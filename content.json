{"meta":{"title":"WEAF å‘¨åˆŠ","subtitle":null,"description":null,"author":"WEAF","url":"http://weafteam.github.io"},"pages":[],"posts":[{"title":"TensorFlowæ¨¡å‹åŠ è½½ä¸è½¬æ¢è¯¦è§£","slug":"2018-08-13/TensorFlowæ¨¡å‹åŠ è½½ä¸è½¬æ¢è¯¦è§£","date":"2018-08-28T01:27:11.000Z","updated":"2018-08-28T02:21:43.671Z","comments":true,"path":"posts/729c646d/","link":"","permalink":"http://weafteam.github.io/posts/729c646d/","excerpt":"","text":"TensorFlowæ¨¡å‹åŠ è½½ä¸è½¬æ¢è¯¦è§£ æœ¬æ¬¡è®²è§£ä¸»è¦æ¶‰åŠåˆ°TensorFlowæ¡†æ¶è®­ç»ƒæ—¶å€™æ¨¡å‹æ–‡ä»¶çš„ç®¡ç†ä»¥åŠè½¬æ¢ã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®TensorFlowæ¨¡å‹æ–‡ä»¶çš„å­˜å‚¨æ ¼å¼ä»¥åŠæ–‡ä»¶ä¸ªæ•°ï¼š 123456789model_folder:------checkpoint------model.meta------model.data-00000-of-00001------model.indexä»¥ä¸Šæ˜¯æ¨¡å‹æ–‡ä»¶å¤¹é‡Œé¢å­˜åœ¨çš„æ‰€æœ‰æ–‡ä»¶ï¼šcheckpointæ–‡ä»¶æ˜¯å­˜å‚¨æ‰€æœ‰æ¨¡å‹æ–‡ä»¶çš„åå­—ï¼Œåœ¨ä½¿ç”¨tf.train.latest_checkpoint()çš„æ—¶å€™ï¼Œè¯¥å‡½æ•°ä¼šå€ŸåŠ©æ­¤æ–‡ä»¶å†…å®¹è·å–æœ€æ–°æ¨¡å‹æ–‡ä»¶ã€‚model.metaæ–‡ä»¶æ˜¯å›¾çš„åŸºæœ¬æ¶æ„ï¼Œpbæ ¼å¼æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«å˜é‡ï¼Œæ“ä½œï¼Œé›†åˆç­‰æ•°æ®ã€‚model.data-00000-of-00001æ–‡ä»¶å’Œmodel.indexæ–‡ä»¶å°±æ˜¯ckptæ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹å­˜å‚¨çš„å°±æ˜¯æƒé‡ã€åç½®ç­‰å†…å®¹ã€‚åœ¨TensorFlow0.11ä¹‹å‰ï¼Œä½¿ç”¨ckptä¸€ä¸ªåç¼€æ–‡ä»¶å­˜å‚¨ï¼Œä»¥åçš„TensorFlowç‰ˆæœ¬éƒ½æ˜¯ä½¿ç”¨è¿™ä¸¤ä¸ªæ–‡ä»¶å…±åŒå­˜å‚¨æ¨¡å‹å‚æ•°ã€‚ æ˜ç¡®äº†è¿™ä¸€ç‚¹ä»¥åï¼Œæˆ‘ä»¬å°±å¼€å§‹åˆ›å»ºè®¡ç®—å›¾ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œç»“æ„å·²ç»å†…éƒ¨çš„è¿ç®—ã€‚ ç½‘ç»œçš„æ­å»ºï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æ­å»ºçš„ç½‘ç»œå°±æ¯”è¾ƒç®€å•ï¼šinput layer,conv_1,conv_2,fc1,dropout,fc2(è¾“å‡ºå±‚),å…·ä½“æ­å»ºä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556def network(): # define the placeholder by using feed the data with tf.name_scope('input_placeholder'): x = tf.placeholder(tf.float32, [None, 784], 'x') # 28*28=784 dim x_input = tf.reshape(x, [-1, 28, 28, 1], 'x_reshape') # reshape for conv, -1è¡¨ç¤ºä¸å›ºå®šæ•°é‡ï¼Œ1ä¸ºé€šé“æ•° y_label = tf.placeholder(tf.float32, [None, FLAGS.classes], 'y_label') # label - 10 dim # define convolution layer1 with tf.name_scope('conv_layer1'): W_conv1 = weight_variable([5, 5, 1, 32], name='w_conv_1') # Weight in:1 out:32 b_conv1 = bias_variable([32], name='b_conv_1') # bias h_relu1 = tf.nn.relu(conv2d(x_input, W_conv1) + b_conv1, name='relu_1') # relu h_pool1 = max_pool_2(h_relu1, name='pool_1') # pool after relu1 # define convolution layer2 with tf.name_scope('conv_layer2'): W_conv2 = weight_variable([5, 5, 32, 64], name='w_conv_2') # Weight in:32 out:64 b_conv2 = bias_variable([64], name='b_conv_2') # bias for 64 kernel h_relu2 = tf.nn.relu(conv2d(h_pool1, W_conv2) + b_conv2, name='relu_2') # relu h_pool2 = max_pool_2(h_relu2, name='pool_2') # pool after relu2 # define the first FC layer with tf.name_scope('fc1'): W_fc1 = weight_variable([7 * 7 * 64, 1024], name='w_fc1') # Weight in:7*7res*64 out:1024 b_fc1 = bias_variable([1024], name='b_fc1') # bias for 1024 h_pool2_flat = tf.reshape(h_pool2, [-1, 7 * 7 * 64], name='pool1') h_fc1 = tf.nn.relu(tf.matmul(h_pool2_flat, W_fc1) + b_fc1, name='relu1') # adding the dropout, in order to restrain overfitting with tf.name_scope('drop_out'): keep_prob = tf.placeholder(tf.float32, name='drop_out_placeholder') drop_fc1 = tf.nn.dropout(h_fc1, keep_prob, name='drop_out_fc') # define the second FC layer, by using softmax with tf.name_scope('fc2'): W_fc2 = weight_variable([1024, FLAGS.classes], name='w_fc2') # Weight in:1024 out:10 b_fc2 = bias_variable([FLAGS.classes], name='b_fc2') # bias for 10, 10ç±»åˆ’åˆ† y = tf.nn.softmax(tf.matmul(drop_fc1, W_fc2) + b_fc2, name='y_out') # è®¡ç®—ç»“æœ global_step = tf.Variable(0, trainable=False) # define the loss with tf.name_scope('loss'): cross_entropy = tf.reduce_mean(-tf.reduce_sum(y_label * tf.log(y), reduction_indices=[1]), name='cross_entropy') with tf.name_scope('train_op'): train_step = tf.train.AdamOptimizer(FLAGS.lr).minimize(cross_entropy, global_step=global_step, name='train_operation') # Adam æ›¿ä»£SGD # define the accuracy with tf.name_scope('accuracy'): correct_pred = tf.equal(tf.argmax(y, 1), tf.argmax(y_label, 1), name='condition') accuracy = tf.reduce_mean(tf.cast(correct_pred, tf.float32), name='accuracy') return x, y, keep_prob, y_label, train_step, accuracy, global_step ä»¥ä¸Šéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œæˆ‘åœ¨æ¯ä¸€å±‚ä¸­éƒ½åŠ å…¥äº†name_scopeï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯å¯ä»¥æ›´æ¸…æ¥šçš„åˆ†æ¸…å±‚ä¸å±‚ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠå¯¹äºåç»­æˆ‘ä»¬ç›´æ¥é€šè¿‡tensor nameæ¥è·å–å˜é‡ï¼Œè€Œæ— é¡»åˆ›å»ºè®¡ç®—å›¾æ¶æ„åšå‡†å¤‡ã€‚ æ•°æ®åŠ è½½ä»¥åŠå¼€å§‹è®­ç»ƒ 123# æ•°æ®åŠ è½½mnist = input_data.read_data_sets(\"MNIST_data/\", one_hot=True)# å°†æ•°æ®å…¨éƒ¨åŠ è½½åœ¨mnistä¸­ï¼Œä¾›åéœ€è®­ç»ƒå’Œæµ‹è¯•ä½¿ç”¨ 1234567891011121314151617181920212223242526# æ¨¡å‹è®­ç»ƒï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°æ¨¡å‹ä¿å­˜çš„ç±»def train(): # the sign which save the meta graph, just once. a = False x, y, keep_prob, y_label, train_step, accuracy, global_step = network() sess.run(tf.global_variables_initializer()) saver = tf.train.Saver(max_to_keep=3) if FLAGS.use_model: model_t = tf.train.latest_checkpoint(FLAGS.model_path) saver.restore(sess, model_t) for i in range(FLAGS.max_iter_step): batch = mnist.train.next_batch(FLAGS.batch_size) # æ¯50ä¸ªä¸€ä¸ªbatch if i % 100 == 0: # evalæ‰§è¡Œè¿‡ç¨‹ï¼è®­ç»ƒç²¾åº¦ train_accuracy = sess.run(accuracy, feed_dict=&#123;x: batch[0], y_label: batch[1], keep_prob: 1.0&#125;) print(\"step &#123;step&#125;, training accuracy &#123;acc&#125;\".format(step=i, acc=train_accuracy)) if (train_accuracy &gt; 0.5): if a == 0: saver.export_meta_graph(FLAGS.model_path + FLAGS.meta_graph_name) a = True saver.save(sess, FLAGS.model_path + FLAGS.model_name, global_step=global_step, write_meta_graph=False) sess.run(train_step, feed_dict=&#123;x: batch[0], y_label: batch[1], keep_prob: FLAGS.keep_drop&#125;) é‚£ä¹ˆæ€ä¹ˆæ„å»ºæ¨¡å‹ä¿å­˜å‘¢ï¼Ÿ 123456789# é¦–å…ˆï¼Œåˆ›å»ºSaverå¯¹è±¡saver = tf.train.Saver(max_to_keep=3) # è¿™é‡Œè®¾ç½®çš„æ¨¡å‹æ–‡ä»¶æœ€å¤§ä¿å­˜ä¸ªæ•°æ˜¯ä¸‰ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´checkpointæ–‡ä»¶ä¸­å§‹ç»ˆæœ‰ä¸‰ä¸ªç‰ˆæœ¬çš„æ¨¡å‹æ–‡ä»¶# ç¬¬äºŒæ­¥ï¼Œé‚£å°±æ˜¯æ ¹æ®ä¸åŒçš„è¿­ä»£æˆ–è€…epochï¼Œä½ å¯ä»¥éšå¿ƒæ‰€æ¬²çš„ä¿å­˜æ¨¡å‹ã€‚# æˆ‘è¿™é‡Œå¤„ç†çš„é€»è¾‘å°±æ˜¯æ¯è®­ç»ƒä¸€ç™¾æ¬¡ï¼Œç„¶åtrain_accuracyçš„å¤§å°å¤§äº0.5ï¼Œé‚£ä¹ˆæˆ‘å°±å¼€å§‹å­˜å‚¨ã€‚# è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œé‚£å°±æ˜¯åœ¨ä¿å­˜æ¨¡å‹æ–‡ä»¶çš„æ—¶å€™ï¼Œå®Œå…¨æ²¡æœ‰å¿…è¦æ¯æ¬¡éƒ½ä¿å­˜metaï¼Œæ‰€ä»¥ï¼Œå¯ä»¥å•ç‹¬åœ¨ç¬¬ä¸€æ¬¡ä¿å­˜metaï¼Œå› ä¸ºmetaæ˜¯graphï¼Œæ‰€ä»¥åç»­è®­ç»ƒä¸ä¼šå¯¹metaèµ·ä½œç”¨ï¼Œæ‰€ä»¥å‡å°‘å¼€é”€ã€‚saver.export_meta_graph(FLAGS.model_path + FLAGS.meta_graph_accuracy)# ä¸Šé¢çš„ä»£ç åªæ˜¯åœ¨ç¬¬ä¸€æ¬¡ä¿å­˜æ¨¡å‹çš„æ—¶å€™æ‰§è¡Œsaver.save(sess, FLAGS.model_path + FLAGS.model_name, global_step=global_step, write_meta_graph=False)# ä¸Šé¢çš„ä»£ç æ¯æ¬¡éƒ½æ‰§è¡Œï¼Œä½†æ˜¯ä¸ä¼šä¿å­˜metaæ•°æ®ï¼Œåœ¨ä¸€èˆ¬çš„ä¿å­˜æ¨¡å‹çš„æ—¶å€™ï¼Œwrite_meta_graphæ ‡å¿—ä½æ˜¯True å¥½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®­ç»ƒå®Œæˆä»¥åï¼Œæ¨¡å‹æ–‡ä»¶å·²ç»æœ‰äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•å¯¼å…¥åˆšæ‰çš„æ¨¡å‹æ–‡ä»¶æ‰§è¡Œæµ‹è¯•å‘¢ï¼Ÿ 12345678910111213141516171819202122def test(): if FLAGS.use_model: with tf.Session() as sess: saver = tf.train.import_meta_graph(FLAGS.model_path + FLAGS.meta_graph_name) saver.restore(sess, tf.train.latest_checkpoint(FLAGS.model_path)) graph = tf.get_default_graph() # one operation possibly have many outputs, so you need specify the which output, such as \"name:0\" x = graph.get_tensor_by_name(\"input_placeholder/x:0\") y_label = graph.get_tensor_by_name(\"input_placeholder/y_label:0\") keep_prob = graph.get_tensor_by_name(\"drop_out/drop_out_placeholder:0\") accuracy = graph.get_tensor_by_name(\"accuracy/accuracy:0\") feed_dict = &#123;x: mnist.test.images, y_label: mnist.test.labels, keep_prob: 1.0&#125; acc = sess.run(accuracy, feed_dict=feed_dict) print(\"test accuracy &#123;acc:.4f&#125;\".format(acc=acc)) ä¸Šé¢çš„ä»£ç ï¼š é¦–å…ˆåˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ¨¡å‹æ–‡ä»¶ï¼Œ ç„¶åæ‰“å¼€ä¼šè¯ï¼Œåœ¨è¿™é‡Œæ³¨æ„ï¼Œæˆ‘å¹¶æ²¡æœ‰åˆ›å»ºç½‘ç»œç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨TensorFLowé»˜è®¤çš„å›¾ä¸­æ˜¯ä¸å­˜åœ¨æˆ‘çš„è®¡ç®—å›¾ç»“æ„çš„ã€‚ ç„¶åæˆ‘ä»¬ä½¿ç”¨tf.train.import_meta_graph()æ–¹æ³•å°†æ¨¡å‹å›¾ï¼Œä¹Ÿå°±æ˜¯metaæ–‡ä»¶å¯¼å…¥ç»™saver ç„¶åä½¿ç”¨saverçš„restoreæ–¹æ³•å°†æ¨¡å‹æ–‡ä»¶å¯¼å…¥ ç„¶åä½¿ç”¨tf.get_default_graph()æ–¹æ³•è·å–TensorFlowé»˜è®¤çš„è®¡ç®—å›¾ï¼ˆè¿™å›ä¼šè·å–åˆ°é‚£ä¸ªæˆ‘ä»¬ä¿å­˜çš„è®¡ç®—å›¾ï¼‰ å› ä¸ºï¼Œæˆ‘ä»¬æ²¡æœ‰å®šä¹‰ç½‘ç»œç»“æ„ä¸­çš„å˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•å¾—åˆ°å…·ä½“çš„ç½‘ç»œæ‰§è¡Œå˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©graph.get_tensor_by_name()æ–¹æ³•æ¥å®ç°è®¡ç®—å›¾å˜é‡çš„è·å–ã€‚ ç„¶åé€šè¿‡sess.run()æ–¹æ³•æ¥è¿è¡Œæƒ³è¦çš„tenosrå€¼ ï¼ˆä¸Šé¢çš„ä»£ç ä¸­éœ€è¦æ³¨æ„çš„æ˜¯get_tensor_by_nameçš„åå­—ç»„æˆï¼šï¼ˆname_scopeï¼‰/(tensor_name):ç¬¬å‡ ä¸ªå€¼ï¼‰å› ä¸ºæˆ‘ä»¬çš„è¿ç®—æ˜¯å»ºç«‹åœ¨tensorä¸Šçš„ï¼Œä½†æ˜¯æ¯æ¬¡è¿è¡Œçš„ç»“æœéƒ½æ˜¯é€šè¿‡operationæ¥å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåé¢çš„é‚£ä¸ªindexå°±æ˜¯æˆ‘ä»¬çš„ç¬¬å‡ ä¸ªoperationæ‰€è¦å–çš„å€¼ã€‚ å¥½ï¼Œè¿™é‡ŒæŠŠæ¨¡å‹æ–‡ä»¶çš„ç‰¹æ®Šä¿å­˜å’ŒåŠ è½½éƒ½è®²å®Œäº†ï¼Œæ‰€ä»¥éœ€è¦è½¬æ¢æˆpbæ–‡ä»¶ï¼Œå› ä¸ºåœ¨åç»­æˆ‘ä»¬ä½¿ç”¨TensorRTéƒ¨ç½²TensorFLowæ¨¡å‹æ–‡ä»¶çš„æ—¶å€™ï¼Œæ˜¯éœ€è¦pbæ–‡ä»¶ï¼Œç„¶åå°†pbæ–‡ä»¶è½¬æ¢ä¸ºuffæ–‡ä»¶æˆ–è€…onnxæ–‡ä»¶æ¥å®ç°TenorRTç½‘ç»œçš„æ„å»ºã€‚ 1234567891011121314151617181920212223242526def save_pb_file(): if FLAGS.use_model: saver = tf.train.import_meta_graph(FLAGS.model_path + FLAGS.meta_graph_name) model_t = tf.train.latest_checkpoint(FLAGS.model_path) saver.restore(sess, model_t) graphdef = tf.get_default_graph().as_graph_def() frozen_graph = tf.graph_util.convert_variables_to_constants(sess, graphdef, ['fc2/y_out']) # è¿™ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼Œæ˜¯æœ€åä¸€ä¸ªè¾“å‡ºèŠ‚ç‚¹çš„tenosråå­— return tf.graph_util.remove_training_nodes(frozen_graph) else: return Falsegraph_def = save_pb_file()if graph_def is False: raise ValueError(\"The meta graph do not exist!!!\") output_file = './graph.pb' with tf.gfile.GFile(name = output_file, mode = 'w') as f: s = graph_def.SerializeToString() f.write(s) é¦–å…ˆä¹Ÿæ˜¯åŠ è½½å›¾ï¼Œç„¶ååŠ è½½æƒé‡å‚æ•°æ–‡ä»¶ï¼Œç„¶åå°†graphä½œä¸ºä¸€ä¸ªgraphdefè¿”å›ï¼Œç„¶åé€šè¿‡tf.graph_util.convert_variables_to_constantså°†å‚æ•°æ–‡ä»¶è½¬æ¢ä¸ºå¸¸é‡ï¼Œæœ€åï¼Œä½¿ç”¨tf.graph_util.remove_training_nodes(frozen_graph)å°†åœ¨è®­ç»ƒé˜¶æ®µæ‰ä½¿ç”¨çš„å˜é‡å»é™¤ï¼Œä¹Ÿå°±æ˜¯ä¸€äº›gradientsã€‚ è¿”å›å»é™¤è®­ç»ƒé˜¶æ®µçš„èŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡tf.gfile.GFileå†™å…¥åˆ°æŒ‡å®šæ–‡ä»¶ã€‚ æ•´ä½“çš„ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197#!/usr/bin/env python# -*- coding: utf-8 -*-# @Time : 2018/4/24 20:08# @Author : milittle# @Site : www.weaf.top# @File : model.py# @Software: PyCharm#coding=utf-8import tensorflow as tffrom tensorflow.examples.tutorials.mnist import input_datafrom tensorflow.python.framework import opsimport datasetops.reset_default_graph()sess = tf.Session()FLAGS = tf.app.flags.FLAGStf.app.flags.DEFINE_integer('max_iter_step', 1000, 'define iteration times')tf.app.flags.DEFINE_integer('batch_size', 128, 'define batch size')tf.app.flags.DEFINE_integer('classes', 10, 'define classes')tf.app.flags.DEFINE_float('keep_drop', 0.5, 'define keep dropout')tf.app.flags.DEFINE_float('lr', 0.001, 'define learning rate')tf.app.flags.DEFINE_string('model_path', 'model\\\\','define model path')tf.app.flags.DEFINE_string('model_name', 'model.ckpt', 'define model name')tf.app.flags.DEFINE_string('meta_graph_name', 'model.meta', 'define model name')tf.app.flags.DEFINE_bool('use_model', False, 'define use_model sign')tf.app.flags.DEFINE_bool('is_train', True, 'define train sign')tf.app.flags.DEFINE_bool('is_test', False, 'define train sign')mnist = input_data.read_data_sets(\"MNIST_data/\", one_hot=True)# mnist_train = dataset.train(\"MNIST_data/\")# mnist_test = dataset.train(\"MNIST_data/\")# define W &amp; bdef weight_variable(para, name): # é‡‡ç”¨æˆªæ–­çš„æ­£æ€åˆ†å¸ƒï¼Œæ ‡å‡†å·®stddevï¼0.1 initial = tf.truncated_normal(para,stddev=0.1) return tf.Variable(initial, name)def bias_variable(para, name): initial = tf.constant(0.1, shape=para) return tf.Variable(initial, name)# define conv &amp; poolingdef conv2d(x,W): return tf.nn.conv2d( x,W,strides=[1,1,1,1],padding='SAME' )def max_pool_2(x, name): return tf.nn.max_pool(x,ksize=[1,2,2,1],strides=[1,2,2,1],padding='SAME', name=name)def network(): # define the placeholder by using feed the data with tf.name_scope('input_placeholder'): x = tf.placeholder(tf.float32, [None, 784], 'x') # 28*28=784 dim x_input = tf.reshape(x, [-1, 28, 28, 1], 'x_reshape') # reshape for conv, -1è¡¨ç¤ºä¸å›ºå®šæ•°é‡ï¼Œ1ä¸ºé€šé“æ•° y_label = tf.placeholder(tf.float32, [None, FLAGS.classes], 'y_label') # label - 10 dim # define convolution layer1 with tf.name_scope('conv_layer1'): W_conv1 = weight_variable([5, 5, 1, 32], name='w_conv_1') # Weight in:1 out:32 b_conv1 = bias_variable([32], name='b_conv_1') # bias h_relu1 = tf.nn.relu(conv2d(x_input, W_conv1) + b_conv1, name='relu_1') # relu h_pool1 = max_pool_2(h_relu1, name='pool_1') # pool after relu1 # define convolution layer2 with tf.name_scope('conv_layer2'): W_conv2 = weight_variable([5, 5, 32, 64], name='w_conv_2') # Weight in:32 out:64 b_conv2 = bias_variable([64], name='b_conv_2') # bias for 64 kernel h_relu2 = tf.nn.relu(conv2d(h_pool1, W_conv2) + b_conv2, name='relu_2') # relu h_pool2 = max_pool_2(h_relu2, name='pool_2') # pool after relu2 # define the first FC layer with tf.name_scope('fc1'): W_fc1 = weight_variable([7 * 7 * 64, 1024], name='w_fc1') # Weight in:7*7res*64 out:1024 b_fc1 = bias_variable([1024], name='b_fc1') # bias for 1024 h_pool2_flat = tf.reshape(h_pool2, [-1, 7 * 7 * 64], name='pool1') h_fc1 = tf.nn.relu(tf.matmul(h_pool2_flat, W_fc1) + b_fc1, name='relu1') # adding the dropout, in order to restrain overfitting with tf.name_scope('drop_out'): keep_prob = tf.placeholder(tf.float32, name='drop_out_placeholder') drop_fc1 = tf.nn.dropout(h_fc1, keep_prob, name='drop_out_fc') # define the second FC layer, by using softmax with tf.name_scope('fc2'): W_fc2 = weight_variable([1024, FLAGS.classes], name='w_fc2') # Weight in:1024 out:10 b_fc2 = bias_variable([FLAGS.classes], name='b_fc2') # bias for 10, 10ç±»åˆ’åˆ† y = tf.nn.softmax(tf.matmul(drop_fc1, W_fc2) + b_fc2, name='y_out') # è®¡ç®—ç»“æœ global_step = tf.Variable(0, trainable=False) # define the loss with tf.name_scope('loss'): cross_entropy = tf.reduce_mean(-tf.reduce_sum(y_label * tf.log(y), reduction_indices=[1]), name='cross_entropy') with tf.name_scope('train_op'): train_step = tf.train.AdamOptimizer(FLAGS.lr).minimize(cross_entropy, global_step=global_step, name='train_operation') # Adam æ›¿ä»£SGD # define the accuracy with tf.name_scope('accuracy'): correct_pred = tf.equal(tf.argmax(y, 1), tf.argmax(y_label, 1), name='condition') accuracy = tf.reduce_mean(tf.cast(correct_pred, tf.float32), name='accuracy') return x, y, keep_prob, y_label, train_step, accuracy, global_stepdef train(): # the sign which save the meta graph, just once. a = False x, y, keep_prob, y_label, train_step, accuracy, global_step = network() sess.run(tf.global_variables_initializer()) saver = tf.train.Saver(max_to_keep=3) if FLAGS.use_model: model_t = tf.train.latest_checkpoint(FLAGS.model_path) saver.restore(sess, model_t) for i in range(FLAGS.max_iter_step): batch = mnist.train.next_batch(FLAGS.batch_size) # æ¯50ä¸ªä¸€ä¸ªbatch if i % 100 == 0: # evalæ‰§è¡Œè¿‡ç¨‹ï¼è®­ç»ƒç²¾åº¦ train_accuracy = sess.run(accuracy, feed_dict=&#123;x: batch[0], y_label: batch[1], keep_prob: 1.0&#125;) print(\"step &#123;step&#125;, training accuracy &#123;acc&#125;\".format(step=i, acc=train_accuracy)) if (train_accuracy &gt; 0.5): if a == 0: saver.export_meta_graph(FLAGS.model_path + FLAGS.meta_graph_name) a = True saver.save(sess, FLAGS.model_path + FLAGS.model_name, global_step=global_step, write_meta_graph=False) sess.run(train_step, feed_dict=&#123;x: batch[0], y_label: batch[1], keep_prob: FLAGS.keep_drop&#125;)def test(): if FLAGS.use_model: with tf.Session() as sess: saver = tf.train.import_meta_graph(FLAGS.model_path + FLAGS.meta_graph_name) saver.restore(sess, tf.train.latest_checkpoint(FLAGS.model_path)) graph = tf.get_default_graph() # one operation possibly have many outputs, so you need specify the which output, such as \"name:0\" x = graph.get_tensor_by_name(\"input_placeholder/x:0\") y_label = graph.get_tensor_by_name(\"input_placeholder/y_label:0\") keep_prob = graph.get_tensor_by_name(\"drop_out/drop_out_placeholder:0\") accuracy = graph.get_tensor_by_name(\"accuracy/accuracy:0\") feed_dict = &#123;x: mnist.test.images, y_label: mnist.test.labels, keep_prob: 1.0&#125; acc = sess.run(accuracy, feed_dict=feed_dict) print(\"test accuracy &#123;acc:.4f&#125;\".format(acc=acc))def save_pb_file(): if FLAGS.use_model: saver = tf.train.import_meta_graph(FLAGS.model_path + FLAGS.meta_graph_name) model_t = tf.train.latest_checkpoint(FLAGS.model_path) saver.restore(sess, model_t) graphdef = tf.get_default_graph().as_graph_def() frozen_graph = tf.graph_util.convert_variables_to_constants(sess, graphdef, ['fc2/y_out']) return tf.graph_util.remove_training_nodes(frozen_graph) else: return Falsedef main(): if FLAGS.is_train: train() elif FLAGS.is_test: test() else: graph_def = save_pb_file() if graph_def is False: raise ValueError(\"The meta graph do not exist!!!\") output_file = './graph.pb' with tf.gfile.GFile(name = output_file, mode = 'w') as f: s = graph_def.SerializeToString() f.write(s)if __name__ == '__main__': try: main() except (ValueError, IndexError) as ve: print(ve) ä»Šå¤©çš„TensorFlowæ¨¡å‹ä¿å­˜ä»¥åŠåŠ è½½ï¼Œä»¥åŠå°†ä¸‰ä¸ªè®­ç»ƒé˜¶æ®µä½¿ç”¨çš„æ¨¡å‹æ–‡ä»¶æ•´åˆåˆ°ä¸€ä¸ªpbæ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªpbæ–‡ä»¶ä¸ä»…ä»…å¯ä»¥åœ¨æ„å»ºTensorRTçš„ç½‘ç»œä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨éƒ¨ç½²TensorFlow servingä¸­ã€‚æ•´ä½“çš„ç»“æ„å’Œå­˜å‚¨è¿‡ç¨‹å°±æ˜¯è¿™æ ·ã€‚æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œéšæ—¶è”ç³»air@weaf.topã€‚æˆ‘ä¸€ç›´éƒ½åœ¨ã€‚ å¦‚æœä½ è§‰å¾—æˆ‘çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¯ä»¥å…³æ³¨ä»¥ä¸‹å…¬ä¼—å·ï¼Œäº†è§£æ›´å¤šç›¸å…³ä¿¡æ¯ï¼š","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"TensorRT-å¼€å‘å…¥é—¨","slug":"2018-05-28/TensorRT-å¼€å‘å…¥é—¨","date":"2018-08-12T09:56:37.000Z","updated":"2018-08-28T01:29:16.308Z","comments":true,"path":"posts/e0818c8b/","link":"","permalink":"http://weafteam.github.io/posts/e0818c8b/","excerpt":"","text":"TensorRT-å¼€å‘å…¥é—¨ Docker For Ubuntu 16.04ï¼ˆå¿ƒè·¯å†ç¨‹ï¼‰ ä»¥åŠåœ¨Ubuntuä¸ŠDockerä¸­ä½¿ç”¨TensorRTçš„å¿ƒè·¯å†ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä¸ºä»¥ååƒæ­å»ºå‡ºè¦ç»™å®å®åœ¨åœ¨èƒ½ç”¨çš„æ·±åº¦å­¦ä¹ åº”ç”¨è€Œåšçš„å‡†å¤‡ è¿™ç¯‡è®°å½•åœ¨Ubuntuä¸Šå®‰è£…Dockerï¼Œå¹¶ä¸”å®‰è£…nvidia-dockerçš„å¿ƒè·¯å†ç¨‹ï¼Œè¿˜æœ‰NGCï¼ˆNvidia GPU Cloud ï¼‰çš„é‡Œé¢çš„containerçš„ä½¿ç”¨ã€‚ï¼ˆå°¤å…¶æ˜¯TensorRT containerçš„ä¸€ä¸ªä½¿ç”¨ï¼‰ ä¸€ã€åœ¨Ubuntuä¸Šå®‰è£…docker-ce è¿™é‡Œçš„docker-ceæ˜¯dockerçš„ç¤¾åŒºç‰ˆï¼Œå› ä¸ºç¤¾åŒºç‰ˆæ˜¯ä¸æ”¶è´¹çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å·²ç»å¤Ÿç”¨äº†ã€‚å…ˆå»å®˜ç½‘ï¼ŒDocker For Ubuntu è¿™é‡Œå¯ä»¥æ‰¾åˆ°å®‰è£…çš„æ•™ç¨‹ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨debæ–‡ä»¶å®‰è£…ã€‚ å»ï¼ˆ1ï¼‰ubuntuçš„docker debæ–‡ä»¶ï¼Œ æ ¹æ®ä½ çš„ubuntuçš„ç‰ˆæœ¬ï¼ŒæŸ¥çœ‹Ubuntuç‰ˆæœ¬å‘½ä»¤ï¼Œ cat /etc/issue ä¼šæ˜¾ç¤ºå‡ºubuntuçš„ç‰ˆæœ¬å·ï¼Œæ ¹æ®ç‰ˆæœ¬å·åœ¨è¿™ä¸ªç½‘ç«™ä¸Šï¼ˆ2ï¼‰ubuntuç‰ˆæœ¬å·åå­—å¯¹åº”å…³ç³»è¡¨ï¼Œ ç„¶ååœ¨ï¼ˆ1ï¼‰é“¾æ¥ä¸­æ‰¾åˆ°è‡ªå·±ç³»ç»Ÿçš„å¯¹åº”åå­—ï¼Œç‚¹è¿›å»åå­—/pool/stable/ åˆ°äº†è¿™ä¸€çº§ç›®å½•ï¼Œå°±åˆ°äº†é€‰æ‹©ä¸»æœºä½æ•°çš„æ—¶å€™äº†ï¼Œä¸æ¸…æ¥šçš„å°ä¼™ä¼´ï¼Œä½¿ç”¨cat /proc/version å‘½ä»¤æŸ¥çœ‹ï¼Œæˆ‘çš„æ˜¯amd64ã€‚ï¼ˆéœ€è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯æˆ‘çš„ubuntuçš„åå­—æ˜¯xenialï¼‰ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°å°çš„æç¤ºï¼Œåœ¨åé¢å®‰è£…nvidia-docker2çš„æ—¶å€™ï¼Œéœ€è¦docker-ce 18.06çš„æ”¯æŒï¼Œæ‰€ä»¥å¤§å®¶åœ¨ä¸‹è½½çš„æ—¶å€™ï¼Œéœ€è¦ä¸‹è½½è¿™ä¸ªç‰ˆæœ¬çš„ã€‚ï¼ˆä¸€å¼ å›¾èƒœè¿‡åƒè¨€ä¸‡è¯­ï¼Œä¸‹é¢æ˜¯debæ–‡ä»¶å±•ç¤ºï¼Œä¸Šé¢æ˜¯è·¯å¾„ï¼Œæˆ‘ä¸‹è½½çš„ç‰ˆæœ¬æ˜¯çº¢è‰²ç®­å¤´æŒ‡å‘çš„é‚£ä¸ªç‰ˆæœ¬ï¼‰ ä¸‹é¢å°±å¼€å§‹å®‰è£…äº†ï¼Œå®‰è£…ä¹‹å‰éœ€è¦åºŸè¯ä¸¤å¥ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿä¸Šå·²ç»æœ‰äº†dockeræ€ä¹ˆåŠï¼Œé‚£è¦çœ‹ä½ æ˜¯é€šè¿‡aptè¿˜æ˜¯apt-getå®‰è£…çš„ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š 1234567891011# æŸ¥çœ‹æ˜¯å¦å®‰è£…å‘½ä»¤apt list --installed | grep docker# æˆ–è€…apt-get list --installed | grep docker# ä»¥ä¸Šçš„ä¸¤æ¡å‘½ä»¤å¯ä»¥æŸ¥åˆ°å®‰è£…ä¿¡æ¯ï¼Œå¦‚æœä½ çš„ç‰ˆæœ¬å’Œè¿™ä¸ªç³»ç»Ÿçš„ç‰ˆæœ¬æ˜¯å†²çªçš„ï¼Œé‚£ä¹ˆä½ å¯ä»¥é€šè¿‡å¸è½½è¿™ä¸ªå½“å‰çš„ç‰ˆæœ¬ï¼Œå®‰è£…æ–°çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯å‰ææ˜¯ä½ æœ‰è¿™ä¸ªæƒåˆ©åšè¿™ä»¶äº‹æƒ…ï¼Œsudoæƒé™ï¼Œè€Œä¸”ï¼Œä½ å¸è½½äº†å¯¹å…¶ä»–ç”¨æˆ·ä¸ä¼šé€ æˆå½±å“çš„å‰æä¸‹ï¼Œå¦‚æœä½ å¸è½½äº†ï¼Œå¯¹å…¶ä»–ç”¨æˆ·äº§ç”Ÿå½±å“ï¼Œåæœè‡ªè´Ÿã€‚# 1 å¼€å§‹å®‰è£…ï¼Œå¦‚æœä½ æ˜¯rootç”¨æˆ·ï¼Œåˆ™ä¸éœ€è¦åŠ ä¸‹é¢çš„sudoï¼Œå¦‚æœä½ çš„ç”¨æˆ·æ²¡æœ‰sudoæƒé™ï¼Œé‚£ä¹ˆéœ€è¦ä½ è®©ç®¡ç†å‘˜å®‰è£…ï¼Œæˆ–è€…ï¼Œè®©ç®¡ç†å‘˜æŠŠä½ åŠ è½½sudoç»„é‡Œã€‚sudo dpkg -i docker-ce_18.06.0_ce_3-0_ubuntu_amd64.deb# 2 å®‰è£…ç»“æŸä»¥åï¼Œéœ€è¦æµ‹è¯•ä¸€ä¸‹å®‰è£…æ˜¯å¦æˆåŠŸsudo docker run hello-world# å¦‚æœä»¥ä¸Šå‘½ä»¤å‡ºç°ä¸€äº›å›¾2çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±æ˜¯æˆåŠŸäº† å›¾2 äºŒã€åœ¨ubuntuä¸Šå®‰è£…nvidia-dockerå’Œä½¿ç”¨NGC container è¿™é‡Œæœ‰ä¸€ä¸ªå¤§å‰ææ˜¯ï¼Œä½ çš„ä¸»æœºä¸Šå·²ç»å®‰è£…è¿‡nvidiaçš„é©±åŠ¨äº†ï¼Œè¯¦ç»†çš„è¿‡ç¨‹è¯·æŸ¥çœ‹å®‰è£…nvidia driverã€‚ å®‰è£…nvidia-docker(è¿™ä¸ªæ­¥éª¤ä¸€å®šè¦åœ¨å®‰è£…dockerä¹‹å) 12345678910curl -s -L https://nvidia.github.io/nvidia-docker/gpkey | \\ sudo apt-key add -# ä¸Šé¢æ˜¯ä¸€æ¡å‘½ä»¤curl -s -L https://nvidia.github.io/nvidia-docker/ubuntu16.04/amd64/nvidia-docker.list | \\ sudo tee /etc/apt/sources.list.d/nvidia-docker.list# ä¸Šé¢æ˜¯ä¸€æ¡å‘½ä»¤## ä¸Šé¢çš„ä¸¤æ¡å‘½ä»¤éƒ½æ˜¯å°†æºæŒ‚è½½åœ¨æœ¬åœ°sudo apt-get update sudo apt-get install -y nvidia-docker2 # è¿™æ˜¯å®‰è£…å‘½ä»¤sudo usermod -aG docker $USER # è¿™ä¸€æ¡æ˜¯å°†ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ä¸­ ç„¶åå»æ³¨å†ŒNGCæ³¨å†Œæ•™ç¨‹ ä¸Šé¢çš„æ•™ç¨‹å·²ç»å¾ˆæ¸…æ¥šäº†ã€‚ï¼ˆæœ€ä¸»è¦çš„æ˜¯ç”Ÿæˆé‚£ä¸ªapi keyï¼‰ é™„ä¸€å¼ æ³¨å†Œä»¥åçš„ä¸»é¡µ è¿™é‡Œé¢æ˜¯æ‰€æœ‰çš„container åé¢è¿è¡Œç¤ºä¾‹çš„æ—¶å€™ä¼šä¸‹è½½TensorRTçš„æ ·ä¾‹ã€‚ æœ¬åœ°å®‰è£…NGC imageï¼ˆè¿™æ˜¯Dockerçš„é•œåƒæ–‡ä»¶ï¼Œå¯ä»¥å½“ä½œä¸€ä¸ªapplicationï¼‰ï¼Œä»¥åŠè¿è¡Œimageä¸ºcontainer 12345678910111213141516171819202122sudo docker login nvcr.io#ä¸Šé¢çš„å‘½ä»¤æ˜¯ç™»å½•nvcr imageæœåŠ¡å™¨sudo docker run --runtime=nvidia --rm nvcr.io/nvidia/cuda:9.0-cudnn7-devel-ubuntu16.04 nvidia-smi# ä¸Šé¢è¿™æ¡å‘½ä»¤æ˜¯è¿è¡Œcudaç¯å¢ƒï¼Œåé¢çš„é‚£ä¸ªnvidia-smiæ˜¯æŸ¥çœ‹GPUä¿¡æ¯çš„ï¼Œç›¸æ¯”å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ã€‚# è¿™å°±æµ‹è¯•äº†dockerçš„ç¯å¢ƒæ˜¯å¦æ˜¯å¯è¿è¡Œäº†# ä¸‹é¢æ˜¯å®‰è£…NGC é‡Œé¢çš„é‚£äº›image# ä¸€ä¸‹çš„ç¤ºä¾‹æ˜¯TensorRTçš„ç¤ºä¾‹sudo docker pull nvcr.io/nvidia/tensorrt:18.07-py2# ä¸Šé¢çš„å‘½ä»¤æ˜¯å°†tensorrtçš„iamgeæ–‡ä»¶ä¸‹åˆ°æœ¬åœ°ï¼Œå¯èƒ½éœ€è¦ç‚¹æ—¶é—´ã€‚å¤§çº¦2.61G# åé¢å°±æ˜¯è¿è¡Œç¤ºä¾‹sudo nvidia-docker run -it --rm nvcr.io/nvidia/tensorrt:18.07-py2# ç„¶åå°±ä¼šè¿›å…¥linux containerï¼Œè¿™é‡Œé¢å·²ç»å«æœ‰tensorrtçš„ç¤ºä¾‹äº†ã€‚# ä¸‹é¢æ˜¯tensorrtçš„ç¤ºä¾‹è¿è¡Œã€‚# c++ exampleç¤ºä¾‹è¿è¡Œ# å›¾4æ‰€ç¤º# python exampleç¤ºä¾‹è¿è¡Œ# å›¾5æ‰€ç¤º å›¾3 å›¾4 å›¾5 ä¸‰ã€åˆ°æ­¤æˆ‘ä»¬å°±ç»“æŸäº†ï¼Œå¯èƒ½æœ‰å¾ˆå¤šå°ä¼™ä¼´è¯´è¿™äº›å¤ªç®€å•äº†ï¼Œå…¶å®ä¸ç®€å•ï¼Œè¿™äº›å†…å®¹æ˜¯æˆ‘èŠ±äº†ä¸€æ•´å¤©æ—¶é—´ï¼ŒæŸ¥å„ç§æ–‡æ¡£ï¼Œæœ€åç®€ç»ƒçš„å°†è¿™äº›ä¸œè¥¿æ•´åˆåˆ°ä¸€èµ·çš„ã€‚å¦‚æœå¤§å®¶æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¯ä»¥ç›´æ¥ç»™æˆ‘å‘é‚®ä»¶æˆ–è€…ç›´æ¥åŠ æˆ‘qqï¼Œæˆ‘æˆ–è®¸å¯ä»¥è§£ç­”ä½ çš„ç–‘æƒ‘ã€‚ qqï¼š329804334 Emailï¼šair@weaf.top","categories":[{"name":"TensorRT","slug":"TensorRT","permalink":"http://weafteam.github.io/categories/TensorRT/"}],"tags":[{"name":"TensorRT","slug":"TensorRT","permalink":"http://weafteam.github.io/tags/TensorRT/"}]},{"title":"Android æ··æ·†","slug":"2018-08-13/android-1","date":"2018-08-10T18:04:44.000Z","updated":"2018-08-22T14:49:02.600Z","comments":true,"path":"posts/df5d12f4/","link":"","permalink":"http://weafteam.github.io/posts/df5d12f4/","excerpt":"","text":"ä¸€ï¼šå¼€å¯æ··æ·† Android studioä¸­å¼€å¯æ··æ·†å¾ˆç®€å•ï¼Œæ‰¾åˆ°build.gradleæ–‡ä»¶ï¼Œè®¾ç½®minifyEnabled=trueã€‚å¦‚ä¸‹ï¼š buildTypes { release { minifyEnabled true shrinkResources true proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39; } } shrinkResourcesè®¾ç½®ä¸ºtrueå¯ä»¥åœ¨å¼€å¯æ··æ·†åå»æ‰æ— ç”¨çš„èµ„æºæ–‡ä»¶ï¼Œå‡å°åº”ç”¨çš„ä½“ç§¯ äºŒï¼šé…ç½®æ··æ·†æ–‡ä»¶ æ‰¾åˆ°proguard-rules.proæ–‡ä»¶ï¼Œå°±å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„æ··æ·†è§„åˆ™äº†ã€‚ ä¸€äº›ç®€å•çš„è§„åˆ™éœ€è¦æˆ‘ä»¬äº†è§£ä¸‹ # ä»£è¡¨è¡Œæ³¨é‡Šç¬¦ - è¡¨ç¤ºä¸€æ¡è§„åˆ™çš„å¼€å§‹ keep ä¿ç•™ ï¼š dont ä¸è¦ : dontwarnï¼šè¡¨ç¤ºä¸è¦æç¤ºè­¦å‘Š ignore å¿½ç•¥ï¼Œä¾‹å¦‚ignorewarningï¼šè¡¨ç¤ºå¿½ç•¥è­¦å‘Š # ä¸ä¼˜åŒ– -dontoptimize # ä»£ç å¾ªç¯ä¼˜åŒ–æ¬¡æ•°ï¼Œ0-7ï¼Œé»˜è®¤ä¸º5 -optimizationpasses 5 # ä¸åšé¢„æ ¡éªŒ -dontpreverify é¦–å…ˆéœ€è¦åŒºåˆ†ä¸‹ * å’Œ **ï¼› -keep class xxxx.info.** -keep class xxxx.info.* å‰è€…è¡¨ç¤ºæœ¬åŒ…ä»¥åŠå­åŒ…ä¸‹çš„ç±»åéƒ½ä¿æŒï¼Œè€Œåè€…è¡¨ç¤ºæœ¬åŒ…ä¸æ··æ·†ï¼Œå­åŒ…ä¸‹çš„ç±»åä¼šè¢«æ··æ·†ã€‚ å½“ç„¶è¿™ä¸¤è€…éƒ½æ˜¯ä¼šæ··æ·†å…·ä½“çš„æ–¹æ³•åå’Œå˜é‡çš„ï¼Œæ‰€ä»¥ä½ å¦‚æœæƒ³è¦éƒ½ä¿æŒï¼Œä¸è¢«æ··æ·†å¤„ç†çš„è¯ï¼Œéœ€è¦å†™æˆä¸‹é¢è¿™ç§ï¼š -keep class xxxx.info.* {*;} å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä¿ç•™ç±»ä¸­çš„æŸäº›éƒ¨åˆ†ä¸è¢«æ··æ·†ï¼Œå¦‚ï¼š -keep class xxxx.info.One { public &lt;methods&gt;; } æˆ–è®¸ä½ è§‰å¾—ç±»åä¹Ÿä¸éœ€è¦ä¿ç•™ï¼Œé‚£å°±ä¸èƒ½ä½¿ç”¨keepäº†ï¼Œè¿™é‡Œè¿˜æœ‰å‡ ç§åˆ«çš„ï¼Œå¦‚ -keepclassmembers ä¸ä¿ç•™åŒ…å é˜²æ­¢æˆå‘˜è¢«ç§»é™¤æˆ–è€…è¢«é‡å‘½å -keepclasseswithmembers ä¿ç•™ç±»åå’Œæˆå‘˜å 1ï¼šåŸºæœ¬è§„åˆ™ ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ä¿å­˜å››å¤§ç»„ä»¶ï¼Œè‡ªå®šä¹‰viewä¸è¢«æ··æ·†ï¼Œå› ä¸º è¿™äº›å­ç±»éƒ½æœ‰å¯èƒ½è¢«å¤–éƒ¨è°ƒç”¨ã€‚ -keep public class * extends android.app.Activity -keep public class * extends android.app.Application -keep public class * extends android.support.multidex.MultiDexApplication -keep public class * extends android.app.Service -keep public class * extends android.content.BroadcastReceiver -keep public class * extends android.content.ContentProvider -keep public class * extends android.app.backup.BackupAgentHelper -keep public class * extends android.preference.Preference -keep public class * extends android.view.View -keep class android.support.** {*;} 2ï¼šåå°„ åå°„ç”¨åˆ°çš„ç±»ä¸€èˆ¬éœ€è¦ä¿ç•™ï¼Œå¦åˆ™ä¼šå‡ºç°é—®é¢˜ã€‚ å®ä½“ç±»ä¸è¢«æ··æ·† -keep class xxxx.info.Bean.** { *; } 3ï¼šæšä¸¾ä¸èƒ½è¢«æ··æ·† -keepclassmembers enum * { public static **[] values(); public static ** valueOf(java.lang.String); } 4ï¼šç»§æ‰¿çš„ä¿ç•™ -keep public class * extends android.support.v4.** -keep public class * extends android.support.v7.** -keep public class * extends android.support.annotation.** -keep class * implements android.os.Parcelable { public static final android.os.Parcelable$Creator *; } 5ï¼šjni æ–¹æ³•ä¸å¯æ··æ·† -keepclasseswithmembernames class * { native &lt;methods&gt;; } 6ï¼š èµ„æºæ–‡ä»¶ä¸è¢«æ··æ·† -keep class **.R$* { *; } -keepclassmembers class **.R$* { public static &lt;fields&gt;; } 7ï¼šwebviewçš„ä¸€äº›å¤„ç† -keepclassmembers class fqcn.of.javascript.interface.for.Webview { public *; } -keepclassmembers class * extends android.webkit.WebViewClient { public void *(android.webkit.WebView, java.lang.String, android.graphics.Bitmap); public boolean *(android.webkit.WebView, java.lang.String); } -keepclassmembers class * extends android.webkit.WebViewClient { public void *(android.webkit.WebView, jav.lang.String); } åœ¨appä¸­ä¸HTML5çš„JavaScriptçš„äº¤äº’è¿›è¡Œç‰¹æ®Šå¤„ç† æˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™äº›jsè¦è°ƒç”¨çš„åŸç”Ÿæ–¹æ³•ä¸èƒ½å¤Ÿè¢«æ··æ·†ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦åšå¦‚ä¸‹å¤„ç†ï¼š -keepclassmembers class com.ljd.example.JSInterface { &lt;methods&gt;; } 8ï¼šå…¶ä»–çš„ä¸€äº›æ“ä½œ åˆ é™¤ä»£ç ä¸­Logç›¸å…³çš„ä»£ç  -assumenosideeffects class android.util.Log { public static boolean isLoggable(java.lang.String, int); public static int v(...); public static int i(...); public static int w(...); public static int d(...); public static int e(...); } ä¿ç•™æµ‹è¯•ç›¸å…³çš„ä»£ç  -dontnote junit.framework.** -dontnote junit.runner.** -dontwarn android.test.** -dontwarn android.support.test.** -dontwarn org.junit.** å¦å¤–è¿˜æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„æˆ‘è¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†ï¼Œæ¥å…¥æ—¶æ–‡æ¡£éƒ½ä¼šç»™å‡ºæ··æ·†ç­–ç•¥ã€‚","categories":[{"name":"ANDROID","slug":"ANDROID","permalink":"http://weafteam.github.io/categories/ANDROID/"}],"tags":[{"name":"ANDROID","slug":"ANDROID","permalink":"http://weafteam.github.io/tags/ANDROID/"}]},{"title":"Python ç±»å‹ç³»ç»Ÿçš„ä¸‹ä¸€æ­¥","slug":"2018-06-18/next-steps-with-python-type-system","date":"2018-08-10T17:35:33.000Z","updated":"2018-08-12T09:51:01.089Z","comments":true,"path":"posts/684b8f9/","link":"","permalink":"http://weafteam.github.io/posts/684b8f9/","excerpt":"","text":"å†™åœ¨å‰é¢ æœ¬æ–‡ç¿»è¯‘è‡ª Next Steps with Python Type Systemã€‚ è‡ªè±ªçš„é‡‡ç”¨æœç‹—ç¿»è¯‘ã€‚ è¿™æ˜¯ Python ç±»å‹ç³»ç»Ÿçš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å±•ç¤º Python ç±»å‹çš„ä¸€äº›æ›´é«˜çº§çš„ç‰¹æ€§ã€‚æ­¤å¤–ä¹Ÿä¼šåŒ…æ‹¬ä¸€äº›å…³äºä½¿ç”¨ç‰¹å®šç±»å‹åŠŸèƒ½çš„æç¤ºï¼Œå’Œä¸€ä¸ªå¦‚ä½•å°†ç±»å‹ç³»ç»Ÿå¼•å…¥ä½ çš„ä»£ç åº“ä¸­çš„ç®€çŸ­æŒ‡å—ã€‚ 1. çº¦æŸç±»å‹ åœ¨ä¸Šä¸€ç¯‡åšå®¢æ–‡ç« ä¸­æè¿°äº† Optional ç±»å‹ã€‚è®©æˆ‘ä»¬å›åˆ°å±•ç¤ºå…¶ç”¨æ³•çš„ç‰‡æ®µï¼š 1234567891011121314from typing import Optionaldef get_user_id() -&gt; Optional[int]: passdef process_user_id(user_id: int): passuser_id = get_user_id()process_user_id(user_id) # é”™è¯¯:# Argument 1 to \"process_user_id\" has incompatible type \"Optional[int]\"; expected \"int\" mypy ç±»å‹æ£€æŸ¥å™¨æŠ¥å‘Šçš„é”™è¯¯ç¡®å®æ˜¯æ­£ç¡®å’Œæœ‰ç”¨çš„ã€‚ä½†æ˜¯å¦‚æœä½ çœŸçš„çŸ¥é“åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­ get_user_id() ä¼šè¿”å›ä¸€ä¸ª intï¼Œè€Œä½ åªæƒ³æŠŠå®ƒä¼ é€’ç»™ process_user_id() æ€ä¹ˆåŠï¼Ÿé¦–å…ˆï¼Œè€ƒè™‘ä¸€ä¸‹ä½ çš„ç¨‹åºç»“æ„æ˜¯å¦ä¸å¤æ‚ï¼Œæ˜¯å¦éœ€è¦é‡æ„ã€‚ä½ è¿˜æƒ³è¿™ä¹ˆåšå—ï¼Ÿå—¯ï¼Œæˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼é€šçŸ¥mypy ç±»å‹å·²ç»æ”¹å˜äº†ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ç§å˜åŒ–å®é™…ä¸Šæ˜¯é™åˆ¶æ€§çš„ï¼šä» Optional[int] ï¼ˆå³ Union[int, None]ï¼‰åˆ° intã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°è¯•æœ€æ˜¾è€Œæ˜“è§çš„æ–¹æ³•æ¥å®ç°å®ƒã€‚ 1.1 å…·æœ‰æ–°çš„ç±»å‹æ³¨è§£çš„ç±»å‹çº¦æŸ [ä¸æ­£ç¡®] æœ€ç®€å•çš„æ–¹æ³•ä¼¼ä¹æ˜¯ç”¨æ›´ä¸¥æ ¼çš„ç±»å‹æ³¨è§£å˜é‡ã€‚ 12345user_id: int = get_user_id() # é”™è¯¯:# Incompatible types in assignment (expression has type \"Optional[int]\",# variable has type \"int\")process_user_id(user_id) ç„¶è€Œæˆ‘ä»¬ä¸èƒ½è¿™æ ·åšã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºç±»å‹æ³¨è§£ä¸ä¼šå¼ºåˆ¶å˜é‡ä½¿ç”¨ç±»å‹ï¼Œå®ƒå‘ŠçŸ¥ç±»å‹ã€‚å¦‚æœæœ‰ä»»ä½•ä¸ä¸€è‡´ï¼Œç±»å‹æ£€æŸ¥å™¨ä¼šæŠ¥å‘Šå®ƒã€‚äº‹å®ä¸Šï¼Œå¦‚æœè¿™ç§æ–¹æ³•æ˜¯æ­£ç¡®çš„ï¼Œæ•´ä¸ªç±»å‹æ£€æŸ¥æ€æƒ³å°±ä¼šå´©æºƒã€‚ ç±»å‹æ£€æŸ¥æ€æƒ³ä¼šå´©æºƒï¼Œç‰¹åˆ«æ˜¯å½“ä¸€ä¸ªæ–°ç±»å‹ä¸æ˜¯æ—§ç±»å‹çš„å­ç±»å‹æ—¶ï¼ˆå¦‚ int å’Œ strï¼‰ã€‚æˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸€ç§å‡è®¾çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œmypy ä¼šæ¥å—ç±»å‹çº¦æŸï¼ˆé€šè¿‡ä½¿ç”¨æ³¨è§£å°†ç±»å‹ä»æ›´ä¸€èˆ¬çš„ç±»å‹å˜ä¸ºä¸å¤ªä¸€èˆ¬çš„ç±»å‹ï¼‰ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒå°†ä¼šä» Union[int, None] çº¦æŸåˆ° intã€‚ä½†æ˜¯ï¼Œç›®å‰å®ƒä¸å—æ”¯æŒã€‚ è‡³å°‘æœ‰ä¸¤ç§æ­£ç¡®çš„æ–¹æ³•å¯ä»¥é€šçŸ¥ mypy ç±»å‹æ£€æŸ¥å™¨ä¸åŒäºé¢„æœŸçš„ç±»å‹ã€‚ 1.2 å…·æœ‰ç±»å‹æ£€æŸ¥çš„ç±»å‹çº¦æŸ [æ­£ç¡®] æ›´æ”¹ç±»å‹çš„æ­£ç¡®æ–¹æ³•æ˜¯ç¡®ä¿æ–°ç±»å‹çš„ isinstance è¿”å› Trueï¼š 123456789101112user_id = get_user_id()if isinstance(user_id, int): process_user_id(user_id) # æ²¡æœ‰é”™è¯¯# æˆ–è€…assert isinstance(user_id, int)process_user_id(user_id) # æ²¡æœ‰é”™è¯¯# åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å¯ä»¥if user_id is not None: process_user_id(user_id) # æ²¡æœ‰é”™è¯¯ ç°åœ¨ï¼Œmypy ç¡®ä¿¡ user_id å…·æœ‰æ­£ç¡®çš„ç±»å‹â€”â€”å¦åˆ™ï¼Œå°†ä¸ä¼šæ‰§è¡Œå¯¹ process_user_id çš„è°ƒç”¨ã€‚ è¯·æ³¨æ„ï¼Œä½¿ç”¨ isinstance ä¼šå¸¦æ¥å°‘é‡è¿è¡Œæ—¶å¼€é”€ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šå¾—åˆ°é¢å¤–çš„è¿è¡Œæ—¶æ£€æŸ¥ï¼Œè¿™å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚ 1.3 å…·æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢çš„ç±»å‹çº¦æŸ [æ­£ç¡®] å‘Šè¯‰ mypy è¯¥ç±»å‹å—åˆ°çº¦æŸï¼ˆæˆ–ä»¥å…¶ä»–æ–¹å¼æ›´æ”¹ï¼‰çš„å¦ä¸€ä¸ªæ­£ç¡®æ–¹æ³•æ˜¯ä½¿ç”¨ cast å‡½æ•°ã€‚è¿™åœ¨ PEP 484 ä¸­æœ‰æ˜ç¡®æè¿°ã€‚ 1234from typing import castuser_id = cast(int, get_user_id())process_user_id(user_id) # æ²¡æœ‰é”™è¯¯ æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨ typing æ¨¡å—ä¸­å®šä¹‰çš„ã€‚ç±»å‹ç³»ç»Ÿä¸åº”å¯¹è¿è¡Œæ—¶äº§ç”Ÿä»»ä½•å½±å“ï¼Œè¿™ä¸ªå‡½æ•°ä¿æŒäº†è¿™ä¸ªæ‰¿è¯ºï¼ˆé™¤äº†ç©ºå‡½æ•°è°ƒç”¨ï¼‰â€”â€”åœ¨ Python çš„æºä»£ç ä¸­ï¼Œå®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªèº«ä»½å‡½æ•° ï¼ˆåˆ é™¤äº† docstringï¼‰ï¼š 12def cast(typ, val): return val å› æ­¤ä¸æ‰§è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚å½“ä½¿ç”¨ cast æ—¶ï¼Œå¯¹äºç±»å‹æ£€æŸ¥è€…æ¥è¯´ï¼Œç›²ç›®ç›¸ä¿¡è¿™ç§æ–°ç±»å‹æ˜¯ä¸€æ¡å‘½ä»¤ã€‚ è¯·æ³¨æ„ï¼Œä½¿ç”¨ cast å¯èƒ½ä¼šæ©ç›–é”™è¯¯ï¼šå‰ä¸€ç§ç±»å‹â€”â€”å¯èƒ½æ˜¯æ­£ç¡®çš„â€”â€”ä¼šè¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒçš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº Any å’Œ #type: ignoreï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œå› æ­¤è¦å°å¿ƒä½¿ç”¨ã€‚ 2. ç»„åˆç±»å‹å¹¶å®šä¹‰ç±»å‹åˆ«å Python çš„ç±»å‹å¯ä»¥è‡ªç”±ç»„åˆã€‚æƒ³è¦ä¸€ä¸ªæ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²æˆ– None çš„åˆ—è¡¨å—ï¼Ÿåªéœ€ä½¿ç”¨ï¼š 1List[Union[int, float, str, None]] æˆ–è€… 1List[Optional[Union[int, float, str]]] éšä¾¿ä½ ã€‚ ç”±å­—ç¬¦ä¸²ç»„æˆçš„å…ƒç»„å’Œç”±æ•´æ•°ç»„æˆçš„å…ƒç»„åˆ—è¡¨ä»¥åŠç”±æ•´æ•°ã€å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²åˆ—è¡¨ç»„æˆçš„å…ƒç»„åˆ—è¡¨æ€ä¹ˆæ ·ï¼Ÿä¹Ÿå¾ˆç›´ç™½ğŸ˜…ï¼š 1Tuple[str, List[Tuple[int, List[Tuple[int, str, List[str]]]]]] çœ‹èµ·æ¥å¾ˆæœ‰è¶£ï¼ä¸æ˜¯å—ï¼Ÿäº‹å®ä¸Šï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šåœ¨ç¨‹åºä¸­ä½¿ç”¨è¿™äº›å¤æ‚çš„æ•°æ®ç±»å‹ã€‚å¦‚ä½•å°†ç±»å‹æ³¨è§£ä¸å®ƒä»¬ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸è¦å¤±å»ç†æ™ºï¼Ÿ è¦ä½¿ç±»å‹æ›´æ˜“äºç®¡ç†å’Œé˜…è¯»ï¼Œè¯·ä½¿ç”¨ç±»å‹åˆ«åã€‚è¦åˆ›å»ºåˆ«åï¼Œåªéœ€ä¸ºå˜é‡åˆ†é…ä¸€ä¸ªç±»å‹ï¼šalias = Tã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ alias ä»£æ›¿ Tã€‚ è¿™é‡Œçš„å…³é”®æ˜¯æ­£ç¡®å‘½ååˆ«åã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆ›å»ºåæ˜ å‘½åç±»å‹ç»“æ„çš„åˆ«åï¼Œå¦‚ ListOfListsOfDictsFromStrToIntOrFloatï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ„ä¹‰ã€‚è¦ä½¿ç”¨å†…éƒ¨åæ˜ â€œä¸šåŠ¡å¯¹è±¡â€çš„åç§°ã€‚åŒæ ·ï¼Œç›¸åº”åœ°åµŒå¥—åˆ«åã€‚åƒè¿™æ ·ï¼š 123456789101112131415from typing import List, TupleItemId = intItemName = strItemTag = strItemTags = List[ItemTag]Item = Tuple[ItemId, ItemName, ItemTags]Items = List[Item]OrderId = intOrder = Tuple[OrderId, Items]Orders = List[Order]ShipmentId = strShipment = Tuple[ShipmentId, Orders] ä½¿ç”¨ NamedTuple æ¥å®šä¹‰ Itemã€Order å’Œ Shipment å°†ä¼šè¿›ä¸€æ­¥æé«˜æˆ‘ä»¬ä»£ç çš„å¯è¯»æ€§ã€‚å¦å¤–ï¼Œåœ¨ç°å®çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨è‡ªå®šä¹‰ç±»æ¥ä»£æ›¿ã€‚å°½ç®¡å¦‚æ­¤ï¼Œç±»å‹åˆ«åä»ç„¶æ˜¯æœ‰ç”¨çš„ã€‚ Shipment çœ‹èµ·æ¥æ¯” Tuple[str, List[Tuple[int, List[Tuple[int, str, List[str]]]]]] å¥½å¾—å¤šï¼Œä¸æ˜¯å—ï¼Ÿéœ€è¦é”®å…¥çš„å­—ç¬¦ä¹Ÿå°‘å¾—å¤šã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥ç”¨ä¸šåŠ¡ç›¸å…³çš„ç±»å‹æ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213def generate_item_id() -&gt; ItemId: passdef create_item(name: ItemName, tags: ItemTags) -&gt; Item: passdef create_order(items: Items) -&gt; Order: passdef make_order(order: Order): pass# ç­‰ç­‰ ä»£ç æ›´æ¸…æ™°ï¼Œä¸šåŠ¡é€»è¾‘æ˜æ˜¾ã€‚æ­¤å¤–ï¼Œç±»å‹æ³¨è§£å’Œç±»å‹æœ¬èº«çš„é”™è¯¯æ›´å®¹æ˜“è¢«å‘ç°ã€‚ 3. NewType å‡½æ•° åœ¨æœ€åä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸ºä¸€ä¸ªç®€å•çš„ç±»å‹åˆ†é…äº†åˆ«åï¼Œå¦‚ ItemId = intã€‚å³ä½¿æ˜¯è¿™ä¸ªç®€å•çš„åˆ«åä¹Ÿæœ‰æ„ä¹‰ï¼Œå› ä¸ºå®ƒè¡¨ç¤ºè¿™ä¸ªç‰¹å®šæ•´æ•°çš„â€œæ„ä¹‰â€ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒå¹¶ä¸èƒ½ä¿æŠ¤æˆ‘ä»¬å…å—ä»¥ä¸‹é”™è¯¯çš„å½±å“ï¼š 123456789101112131415161718ItemId = intOrderId = intdef get_last_item_id() -&gt; ItemId: passdef get_last_order_id() -&gt; OrderId: passdef get_order(id_: OrderId): passorder_id = get_last_item_id()order = get_order(order_id) # æ²¡æœ‰é”™è¯¯ mypy å¾ˆå¼€å¿ƒï¼ŒIDE å¾ˆå¼€å¿ƒï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå¼€å¿ƒã€‚è®©æˆ‘ä»¬ç¥ˆç¥·è¿›è¡Œä»£ç å®¡æŸ¥çš„äººä¼šå‘ç°é”™è¯¯ï¼ ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é¢å¤–å®šä¹‰ç›´æ¥ä» int ç»§æ‰¿çš„å­ç±»ï¼ˆå­ç±»å‹ï¼‰ï¼š 1234567891011121314151617181920212223class ItemId(int): passclass OrderId(int): passdef get_last_item_id() -&gt; ItemId: passdef get_last_order_id() -&gt; OrderId: passdef get_order(id_: OrderId): passorder_id = get_last_item_id()order = get_order(order_id) # é”™è¯¯:# Argument 1 to \"get_order\" has incompatible type \"ItemId\"; expected \"OrderId\" å¾ˆå¥½ï¼Œé”™è¯¯è¢«å‘ç°äº†ã€‚ä¸å¹¸çš„æ˜¯ï¼Œé€šè¿‡é¢å¤–çš„æ„é€ å‡½æ•°ä¼ é€’å€¼ä¼šå¸¦æ¥è¿è¡Œæ—¶å¼€é”€ã€‚å½“æˆ‘ä»¬å¿…é¡»å¤„ç†è®¸å¤šå®ä¾‹æ—¶ï¼Œè¿™å°¤å…¶ç—›è‹¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œtyping æ¨¡å—å…·æœ‰ NewType å‡½æ•°ã€‚å®ƒç”¨äºå®šä¹‰ä¸åŒçš„å­ç±»å‹ï¼š 123456789101112131415161718192021from typing import NewTypeItemId = NewType(\"ItemId\", int)OrderId = NewType(\"OrderId\", int)def get_last_item_id() -&gt; ItemId: passdef get_last_order_id() -&gt; OrderId: passdef get_order(id_: OrderId): passorder_id = get_last_item_id()order = get_order(order_id) # é”™è¯¯:# Argument 1 to \"get_order\" has incompatible type \"ItemId\"; expected \"OrderId\" NewType åªæ˜¯è¿”å›ä¸€ä¸ªèº«ä»½å‡½æ•°ï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶æ²¡æœ‰å®šä¹‰å­ç±»ã€‚æ­¤å¤–ï¼Œè¿™åªä¼šå¸¦æ¥æœ€å°çš„å¼€é”€ã€‚è¯·å‚è§è¿™é‡Œçš„æºä»£ç ã€‚ ä½¿ç”¨ç”¨ NewType å®šä¹‰çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­æ·»åŠ é¢å¤–çš„ç±»å‹â€œè·Ÿè¸ªâ€ã€‚è¿™åœ¨å®‰å…¨ç¯å¢ƒä¸­å¯èƒ½å¾ˆæ–¹ä¾¿â€”â€”ä¾‹å¦‚åŒºåˆ†å®‰å…¨å’Œï¼ˆæ½œåœ¨çš„ï¼‰ä¸å®‰å…¨å­—ç¬¦ä¸²ã€‚ 12345678910111213from typing import NewTypeSafeStr = NewType('SafeStr', str)safe_code = SafeStr('2 + 2')user_provided_code = 'import sys; sys.melt_cpu()'def exec_code(string: SafeStr): exec(string)exec_code(safe_code)exec_code(user_provided_code) # é”™è¯¯:# Argument 1 to \"exec_code\" has incompatible type \"str\"; expected \"SafeStr\" è¯·æ³¨æ„ï¼Œè·å– user_provided_code çš„å€¼å¯èƒ½ç¦»å¯¹ exec_code çš„è°ƒç”¨å¾ˆè¿œï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ mypy å¸®åŠ©ï¼Œå¾ˆéš¾å‘ç°å®ƒæ˜¯ä¸å®‰å…¨çš„ã€‚ åœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ NewTypeâ€”â€”åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ SafeStr('2 + 2')ï¼ˆç¬¬ 5 è¡Œï¼‰â€”â€”ä¼ é€’å€¼å‡ ä¹æ²¡æœ‰å¼€é”€ï¼Œå®é™…ä¸Šæ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚å¯¹ mypy æ¥è¯´ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼å°±åƒ cast(SafeStr, '2 + 2')ã€‚ 4. å¯è°ƒç”¨ç±»å‹ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®šä¹‰äº†å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†ä¸€ä¸ªå‡½æ•°æœ¬èº«ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼ˆåœ¨ Python ä¸­ï¼Œå‡½æ•°æ˜¯ç¬¬ä¸€ç±»å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·åšï¼‰æ€ä¹ˆåŠâ€”â€”æˆ‘ä»¬å¦‚ä½•è¡¨è¾¾ä¼ é€’å‡½æ•°çš„ç±»å‹ï¼Ÿ è®©æˆ‘ä»¬ç¦»é¢˜ä¸€ä¼šå„¿â€¦â€¦åœ¨ Python çš„ç±»å‹ç³»ç»Ÿä¸­ï¼Œå‡½æ•°çš„ç±»å‹å°±åƒä»»ä½•å…¶ä»–ç±»å‹ä¸€æ ·ï¼ˆè®°ä½ï¼šå‡½æ•°æ˜¯ç¬¬ä¸€ç±»å¯¹è±¡ï¼Œå°±åƒæ•´æ•°æˆ–å­—ç¬¦ä¸²ä¸€æ ·ï¼‰ã€‚èµ·åˆè¿™å¯èƒ½ä»¤äººæƒŠè®¶ï¼Œä½†å¦‚æœä½ ä»”ç»†æƒ³æƒ³ï¼Œè¿™æ˜¯å¾ˆè‡ªç„¶çš„ã€‚ä¾‹å¦‚ï¼Œè¿™æ ·æ³¨è§£çš„å‡½æ•°ç±»å‹ï¼š 1def fun(arg: str) -&gt; int: ... å¯ä»¥è¢«è®¤ä¸ºæ˜¯â€œstr åˆ° intâ€ã€‚äº‹å®ä¸Šï¼Œå‡½æ•°çš„ç±»å‹åœ¨æŸç§ç¨‹åº¦ä¸Šéå¸¸ç±»ä¼¼äº Dict ç±»å‹ï¼Œå®ƒå°†ä¸€ä¸ªå€¼â€œæ˜ å°„â€åˆ°å¦ä¸€ä¸ªå€¼ï¼›åƒ Dict[str, int] å°† str æ˜ å°„åˆ° intã€‚ä»ç±»å‹çš„è§’åº¦æ¥çœ‹ï¼Œå‡½æ•°æ›´å¤æ‚â€”â€”å¯ä»¥æ²¡æœ‰ã€ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œå­—å…¸åªæœ‰ä¸€ä¸ªé”®ã€‚ç„¶è€Œï¼Œæ˜ å°„çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Python ä¸­ï¼Œæè¿°å‡½æ•°ç±»å‹ï¼ˆå’Œå…¶ä»–å¯è°ƒç”¨ç±»å‹ï¼‰æ—¶ä½¿ç”¨ Callable ç±»å‹ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š Callable[[t1, t2, â€¦, tn], tr] å…·æœ‰ä½ç½®å‚æ•°ç±»å‹ t1 ç­‰çš„å‡½æ•°ï¼Œè¿”å›ç±»å‹ trã€‚[æ¥æº] è®©æˆ‘ä»¬çœ‹çœ‹ï¼š 1234567891011121314from typing import Callable, Listdef apply_function_on_value(func: Callable[[str], int], value: str) -&gt; int: return func(value)def text_length(text: str) -&gt; int: return len(text)result1 = apply_function_on_value( func=text_length, value=\"I know a dead parrot when I see one.\") # æ²¡æœ‰é”™è¯¯ apply_function_on_value å°†ä¸€ä¸ªå‡½æ•° func ä½œä¸ºå®ƒç¬¬ä¸€ä¸ªå‚æ•°å¹¶å°†å®ƒåº”ç”¨äºå…¶ç¬¬äºŒä¸ªå‚æ•° valueã€‚è¿™ä¸ªå‡½æ•°çš„ç±»å‹ä¸ºâ€œstr åˆ° intâ€ï¼Œæˆ–è€… Callable[[str], int]ã€‚æ‰€ä»¥å°† text_length å‡½æ•°ï¼ˆå®ƒåªæ˜¯å®šä¹‰åœ¨å­—ç¬¦ä¸²ä¸Šçš„ len å‡½æ•°ï¼‰ä¼ é€’ç»™å®ƒæ˜¯æ­£ç¡®çš„ï¼Œå› ä¸º func è¢«å®šä¹‰ä¸ºè·å– str å¹¶è¿”å› intã€‚ 123456789def append_parrot(text: str) -&gt; str: return text + ' Parrot!'result2 = apply_function_on_value( func=append_parrot, value=\"Now that's what I call a dead parrot.\",) # é”™è¯¯:# Argument \"func\" to \"apply_function_on_value\" has incompatible type# \"Callable[[str], str]\"; expected \"Callable[[str], int]\" append_parrot æ— æ³•æ­£ç¡®ä¼ é€’ç»™ apply_function_on_valueï¼Œå› ä¸ºå®ƒä¸ func ç±»å‹ä¸å…¼å®¹ï¼šè¿”å›ä¸€ä¸ª strï¼Œè€Œä¸æ˜¯ intã€‚ 5. Any ç±»å‹ä¸å…³é—­ mypy æ£€æŸ¥ Python çš„ç±»å‹è§„åˆ™éå¸¸ä¸¥æ ¼ï¼Œä½†æ˜¯ Python ä¸ºä½ ä¸æƒ³è®© mypy æŠ±æ€¨æŸä¸ªç±»å‹çš„æƒ…å†µæä¾›äº†æ¼æ´ã€‚è¿™ä¸ªæ¼æ´æ˜¯ Any ç±»å‹ã€‚Any ä¸æ¯ç§ç±»å‹éƒ½ä¸€è‡´ï¼Œæ¯ç§ç±»å‹éƒ½ä¸ Any ä¸€è‡´ã€‚ å½“ä¸€ä¸ªå€¼å…·æœ‰ç±»å‹ Any æ—¶ï¼Œç±»å‹æ£€æŸ¥å™¨å°†å…è®¸å¯¹å…¶è¿›è¡Œæ‰€æœ‰æ“ä½œï¼Œå¹¶ä¸”ç±»å‹ Any çš„å€¼å¯ä»¥åˆ†é…ç»™ä¸€ä¸ªæ›´å—çº¦æŸç±»å‹çš„å˜é‡ï¼ˆæˆ–è€…ç”¨ä½œè¿”å›å€¼ï¼‰ã€‚[æ¥æº] è®©æˆ‘ä»¬è¯æ˜ä¸€ä¸‹ï¼š 12345678910111213141516from typing import Anyclass Dog: ...# æ£€æŸ¥ç±»å‹lassie: Doganything1: Anylassie = anything1 # æ²¡æœ‰é”™è¯¯scooby: Doganything2: Anyanything2 = scooby # æ²¡æœ‰é”™è¯¯# æ£€æŸ¥å±æ€§anything3: Anyanything3.enter_hiperspace() # æ²¡æœ‰é”™è¯¯ æ­£å¦‚æ–‡æ¡£æ‰€è¿°ï¼š Any å¯ä»¥è¢«è®¤ä¸ºæ˜¯å…·æœ‰æ‰€æœ‰å€¼å’Œæ‰€æœ‰æ–¹æ³•çš„ç±»å‹ã€‚ç»“åˆä¸Šé¢çš„å­ç±»å‹å®šä¹‰ï¼Œè¿™å°† Any éƒ¨åˆ†çš„æ”¾åœ¨ç±»å‹å±‚æ¬¡ç»“æ„çš„é¡¶éƒ¨ï¼ˆå®ƒæœ‰æ‰€æœ‰å€¼ï¼‰å’Œåº•éƒ¨ï¼ˆå®ƒæœ‰æ‰€æœ‰æ–¹æ³•ï¼‰ã€‚æ¥æº å¯ä»¥è¿™æ ·è¡¨ç¤ºï¼š 12345678910111213141516 Any &lt;- æ‰€æœ‰ç±»å‹éƒ½æ˜¯ Any / \\ (å°±åƒ `object` /* \\* -- æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ `object`) / \\ SomeType1 SomeType2 / | | \\ / | | \\ / | | \\ Subtype1_1 Subtype1_2 Subtype2_1 Subtype2_2 | | | | |* |* |* |* | | | | Any Any Any Any &lt;- Any æœ‰æ‰€æœ‰å±æ€§ (ä¸åƒ `object` -- `object` æ²¡æœ‰å±æ€§)* ä¸€è‡´æ€§å…³ç³»ï¼Œä¸æ˜¯å­ç±»å‹ï¼Œè§ä¸‹æ–‡ è¯·æ³¨æ„ï¼Œä¸¥æ ¼æ¥è¯´ï¼ŒAny ç±»å‹å’Œå…¶ä»–ç±»å‹ä¹‹é—´çš„å…³ç³»ä¸æ˜¯å¾®å¦™çš„å…³ç³»ï¼Œè€Œæ˜¯ä¿æŒä¸€è‡´çš„å…³ç³»ã€‚æœ‰å…³æ­£å¼å®šä¹‰å’Œæ›´å¤šä¸Šä¸‹æ–‡ï¼Œè¯·å‚è§è¿™é‡Œã€‚ å®é™…ä¸Šï¼ŒAny åªæ˜¯å…³é—­å®ƒæ­£åœ¨æ³¨è§£çš„é¡¹ç›®çš„ mypy æ£€æŸ¥ã€‚ç¦ç”¨ mypy æ£€æŸ¥çš„å¦ä¸€ç§æ›´æ®‹é…·çš„æ–¹æ³•æ˜¯ä½¿ç”¨ # type: ignoreã€‚åœ¨ä½ æƒ³è®© mypy é”™è¯¯æ¶ˆå¤±çš„è¡Œä¸Šä½¿ç”¨å®ƒï¼š 123456789height: intheight = '25' # type: ignore# æ²¡æœ‰é”™è¯¯class Dog: passlassie: Doglassie.fly() # type: ignore# æ²¡æœ‰é”™è¯¯ Any çš„ä½¿ç”¨åº”è¯¥å°½å¯èƒ½å°‘ï¼Œè€Œä½¿ç”¨ # type: ignore åº”è¯¥æ˜¯æœ€åä¸€æ‹›ã€‚å°¤å…¶æ˜¯å½“ä½ è®¤çœŸå¯¹å¾…æ•´ä¸ªç±»å‹å·¥ä½œçš„æ—¶å€™ã€‚ ä½ ç»å¯¹ä¸åº”è¯¥åœ¨ä¸‹åˆ—æƒ…å†µä¸‹ä½¿ç”¨å®ƒä»¬ï¼š ä½ æƒ³æ¨è¿Ÿæ³¨è§£ä¸€äº›ä¸œè¥¿ã€‚å¦‚æœä½ ç°åœ¨ä¸æƒ³æ·»åŠ ä¸€ä¸ªç±»å‹ï¼Œå°±è®©è¿™ä¸ªä¸œè¥¿æ²¡æœ‰ç±»å‹ã€‚Python ç±»å‹ç³»ç»Ÿæ˜¯å®Œå…¨å¯é€‰çš„â€”â€”æ‚¨å¯ä»¥è‡ªç”±æ³¨è§£ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ³¨è§£å¦ä¸€éƒ¨åˆ†ã€‚ ä½ ä¸ç†è§£ mypy çš„é”™è¯¯ä¿¡æ¯ï¼Œåªæƒ³æ‘†è„±å®ƒã€‚æœ‰æ—¶å€™å®ƒå¯èƒ½æ˜¯å¤ªç¥ç§˜æˆ–è€…å¤ªæ™®é€šäº†ï¼Œä½†æ˜¯çœŸçš„å€¼å¾—æ·±å…¥ç ”ç©¶è¿™ä¸ªé—®é¢˜ã€‚åœ¨æˆ‘çš„ç»éªŒä¸­ï¼Œå‡ ä¹æ¯æ¬¡ mypy éƒ½å‘ç°äº†ä»€ä¹ˆã€‚ Any åœ¨å“ªå¯èƒ½æœ‰ç”¨ï¼Ÿ å½“ä½ çœŸçš„ä¸çŸ¥é“å˜é‡çš„ç±»å‹æ—¶ï¼Œä½¿ç”¨ Anyã€‚å…¸å‹çš„ä¾‹å­æ˜¯ä»å¤–éƒ¨æä¾›çš„ JSON åˆ›å»ºçš„æ•°æ®ã€‚è¿™æ ·åˆ›å»ºçš„å˜é‡çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯ä¸€ä¸ª listï¼Œdictï¼Œintï¼Œfloatï¼Œbool è¿˜æ˜¯ Noneï¼Ÿä¹Ÿå¯ä»¥æ˜¯ Anyã€‚è¯·æ³¨æ„ï¼Œä½¿ç”¨åµŒå¥—ç±»å‹ï¼ˆDictã€List ç­‰ï¼‰æ­£ç¡®å®šä¹‰ JSON æ ¼å¼æ˜¯ä¸å¯èƒ½çš„ï¼ˆæˆ–è€…è‡³å°‘éå¸¸å›°éš¾ï¼‰ï¼Œå› ä¸º JSON çš„é€’å½’ç»“æ„ã€‚ # type: ignore åœ¨å“ªå¯èƒ½æœ‰ç”¨ï¼Ÿ å½“ mypy ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œè¿è¡Œæ—¶å‘ç”Ÿäº†ä¸€äº›å˜åŒ–â€”â€”å°±åƒæ–¹æ³•è¢«åŠ¨æ€æ·»åŠ åˆ°ç±»ä¸­æˆ–è€…ç±»å±‚æ¬¡ç»“æ„å‘ç”Ÿäº†å˜åŒ–ã€‚å¦‚æœ mypy çš„é”™è¯¯çœŸçš„ä¸å¤ªèƒœä»»ï¼Œå¹¶ä¸”ä½ æ— æ³•æƒ³å‡ºå¦ä¸€ç§æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ # type: ignore ã€‚ä½†æ˜¯é¦–å…ˆï¼Œè¯•ç€ç†è§£ä¸ºä»€ä¹ˆ mypy åœ¨æŠ±æ€¨ã€‚äº‹å®ä¸Šï¼Œmypy æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„åå‘³é“ä»£ç æ£€æµ‹å™¨ã€‚ å½“æŸäº›ä¸œè¥¿è¿˜ä¸å…¼å®¹ mypy æ—¶ï¼ˆæ¯”å¦‚ enumsï¼Œä¸€å¼€å§‹ä¸æ”¯æŒï¼‰ã€‚ mypy ä¸­æœ‰ bugã€‚è®°å¾—åœ¨ github ä¸Šæå‡ºè¿™ä»¶äº‹ï¼ Q&amp;A å¦‚æœä½ è¿˜ä¸èƒ½è¢«è¯´æœå¼€å§‹ä½¿ç”¨ Python ç±»å‹ç³»ç»Ÿï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚ æˆ‘å–œæ¬¢æˆ‘çš„ Python ä»£ç å…·æœ‰åŠ¨æ€æ€§å’Œé¸­å­ç±»å‹ã€‚ç±»å‹ä¼šæ¯äº†è¿™ä¸€åˆ‡ã€‚æ˜¯å—ï¼Ÿ é¦–å…ˆï¼Œmypy ç¡®å®ä¸ä¼šç†è§£ä¸€äº›ä¸è¯­è¨€çš„åŠ¨æ€ç‰¹æ€§ç›¸å…³çš„è¿è¡Œæ—¶é»‘ç§‘æŠ€ã€‚ç„¶è€Œï¼Œä½œä¸ºå›æŠ¥ï¼Œä½ ä¼šå¾—åˆ°æ›´å¯é çš„ä»£ç ã€‚ å…¶æ¬¡ï¼ŒPython ç±»å‹ç³»ç»Ÿæ”¯æŒåè®®ï¼ˆä¹Ÿç§°ä¸ºâ€œé¸­å­ç±»å‹â€ï¼‰ï¼Œæ—¢æ”¯æŒå†…ç½®åè®®ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·å®šä¹‰çš„åè®® ï¼ˆæœ¬ä¸»é¢˜ä¸åœ¨æ­¤è®¨è®ºï¼‰ã€‚æ‰€ä»¥ä¸ç”¨æ‹…å¿ƒã€‚ å¦ç™½åœ°è¯´ï¼Œæˆ‘ä¸å–œæ¬¢è¿™æ•´ä»¶ç±»å‹ç³»ç»Ÿçš„äº‹æƒ…ã€‚æ˜¯ä¸æ˜¯æ…¢æ…¢åœ°å°† Python å˜æˆäº† Javaï¼Ÿ ä¸è¦æ‹…å¿ƒï¼Œä¸ Java ä¸åŒï¼ŒPython çš„ç±»å‹ç³»ç»Ÿï¼š å®Œå…¨å¯é€‰ï¼ˆ*ï¼‰ï¼Œ ä¸ä¼šå½±å“è¿è¡Œæ—¶ï¼ˆ**ï¼‰ã€‚ ï¼ˆ*ï¼‰å¥½å§ï¼Œä¸å®Œå…¨æ˜¯ï¼Œdataclasses å¼ºè¿«ä½ ä½¿ç”¨ç±»å‹ã€‚å¸Œæœ›è¿™æ˜¯ä¸€ä¸ªå¼‚ç«¯ã€‚ ï¼ˆ**ï¼‰å¥½å§ï¼Œä¸å®Œå…¨æ˜¯â€¦â€¦ é¦–å…ˆï¼Œä» typing ä¸­å¯¼å…¥ä¼šå½±å“ã€‚å…¶æ¬¡ï¼Œä¸€äº›å€¼â€”â€”ä¾‹å¦‚ cast å’Œ NewType â€”â€”é€šè¿‡èº«ä»½å‡½æ•°ä¼ é€’ã€‚ç¬¬ä¸‰ï¼Œæ³›å‹ç±»å‹ï¼ˆæœ¬æ–‡ä¸­æœªæ¶µç›–ï¼‰ä½¿ç”¨è‡ªå®šä¹‰å…ƒç±»ï¼Œè¿™å¯èƒ½ä¸ç”¨æˆ·å®šä¹‰çš„å…ƒç±»å†²çªï¼›åœ¨ Python 3.7 ä¸­ï¼Œè¿™ä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ æ²¡é”™ï¼Œä½†æ˜¯çœ‹çœ‹ç±»å‹åŒ–çš„ Python ä»£ç ï¼šæ›´åƒ Javaï¼Œè€Œä¸æ˜¯å¥½çš„è€ Pythonã€‚ è¿™å¯èƒ½æ˜¯ç¬¬ä¸€å°è±¡ï¼Œä½†æ˜¯ä½ çœŸçš„çœ‹è¿‡ä¼ä¸š Java ä»£ç åº“å—ï¼Ÿæˆ‘ä¸å¦è®¤ç±»å‹åŒ–çš„ Python ä»£ç çœ‹èµ·æ¥ä¸éç±»å‹åŒ–ä»£ç ä¸åŒï¼Œä½ éœ€è¦ä¹ æƒ¯é˜…è¯»å®ƒã€‚ä½†æ˜¯å½“ä½ è¿™æ ·åšçš„æ—¶å€™â€”â€”å¹¶ä¸”ä»£ç æœ¬èº«æ˜¯ä»¥ä¸€ç§èªæ˜çš„æ–¹å¼å…·æœ‰ç±»å‹çš„ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨åˆ«åï¼‰â€”â€”å®ƒä¼šå˜å¾—æ¯”æ·»åŠ ç±»å‹ä¹‹å‰æ›´åŠ æ˜“è¯»æ˜“æ‡‚ã€‚å®ƒä»ç„¶æ˜¯ Pythonic çš„ï¼Œå› ä¸ºå®ƒå¢åŠ äº†ä»£ç çš„æ¸…æ™°æ€§å’Œå¯è¯»æ€§ã€‚ å¥½å§ï¼Œè®©æˆ‘è¯•è¯•è¿™ä¸ªâ€¦ æˆ‘å¦‚ä½•å¼€å§‹åœ¨ä»£ç åº“ä¸­ä½¿ç”¨ç±»å‹æ³¨è§£ï¼Ÿ æˆ‘æ¨èä»¥ä¸‹æ­¥éª¤ï¼š ä»åœ¨ä½ çš„éç±»å‹åŒ–ä»£ç ä¸Šè¿è¡Œ mypy å¼€å§‹ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä½ å¯èƒ½ä¼šæƒŠè®¶äºå®ƒå·²ç»ç†è§£äº†è¿™ä¹ˆå¤šã€‚ï¼ˆæ‚¨å¯èƒ½å¸Œæœ›é¦–å…ˆä½¿ç”¨ --ignore-missing-imports å’Œ --follow-imports skip å‚æ•°æ¥è¿è¡Œå®ƒã€‚ï¼‰ ä¿®å¤æ‰€æœ‰åˆå§‹çš„ mypy é”™è¯¯ã€‚ ç°åœ¨ï¼Œåªéœ€å¼€å§‹å‘ä»£ç ä¸­æ·»åŠ ç±»å‹æ³¨è§£ã€‚ä½ å¯ä»¥ä»ä»»ä½•åœ°æ–¹å¼€å§‹ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºæœ€å¥½ä»æœ€é‡è¦çš„ä»£ç å¼€å§‹ã€‚è¿™æ ·ï¼Œä½ çš„ä»£ç åº“å°†ä¼šæ›´å¯é ã€‚ä¸è¦æ‹…å¿ƒé”™è¯¯çš„ç±»å‹æ³¨è§£ä¼šç ´åä½ çš„ä»£ç ï¼šç±»å‹ä¼šå°½å¯èƒ½å°‘åœ°å½±å“ Python çš„è¿è¡Œæ—¶ã€‚ ç»§ç»­æ·»åŠ ç±»å‹æ³¨è§£ã€‚è¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œæ·»åŠ ç±»å‹æ³¨è§£å°†å¼€å§‹è§æ•ˆã€‚ä½ å¯èƒ½ä¼šæ”¶åˆ°è¶Šæ¥è¶Šå¤šçš„æ•æ‰åˆ°çœŸæ­£é”™è¯¯çš„ mypy é”™è¯¯ã€‚ï¼ˆåªæ˜¯ä¸è¦å¿˜è®°è¿è¡Œ mypyã€‚ï¼‰ ä¸‹ä¸€æ­¥æ˜¯å°† mypy æ£€æŸ¥æ·»åŠ åˆ° CI æµç¨‹ï¼ˆä¹Ÿè®¸æ˜¯é¢„æäº¤é’©å­ï¼‰ä¸­ï¼Œå¹¶ä½¿ä»£ç å§‹ç»ˆæ›´åŠ å¯é ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä½ è‡´åŠ›äºç±»å‹ï¼Œæœ€å¥½æ³¨è§£æ‰€æœ‰æ–°ä»£ç ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œå½“æ‚¨åªæƒ³å¿«é€ŸåŸå‹åŒ–åŠŸèƒ½æ—¶ï¼Œè·³è¿‡æ³¨è§£é˜¶æ®µã€‚å½“ä½ çŸ¥é“ä»£ç ä¼šç¨³å®šä¸‹æ¥ï¼Œä½ å¯ä»¥æ·»åŠ ç±»å‹æ³¨è§£ã€‚ æ‚¨ä¹Ÿå¯ä»¥å°è¯•ä»ä½¿ç”¨è‡ªåŠ¨å·¥å…·æ·»åŠ ç±»å‹æ³¨è§£å¼€å§‹ã€‚pyannotate åº“ä»è¿è¡Œæ—¶è§‚å¯Ÿå®é™…ç±»å‹ä¸­è·å–ç±»å‹ä¿¡æ¯ã€‚ç±»ä¼¼åœ°ï¼Œpytest-annotate é€šè¿‡è¿è¡Œæµ‹è¯•å’Œè§‚å¯Ÿç±»å‹æ·»åŠ ç±»å‹æ³¨è§£ã€‚å¦å¤–ï¼Œpytype å¯ä»¥åŸºäºä»£ç çš„é™æ€åˆ†ææ·»åŠ æ³¨è§£ã€‚æˆ‘æ²¡æœ‰ä½¿ç”¨è¿™äº›å·¥å…·çš„ç»éªŒï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºä»”ç»†éªŒè¯å…¶ä¸­ä»»ä½•ä¸€ä¸ªå·¥å…·ç»™å‡ºçš„æ³¨è§£æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ç ”ç©¶è¿™äº›æ³¨è§£ç”šè‡³å¯èƒ½å¯¼è‡´å‘ç°ä»£ç ä¸­çš„ä¸€äº›é”™è¯¯ã€‚ å½“æˆ‘æ²¡æœ‰æ—¶é—´ç†è§£ mypy çš„é”™è¯¯æ—¶è¯¥æ€ä¹ˆåŠï¼Ÿ æ‰¾åˆ°æ—¶é—´ï¼Œå®ƒå¯èƒ½ä¼šæœ‰å›æŠ¥ã€‚ä¸è¦ç”¨ # type: ignoreï¼Œä½†æ˜¯å…ˆè¯•ç€ç†è§£è¿™ä¸ªé—®é¢˜ï¼ˆæœ‰æ—¶åœ¨ mypy é—®é¢˜é¡µé¢ä¸Šæœç´¢æ˜¯å”¯ä¸€çš„æ–¹æ³•ï¼‰ï¼Œåªæœ‰å½“ä½ ç¡®ä¿¡æ²¡æœ‰å¥½çš„é€‰æ‹©æ—¶ï¼Œæ‰ä½¿ç”¨å®ƒã€‚mypy å¯èƒ½ï¼Œå¾ˆå¯èƒ½ï¼Œå‘ç°äº†ä»€ä¹ˆä¸œè¥¿ã€‚ å¦ä¸€æ–¹é¢ï¼Œæ— è®ºä»£ä»·æ˜¯ä»€ä¹ˆï¼Œä¸è¦è¯•å›¾å–æ‚¦ mypyã€‚ç»éªŒæ³•åˆ™æ˜¯ï¼šä¸è¦ä»…ä»…ä¸ºäº†æŠ‘åˆ¶ mypy é”™è¯¯è€Œè®©ä»£ç å˜å¾—æ›´ç³Ÿã€‚å®ƒä»ç„¶åªæ˜¯ä¸€ç§å·¥å…·ã€‚ è¯·è®°ä½ï¼Œmypy æ­£åœ¨ä¸æ–­å‘å±•ã€‚å®ƒçš„é”™è¯¯ä¿¡æ¯è¶Šæ¥è¶Šå¥½ï¼Œè¯¯æŠ¥ï¼ˆä¸æ—¶è¢«å‘ç°ï¼‰ä¹Ÿè¶Šæ¥è¶Šå°‘ã€‚æ‰€ä»¥ï¼Œè®°å¾—åœ¨æ–°ç‰ˆæœ¬å‘å¸ƒæ—¶æ›´æ–° mypyã€‚","categories":[],"tags":[]},{"title":"Python ç±»å‹ç³»ç»Ÿçš„ç¬¬ä¸€æ­¥","slug":"2018-06-11/first-steps-with-python-type-system","date":"2018-08-08T13:52:35.000Z","updated":"2018-08-12T09:51:01.082Z","comments":true,"path":"posts/cde2bcff/","link":"","permalink":"http://weafteam.github.io/posts/cde2bcff/","excerpt":"","text":"å†™åœ¨å‰é¢ æœ¬æ–‡ç¿»è¯‘è‡ª First Steps with Python Type Systemã€‚ è‡ªè±ªçš„é‡‡ç”¨æœç‹—ç¿»è¯‘ã€‚ è¿™æ˜¯ä»€ä¹ˆç©æ„ï¼Ÿ åœ¨è¿‡å»å‡ å¹´ä¸­ï¼Œç±»å‹æ³¨è§£çš„è¯­æ³•å’Œè¯­ä¹‰é€æ¸è¢«å¼•å…¥ Python è¯­è¨€ã€‚ç±»å‹åœ¨ Python ä¸­ä»ç„¶æ˜¯ä¸€ä¸ªéå¸¸æ–°é¢–å¹¶ä¸”ç»å¸¸è¢«è¯¯è§£çš„ä¸»é¢˜ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šä»‹ç»å®ƒçš„åŸºç¡€çŸ¥è¯†ï¼Œè€Œä¸€äº›æ›´é«˜çº§çš„åŠŸèƒ½å°†å‡ºç°åœ¨æœ¬æ–‡çš„åç»­éƒ¨åˆ†ä¸­ã€‚ è¿™ç¯‡æ–‡ç« åŸºäº PEP 483: The Theory of Type Hintsï¼ŒPEP 484: Type Hintsï¼ŒPython ç±»å‹æ–‡æ¡£ï¼Œmypy çš„ github issuesï¼Œå’Œæˆ‘ä¸ªäººå¯¹äºç±»å‹åœ¨ç°å®ä»£ç æ–¹é¢çš„ç»éªŒã€‚æˆ‘åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬ä¸º Python 3.6 å’Œ mypy 0.620ã€‚ 1. ç±»å‹å’Œç±» ä¸ºäº†æ›´å¥½åœ°æŒæ¡ Python çš„ç±»å‹ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†ç±»å‹å’Œç±»ã€‚åœ¨å‘å¸ƒ PEP 483 å’Œ 484 ä¹‹å‰ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæœ‰äº›æ··ä¹±ã€‚ç°åœ¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œç±»å‹æ˜¯ç±»å‹æ£€æŸ¥å™¨æ¦‚å¿µï¼Œç±»æ˜¯è¿è¡Œæ—¶æ¦‚å¿µã€‚åœ¨è¿™ä¸¤è€…çš„åŸºæœ¬æè¿°ä¸­ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†å…³é”®ä¿¡æ¯ï¼šç±»å‹ä¸åœ¨è¿è¡Œæ—¶çš„ â€œé¢†åŸŸâ€ ä¸­ã€‚å®é™…ä¸Šï¼Œç±»å‹æ˜¯ç¨‹åºçš„å¦ä¸€ä¸ª â€œå±‚â€ ä¸Šçš„ä¸œè¥¿ï¼Œä¸€ä¸ªç”¨äºç±»å‹æ£€æŸ¥çš„å±‚ã€‚ ä½†æ˜¯ä»€ä¹ˆæ˜¯ç±»å‹æ£€æŸ¥å™¨ï¼Ÿè¿™æ˜¯ä¸€ä¸ªåˆ†ææˆ‘ä»¬ä»£ç çš„å·¥å…·ï¼ˆç±»ä¼¼äº flake8ï¼Œä½†æ›´æ™ºèƒ½ï¼‰ã€‚å®ƒä¸ä»¥ä»»ä½•æ–¹å¼è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œåªä¼šé™æ€æ£€æŸ¥ä»£ç çš„ç±»å‹ä¸€è‡´æ€§ã€‚Python ç¤¾åŒºçš„å®˜æ–¹ç±»å‹æ£€æŸ¥å™¨æ˜¯ mypyã€‚æ­¤å¤–è¿˜æœ‰ Facebook çš„ pyre-check å’Œè°·æ­Œçš„ pytypeã€‚ 1.1 å¦‚ä½•å®šä¹‰ç±»å‹ï¼Ÿ ç±»å‹æ£€æŸ¥å™¨éœ€è¦å…³äºç±»å‹çš„ä¿¡æ¯æ¥æ£€æŸ¥æˆ‘ä»¬çš„ç¨‹åºã€‚å®šä¹‰ç±»å‹æœ‰ä¸‰ç§åŸºæœ¬æ–¹æ³•ï¼š é€šè¿‡å®šä¹‰ä¸€ä¸ªç±»ï¼Œ é€šè¿‡æŒ‡å®šä½¿ç”¨ç±»å‹å˜é‡çš„å‡½æ•°ï¼Œ é€šè¿‡ä½¿ç”¨æ›´åŸºæœ¬çš„ç±»å‹æ¥åˆ›å»ºæ›´å¤æ‚çš„ç±»å‹ã€‚ ç¬¬ä¸€ç§æƒ…å†µä¸­ï¼Œè¯­å¥ class Animal: â€¦ åŒæ—¶å®šä¹‰äº† Animal ç±»å’Œ Animal ç±»å‹ã€‚è¿™ä¹Ÿé€‚ç”¨äºå†…ç½®ç±»å‹ï¼šintï¼Œfloatï¼Œstrï¼Œlistï¼Œdict ç­‰ç­‰ï¼Œå®ƒä»¬ä¹ŸåŒæ—¶æ˜¯ç±»å’Œç±»å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»è¢«ä¸€ä¸€æ˜ å°„åˆ°å­ç±»å‹å…³ç³»ã€‚å› æ­¤ï¼Œå¦‚æœ Dog æ˜¯ Animal çš„ä¸€ä¸ªå­ç±»ï¼Œé‚£ä¹ˆ Dog å°±æ˜¯ Animal çš„ä¸€ä¸ªå­ç±»å‹ï¼Œç­‰ç­‰ã€‚è¿™ç§å¤„ç†ç±»å‹çš„æ–¹æ³•è¢«ç§°ä¸ºâ€œå‘½åå­ç±»å‹â€ã€‚ä¸€ä¼šå„¿ï¼Œæˆ‘å°†å±•ç¤ºå®ƒåœ¨ç±»å‹æ£€æŸ¥çš„æƒ…å¢ƒä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ ç¬¬äºŒç§æƒ…å†µæ˜¯é¸­å­ç±»å‹çš„ç²¾ç¥ï¼šæˆ‘ä»¬é€šè¿‡æŒ‡å®šå“ªäº›å‡½æ•°/æ–¹æ³•ä½¿ç”¨æ­¤ç±»å‹çš„å˜é‡æ¥å®šä¹‰ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æœ‰ __len__ æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå…·æœ‰ Sized ç±»å‹ã€‚è¿™ç§å¤„ç†ç±»å‹çš„æ–¹æ³•è¢«ç§°ä¸ºâ€œç»“æ„å­ç±»å‹â€ã€‚è¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¯é¢˜ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­åªä¼šç•¥åŠ è®¨è®ºã€‚ åœ¨ç¬¬ä¸‰ç§æƒ…å†µä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ—©æœŸå®šä¹‰çš„ç±»å‹ï¼ˆä»¥ä»»ä½•æ–¹å¼ï¼‰æ¥å®šä¹‰æ›´å¤æ‚çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹ç±»å‹ï¼šâ€œä»…åŒ…å«æ•´æ•°æˆ–å­—ç¬¦ä¸²å®ä¾‹çš„åˆ—è¡¨â€ã€‚ç¨åå°†ä»‹ç»è¿™äº›ç±»å‹ã€‚ 2. ç±»å‹æ³¨è§£è¯­æ³• ä¸ºäº†ç”¨ç±»å‹ä¿¡æ¯ç»™æˆ‘ä»¬çš„ä»£ç åšæ³¨è§£ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ç‰¹æ®Šçš„è¯­æ³•ã€‚è¿™ç§è¯­æ³•é€æ¸è¢«å¼•å…¥åˆ°è¯­è¨€ä¸­ï¼Œä½†æ˜¯ç°åœ¨åªå…³æ³¨å®ƒçš„å½“å‰ï¼ˆä¹Ÿå¾ˆå¯èƒ½æ˜¯æœ€ç»ˆï¼‰çŠ¶æ€ã€‚ 2.1 æ³¨è§£å˜é‡ è¦æ³¨è§£å˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨å˜é‡ååè·Ÿå†’å·å’Œç±»å‹åã€‚å˜é‡åˆå§‹åŒ–æ˜¯å¯é€‰çš„ï¼š 1name: Type ç±»å‹æ³¨è§£ä¸åˆå§‹åŒ–å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1name: Type = initial_value æ‰€ä»¥ä»ç°åœ¨å¼€å§‹ï¼Œmypy çŸ¥é“ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œname åº”è¯¥å…·æœ‰ Type ç±»å‹ï¼Œå¹¶å°†æ£€æŸ¥æ˜¯å¦ç¡®å®å¦‚æ­¤ã€‚äº‹å®ä¸Šï¼Œç¬¬ä¸€æ¬¡æ£€æŸ¥æ˜¯åœ¨èµ‹å€¼é˜¶æ®µè¿›è¡Œçš„ï¼šinitial_value æ˜¯ Type ç±»å‹çš„å—ï¼Ÿ å¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ä½¿ç”¨å®ƒï¼ˆä¼šå¼•å‘ NameErrorï¼‰ï¼Œä½†æ˜¯ç¨åï¼Œåœ¨æˆ‘ä»¬åˆå§‹åŒ–å®ƒä¹‹åï¼Œmypy ä¼šç”¨å£°æ˜çš„å˜é‡ç±»å‹æ¥æ£€æŸ¥å€¼çš„ç±»å‹ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯ä»€ä¹ˆæ ·çš„ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä¼šæŠŠæ‰€æœ‰çš„ mypy é”™è¯¯æ”¾åœ¨æ³¨é‡Šä¸­ã€‚ 123456789width: intwidth = 15 # æ²¡æœ‰é”™è¯¯height: intheight = \"25\" # é”™è¯¯:# Incompatible types in assignment (expression has type \"str\", variable has type \"int\")depth: int = 15.5 # é”™è¯¯:# error:Incompatible types in assignment (expression has type \"float\", variable has type \"int\") æ‰€ä»¥å³ä½¿åœ¨è¿™äº›ç®€å•çš„æƒ…å†µä¸‹ï¼Œmypy ä¹Ÿå·²ç»å¾ˆæœ‰ç”¨äº†ã€‚ 2.2 æ³¨è§£å‡½æ•° æˆ‘ä»¬è¿˜å¯ä»¥æ³¨è§£å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ã€‚ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š 12def function(arg1: Type1, arg2: Type2) -&gt; ReturnType: ... è®©æˆ‘ä»¬çœ‹çœ‹ï¼š 123456789101112def add_ints(x: int, y: int) -&gt; int: return x + y # æ²¡æœ‰é”™è¯¯add_ints(1, 2) # æ²¡æœ‰é”™è¯¯add_ints(1, 2.0) # é”™è¯¯:# Argument 2 to \"add_ints\" has incompatible type \"float\"; expected \"int\"def broken_add(x: int, y: int) -&gt; str: return x + y # é”™è¯¯: # Incompatible return value type (got \"int\", expected \"str\") åœ¨ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œmypy é€šè¿‡æ£€æŸ¥ + è¿ç®—ç¬¦ï¼ˆå®é™…ä¸Šæ˜¯ __add__ æ–¹æ³•ï¼‰çš„è¿”å›ç±»å‹çŸ¥é“ broken_add åœ¨ä¸¤ä¸ª int ä¸Šä½¿ç”¨æ—¶æœ‰é”™è¯¯çš„è¿”å›ç±»å‹ï¼šå®ƒæ˜¯ä¸€ä¸ª intï¼Œè€Œä¸æ˜¯ strï¼Œæ‰€ä»¥å‡½æ•°çš„è¿”å›ç±»å‹å£°æ˜ä¸æ­£ç¡®ã€‚ 3. å­ç±»å‹ åœ¨æˆ‘ä»¬å¼€å§‹å°è¯•æ‰€æœ‰å…³äº Python ç±»å‹çš„ä¸œè¥¿ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¥½åœ°ç†è§£åŸºæœ¬çš„å­ç±»å‹å…³ç³»ã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªç±»ï¼š 12345class Animal: ...class Dog(Animal): ... åŸºæœ¬ä¸Šï¼Œå­ç±»å‹æ˜¯ä¸€ç§ä¸å¤ªæ™®éçš„ç±»å‹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒDog æ²¡æœ‰ Animal ä¸€èˆ¬ï¼Œæ‰€ä»¥å®ƒæ˜¯ Animal çš„ä¸€ä¸ªå­ç±»å‹ã€‚ä½†æ˜¯è®©æˆ‘ä»¬æ·±å…¥ä¸€ç‚¹ï¼Œçœ‹çœ‹ Python ä¸­å¦‚ä½•å®šä¹‰å­ç±»å‹å…³ç³»ã€‚è¿™ä¸ªå®šä¹‰å°†å†³å®šèµ‹å€¼è§„åˆ™å’Œå±æ€§è§„åˆ™çš„ä½¿ç”¨ï¼Œè¿™äº›è§„åˆ™æ˜¯ mypy åœ¨ä»£ç ä¸Šå¼ºåˆ¶æ‰§è¡Œçš„ã€‚ 3.1 å®šä¹‰ æˆ‘ä»¬ç”¨ &lt;: è¡¨ç¤ºå­ç±»å‹å…³ç³»ã€‚ï¼ˆä¾‹å¦‚ B &lt;: A è¡¨ç¤º B æ˜¯ A çš„å­ç±»å‹ã€‚ï¼‰ ç°åœ¨ï¼ŒB &lt;: A å½“ä¸”ä»…å½“ï¼š ç±»å‹ B çš„æ¯ä¸ªå€¼ä¹Ÿåœ¨ç±»å‹ A çš„å€¼çš„é›†åˆä¸­ï¼›å¹¶ä¸” ç±»å‹ A çš„æ¯ä¸ªå‡½æ•°ä¹Ÿåœ¨ç±»å‹ B çš„å‡½æ•°çš„é›†åˆä¸­ã€‚ ï¼ˆâ€œç±»å‹ A çš„å‡½æ•°â€ åŸºæœ¬ä¸Šæ„å‘³ç€â€œæ¥å—ç±»å‹ A çš„å¯¹è±¡ä½œä¸ºå…¶å‚æ•°çš„å‡½æ•°â€ã€‚å› æ­¤ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå…·æœ‰ A ç±»å‹å‚æ•°çš„ç‹¬ç«‹å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ A ç±»ä¸Šå®šä¹‰çš„æ–¹æ³•ã€‚ï¼‰ å› æ­¤ï¼Œåœ¨å­ç±»å‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå€¼é›†åˆå˜å¾—æ›´å°ï¼Œè€Œå‡½æ•°é›†åˆå˜å¾—æ›´å¤§ï¼ˆå‚è§æ–‡æ¡£å’Œè¿™ä¸ªåšå®¢ï¼Œå®ƒå¯å‘äº†ç¬¦å·å’Œç¤ºä¾‹ï¼‰ã€‚ å°±æˆ‘ä»¬çš„ä¸¤ç§ç±»å‹è€Œè¨€ï¼ŒDog &lt;: Animal æ„å‘³ç€ï¼š ä¸€ç»„ Dog æ˜¯ Animal çš„å­é›†ï¼ˆæ¯åª Dog éƒ½æ˜¯ Animalï¼Œä½†ä¸æ˜¯æ¯åª Animal éƒ½æ˜¯ Dogï¼‰ã€‚è¿™åŸºæœ¬ä¸Šæ„å‘³ç€ Dog æ¯” Animal å°‘ã€‚ Animal çš„ä¸€ç»„å‡½æ•°æ˜¯ Dog çš„å‡½æ•°çš„å­é›†ï¼ˆDog å¯ä»¥åšä»»ä½• Animal èƒ½åšçš„äº‹æƒ…ï¼Œä½†æ˜¯ Animal ä¸èƒ½åšä»»ä½• Dog èƒ½åšçš„äº‹æƒ…ï¼‰ã€‚åŸºæœ¬ä¸Šï¼ŒAnimal èƒ½åšçš„æ¯” Dog å°‘ã€‚ 3.2 èµ‹å€¼è§„åˆ™ è¿™ä¸ªå®šä¹‰å†³å®šäº†å“ªäº›èµ‹å€¼æ˜¯å¯æ¥å—çš„ï¼Œå“ªäº›æ˜¯ä¸å¯æ¥å—çš„ã€‚è®©æˆ‘ä»¬å°è¯•å°†ä¸€ç§ç±»å‹çš„å˜é‡åˆ†é…ç»™å¦ä¸€ç§ç±»å‹çš„å˜é‡ã€‚ 12345# Dog &lt;: Animalscooby: Dogan_animal: Animalan_animal = scooby # æ²¡æœ‰é”™è¯¯ å°† scooby èµ‹å€¼ç»™ an_animal æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸º scooby è¢«ä¿è¯æ˜¯ä¸€åª Animalã€‚ 123456# Dog &lt;: Animalscooby: Dogan_animal: Animalscooby = an_animal # é”™è¯¯:# Incompatible types in assignment (expression has type \"Animal\", variable has type \"Dog\") æŠŠ an_animal èµ‹å€¼ç»™ scooby ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸º an_animal å¯èƒ½ä¸æ˜¯ Dogã€‚ æ£€æŸ¥ç»§æ‰¿å…³ç³»æ˜¯å‘½åå­ç±»å‹åŒ–æ–¹æ³•çš„ä¸€éƒ¨åˆ†ã€‚ 3.3 å±æ€§è§„åˆ™ mypy ä¸ä»…å…³æ³¨èµ‹å€¼ï¼Œè¿˜å…³æ³¨å±æ€§çš„ä½¿ç”¨ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œå®ƒæ£€æŸ¥å±æ€§æ˜¯å¦å®é™…å®šä¹‰åœ¨å¯¹è±¡ä¸Šã€‚ 12345class Animal: def eat(self): ...class Dog(Animal): def bark(self): ... ç°åœ¨ Animal å¯ä»¥ eatï¼ŒDog å¯ä»¥ eat ï¼ˆé€šè¿‡ç»§æ‰¿ï¼‰å’Œ barkã€‚ 123456789# Dog &lt;: Animalan_animal: Animalsnoopy: Dogan_animal.eat() # æ²¡æœ‰é”™è¯¯snoopy.eat() # æ²¡æœ‰é”™è¯¯snoopy.bark() # æ²¡æœ‰é”™è¯¯an_animal.bark() # é”™è¯¯: \"Animal\" has no attribute \"bark\" mypy ç¡®ä¿ç¡®å®åœ¨ç›¸å…³å¯¹è±¡ä¸Šå®šä¹‰äº†æ–¹æ³•ã€‚an_animal æ²¡æœ‰å®šä¹‰ bark æ–¹æ³•ï¼Œå› æ­¤ä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ã€‚ æ£€æŸ¥å±æ€§ï¼Œç‰¹åˆ«æ˜¯æ–¹æ³•ï¼Œæ˜¯ç»“æ„å­ç±»å‹åŒ–æ–¹æ³•çš„ä¸€éƒ¨åˆ†ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œâ€œå­ç±»å‹å…³ç³»æ˜¯ä»å£°æ˜çš„æ–¹æ³•ä¸­æ¨å¯¼å‡ºæ¥çš„â€[æ¥æº]ã€‚ 4. å®šä¹‰å¤æ‚ç±»å‹ è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨æ›´åŸºæœ¬çš„ç±»å‹æ¥åˆ›å»ºæ›´å¤æ‚çš„ç±»å‹ã€‚è¿™æ˜¯åœ¨ Python ä¸­å®šä¹‰ç±»å‹çš„ç¬¬ä¸‰ç§æ–¹æ³•ã€‚æˆ‘å°†é›†ä¸­è®¨è®ºå‡ ä¸ªå…¸å‹çš„å¤æ‚ç±»å‹ï¼Œè€Œå…¶ä½™çš„å·¥ä½œæ–¹å¼åŸºæœ¬ç›¸åŒã€‚ 4.1 åˆ—è¡¨ å…¶ä¸­æœ€åŸºæœ¬çš„æ˜¯ Listã€‚é™¤äº†å¤§å†™å­—æ¯ L ä¹‹å¤–ï¼Œå®ƒçš„æ‹¼å†™ä¸å†…ç½® list ç›¸åŒã€‚è¯­æ³•å¦‚ä¸‹ï¼šList[TypeOfElements]ã€‚æ‰€ä»¥æ•´æ•°åˆ—è¡¨æ˜¯ List[int]ï¼Œå­—ç¬¦ä¸²åˆ—è¡¨æ˜¯ List[str] ç­‰ç­‰ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç : 12345678910111213141516171819202122from typing import Listmy_list: List[int] = [1, 2, 3] # æ²¡æœ‰é”™è¯¯my_other_list: List[int] = [1, 2, \"3\"] # é”™è¯¯:# List item 2 has incompatible type \"str\"; expected \"int\"class Animal: passclass Dog(Animal): passscooby = Dog()lassie = Dog()pinky = Animal()my_dogs: List[Dog] = [scooby, lassie, pinky] # é”™è¯¯:# List item 2 has incompatible type \"Animal\"; expected \"Dog\" è¿™æ˜¯æœ‰é“ç†çš„ï¼Œä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Python åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®å¤šç§ç±»å‹çš„é¡¹ç›®ï¼š [1, 2, '3'] ä»ç„¶æ˜¯æœ‰æ•ˆçš„åˆ—è¡¨ã€‚ä¸€ä¼šå„¿ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•è¡¨è¾¾åƒ â€œæ•´æ•°æˆ–å­—ç¬¦ä¸²â€ è¿™æ ·çš„ç±»å‹ã€‚ä½†æ˜¯é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å…ƒç»„å’Œå­—å…¸ç±»å‹ã€‚ 4.2 å…ƒç»„ åœ¨ Python è¯­è¨€ä¸­ï¼Œå…ƒç»„ä¼ ç»Ÿä¸Šæœ‰ä¸¤ä¸ªç”¨é€”ã€‚é¦–å…ˆï¼Œè¿™æ˜¯ä¸€ä¸ª â€œä¸å¯æ”¹å˜çš„åˆ—è¡¨â€ã€‚ç¬¬äºŒï¼Œå®ƒæ˜¯ â€œè®°å½•â€ æˆ– â€œä¸€è¡Œå€¼â€ï¼Œå…¶ä¸­æ¯ä¸ªä½ç½®ä¸Šçš„å€¼é€šå¸¸éƒ½æœ‰ç‰¹å®šå®šä¹‰çš„ç±»å‹ï¼›æŠŠå®ƒæƒ³è±¡æˆ SQL æ•°æ®åº“ä¸­çš„ä¸€è¡Œã€‚Tupleï¼ˆå¤§å†™ T ï¼‰ç±»å‹æ”¯æŒè¿™ä¸¤ç§æ–¹æ³•ã€‚ è¦å°†å…ƒç»„å®šä¹‰ä¸ºè®°å½•ï¼Œä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼šTuple[Type1, Type2, Type3]ï¼ˆç­‰ç­‰ï¼‰ã€‚ è¦å°†å…ƒç»„å®šä¹‰ä¸ºä¸å¯å˜åˆ—è¡¨ï¼Œä½¿ç”¨å…ƒç»„ä¸çœç•¥å·å¯¹è±¡ï¼ˆç”¨ä¸‰ä¸ªç‚¹æ‹¼å†™ï¼š...ï¼‰ï¼šTuple[TypeOfAllElements, ...]ã€‚ 1234567891011121314151617from typing import Tuplebob: Tuple[str, str, int] = (\"Bob\", \"Smith\", 25) # æ²¡æœ‰é”™è¯¯frank: Tuple[str, str, int] = (\"Frank\", \"Brown\", 43.4) # é”™è¯¯:# Incompatible types in assignment (expression has type \"Tuple[str, str, float]\",# variable has type \"Tuple[str, str, int]\")ann: Tuple[str, str, int] = (\"Ann\", \"X\", 1, 2) # é”™è¯¯:# Incompatible types in assignment (expression has type \"Tuple[str, str, int, int]\",# variable has type \"Tuple[str, str, int]\")scores1: Tuple[int, ...] = (5, 8, 4, -1) # æ²¡æœ‰é”™è¯¯scores2: Tuple[int, ...] = (5, 8, 4, -1, None, 7) # é”™è¯¯:# Incompatible types in assignment (expression has type# \"Tuple[int, int, int, int, None, int]\", variable has type \"Tuple[int, ...]\") 4.3 å‘½åå…ƒç»„ åœ¨ Python ä¸­ä¹Ÿæœ‰ namedtupleã€‚å³ä½¿ä¸æ¶‰åŠç±»å‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„å…ƒç»„æ‰©å±•ã€‚å®ƒå¢åŠ äº†å­—æ®µåæŸ¥æ‰¾å’Œä¸€ä¸ªæ¼‚äº®çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼š 123456789101112131415161718192021&gt;&gt;&gt; from collections import namedtuple Person = namedtuple('Person', 'first_name last_name age') bob = Person(first_name='Bob', last_name='Smith', age=41)&gt;&gt;&gt; bob.age41&gt;&gt;&gt; bobPerson(first_name='Bob', last_name='Smith', age=41)&gt;&gt;&gt; # ä¾ç„¶å¯ä»¥ä½¿ç”¨æ—§çš„è®¿é—®æ–¹å¼ï¼š bob[0]'Bob'&gt;&gt;&gt; bob[1:]('Smith', 41)&gt;&gt;&gt; list(bob)['Bob', 'Smith', 41] åœ¨ Python 3 ä¸­ï¼Œnamedtuple æœ‰ä¸€ä¸ªæ›´å¹´è½»çš„ç±»å‹å…„å¼Ÿï¼šNamedTupleï¼ˆåŒæ ·ï¼Œç”¨å¤§å†™å­—æ¯ N å’Œ T æ‹¼å†™ï¼‰ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå®ƒå…·æœ‰ä¸ namedtuple å®Œå…¨ç›¸åŒçš„ APIï¼Œä½†æ˜¯å¦å¤–ï¼Œå®ƒæ”¯æŒç±»å‹æ³¨è§£ï¼š 12345678910111213from typing import NamedTupleclass Person(NamedTuple): first_name: str last_name: str age: intPerson(\"Bob\", \"Smith\", 41) # æ²¡æœ‰é”™è¯¯Person(\"Kate\", \"Smith\", \"32\") # é”™è¯¯:# Argument 3 to \"Person\" has incompatible type \"str\"; expected \"int\" ä¸é”™ï¼Œæ˜“è¯»ï¼Œæ–¹ä¾¿ï¼ 4.4 å­—å…¸ å¦ä¸€ç§é‡è¦çš„ Python ç±»å‹æ˜¯å­—å…¸ã€‚å…¶ç±»å‹çš„å®šä¹‰ç±»ä¼¼äºå…ƒç»„ï¼šDict[KeyType, ValueType]ã€‚å› æ­¤ï¼Œå°†æ•´æ•°é”®æ˜ å°„åˆ°å­—ç¬¦ä¸²å€¼çš„å­—å…¸æ˜¯ Dict[int, str]ã€‚ 12345678from typing import Dictid_to_name: Dict[int, str] = &#123;1: \"Bob\", 23: \"Ann\", 7: \"Kate\"&#125; # æ²¡æœ‰é”™è¯¯id_to_age: Dict[int, int] = &#123;\"1\": 41, 2: 22&#125; # é”™è¯¯:# Dict entry 0 has incompatible type \"str\": \"int\"; expected \"int\": \"int\"name_to_phone_no: Dict[str, str] = &#123;\"Bob\": \"55534534\", \"Ann\": 55599412&#125; # é”™è¯¯:# Dict entry 1 has incompatible type \"str\": \"int\"; expected \"str\": \"str\" è¿˜æœ‰å…¶ä»– Python é›†åˆçš„ç±»å‹ï¼šSetã€FrozenSetã€DefaultDictã€Counterã€Deque å’Œè®¸å¤šå…¶ä»–ç±»å‹ã€‚æœ‰å…³å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚è§æ–‡æ¡£ã€‚ ç°åœ¨è®©æˆ‘ä»¬å…³æ³¨å¦ä¸€ç§åˆ›å»ºå¤æ‚ç±»å‹çš„æ–¹æ³•ã€‚ 4.5 Union å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå˜é‡å¯ä»¥æœ‰ str ç±»å‹æˆ– int ç±»å‹ï¼Œè¿™å–å†³äºæƒ…å†µï¼ˆåƒä¸åŒçš„æ•°æ®æºï¼‰ã€‚ä¸ºäº†å®šä¹‰è¿™ç§ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Unionã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒå°†æ˜¯Union[str, int]ã€‚åœ¨æ–¹æ‹¬å·ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦æ”¾ç½®ä»»æ„å¤šçš„ç±»å‹ï¼šUnion[Type1, Type2, Type3, Type4]ï¼ˆç­‰ç­‰ï¼‰ã€‚å½¢å¼ä¸Šï¼š Union[t1, t2, ...]. t1, ... ä¸­è‡³å°‘ä¸€ä¸ªçš„å­ç±»å‹æ˜¯è¿™ä¸ªç±»å‹çš„å­ç±»å‹ã€‚[æ¥æº] ä¸€äº›ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940from typing import Unionwidth1: Union[int, float] = 20 # æ²¡æœ‰é”™è¯¯width2: Union[int, float] = 20.5 # æ²¡æœ‰é”™è¯¯width3: Union[int, float] = \"44\" # é”™è¯¯:# Incompatible types in assignment (expression has type \"str\",# variable has type \"Union[int, float]\")class Animal: def eat(self): passclass Dog(Animal): passclass Cat(Animal): passclass Lizard(Animal): passdef restricted_eat(animal: Union[Dog, Cat]) -&gt; None: animal.eat()a_dog: Dogrestricted_eat(a_dog) # æ²¡æœ‰é”™è¯¯a_cat: Catrestricted_eat(a_cat) # æ²¡æœ‰é”™è¯¯a_lizard: Lizardrestricted_eat(a_lizard) # é”™è¯¯:# Argument 1 to \"restricted_eat\" has incompatible type \"Lizard\";# expected \"Union[Dog, Cat]\" 4.6 None ç±»å‹å’Œå¯é€‰ç±»å‹ ä¸€ç§å¸¸è§çš„ç¼–ç¨‹æ¨¡å¼æ˜¯ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥è¡¨ç¤ºå…·ä½“çš„å€¼ï¼Œæˆ–è€…ç”¨ä¸€ä¸ªç¬¦å·æ¥è¡¨ç¤ºæ²¡æœ‰å€¼ï¼ˆå½“å€¼ä¸¢å¤±ã€æŸåã€è¿˜ä¸å¯ç”¨ã€åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­ä¸å……åˆ†ç­‰ç­‰ï¼‰ã€‚åœ¨ Python ä¸­ï¼Œä¸ºäº†è¡¨ç¤ºæ²¡æœ‰å€¼ï¼ŒNone æ˜¯æœ€å¸¸ç”¨çš„å¯¹è±¡ã€‚ None çš„ç±»å‹æ˜¯ NoneTypeï¼Œä½†æ˜¯åœ¨ç±»å‹ç³»ç»Ÿä¸­ï¼Œå®ƒæœ‰ä¸€ä¸ªåˆ«åï¼Œå³â€¦ None æœ¬èº«ã€‚åˆ«åéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä¸æ¶‰åŠå¯¼å…¥ä»»ä½•å†…å®¹ã€‚å› æ­¤ï¼Œè¡¨è¾¾ T ç±»å‹æˆ– None ç±»å‹çš„å€¼çš„æœ€è‡ªç„¶æ–¹å¼æ˜¯ Union[T, None]ã€‚æ‰€ä»¥æ•´å‹æˆ–æ— åº”è¯¥æ˜¯ Union[int, None]ã€‚ è¿™ç§ç±»å‹æˆ–æ— çš„æ¨¡å¼éå¸¸æ™®éï¼Œä»¥è‡³äºåœ¨ Python çš„ç±»å‹ç³»ç»Ÿä¸­ Union[T, None] æœ‰ä¸€ä¸ªåˆ«åï¼šOptional[T]ã€‚ä¾‹å¦‚ï¼Œè¦æƒ³è¡¨è¾¾ Union[int, None] åº”è¯¥ä½¿ç”¨ Optional[int]ã€‚ å¿˜è®°å˜é‡çš„â€œå¯é€‰æ€§â€å¸¸å¸¸ä¼šå¯¼è‡´é”™è¯¯ã€‚mypy çœŸçš„å¯ä»¥å¸®åˆ°æˆ‘ä»¬ã€‚","categories":[],"tags":[]},{"title":"å†…å­˜ä¸­çš„æ ˆã€å †å’Œé™æ€åŒºçš„ç”¨æ³•","slug":"2018-05-28/å†…å­˜ä¸­çš„æ ˆã€å †å’Œé™æ€åŒºçš„ç”¨æ³•","date":"2018-07-29T09:46:14.000Z","updated":"2018-08-08T06:25:10.793Z","comments":true,"path":"posts/978fb366/","link":"","permalink":"http://weafteam.github.io/posts/978fb366/","excerpt":"","text":"æœ¬å‘¨çš„ç¬¬ä¸‰ç¯‡åšå®¢ï¼Œè¿™ä¸ªé¢˜ç›®åº”è¯¥ä¹Ÿæ˜¯è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ã€‚ 1 å †åŒº å…ˆäº†è§£ä¸‹Heapçš„ä½œç”¨ï¼Œå †åŒºæ˜¯ä¸“é—¨ç”¨æ¥å­˜å‚¨å¯¹è±¡çš„å®ä¾‹çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶é€šè¿‡newå‡ºæ¥çš„å¯¹è±¡ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™é‡Œé¢ä¹Ÿåªæ˜¯ä¿å­˜äº†å¯¹è±¡å®ä¾‹çš„å±æ€§å€¼ï¼Œå±æ€§çš„ç±»å‹å’Œå¯¹è±¡æœ¬èº«çš„æ ‡è®°ç­‰ä¸€äº›å†…å®¹ï¼Œå…¶ä¸­å€¼å¾—æ³¨æ„çš„æ˜¯å®ƒé‡Œé¢å¹¶ä¸ä¿å­˜å¯¹è±¡çš„æ–¹æ³•ï¼ˆæ–¹æ³•ä¹Ÿå¯ä»¥ç†è§£æˆæŒ‡ä»¤ï¼Œä¿å­˜åœ¨stackä¸­ï¼‰ æ‰€ä»¥æˆ‘ä»¬åŠ ä»¥æ€»ç»“å’Œå»¶ä¼¸ä¸‹ï¼š 1 å®ƒå­˜å‚¨çš„éƒ½æ˜¯å¯¹è±¡ï¼Œè€Œä¸”æ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„classçš„ä¿¡æ¯ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯èƒ½å¤Ÿè®©å¯¹è±¡å¾—åˆ°æ“ä½œçš„æŒ‡ä»¤é›†ã€‚ 2 éœ€è¦æ³¨æ„çš„æ˜¯JVMä¸­åªæœ‰ä¸€å—å †åŒºï¼ˆHeapï¼‰ï¼Œè€Œä¸”å®ƒæ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ã€‚å †åŒºä¸­å­˜æ”¾çš„åªæœ‰å¯¹è±¡æœ¬èº«ï¼Œä¸å­˜æ”¾åŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡çš„å¼•ç”¨ã€‚ 3 å…³äºå †åŒºçš„åˆ†é…å’Œé‡Šæ”¾ä¸€èˆ¬æ˜¯ç”±ç¨‹åºå‘˜åšè¿™ä¸ªæ“ä½œã€‚å…¶å®è¿™ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œç¨‹åºå‘˜newä¸€ä¸ªå¯¹è±¡ç›¸å½“äºå¯¹è¿™å—åŒºåŸŸåšäº†åˆ†é…çš„å·¥ä½œï¼Œè€Œå½“ç¨‹åºå‘˜åšdeleteæ“ä½œæ—¶ï¼Œç›¸å½“äºé‡Šæ”¾äº†è¿™éƒ¨åˆ†ç©ºé—´ï¼ŒåŒæ—¶å¦‚æœç¨‹åºå‘˜çš„ä¹ æƒ¯ä¸å¥½ï¼Œä¸å¯¹æ— ç”¨çš„å¯¹è±¡è¿›è¡Œé‡Šæ”¾çš„è¯ï¼Œå½“ç¨‹åºç»“æŸæ—¶ï¼Œä¹Ÿä¼šç”±OSåšè¿™ä¸ªå·¥ä½œã€‚ 2 æ ˆ ç„¶åæˆ‘ä»¬å†äº†è§£ä¸‹Stackçš„ä½œç”¨ï¼Œå½“æˆ‘ä»¬åœ¨å †åŒºä¸­ä¸ºæˆ‘ä»¬newå‡ºæ¥çš„å¯¹è±¡åˆ†é…å¥½ç©ºé—´ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ ˆä¸­ä¿å­˜ä¸€ä¸ª4å­—èŠ‚çš„Heapçš„åœ°å€ï¼Œç”¨æ¥å®šä½è¯¥å¯¹è±¡å®ä¾‹åœ¨Heapä¸­çš„ä½ç½®ï¼Œä¾¿äºæ‰¾åˆ°è¯¥å¯¹è±¡å®ä¾‹ã€‚ å…¶å®Stackçš„åŠŸèƒ½ä¸æ­¢äºæ­¤ï¼š 1 ä¸åŒäºHeapï¼ŒStackçš„ä¸ªæ•°æ˜¯å’Œçº¿ç¨‹æŒ‚é’©çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åŒ…å«ä¸€ä¸ªStackï¼Œè€Œä¸”æ ˆä¸­åªåŒ…å«äº†åŸºæœ¬çš„æ•°æ®ç±»å‹çš„å˜é‡å’Œå¯¹è±¡çš„å¼•ç”¨ã€‚ 2 æ ˆä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥æ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ç§æœ‰çš„ï¼Œå…¶ä»–çš„æ ˆä¸èƒ½è®¿é—®ã€‚ 3 æ ˆå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šåŸºæœ¬æ•°æ®ç±»å‹å˜é‡åŒºã€æ‰§è¡Œç¯å¢ƒçš„ä¸Šä¸‹æ–‡ã€æ“ä½œæŒ‡ä»¤åŒº 4 æ ˆç›¸å¯¹äºå †åŒºï¼Œå®ƒçš„åˆ†é…å’Œé‡Šæ”¾çš„å·¥ä½œæ˜¯ç³»ç»Ÿè‡ªå·±åšçš„ 3 é™æ€åŒº/æ–¹æ³•åŒº ç±»ä¼¼äºå †åŒºï¼Œè€Œä¸”æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹æ‰€å…±äº«çš„ã€‚æ–¹æ³•åŒºä¸­å­˜æ”¾äº†æ•´ä¸ªç¨‹åºä¸­æ‰€æœ‰çš„æ°¸è¿œå”¯ä¸€çš„å˜é‡ï¼Œä¾‹å¦‚ï¼šclassä¿¡æ¯å’Œstaticå˜é‡ç­‰ã€‚ å®ƒä¹Ÿæ˜¯åˆ†äº†ä¸‰å—ï¼šå…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„å­˜å‚¨æ˜¯æ”¾åœ¨ä¸€å—çš„ï¼Œåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡åœ¨ä¸€å—åŒºåŸŸï¼Œ æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œæœªåˆå§‹åŒ–çš„é™æ€å˜é‡åœ¨ç›¸é‚»çš„å¦ä¸€å—åŒºåŸŸã€‚ æ³¨æ„ æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨æ—¶çš„å•ä½ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå †å’Œæ ˆä¸éƒ½å¯ä»¥å­˜å‚¨æ•°æ®å—ï¼Œä¸ºä»€ä¹ˆè¦å°†è¿™ä¸¤è€…åŒºåˆ†å¼€æ¥ï¼Ÿ ** 1 ** é¦–å…ˆä»è½¯ä»¶è®¾è®¡çš„è§’åº¦æ¥çœ‹è¿™ä¸ªé—®é¢˜ï¼Œæ ˆå…¶å®ä»£è¡¨äº†å¤„ç†é€»è¾‘ï¼Œè€Œå †ä»£è¡¨äº†æ•°æ®å­˜å‚¨ã€‚è¿™ç§åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³ï¼Œä½¿å¾—æˆ‘ä»¬çš„å¤„ç†é€»è¾‘æ›´ä¸ºæ¸…æ™°ã€‚ ** 2 ** å› ä¸ºå †æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å †ä¸­çš„å†…å®¹ä¹Ÿæ˜¯è¢«å¤šä¸ªæ ˆå…±äº«çš„ã€‚è¿™æ ·åšçš„æ”¶ç›Šæœ‰ä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ–¹é¢è¿™ç§å…±äº«æä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ•°æ®äº¤äº’æ–¹å¼ï¼Œå¦ä¸€æ–¹é¢ï¼Œå †ä¸­çš„å…±äº«å¸¸é‡å’Œç¼“å­˜å¯ä»¥è¢«æ‰€æœ‰çš„æ ˆè®¿é—®åˆ°ã€‚ ä»¥ä¸Šã€‚æ„Ÿè°¢é©»è¶³~","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"http://weafteam.github.io/tags/é¢è¯•/"}]},{"title":"StackOverflowä¸Šç®€å•æ•°å­—è¯†åˆ«æ¡ˆä¾‹å­¦ä¹ ","slug":"2018-05-21/StackOverflowä¸Šç®€å•æ•°å­—è¯†åˆ«æ¡ˆä¾‹å­¦ä¹ ","date":"2018-07-24T04:59:38.000Z","updated":"2018-08-07T08:56:41.652Z","comments":true,"path":"posts/8b09dcdd/","link":"","permalink":"http://weafteam.github.io/posts/8b09dcdd/","excerpt":"","text":"æ­£å¦‚é¢˜ç›®é‚£æ ·ï¼Œè¿™æ¬¡çš„å­¦ä¹ æ˜¯StackOverflowä¸Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå®ƒçš„åœ°å€ä¸ºhttps://stackoverflow.com/questions/9413216/simple-digit-recognition-ocr-in-opencv-pythonï¼Œä½†æ˜¯æºåœ°å€ä¸Šçš„ä»£ç ç•¥å¾®æœ‰ç‚¹æ—§ï¼Œå¾ˆå¤šå‡½æ•°åœ¨OpenCV3ä¸­æœ‰äº†äº›è®¸çš„æ”¹åŠ¨ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯ä¼šè´´ä¸Šæˆ‘è‡ªå·±æ”¹æ­£è¿‡åçš„ä»£ç ï¼Œç„¶åé™„ä¸Šæˆ‘å¯¹ä½œè€…çš„æ€è·¯çš„ç†è§£æ•´ç†ä»¥åŠå¯¹æ‰€æœ‰ä»£ç çš„ç†è§£ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿å’Œæˆ‘è¿›è¡Œæ²Ÿé€šäº¤æµï¼Œé‚®ç®±åœ°å€ï¼šcliugeek@us-forever.com æ€è·¯ï¼š æ•´ä½“çš„æ€è·¯ï¼šæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªè®­ç»ƒï¼ˆå…¶å®ä¸¥æ ¼æ„ä¹‰ä¸Šè¯´ä¸ä¸Šæ˜¯è®­ç»ƒï¼Œå…¶å®æˆ‘ä»¬æœ€ç»ˆè¦åšçš„æ˜¯æ¯ä¸ªæ•°å­—çš„ç‰¹å¾æå–å¹¶ä¸”å°†ä»–ä»¬ä¸å®é™…çš„æ•°å­—å­—ç¬¦ä¸€ä¸€å¯¹åº”èµ·æ¥ï¼Œå§‘ä¸”å°±ç§°è¿™ä¸ªè¿‡ç¨‹ä¸ºâ€œè®­ç»ƒâ€å§ï¼‰çš„å›¾åƒï¼Œç„¶åæˆ‘ä»¬æå–å…¶ä¸­æ‰€æœ‰çš„æ•°å­—çš„ç‰¹å¾ï¼Œç„¶åæ ¹æ®ä¸€ä¸€å¯¹åº”çš„çš„å…³ç³»ï¼Œå°†ç‰¹å¾å’Œå¯¹åº”çš„å­—ç¬¦å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿æˆ‘ä»¬åç»­åšå…¶ä»–å›¾åƒä¸­çš„æ•°å­—è¯†åˆ«ä½¿ç”¨ã€‚ æ‰€ä»¥å…ˆè´´ä¸€ä¸‹è®­ç»ƒç”¨åˆ°çš„æ•°æ®å›¾ï¼š å…¶å®è¿™æ ·çš„è®­ç»ƒæ•°æ®å­˜åœ¨ç€ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ‰€æœ‰çš„å­—æ¯éƒ½æ˜¯ç›¸åŒçš„å­—ä½“å’Œå¤§å°ï¼Œæ‰€ä»¥æ•´ä½“çš„é²æ£’æ€§å¾ˆå—å½±å“ã€‚æ‰€ä»¥è¿™æ˜¯æœ¬ç¨‹åºéœ€è¦åšç»§ç»­ä¼˜åŒ–çš„åœ°æ–¹ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬è®²å…·ä½“çš„è®­ç»ƒè¿‡ç¨‹ï¼š 1 åŠ è½½å›¾åƒ 2 æ£€æµ‹æ•°å­—ï¼ˆé€šè¿‡è½®å»“æŸ¥æ‰¾æ‰¾ï¼Œå¹¶ä¸”é€šè¿‡å¯¹æ£€æµ‹åˆ°çš„å­—æ¯çš„é¢ç§¯å’Œé«˜åº¦åšç›¸åº”çš„çº¦æŸï¼Œæ¥é¿å…é”™è¯¯çš„æ£€æµ‹ï¼‰ 3 å¯¹æ£€æµ‹åˆ°çš„å­—æ¯ç»˜åˆ¶è¾¹æ¡† 4 æ¯ç»˜åˆ¶å‡ºä¸€ä¸ªè¾¹æ¡†ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨é”®ç›˜ä¸Šé”®å…¥ç›¸åº”çš„æ•°å­—é”®ï¼Œè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œå¦åˆ™ä¼šå¯¼è‡´æˆ‘ä»¬è®­ç»ƒè¿‡ç¨‹æ— æ•ˆï¼Œå¯¼è‡´åé¢ä¸€ç³»åˆ—çš„å·¥ä½œæ— æ³•è¿›è¡Œ 5 å½“æˆ‘ä»¬æŒ‰ä¸‹ç›¸åº”çš„æ•°å­—é”®ä¹‹åï¼Œè¾¹æ¡†é‡Œé¢çš„ä¸œè¥¿ä¾¿ä¼šè¿›è¡Œé‡æ–°çš„resizeï¼Œå˜æˆ10x10çš„å¤§å°ï¼Œç„¶åå°†å…¶å­˜å…¥åˆ°ä¸€ä¸ª100ç»´çš„æ•°ç»„ä¸­ï¼ˆå…¶å®å°±æ˜¯å°†è¿™äº›åƒç´ å€¼éƒ½å­˜äº†è¿›å»ä½œä¸ºæˆ‘ä»¬çš„ç‰¹å¾æå–ï¼‰ï¼Œç›¸åº”çš„ä¹Ÿä¼šå°†æˆ‘ä»¬é”®å…¥çš„æ•°å­—å­˜åˆ°å¦ä¸€ä¸ªdataæ–‡ä»¶å½“ä¸­å» 6 è®­ç»ƒè¿‡ç¨‹å®Œæˆä¹‹åï¼Œç³»ç»Ÿç”Ÿæˆä¸¤ä¸ªdataæ–‡ä»¶ã€‚ åœ¨æ‰‹åŠ¨æ•°å­—åˆ†ç±»ç»“æŸæ—¶ï¼Œè®­ç»ƒæ•°æ®ï¼ˆå…¶å®å°±æ˜¯ä¸Šé¢ç»™å¤§å®¶çš„é‚£å¼ å›¾åƒï¼‰ä¸­æ‰€æœ‰çš„æ•°å­—ï¼Œéƒ½å·²ç»ç”±æˆ‘ä»¬æ‰‹å·¥æ ‡è®°ï¼Œç»“æœå¦‚ä¸‹ï¼š ä¸‹é¢å°±æ˜¯é’ˆå¯¹ä¸Šè¿°è¿‡ç¨‹çš„ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344import sysimport numpy as npimport cv2im = cv2.imread('digit.png')im3 = im.copy()gray = cv2.cvtColor(im, cv2.COLOR_BGR2GRAY)blur = cv2.GaussianBlur(gray, (5, 5), 0)thresh = cv2.adaptiveThreshold(blur, 255, 1, 1, 11, 2)################# Now finding Contours ###################image, contours, hierarchy = cv2.findContours(thresh, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)samples = np.empty((0, 100))responses = []keys = [i for i in range(48, 58)]for cnt in contours: if cv2.contourArea(cnt) &gt; 50: [x, y, w, h] = cv2.boundingRect(cnt) if h &gt; 28: cv2.rectangle(im, (x, y), (x + w, y + h), (0, 0, 255), 2) roi = thresh[y:y + h, x:x + w] roismall = cv2.resize(roi, (10, 10)) cv2.imshow('norm', im) key = cv2.waitKey(0) if key == 27: # (escape to quit) sys.exit() elif key in keys: responses.append(int(chr(key))) sample = roismall.reshape((1, 100)) samples = np.append(samples, sample, 0)responses = np.array(responses, np.float32)responses = responses.reshape((responses.size, 1))print(\"training complete\")np.savetxt('generalsamples.data', samples)np.savetxt('generalresponses.data', responses) ä»£ç å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæ‰€ä»¥ç®€å•çš„è¯´ä¸€ä¸‹ï¼Œé¦–å…ˆå¯¹å›¾åƒè¿›è¡Œç°åº¦åŒ–ï¼Œç„¶åè¿›è¡Œé«˜æ–¯å»å™ªï¼Œå†ç„¶ååšäºŒå€¼åŒ–ã€‚æ¥ä¸‹æ¥è¿›è¡Œè½®å»“æ£€æµ‹ï¼Œç„¶åå¯¹æ¯ä¸ªæ£€æµ‹åˆ°çš„è½®å»“åœ¨é¢ç§¯å’Œé«˜åº¦ä¸Šè¿›è¡Œæ§åˆ¶ï¼Œå¦‚æœç¬¦åˆè®¾å®šçš„æ ‡å‡†å°±è¿›è¡Œç”»æ¡†ã€resizeå’Œdisplayï¼ŒåŒæ—¶å°†è¾“å…¥çš„keyè¿›è¡Œç›¸åº”çš„å­˜å‚¨ï¼Œåˆ°æœ€åè¿›è¡Œsaveï¼Œå°†ä»–ä»¬åˆ†åˆ«å­˜åˆ°generalsamples.dataå’Œgeneralresponses.dataä¸­ã€‚ æ¥ä¸‹æ¥è¿›è¡Œæµ‹è¯•éƒ¨åˆ†ï¼ŒåŒæ ·å…ˆç»™å‡ºæµ‹è¯•æ‰€ç”¨çš„å›¾åƒï¼š å†ç„¶åå°±æ˜¯æµ‹è¯•éƒ¨åˆ†çš„æ­¥éª¤ï¼šé¦–å…ˆå°†åˆšæ‰æˆ‘ä»¬ç”Ÿæˆçš„dataæ–‡ä»¶loadè¿›æ¥ï¼Œä¹Ÿå°±æ˜¯å°†åˆšæ‰çš„æ¨¡å‹åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åæˆ‘ä»¬ç”¨KNNï¼ˆKé‚»è¿‘å€¼æ³•ï¼Œé€‰å–ä¸å½“å‰çš„æµ‹è¯•å›¾åƒä¸­æœ€ç›¸è¿‘çš„ä½œä¸ºæˆ‘ä»¬é¢„æµ‹å‡ºæ¥çš„å€¼ï¼‰åšé¢„æµ‹ï¼Œç„¶åé’ˆå¯¹äºæ£€æµ‹å‡ºæ¥çš„æ¯ä¸ªè½®å»“éƒ½è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œé¢„æµ‹å‡ºæ¥çš„å›¾åƒï¼Œæˆ‘ä»¬é€šè¿‡puttextæ–¹æ³•æ”¾åˆ°å°†è¦ç”Ÿæˆçš„å›¾åƒoutä¸Šï¼Œæœ€åå°†åŸå›¾imå’Œç”Ÿæˆå›¾outæ˜¾ç¤ºå‡ºæ¥ã€‚ ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637import cv2import numpy as np####### training part ###############samples = np.loadtxt('generalsamples.data', np.float32)responses = np.loadtxt('generalresponses.data', np.float32)responses = responses.reshape((responses.size, 1))model = cv2.ml.KNearest_create()model.train(samples, cv2.ml.ROW_SAMPLE, responses)# model.train(samples,responses)############################# testing part #########################im = cv2.imread('dig.png')out = np.zeros(im.shape, np.uint8)gray = cv2.cvtColor(im, cv2.COLOR_BGR2GRAY)thresh = cv2.adaptiveThreshold(gray, 255, 1, 1, 11, 2)image, contours, hierarchy = cv2.findContours(thresh, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)for cnt in contours: if cv2.contourArea(cnt) &gt; 50: [x, y, w, h] = cv2.boundingRect(cnt) if h &gt; 28: cv2.rectangle(im, (x, y), (x + w, y + h), (0, 255, 0), 2) roi = thresh[y:y + h, x:x + w] roismall = cv2.resize(roi, (10, 10)) roismall = roismall.reshape((1, 100)) roismall = np.float32(roismall) retval, results, neigh_resp, dists = model.findNearest(roismall, k=1) string = str(int((results[0][0]))) cv2.putText(out, string, (x, y + h), 0, 1, (0, 255, 0))cv2.imshow('im', im)cv2.imshow('out', out)cv2.waitKey(0) è¿™éƒ¨åˆ†çš„ä»£ç å…¶å®æŒ‰ç…§åˆšæ‰çš„æµç¨‹ç†è§£å°±å¯ä»¥ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ã€‚ æœ€åç»™å¤§å®¶çœ‹ä¸‹æ•ˆæœï¼š æˆ‘ä»”ç»†å¯¹æ¯”äº†ä¸€éï¼Œå‡†ç¡®ç‡å¯ä»¥è¾¾åˆ°100%ã€‚å¯¹äºè¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¿™æ ·çš„ç»“æœå¯ä»¥ç§°å¾—ä¸Šå®Œç¾å§ã€‚ ä»¥ä¸Šå°±æ˜¯æœ¬æ¬¡å­¦ä¹ çš„æ‰€æœ‰å†…å®¹ã€‚æ„Ÿè°¢é©»è¶³~","categories":[{"name":"OCR","slug":"OCR","permalink":"http://weafteam.github.io/categories/OCR/"}],"tags":[{"name":"OpenCV-Python","slug":"OpenCV-Python","permalink":"http://weafteam.github.io/tags/OpenCV-Python/"}]},{"title":"Threadå’ŒRunnableçš„åŒºåˆ«","slug":"2018-05-14/Threadå’ŒRunnableçš„åŒºåˆ«","date":"2018-07-23T07:32:42.000Z","updated":"2018-08-07T08:56:41.651Z","comments":true,"path":"posts/42fb2e58/","link":"","permalink":"http://weafteam.github.io/posts/42fb2e58/","excerpt":"","text":"ä¸¤å‘¨çš„å°æš‘å‡ä¹Ÿç®—æ˜¯è¿‡å®Œäº†ï¼Œæ¥ä¸‹æ¥å¾—å¥½å¥½åšä¸œè¥¿äº†ï¼Œåšå®¢ä»ä»Šå¤©å¼€å§‹ä¹Ÿè¦è·Ÿä¸Šè¿›åº¦äº†ã€‚ 1. ä¸¤ç§åˆ›å»ºçš„æ–¹å¼ 1 ç»§æ‰¿Threadç±»ï¼Œå¹¶ä¸”é‡å†™å…¶ä¸­çš„run()æ–¹æ³• 2 å®ç°Runnableæ¥å£ï¼Œé‡å†™å…¶ä¸­çš„run()æ–¹æ³• ä½†æ˜¯åœ¨å®ç°åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¤šç”¨å®ç°Runnableæ¥å£çš„æ–¹å¼ï¼Œè¿™æ˜¯å› ä¸ºJavaçš„å•ç»§æ‰¿å¤šå®ç°çš„æœºåˆ¶ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥é¿å…ç”±äºè¿™ä¸ªæœºåˆ¶ä»£ç çš„å±€é™æ€§ã€‚å…¶å®æˆ‘ä»¬ç”¨Runnableçš„åŸå› ä¸æ­¢äºæ­¤ï¼Œæœ€ä¸»è¦çš„ä¸€ç‚¹æ˜¯Runnableæ˜¯å¯ä»¥è¿›è¡Œæ•°æ®å…±äº«çš„ï¼Œä½†å› æ­¤å®ƒä¹Ÿæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ç°åœ¨å¯¹è¿™ä¸¤ç‚¹è¿›è¡Œé€ä¸€è§£é‡Šï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„å”®ç¥¨çš„ä¾‹å­ï¼Œå¯¹æ•°æ®å…±äº«è¿™ä¸€ç‚¹è¿›è¡Œè§£é‡Šã€‚ 2. ç¤ºä¾‹ä»£ç  ç¤ºä¾‹ä»£ç 1 é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ªMyThreadï¼Œè®©å®ƒç»§æ‰¿Threadï¼Œç„¶åæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªcountï¼Œè¿™ä¸ªcountå‚æ•°å¯ä»¥æƒ³è±¡æˆæˆ‘ä»¬è¦å…±äº«çš„èµ„æºã€‚ç„¶åä»£ç å°±å¾ˆç®€å•äº†ï¼Œå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930public class TestThread &#123; public static void main(String[] args) &#123; // TODO Auto-generated method stub MyThread thread1 = new MyThread(\"ä¸€å·çª—å£\"); MyThread thread2 = new MyThread(\"äºŒå·çª—å£\"); MyThread thread3 = new MyThread(\"ä¸‰å·çª—å£\"); thread1.start(); thread2.start(); thread3.start(); &#125; public static class MyThread extends Thread &#123; private String name; public MyThread(String name) &#123; this.name = name; &#125; int count = 5; @Override public void run() &#123; // TODO Auto-generated method stub while (count &gt; 0) &#123; System.out.println(\"å½“å‰å”®ç¥¨çª—å£ä¸ºï¼š\" + this.name + \" å”®ç¥¨ï¼š\" + count--); &#125; &#125; &#125;&#125; è¿è¡Œç»“æœ1ï¼š æˆ‘ä»¬å…ˆå°†ä¸¤ä¸ªä»£ç éƒ½ç»™å¤§å®¶ï¼Œç¨åå†åšåˆ†æã€‚ ç¤ºä¾‹ä»£ç 2 åŒæ ·ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè®©å®ƒå®ç°Runnableæ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728public class testRunnable &#123; public static void main(String[] args) &#123; // TODO Auto-generated method stub MyThread mt = new MyThread(); Thread t1 = new Thread(mt, \"ä¸€å·çª—å£\"); Thread t2 = new Thread(mt, \"äºŒå·çª—å£\"); Thread t3 = new Thread(mt, \"äºŒå·çª—å£\"); t1.start(); t2.start(); t3.start(); &#125; public static class MyThread implements Runnable &#123; private int count = 5; @Override public void run() &#123; // TODO Auto-generated method stub while (count &gt; 0) &#123; System.out.println(\"å½“å‰çº¿ç¨‹ä¸ºï¼š\" + Thread.currentThread().getName() + \" å”®ç¥¨ä¸ºï¼š\" + count--); &#125; &#125; &#125;&#125; è¿è¡Œç»“æœ2ï¼š 3. åˆ†æ é€šè¿‡ä»£ç è¿è¡Œç»“æœæˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„æˆªç„¶ä¸åŒï¼Œç›¸ä¿¡å¤§å®¶ç°åœ¨ä¹Ÿèƒ½ç†è§£äº†ï¼Œä¸ºä»€ä¹ˆè¯´Runnableæ˜¯å¯ä»¥è¿›è¡Œèµ„æºå…±äº«çš„ï¼Œä¸è¿‡è¿˜æ˜¯åœ¨å¤šè¯´ä¸€ç‚¹å§ã€‚ æˆ‘ä»¬ç»§æ‰¿äº†Threadçš„MyTheadç±»ï¼Œé€šè¿‡ä¸‰æ¬¡å®ä¾‹åŒ–ï¼Œåˆ†åˆ«çš„å°†è¿™ä¸‰ä¸ªå†startèµ·æ¥ï¼Œå°±ç›¸å½“äºç»™äº†ä¸‰ä¸ªå”®ç¥¨çª—å£æ¯äººä¸€ä¸ªå–5å¼ ç¥¨çš„ä»»åŠ¡ï¼Œä»–ä»¬å› ä¸ºæ˜¯ä¸‰ä¸ªå®ä¾‹ï¼Œå„è‡ªåšå„è‡ªçš„äº‹æƒ…ï¼Œå„è‡ªå®Œæˆè¿™ä¸ªå–ç¥¨çš„ä»»åŠ¡ã€‚ è€Œæˆ‘ä»¬å®ç°äº†Runnableçš„MyThreadç±»ï¼Œç›¸å½“äºå…ˆåˆ›å»ºäº†ä¸€ä¸ªä»»åŠ¡ï¼ˆå…¶å®å°±æ˜¯æˆ‘ä»¬new MyThreadè¿‡ç¨‹ï¼‰,ç„¶åé€šè¿‡å®ä¾‹åŒ–ä¸‰ä¸ªThreadï¼Œåˆ›å»ºäº†ä¸‰ä¸ªçº¿ç¨‹å…±åŒå»å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚ é‚£ä¸ºä»€ä¹ˆè¯´Runnableæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„å‘¢ï¼Œç†ç”±å…¶å®å¾ˆç®€å•ï¼šå¦‚æœæˆ‘ä»¬åœ¨System.outâ€¦ä¹‹å‰åŠ ä¸Šä¸€ä¸ªçº¿ç¨‹ä¼‘çœ æ“ä½œçš„è¯ï¼Œå°±ä¼šå¾ˆæœ‰å¯èƒ½å¯¼è‡´æˆ‘ä»¬çš„countæœ€åèƒ½è¾“å‡º-1ï¼Œä¹Ÿå°±æ˜¯è¯´å­˜åœ¨ä¸€å¼ ç¥¨è¢«å”®å–ä¸¤æ¬¡çš„çŠ¶å†µã€‚å¦‚æœæƒ³å¯¹äºè¿™ä¸€ç‚¹è¿›è¡Œæµ‹è¯•çš„è¯ï¼Œå¤§å®¶è¦æ³¨æ„ä¸€ç‚¹ï¼Œç¥¨æ•°è¦è®¾ç½®çš„å¤§ä¸€äº›ï¼Œä¼‘çœ æ—¶é—´å†™æˆ1æ¯«ç§’å°±è¡Œï¼Œè¿™æ ·çš„æµ‹è¯•æ•ˆæœæ¯”è¾ƒæ˜æ˜¾ã€‚ é‚£ä¹ˆå¦‚ä½•æ‰èƒ½ä¿è¯æˆ‘ä»¬ç”¨Runnableæ—¶çš„çº¿ç¨‹å®‰å…¨æ€§å‘¢ï¼Ÿæ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªåœ°æ–¹åŠ ä¸ŠåŒæ­¥æ“ä½œï¼ˆäº’æ–¥é”ï¼‰ï¼Œç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå”®ç¥¨çš„æ“ä½œã€‚è€Œæˆ‘ä»¬ä¹‹å‰çš„ç»§æ‰¿Threadçš„æ–¹æ³•å¹¶ä¸éœ€è¦è¿™ä¹ˆåšï¼ŒåŸå› å°±æ˜¯æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œè‡ªå·±çš„Threadå¯¹è±¡ä¸­çš„ä»£ç ï¼Œä¸å­˜åœ¨å¤šä¸ªçº¿ç¨‹å…±åŒæ‰§è¡ŒåŒä¸€ä¸ªæ–¹æ³•çš„æƒ…å†µã€‚ ä»¥ä¸Šæ˜¯æœ¬æ¬¡çš„æ‰€æœ‰å†…å®¹ï¼Œæ„Ÿè°¢é©»è¶³~","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"http://weafteam.github.io/tags/é¢è¯•/"}]},{"title":"Javaä¸­Listå’ŒArrayListçš„åŒºåˆ«","slug":"2018-05-07/Javaä¸­Listå’ŒArrayListçš„åŒºåˆ«","date":"2018-06-23T11:10:07.000Z","updated":"2018-08-07T08:56:41.620Z","comments":true,"path":"posts/e85880/","link":"","permalink":"http://weafteam.github.io/posts/e85880/","excerpt":"","text":"å¼€å§‹è¡¥åšå®¢äº†ä»5æœˆåˆåˆ°ç°åœ¨åº”è¯¥æœ‰8ç¯‡åšå®¢éœ€è¦è¡¥ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œå¼€å§‹å†™å§ åŒºåˆ« è¿™ä¿©ä¸ªçš„åŒºåˆ«å¾ˆæ˜æ˜¾ï¼ŒListæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè€ŒArrayListæ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒç»§æ‰¿AbstractListæŠ½è±¡ç±»å¹¶ä¸”å®ç°äº†Listæ¥å£ã€‚ æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªListçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥çš„newä¸€ä¸ªListï¼ˆæ˜¾ç„¶æ˜¯åºŸè¯ï¼Œæ¥å£è‚¯å®šæ˜¯ä¸èƒ½é€šè¿‡newå®ä¾‹åŒ–çš„ï¼‰ï¼Œè€Œåªèƒ½æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªç»§æ‰¿å¹¶å®ç°å®ƒçš„ç±»çš„å®ä¾‹å¹¶å°†è¿™ä¸ªå®ä¾‹åŒ–çš„å€¼èµ‹å€¼ç»™æˆ‘ä»¬çš„listå®ç°Listçš„å®ä¾‹åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®å¯ä»¥ç”¨ä¸€è¡Œä»£ç æ¥è¡¨ç¤ºï¼ˆå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæŒ‡å‘Listå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™å°±æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­å¤šæ€çš„ä¼˜åŠ¿å§ï¼ï¼‰ã€‚ 12345//ä¾‹å¦‚æˆ‘ä»¬è¦æ‹¿æ¥æ¯”è¾ƒçš„ArrayListList list = new ArrayList();//æˆ–è€…ç»§æ‰¿Listçš„å…¶ä»–ç±»List b = new LinkedList&lt;&gt;(); æ‰€ä»¥é€šè¿‡ä»¥ä¸Šçš„ä»£ç ï¼Œå¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ï¼ŒListçš„å®ä¾‹åŒ–çš„å…·ä½“æ“ä½œï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥çš„å†™ä¸€è¡Œ 1List list; åªä¸è¿‡è¿™æ ·åšå‡ºæ¥çš„listæ˜¯ä¸€ä¸ªç©ºçš„åˆ—è¡¨ï¼Œä½ å¯ä»¥åœ¨åç»­çš„æ“ä½œä¸ºå®ƒåšå¡«å……ã€‚ æ³¨æ„äº‹é¡¹ï¼š æˆ‘ä»¬æ¥ç€åˆšæ‰çš„ List list = new ArrayList(); æ¥è¯´ã€‚é¦–å…ˆlistæ˜¯ä¸€ä¸ªListç±»å‹çš„å¯¹è±¡ï¼Œè™½ç„¶æˆ‘ä»¬æ˜¯newçš„ä¸€ä¸ªArrayListçš„ï¼Œä½†æ˜¯æœ‰äº›ArrayListå…·æœ‰çš„è€ŒListç±»ä¸­æ²¡æœ‰çš„å±æ€§å’Œæ–¹æ³•ï¼Œlistéƒ½ä¸èƒ½å†ç”¨äº†ã€‚ é‚£ä¹ˆå¦‚ä½•æ‰èƒ½ä¿è¯ArrayListä¸­ç‹¬æœ‰çš„æ–¹æ³•å’Œå±æ€§éƒ½èƒ½è¢«ä½¿ç”¨åˆ°å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œæ¯•ç«ŸArrayListæ˜¯ä¸€ä¸ªç±»ï¼Œç›´æ¥å®ä¾‹åŒ–æ˜¯æ²¡é—®é¢˜çš„ï¼Œè¿™æ ·å®ƒæ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•å°±éƒ½å¯ä»¥ä½¿ç”¨äº†ã€‚ 1ArrayList A = new ArrayList(); æˆ‘ä»¬å†æ¥ç€è®²List list = new ArrayList();å¦‚æœListå’ŒArrayListä¸­å­˜åœ¨ç›¸åŒçš„å±æ€§ï¼ˆä¾‹å¦‚ï¼šint iï¼‰å’Œç›¸åŒçš„æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼šf()ï¼‰ï¼Œè¿™æ—¶å€™list.içš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯Listä¸­çš„å±æ€§ï¼Œè€Œa.f()è°ƒç”¨çš„æ˜¯ArrayListä¸­çš„æ–¹æ³•f()ã€‚ å…¶ä»– æœ‰å…³äºListå’ŒArrayListæœ¬æ–‡ç”¨åˆ°çš„æ˜¯æ²¡æœ‰æŒ‡å®šæ³›åŒ–ç±»å‹çš„å†™æ³•ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œæœ‰å…³å®è£…ç®±å’Œæ‹†ç®±çš„å†…å®¹ï¼Œæˆ‘è¿™æä¾›ä¸€ä¸ªç½‘å€ã€‚ http://www.cnblogs.com/a164266729/p/4561651.html æœ¬æ–‡å‚è€ƒ http://www.cnblogs.com/aisiteru/articles/1151874.html https://blog.csdn.net/erlian1992/article/details/51298276","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"http://weafteam.github.io/tags/é¢è¯•/"}]},{"title":"SpringBootä½¿ç”¨Swagger2","slug":"2018-06-11/SpringBoot-integration-with-Swagger2","date":"2018-06-10T18:04:44.000Z","updated":"2018-08-22T14:49:02.599Z","comments":true,"path":"posts/d023fbc0/","link":"","permalink":"http://weafteam.github.io/posts/d023fbc0/","excerpt":"","text":"ä¸€ã€ç®€ä»‹ Swagger2æ˜¯ä¸€æ¬¾å¯ä»¥ç”ŸæˆRESTfulæ¥å£æ–‡æ¡£çš„å·¥å…·ã€‚è€Œä¸”ä¹¦å†™èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œå¼€å‘äººå‘˜åªéœ€ç»´æŠ¤ä»£ç ï¼Œä¸ç”¨é¢å¤–ä¹¦å†™æ–‡æ¡£ã€‚ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ï¼Œè€Œä¸”å‘ˆç°çš„æ–¹å¼å¾ˆæ£’ã€‚è¿˜æ”¯æŒåœ¨çº¿æµ‹è¯•ã€‚ äºŒã€SpringBooté›†æˆ æˆ‘è¿™é‡Œæ—¶ä½¿ç”¨çš„æœ€æ–°ç‰ˆæœ¬2.9.2 æˆ‘è¿™é‡Œé¡¹ç›®æ˜¯ä½¿ç”¨Mavenæ„å»ºçš„ã€‚ 123456789101112&lt;!-- start swagger --&gt;&lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt; &lt;version&gt;2.9.2&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt; &lt;version&gt;2.9.2&lt;/version&gt;&lt;/dependency&gt;&lt;!-- end swagger --&gt; é…ç½®æ–‡ä»¶ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package com.xxx.config;import org.springframework.beans.factory.annotation.Value;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import springfox.documentation.builders.ApiInfoBuilder;import springfox.documentation.builders.PathSelectors;import springfox.documentation.builders.RequestHandlerSelectors;import springfox.documentation.service.ApiInfo;import springfox.documentation.service.Contact;import springfox.documentation.spi.DocumentationType;import springfox.documentation.spring.web.plugins.Docket;import springfox.documentation.swagger2.annotations.EnableSwagger2;/** * @Author ï¼šyaxuSong * @Description: å¢åŠ swaggerçš„rest APIæŸ¥çœ‹ * @Date: 13:20 2018/8/20 * @Modified by: */@EnableSwagger2@Configurationpublic class Swagger2Config &#123; //æ˜¯å¦å¼€å¯swaggerï¼Œæ­£å¼ç¯å¢ƒä¸€èˆ¬æ˜¯éœ€è¦å…³é—­çš„ï¼Œå¯æ ¹æ®springbootçš„å¤šç¯å¢ƒé…ç½®è¿›è¡Œè®¾ç½® @Value(value = \"$&#123;swagger.enabled&#125;\") Boolean swaggerEnabled; @Bean public Docket createRestApi() &#123; return new Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo()) // æ˜¯å¦å¼€å¯ .enable(swaggerEnabled).select() // æ‰«æçš„è·¯å¾„åŒ… .apis(RequestHandlerSelectors.basePackage(\"com.xxx.controller\")) // æŒ‡å®šè·¯å¾„å¤„ç†PathSelectors.any()ä»£è¡¨æ‰€æœ‰çš„è·¯å¾„ .paths(PathSelectors.any()).build().pathMapping(\"/\"); &#125; private ApiInfo apiInfo() &#123; return new ApiInfoBuilder() .title(\"åç«¯æœåŠ¡æ¥å£è¯¦æƒ…\") .description(\"yaxuSong\") // ä½œè€…ä¿¡æ¯ .contact(new Contact(\"yaxuSong\", \"https://weaf.top\", \"earth@weaf.top\")) .version(\"1.0.0\") .build(); &#125;&#125; éƒ¨åˆ†é¡¹ç›®é…ç½®ä¸åŒå¯èƒ½éœ€è¦é…ç½®è®¿é—®é™æ€æ–‡ä»¶çš„è·¯å¾„ 12345678910111213141516171819202122232425262728/** * @Author ï¼šyaxuSong * @Description: å…è®¸è®¿é—®Swagger uié™æ€é¡µé¢ * @Date: 13:20 2018/8/20 * @Modified by: */@Configurationpublic class WebMvcConfig extends WebMvcConfigurerAdapter &#123; @Override public void addResourceHandlers(ResourceHandlerRegistry registry) &#123; registry.addResourceHandler(\"/static/**\").addResourceLocations(\"classpath:/static/\"); registry.addResourceHandler(\"swagger-ui.html\") .addResourceLocations(\"classpath:/META-INF/resources/\"); registry.addResourceHandler(\"/webjars/**\") .addResourceLocations(\"classpath:/META-INF/resources/webjars/\"); &#125; //è·¨åŸŸæ”¯æŒ @Override public void addCorsMappings(CorsRegistry registry) &#123; registry.addMapping(\"/**\"); &#125;&#125; è®¾ç½®æ–‡æ¡£å†…å®¹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697package com.xxx.controller;import com.xxx.annotation.EnableRequestLog;import com.xxx.common.CommonConverter;import com.xxx.common.Constants;import com.xxxx.common.Restful;import com.xxx.common.Restful.Result; //...........import io.swagger.annotations.Api;import io.swagger.annotations.ApiImplicitParam;import io.swagger.annotations.ApiImplicitParams;import io.swagger.annotations.ApiOperation;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.format.annotation.DateTimeFormat;import org.springframework.stereotype.Controller;import org.springframework.util.CollectionUtils;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestMethod;import org.springframework.web.bind.annotation.RequestParam;import org.springframework.web.bind.annotation.ResponseBody;import org.springframework.web.multipart.MultipartFile;import javax.servlet.http.HttpServletRequest;import java.util.Date;import java.util.List;import java.util.concurrent.TimeUnit;/** * @Author ï¼šyaxuSong * @Description: * @Date: 17:17 2018/5/25 * @Modified by: */@Controller@RequestMapping(\"user\")@Api(tags = \"ç”¨æˆ·API\")@Slf4jpublic class UserController &#123; @Autowired private UserService userService; /** * type = 0 ä¸ºç²‰ä¸åˆ—è¡¨ 1 - ä¸ºå…³æ³¨è€…åˆ—è¡¨ é»˜è®¤0 * @param type * @return */ @EnableRequestLog(\"æŸ¥çœ‹ç²‰ä¸ï¼Œå…³æ³¨åˆ—è¡¨\") @ResponseBody @RequestMapping(\"list\") @ApiOperation(value = \"æŸ¥çœ‹ç²‰ä¸å’Œå…³æ³¨åˆ—è¡¨\",httpMethod = \"POST\", notes = \"type= 0,æ˜¯æŸ¥çœ‹ç²‰ä¸åˆ—è¡¨ï¼Œtype =1 æ˜¯æŸ¥çœ‹å…³æ³¨åˆ—è¡¨ï¼Œé»˜è®¤å€¼æ˜¯0\") public Result list(@RequestParam(value = \"type\",defaultValue = \"0\",required = false) int type ,int limit,int offset,HttpServletRequest request)&#123; AppUser appUser = getUser(request); if (appUser == null) &#123; return Restful.failure(RestfulResultEnum.USER_UNLOGIN); &#125; if (type == 0) &#123; return Restful.success(userService.getFollowList(appUser.getId(),limit,offset)); &#125; else &#123; List&lt;UserListVO&gt; list = userService.getFocusList(appUser.getId(), limit, offset); if (CollectionUtils.isEmpty(list)) &#123; return Restful.success(list); &#125; else &#123; for (int i = 0;i&lt;list.size();i++)&#123; list.get(i).setRank(Long.parseLong(rankService.getRank(list.get(i).getId())+\"\")); &#125; return Restful.success(list); &#125; &#125; &#125; @EnableRequestLog(\"åŒæ­¥å¾®ä¿¡ä¿¡æ¯\") @ResponseBody @ApiOperation(value = \"åŒæ­¥å¾®ä¿¡ä¿¡æ¯\") @RequestMapping(\"sync/wechat\") @ApiImplicitParams(&#123; @ApiImplicitParam(name = \"id\", value = \"å¾®ä¿¡å¯¹è±¡\", required = true, dataType = \"WeChatDTO\") &#125;) public Result syncWechat(WeChatDTO weChatDTO,HttpServletRequest request)&#123; AppUser appUser = getUser(request); if (appUser == null) &#123; return Restful.failure(RestfulResultEnum.USER_UNLOGIN); &#125; log.info(\"ã€ç”¨æˆ·ID = &#123;&#125;,ç±»å = UserController,æ–¹æ³•å = syncWechat, å‚æ•°ä¸º = &#123;&#125;ã€‘\",appUser.getId(),weChatDTO.toString()); UserInfoVO vo = userService.syncWeChat(weChatDTO,appUser.getId()); if (vo==null) &#123; return Restful.failure(RestfulResultEnum.USER_SYNC_WECHAT_FAIL); &#125; return Restful.success(vo); &#125;&#125; å®ä½“å¯¹è±¡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.xxx.entry.dto;import io.swagger.annotations.ApiModel;import io.swagger.annotations.ApiModelProperty;import lombok.Data;/** * @Author ï¼šyaxuSong * @Description: * @Date: 11:32 2018/5/29 * @Modified by: */@Data@ApiModelpublic class WeChatDTO &#123; @ApiModelProperty(value=\"æ‰‹æœºå·ç \",dataType=\"String\",name=\"phone\",example=\"15300000000\") private String phone; @ApiModelProperty(value=\"åç§°\",dataType=\"String\",name=\"name\",example=\"æ„¿å¾—ä¸€äººå¿ƒ\") private String name; @ApiModelProperty(value=\"æ€§åˆ«\",dataType=\"String\",name=\"gender\",example=\"ç”·\") private String gender; @ApiModelProperty(value=\"unionID\",dataType=\"String\",name=\"unionId\",example=\"o17g2621sE-9Ak-Nva2QbHzeF4\") private String unionId; @ApiModelProperty(value=\"å¤´åƒè·¯å¾„\",dataType=\"String\",name=\"avatar\",example=\"https://xxxx.png\") private String avatar; @ApiModelProperty(value=\"openID\",dataType=\"String\",name=\"openId\",example=\"othzc0VW0T8yyEk52C3lh2H_lTE0\") private String openId; @ApiModelProperty(value=\"çœä»½\",dataType=\"String\",name=\"province\",example=\"åŒ—äº¬\") private String province; @ApiModelProperty(value=\"å›½å®¶\",dataType=\"String\",name=\"country\",example=\"ä¸­å›½\") private String country; @ApiModelProperty(value=\"éªŒè¯ç \",dataType=\"String\",name=\"code\",example=\"2341\") private String code; @ApiModelProperty(value=\"é‚€è¯·ç \",dataType=\"String\",name=\"inviteCode\",example=\"LTEtNTQzMDMtRkUwQzQzNjE3NkE0NEM1MzAzNTBGRjk1NkU2QzQ4MkQ=\") private String inviteCode;&#125; ä¸‰ã€ç»“æœå±•ç¤º è®¿é—®è·¯å¾„ http://127.0.0.1:10086/swagger-ui.html#/ è®¾ç½®è¯·æ±‚æ–¹æ³•çš„â€œæŸ¥çœ‹ç²‰ä¸å’Œå…³æ³¨åˆ—è¡¨â€ï¼ˆè®¾ç½®äº†è¯·æ±‚æ–¹æ³•ï¼‰ æœªè®¾ç½®è¯·æ±‚æ–¹æ³•çš„api ä¸¤ç§è®¾ç½®æ–¹æ³•çš„è¯¦ç»†å†…å®¹ï¼ˆé€šè¿‡ç‚¹å‡»try itå¯ä»¥è¿›è¡Œæµ‹è¯•ï¼‰è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡Postmanè¿›è¡Œæµ‹è¯• å››ã€ç›¸å…³æ³¨è§£ å‚è€ƒæ–‡æ¡£ï¼šhttps://swagger.io/","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆä¸ƒï¼‰","slug":"2018-06-04/guide-to-asyncio-7","date":"2018-06-09T09:35:25.000Z","updated":"2018-08-07T08:56:41.657Z","comments":true,"path":"posts/a6235d78/","link":"","permalink":"http://weafteam.github.io/posts/a6235d78/","excerpt":"","text":"ä¹¦æ¥ä¸Šæ–‡ã€‚ ä½¿ç”¨ aiohttp ä½œä¸º Web æœåŠ¡å™¨ ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°ï¼Œaiohttp ä¸ä»…ä»…æ˜¯ä¸€ä¸ª http å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ã€‚åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ aiohttp å®ç°ä¸€ä¸ªç®€å•çš„ Web ç¨‹åºï¼ŒåŒæ—¶ä¸ flask æ¯”è¾ƒä¸€ä¸‹æ€§èƒ½ä¸Šçš„å·®åˆ«ã€‚ å‡†å¤‡å·¥ä½œ é¦–å…ˆå®‰è£…æˆ‘ä»¬éœ€è¦çš„ç¬¬ä¸‰æ–¹åº“ï¼š 12pip install aiohttppip install flask ç„¶åå‡†å¤‡å¥½è¦ä½¿ç”¨çš„ Web å®¹å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å¯¹ aiohttp å’Œ flask éƒ½å¾ˆå‹å¥½çš„ gunicornã€‚ä¸ºäº†è®© flask å¾—åˆ°å¼‚æ­¥æ”¯æŒï¼Œ éœ€è¦åŒæ—¶å®‰è£… geventï¼š 1pip install gunicorn[gevent] å®‰è£… wrkï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼š 1brew install wrk Hello, world æˆ‘ä»¬çš„èµ·æ‰‹å¼å½“ç„¶æ˜¯ Hello, worldã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨ flask å’Œ aiohttp å®ç°ä¸€ä¸ªè¿”å› Hello, world çš„ Web æœåŠ¡ã€‚ flask 123456789# flask_app.pyfrom flask import Flaskapp = Flask(\"flask_app\")@app.route(\"/\")def hello(): return \"Hello, world!\" éå¸¸ç®€å•ï¼ æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ€§èƒ½æµ‹è¯•çš„ç»“æœã€‚é¦–å…ˆç”¨ gunicorn å¯åŠ¨åº”ç”¨ï¼Œå°† socket ç»‘å®šåˆ° localhost:5000ï¼Œæ‰“å¼€è®¿é—®æ—¥å¿—ï¼Œä½¿ç”¨ 4 ä¸ª workerï¼Œå¹¶ä½¿ç”¨ gevent ä½œä¸º worker çš„ç±»å‹ï¼š 1gunicorn -b localhost:5000 --access-logfile - -w 4 -k gevent flask_app:app ç„¶åå°±å¯ä»¥è¿›è¡Œæ€§èƒ½æµ‹è¯•äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ 8 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ 200 ä¸ªè¯·æ±‚ï¼Œå…±æµ‹è¯• 10 ç§’ï¼Œå¹¶å¼€å¯è¯¦ç»†æ—¥å¿—ï¼š 1wrk -t8 -c200 -d10s --latency http://localhost:5000 æˆ‘ä»¬ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š 1234567891011121314Running 10s test @ http://localhost:5000 8 threads and 200 connections Thread Stats Avg Stdev Max +/- Stdev Latency 9.80ms 94.91ms 1.67s 99.06% Req/Sec 1.07k 555.92 2.14k 63.76% Latency Distribution 50% 1.55ms 75% 1.82ms 90% 2.27ms 99% 20.89ms 23325 requests in 10.01s, 3.96MB read Socket errors: connect 0, read 0, write 0, timeout 8Requests/sec: 2330.74Transfer/sec: 405.20KB è¿™é‡Œåªå…³æ³¨å‡ ä¸ªé‡è¦çš„ä¿¡æ¯ï¼š Latencyï¼Œå¯ä»¥ç†è§£ä¸ºå“åº”æ—¶é—´ï¼Œwrk æä¾›äº†å¹³å‡å€¼ï¼Œæ ‡å‡†å·®ï¼Œæœ€å¤§å€¼ï¼Œä»¥åŠæ­£è´Ÿä¸€ä¸ªæ ‡å‡†å·®çš„å æ¯”ï¼› Req/Secï¼Œæ¯ä¸ªçº¿ç¨‹æ¯ç§’é’Ÿçš„å®Œæˆçš„è¯·æ±‚æ•°ï¼ŒåŒæ ·æœ‰ä»¥ä¸Šæ•°æ®ç±»å‹ï¼› Latency Distributionï¼Œå“åº”æ—¶é—´çš„åˆ†å¸ƒæƒ…å†µï¼Œ50%ã€75%ã€90%ã€99%çš„è¯·æ±‚åœ¨å¤šé•¿æ—¶é—´å†…ç»“æŸï¼› Socket errorsï¼Œåœ¨æµ‹è¯•ä¸­æœ‰å¤šå°‘é”™è¯¯å‘ç”Ÿï¼› Requests/secï¼Œæ¯ç§’é’Ÿå®Œæˆå¤šå°‘è¯·æ±‚ï¼› Transfer/secï¼Œæ¯ç§’é’Ÿäº§ç”Ÿçš„æ•°æ®é‡ï¼› çŸ¥é“äº†ä¸Šè¿°ä¿¡æ¯çš„å«ä¹‰ï¼Œå°±å¯ä»¥å¯¹åº”ç”¨ç¨‹åºçš„æ€§èƒ½æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£äº†ã€‚ aiohttp åŒæ ·æˆ‘ä»¬ç”¨ aiohttp å®ç°ä¸€ä¸ª Hello world åº”ç”¨ï¼š 12345678910111213# aio_app.pyfrom aiohttp import webroutes = web.RouteTableDef()@routes.get(\"/\")async def hello(request): return web.Response(text=\"Hello, world!\")app = web.Application()app.add_routes(routes) ç„¶åç”¨ gunicorn å¯åŠ¨å®ƒï¼š 1gunicorn -b localhost:5000 --access-logfile - -w 4 -k aiohttp.GunicornWebWorker aio_app:app å¤§éƒ¨åˆ†å‚æ•°éƒ½ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ä½¿ç”¨äº† aiohttp çš„ wroker ç±»å‹ã€‚ ä¹Ÿç”¨åŒæ ·çš„å‚æ•°å¯åŠ¨ wrkï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š 12345678910111213Running 10s test @ http://localhost:5000 8 threads and 200 connections Thread Stats Avg Stdev Max +/- Stdev Latency 32.58ms 15.57ms 120.43ms 68.40% Req/Sec 773.91 167.40 1.16k 67.25% Latency Distribution 50% 36.83ms 75% 42.40ms 90% 46.73ms 99% 66.48ms 61709 requests in 10.03s, 9.65MB readRequests/sec: 6150.18Transfer/sec: 0.96MB å¯¹æ¯” æˆ‘ä»¬æŠŠæ€§èƒ½æµ‹è¯•çš„ç»“æœæ”¾åœ¨ä¸€å—å¯¹æ¯”ä¸€ä¸‹ï¼Œå·¦è¾¹æ˜¯ flaskï¼Œå³è¾¹æ˜¯ aiohttpï¼š 1234567891011121314Running 10s test @ http://localhost:5000 Running 10s test @ http://localhost:5000 8 threads and 200 connections 8 threads and 200 connections Thread Stats Avg Stdev Max +/- Stdev Thread Stats Avg Stdev Max +/- Stdev Latency 9.80ms 94.91ms 1.67s 99.06% Latency 32.58ms 15.57ms 120.43ms 68.40% Req/Sec 1.07k 555.92 2.14k 63.76% Req/Sec 773.91 167.40 1.16k 67.25% Latency Distribution Latency Distribution 50% 1.55ms 50% 36.83ms 75% 1.82ms 75% 42.40ms 90% 2.27ms 90% 46.73ms 99% 20.89ms 99% 66.48ms 23325 requests in 10.01s, 3.96MB read 61709 requests in 10.03s, 9.65MB read Socket errors: connect 0, read 0, write 0, timeout 8Requests/sec: 2330.74 Requests/sec: 6150.18Transfer/sec: 405.20KB Transfer/sec: 0.96MB å¯ä»¥çœ‹å‡º flask åœ¨å•ä¸ªè¯·æ±‚çš„è€—æ—¶ä¸Šæ˜æ˜¾èƒœäº aiohttpï¼Œä½†æ˜¯æ ‡å‡†å·®å·¨å¤§ï¼Œåœ¨å‹åŠ›åœºæ™¯ä¸‹æœ€å¤§è€—æ—¶é•¿è¾¾ 1.67sï¼Œç”šè‡³å‡ºç°äº† 8 ä¸ªè¶…æ—¶çš„è¿æ¥ï¼Œè€Œ aiohttp çš„è¯·æ±‚è€—æ—¶æ¯”è¾ƒç¨³å®šï¼›æœ€é‡è¦çš„åŒºåˆ«åœ¨äºï¼Œaiohttp æ¯ç§’å®Œæˆäº†å¤šè¾¾ 6150.18 ä¸ªè¯·æ±‚ï¼Œæ˜¯ flask çš„è¿‘ 3 å€ï¼flask ä¸­ 1% è¶…è¿‡ 20.89ms çš„è¯·æ±‚ä¸¥é‡å½±å“äº†æ•´ä½“çš„æ€§èƒ½ã€‚ ç‚¹å‡»è®¡æ•° é€šè¿‡ä¸Šé¢çš„ Hello, world ç¨‹åºæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä½¿ç”¨ aiohttp å¯ä»¥æ˜¾è‘—æå‡ Web ç¨‹åºçš„æ€§èƒ½ã€‚å½“ç„¶ Web ç¨‹åºå¹¶ä¸æ­¢äºæ­¤ï¼Œå®ƒè¿˜éœ€è¦æ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰ç»„ä»¶ååŒå·¥ä½œã€‚asyncio çš„å‘¨è¾¹è™½ç„¶åœ¨è¿…é€Ÿå‘å±•ï¼Œä¸è¿‡ä»ä¸å®Œå–„ã€‚å¥½æ¶ˆæ¯æ˜¯ RabbitMQ çš„ Python é©±åŠ¨åœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¹ŸåŠ å…¥äº† asyncio æ”¯æŒï¼ŒåŸºæœ¬ç»„ä»¶å¤§éƒ¨åˆ†éƒ½æ”¯æŒäº† asyncioã€‚åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬å¢åŠ  redis æ”¯æŒï¼Œåˆ¶ä½œä¸€ä¸ªç®€å•çš„ç‚¹å‡»è®¡æ•°å™¨ã€‚ å‡†å¤‡å·¥ä½œ åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… redisï¼Œå¹¶å¯åŠ¨å®ƒï¼š 12brew install redisbrew services start redis å‡†å¤‡å¥½æ”¯æŒ asyncio çš„ redis é©±åŠ¨ï¼š 1pip install aioredis å®šä¹‰ App 123from aiohttp import webapp = web.Application() åˆå§‹åŒ– redis åœ¨ aiohttp ä¸­ä½¿ç”¨ redis éœ€è¦åœ¨åº”ç”¨å¯åŠ¨å‰åˆå§‹åŒ–è¿æ¥æ± ï¼Œå¹¶åœ¨åº”ç”¨é€€å‡ºåå…³é—­è¿æ¥æ± ï¼š 12345678import aioredisasync def setup_redis(app): redis_url = \"redis://@localhost/0\" app[\"redis\"] = await aioredis.create_redis_pool(redis_url) yield app[\"redis\"].close() await app[\"redis\"].wait_closed() å¹¶å°†åˆå§‹åŒ–å‡½æ•°æ³¨å†Œåˆ° app çš„æ¸…ç†ä¸Šä¸‹æ–‡ï¼š 1app.cleanup_ctx.append(setup_redis) ç¼–å†™è·¯ç”± 12345678routes = web.RouteTableDef()@routes.get(\"/hit\")async def hello(request): redis = request.app[\"redis\"] return web.json_response(&#123;\"hit\": await redis.incr(\"hit\")&#125;)app.add_routes(routes) è¿™æ ·ï¼Œä¸€ä¸ªç‚¹å‡»è®¡æ•°å™¨å°±å®Œæˆäº†ã€‚æˆ‘ä»¬è¯•ç€è¯·æ±‚ä¸€ä¸‹ï¼š 12345678910$ http localhost:5000/hitHTTP/1.1 200 OKContent-Length: 10Content-Type: application/json; charset=utf-8Date: Sat, 09 Jun 2018 08:37:33 GMTServer: Python/3.6 aiohttp/3.3.1&#123; \"hit\": 1&#125; ä¹‹åæ¯æ¬¡è¯·æ±‚ hit çš„å€¼éƒ½ä¼š +1ã€‚ å¯¹æ¯” åŒæ ·ï¼Œæˆ‘ä¹Ÿç¼–å†™äº†ä¸€ä¸ª flask ç‰ˆæœ¬çš„ç‚¹å‡»è®¡æ•°å™¨ï¼Œåœ¨è¿™é‡Œåªå±•ç¤ºä¸€ä¸‹å¯¹æ¯”ç»“æœï¼š aiohttp ç‰ˆæœ¬ï¼š 12345678910111213Running 10s test @ http://localhost:5000/hit 8 threads and 200 connections Thread Stats Avg Stdev Max +/- Stdev Latency 35.83ms 7.18ms 90.80ms 70.37% Req/Sec 699.60 86.70 0.92k 68.62% Latency Distribution 50% 35.01ms 75% 40.39ms 90% 44.61ms 99% 58.03ms 55816 requests in 10.04s, 9.10MB readRequests/sec: 5559.97Transfer/sec: 0.91MB flask ç‰ˆæœ¬ï¼š 1234567891011121314Running 10s test @ http://localhost:5000/hit 8 threads and 200 connections Thread Stats Avg Stdev Max +/- Stdev Latency 123.99ms 171.06ms 1.89s 95.32% Req/Sec 262.03 163.41 670.00 69.57% Latency Distribution 50% 106.59ms 75% 156.67ms 90% 179.60ms 99% 1.05s 20484 requests in 10.07s, 3.33MB read Socket errors: connect 0, read 19, write 0, timeout 0Requests/sec: 2033.33Transfer/sec: 338.51KB å¯ä»¥çœ‹å‡ºå¢åŠ äº† redis çš„å†…å­˜ io æ“ä½œå aiohttp çš„é¢†å…ˆä¼˜åŠ¿å·¨å¤§ï¼Œè€Œ Web åº”ç”¨å¤§å¤šæ˜¯é‡ io çš„ï¼Œå¯ä»¥é¢„è§åˆ° asyncio åœ¨æœªæ¥ä¼šå æ®æ›´é‡è¦çš„åœ°ä½ã€‚ ç»“è¯­ å†™å®Œè¿™ç¯‡ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°±åˆ°æ­¤ä¸ºæ­¢äº†ã€‚æ•´ä½“ä¸Š asyncio ä»åœ¨ç»§ç»­å‘å±•ï¼Œæœ‰è¶Šæ¥è¶Šå¤šçš„åŸºç¡€ç»„ä»¶å·²ç»æœ‰äº†å¯ç”¨çš„ asyncio ç‰ˆæœ¬ï¼Œä¸€äº›å¤§å‚å·²ç»æœ‰è½¬å‘ asyncio çš„è¶‹åŠ¿äº†ã€‚asyncio æ˜¯æœªæ¥ï¼Œæ˜¯ä¸€å®šè¦äº†è§£çš„~","categories":[],"tags":[]},{"title":"Redisson çš„ä»‹ç»ä¸ä½¿ç”¨","slug":"2018-06-04/Redisson-çš„ä»‹ç»ä¸ä½¿ç”¨","date":"2018-06-04T18:04:44.000Z","updated":"2018-08-08T11:54:45.491Z","comments":true,"path":"posts/eae731fe/","link":"","permalink":"http://weafteam.github.io/posts/eae731fe/","excerpt":"","text":"ä¸€ã€ç®€ä»‹ Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ã€‚å…¶ä¸­åŒ…æ‹¬(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redissonæä¾›äº†ä½¿ç”¨Redisçš„æœ€ç®€å•å’Œæœ€ä¾¿æ·çš„æ–¹æ³•ã€‚Redissonçš„å®—æ—¨æ˜¯ä¿ƒè¿›ä½¿ç”¨è€…å¯¹Redisçš„å…³æ³¨åˆ†ç¦»ï¼ˆSeparation of Concernï¼‰ï¼Œä»è€Œè®©ä½¿ç”¨è€…èƒ½å¤Ÿå°†ç²¾åŠ›æ›´é›†ä¸­åœ°æ”¾åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚ äºŒã€åˆ†å¸ƒå¼é” ä»Šå¤©ä¹Ÿåªæ˜¯å°±Redissonåˆ†å¸ƒå¼é”è¿™ä¸€éƒ¨åˆ†è¿›è¡Œè®²è§£ã€‚ åœ¨å¾ˆå¤šæ—¶å€™ï¼Œä¸€ä¸ªæœåŠ¡å™¨å·²ç»ä¸æ»¡è¶³æˆ‘ä»¬å¯¹æœåŠ¡æ€§èƒ½çš„è¦æ±‚äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•è¿›å’Œå¾ˆå¤šç›¸å…³çš„æŠ€æœ¯ï¼Œå¼•å…¥äº†åˆ†å¸ƒå¼æœåŠ¡çš„æ–¹å¼ï¼Œä½†æ˜¯è¿™æ ·æ—¢å¸¦æ¥äº†æ–¹ä¾¿ï¼Œå…¶å®ä¹Ÿå¸¦æ¥äº†é—®é¢˜ï¼Œå¤šå°æœåŠ¡å™¨ä¸€èµ·è¿è¡Œç›¸åŒçš„ä»£ç ï¼Œä¸€æ—¦ä¸¤å°æœåŠ¡è¿è¡Œäº†ç›¸åŒçš„ä»£ç ï¼Œé‚£å°±è¦ä¿è¯æœåŠ¡â€œå¹‚ç­‰æ€§â€çš„è®¾è®¡ã€‚è€Œä¸”è¦è€ƒè™‘æœåŠ¡å¹¶å‘å¸¦æ¥çš„å¯èƒ½æ€§é—®é¢˜ã€‚ é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å¼•å…¥åˆ†å¸ƒå¼é”çš„æ¦‚å¿µï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä½¿ç”¨é”ï¼Œå°†æˆ‘ä»¬è¦ç´§è¡Œæ“ä½œçš„å¯¹è±¡æˆ–è€…æ•°æ®åŠ é”ã€‚æ“ä½œåé‡Šæ”¾é”ã€‚ä½¿å¾—æ­¤æ—¶æ“ä½œè¿™ä¸ªå¯¹è±¡çš„æœåŠ¡å™¨åªæœ‰ä¸€ä¸ªï¼ˆæˆ–è€…è¯´åªèƒ½å¯¹å½“å‰å¯¹è±¡è¿›è¡Œå½“å‰æ‹¿åˆ°é”çš„æ“ä½œï¼Œæ‹¿ä¸åˆ°é”çš„éƒ½ä¸å…è®¸æ“ä½œï¼‰ã€‚è¿™æ ·ä¿è¯æ•°æ®çš„æ¯æ¬¡æ“ä½œå‰åéƒ½ä¸ä¼šæœ‰é—®é¢˜ã€‚å½“ç„¶åŒä¸€ä¸ªæœåŠ¡å™¨ä¹Ÿåªèƒ½å¯¹å½“å‰å¯¹è±¡è¿›è¡Œä¸€ä¸ªæ“ä½œã€‚ å…¶å®ä¸ºäº†ä¿è¯è¿™ä¸€ç‚¹ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šé”ï¼Œç›¸ä¿¡å¤§å®¶ä¹ŸçŸ¥é“ï¼Œä¹è§‚é”ï¼Œæ‚²è§‚é”ã€è¡¨é”ã€è¡Œé”ç­‰ã€‚ ä¸‰ã€å…·ä½“é…ç½® æ­¤æ–‡æ˜¯ä»¥SpringBootä¸ºåŸºç¡€æ¥å®ç°çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536package lock;import org.redisson.Redisson;import org.redisson.api.RedissonClient;import org.redisson.config.Config;import org.springframework.beans.factory.annotation.Value;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;/** * @Author ï¼šyaxuSong * @Description: * @Date: 11:30 2018/6/30 * @Modified by: */@Configurationpublic class RedissionServiceConfig &#123; @Value(\"$&#123;spring.redis.host&#125;\") private String redisHost; @Value(\"$&#123;spring.redis.port&#125;\") private String redisPort; @Value(\"$&#123;spring.redis.password&#125;\") private String redisPassword; @Value(\"$&#123;spring.redis.database&#125;\") private Integer redisDatabase; @Bean(\"redisson\") public RedissonClient redissionConfig()&#123; Config config = new Config(); config.useSingleServer().setAddress(redisHost + \":\" + redisPort).setPassword(redisPassword) .setDatabase(redisDatabase); return Redisson.create(config); &#125;&#125; å››ã€å®ç°ä¸åº”ç”¨ å®ç°éƒ¨åˆ† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667package lock;import xxx.ExceptionCodeEnum;import lombok.extern.slf4j.Slf4j;import org.redisson.api.RLock;import org.redisson.api.RedissonClient;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Qualifier;import org.springframework.stereotype.Service;import java.util.concurrent.TimeUnit;/** * @Author ï¼šyaxuSong * @Description: * @Date: 11:30 2018/6/30 * @Modified by: */@Slf4j@Service(\"redissonLockService\")public class RedissonLockServiceImpl implements LockService &#123; @Autowired @Qualifier(\"redisson\") private RedissonClient redisson; @Override public boolean tryLock(String key) &#123; return tryLock(key); &#125; @Override public boolean tryLock(String key, long timeout, TimeUnit unit) &#123; return tryLock(key, timeout, LockService.DEFAULT_EXPIRE_TIME, unit); &#125; @Override public boolean tryLock(String key, long waitTime, long leaseTime, TimeUnit unit) &#123; try &#123; RLock lock = redisson.getLock(key); boolean res = lock.tryLock(waitTime, leaseTime, unit); return res; &#125; catch (InterruptedException e) &#123; RedissonLockServiceImpl.log.error(\"è·å–redissoné”å¼‚å¸¸, key is &#123;&#125;, timeout is &#123;&#125;,leaseTime is &#123;&#125;, unit is &#123;&#125;.\", key, waitTime, leaseTime, unit, e); throw new LockException(ExceptionCodeEnum.CACHE_EXCEPTION_LOCK_FAIL); &#125; &#125; @Override public void lock(String key) &#123; RLock lock = redisson.getLock(key); lock.lock(); &#125; @Override public void unLock(String key) &#123; try &#123; RLock lock = redisson.getLock(key); lock.unlock(); &#125; catch (Exception e) &#123; RedissonLockServiceImpl.log.error(\"redissonè§£é”å¤±è´¥,key=&#123;&#125;\", key, e); &#125; &#125;&#125; åº”ç”¨ 123456789String lockKey = \"xxxx\"; if(!lockService.tryLock(lockKey))&#123; log.warn(\"current request can't not be locked!\"); throw new LockException(code,msg); &#125;//...lockService.unLock(lockKey); äº”ã€ç›¸å…³é—®é¢˜ å¤§å®¶éƒ½çŸ¥é“ï¼Œå¦‚æœè´Ÿè´£å‚¨å­˜è¿™ä¸ªåˆ†å¸ƒå¼é”çš„RedisèŠ‚ç‚¹å®•æœºä»¥åï¼Œè€Œä¸”è¿™ä¸ªé”æ­£å¥½å¤„äºé”ä½çš„çŠ¶æ€æ—¶ï¼Œè¿™ä¸ªé”ä¼šå‡ºç°é”æ­»çš„çŠ¶æ€ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼ŒRedissonå†…éƒ¨æä¾›äº†ä¸€ä¸ªç›‘æ§é”çš„çœ‹é—¨ç‹—ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨Redissonå®ä¾‹è¢«å…³é—­å‰ï¼Œä¸æ–­çš„å»¶é•¿é”çš„æœ‰æ•ˆæœŸã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œçœ‹é—¨ç‹—çš„æ£€æŸ¥é”çš„è¶…æ—¶æ—¶é—´æ˜¯30ç§’é’Ÿï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹Config.lockWatchdogTimeoutæ¥å¦è¡ŒæŒ‡å®šã€‚ å‚è€ƒæ–‡ç«  ï¼šhttps://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"chapter-11-AIR","slug":"2018-05-21/TensorFlowå®ç°Siamese Network","date":"2018-05-29T03:27:34.000Z","updated":"2018-08-12T11:03:56.319Z","comments":true,"path":"posts/45d29694/","link":"","permalink":"http://weafteam.github.io/posts/45d29694/","excerpt":"","text":"TensorFlow å®ç°Siamese Network è¿™æ¬¡æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªåŸºäºlenetçš„Siamese Networkï¼Œå¤§å®¶å¦‚æœæƒ³äº†è§£Siamese Networkï¼Œç»™å¤§å®¶æ¨èAndrew NGçš„è¯¾deeplearning.aiä½œä¸ºäº†è§£ æ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥ä¸Šcodeï¼šå¤§å®¶ä¹Ÿå¯ä»¥ç›´æ¥ç§»æ­¥åˆ°æˆ‘çš„github ä»“åº“é‡Œé¢æ‰¾ä»£ç ä»£ç  123456789ä»£ç ç›®å½•ç»„ç»‡ç»“æ„ï¼šsiameasenetwork __init__.py mnistï¼š __init__.py train.py lenet.py util.py DataShuffler.py train.py 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275#!/usr/bin/env python# -*- coding: utf-8 -*-# @Time : 2018/5/25 22:16# @Author : milittle# @Site : www.weaf.top# @File : train.py# @Software: PyCharmimport tensorflow as tfimport numpy as np from siameasenetwork.mnist import util # è¿™æ˜¯å¤–éƒ¨ä¾èµ–æ–‡ä»¶from siameasenetwork.mnist.DataShuffler import * #è¿™æ˜¯æ‰“ä¹±æ•°æ®æ–‡ä»¶from siameasenetwork.mnist.lenet import Lenet # ä¸»ç½‘ç»œç»“æ„SEED = 10def compute_euclidean_distance(x, y): \"\"\" Computes the euclidean distance between two tensorflow variables \"\"\" with tf.name_scope('euclidean_distance') as scope: #d = tf.square(tf.sub(x, y)) #d = tf.sqrt(tf.reduce_sum(d)) # What about the axis ??? d = tf.sqrt(tf.reduce_sum(tf.square(tf.subtract(x, y)), 1)) return ddef compute_contrastive_loss(left_feature, right_feature, label, margin, is_target_set_train=True): \"\"\" Compute the contrastive loss as in http://yann.lecun.com/exdb/publis/pdf/hadsell-chopra-lecun-06.pdf L = 0.5 * (Y) * D^2 + 0.5 * (1-Y) * &#123;max(0, margin - D)&#125;^2 OR MAYBE THAT L = 0.5 * (1-Y) * D^2 + 0.5 * (Y) * &#123;max(0, margin - D)&#125;^2 **Parameters** left_feature: First element of the pair right_feature: Second element of the pair label: Label of the pair (0 or 1) margin: Contrastive margin **Returns** Return the loss operation \"\"\" with tf.name_scope(\"contrastive_loss\"): label = tf.to_float(label) one = tf.constant(1.0) d = compute_euclidean_distance(left_feature, right_feature) d_sqrt = tf.sqrt(d) loss = label * tf.square(tf.maximum(0., margin - d_sqrt)) + (1 - label) * d loss = 0.5 * tf.reduce_mean(loss) # #first_part = tf.mul(one - label, tf.square(d)) # (Y-1)*(d^2) # #first_part = tf.mul(label, tf.square(d)) # (Y-1)*(d^2) # between_class = tf.exp(tf.multiply(one-label, tf.square(d))) # (1-Y)*(d^2) # max_part = tf.square(tf.maximum(margin-d, 0)) # # within_class = tf.multiply(label, max_part) # (Y) * max((margin - d)^2, 0) # #second_part = tf.mul(one-label, max_part) # (Y) * max((margin - d)^2, 0) # # loss = 0.5 * tf.reduce_mean(within_class + between_class) # return loss, tf.reduce_mean(within_class), tf.reduce_mean(between_class) return lossdef compute_contrastive_loss_andre(left_feature, right_feature, label, margin, is_target_set_train=True): \"\"\" Compute the contrastive loss as in https://gitlab.idiap.ch/biometric/xfacereclib.cnn/blob/master/xfacereclib/cnn/scripts/experiment.py#L156 With Y = [-1 +1] --&gt; [POSITIVE_PAIR NEGATIVE_PAIR] L = log( m + exp( Y * d^2)) / N **Parameters** left_feature: First element of the pair right_feature: Second element of the pair label: Label of the pair (0 or 1) margin: Contrastive margin **Returns** Return the loss operation \"\"\" with tf.name_scope(\"contrastive_loss_andre\"): label = tf.to_float(label) d = compute_euclidean_distance(left_feature, right_feature) loss = tf.log(tf.exp(tf.multiply(label, d))) loss = tf.reduce_mean(loss) # Within class part genuine_factor = tf.multiply(label-1, 0.5) within_class = tf.reduce_mean(tf.log(tf.exp(tf.multiply(genuine_factor, d)))) # Between class part impostor_factor = tf.multiply(label + 1, 0.5) between_class = tf.reduce_mean(tf.log(tf.exp(tf.multiply(impostor_factor, d)))) # first_part = tf.mul(one - label, tf.square(d)) # (Y-1)*(d^2) return loss, between_class, within_classdef main(): BATCH_SIZE = 128 BATCH_SIZE_TEST = 128 #BATCH_SIZE_TEST = 300 ITERATIONS = 10000 VALIDATION_TEST = 100 perc_train = 0.9 CONTRASTIVE_MARGIN = 1 USE_GPU = True ANDRE_LOSS = False LOG_NAME = 'logs' train_data, train_labels, test_data, test_labels = util.load_mnist() data = np.concatenate((train_data, test_data), axis=0) label = np.concatenate((train_labels, test_labels), axis=0) data_shuffler = DataShuffler(train_data, train_labels, scale=True) # Creating the variables lenet_architecture = Lenet(seed=SEED, use_gpu=USE_GPU) # Siamease place holders - Training train_left_data = tf.placeholder(tf.float32, shape=(BATCH_SIZE*2, 28, 28, 1), name=\"left\") train_right_data = tf.placeholder(tf.float32, shape=(BATCH_SIZE*2, 28, 28, 1), name=\"right\") labels_data = tf.placeholder(tf.int32, shape=BATCH_SIZE*2) # Creating the graphs for training lenet_train_left = lenet_architecture.create_lenet(train_left_data) lenet_train_right = lenet_architecture.create_lenet(train_right_data) # Siamease place holders - Validation validation_data = tf.placeholder(tf.float32, shape=(data_shuffler.validation_data.shape[0], 28, 28, 1), name=\"validation\") labels_data_validation = tf.placeholder(tf.int32, shape=BATCH_SIZE_TEST) # Creating the graphs for validation lenet_validation = lenet_architecture.create_lenet(validation_data, train=False) if ANDRE_LOSS: loss, between_class, within_class = compute_contrastive_loss_andre(lenet_train_left, lenet_train_right, labels_data, CONTRASTIVE_MARGIN) else: # Regular contrastive loss loss = compute_contrastive_loss(lenet_train_left, lenet_train_right, labels_data, CONTRASTIVE_MARGIN) distances = compute_euclidean_distance(lenet_train_left, lenet_train_right) #regularizer = (tf.nn.l2_loss(lenet_architecture.W_fc1) + tf.nn.l2_loss(lenet_architecture.b_fc1) + # tf.nn.l2_loss(lenet_architecture.W_fc2) + tf.nn.l2_loss(lenet_architecture.b_fc2)) #loss += 5e-4 * regularizer # Defining training parameters batch = tf.Variable(0) learning_rate = tf.train.exponential_decay( 0.01, # Learning rate batch * BATCH_SIZE, data_shuffler.train_data.shape[0], 0.95 # Decay step ) #optimizer = tf.train.GradientDescentOptimizer(learning_rate).minimize(loss, global_step=batch) optimizer = tf.train.AdamOptimizer(0.01, name='Adam').minimize(loss, global_step=batch) # pp = PdfPages(\"groups.pdf\") # Training with tf.Session() as session: #Trying to write things on tensor board train_writer = tf.summary.FileWriter(LOG_NAME + '/train', session.graph) test_writer = tf.summary.FileWriter(LOG_NAME + '/test', session.graph) tf.summary.scalar('loss', loss) # tf.summary.scalar('between_class', between_class) # tf.summary.scalar('within_class', within_class) tf.summary.scalar('lr', learning_rate) merged = tf.summary.merge_all() init = tf.global_variables_initializer() session.run(init) for step in range(ITERATIONS+1): batch_left, batch_right, labels = data_shuffler.get_pair(BATCH_SIZE, zero_one_labels=not ANDRE_LOSS) feed_dict = &#123;train_left_data: batch_left, train_right_data: batch_right, labels_data: labels&#125; _, l, lr, summary = session.run([optimizer, loss, learning_rate, merged], feed_dict=feed_dict) train_writer.add_summary(summary, step) print(\"Step &#123;0&#125;. Loss Validation = &#123;1&#125;\". format(step, l)) if step % VALIDATION_TEST == 0: # Siamese validation batch_left, batch_right, labels = data_shuffler.get_pair(n_pair=BATCH_SIZE_TEST, is_target_set_train=False, zero_one_labels=not ANDRE_LOSS) feed_dict = &#123;train_left_data: batch_left, train_right_data: batch_right, labels_data: labels&#125; d, lv, summary = session.run([distances, loss, merged], feed_dict=feed_dict) test_writer.add_summary(summary, step) ################################### # Siamese as a feature extractor ################################### batch_train_data, batch_train_labels = data_shuffler.get_batch( data_shuffler.validation_data.shape[0], train_dataset=True) features_train = session.run(lenet_validation, feed_dict=&#123;validation_data: batch_train_data[:]&#125;) batch_validation_data, batch_validation_labels = data_shuffler.get_batch( data_shuffler.validation_data.shape[0], train_dataset=False) features_validation = session.run(lenet_validation, feed_dict=&#123;validation_data: batch_validation_data[:]&#125;) acc = util.compute_accuracy(features_train, batch_train_labels, features_validation, batch_validation_labels, 10) print(\"Step &#123;0&#125;. Loss Validation = &#123;1&#125;, acc = &#123;2&#125;\". format(step, lv, acc)) # fig = util.plot_embedding_lda(features_validation, batch_validation_labels) # pp.savefig(fig) #if ANDRE_LOSS: # positive_scores = d[numpy.where(labels == -1)[0]].astype(\"float\") # negative_scores = d[numpy.where(labels == 1)[0]].astype(\"float\") #else: # positive_scores = d[numpy.where(labels == 1)[0]].astype(\"float\") # negative_scores = d[numpy.where(labels == 0)[0]].astype(\"float\") #threshold = bob.measure.eer_threshold(negative_scores, positive_scores) #far, frr = bob.measure.farfrr(negative_scores, positive_scores, threshold) #eer = ((far + frr) / 2.) * 100. print(\"End !!\") train_writer.close() test_writer.close() # pp.close()if __name__ == '__main__': main() lenet.py 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121#!/usr/bin/env python# vim: set fileencoding=utf-8 :# @author: Tiago de Freitas Pereira &lt;tiago.pereira@idiap.ch&gt;# @date: Wed 11 May 2016 09:39:36 CEST &quot;&quot;&quot;Class that creates the lenet architecture&quot;&quot;&quot;from siameasenetwork.mnist.util import *class Lenet(object): def __init__(self, conv1_kernel_size=5, conv1_output=16, conv2_kernel_size=5, conv2_output=32, fc1_output=400, n_classes=10, seed=10, use_gpu = False): &quot;&quot;&quot; Create all the necessary variables for this CNN **Parameters** conv1_kernel_size=5, conv1_output=32, conv2_kernel_size=5, conv2_output=64, fc1_output=400, n_classes=10 seed = 10 &quot;&quot;&quot; # First convolutional self.W_conv1 = create_weight_variables([conv1_kernel_size, conv1_kernel_size, 1, conv1_output], seed=seed, name=&quot;W_conv1&quot;, use_gpu=use_gpu) self.b_conv1 = create_bias_variables([conv1_output], name=&quot;bias_conv1&quot;, use_gpu=use_gpu) # Second convolutional self.W_conv2 = create_weight_variables([conv2_kernel_size, conv2_kernel_size, conv1_output, conv2_output], seed=seed, name=&quot;W_conv2&quot;, use_gpu=use_gpu) self.b_conv2 = create_bias_variables([conv2_output], name=&quot;bias_conv2&quot;, use_gpu=use_gpu) # First fc self.W_fc1 = create_weight_variables([(28 // 4) * (28 // 4) * conv2_output, fc1_output], seed=seed, name=&quot;W_fc1&quot;, use_gpu=use_gpu) self.b_fc1 = create_bias_variables([fc1_output], name=&quot;bias_fc1&quot;, use_gpu=use_gpu) # Second FC fc self.W_fc2 = create_weight_variables([fc1_output, n_classes], seed=seed, name=&quot;W_fc2&quot;, use_gpu=use_gpu) self.b_fc2 = create_bias_variables([n_classes], name=&quot;bias_fc2&quot;, use_gpu=use_gpu) self.seed = seed def create_lenet(self, data, train=True): &quot;&quot;&quot; Create the Lenet Architecture **Parameters** data: Input data train: **Returns features_back: Features for backpropagation features_val: Features for validation &quot;&quot;&quot; # Creating the architecture # First convolutional with tf.name_scope(&apos;conv_1&apos;) as scope: conv1 = create_conv2d(data, self.W_conv1) # relu1 = create_relu(conv1, self.b_conv1) # relu1 = create_sigmoid(conv1, self.b_conv1) with tf.name_scope(&apos;tanh_1&apos;) as scope: tanh_1 = create_tanh(conv1, self.b_conv1) # Pooling # pool1 = create_max_pool(relu1) # pool1 = create_max_pool(relu1) with tf.name_scope(&apos;pool_1&apos;) as scope: pool1 = create_max_pool(tanh_1) # Second convolutional with tf.name_scope(&apos;conv_2&apos;) as scope: conv2 = create_conv2d(pool1, self.W_conv2) # relu2 = create_relu(conv2, self.b_conv2) # relu2 = create_sigmoid(conv2, self.b_conv2) with tf.name_scope(&apos;tanh_2&apos;) as scope: # pool2 = create_max_pool(relu2) #tanh_2 = create_relu(conv2, self.b_conv2) # pool2 = create_max_pool(conv2) tanh_2 = create_tanh(conv2, self.b_conv2) # Pooling with tf.name_scope(&apos;pool_2&apos;) as scope: pool2 = create_max_pool(tanh_2) #if train: #pool2 = tf.nn.dropout(pool2, 0.5, seed=self.seed) # Reshaping all the convolved images to 2D to feed the FC layers # FC1 with tf.name_scope(&apos;fc_1&apos;) as scope: pool_shape = pool2.get_shape().as_list() reshape = tf.reshape(pool2, [pool_shape[0], pool_shape[1] * pool_shape[2] * pool_shape[3]]) #fc1 = tf.nn.relu(tf.matmul(reshape, self.W_fc1) + self.b_fc1) fc1 = tf.nn.tanh(tf.matmul(reshape, self.W_fc1) + self.b_fc1) #if train: #fc1 = tf.nn.dropout(fc1, 0.5, seed=self.seed) # FC2 with tf.name_scope(&apos;fc_2&apos;) as scope: fc2 = tf.matmul(fc1, self.W_fc2) + self.b_fc2 #fc2 = tf.nn.softmax(tf.matmul(fc1, self.W_fc2) + self.b_fc2) return fc2 util.py 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293#!/usr/bin/env python# vim: set fileencoding=utf-8 :# @author: Tiago de Freitas Pereira &lt;tiago.pereira@idiap.ch&gt;# @date: Wed 11 May 2016 09:39:36 CEST import numpyimport tensorflow as tfnumpy.random.seed(10)from tensorflow.examples.tutorials.mnist import input_datadef create_weight_variables(shape, seed, name, use_gpu=False): &quot;&quot;&quot; Create gaussian random neurons with mean 0 and std 0.1 **Paramters** shape: Shape of the layer &quot;&quot;&quot; #import ipdb; ipdb.set_trace() if len(shape) == 4: in_out = shape[0] * shape[1] * shape[2] + shape[3] else: in_out = shape[0] + shape[1] import math stddev = math.sqrt(3.0 / in_out) # XAVIER INITIALIZER (GAUSSIAN) initializer = tf.truncated_normal(shape, stddev=stddev, seed=seed) if use_gpu: with tf.device(&quot;/gpu&quot;): return tf.get_variable(name, initializer=initializer, dtype=tf.float32) else: with tf.device(&quot;/cpu&quot;): return tf.get_variable(name, initializer=initializer, dtype=tf.float32)def create_bias_variables(shape, name, use_gpu=False): &quot;&quot;&quot; Create the bias term &quot;&quot;&quot; initializer = tf.constant(0.1, shape=shape) if use_gpu: with tf.device(&quot;/gpu&quot;): return tf.get_variable(name, initializer=initializer, dtype=tf.float32) else: with tf.device(&quot;/cpu&quot;): return tf.get_variable(name, initializer=initializer, dtype=tf.float32) def create_conv2d(x, W): &quot;&quot;&quot; Create a convolutional kernel with 1 pixel of stride **Parameters** x: input layer W: Neurons &quot;&quot;&quot; return tf.nn.conv2d(x, W, strides=[1, 1, 1, 1], padding=&apos;SAME&apos;)def create_max_pool(x): &quot;&quot;&quot; Create max pooling using a patch of 2x2 **Parameters** x: input layer &quot;&quot;&quot; return tf.nn.max_pool(x, ksize=[1, 2, 2, 1], strides=[1, 2, 2, 1], padding=&apos;SAME&apos;)def create_tanh(x, bias): &quot;&quot;&quot; Create the Tanh activations **Parameters** x: input layer bias: bias term &quot;&quot;&quot; return tf.nn.tanh(tf.nn.bias_add(x, bias))def create_relu(x, bias): &quot;&quot;&quot; Create the ReLU activations **Parameters** x: input layer bias: bias term &quot;&quot;&quot; return tf.nn.relu(tf.nn.bias_add(x, bias))def create_sigmoid(x, bias): &quot;&quot;&quot; Create the Sigmoid activations **Parameters** x: input layer bias: bias term &quot;&quot;&quot; return tf.nn.sigmoid(tf.nn.bias_add(x, bias))def scale_mean_norm(data, scale=0.00390625): mean = numpy.mean(data) data = (data - mean) * scale return datadef evaluate_softmax(data, labels, session, network, data_node): &quot;&quot;&quot; Evaluate the network assuming that the output layer is a softmax &quot;&quot;&quot; predictions = numpy.argmax(session.run( network, feed_dict=&#123;data_node: data[:]&#125;), 1) return 100. * numpy.sum(predictions == labels) / predictions.shape[0]def load_mnist(): mnist_data = input_data.read_data_sets(&quot;MNIST_data/&quot;, one_hot=True) train_data = mnist_data.train.images test_data = mnist_data.test.images train_labels = mnist_data.train.labels test_labels = mnist_data.test.labels return train_data, train_labels, test_data, test_labelsdef plot_embedding_pca(features, labels): &quot;&quot;&quot; Trains a PCA using bob, reducing the features to dimension 2 and plot it the possible clusters :param features: :param labels: :return: &quot;&quot;&quot; import bob.learn.linear import matplotlib.pyplot as mpl colors = [&apos;#FF0000&apos;, &apos;#FFFF00&apos;, &apos;#FF00FF&apos;, &apos;#00FFFF&apos;, &apos;#000000&apos;, &apos;#AA0000&apos;, &apos;#AAAA00&apos;, &apos;#AA00AA&apos;, &apos;#00AAAA&apos;, &apos;#330000&apos;] # Training PCA trainer = bob.learn.linear.PCATrainer() machine, lamb = trainer.train(features.astype(&quot;float64&quot;)) # Getting the first two most relevant features projected_features = machine(features.astype(&quot;float64&quot;))[:, 0:2] # Plotting the classes n_classes = max(labels)+1 fig = mpl.figure() for i in range(n_classes): indexes = numpy.where(labels == i)[0] selected_features = projected_features[indexes,:] mpl.scatter(selected_features[:, 0], selected_features[:, 1], marker=&apos;.&apos;, c=colors[i], linewidths=0, label=str(i)) mpl.legend() return figdef plot_embedding_lda(features, labels): &quot;&quot;&quot; Trains a LDA using bob, reducing the features to dimension 2 and plot it the possible clusters :param features: :param labels: :return: &quot;&quot;&quot; import bob.learn.linear import matplotlib.pyplot as mpl colors = [&apos;#FF0000&apos;, &apos;#FFFF00&apos;, &apos;#FF00FF&apos;, &apos;#00FFFF&apos;, &apos;#000000&apos;, &apos;#AA0000&apos;, &apos;#AAAA00&apos;, &apos;#AA00AA&apos;, &apos;#00AAAA&apos;, &apos;#330000&apos;] n_classes = max(labels)+1 # Training PCA trainer = bob.learn.linear.FisherLDATrainer(use_pinv=True) lda_features = [] for i in range(n_classes): indexes = numpy.where(labels == i)[0] lda_features.append(features[indexes, :].astype(&quot;float64&quot;)) machine, lamb = trainer.train(lda_features) #import ipdb; ipdb.set_trace(); # Getting the first two most relevant features projected_features = machine(features.astype(&quot;float64&quot;))[:, 0:2] # Plotting the classes fig = mpl.figure() for i in range(n_classes): indexes = numpy.where(labels == i)[0] selected_features = projected_features[indexes,:] mpl.scatter(selected_features[:, 0], selected_features[:, 1], marker=&apos;.&apos;, c=colors[i], linewidths=0, label=str(i)) mpl.legend() return figdef compute_eer(data_train, labels_train, data_validation, labels_validation, n_classes): from scipy.spatial.distance import cosine # Creating client models models = [] for i in range(n_classes): labels_num = numpy.argmax(labels_train, axis=1) indexes = numpy.where(labels_num == i) models.append(numpy.mean(data_train[indexes, :], axis=0)) # Probing positive_scores = numpy.zeros(shape=0) negative_scores = numpy.zeros(shape=0) for i in range(n_classes): # Positive scoring val_num = numpy.argmax(labels_validation) indexes = numpy.where(val_num == i) positive_data = data_validation[indexes, :] p = [cosine(models[i], positive_data[j]) for j in range(positive_data.shape[0])] positive_scores = numpy.hstack((positive_scores, p)) # negative scoring indexes = numpy.where(val_num != i) negative_data = data_validation[indexes, :] n = [cosine(models[i], negative_data[j]) for j in range(negative_data.shape[0])] negative_scores = numpy.hstack((negative_scores, n)) # Computing performance based on EER negative_scores = (-1) * negative_scores positive_scores = (-1) * positive_scores # threshold = bob.measure.eer_threshold(negative_scores, positive_scores) # far, frr = bob.measure.farfrr(negative_scores, positive_scores, threshold) # eer = (far + frr) / 2. return negative_scores, positive_scoresdef compute_accuracy(data_train, labels_train, data_validation, labels_validation, n_classes): from scipy.spatial.distance import cosine # Creating client models models = [] for i in range(n_classes): index = numpy.argmax(labels_train, axis=1) indexes = numpy.where(index == i)[0] data_t = [data_train[i] for i in indexes] models.append(numpy.mean(data_t, axis=0)) # Probing tp = 0 for i in range(data_validation.shape[0]): d = data_validation[i,:] l = labels_validation[i] scores = [cosine(m, d) for m in models] predict = numpy.argmin(scores) ll = numpy.argmax(l, axis=0) if predict == ll: tp += 1 return (float(tp) / data_validation.shape[0]) * 100def compute_acc(data_val, labels_val): tp = 0 data_size = data_val.shape[0] for i in range(data_size): index = numpy.argmax(data_val[i]) if index == numpy.argmax(labels_val[i]): tp += 1 return (float(tp) / data_size) DataShuffler.py 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192#!/usr/bin/env python# vim: set fileencoding=utf-8 :# @author: Tiago de Freitas Pereira &lt;tiago.pereira@idiap.ch&gt;# @date: Wed 11 May 2016 09:39:36 CEST import numpydef scale_mean_norm(data, scale=0.00390625): mean = numpy.mean(data) data = (data - mean) * scale return data, mean&quot;&quot;&quot;Data&quot;&quot;&quot;class DataShuffler(object): def __init__(self, data, labels, perc_train=0.9, scale=True): &quot;&quot;&quot; Some base functions for neural networks **Parameters** data: &quot;&quot;&quot; scale_value = 0.00390625 total_samples = data.shape[0] #æ€»å…±çš„æ ·æœ¬æ•°é‡ indexes = numpy.array(range(total_samples)) numpy.random.shuffle(indexes) # Spliting train and validation train_samples = int(round(total_samples * perc_train)) #è®­ç»ƒæ ·æœ¬æ•°ç›® validation_samples = total_samples - train_samples #éªŒè¯é›†æ ·æœ¬æ•°ç›® data = numpy.reshape(data, (data.shape[0], 28, 28, 1)) #æ‰€æœ‰è¾“å…¥æ ·æœ¬ self.train_data = data[indexes[0:train_samples], :, :, :] # è®­ç»ƒæ ·æœ¬ self.train_labels = labels[indexes[0:train_samples]] # è®­ç»ƒlabels self.validation_data = data[indexes[train_samples:train_samples + validation_samples], :, :, :] self.validation_labels = labels[indexes[train_samples:train_samples + validation_samples]] self.total_labels = 10 if scale: # data = scale_minmax_norm(data,lower_bound = -1, upper_bound = 1) self.train_data, self.mean = scale_mean_norm(self.train_data) self.validation_data = (self.validation_data - self.mean) * scale_value def get_batch(self, n_samples, train_dataset=True): if train_dataset: data = self.train_data label = self.train_labels else: data = self.validation_data label = self.validation_labels # Shuffling samples indexes = numpy.array(range(data.shape[0])) numpy.random.shuffle(indexes) selected_data = data[indexes[0:n_samples], :, :, :] selected_labels = label[indexes[0:n_samples]] return selected_data.astype(&quot;float32&quot;), selected_labels def get_pair(self, n_pair=1, is_target_set_train=True, zero_one_labels=True): &quot;&quot;&quot; Get a random pair of samples **Parameters** is_target_set_train: Defining the target set to get the batch **Return** &quot;&quot;&quot; def get_genuine_or_not(input_data, input_labels, genuine=True): if genuine: # TODO: THIS KEY SELECTION NEEDS TO BE MORE EFFICIENT # Getting a client index = numpy.random.randint(self.total_labels) # Getting the indexes of the data from a particular client arg_max = numpy.argmax(input_labels, axis=1) indexes = numpy.where(arg_max == index)[0] numpy.random.shuffle(indexes) # Picking a pair data = input_data[indexes[0], :, :, :] data_p = input_data[indexes[1], :, :, :] else: # Picking a pair from different clients index = numpy.random.choice(self.total_labels, 2, replace=False) # Getting the indexes of the two clients arg_max = numpy.argmax(input_labels, axis=1) indexes = numpy.where(arg_max == index[0])[0] indexes_p = numpy.where(arg_max == index[1])[0] numpy.random.shuffle(indexes) numpy.random.shuffle(indexes_p) # Picking a pair data = input_data[indexes[0], :, :, :] data_p = input_data[indexes_p[0], :, :, :] return data, data_p if is_target_set_train: target_data = self.train_data target_labels = self.train_labels else: target_data = self.validation_data target_labels = self.validation_labels total_data = n_pair * 2 c = target_data.shape[3] w = target_data.shape[1] h = target_data.shape[2] data = numpy.zeros(shape=(total_data, w, h, c), dtype=&apos;float32&apos;) data_p = numpy.zeros(shape=(total_data, w, h, c), dtype=&apos;float32&apos;) labels_siamese = numpy.zeros(shape=total_data, dtype=&apos;float32&apos;) genuine = True for i in range(total_data): data[i, :, :, :], data_p[i, :, :, :] = get_genuine_or_not(target_data, target_labels, genuine=genuine) if zero_one_labels: labels_siamese[i] = not genuine else: labels_siamese[i] = -1 if genuine else +1 genuine = not genuine return data, data_p, labels_siamese def get_triplet(self, n_labels, n_triplets=1, is_target_set_train=True): &quot;&quot;&quot; Get a triplet **Parameters** is_target_set_train: Defining the target set to get the batch **Return** &quot;&quot;&quot; def get_one_triplet(input_data, input_labels): # Getting a pair of clients index = numpy.random.choice(n_labels, 2, replace=False) label_positive = index[0] label_negative = index[1] # Getting the indexes of the data from a particular client indexes = numpy.where(input_labels == index[0])[0] numpy.random.shuffle(indexes) # Picking a positive pair data_anchor = input_data[indexes[0], :, :, :] data_positive = input_data[indexes[1], :, :, :] # Picking a negative sample indexes = numpy.where(input_labels == index[1])[0] numpy.random.shuffle(indexes) data_negative = input_data[indexes[0], :, :, :] return data_anchor, data_positive, data_negative, label_positive, label_positive, label_negative if is_target_set_train: target_data = self.train_data target_labels = self.train_labels else: target_data = self.validation_data target_labels = self.validation_labels c = target_data.shape[3] w = target_data.shape[1] h = target_data.shape[2] data_a = numpy.zeros(shape=(n_triplets, w, h, c), dtype=&apos;float32&apos;) data_p = numpy.zeros(shape=(n_triplets, w, h, c), dtype=&apos;float32&apos;) data_n = numpy.zeros(shape=(n_triplets, w, h, c), dtype=&apos;float32&apos;) labels_a = numpy.zeros(shape=n_triplets, dtype=&apos;float32&apos;) labels_p = numpy.zeros(shape=n_triplets, dtype=&apos;float32&apos;) labels_n = numpy.zeros(shape=n_triplets, dtype=&apos;float32&apos;) for i in range(n_triplets): data_a[i, :, :, :], data_p[i, :, :, :], data_n[i, :, :, :], \\ labels_a[i], labels_p[i], labels_n[i] = \\ get_one_triplet(target_data, target_labels) return data_a, data_p, data_n, labels_a, labels_p, labels_n","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆå…­ï¼‰","slug":"2018-05-21/guide-to-asyncio-6","date":"2018-05-27T10:39:08.000Z","updated":"2018-08-07T08:56:41.653Z","comments":true,"path":"posts/74232ae7/","link":"","permalink":"http://weafteam.github.io/posts/74232ae7/","excerpt":"","text":"å‰è¨€ å‰äº”ç¯‡æ–‡ç« ä»‹ç»äº† asyncio çš„ APIï¼Œä»è¿™ç¯‡å¼€å§‹ï¼Œå°±è¦è®²ä¸€äº› Real Worldï¼ˆå¹¶ä¸ï¼‰çš„ä¸œè¥¿äº†ã€‚ ä½¿ç”¨ aiohttp ä½œä¸º HTTP å®¢æˆ·ç«¯ aiohttp æ˜¯ä¸€ä¸ªåŸºäº asyncio çš„å¼‚æ­¥ HTTP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åº“ï¼Œä¹Ÿæ˜¯ asyncio ç”Ÿæ€ä¸­å‘å±•æœ€è¿…é€Ÿçš„ç¬¬ä¸‰æ–¹åº“ä¹‹ä¸€ã€‚åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ aiohttp ä½œä¸º HTTP å®¢æˆ·ç«¯æ¥æ¯”è¾ƒä¸€ä¸‹åŒæ­¥ã€åŸºäºçº¿ç¨‹çš„å¼‚æ­¥å’ŒåŸºäº asyncio çš„å¼‚æ­¥çš„å·®åˆ«ã€‚ å‡†å¤‡å·¥ä½œ é¦–å…ˆæˆ‘ä»¬å®‰è£…å¥½æ‰€éœ€çš„ç¬¬ä¸‰æ–¹åº“ï¼š 12pip install requestspip install aiohttp å‡†å¤‡ä¸€äº›ç”¨äºå¹¶å‘è¯·æ±‚çš„ urlï¼Œå…± 45 ä¸ªï¼š 12345678910111213141516171819202122# url.pyurls = [ 'http://caipiao.hao123.com/', 'http://game.hao123.com/', 'http://mail.10086.cn/', 'http://mail.126.com/', 'http://mail.163.com/', 'http://mail.aliyun.com/', 'http://mail.qq.com/', 'http://mail.sina.com.cn/', 'http://music.163.com/', 'http://tuijian.hao123.com/', 'http://www.12306.cn/', 'http://www.163.com/', 'http://www.37.com/', 'http://www.4399.com/', 'http://www.abchina.com/', 'http://www.baidu.com/', 'http://www.bankcomm.com/', 'http://www.boc.cn/', 'http://www.ccb.com/', 'http://www.chsi.com.cn/', 'http://www.cmbchina.com/', 'http://www.cnki.net/', 'http://www.eastmoney.com/', 'http://www.fang.com/', 'http://www.icbc.com.cn/icbc/', 'http://www.ifeng.com', 'http://www.iqiyi.com/', 'http://www.psbc.com/', 'http://www.qq.com/', 'http://www.sina.com.cn/', 'http://www.sohu.com/', 'http://www.tianya.cn/', 'http://www.zhihu.com/', 'http://wyyx.hao123.com/', 'https://mail.qq.com/', 'https://mail.sohu.com/', 'https://tieba.baidu.com/', 'https://weibo.com/', 'https://www.autohome.com.cn/', 'https://www.bilibili.com/', 'https://www.booking.com/', 'https://www.douyu.com/', 'https://www.qunar.com/', 'https://www.suning.com/', 'https://www.taobao.com/'] åŒæ­¥çš„è¯·æ±‚ é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„åº“ï¼š 123import timeimport requestsfrom url import urls å®Œæˆè¯·æ±‚å•ä¸ª url çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä»¥ bytes å½¢å¼è¿”å›ç½‘ç«™å†…å®¹ï¼š 123def fetch(session, url): resp = session.get(url) return resp.content åŒæ­¥è¯·æ±‚æ‰€æœ‰çš„ urlï¼Œæ‰“å°å‡ºå­—èŠ‚çš„é•¿åº¦ï¼š 12345def main(): session = requests.Session() for url in urls: data = fetch(session, url) print(f'&#123;url&#125;: &#123;len(data)&#125;') è®°å½•å®Œæˆè¯·æ±‚æ‰€éœ€çš„æ—¶é—´ï¼š 1234if __name__ == '__main__': start = time.time() main() print(time.time() - start) ä¸Šè¿°ä»£ç çš„ç»“æœï¼š 123456789101112131415161718http://caipiao.hao123.com/: 109299http://game.hao123.com/: 179707http://mail.10086.cn/: 52500http://mail.126.com/: 13063http://mail.163.com/: 137118http://mail.aliyun.com/: 725http://mail.qq.com/: 8206http://mail.sina.com.cn/: 2837http://music.163.com/: 92606...https://www.autohome.com.cn/: 656200https://www.bilibili.com/: 26642https://www.booking.com/: 457842https://www.douyu.com/: 75286https://www.qunar.com/: 140898https://www.suning.com/: 188523https://www.taobao.com/: 12628324.28531312942505 å¯ä»¥çœ‹å‡ºæ‰“å°çš„é¡ºåºæ˜¯å’Œ url åˆ—è¡¨çš„é¡ºåºå®Œå…¨ä¸€è‡´çš„ï¼ŒåŒæ­¥çš„ä»£ç è€—æ—¶çº¦ 24sã€‚ åŸºäºçº¿ç¨‹çš„è¯·æ±‚ é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„åº“ï¼š 1234import timefrom concurrent.futures import ThreadPoolExecutor, as_completedimport requestsfrom url import urls å®Œæˆå•ä¸ªè¯·æ±‚çš„å‡½æ•°ï¼š 123def fetch(session, url): resp = session.get(url) return resp.content ä½¿ç”¨çº¿ç¨‹æ± è¯·æ±‚æ‰€æœ‰çš„ urlï¼š 1234567def main(): session = requests.Session() with ThreadPoolExecutor() as executor: tasks = &#123;executor.submit(fetch, session, url): url for url in urls&#125; for task in as_completed(tasks.keys()): data = task.result() print(f'&#123;tasks[task]&#125;: &#123;len(data)&#125;') è®°å½•å®Œæˆæ‰€éœ€çš„æ—¶é—´ï¼š 1234if __name__ == '__main__': start = time.time() main() print(time.time() - start) ä¸Šè¿°ä»£ç çš„ç»“æœï¼š 123456789101112131415161718http://www.ccb.com/: 276http://www.12306.cn/: 1480http://www.cnki.net/: 59235http://mail.aliyun.com/: 725http://www.tianya.cn/: 7867http://www.icbc.com.cn/icbc/: 157227http://www.bankcomm.com/: 3473http://www.chsi.com.cn/: 34188http://mail.sina.com.cn/: 2837...http://www.sina.com.cn/: 584540https://tieba.baidu.com/: 137714https://www.autohome.com.cn/: 656154https://www.taobao.com/: 126283https://www.booking.com/: 457849http://www.iqiyi.com/: 599940http://tuijian.hao123.com/: 5114659.722297191619873 å¯ä»¥çœ‹åˆ°è¿”å›ç»“æœçš„é¡ºåºå¹¶ä¸å’Œ url åˆ—è¡¨ä¸€è‡´ï¼Œå‡†ç¡®çš„è¯´ï¼Œæ˜¯æŒ‰ç…§è¯·æ±‚å®Œæˆçš„é¡ºåºæ’åˆ—çš„ã€‚åŒæ—¶ï¼Œè¯·æ±‚æ‰€éœ€çš„æ—¶é—´å¤§å¹…ç¼©çŸ­ï¼Œé™åˆ°äº†çº¦ 9sã€‚ åŸºäº asyncio çš„è¯·æ±‚ é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„åº“ï¼š 1234import asyncioimport timeimport aiohttpfrom url import urls å®Œæˆå•ä¸ªè¯·æ±‚çš„å‡½æ•°ï¼š 123async def fetch(session, url): async with session.get(url) as resp: return url, await resp.read() è¿™é‡ŒåŒæ—¶è¿”å›äº†è¯·æ±‚çš„ url å’Œç½‘ç«™å†…å®¹ï¼Œæ˜¯å› ä¸ºåé¢çš„ä»£ç ä¸å®¹æ˜“åœ¨è¯·æ±‚å®Œæˆåè·å¾—è¯·æ±‚çš„ urlã€‚ ä½¿ç”¨ aiohttp è¯·æ±‚æ‰€æœ‰çš„ urlï¼š 123456async def main(): async with aiohttp.ClientSession() as session: tasks = [fetch(session, url) for url in urls] for task in asyncio.as_completed(tasks): url, data = await task print(f'&#123;url&#125;: &#123;len(data)&#125;') å¼€å¯äº‹ä»¶å¾ªç¯ï¼Œå¹¶è®°å½•æ‰€éœ€çš„æ—¶é—´ï¼š 12345if __name__ == '__main__': start = time.time() loop = asyncio.get_event_loop() loop.run_until_complete(main()) print(time.time() - start) ä¸Šè¿°ä»£ç çš„ç»“æœï¼š 1234567891011121314151617http://www.psbc.com/: 404http://www.eastmoney.com/: 392883http://www.icbc.com.cn/icbc/: 157227http://www.ifeng.com: 438464http://mail.aliyun.com/: 725http://www.tianya.cn/: 7867...http://tuijian.hao123.com/: 510052http://mail.qq.com/: 8023http://game.hao123.com/: 179707https://tieba.baidu.com/: 137723http://www.iqiyi.com/: 599830https://www.taobao.com/: 126283https://weibo.com/: 6117http://www.zhihu.com/: 22696https://www.booking.com/: 4578512.0516560077667236 å’Œä½¿ç”¨çº¿ç¨‹ä¸€æ ·ï¼Œè¿”å›ç»“æœæ˜¯æŒ‰ç…§è¯·æ±‚å®Œæˆé¡ºåºæ’åˆ—çš„ã€‚è¯·æ±‚çš„æ—¶é—´æ¯”çº¿ç¨‹æ›´çŸ­ï¼Œåªç”¨äº†çº¦ 2s å°±å®Œæˆäº†æ‰€æœ‰çš„è¯·æ±‚ã€‚å’Œä½¿ç”¨çº¿ç¨‹çš„æ–¹å¼ç›¸æ¯”ï¼Œasyncio é¿å…äº†åˆ›å»ºçº¿ç¨‹çš„å¼€é”€ã€‚ ä¿å­˜è¯·æ±‚çš„ç»“æœ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°è¯·æ±‚åªæ˜¯ç®€å•çš„è·å–äº†å†…å®¹ï¼Œè¿™äº› bytes åªåœ¨å†…å­˜ä¸­å­˜åœ¨ã€‚ä¸€æ—¦æˆ‘ä»¬éœ€è¦æŠŠç»“æœä¿å­˜åˆ°ç£ç›˜ï¼Œå°±ä¼šæœ‰å¦ä¸€ä¸ªä¼šå¯¼è‡´å¼‚æ­¥ä»£ç é€€åŒ–åˆ°åŒæ­¥çš„åœ°æ–¹ï¼šç£ç›˜ I / Oã€‚ ç°åœ¨æˆ‘ä»¬å¢åŠ ä¸€ä¸ªä¿å­˜è¯·æ±‚å†…å®¹åˆ°ç£ç›˜çš„å‡½æ•°ï¼š 12345from urllib.parse import quote_plusdef save_to_file(filename, data): with open(f'async_data/&#123;quote_plus(filename)&#125;.html', 'wb') as f: f.write(data) åŒæ—¶å¢åŠ ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥åŒæ—¶å‘èµ·è¯·æ±‚å¹¶æŠŠç»“æœä¿å­˜åˆ°æ–‡ä»¶ï¼š 1234async def fetch_and_save(session, url): url, data = await fetch(session, url) save_to_file(url, data * 500) # æŠŠæ–‡ä»¶å¤§å°æ‰©å¤§ 500 å€ï¼Œä½¿ç»“æœæ›´æ˜æ˜¾ return url åŒæ—¶æ›´æ–°ä¸€ä¸‹ main() å‡½æ•°ï¼š 123456async def main(): async with aiohttp.ClientSession() as session: tasks = [fetch_and_save(session, url) for url in urls] for task in asyncio.as_completed(tasks): url = await task print(f'save: &#123;url&#125;') ä¸Šè¿°ä»£ç çš„ç»“æœï¼š 123456789101112131415161718save: http://www.psbc.com/save: http://www.cnki.net/save: http://www.eastmoney.com/save: http://tuijian.hao123.com/save: http://caipiao.hao123.com/save: http://www.ifeng.comsave: http://www.fang.com/save: http://www.qq.com/...save: https://www.bilibili.com/save: https://www.autohome.com.cn/save: https://www.booking.com/save: https://mail.sohu.com/save: https://weibo.com/save: http://mail.qq.com/save: http://mail.10086.cn/save: http://www.zhihu.com/10.63579511642456 å¯ä»¥çœ‹åˆ°æ¶ˆè€—çš„æ—¶é—´å¢åŠ åˆ°äº†çº¦ 10sã€‚ æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å°†åŒæ­¥çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œå˜ä¸ºå¼‚æ­¥çš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ç»“åˆä½¿ç”¨çº¿ç¨‹å’Œ asyncioã€‚ä¿®æ”¹ä¸€ä¸‹ fetch_and_save() å‡½æ•°ï¼Œä½¿å…¶åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œä¿å­˜æ“ä½œï¼š 12345async def fetch_and_save(session, url): url, data = await fetch(session, url) loop = asyncio.get_event_loop() loop.run_in_executor(None, save_to_file, url, data * 500) # é»˜è®¤ä½¿ç”¨ ThreadPoolExecutor return url ä¿®æ”¹åçš„ç»“æœï¼š 12345678910111213141516171819save: http://www.psbc.com/save: http://www.12306.cn/save: http://www.ccb.com/save: http://www.cnki.net/save: http://www.sohu.com/save: http://www.37.com/save: http://www.icbc.com.cn/icbc/save: http://mail.sina.com.cn/save: http://www.ifeng.com...save: https://mail.qq.com/save: http://mail.163.com/save: https://mail.sohu.com/save: https://weibo.com/save: http://mail.qq.com/save: http://mail.10086.cn/save: http://www.zhihu.com/save: https://www.booking.com/4.817075967788696 æ•ˆæœå¾ˆæ˜æ˜¾ï¼Œæ‰€éœ€çš„æ—¶é—´ç¼©çŸ­åˆ°äº†çº¦ 5sã€‚ NOTEï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸Šå¹¶æœªæä¾›æ–‡ä»¶ç³»ç»Ÿçš„å¼‚æ­¥ I / O æ“ä½œï¼ˆLinux kernel æä¾›äº†æ–‡ä»¶ç³»ç»Ÿå¼‚æ­¥ I / Oï¼Œä¸è¿‡å®ƒéœ€è¦ä¸€ä¸ªé¢å¤–çš„åº“ aioï¼‰ï¼Œå¤§éƒ¨åˆ†çš„å¼‚æ­¥æ¡†æ¶éƒ½æ˜¯ä½¿ç”¨çº¿ç¨‹å¤„ç†æ–‡ä»¶ç³»ç»Ÿ I / O çš„ã€‚å¦‚æœéœ€è¦ç»Ÿä¸€çš„ APIï¼Œå¯ä»¥é€‰æ‹© aiofilesã€‚","categories":[],"tags":[]},{"title":"Lombokçš„ä½¿ç”¨","slug":"2018-05-28/Lombokä½¿ç”¨","date":"2018-05-26T18:04:44.000Z","updated":"2018-08-08T11:54:45.488Z","comments":true,"path":"posts/3859dc89/","link":"","permalink":"http://weafteam.github.io/posts/3859dc89/","excerpt":"","text":"ä¸€ã€ç®€ä»‹ ä½¿ç”¨lombokå‡å°‘ä»£ç å†—ä½™ï¼ˆReducing Boilerplate Code with Project Lombokï¼‰ã€‚â€œBoilerplateâ€æ˜¯ç”¨æ¥æè¿°è®¸å¤šéƒ¨åˆ†é‡å¤çš„ä»£ç çš„æœ¯è¯­ã€‚è¿™ä¹Ÿæ˜¯Javaè¯­è¨€æœ€å¸¸æå‡ºæ‰¹è¯„ä¹‹ä¸€,æ˜¯å¤§å¤šæ•°é¡¹ç›®ä¸­éƒ½å­˜åœ¨æ­¤ç±»ä»£ç è€Œä¸”æ•°é‡å¾ˆå¤šã€‚è¿™ä¸ªé—®é¢˜ç»å¸¸æ˜¯å„ç§åº“ä¸­è®¾è®¡å†³ç­–çš„ç»“æœï¼Œä½†æ˜¯ç”±äºè¯­è¨€æœ¬èº«çš„é™åˆ¶è€Œå¯¼è‡´çš„ã€‚Lombok æ—¨åœ¨é€šè¿‡ä¸€ç»„ç®€å•çš„æ³¨é‡Šå–ä»£è¿™äº›é—®é¢˜ã€‚ è™½ç„¶æ³¨é‡Šç”¨äºæŒ‡ç¤ºç”¨æ³•ï¼Œå®ç°ç»‘å®šç”šè‡³ç”Ÿæˆæ¡†æ¶ä½¿ç”¨çš„ä»£ç å¹¶ä¸ç½•è§ï¼Œä½†å®ƒä»¬é€šå¸¸ä¸ç”¨äºç”Ÿæˆåº”ç”¨ç¨‹åºç›´æ¥ä½¿ç”¨çš„ä»£ç ã€‚ éƒ¨åˆ†åŸå› æ˜¯è¿™æ ·åšéœ€è¦åœ¨å¼€å‘æ—¶æ€¥åˆ‡åœ°å¤„ç†æ³¨é‡Šã€‚ Lombokæ­£æ˜¯è¿™æ ·åšçš„ã€‚ é€šè¿‡é›†æˆåˆ°IDEä¸­ï¼ŒProject Lombokèƒ½å¤Ÿæ³¨å…¥å¼€å‘äººå‘˜å¯ç«‹å³ä½¿ç”¨çš„ä»£ç ã€‚ ä¾‹å¦‚ï¼Œç®€å•åœ°å°†@Dataæ³¨é‡Šæ·»åŠ åˆ°æ•°æ®ç±»ï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰ä¼šåœ¨IDEä¸­ç”Ÿæˆè®¸å¤šæ–°æ–¹æ³•ï¼š äºŒã€å®‰è£… ======= 1.eclipseå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å®‰è£… â€”â€”â€”â€”â€“ ### 1) ä¸‹è½½lombok.jaråŒ…https://projectlombok.org/download.html 2) è¿è¡ŒLombok.jar: Java -jar D:.jar D:.jarè¿™æ˜¯windowsä¸‹lombok.jaræ‰€åœ¨çš„ä½ç½® æ•°ç§’åå°†å¼¹å‡ºä¸€æ¡†ï¼Œä»¥ç¡®è®¤eclipseçš„å®‰è£…è·¯å¾„ 3) ç¡®è®¤å®Œeclipseçš„å®‰è£…è·¯å¾„åï¼Œç‚¹å‡»install/updateæŒ‰é’®ï¼Œå³å¯å®‰è£…å®Œæˆ 4) å®‰è£…å®Œæˆä¹‹åï¼Œè¯·ç¡®è®¤eclipseå®‰è£…è·¯å¾„ä¸‹æ˜¯å¦å¤šäº†ä¸€ä¸ªlombok.jaråŒ…ï¼Œå¹¶ä¸”å…¶ é…ç½®æ–‡ä»¶eclipse.iniä¸­æ˜¯å¦ æ·»åŠ äº†å¦‚ä¸‹å†…å®¹: -javaagent:lombok.jar -Xbootclasspath/a:lombok.jar å¦‚æœä¸Šé¢çš„ç­”æ¡ˆå‡ä¸ºtrueï¼Œé‚£ä¹ˆæ­å–œä½ å·²ç»å®‰è£…æˆåŠŸï¼Œå¦åˆ™å°†ç¼ºå°‘çš„éƒ¨åˆ†æ·»åŠ åˆ°ç›¸åº”çš„ä½ç½®å³å¯ 5) é‡å¯eclipseæˆ–myeclipse 2.IntelliJ IDEAå®‰è£… â€”â€”â€” ### 1ï¼‰æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰“å¼€è®¾ç½®Settingså®‰è£… ### 2ï¼‰å®‰è£…åé‡å¯ 3.æœ€åéœ€è¦åœ¨é¡¹ç›®ä¸­å¼•å…¥jaråŒ…æˆ–è€…ï¼Œä½¿ç”¨mavené…ç½®å¥½åæ ‡ã€‚ 12345678910111213&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;0.9.2&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt;&lt;repositories&gt; &lt;repository&gt; &lt;id&gt;projectlombok.org&lt;/id&gt; &lt;url&gt;http://projectlombok.org/mavenrepo&lt;/url&gt; &lt;/repository&gt;&lt;/repositories&gt; ä¸‰ã€Lombokçš„æ³¨è§£æœ‰å“ªäº› @Getter @Setter @Data @NonNull @ToString @EqualsAndHashCode @Cleanup @Synchronized @SneakyThrows @AllArgsConstructor @Builder @Generated @NoArgsConstructor @RequiredArgsConstructor @Singular @val @var @Value @FieldNameConstants @Log, @Log4j, @Log4j2, @Slf4j, @XSlf4j, @CommonsLog, @JBossLog, @Flogger @Delegate @Wither å››ã€Lombokæ³¨è§£çš„ä½¿ç”¨ 1 @Getter ç”Ÿæˆç›¸åº”çš„getæ–¹æ³•,å…¶ä¸­booleanç±»å‹ä¼šç”Ÿæˆ isFoo(); å¹¶ä¸”å¯ä»¥é…åˆAccessLevelä½¿ç”¨ 2 @Setter ç”Ÿæˆç›¸åº”çš„setæ–¹æ³•,å…¶ä¸­booleanç±»å‹ä¼šç”Ÿäº§ setFoo(); 3 @Data ç”Ÿæˆgetã€setã€toStringã€equalsã€hashCodeç­‰æ–¹æ³•ã€‚ 4 @NonNull å¯ä»¥å†æ–¹æ³•å¼•ç”¨ã€å’Œä¼ å‚æ—¶å¦‚æœå€¼ä¸ºnull,æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ 5 @ToString ç”ŸæˆtoStringæ–¹æ³• 6 @EqualsAndHashCode ç”Ÿæˆequalså’ŒhashCodeæ–¹æ³• 7 @Cleanup å‚è€ƒåœ°å€ï¼šhttp://jnb.ociweb.com/jnb/jnbJan2010.html","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"Springä¸­@transactionalçš„ä½¿ç”¨","slug":"2018-05-21/Springä¸­@transactionalçš„ä½¿ç”¨","date":"2018-05-20T18:04:44.000Z","updated":"2018-08-07T08:56:41.651Z","comments":true,"path":"posts/435ecce8/","link":"","permalink":"http://weafteam.github.io/posts/435ecce8/","excerpt":"","text":"ä¸€ã€ç®€ä»‹ æˆ‘ä»¬åœ¨å·¥ä½œä¸­å¤šå¤šå°‘å°‘ä¼šä½¿ç”¨åˆ°å’Œäº‹åŠ¡ç›¸å…³çš„ï¼Œä½†æ˜¯ç¨‹åºè¿è¡Œæ€»ä¸ä¼šä¸€å®šä¸å‡ºç°ä»»ä½•å¼‚å¸¸ã€‚ä¸€æ—¦æ•´ä¸ªæµç¨‹ä¸­å‡ºç°ä¸€ä¸ªå¼‚å¸¸ï¼Œä¹Ÿè®¸æˆ‘ä»¬å°±éœ€è¦æ•´ä¸ªæ“ä½œä¸ç»§ç»­è¿›è¡Œä¸‹å»ï¼Œå¹¶ä¸”éœ€è¦ä¹‹å‰åšè¿‡çš„æ“ä½œéƒ½ä¸èµ·ä½œç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨äº‹åŠ¡æ¥æ§åˆ¶ã€‚ åœ¨Springä¸­ï¼Œæˆ‘ä»¬é€šè¿‡@transactionalæ¥å¯ç”¨äº‹åŠ¡ã€‚ äºŒã€@transactionalè¯¦è§£ @Transactionalæ³¨è§£ä¸­å¸¸ç”¨å‚æ•°è¯´æ˜ å‚æ•°åç§° æè¿° rollbackFor è¯¥å±æ€§ç”¨äºè®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š@Transactional(rollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š@Transactional(rollbackFor={RuntimeException.class, Exception.class}) rollbackForClassName è¯¥å±æ€§ç”¨äºè®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š@Transactional(rollbackForClassName=â€œRuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š@Transactional(rollbackForClassName={â€œRuntimeExceptionâ€,â€œExceptionâ€}) noRollbackFor è¯¥å±æ€§ç”¨äºè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š@Transactional(noRollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š@Transactional(noRollbackFor={RuntimeException.class, Exception.class}) noRollbackForClassName è¯¥å±æ€§ç”¨äºè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š@Transactional(noRollbackForClassName=â€œRuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š@Transactional(noRollbackForClassName={â€œRuntimeExceptionâ€,â€œExceptionâ€}) propagation è¯¥å±æ€§ç”¨äºè®¾ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼Œå…·ä½“å–å€¼å¯å‚è€ƒè¡¨6-7ã€‚ä¾‹å¦‚ï¼š@Transactional(propagation=Propagation.NOT_SUPPORTED,readOnly=true) isolation è¯¥å±æ€§ç”¨äºè®¾ç½®åº•å±‚æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«ç”¨äºå¤„ç†å¤šäº‹åŠ¡å¹¶å‘çš„æƒ…å†µï¼Œé€šå¸¸ä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«å³å¯ï¼ŒåŸºæœ¬ä¸éœ€è¦è¿›è¡Œè®¾ç½® timeout è¯¥å±æ€§ç”¨äºè®¾ç½®äº‹åŠ¡çš„è¶…æ—¶ç§’æ•°ï¼Œé»˜è®¤å€¼ä¸º-1è¡¨ç¤ºæ°¸ä¸è¶…æ—¶ readOnly è¯¥å±æ€§ç”¨äºè®¾ç½®å½“å‰äº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡ï¼Œè®¾ç½®ä¸ºtrueè¡¨ç¤ºåªè¯»ï¼Œfalseåˆ™è¡¨ç¤ºå¯è¯»å†™ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚ä¾‹å¦‚ï¼š@Transactional(readOnly=true) äº‹ç‰©ä¼ æ’­è¡Œä¸ºä»‹ç»: @Transactional(propagation=Propagation.REQUIRED) ï¼šå¦‚æœæœ‰äº‹åŠ¡, é‚£ä¹ˆåŠ å…¥äº‹åŠ¡, æ²¡æœ‰çš„è¯æ–°å»ºä¸€ä¸ª(é»˜è®¤æƒ…å†µä¸‹) @Transactional(propagation=Propagation.NOT_SUPPORTED) ï¼šå®¹å™¨ä¸ä¸ºè¿™ä¸ªæ–¹æ³•å¼€å¯äº‹åŠ¡ @Transactional(propagation=Propagation.REQUIRES_NEW) ï¼šä¸ç®¡æ˜¯å¦å­˜åœ¨äº‹åŠ¡,éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡,åŸæ¥çš„æŒ‚èµ·,æ–°çš„æ‰§è¡Œå®Œæ¯•,ç»§ç»­æ‰§è¡Œè€çš„äº‹åŠ¡ @Transactional(propagation=Propagation.MANDATORY) ï¼šå¿…é¡»åœ¨ä¸€ä¸ªå·²æœ‰çš„äº‹åŠ¡ä¸­æ‰§è¡Œ,å¦åˆ™æŠ›å‡ºå¼‚å¸¸ @Transactional(propagation=Propagation.NEVER) ï¼šå¿…é¡»åœ¨ä¸€ä¸ªæ²¡æœ‰çš„äº‹åŠ¡ä¸­æ‰§è¡Œ,å¦åˆ™æŠ›å‡ºå¼‚å¸¸(ä¸Propagation.MANDATORYç›¸å) @Transactional(propagation=Propagation.SUPPORTS) ï¼šå¦‚æœå…¶ä»–beanè°ƒç”¨è¿™ä¸ªæ–¹æ³•,åœ¨å…¶ä»–beanä¸­å£°æ˜äº‹åŠ¡,é‚£å°±ç”¨äº‹åŠ¡.å¦‚æœå…¶ä»–beanæ²¡æœ‰å£°æ˜äº‹åŠ¡,é‚£å°±ä¸ç”¨äº‹åŠ¡. äº‹ç‰©è¶…æ—¶è®¾ç½®: @Transactional(timeout=30) //é»˜è®¤æ˜¯30ç§’ äº‹åŠ¡éš”ç¦»çº§åˆ«: @Transactional(isolation = Isolation.READ_UNCOMMITTED)ï¼šè¯»å–æœªæäº¤æ•°æ®(ä¼šå‡ºç°è„è¯», ä¸å¯é‡å¤è¯») åŸºæœ¬ä¸ä½¿ç”¨ @Transactional(isolation = Isolation.READ_COMMITTED)ï¼šè¯»å–å·²æäº¤æ•°æ®(ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯») @Transactional(isolation = Isolation.REPEATABLE_READ)ï¼šå¯é‡å¤è¯»(ä¼šå‡ºç°å¹»è¯») @Transactional(isolation = Isolation.SERIALIZABLE)ï¼šä¸²è¡ŒåŒ– MYSQL: é»˜è®¤ä¸ºREPEATABLE_READçº§åˆ« SQLSERVER: é»˜è®¤ä¸ºREAD_COMMITTED è„è¯» : ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°å¦ä¸€äº‹åŠ¡æœªæäº¤çš„æ›´æ–°æ•°æ® ä¸å¯é‡å¤è¯» : åœ¨åŒä¸€äº‹åŠ¡ä¸­, å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®è¿”å›çš„ç»“æœæœ‰æ‰€ä¸åŒ, æ¢å¥è¯è¯´, åç»­è¯»å–å¯ä»¥è¯»åˆ°å¦ä¸€äº‹åŠ¡å·²æäº¤çš„æ›´æ–°æ•°æ®. ç›¸å, â€œå¯é‡å¤è¯»â€åœ¨åŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡ è¯»å–æ•°æ®æ—¶, èƒ½å¤Ÿä¿è¯æ‰€è¯»æ•°æ®ä¸€æ ·, ä¹Ÿå°±æ˜¯åç»­è¯»å–ä¸èƒ½è¯»åˆ°å¦ä¸€äº‹åŠ¡å·²æäº¤çš„æ›´æ–°æ•°æ® å¹»è¯» : ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å·²æäº¤çš„insertæ•°æ® ä¸‰ã€ç‰¹åˆ«éœ€è¦æ³¨æ„çš„å‡ ç‚¹ spring äº‹åŠ¡ç®¡ç†å™¨,ç”±springæ¥è´Ÿè´£æ•°æ®åº“çš„æ‰“å¼€,æäº¤,å›æ»š.é»˜è®¤é‡åˆ°è¿è¡ŒæœŸä¾‹å¤–(throw new RuntimeException(â€œæ³¨é‡Šâ€);)ä¼šå›æ»šï¼Œå³é‡åˆ°ä¸å—æ£€æŸ¥ï¼ˆuncheckedï¼‰çš„ä¾‹å¤–æ—¶å›æ»šï¼›è€Œé‡åˆ°éœ€è¦æ•è·çš„ä¾‹å¤–(throw new Exception(â€œæ³¨é‡Šâ€);)ä¸ä¼šå›æ»š,å³é‡åˆ°å—æ£€æŸ¥çš„ä¾‹å¤–ï¼ˆå°±æ˜¯éè¿è¡Œæ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥åˆ°çš„å¼‚å¸¸å«å—æ£€æŸ¥ä¾‹å¤–æˆ–è¯´å—æ£€æŸ¥å¼‚å¸¸ï¼‰æ—¶ï¼Œéœ€æˆ‘ä»¬æŒ‡å®šæ–¹å¼æ¥è®©äº‹åŠ¡å›æ»šè¦æƒ³æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š,è¦åŠ ä¸Š @Transactional( rollbackFor={Exception.class,å…¶å®ƒå¼‚å¸¸}) .å¦‚æœè®©uncheckedä¾‹å¤–ä¸å›æ»š @Transactional æ³¨è§£åº”è¯¥åªè¢«åº”ç”¨åˆ° public å¯è§åº¦çš„æ–¹æ³•ä¸Šã€‚ å¦‚æœä½ åœ¨ protectedã€private æˆ–è€… package-visible çš„æ–¹æ³•ä¸Šä½¿ç”¨ @Transactional æ³¨è§£ï¼Œå®ƒä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œ ä½†æ˜¯è¿™ä¸ªè¢«æ³¨è§£çš„æ–¹æ³•å°†ä¸ä¼šå±•ç¤ºå·²é…ç½®çš„äº‹åŠ¡è®¾ç½®ã€‚ @Transactional æ³¨è§£å¯ä»¥è¢«åº”ç”¨äºæ¥å£å®šä¹‰å’Œæ¥å£æ–¹æ³•ã€ç±»å®šä¹‰å’Œç±»çš„ public æ–¹æ³•ä¸Šã€‚ç„¶è€Œï¼Œè¯·æ³¨æ„ä»…ä»… @Transactional æ³¨è§£çš„å‡ºç°ä¸è¶³äºå¼€å¯äº‹åŠ¡è¡Œä¸ºï¼Œå®ƒä»…ä»… æ˜¯ä¸€ç§å…ƒæ•°æ®ï¼Œèƒ½å¤Ÿè¢«å¯ä»¥è¯†åˆ« @Transactional æ³¨è§£å’Œä¸Šè¿°çš„é…ç½®é€‚å½“çš„å…·æœ‰äº‹åŠ¡è¡Œä¸ºçš„beansæ‰€ä½¿ç”¨ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå…¶å®æ­£æ˜¯ å…ƒç´ çš„å‡ºç° å¼€å¯ äº†äº‹åŠ¡è¡Œä¸ºã€‚ Springå›¢é˜Ÿçš„å»ºè®®æ˜¯ä½ åœ¨å…·ä½“çš„ç±»ï¼ˆæˆ–ç±»çš„æ–¹æ³•ï¼‰ä¸Šä½¿ç”¨ @Transactional æ³¨è§£ï¼Œè€Œä¸è¦ä½¿ç”¨åœ¨ç±»æ‰€è¦å®ç°çš„ä»»ä½•æ¥å£ä¸Šã€‚ä½ å½“ç„¶å¯ä»¥åœ¨æ¥å£ä¸Šä½¿ç”¨ @Transactional æ³¨è§£ï¼Œä½†æ˜¯è¿™å°†åªèƒ½å½“ä½ è®¾ç½®äº†åŸºäºæ¥å£çš„ä»£ç†æ—¶å®ƒæ‰ç”Ÿæ•ˆã€‚å› ä¸ºæ³¨è§£æ˜¯ä¸èƒ½ç»§æ‰¿çš„ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœä½ æ­£åœ¨ä½¿ç”¨åŸºäºç±»çš„ä»£ç†æ—¶ï¼Œé‚£ä¹ˆäº‹åŠ¡çš„è®¾ç½®å°†ä¸èƒ½è¢«åŸºäºç±»çš„ä»£ç†æ‰€è¯†åˆ«ï¼Œè€Œä¸”å¯¹è±¡ä¹Ÿå°†ä¸ä¼šè¢«äº‹åŠ¡ä»£ç†æ‰€åŒ…è£…ï¼ˆå°†è¢«ç¡®è®¤ä¸ºä¸¥é‡çš„ï¼‰ã€‚å› æ­¤ï¼Œè¯·æ¥å—Springå›¢é˜Ÿçš„å»ºè®®å¹¶ä¸”åœ¨å…·ä½“çš„ç±»ä¸Šä½¿ç”¨ @Transactional æ³¨è§£ã€‚ å¦‚æœå¼‚å¸¸è¢«tryï½›ï½catchï½›ï½äº†ï¼Œäº‹åŠ¡å°±ä¸å›æ»šäº†ï¼Œå¦‚æœæƒ³è®©äº‹åŠ¡å›æ»šå¿…é¡»å†å¾€å¤–æŠ›tryï½›ï½catchï½›throw Exceptionï½ã€‚ ä½¿ç”¨äº†@Transactionalçš„æ–¹æ³•ï¼Œå¯¹åŒä¸€ä¸ªç±»é‡Œé¢çš„æ–¹æ³•è°ƒç”¨ï¼Œ @Transactionalæ— æ•ˆã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªç±»Testï¼Œå®ƒçš„ä¸€ä¸ªæ–¹æ³•Aï¼ŒAå†è°ƒç”¨Testæœ¬ç±»çš„æ–¹æ³•Bï¼ˆä¸ç®¡Bæ˜¯å¦publicè¿˜æ˜¯privateï¼‰ï¼Œä½†Aæ²¡æœ‰å£°æ˜æ³¨è§£äº‹åŠ¡ï¼Œè€ŒBæœ‰ã€‚åˆ™å¤–éƒ¨è°ƒç”¨Aä¹‹åï¼ŒBçš„äº‹åŠ¡æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„ã€‚ï¼ˆç»å¸¸åœ¨è¿™é‡Œå‡ºé”™ï¼‰ æ”¾åœ¨æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼šè¦†ç›–ç±»ä¸Šè¾¹çš„æ³¨è§£çš„å‚æ•°å±æ€§ã€‚","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"chapter-10-AIR","slug":"2018-05-14/TensorFlow SVMè¯¦è§£","date":"2018-05-20T11:52:00.000Z","updated":"2018-05-29T03:28:39.852Z","comments":true,"path":"posts/78b2bf24/","link":"","permalink":"http://weafteam.github.io/posts/78b2bf24/","excerpt":"","text":"TensorFlow SVM ç®€å•çš„ä»‹ç»ä¸€ä¸‹Support Vector Machineï¼ŒSVMæ˜¯ä¸€ä¸ªäºŒåˆ†ç±»æœºå™¨å­¦ä¹ ç®—æ³•ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†è®©ä¸¤ç±»ä¹‹é—´çš„marginæ›´å¤§ï¼ŒSVMè¿˜å¯ä»¥å®ç°å¤šåˆ†ç±»ä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦æ‰©å±•éçº¿æ€§kernelsè¿›å»ï¼Œæ¥ä¸‹æ¥é€æ¸ä»‹ç»SVM å’Œçº¿æ€§å›å½’ä¸€èµ·å·¥ä½œçš„SVM,ä½¿ç”¨å¾—æ•°æ®æ˜¯IRISæ•°æ®é›†ï¼Œå–ä¸¤ä¸ªç‰¹å¾ç»´åº¦ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126importimport matplotlib.pyplotmatplot as pltimport numpy as npimport tensorflow as tffrom sklearn import datasetsfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()iris = datasets.load_iris()x_vals = np.array([[x[0], x[3]] for x in iris.data])y_vals = np.array([1 if y == 0 else -1 for y in iris.target])train_indices = np.random.choice(len(x_vals), round(len(x_vals)*0.8), replace=False)test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))x_vals_train = x_vals[train_indices]x_vals_test = x_vals[test_indices]y_vals_train = y_vals[train_indices]y_vals_test = y_vals[test_indices]batch_size = 100x_data = tf.placeholder(shape=[None, 2], dtype=tf.float32)y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32)A = tf.Variable(tf.random_normal(shape=[2, 1]))b = tf.Variable(tf.random_normal(shape=[1, 1]))model_output = tf.subtract(tf.matmul(x_data, A), b)l2_norm = tf.reduce_sum(tf.square(A))prediction = tf.sign(model_output)accuracy = tf.reduce_mean(tf.cast(tf.equal(prediction, y_target), tf.float32))my_opt = tf.train.GradientDescentOptimizer(0.01)train_step = my_opt.minimize(loss)init = tf.global_variables_initializer()sess.run(init)loss_vec = []train_accuracy = []test_accuracy = []for i in range(500): rand_index = np.random.choice(len(x_vals_train), size=batch_size) rand_x = x_vals_train[rand_index] rand_y = np.transpose([y_vals_train[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec.append(temp_loss) train_acc_temp = sess.run(accuracy, feed_dict=&#123; x_data: x_vals_train, y_target: np.transpose([y_vals_train])&#125;) train_accuracy.append(train_acc_temp) test_acc_temp = sess.run(accuracy, feed_dict=&#123; x_data: x_vals_test, y_target: np.transpose([y_vals_test])&#125;) test_accuracy.append(test_acc_temp) if (i + 1) % 100 == 0: print('Step #&#123;&#125; A = &#123;&#125;, b = &#123;&#125;'.format( str(i+1), str(sess.run(A)), str(sess.run(b)) )) print('Loss = ' + str(temp_loss)) [[a1], [a2]] = sess.run(A)[[b]] = sess.run(b)slope = -a2/a1y_intercept = b/a1x1_vals = [d[1] for d in x_vals]best_fit = []for i in x1_vals: best_fit.append(slope*i+y_intercept)setosa_x = [d[1] for i, d in enumerate(x_vals) if y_vals[i] == 1]setosa_y = [d[0] for i, d in enumerate(x_vals) if y_vals[i] == 1]not_setosa_x = [d[1] for i, d in enumerate(x_vals) if y_vals[i] == -1]not_setosa_y = [d[0] for i, d in enumerate(x_vals) if y_vals[i] == -1]plt.plot(setosa_x, setosa_y, 'o', label='I. setosa')plt.plot(not_setosa_x, not_setosa_y, 'x', label='Non-setosa')plt.plot(x1_vals, best_fit, 'r-', label='Linear Separator', linewidth=3)plt.ylim([0, 10])plt.legend(loc='lower right')plt.title('Sepal Length vs Pedal Width')plt.xlabel('Pedal Width')plt.ylabel('Sepal Length')plt.show()plt.plot(train_accuracy, 'k-', label='Training Accuracy')plt.plot(test_accuracy, 'r--', label='Test Accuracy')plt.title('Train and Test Set Accuracies')plt.xlabel('Generation')plt.ylabel('Accuracy')plt.legend(loc='lower right')plt.show()plt.plot(loss_vec, 'k-')plt.title('Loss per Generation')plt.xlabel('Generation')plt.ylabel('Loss')plt.show() åˆæ¢SVM å¤§å®¶ä¸€å®šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œæˆ‘åªä»‹ç»åœ¨tensorflowä¸‹é¢çš„ä¸€äº›å®ç°ï¼Œä¸å«åŸç†ï¼ŒåŸç†å¤§å®¶å¯ä»¥åœ¨ç½‘ä¸Šæ‰¾ä¸€äº›èµ„æ–™äº†è§£ã€‚é‚®ç®±air@weaf.topã€‚","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"chapter-09-AIR","slug":"2018-05-07/TensorFlowé€»è¾‘å›å½’è¯¦è§£","date":"2018-05-20T11:31:09.000Z","updated":"2018-05-29T01:27:49.900Z","comments":true,"path":"posts/befe0ef0/","link":"","permalink":"http://weafteam.github.io/posts/befe0ef0/","excerpt":"","text":"TensorFlow Logistic Regression è¿˜æ˜¯å¾—å…ˆå’Œå¤§å®¶å¼€ä¸ªå¤´ï¼Œæˆ‘æœ€è¿‘æœ‰ç‚¹å¿™ï¼Œæ‰€ä»¥æœ‰æ—¶å€™éœ€è¦æŠ½å¼€æ—¶é—´è¡¥ä¸Šæ‹‰ä¸‹çš„åšå®¢ï¼Œè¿™æ˜¯æˆ‘2018å¹´5æœˆ20å·è¡¥5æœˆä¸ƒå·é‚£ä¸ªæœˆçš„åšå®¢ï¼Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹é€»è¾‘å›å½’çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯ç›¸å¯¹äºçº¿æ€§å›å½’ï¼Œå…¶å®é€»è¾‘å›å½’å°±æ˜¯ä¸€ä¸ªåˆ†ç±»é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œä¹Ÿå°±æ˜¯æœ€åå°†å€¼å¾—åˆ†å¸ƒç¡®å®šåœ¨å‡ ç±»å½“ä¸­ï¼Œå°±åƒæˆ‘ä»¬æœ€å¼€å§‹åœ¨åšå®¢ä¸€å¼€å§‹å­¦ä¹ å¾—fashion mnistä¸€æ ·ï¼Œåªä¸è¿‡ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾æ¥ä¸€ä¸ªï¼Œç®€å•å¾—äºŒåˆ†ç±»é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯ï¼š \\[ y=sigmoid(A*x+b) \\] æœ€åæˆ‘ä»¬å¾—åˆ°å¾—yçš„é¢„æµ‹å€¼éƒ½ä¼šæ˜¯0ï¼Œæˆ–è€…æ˜¯1ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®æ˜¯githubçš„ä¸€ä¸ªæ•°æ®ï¼š æ­£å¼å¼€å§‹ä»£ç çš„ç¼–å†™ï¼Œå…¶å®å¾ˆç®€å•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tfimport requestsfrom tensorflow.python.framework import opsimport os.pathimport csv# ä¸Šé¢ä¸€å¦‚æ—¢å¾€çš„æ¨¡å—å¯¼å…¥ops.reset_default_graph()# åˆ›å»ºæˆ‘ä»¬çš„ä¼šè¯sess = tf.Session()# æ•°æ®çš„æ–‡ä»¶åbirth_weight_file = 'birth_weight.csv'# ä¸‹è½½æ•°æ®if not os.path.exists(birth_weight_file): birthdata_url = 'https://github.com/nfmcclure/tensorflow_cookbook/' + \\ 'raw/master/01_Introduction/07_Working_with_Data_Sources/birthweight_data/birthweight.dat' birth_file = requests.get(birthdata_url) birth_data = birth_file.text.split('\\r\\n') birth_header = birth_data[0].split('\\t') birth_data = [[float(x) for x in y.split('\\t') if len(x)&gt;=1] for y in birth_data[1:] if len(y)&gt;=1] with open(birth_weight_file, \"w\") as f: writer = csv.writer(f) writer.writerow(birth_header) writer.writerows(birth_data) f.close()# è¯»å–æ•°æ®ï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œè¦æ”¾åœ¨placeholderå¾—æ•°æ®æ˜¯è¦åŠ è½½åœ¨æ•°ç»„é‡Œé¢å¾—birth_data = []with open(birth_weight_file, newline='') as csvfile: csv_reader = csv.reader(csvfile) birth_header = next(csv_reader) for row in csv_reader: birth_data.append(row)birth_data = [[float(x) for x in row] for row in birth_data]# åˆ†æ•°æ®y_vals = np.array([x[0] for x in birth_data])x_vals = np.array([x[1:8] for x in birth_data])seed = 99np.random.seed(seed)tf.set_random_seed(seed)# åˆ†ç¦»è®­ç»ƒé›†å’Œæµ‹è¯•é›†train_indices = np.random.choice(len(x_vals), round(len(x_vals)*0.8), replace=False)test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))x_vals_train = x_vals[train_indices]x_vals_test = x_vals[test_indices]y_vals_train = y_vals[train_indices]y_vals_test = y_vals[test_indices]# å½’ä¸€åŒ–æ•°æ®å‡½æ•°def normalize_cols(m): col_max = m.max(axis=0) col_min = m.min(axis=0) return (m-col_min) / (col_max - col_min) x_vals_train = np.nan_to_num(normalize_cols(x_vals_train))x_vals_test = np.nan_to_num(normalize_cols(x_vals_test))# å®šä¹‰æ‰¹å¤„ç†å¤§å°batch_size = 25# åˆå§‹åŒ– placeholdersx_data = tf.placeholder(shape=[None, 7], dtype=tf.float32)y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32)# åˆ›å»ºå›å½’å˜é‡A = tf.Variable(tf.random_normal(shape=[7,1]))b = tf.Variable(tf.random_normal(shape=[1,1]))# å®šä¹‰æ¨¡å‹å›¾çš„æ“ä½œmodel_output = tf.add(tf.matmul(x_data, A), b)# å®šä¹‰äº¤å‰ç†µæŸå¤±å‡½æ•°loss = tf.reduce_mean(tf.nn.sigmoid_cross_entropy_with_logits(logits=model_output, labels=y_target))# å®šä¹‰ä¼˜åŒ–å™¨my_opt = tf.train.GradientDescentOptimizer(0.01)train_step = my_opt.minimize(loss)# åˆå§‹åŒ–å…¨å±€å˜é‡init = tf.global_variables_initializer()sess.run(init)# é¢„æµ‹å€¼prediction = tf.round(tf.sigmoid(model_output))predictions_correct = tf.cast(tf.equal(prediction, y_target), tf.float32)accuracy = tf.reduce_mean(predictions_correct)# å¼€å§‹è®­ç»ƒloss_vec = []train_acc = []test_acc = []for i in range(1500): rand_index = np.random.choice(len(x_vals_train), size=batch_size) rand_x = x_vals_train[rand_index] rand_y = np.transpose([y_vals_train[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec.append(temp_loss) temp_acc_train = sess.run(accuracy, feed_dict=&#123;x_data: x_vals_train, y_target: np.transpose([y_vals_train])&#125;) train_acc.append(temp_acc_train) temp_acc_test = sess.run(accuracy, feed_dict=&#123;x_data: x_vals_test, y_target: np.transpose([y_vals_test])&#125;) test_acc.append(temp_acc_test) if (i+1)%300==0: # æ¯ä¸‰ç™¾æ¬¡æ‰“ä¸€æ¬¡æŸå¤±å‡½æ•° print('Loss = ' + str(temp_loss)) ## ç”»å‡ºlossçš„å€¼plt.plot(loss_vec, 'k-')plt.title('Cross Entropy Loss per Generation')plt.xlabel('Generation')plt.ylabel('Cross Entropy Loss')plt.show()# ç”»å‡ºè®­ç»ƒå’Œæµ‹è¯•çš„å‡†ç¡®ç‡plt.plot(train_acc, 'k-', label='Train Set Accuracy')plt.plot(test_acc, 'r--', label='Test Set Accuracy')plt.title('Train and Test Accuracy')plt.xlabel('Generation')plt.ylabel('Accuracy')plt.legend(loc='lower right')plt.show() è¿™æ˜¯è¡¥ä¸Šå‘¨çš„åšå®¢ï¼Œè®©å¤§å®¶è®¤è¯†ä¸€ä¸‹é€»è¾‘å›å½’æ¨¡å‹çš„åŸºæœ¬å»ºç«‹ã€‚æœ‰ä»€ä¹ˆç–‘é—®ï¼Œå‘é‚®ä»¶air@weaf.topã€‚æœŸå¾…ä½ å“¦ï¼ï¼ï¼","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"Pillowçš„ç®€å•ä½¿ç”¨","slug":"2018-04-30/Pillowçš„ç®€å•ä½¿ç”¨","date":"2018-05-17T02:03:18.000Z","updated":"2018-05-29T01:27:49.882Z","comments":true,"path":"posts/33d9791f/","link":"","permalink":"http://weafteam.github.io/posts/33d9791f/","excerpt":"","text":"æœ€è¿‘å¯¼å¸ˆè®©æˆ‘æ ¹æ®å·²æœ‰çš„ç¬”ç”»ä½ç½®ä¿¡æ¯ï¼Œç”Ÿæˆç›¸å¯¹åº”çš„å›¾åƒä¿¡æ¯ï¼Œå…¶ä¸­ç”¨åˆ°çš„å°±æ˜¯Pillowåº“ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±æŒ‰ç…§è¿™ä¸ªä»»åŠ¡è¦æ±‚ï¼Œå¯¹Pillowè¿™ä¸ªåº“è¿›è¡Œä½¿ç”¨è®²è§£ã€‚ æ•°æ® å…ˆä»‹ç»ä¸‹æ•°æ®å§ï¼Œå½“æ—¶å¯¼å¸ˆç»™äº†æˆ‘ä¸€ä»½600Mçš„JSONæ–‡ä»¶ï¼Œçœ‹åˆ°ä¹‹åæˆ‘çš„å†…å¿ƒæ¯«æ— æ³¢æ¾œï¼Œç”šè‡³è¿˜æƒ³æ¥ä¸€ä»½é»„ç„–é¸¡ç±³é¥­ã€‚è™½ç„¶æ•°æ®é‡å¾ˆå¤§ï¼Œä½†æ˜¯æ¯æ¡æ•°æ®æ˜¯å¾ˆè§„èŒƒçš„ï¼Œä¾‹å¦‚è¿™æ ·ï¼š 1&#123;&quot;_id&quot;:&#123;&quot;$oid&quot;:&quot;58cbeb882398b78ed0c8165b&quot;&#125;,&quot;word&quot;:&quot;640,83;640,83;642,93;645,102;650,112;653,121;654,128;656,136;654,143;649,152;641,164;630,178;616,193;599,208;583,224;571,234;564,241;558,246;557,250;556,254;562,257;567,260;573,263;575,264;578,270;576,278;572,289;566,303;557,320;549,332;542,342;539,348;537,352;538,353;539,354;541,354;543,355;544,356;544,358;544,363;543,372;541,384;538,396;536,405;536,411;536,415;537,417;542,418;546,420;551,420;554,421;555,422;555,427;552,437;546,455;533,479;514,511;493,548;473,580;460,604;452,622;448,632;448,638;451,639;464,637;484,621;504,600;518,581;527,566;530,558;531,552;529,548;526,545;525,542;523,539;526,534;533,526;546,519;555,514;565,514;569,515;570,522;567,537;560,557;551,577;544,592;540,600;540,604;540,605;541,606;544,607;548,609;550,610;552,613;552,618;552,627;551,637;549,647;548,653;547,658;547,661;549,664;550,665;553,668;554,672;556,676;556,686;555,697;553,708;550,717;549,722;549,725;551,728;553,730;557,733;560,736;563,743;565,754;561,777;552,804;540,833;524,862;508,884;496,899;490,906;485,908;484,903;484,890;494,863;506,842;522,829;543,821;568,835;589,855;608,886;622,923;629,946;633,966;633,977;633,979#577,414;577,414;593,416;614,420;648,423;666,423;689,418;704,414;724,404;742,390;755,381&quot;,&quot;wordIndex&quot;:8826,&quot;str&quot;:&quot;á  á ¯á ³á  á ¬á ¤&quot;,&quot;createAtDate&quot;:&#123;&quot;$date&quot;:&quot;2017-03-17T13:58:32.767Z&quot;&#125;,&quot;updateAtDate&quot;:&#123;&quot;$date&quot;:&quot;2017-03-17T13:58:32.767Z&quot;&#125;,&quot;phoneId&quot;:&quot;9e29fc4021b45fbe&quot;,&quot;userId&quot;:&quot;0161132290&quot;,&quot;paid&quot;:false,&quot;__v&quot;:0&#125; wordå­—æ®µå°±æ˜¯ç¬”ç”»çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ç°åœ¨æ‰¾ä¸ªç”»ç¬”è·Ÿç€è¿™ä¸ªç¬”ç”»ç”»å°±è¡Œäº†ã€‚ æ€è·¯ å› ä¸ºè¿™äº›ç¬”ç”»çš„ä½ç½®å’Œå¤§å°å¹¶ä¸æ˜¯ç‰¹åˆ«è§„èŒƒçš„ï¼ˆå› ä¸ºæ”¶é›†è¿™äº›æ‰‹å†™ä½“çš„æ—¶å€™ï¼Œå°±æ˜¯åˆ©ç”¨æ‰‹æœºçš„æ‰‹å†™è¾“å…¥æ”¶é›†çš„ï¼Œæ‰€ä»¥ä¸æ˜¯å¾ˆè§„èŒƒï¼‰ï¼Œæ‰€ä»¥é¦–å…ˆç”Ÿæˆä¸€ä¸ª3000*3000çš„ç°åº¦å›¾ï¼ˆåº•æ˜¯ç™½è‰²ï¼‰ï¼Œç„¶åç”¨ä¸€ä¸ªå¾ˆç²—çš„ç”»ç¬”ï¼ˆå½“æ—¶ç”¨æ¥ä¸€ä¸ªwidth = 18çš„ç”»ç¬”ï¼‰å°†ä¸Šè¿°çš„ç¬”ç”»ç”»å‡ºæ¥ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬å¯ä»¥å…ˆæ‰¾å‡ºç¬”ç”»çš„æ¨ªå‘æœ€å¤§æœ€å°å€¼å’Œçºµå‘çš„æœ€å¤§æœ€å°å€¼ï¼Œç„¶åæ ¹æ®è¿™å››ä¸ªå€¼ï¼Œåœ¨ç”»å¸ƒä¸Šè£å‰ªå‡ºä¸€ä¸ªçŸ©å½¢æ¡†ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥å°†è£å‰ªå‡ºçš„çŸ©å½¢åŒºåŸŸresizeï¼ŒæŒ‰ç…§è¦æ±‚æ˜¯ç”Ÿæˆå®½åº¦ä¸º32ï¼Œé«˜åº¦ç­‰æ¯”ä¾‹ç¼©æ”¾çš„å›¾åƒï¼Œå½“ç„¶è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åŠ ä¸€ä¸ªå‚æ•°ï¼Œå«åšæŠ—é”¯é½¿ï¼Œç¨åæˆ‘ä¼šè®²åˆ°ã€‚ å› ä¸ºä¼ ç»Ÿçš„PILåº“ä¸æ”¯æŒPython3ï¼Œæ‰€ä»¥ä½¿ç”¨ä»PILæ´¾ç”Ÿå‡ºæ¥çš„Pillowåº“ã€‚ Imageå’ŒImageDrawç±» Pillowä¸­æœ€é‡è¦çš„å°±æ˜¯Imageç±»ï¼Œè¯¥ç±»å­˜åœ¨äºåŒåçš„æ¨¡å—ä¸­ã€‚æˆ‘ä»¬æœ¬æ¬¡ç”¨åˆ°çš„å®ä¾‹åŒ–æ–¹å¼æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ªå›¾ç‰‡ã€‚ ç”Ÿæˆç”»å¸ƒ 1image = Image.new(\"L\",(3000,3000),\"white\") ImageDrawç±»ï¼Œä»åå­—ä¸­ä¸éš¾çœ‹å‡ºä»–çš„ä½œç”¨ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¼€å§‹ç”»å›¾å§ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œwordå­—æ®µé‡Œé¢ï¼Œ\\(;\\)åˆ†å‰²çš„æ˜¯ç‚¹ï¼Œ\\(,\\)åˆ†å‰²çš„æ˜¯xå’Œyï¼Œ\\(#\\)åˆ†å‰²çš„æ˜¯ç¬”ç”»ï¼Œæ‰€ä»¥æ ¹æ®è¿™ä¸ªå±‚çº§å…³ç³»ï¼Œä¸‰å±‚åµŒå¥—çš„æ–¹å¼å°±å¯ä»¥å°†è¿™äº›ç¬”ç”»åˆ»ç”»å‡ºæ¥ã€‚ ç”Ÿæˆç”»ç¬” 1draw = ImageDraw.Draw(image) ç”»å›¾ 123456789lines = [[[int(x) for x in point.split(',')] for point in line.split(';')] for line in fileJson['word'].split('#')]for line in lines: if(len(line)&gt;1): draw.line((line[0][0], -line[0][1], line[1][0], -line[1][1]),fill='black',width=18) temp = [line[1][0],line[1][1]] for point in line: draw.line((temp[0],temp[1],point[0],point[1]),fill='black',width=18) temp=[point[0],point[1]] è£å‰ª è®¡ç®—å‡ºæ¨ªå‘çºµå‘ä¸Šçš„æœ€å¤§æœ€å°å€¼ï¼Œè¿›è¡Œè£å‰ªã€‚ï¼ˆä¹‹æ‰€ä»¥åŠ 30ï¼Œæ˜¯å› ä¸ºæœ‰ç™½è¾¹çš„æƒ…å†µä¸‹çœ‹ç€æ¯”è¾ƒèˆ’æœï¼Œä½†æ˜¯minçš„å€¼å¹¶æ²¡æœ‰åŠ ï¼ŒåŸå› æ˜¯å®¹æ˜“äº§ç”Ÿé»‘æ ï¼‰ 12box = (hor_min , ver_min , hor_max + 30 , ver_max + 30)b = image.crop(box) resizeå¹¶ä¿å­˜ 12a = b.resize((32,length),Image.ANTIALIAS)a.save(path) æœ¬æ¬¡å®éªŒå¾ˆç®€å•ï¼Œç”¨åˆ°äº†Pillowä¸­ä¸å¤šçš„å‡½æ•°ï¼Œå…¶å®Pillowä¸­è¿˜æœ‰å¾ˆå¤šæœ‰è¶£çš„æ“ä½œï¼Œè¯·å¤§å®¶è‡ªè¡Œç ”ç©¶å®ƒçš„ä¸­æ–‡æ–‡æ¡£ã€‚ æ•ˆæœ æœ€åç»™å¤§å®¶çœ‹ä¸‹æ•ˆæœï¼š","categories":[],"tags":[{"name":"Pillow Python OCR","slug":"Pillow-Python-OCR","permalink":"http://weafteam.github.io/tags/Pillow-Python-OCR/"}]},{"title":"Spring Boot å…³ä¹javaç¨‹åºå‘˜","slug":"2018-05-14/Spring-Boot--about-java-software-engineer","date":"2018-05-16T18:04:44.000Z","updated":"2018-08-07T08:56:41.650Z","comments":true,"path":"posts/1cf77d1e/","link":"","permalink":"http://weafteam.github.io/posts/1cf77d1e/","excerpt":"","text":"ä¸€ã€ç®€ä»‹ Spring Boot2.0ä¸€æ¨å‡ºå°±æ¿€èµ·äº†ä¸€é˜µå­¦ä¹ Spring Bootçš„çƒ­æµªï¼Œå°±ç™¾åº¦å’Œæœç´¢å¼•æ“çš„æ•°æ®æŠ¥å‘Šæ˜¾ç¤ºSpring Bootç›¸å…³æœç´¢æŒ‡æ•°æ€¥å‰§å¢åŠ ã€‚ é‚£ä¹ˆSpring Bootåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæƒ³å¿…å¤§å®¶éƒ½æœ‰äº†ä¸€äº›äº†è§£ï¼‰ é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤šäººå»å­¦ä¹ ä»–å‘¢ï¼Ÿï¼ˆå€¼å¾—æ€è€ƒçš„é—®é¢˜ï¼‰ Spring Bootçš„è¯ç”Ÿ éšç€ä½¿ç”¨Springçš„äººè¶Šæ¥è¶Šå¤šï¼ŒSpringå°±å¼€å§‹ä»ä¸€ä¸ªç®€å•ã€å•ä¸€çš„å°æ¡†æ¶å˜æˆä¸€ä¸ªå¤§è€Œå…¨çš„å¼€æºè½¯ä»¶ï¼Œéƒ½åæ¥ï¼Œå‡ ä¹ç”¨æ•´ä¸ªSpringå°±å¯ä»¥æ”¯æ’‘èµ·ä¼ä¸šä¸­æ‰€æœ‰çš„æœåŠ¡äº†ã€‚ä½†æ˜¯éšä¹‹ä¹Ÿä½¿å¾—å¸¦æ¥ä¸€äº›é—®é¢˜ã€‚ ä¹‹å‰çš„Spring æœ‰ç€å„ç§å„æ ·çš„é…ç½®æ–‡ä»¶ã€‚å¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ä¸å¾—ä¸é…ç½®å¾ˆå¤šä¸œè¥¿ã€‚ åæ¥Springæ…¢æ…¢çš„å‘ç°äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¼€å§‹äº†Spring Booté¡¹ç›®çš„ç ”å‘ã€‚ Spring Bootæ˜¯ä»€ä¹ˆï¼Ÿ Spring Bootæ˜¯ç”±Pivotalå›¢é˜Ÿæä¾›çš„å…¨æ–°æ¡†æ¶ï¼Œå…¶è®¾è®¡ç›®çš„æ˜¯ç”¨æ¥ç®€åŒ–æ–°Springåº”ç”¨çš„åˆå§‹æ­å»ºä»¥åŠå¼€å‘è¿‡ç¨‹ã€‚è¯¥æ¡†æ¶ä½¿ç”¨äº†ç‰¹å®šçš„æ–¹å¼æ¥è¿›è¡Œé…ç½®ï¼Œä»è€Œä½¿å¼€å‘äººå‘˜ä¸å†éœ€è¦å®šä¹‰æ ·æ¿åŒ–çš„é…ç½®ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒSpring Bootè‡´åŠ›äºåœ¨è“¬å‹ƒå‘å±•çš„å¿«é€Ÿåº”ç”¨å¼€å‘é¢†åŸŸ(rapid application development)æˆä¸ºé¢†å¯¼è€…ã€‚ ç‰¹ç‚¹ åˆ›å»ºç‹¬ç«‹çš„Springåº”ç”¨ç¨‹åº åµŒå…¥çš„Tomcatï¼Œæ— éœ€éƒ¨ç½²WARæ–‡ä»¶ ç®€åŒ–Mavené…ç½® è‡ªåŠ¨é…ç½®Spring æä¾›ç”Ÿäº§å°±ç»ªå‹åŠŸèƒ½ï¼Œå¦‚æŒ‡æ ‡ï¼Œå¥åº·æ£€æŸ¥å’Œå¤–éƒ¨é…ç½® ç»å¯¹æ²¡æœ‰ä»£ç ç”Ÿæˆå’Œå¯¹XMLæ²¡æœ‰è¦æ±‚é…ç½® äºŒã€SpringBootå…³ä¹Javaç¨‹åºå‘˜ é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼Œç°åœ¨ä¼ä¸šä¸­å¾ˆå¤šéƒ½æ˜¯ç”¨Springå¼€æºæ¡†æ¶ï¼Œå¹¶ä¸”ç°åœ¨Spring Boot2.0ä½œä¸ºSpringçš„ä¼˜ç§€äº§ç‰©ï¼Œå·²ç»å¸å¼•äº†å¾ˆå¤šæŠ€æœ¯å’Œä¼ä¸šå»ä½¿ç”¨å®ƒã€‚ è¿™ä½¿å¾—æˆ‘ä»¬Javaç¨‹åºå‘˜ä¸å¾—ä¸å»å­¦ä¹ ä»–çš„ä¸€ä¸ªåŸå› ã€‚ å…¶æ¬¡ï¼ŒSpring Boot è¿˜å…·æœ‰ä¸€ä¸‹ç‰¹ç‚¹ï¼š Spring Boot è®©å¼€å‘å˜å¾—æ›´ç®€å• ç™»å½•ç½‘å€ http://start.spring.io/ é€‰æ‹©å¯¹åº”çš„ç»„ä»¶ç›´æ¥ä¸‹è½½ å¯¼å…¥é¡¹ç›®ï¼Œç›´æ¥å¼€å‘ Spring Boot ä½¿æµ‹è¯•å˜å¾—æ›´ç®€å• å¼•å…¥spring-boot-start-testä¾èµ–åŒ… å¯¹æ•°æ®åº“ã€Mockã€ Web ç­‰å„ç§æƒ…å†µè¿›è¡Œæµ‹è¯•ã€‚ Spring Boot è®©é…ç½®å˜å¾—æ›´ç®€å• Spring Boot è®©éƒ¨ç½²å˜å¾—æ›´ç®€å• Spring Boot è®©ç›‘æ§å˜å¾—æ›´ç®€å• ä¸‰ã€é¡¹ç›®ç”Ÿäº§ Spring Booté¡¹ç›®æ­å»ºéå¸¸ç®€å• æˆ‘ä»¬å¯ä»¥ä½¿ç”¨springæä¾›çš„ç½‘ç«™ç›´æ¥ç”Ÿäº§è‡ªå·±æƒ³è¦çš„é¡¹ç›® https://start.spring.io/ è¿™é‡Œç”Ÿäº§çš„demoå¯ä»¥å°†ä½ æ‰€éœ€çš„æ‰€æœ‰ä¸œè¥¿éƒ½é›†æˆè¿›å»ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‚¹å‡» Switch to the full version æ¥æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„åˆ—è¡¨ å››ã€ç›®å½•è§£æ æˆ‘ä»¬å¯ä»¥çœ‹å‡ºé»˜è®¤ç»™å‡ºçš„demoçš„é¡¹ç›®ç›®å½•å¾ˆç®€å•ã€‚ éƒ½æ˜¯æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„ä¸‰ä¸ªç›®å½• src/main/java/ src/main/resources/ src/test/java/ è¿™é‡Œresources æˆ‘ä½¿ç”¨çš„æ˜¯yamlæ–‡ä»¶ã€‚è€Œä¸”SpringBootå¯¹å®ƒçš„æ”¯æŒä¹Ÿæ˜¯éå¸¸å¥½çš„ã€‚ ã€‚ å‚è€ƒæ–‡æ¡£ï¼š https://spring.io/projects/spring-boot http://blog.51cto.com/ityouknow/2128700","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆäº”ï¼‰","slug":"2018-05-07/guide-to-asyncio-5","date":"2018-05-13T15:09:56.000Z","updated":"2018-08-07T08:56:41.649Z","comments":true,"path":"posts/112d613e/","link":"","permalink":"http://weafteam.github.io/posts/112d613e/","excerpt":"","text":"ä¹¦æ¥ä¸Šæ–‡ã€‚ ç”¨åç¨‹å’Œæµå®ç°å¼‚æ­¥ I / O æœ¬èŠ‚å°†é‡æ–°å®ç° echo æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ä¸¤ä¸ªç¤ºä¾‹ç¨‹åºï¼Œåªä¸è¿‡ä¼šä½¿ç”¨åç¨‹å’Œ asyncio æµ API è€Œä¸æ˜¯ Protocol å’Œ Transport ç±»æŠ½è±¡ã€‚è¿™äº›ç¤ºä¾‹åœ¨æ¯”å‰é¢è®¨è®ºçš„Protocol API æ›´ä½çš„æŠ½è±¡çº§åˆ«ä¸Šæ“ä½œï¼Œä½†æ˜¯å¤„ç†çš„äº‹ä»¶æ˜¯ç›¸ä¼¼çš„ã€‚ Echo æœåŠ¡å™¨ æœåŠ¡å™¨ç¨‹åºé¦–å…ˆå¯¼å…¥æ‰€éœ€çš„ asyncio å’Œ logging æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š 1234567891011121314import asyncioimport loggingimport sysSERVER_ADDRESS = ('localhost', 10000)logging.basicConfig( level=logging.DEBUG, format='%(name)s: %(message)s', stream=sys.stderr,)log = logging.getLogger('main')event_loop = asyncio.get_event_loop() ç„¶åå®šä¹‰ä¸€ä¸ªåç¨‹æ¥å¤„ç†é€šä¿¡ã€‚æ¯æ¬¡å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨åç¨‹çš„æ–°å®ä¾‹ï¼Œä»è€Œåœ¨è¯¥å‡½æ•°ä¸­çš„ä»£ç ä¸€æ¬¡åªèƒ½ä¸ä¸€ä¸ªå®¢æˆ·ç«¯é€šä¿¡ã€‚Python çš„è¯­è¨€è¿è¡Œæ—¶ç®¡ç†æ¯ä¸ªåç¨‹å®ä¾‹çš„çŠ¶æ€ï¼Œå› æ­¤åº”ç”¨ç¨‹åºä»£ç ä¸éœ€è¦ç®¡ç†ä»»ä½•é¢å¤–çš„æ•°æ®ç»“æ„æ¥è·Ÿè¸ªå•ç‹¬çš„å®¢æˆ·ç«¯ã€‚ åç¨‹æ¥å—çš„å‚æ•°æ˜¯ä¸æ–°è¿æ¥å…³è”çš„ StreamReader å’Œ StreamWriter å®ä¾‹ã€‚ä¸ Transport ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡ writer çš„ get_extra_info() æ–¹æ³•è®¿é—®å®¢æˆ·ç«¯åœ°å€ï¼š 1234async def echo(reader, writer): address = writer.get_extra_info('peername') log = logging.getLogger('echo_&#123;&#125;_&#123;&#125;'.format(*address)) log.debug('connection accepted') è™½ç„¶åœ¨å»ºç«‹è¿æ¥æ—¶è°ƒç”¨åç¨‹ï¼Œä½†å¯èƒ½è¿˜æ²¡æœ‰ä»»ä½•è¦è¯»å–çš„æ•°æ®ã€‚ä¸ºäº†é¿å…åœ¨è¯»å–æ—¶é˜»å¡ï¼Œåç¨‹ä½¿ç”¨ await read() æ¥å…è®¸äº‹ä»¶å¾ªç¯ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œç›´åˆ°æœ‰æ•°æ®è¦è¯»å–ï¼š 12while True: data = await reader.read(128) å¦‚æœå®¢æˆ·ç«¯å‘é€äº†æ•°æ®ï¼Œåˆ™ä» await è¿”å›æ•°æ®ï¼Œå¹¶å¯é€šè¿‡å°†å…¶ä¼ é€’ç»™ writer å‘é€å›å®¢æˆ·ç«¯ã€‚å¯¹ write() çš„å¤šä¸ªè°ƒç”¨å¯ç”¨äºç¼“å†²ä¼ å‡ºçš„æ•°æ®ï¼Œç„¶åä½¿ç”¨ drain() åˆ·æ–°ç»“æœã€‚ç”±äºåˆ·æ–°ç½‘ç»œ I / O å¯èƒ½ä¼šé˜»å¡ï¼Œå› æ­¤å†æ¬¡ä½¿ç”¨ await æ¥æ¢å¤å¯¹äº‹ä»¶å¾ªç¯çš„æ§åˆ¶ï¼Œäº‹ä»¶å¾ªç¯ç›‘è§†å†™å…¥ socketï¼Œå¹¶åœ¨å¯èƒ½å‘é€æ›´å¤šæ•°æ®æ—¶è°ƒç”¨ writerï¼š 12345if data: log.debug(f'received &#123;data&#125;') writer.write(data) await writer.drain() log.debug(f'sent &#123;data&#125;') å¦‚æœå®¢æˆ·ç«¯æœªå‘é€ä»»ä½•æ•°æ®ï¼Œread() å°†è¿”å›ä¸€ä¸ªç©ºå­—èŠ‚ä¸²ï¼Œä»¥æŒ‡ç¤ºè¿æ¥å·²å…³é—­ã€‚æœåŠ¡å™¨éœ€è¦å…³é—­ socket ä»¥å†™å…¥å®¢æˆ·ç«¯ï¼Œç„¶å åç¨‹å¯ä»¥è¿”å›ä»¥æŒ‡ç¤ºå®ƒå·²å®Œæˆï¼š 1234else: log.debug('closing') writer.close() return å¯åŠ¨æœåŠ¡å™¨æœ‰ä¸¤ä¸ªæ­¥éª¤ã€‚é¦–å…ˆï¼Œåº”ç”¨ç¨‹åºå‘Šè¯‰äº‹ä»¶å¾ªç¯è¦ç›‘å¬çš„ä¸»æœºåå’Œ socketï¼Œä½¿ç”¨åç¨‹åˆ›å»ºæ–°çš„æœåŠ¡å™¨å¯¹è±¡ã€‚ start_server() æ–¹æ³•æœ¬èº«å°±æ˜¯ä¸€ä¸ªåç¨‹ï¼Œå› æ­¤å¿…é¡»ç”±äº‹ä»¶å¾ªç¯å¤„ç†ç»“æœæ‰èƒ½å®é™…å¯åŠ¨æœåŠ¡å™¨ã€‚å®Œæˆåç¨‹äº§ç”Ÿäº†ç»‘å®šåˆ°äº‹ä»¶å¾ªç¯çš„ asyncio.Server å®ä¾‹ï¼š 123factory = asyncio.start_server(echo, *SERVER_ADDRESS)server = event_loop.run_until_complete(factory)log.debug('starting up on &#123;&#125; port &#123;&#125;'.format(*SERVER_ADDRESS)) éœ€è¦è¿è¡Œäº‹ä»¶å¾ªç¯ä»¥å¤„ç†äº‹ä»¶å’Œå®¢æˆ·ç«¯è¯·æ±‚ã€‚å¯¹äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ï¼Œrun_forever() æ–¹æ³•æ˜¯æœ€ç®€å•çš„æ–¹æ³•ã€‚å½“äº‹ä»¶å¾ªç¯åœæ­¢æ—¶ï¼Œæ— è®ºæ˜¯é€šè¿‡åº”ç”¨ç¨‹åºä»£ç è¿˜æ˜¯é€šè¿‡å‘ä¿¡å·é€šçŸ¥è¿›ç¨‹ï¼ŒæœåŠ¡å™¨éƒ½å¯ä»¥å…³é—­ä»¥æ­£ç¡®æ¸…ç† socketï¼Œç„¶åå¯ä»¥å…³é—­äº‹ä»¶å¾ªç¯ä»¥åœ¨ç¨‹åºé€€å‡ºä¹‹å‰å®Œæˆå¯¹ä»»ä½•å…¶ä»–äº‹åŠ¡çš„å¤„ç†ï¼š 12345678910try: event_loop.run_forever()except KeyboardInterrupt: passfinally: log.debug('closing server') server.close() event_loop.run_until_complete(server.wait_closed()) log.debug('closing event loop') event_loop.close() Echo å®¢æˆ·ç«¯ ä½¿ç”¨åç¨‹æ„å»ºå®¢æˆ·ç«¯éå¸¸ç±»ä¼¼äºæ„å»ºæœåŠ¡å™¨ã€‚ä»£ç å†æ¬¡å¼€å§‹äºå¯¼å…¥ asyncio å’Œ logging æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š 12345678910111213141516171819import asyncioimport loggingimport sysMESSAGES = [ b'This is the message. ', b'It will be sent ', b'in parts.',]SERVER_ADDRESS = ('localhost', 10000)logging.basicConfig( level=logging.DEBUG, format='%(name)s: %(message)s', stream=sys.stderr,)log = logging.getLogger('main')event_loop = asyncio.get_event_loop() echo_client åç¨‹æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œå‘Šè¯‰å®ƒæœåŠ¡å™¨åœ¨å“ªé‡Œä»¥åŠè¦å‘é€ä»€ä¹ˆæ¶ˆæ¯ï¼š 1async def echo_client(address, messages): å½“ä»»åŠ¡å¯åŠ¨æ—¶è°ƒç”¨åç¨‹ï¼Œä½†å®ƒæ²¡æœ‰å¯ç”¨çš„æ´»åŠ¨è¿æ¥ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯è®©å®¢æˆ·ç«¯å»ºç«‹è‡ªå·±çš„è¿æ¥ã€‚å®ƒä½¿ç”¨ await æ¥é¿å…åœ¨ open_connection() åç¨‹è¿è¡Œæ—¶é˜»å¡å…¶ä»–æ´»åŠ¨ï¼š 1234log = logging.getLogger('echo_client')log.debug('connecting to &#123;&#125; port &#123;&#125;'.format(*address))reader, writer = await asyncio.open_connection(*address) open_connection() åç¨‹è¿”å›ä¸æ–° socket å…³è”çš„ StreamReader å’Œ StreamWriter å®ä¾‹ã€‚ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨ writer å‘æœåŠ¡å™¨å‘é€æ•°æ®ã€‚ä¸æœåŠ¡å™¨ä¸€æ ·ï¼Œwriter å°†ç¼“å†²ä¼ å‡ºçš„æ•°æ®ï¼Œç›´åˆ° socket å°±ç»ªæˆ–ä½¿ç”¨ drain() åˆ·æ–°ç»“æœã€‚ç”±äºåˆ·æ–°ç½‘ç»œ I / O å¯èƒ½ä¼šé˜»å¡ï¼Œå› æ­¤å†æ¬¡ä½¿ç”¨ await æ¥æ¢å¤å¯¹äº‹ä»¶å¾ªç¯çš„æ§åˆ¶ï¼Œäº‹ä»¶å¾ªç¯ç›‘è§†å†™å…¥ socketï¼Œå¹¶åœ¨å¯èƒ½å‘é€æ›´å¤šæ•°æ®æ—¶è°ƒç”¨ writerï¼š 123456for msg in messages: writer.write(msg) log.debug(f'sending &#123;msg&#125;')if writer.can_write_eof(): writer.write_eof()await writer.drain() æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯é€šè¿‡å°è¯•è¯»å–æ•°æ®ç›´åˆ°æ²¡æœ‰è¦è¯»å–çš„å†…å®¹æ¥è·å–æ¥è‡ªæœåŠ¡å™¨çš„å“åº”ã€‚ä¸ºäº†é¿å…é˜»å¡å•ä¸ª read() è°ƒç”¨ï¼Œawait å°†æ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯ã€‚å¦‚æœæœåŠ¡å™¨å·²å‘é€æ•°æ®ï¼Œåˆ™ä¼šè®°å½•æ•°æ®ã€‚å¦‚æœæœåŠ¡å™¨æœªå‘é€ä»»ä½•æ•°æ®ï¼Œread() å°†è¿”å›ä¸€ä¸ªç©ºå­—èŠ‚ä¸²ï¼ŒæŒ‡ç¤ºè¿æ¥å·²å…³é—­ã€‚å®¢æˆ·ç«¯éœ€è¦å…³é—­ socket ä»¥å‘é€åˆ°æœåŠ¡å™¨ï¼Œç„¶åè¿”å›ä»¥æŒ‡ç¤ºå·²å®Œæˆï¼š 123456789log.debug('waiting for response')while True: data = await reader.read(128) if data: log.debug(f'received &#123;data&#125;') else: log.debug('closing') writer.close() return è¦å¯åŠ¨å®¢æˆ·ç«¯ï¼Œä½¿ç”¨åç¨‹è°ƒç”¨äº‹ä»¶å¾ªç¯ä»¥åˆ›å»ºå®¢æˆ·ç«¯ã€‚ä½¿ç”¨ run_until_complete() å¯é¿å…å®¢æˆ·ç«¯ç¨‹åºä¸­å‡ºç°æ— é™å¾ªç¯ã€‚ä¸Protocol ç¤ºä¾‹ä¸åŒï¼Œåç¨‹å®Œæˆæ—¶ä¸éœ€è¦å•ç‹¬çš„ future å‘å‡ºä¿¡å·ï¼Œå› ä¸º echo_client() åŒ…å«æ‰€æœ‰å®¢æˆ·ç«¯é€»è¾‘æœ¬èº«ï¼Œå¹¶ä¸”åœ¨æ”¶åˆ°å“åº”å¹¶å…³é—­æœåŠ¡å™¨è¿æ¥ä¹‹å‰ä¸ä¼šè¿”å›ï¼š 12345try: event_loop.run_until_complete(echo_client(SERVER_ADDRESS, MESSAGES))finally: log.debug('closing event loop') event_loop.close() è¾“å‡º åœ¨ä¸€ä¸ªçª—å£ä¸­è¿è¡ŒæœåŠ¡å™¨è€Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­è¿è¡Œå®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š 123456789asyncio: Using selector: SelectSelectorecho_client: connecting to localhost port 10000echo_client: sending b'This is the message. 'echo_client: sending b'It will be sent 'echo_client: sending b'in parts.'echo_client: waiting for responseecho_client: received b'This is the message. It will be sent in parts.'echo_client: closingmain: closing event loop è™½ç„¶å®¢æˆ·ç«¯æ€»æ˜¯å•ç‹¬å‘é€æ¶ˆæ¯ï¼Œä½†å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ”¶åˆ°ä¸€æ¡å¤§æ¶ˆæ¯ï¼Œå¹¶å°†è¯¥æ¶ˆæ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ ¹æ®ç½‘ç»œçš„ç¹å¿™ç¨‹åº¦ä»¥åŠæ˜¯å¦åœ¨å‡†å¤‡æ‰€æœ‰æ•°æ®ä¹‹å‰åˆ·æ–°ç½‘ç»œç¼“å†²åŒºï¼Œè¿™äº›ç»“æœåœ¨åç»­è¿è¡Œä¸­ä¼šæœ‰æ‰€ä¸åŒï¼š 123456asyncio: Using selector: SelectSelectormain: starting up on localhost port 10000echo_::1_11075: connection acceptedecho_::1_11075: received b'This is the message. It will be sent in parts.'echo_::1_11075: sent b'This is the message. It will be sent in parts.'echo_::1_11075: closing 123456echo_::1_11200: connection acceptedecho_::1_11200: received b'This is the message. It will be sent 'echo_::1_11200: sent b'This is the message. It will be sent 'echo_::1_11200: received b'in parts.'echo_::1_11200: sent b'in parts.'echo_::1_11200: closing ä¸å­è¿›ç¨‹åä½œ ä¸ºäº†åˆ©ç”¨ç°æœ‰ä»£ç è€Œä¸é‡å†™ï¼Œæˆ–è€…è®¿é—® Python ä¸­ä¸å¯ç”¨çš„åº“æˆ–åŠŸèƒ½ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä½¿ç”¨å…¶ä»–ç¨‹åºæˆ–è¿›ç¨‹ã€‚ä¸ç½‘ç»œ I / O ä¸€æ ·ï¼Œasyncio åŒ…æ‹¬ä¸¤ä¸ªæŠ½è±¡ï¼Œç”¨äºå¯åŠ¨å¦ä¸€ä¸ªç¨‹åºï¼Œç„¶åä¸å®ƒäº¤äº’ã€‚ ä½¿ç”¨å­è¿›ç¨‹çš„ Protocol æŠ½è±¡ è¿™ä¸ªä¾‹å­ä½¿ç”¨åç¨‹å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œ Unix å‘½ä»¤ dfï¼Œä»¥ä¾¿æŸ¥çœ‹åœ¨æœ¬åœ°ç£ç›˜ä¸Šçš„å¯ç”¨ç©ºé—´ã€‚å®ƒä½¿ç”¨ subprocess_exec() å¯åŠ¨è¿›ç¨‹ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°çŸ¥é“å¦‚ä½•è¯»å– df å‘½ä»¤è¾“å‡ºå¹¶å¯¹å…¶è¿›è¡Œåˆ†æçš„ Protocol ç±»ã€‚Protocol ç±»çš„æ–¹æ³•æ˜¯æ ¹æ®å­è¿›ç¨‹çš„ I / O äº‹ä»¶è‡ªåŠ¨è°ƒç”¨çš„ã€‚å› ä¸º stdin å’Œ stderr å‚æ•°éƒ½è®¾ç½®ä¸º Noneï¼Œæ‰€ä»¥è¿™äº›é€šä¿¡é€šé“ä¸ä¼šè¿æ¥åˆ°æ–°è¿›ç¨‹ï¼š 12345678910111213141516171819202122232425import asyncioimport functoolsasync def run_df(loop): print('in run_df') cmd_done = asyncio.Future(loop=loop) factory = functools.partial(DFProtocol, cmd_done) proc = loop.subprocess_exec( factory, 'df', '-hl', stdin=None, stderr=None, ) try: print('launching process') transport, protocol = await proc print('waiting for process to complete') await cmd_done finally: transport.close() return cmd_done.result() ç±» DFProtocol ç»§æ‰¿è‡ª SubprocessProtocolï¼Œè¯¥ Protocol å®šä¹‰äº†ç±»é€šè¿‡ç®¡é“ä¸å¦ä¸€è¿›ç¨‹é€šä¿¡çš„ APIã€‚done å‚æ•°æ˜¯è°ƒç”¨è€…ç”¨æ¥ç›‘è§†è¿›ç¨‹æ˜¯å¦å®Œæˆçš„ futureï¼š 12345678class DFProtocol(asyncio.SubprocessProtocol): FD_NAMES = ['stdin', 'stdout', 'stderr'] def __init__(self, done_future): self.done = done_future self.buffer = bytearray() super().__init__() ä¸ socket é€šä¿¡ä¸€æ ·ï¼Œåœ¨è®¾ç½®æ–°è¿›ç¨‹çš„è¾“å…¥é€šé“æ—¶è°ƒç”¨ connection_made()ã€‚transport å‚æ•°æ˜¯ BaseSubprocessTransport å­ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚å¦‚æœè¿›ç¨‹è¢«é…ç½®ä¸ºæ¥æ”¶è¾“å…¥ï¼Œåˆ™å®ƒå¯ä»¥è¯»å–è¿›ç¨‹è¾“å‡ºçš„æ•°æ®å¹¶å°†æ•°æ®å†™å…¥è¿›ç¨‹çš„è¾“å…¥æµï¼š 123def connection_made(self, transport): print(f'process started &#123;transport.get_pid()&#125;') self.transport = transport å½“è¿›ç¨‹ç”Ÿæˆè¾“å‡ºæ—¶ï¼Œpipe_data_received() å°†ä½¿ç”¨å‘é€æ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦å’Œä»ç®¡é“è¯»å–çš„å®é™…æ•°æ®ä½œä¸ºå‚æ•°è°ƒç”¨ã€‚Protocolç±»å°†è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºé€šé“çš„è¾“å‡ºä¿å­˜åœ¨ç¼“å†²åŒºä¸­ï¼Œä»¥ä¾›ä»¥åå¤„ç†ï¼š 1234def pipe_data_received(self, fd, data): print(f'read &#123;len(data)&#125; bytes from &#123;self.FD_NAMES[fd]&#125;') if fd == 1: self.buffer.extend(data) å½“è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œprocess_exited() å°†è¢«è°ƒç”¨ã€‚é€šè¿‡è°ƒç”¨ get_returncode() å¯ä»¥ä» transport å¯¹è±¡è·å¾—è¿›ç¨‹çš„é€€å‡ºä»£ç ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æŠ¥å‘Šé”™è¯¯ï¼Œåˆ™å¯ä»¥åœ¨é€šè¿‡ future å®ä¾‹è¿”å›å¯ç”¨è¾“å‡ºä¹‹å‰å¯¹å…¶è¿›è¡Œè§£ç å’Œåˆ†æã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œåˆ™ç»“æœä¸ºç©ºã€‚è®¾ç½® future çš„ç»“æœä¼šå‘Šè¯‰ run_df() è¿›ç¨‹å·²é€€å‡ºï¼Œå› æ­¤å®ƒä¼šæ¸…ç†å¹¶è¿”å›ç»“æœï¼š 12345678910def process_exited(self): print('process exited') return_code = self.transport.get_returncode() print(f'return code &#123;return_code&#125;') if not return_code: cmd_output = bytes(self.buffer).decode() results = self._parse_results(cmd_output) else: results = [] self.done.set_result((return_code, results)) å‘½ä»¤çš„è¾“å‡ºè¢«è§£ææˆä¸€ç³»åˆ—å­—å…¸ï¼Œå°†æ¯è¡Œè¾“å‡ºçš„æ ‡é¢˜åç§°æ˜ å°„åˆ°å€¼ï¼Œå¹¶è¿”å›ç»“æœåˆ—è¡¨ï¼š 123456789def _parse_results(self, output): print('parsing results') if not output: return [] lines = output.splitlines() headers = lines[0].split() devices = lines[1:] results = [dict(zip(headers, line.split())) for line in devices] return results run_df() åç¨‹ä½¿ç”¨ run_until_complete() è¿è¡Œï¼Œç„¶åæ£€æŸ¥ç»“æœå¹¶æ‰“å°æ¯ä¸ªè®¾å¤‡ä¸Šçš„å¯ç”¨ç©ºé—´ï¼š 123456789101112event_loop = asyncio.get_event_loop()try: return_code, results = event_loop.run_until_complete(run_df(event_loop))finally: event_loop.close()if return_code: print(f'error exit &#123;return_code&#125;')else: print('\\nFree space:') for r in results: print(f'&#123;r[\"Mounted\"]:25&#125;: &#123;r[\"Avail\"]&#125;') ä¸‹é¢çš„è¾“å‡ºæ˜¾ç¤ºäº†æ‰§è¡Œæ­¥éª¤çš„é¡ºåºï¼Œä»¥åŠç³»ç»Ÿä¸­é©±åŠ¨å™¨çš„å¯ç”¨ç©ºé—´ï¼š 123456789101112in run_dflaunching processprocess started 6170waiting for process to completeread 375 bytes from stdoutprocess exitedreturn code 0parsing resultsFree space:/ : 41G... ç”¨åç¨‹å’Œæµè°ƒç”¨å­è¿›ç¨‹ è‹¥è¦ä½¿ç”¨åç¨‹ç›´æ¥è¿è¡Œè¿›ç¨‹ï¼Œè€Œä¸æ˜¯é€šè¿‡ Protocol å­ç±»è®¿é—®è¿›ç¨‹ï¼Œè¯·è°ƒç”¨ create_subprocess_exec()ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªè¿æ¥åˆ°ç®¡é“çš„æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯å’Œæ ‡å‡†è¾“å…¥ã€‚äº§ç”Ÿå­è¿›ç¨‹çš„åç¨‹çš„ç»“æœæ˜¯ä¸€ä¸ª Process å®ä¾‹ï¼Œå¯ç”¨äºæ“ä½œå­è¿›ç¨‹æˆ–ä¸å…¶é€šä¿¡ï¼š 1234567891011121314151617import asyncioimport asyncio.subprocessasync def run_df(): print('in run_df') buffer = bytearray() create = asyncio.create_subprocess_exec( 'df', '-hl', stdout=asyncio.subprocess.PIPE, ) print('launching process') proc = await create print(f'process started &#123;proc.pid&#125;') åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œdf é™¤äº†å‘½ä»¤è¡Œå‚æ•°ä¹‹å¤–ä¸éœ€è¦ä»»ä½•è¾“å…¥ï¼Œå› æ­¤ä¸‹ä¸€æ­¥æ˜¯è¯»å–æ‰€æœ‰è¾“å‡ºã€‚å¯¹äº Protocolï¼Œæ— æ³•æ§åˆ¶ä¸€æ¬¡è¯»å–å¤šå°‘æ•°æ®ã€‚è¿™ä¸ªä¾‹å­ä¸­ä½¿ç”¨äº† readline()ï¼Œä½†ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ read() è¯»å–ä¸æ˜¯æŒ‰è¡Œç»„ç»‡çš„æ•°æ®ã€‚å‘½ä»¤çš„è¾“å‡ºè¢«ç¼“å†²ï¼Œå°±åƒ Protocol ç¤ºä¾‹ä¸€æ ·ï¼Œå› æ­¤ç¨åå¯ä»¥å¯¹å…¶è¿›è¡Œåˆ†æï¼š 1234567while True: line = await proc.stdout.readline() print(f'read &#123;line!r&#125;') if not line: print('no more output from command') break buffer.extend(line) readline() æ–¹æ³•åœ¨ç¨‹åºå·²å®Œæˆä¸å†æœ‰è¾“å‡ºæ—¶è¿”å›ç©ºå­—èŠ‚ä¸²ã€‚ä¸ºç¡®ä¿æ­£ç¡®æ¸…é™¤è¿›ç¨‹ï¼Œä¸‹ä¸€æ­¥æ˜¯ç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡ºï¼š 12print('waiting for process to complete')await proc.wait() æ­¤æ—¶å¯ä»¥æ£€æŸ¥é€€å‡ºçŠ¶æ€ï¼Œä»¥ç¡®å®šæ˜¯è§£æè¾“å‡ºè¿˜æ˜¯å°†é”™è¯¯è§†ä¸ºæœªç”Ÿæˆè¾“å‡ºã€‚è§£æé€»è¾‘ä¸å‰é¢çš„ç¤ºä¾‹ç›¸åŒï¼Œä½†å¤„äºç‹¬ç«‹å‡½æ•°ä¸­ï¼Œå› ä¸ºæ²¡æœ‰å¯ä»¥åŒ…è£…å®ƒçš„ Protocol ç±»ã€‚è§£ææ•°æ®åï¼Œç»“æœå’Œé€€å‡ºä»£ç å°†è¿”å›ç»™è°ƒç”¨æ–¹ï¼š 123456789return_code = proc.returncodeprint(f'return code &#123;return_code&#125;')if not return_code: cmd_output = bytes(buffer).decode() results = _parse_results(cmd_output)else: results = []return (return_code, results) ä¸»ç¨‹åºçœ‹èµ·æ¥ç±»ä¼¼äºåŸºäº Protocol çš„ç¤ºä¾‹ï¼Œå› ä¸ºå®ç°çš„æ”¹å˜è¢«éš”ç¦»åœ¨ run_df() ä¸­ï¼š 123456789101112event_loop = asyncio.get_event_loop()try: return_code, results = event_loop.run_until_complete(run_df())finally: event_loop.close()if return_code: print(f'error exit &#123;return_code&#125;')else: print('\\nFree space:') for r in results: print(f'&#123;r[\"Mounted\"]:25&#125;: &#123;r[\"Avail\"]&#125;') ç”±äº df çš„è¾“å‡ºå¯ä»¥ä¸€æ¬¡è¯»å–ä¸€è¡Œï¼Œå› æ­¤å®ƒå°†æ˜¾ç¤ºç¨‹åºçš„è¿›åº¦ã€‚å¦åˆ™ï¼Œè¾“å‡ºçœ‹èµ·æ¥ä¸å‰é¢çš„ç¤ºä¾‹ç±»ä¼¼ï¼š 123456789101112131415in run_dflaunching processprocess started 7354read b'Filesystem Size Used Avail Use% Mounted on\\n'read b'/dev/vda1 50G 6.0G 41G 13% /\\n'...read b''no more output from commandwaiting for process to completereturn code 0parsing resultsFree space:/ : 41G... å‘å­è¿›ç¨‹å‘é€æ•°æ® å‰é¢çš„ä¸¤ä¸ªç¤ºä¾‹éƒ½ä»…ä½¿ç”¨å•ä¸ªé€šä¿¡ä¿¡é“æ¥ä»å­è¿›ç¨‹è¯»å–æ•°æ®ã€‚é€šå¸¸éœ€è¦å°†æ•°æ®å‘é€åˆ°å‘½ä»¤ä¸­è¿›è¡Œå¤„ç†ã€‚ä¸‹é¢å°†å®šä¹‰ä¸€ä¸ªåç¨‹ï¼Œç”¨äºæ‰§è¡Œ Unix å‘½ä»¤ tr ä»¥è½¬æ¢å…¶è¾“å…¥æµä¸­çš„å­—ç¬¦ã€‚è¿™ä¸ªä¾‹å­ä¸­tr ç”¨äºå°†å°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯ã€‚ to_upper() åç¨‹å°†è¾“å…¥å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ã€‚å®ƒäº§ç”Ÿè¿è¡Œ tr [:lower:] [:upper:] çš„å­è¿›ç¨‹ï¼š 1234567891011121314151617import asyncioimport asyncio.subprocessasync def to_upper(input): print('in to_upper') create = asyncio.create_subprocess_exec( 'tr', '[:lower:]', '[:upper:]', stdout=asyncio.subprocess.PIPE, stdin=asyncio.subprocess.PIPE, ) print('launching process') proc = await create print(f'pid &#123;proc.pid&#125;') æ¥ä¸‹æ¥ to_upper() ä½¿ç”¨ Process çš„ communicate() æ–¹æ³•å°†è¾“å…¥å­—ç¬¦ä¸²å‘é€åˆ°å‘½ä»¤ï¼Œå¹¶å¼‚æ­¥è¯»å–æ‰€æœ‰ç”Ÿæˆçš„è¾“å‡ºã€‚ä¸ subprocess.Popen ç‰ˆæœ¬çš„æ–¹æ³•ç›¸åŒï¼Œcommunicate() è¿”å›å®Œæ•´çš„è¾“å‡ºå­—èŠ‚ä¸²ã€‚å¦‚æœä¸€ä¸ªå‘½ä»¤å¯èƒ½äº§ç”Ÿçš„æ•°æ®è¶…å‡ºäº†å¯ä»¥å……è£•çš„æ”¾å…¥å†…å­˜çš„èŒƒå›´ï¼Œæˆ–è€…æ— æ³•ä¸€æ¬¡äº§ç”Ÿè¾“å…¥ï¼Œæˆ–è€…å¿…é¡»å¢é‡å¤„ç†è¾“å‡ºï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨è¿›ç¨‹çš„ stdinã€stdout å’Œ stderr å¥æŸ„ï¼Œè€Œä¸æ˜¯è°ƒç”¨ communicate() ï¼š 12print('communicating with process')stdout, stderr = await proc.communicate(input.encode()) I / O å®Œæˆåï¼Œç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡ºå¯ç¡®ä¿è¿›ç¨‹å¾—åˆ°æ­£ç¡®æ¸…ç†ï¼š 12print('waiting for process to complete')await proc.wait() ç„¶åå¯ä»¥æ£€æŸ¥è¿”å›ä»£ç ï¼Œå¹¶å¯¹è¾“å‡ºå­—èŠ‚ä¸²è¿›è¡Œè§£ç ï¼Œä»¥å‡†å¤‡åç¨‹çš„è¿”å›å€¼ï¼š 12345678return_code = proc.returncodeprint(f'return code &#123;return_code&#125;')if not return_code: results = bytes(stdout).decode()else: results = ''return (return_code, results) ç¨‹åºçš„ä¸»è¦éƒ¨åˆ†æ„å»ºè¦è½¬æ¢çš„æ¶ˆæ¯å­—ç¬¦ä¸²ï¼Œç„¶åè®¾ç½®äº‹ä»¶å¾ªç¯ä»¥è¿è¡Œ to_upper() å¹¶æ‰“å°ç»“æœï¼š 12345678910111213141516MESSAGE = \"\"\"This message will be convertedto all caps.\"\"\"event_loop = asyncio.get_event_loop()try: return_code, results = event_loop.run_until_complete(to_upper(MESSAGE))finally: event_loop.close()if return_code: print(f'error exit &#123;return_code&#125;')else: print(f'Original: &#123;MESSAGE!r&#125;'.format(MESSAGE)) print(f'Changed : &#123;results!r&#125;') è¾“å‡ºæ˜¾ç¤ºæ“ä½œåºåˆ—ï¼Œç„¶åæ˜¾ç¤ºå¦‚ä½•è½¬æ¢ç®€å•æ–‡æœ¬æ¶ˆæ¯ï¼š 12345678in to_upperlaunching processpid 12428communicating with processwaiting for process to completereturn code 0Original: '\\nThis message will be converted\\nto all caps.\\n'Changed : '\\nTHIS MESSAGE WILL BE CONVERTED\\nTO ALL CAPS.\\n' æ¥æ”¶ Unix ä¿¡å· UNIX ç³»ç»Ÿäº‹ä»¶é€šçŸ¥é€šå¸¸ä¼šä¸­æ–­åº”ç”¨ç¨‹åºï¼Œä»è€Œè§¦å‘å…¶å¤„ç†ç¨‹åºã€‚å½“ä¸ asyncio ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œä¿¡å·å¤„ç†ç¨‹åºå›è°ƒä¸äº‹ä»¶å¾ªç¯ç®¡ç†çš„å…¶ä»–åç¨‹å’Œå›è°ƒäº¤é”™æ‰§è¡Œã€‚è¿™å¯¼è‡´ä¸­æ–­å‡½æ•°è¾ƒå°‘ï¼Œå› æ­¤éœ€è¦æä¾›å®‰å…¨é˜²æŠ¤æ¥æ¸…ç†ä¸å®Œæ•´çš„æ“ä½œã€‚ ä¿¡å·å¤„ç†ç¨‹åºå¿…é¡»æ˜¯å¸¸è§„çš„å¯è°ƒç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯åç¨‹ï¼š 12345678import asyncioimport functoolsimport osimport signaldef signal_handler(name): print(f'signal_handler(&#123;name!r&#125;)') ä¿¡å·å¤„ç†ç¨‹åºæ˜¯ä½¿ç”¨ add_signal_handler() æ³¨å†Œçš„ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¿¡å·ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å›è°ƒã€‚å›è°ƒä¸ä¼ é€’å‚æ•°ï¼Œå› æ­¤å¦‚æœéœ€è¦å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ functools.partical() åŒ…è£…å‡½æ•°ï¼š 12345678910111213event_loop = asyncio.get_event_loop()event_loop.add_signal_handler( signal.SIGHUP, functools.partial(signal_handler, name='SIGHUP'),)event_loop.add_signal_handler( signal.SIGUSR1, functools.partial(signal_handler, name='SIGUSR1'),)event_loop.add_signal_handler( signal.SIGINT, functools.partial(signal_handler, name='SIGINT'),) æœ¬ç¤ºä¾‹ç¨‹åºä½¿ç”¨åç¨‹é€šè¿‡ os.kill() å‘è‡ªèº«å‘é€ä¿¡å·ã€‚åœ¨å‘é€æ¯ä¸ªä¿¡å·ä¹‹åï¼Œåç¨‹å°†è®©å‡ºæ§åˆ¶æƒä»¥å…è®¸å¤„ç†ç¨‹åºæ‰§è¡Œã€‚åœ¨ä¸€ä¸ªæ­£å¸¸çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¼šæœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºä»£ç è®©æ­¥ç»™äº‹ä»¶å¾ªç¯çš„åœ°æ–¹ï¼Œè€Œä¸éœ€è¦è¿™æ ·çš„äººå·¥è®©æ­¥ï¼š 12345678910async def send_signals(): pid = os.getpid() print(f'starting send_signals for &#123;pid&#125;') for name in ['SIGHUP', 'SIGHUP', 'SIGUSR1', 'SIGINT']: print(f'sending &#123;name&#125;') os.kill(pid, getattr(signal, name)) print('yielding control') await asyncio.sleep(0.01) return ä¸»ç¨‹åºè¿è¡Œ send_signals()ï¼Œç›´åˆ°å®ƒå‘é€å®Œæ‰€æœ‰ä¿¡å·ï¼š 1234try: event_loop.run_until_complete(send_signals())finally: event_loop.close() è¾“å‡ºæ˜¾ç¤ºå½“ send_signals() åœ¨å‘é€ä¿¡å·åè®©å‡ºæ§åˆ¶æ—¶å¦‚ä½•è°ƒç”¨å¤„ç†ç¨‹åºï¼š 12345678910111213starting send_signals for 23185sending SIGHUPyielding controlsignal_handler('SIGHUP')sending SIGHUPyielding controlsignal_handler('SIGHUP')sending SIGUSR1yielding controlsignal_handler('SIGUSR1')sending SIGINTyielding controlsignal_handler('SIGINT') å°†åç¨‹ä¸çº¿ç¨‹å’Œè¿›ç¨‹ç›¸ç»“åˆ è®¸å¤šç°æœ‰åº“å°šæœªå‡†å¤‡å¥½ä¸ asyncio é…åˆä½¿ç”¨ã€‚å®ƒä»¬å¯èƒ½ä¼šé˜»å¡æˆ–ä¾èµ–æ¨¡å—ä¸­ä¸å¯ç”¨çš„å¹¶å‘åŠŸèƒ½ã€‚é€šè¿‡ä½¿ç”¨æ¥è‡ª concurrent.futures çš„ executor åœ¨å•ç‹¬çš„çº¿ç¨‹æˆ–å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œä»£ç ï¼Œä»ç„¶å¯ä»¥åœ¨åŸºäº asyncio çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¿™äº›åº“ã€‚ çº¿ç¨‹ äº‹ä»¶å¾ªç¯çš„ run_in_executor() æ–¹æ³•æ¥å—çš„å‚æ•°ä¸º executor å®ä¾‹ï¼Œè¦è°ƒç”¨çš„å¸¸è§„å¯è°ƒç”¨å¯¹è±¡ä»¥åŠè¦ä¼ é€’ç»™å¯è°ƒç”¨å¯¹è±¡çš„ä»»ä½•å‚æ•°ã€‚å®ƒè¿”å›ä¸€ä¸ªå¯ç”¨äºç­‰å¾…å‡½æ•°å®Œæˆå…¶å·¥ä½œå¹¶è¿”å›æŸäº›å†…å®¹çš„ futureã€‚å¦‚æœæ²¡æœ‰ä¼ å…¥ executorï¼Œåˆ™ä¼šåˆ›å»º ThreadPoolExecutorã€‚æ­¤ç¤ºä¾‹æ˜¾å¼åˆ›å»ºä¸€ä¸ª executorï¼Œä»¥é™åˆ¶å¯ç”¨çš„å·¥ä½œçº¿ç¨‹æ•°ã€‚ ThreadPoolExecutorå¯åŠ¨å…¶å·¥ä½œçº¿ç¨‹ï¼Œç„¶ååœ¨çº¿ç¨‹ä¸­è°ƒç”¨æ¯ä¸ªæä¾›çš„å‡½æ•°ä¸€æ¬¡ã€‚æ­¤ç¤ºä¾‹è¯´æ˜å¦‚ä½•å°† run_in_executor() å’Œ wait() ç»„åˆèµ·æ¥ï¼Œä»¥ä¾¿åœ¨é˜»å¡å•ç‹¬çº¿ç¨‹ä¸­è¿è¡Œçš„å‡½æ•°çš„åŒæ—¶ï¼Œå¯¹äº‹ä»¶å¾ªç¯å…·æœ‰åç¨‹è®©æ­¥æ§åˆ¶ï¼Œç„¶ååœ¨è¿™äº›å‡½æ•°å®Œæˆæ—¶å°†å…¶å”¤é†’ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344import asyncioimport concurrent.futuresimport loggingimport sysimport timedef blocks(n): log = logging.getLogger(f'blocks(&#123;n&#125;)') log.info('running') time.sleep(0.1) log.info('done') return n**2async def run_blocking_tasks(executor): log = logging.getLogger('run_blocking_tasks') log.info('starting') log.info('creating executor tasks') loop = asyncio.get_event_loop() blocking_tasks = [loop.run_in_executor(executor, blocks, i) for i in range(6)] log.info('waiting for executor tasks') completed, pending = await asyncio.wait(blocking_tasks) results = [t.result() for t in completed] log.info(f'results: &#123;results!r&#125;') log.info('exiting')if __name__ == '__main__': logging.basicConfig( level=logging.INFO, format='%(threadName)10s %(name)18s: %(message)s', stream=sys.stderr, ) executor = concurrent.futures.ThreadPoolExecutor(max_workers=3,) event_loop = asyncio.get_event_loop() try: event_loop.run_until_complete(run_blocking_tasks(executor)) finally: event_loop.close() è¿™ä¸ªç¨‹åºä½¿ç”¨ logging æ¥æ–¹ä¾¿åœ°æŒ‡ç¤ºå“ªäº›çº¿ç¨‹å’Œå‡½æ•°æ­£åœ¨ç”Ÿæˆçš„æ—¥å¿—æ¶ˆæ¯ã€‚å› ä¸ºæ¯æ¬¡è°ƒç”¨ blocks() æ—¶ä½¿ç”¨å•ç‹¬çš„ Loggerï¼Œæ‰€ä»¥è¾“å‡ºæ¸…æ¥šåœ°æ˜¾ç¤ºäº†ç›¸åŒçš„çº¿ç¨‹è¢«é‡ç”¨ï¼Œä»¥è°ƒç”¨å…·æœ‰ä¸åŒå‚æ•°çš„å‡½æ•°çš„å¤šä¸ªå‰¯æœ¬ï¼š 1234567891011121314151617MainThread run_blocking_tasks: startingMainThread run_blocking_tasks: creating executor tasksThreadPoolExecutor-0_0 blocks(0): runningThreadPoolExecutor-0_1 blocks(1): runningThreadPoolExecutor-0_2 blocks(2): runningMainThread run_blocking_tasks: waiting for executor tasksThreadPoolExecutor-0_0 blocks(0): doneThreadPoolExecutor-0_0 blocks(3): runningThreadPoolExecutor-0_1 blocks(1): doneThreadPoolExecutor-0_2 blocks(2): doneThreadPoolExecutor-0_1 blocks(4): runningThreadPoolExecutor-0_2 blocks(5): runningThreadPoolExecutor-0_0 blocks(3): doneThreadPoolExecutor-0_1 blocks(4): doneThreadPoolExecutor-0_2 blocks(5): doneMainThread run_blocking_tasks: results: [16, 25, 1, 4, 0, 9]MainThread run_blocking_tasks: exiting è¿›ç¨‹ ProcessPoolExecutor çš„å·¥ä½œæ–¹å¼å¤§è‡´ç›¸åŒï¼Œå®ƒåˆ›å»ºä¸€ç»„å·¥ä½œè¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ã€‚ä½¿ç”¨å•ç‹¬çš„è¿›ç¨‹éœ€è¦æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œä½†æ˜¯å¯¹äºè®¡ç®—å¯†é›†å‹æ“ä½œï¼Œåœ¨æ¯ä¸ª CPU å†…æ ¸ä¸Šè¿è¡Œå•ç‹¬çš„ä»»åŠ¡æ˜¯æœ‰æ„ä¹‰çš„ï¼š 12345678910111213141516...if __name__ == '__main__': logging.basicConfig( level=logging.INFO, format='PID %(process)5s %(name)18s: %(message)s', stream=sys.stderr, ) executor = concurrent.futures.ProcessPoolExecutor(max_workers=3,) event_loop = asyncio.get_event_loop() try: event_loop.run_until_complete(run_blocking_tasks(executor)) finally: event_loop.close() ä»çº¿ç¨‹è½¬ç§»åˆ°è¿›ç¨‹æ‰€éœ€çš„å”¯ä¸€æ›´æ”¹æ˜¯åˆ›å»ºä¸åŒç±»å‹çš„ executorã€‚æœ¬ç¤ºä¾‹è¿˜å°†æ—¥å¿—è®°å½•æ ¼å¼æ›´æ”¹ä¸ºåŒ…å«è¿›ç¨‹ id è€Œä¸æ˜¯çº¿ç¨‹åç§°ï¼Œä»¥è¯æ˜ä»»åŠ¡å®é™…ä¸Šæ­£åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œï¼š 1234567891011121314151617PID 24417 run_blocking_tasks: startingPID 24417 run_blocking_tasks: creating executor tasksPID 24417 run_blocking_tasks: waiting for executor tasksPID 24461 blocks(0): runningPID 24460 blocks(1): runningPID 24459 blocks(2): runningPID 24460 blocks(1): donePID 24459 blocks(2): donePID 24460 blocks(3): runningPID 24461 blocks(0): donePID 24459 blocks(4): runningPID 24461 blocks(5): runningPID 24460 blocks(3): donePID 24459 blocks(4): donePID 24461 blocks(5): donePID 24417 run_blocking_tasks: results: [16, 1, 25, 0, 4, 9]PID 24417 run_blocking_tasks: exiting è°ƒè¯• asyncio å†…ç½®äº†å‡ ä¸ªæœ‰ç”¨çš„è°ƒè¯•åŠŸèƒ½ã€‚ é¦–å…ˆï¼Œäº‹ä»¶å¾ªç¯ä½¿ç”¨ logging åœ¨è¿è¡Œæ—¶å‘å‡ºçŠ¶æ€æ¶ˆæ¯ã€‚å¦‚æœåœ¨åº”ç”¨ç¨‹åºä¸­å¯ç”¨äº†æ—¥å¿—è®°å½•ï¼Œåˆ™å…¶ä¸­ä¸€äº›æ˜¯å¯ç”¨çš„ã€‚å…¶ä»–çš„å¯ä»¥é€šè¿‡å‘Šè¯‰å¾ªç¯å‘å‡ºæ›´å¤šè°ƒè¯•æ¶ˆæ¯æ¥æ‰“å¼€ã€‚è°ƒç”¨ set_debug()ï¼Œä¼ é€’ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦åº”å¯ç”¨è°ƒè¯•ã€‚ ç”±äºåŸºäº asyncio æ„å»ºçš„åº”ç”¨ç¨‹åºå¯¹æ— æ³•è®©å‡ºæ§åˆ¶çš„â€œè´ªå©ªâ€åç¨‹éå¸¸æ•æ„Ÿï¼Œå› æ­¤æ”¯æŒæ£€æµ‹äº‹ä»¶å¾ªç¯ä¸­çš„ç¼“æ…¢å›è°ƒã€‚é€šè¿‡å¯ç”¨è°ƒè¯•å°†å…¶æ‰“å¼€ï¼Œå¹¶é€šè¿‡å°†å¾ªç¯çš„ slow_callback_duration å±æ€§è®¾ç½®ä¸ºåº”å‘å‡ºè­¦å‘Šçš„ç§’æ•°æ¥å®šä¹‰ â€œç¼“æ…¢â€ã€‚ æœ€åï¼Œå¦‚æœä½¿ç”¨ asyncio çš„åº”ç”¨ç¨‹åºåœ¨ä¸æ¸…ç†æŸäº›åç¨‹æˆ–å…¶ä»–èµ„æºçš„æƒ…å†µä¸‹é€€å‡ºï¼Œè¿™å¯èƒ½æ„å‘³ç€å­˜åœ¨é€»è¾‘é”™è¯¯ï¼Œæ— æ³•è¿è¡ŒæŸäº›åº”ç”¨ç¨‹åºä»£ç ã€‚å¯ç”¨ ResourceWarning è­¦å‘Šä¼šåœ¨ç¨‹åºé€€å‡ºæ—¶æŠ¥å‘Šè¿™äº›æƒ…å†µï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import argparseimport asyncioimport loggingimport sysimport timeimport warningsparser = argparse.ArgumentParser('debugging asyncio')parser.add_argument( '-v', dest='verbose', default=False, action='store_true',)args = parser.parse_args()logging.basicConfig( level=logging.DEBUG, format='%(levelname)7s: %(message)s', stream=sys.stderr,)LOG = logging.getLogger('')async def inner(): LOG.info('inner starting') # æ¨¡æ‹Ÿç¼“æ…¢çš„ä»»åŠ¡ time.sleep(0.1) LOG.info('inner completed')async def outer(loop): LOG.info('outer starting') await asyncio.ensure_future(loop.create_task(inner())) LOG.info('outer completed')event_loop = asyncio.get_event_loop()if args.verbose: LOG.info('enabling debugging') # å¯ç”¨è°ƒè¯• event_loop.set_debug(True) # å®šä¹‰ä¸€ä¸ªå¾ˆå°é˜ˆå€¼è¡¨ç¤ºâ€œç¼“æ…¢â€ event_loop.slow_callback_duration = 0.001 # æŠ¥å‘Šç®¡ç†å¼‚æ­¥èµ„æºçš„æ‰€æœ‰é”™è¯¯ warnings.simplefilter('always', ResourceWarning)LOG.info('entering event loop')event_loop.run_until_complete(outer(event_loop)) åœ¨æœªå¯ç”¨è°ƒè¯•çš„æƒ…å†µä¸‹è¿è¡Œæ—¶ï¼Œæ­¤åº”ç”¨ç¨‹åºçš„æ‰€æœ‰å†…å®¹çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼š 123456DEBUG: Using selector: SelectSelector INFO: entering event loop INFO: outer starting INFO: inner starting INFO: inner completed INFO: outer completed å¼€å¯è°ƒè¯•ä¼šæš´éœ²å‡ºä¸€äº›é—®é¢˜ï¼ŒåŒ…æ‹¬ inner() å®Œæˆæ‰€èŠ±çš„æ—¶é—´æ¯”è®¾å®šçš„ slow_callback_duration è¿˜è¦é•¿ï¼Œè€Œä¸”å½“ç¨‹åºç»“æŸæ—¶ï¼Œäº‹ä»¶å¾ªç¯å¹¶æœªæ­£ç¡®å…³é—­ï¼š 12345678 DEBUG: Using selector: SelectSelector INFO: enabling debugging INFO: entering event loop INFO: outer starting INFO: inner starting INFO: inner completedWARNING: Executing &lt;Task finished coro=&lt;inner() done, defined at *.py:25&gt; result=None created at *.py:33&gt; took 0.093 seconds INFO: outer completed","categories":[],"tags":[]},{"title":"Kafkaåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ-1","slug":"2018-05-07/SpringBoot-integration-with-Kafka-1","date":"2018-05-07T10:13:02.000Z","updated":"2018-08-12T09:51:01.075Z","comments":true,"path":"posts/6e26f2f1/","link":"","permalink":"http://weafteam.github.io/posts/6e26f2f1/","excerpt":"","text":"ä¸€ã€ç®€ä»‹ ä¹‹å‰æˆ‘è®²è¿‡å…³äºSpringBootæ•´åˆKafkaçš„demo,ä½†æ˜¯åæ¥ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œè¶Šæ¥ä¸å‘ç°è¿™ä¸ªå·²ç»ä¸èƒ½é€‚åˆæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„ç¯å¢ƒäº†ã€‚ ä¹‹å‰æ˜¯ç®€å•çš„å‘é€æ¶ˆæ¯è€Œå·²ï¼Œè€Œç°åœ¨æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªé«˜ååé‡çš„webä¸­é—´ä»¶ã€‚ ç°åœ¨æ¯ç§’å¤§æ¦‚èƒ½å‘é€1000æ¡å·¦å³çš„æ•°æ®ï¼Œä½†æ˜¯æ¥å—è¿™è¾¹å¹¶ä¸èƒ½æ‰¿å—è¿™ä¹ˆé«˜çš„ååé‡ï¼Œå¯¼è‡´kafkaæ¶ˆæ¯å †ç§¯ï¼Œæ¶ˆæ¯å †ç§¯çš„è¶Šæ¥è¶Šå¤šã€‚ æ°å·§æˆ‘ä»¬çš„äº§å“æ‰€éœ€è¦çš„æ•°æ®å®æ—¶æ€§éå¸¸é«˜ã€‚æ‰€ä»¥è¿™ä¸å¾—ä»¥æˆ‘è¦æ”¹è¿›æˆ‘è¯»çš„é€Ÿåº¦ã€‚ äºŒã€å…¥é—¨ ç®€å•ä»‹ç»ä¸€ç‚¹ç›¸å…³çš„æ¦‚å¿µ 2.1 æ¶ˆè´¹æ¶ˆæ¯åŸºæœ¬æµç¨‹ Kafka è®¢é˜…è€…åœ¨è®¢é˜…æ¶ˆæ¯æ—¶çš„åŸºæœ¬æµç¨‹æ˜¯ï¼š Poll æ•°æ® æ‰§è¡Œæ¶ˆè´¹é€»è¾‘ å†æ¬¡ poll æ•°æ® 2.2 è´Ÿè½½å‡è¡¡ æ¯ä¸ª Consumer Group å¯ä»¥åŒ…å«å¤šä¸ªæ¶ˆè´¹å®ä¾‹ï¼Œå³å¯ä»¥å¯åŠ¨å¤šä¸ª Kafka Consumerï¼Œå¹¶æŠŠå‚æ•° group.id è®¾ç½®æˆç›¸åŒçš„å€¼ã€‚å±äºåŒä¸€ä¸ª Consumer Group çš„æ¶ˆè´¹å®ä¾‹ä¼šè´Ÿè½½æ¶ˆè´¹è®¢é˜…çš„ Topicã€‚ ä¸¾ä¾‹ï¼šConsumer Group A è®¢é˜…äº† Topic Aï¼Œå¹¶å¼€å¯ä¸‰ä¸ªæ¶ˆè´¹å®ä¾‹ C1ã€C2ã€C3ï¼Œåˆ™å‘é€åˆ° Topic A çš„æ¯æ¡æ¶ˆæ¯æœ€ç»ˆåªä¼šä¼ ç»™ C1ã€C2ã€C3 çš„æŸä¸€ä¸ªã€‚Kafka é»˜è®¤ä¼šå‡åŒ€åœ°æŠŠæ¶ˆæ¯ä¼ ç»™å„ä¸ªæ¶ˆæ¯å®ä¾‹ï¼Œä»¥åšåˆ°æ¶ˆè´¹è´Ÿè½½å‡è¡¡ã€‚ Kafka è´Ÿè½½æ¶ˆè´¹çš„å†…éƒ¨åŸç†æ˜¯ï¼ŒæŠŠè®¢é˜…çš„ Topic çš„åˆ†åŒºï¼Œå¹³å‡åˆ†é…ç»™å„ä¸ªæ¶ˆè´¹å®ä¾‹ã€‚å› æ­¤ï¼Œæ¶ˆè´¹å®ä¾‹çš„ä¸ªæ•°ä¸è¦å¤§äºåˆ†åŒºçš„æ•°é‡ï¼Œå¦åˆ™ä¼šæœ‰å®ä¾‹åˆ†é…ä¸åˆ°ä»»ä½•åˆ†åŒºè€Œå¤„äºç©ºè·‘çŠ¶æ€ã€‚è¿™ä¸ªè´Ÿè½½å‡è¡¡å‘ç”Ÿçš„æ—¶é—´ï¼Œé™¤äº†ç¬¬ä¸€æ¬¡å¯åŠ¨ä¸Šçº¿ä¹‹å¤–ï¼Œåç»­æ¶ˆè´¹å®ä¾‹å‘ç”Ÿé‡å¯ã€å¢åŠ ã€å‡å°‘ç­‰å˜æ›´æ—¶ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡è´Ÿè½½å‡è¡¡ã€‚ æ¶ˆæ¯é˜Ÿåˆ— Kafka çš„æ¯ä¸ª Topic çš„åˆ†åŒºæ•°é‡é»˜è®¤æ˜¯ 16 ä¸ªï¼Œå·²ç»è¶³å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯çš„éœ€æ±‚ï¼Œä¸”äº‘ä¸ŠæœåŠ¡ä¼šæ ¹æ®å®¹é‡è°ƒæ•´åˆ†åŒºæ•°ã€‚ 2.3 å¤šä¸ªè®¢é˜… ä¸€ä¸ª Consumer Group å¯ä»¥è®¢é˜…å¤šä¸ª Topicã€‚ä¸€ä¸ª Topic ä¹Ÿå¯ä»¥è¢«å¤šä¸ª Consumer Group è®¢é˜…ï¼Œä¸”å„ä¸ª Consumer Group ç‹¬ç«‹æ¶ˆè´¹ Topic ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯ã€‚ ä¸¾ä¾‹ï¼šConsumer Group A è®¢é˜…äº† Topic Aï¼ŒConsumer Group B ä¹Ÿè®¢é˜…äº† Topic Aï¼Œåˆ™å‘é€åˆ° Topic A çš„æ¯æ¡æ¶ˆæ¯ï¼Œä¸ä»…ä¼šä¼ ä¸€ä»½ç»™ Consumer Group A çš„æ¶ˆè´¹å®ä¾‹ï¼Œä¹Ÿä¼šä¼ ä¸€ä»½ç»™ Consumer Group B çš„æ¶ˆè´¹å®ä¾‹ï¼Œä¸”è¿™ä¸¤ä¸ªè¿‡ç¨‹ç›¸äº’ç‹¬ç«‹ï¼Œç›¸äº’æ²¡æœ‰ä»»ä½•å½±å“ã€‚ ### 2.4 æ¶ˆè´¹ä½ç‚¹ æ¯ä¸ª Topic ä¼šæœ‰å¤šä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºä¼šç»Ÿè®¡å½“å‰æ¶ˆæ¯çš„æ€»æ¡æ•°ï¼Œè¿™ä¸ªç§°ä¸ºæœ€å¤§ä½ç‚¹ MaxOffsetã€‚Kafka Consumer ä¼šæŒ‰é¡ºåºä¾æ¬¡æ¶ˆè´¹åˆ†åŒºå†…çš„æ¯æ¡æ¶ˆæ¯ï¼Œè®°å½•å·²ç»æ¶ˆè´¹äº†çš„æ¶ˆæ¯æ¡æ•°ï¼Œç§°ä¸ºConsumerOffsetã€‚ å‰©ä½™çš„æœªæ¶ˆè´¹çš„æ¡æ•°ï¼ˆä¹Ÿç§°ä¸ºæ¶ˆæ¯å †ç§¯é‡ï¼‰ = MaxOffset - ConsumerOffset 2.5 æ¶ˆè´¹ä½ç‚¹æäº¤ Kafka æ¶ˆè´¹è€…æœ‰ä¸¤ä¸ªç›¸å…³å‚æ•°ï¼š enable.auto.commitï¼šé»˜è®¤å€¼ä¸º trueã€‚ auto.commit.interval.msï¼š é»˜è®¤å€¼ä¸º 1000ï¼Œä¹Ÿå³ 1sã€‚ è¿™ä¸¤ä¸ªå‚æ•°ç»„åˆçš„ç»“æœå°±æ˜¯ï¼Œæ¯æ¬¡ poll æ•°æ®å‰ä¼šå…ˆæ£€æŸ¥ä¸Šæ¬¡æäº¤ä½ç‚¹çš„æ—¶é—´ï¼Œå¦‚æœè·ç¦»å½“å‰æ—¶é—´å·²ç»è¶…è¿‡å‚æ•°auto.commit.interval.msè§„å®šçš„æ—¶é•¿ï¼Œåˆ™å®¢æˆ·ç«¯ä¼šå¯åŠ¨ä½ç‚¹æäº¤åŠ¨ä½œã€‚ å› æ­¤ï¼Œå¦‚æœå°†enable.auto.commitè®¾ç½®ä¸º trueï¼Œåˆ™éœ€è¦åœ¨æ¯æ¬¡ poll æ•°æ®æ—¶ï¼Œç¡®ä¿å‰ä¸€æ¬¡ poll å‡ºæ¥çš„æ•°æ®å·²ç»æ¶ˆè´¹å®Œæ¯•ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ä½ç‚¹è·³è·ƒã€‚ å¦‚æœæƒ³è‡ªå·±æ§åˆ¶ä½ç‚¹æäº¤ï¼Œè¯·æŠŠ enable.auto.commit è®¾ä¸º falseï¼Œå¹¶è°ƒç”¨ commit(offsets)å‡½æ•°è‡ªè¡Œæ§åˆ¶ä½ç‚¹æäº¤ã€‚ 2.6 æ¶ˆæ¯é‡å¤å’Œæ¶ˆè´¹å¹‚ç­‰ Kafka æ¶ˆè´¹çš„è¯­ä¹‰æ˜¯ â€œat least onceâ€ï¼Œ ä¹Ÿå°±æ˜¯è‡³å°‘æŠ•é€’ä¸€æ¬¡ï¼Œä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼Œä½†æ˜¯ä¸ä¼šä¿è¯æ¶ˆæ¯ä¸é‡å¤ã€‚åœ¨å‡ºç°ç½‘ç»œé—®é¢˜ã€å®¢æˆ·ç«¯é‡å¯æ—¶å‡æœ‰å¯èƒ½å‡ºç°å°‘é‡é‡å¤æ¶ˆæ¯ï¼Œæ­¤æ—¶åº”ç”¨æ¶ˆè´¹ç«¯å¦‚æœå¯¹æ¶ˆæ¯é‡å¤æ¯”è¾ƒæ•æ„Ÿï¼ˆæ¯”å¦‚è¯´è®¢å•äº¤æ˜“ç±»ï¼‰ï¼Œåˆ™åº”è¯¥åšåˆ°æ¶ˆæ¯å¹‚ç­‰ã€‚ ä»¥æ•°æ®åº“ç±»åº”ç”¨ä¸ºä¾‹ï¼Œå¸¸ç”¨åšæ³•æ˜¯ï¼š å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼ å…¥ key ä½œä¸ºå”¯ä¸€æµæ°´å·IDï¼› æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œåˆ¤æ–­ key æ˜¯å¦å·²ç»æ¶ˆè´¹è¿‡ï¼Œå¦‚æœå·²ç»æ¶ˆè´¹è¿‡äº†ï¼Œåˆ™å¿½ç•¥ï¼Œå¦‚æœæ²¡æ¶ˆè´¹è¿‡ï¼Œåˆ™æ¶ˆè´¹ä¸€æ¬¡ï¼› å½“ç„¶ï¼Œå¦‚æœåº”ç”¨æœ¬èº«å¯¹å°‘é‡æ¶ˆæ¯é‡å¤ä¸æ•æ„Ÿï¼Œåˆ™ä¸éœ€è¦åšæ­¤ç±»å¹‚ç­‰æ£€æŸ¥ã€‚ 2.7 æ¶ˆè´¹å¤±è´¥ Kafka æ˜¯æŒ‰åˆ†åŒºä¸€æ¡ä¸€æ¡æ¶ˆæ¯é¡ºåºå‘å‰æ¨è¿›æ¶ˆè´¹çš„ï¼Œå¦‚æœæ¶ˆè´¹ç«¯æ‹¿åˆ°æŸæ¡æ¶ˆæ¯åæ‰§è¡Œæ¶ˆè´¹é€»è¾‘å¤±è´¥ï¼Œæ¯”å¦‚åº”ç”¨æœåŠ¡å™¨å‡ºç°äº†è„æ•°æ®ï¼Œå¯¼è‡´æŸæ¡æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œç­‰å¾…äººå·¥å¹²é¢„ï¼Œé‚£ä¹ˆæœ‰ä»¥ä¸‹ä¸¤ç§å¤„ç†æ–¹å¼ï¼š å¤±è´¥åä¸€ç›´å°è¯•å†æ¬¡æ‰§è¡Œæ¶ˆè´¹é€»è¾‘ã€‚è¿™ç§æ–¹å¼æœ‰å¯èƒ½é€ æˆæ¶ˆè´¹çº¿ç¨‹é˜»å¡åœ¨å½“å‰æ¶ˆæ¯ï¼Œæ— æ³•å‘å‰æ¨è¿›ï¼Œé€ æˆæ¶ˆæ¯å †ç§¯ï¼› ç”±äº Kafka è‡ªèº«æ²¡æœ‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„è®¾è®¡ï¼Œå®è·µä¸­é€šå¸¸ä¼šæ‰“å°å¤±è´¥çš„æ¶ˆæ¯ã€æˆ–è€…å­˜å‚¨åˆ°æŸä¸ªæœåŠ¡ï¼ˆæ¯”å¦‚åˆ›å»ºä¸€ä¸ª Topic ä¸“é—¨ç”¨æ¥æ”¾å¤±è´¥çš„æ¶ˆæ¯ï¼‰ï¼Œç„¶åå®šæ—¶ check å¤±è´¥æ¶ˆæ¯çš„æƒ…å†µï¼Œåˆ†æå¤±è´¥åŸå› ï¼Œæ ¹æ®æƒ…å†µå¤„ç†ã€‚ ### 2.8 æ¶ˆè´¹é˜»å¡ä»¥åŠå †ç§¯ æ¶ˆè´¹ç«¯æœ€å¸¸è§çš„é—®é¢˜å°±æ˜¯æ¶ˆè´¹å †ç§¯ï¼Œæœ€å¸¸é€ æˆå †ç§¯çš„åŸå› æ˜¯ï¼š æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦ï¼Œæ­¤æ—¶åº”è¯¥æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œè¯¦è§ä¸‹ä¸€èŠ‚ã€Šæé«˜æ¶ˆè´¹é€Ÿåº¦ã€‹ï¼› æ¶ˆè´¹ç«¯äº§ç”Ÿäº†é˜»å¡ã€‚ æ¶ˆè´¹ç«¯æ‹¿åˆ°æ¶ˆæ¯åï¼Œæ‰§è¡Œæ¶ˆè´¹é€»è¾‘ï¼Œé€šå¸¸ä¼šæ‰§è¡Œä¸€äº›è¿œç¨‹è°ƒç”¨ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™åŒæ­¥ç­‰å¾…ç»“æœï¼Œåˆ™æœ‰å¯èƒ½é€ æˆä¸€ç›´ç­‰å¾…ï¼Œæ¶ˆè´¹è¿›ç¨‹æ— æ³•å‘å‰æ¨è¿›ã€‚ æ¶ˆè´¹ç«¯åº”è¯¥ç«­åŠ›é¿å…å µå¡æ¶ˆè´¹çº¿ç¨‹ï¼Œå¦‚æœå­˜åœ¨ç­‰å¾…è°ƒç”¨ç»“æœçš„æƒ…å†µï¼Œå»ºè®®è®¾ç½®ç­‰å¾…çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åä½œæ¶ˆè´¹å¤±è´¥å¤„ç†ã€‚ 2.9 æé«˜æ¶ˆè´¹é€Ÿåº¦ æé«˜æ¶ˆè´¹é€Ÿåº¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŠæ³•ï¼š å¢åŠ  Consumer å®ä¾‹ä¸ªæ•° å¢åŠ æ¶ˆè´¹çº¿ç¨‹ ##### å¢åŠ  Consumer å®ä¾‹ å¯ä»¥åœ¨è¿›ç¨‹å†…ç›´æ¥å¢åŠ ï¼ˆéœ€è¦ä¿è¯æ¯ä¸ªå®ä¾‹å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦åˆ™æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼‰ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²å¤šä¸ªæ¶ˆè´¹å®ä¾‹è¿›ç¨‹ï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ä¾‹ä¸ªæ•°è¶…è¿‡åˆ†åŒºæ•°é‡åå°±ä¸å†èƒ½æé«˜é€Ÿåº¦ï¼Œå°†ä¼šæœ‰æ¶ˆè´¹å®ä¾‹ä¸å·¥ä½œã€‚ å¢åŠ æ¶ˆè´¹çº¿ç¨‹ å¢åŠ  Consumer å®ä¾‹æœ¬è´¨ä¸Šä¹Ÿæ˜¯å¢åŠ çº¿ç¨‹çš„æ–¹å¼æ¥æå‡é€Ÿåº¦ï¼Œå› æ­¤æ›´åŠ é‡è¦çš„æ€§èƒ½æå‡æ–¹å¼æ˜¯å¢åŠ æ¶ˆè´¹çº¿ç¨‹ï¼Œæœ€åŸºæœ¬çš„æ­¥éª¤å¦‚ä¸‹ï¼š å®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼› Poll æ•°æ®ï¼› æŠŠæ•°æ®æäº¤åˆ°çº¿ç¨‹æ± è¿›è¡Œå¹¶å‘å¤„ç†ï¼› ç­‰å¹¶å‘ç»“æœè¿”å›æˆåŠŸåï¼Œå†æ¬¡ poll æ•°æ®æ‰§è¡Œã€‚ 2.10 æ¶ˆæ¯è¿‡æ»¤ Kafka è‡ªèº«æ²¡æœ‰æ¶ˆæ¯è¿‡æ»¤çš„è¯­ä¹‰ã€‚å®è·µä¸­å¯ä»¥é‡‡å–ä»¥ä¸‹ä¸¤ä¸ªåŠæ³•ï¼š å¦‚æœè¿‡æ»¤çš„ç§ç±»ä¸å¤šï¼Œå¯ä»¥é‡‡å–å¤šä¸ª Topic çš„æ–¹å¼è¾¾åˆ°è¿‡æ»¤çš„ç›®çš„ï¼› å¦‚æœè¿‡æ»¤çš„ç§ç±»å¤šï¼Œåˆ™æœ€å¥½åœ¨å®¢æˆ·ç«¯ä¸šåŠ¡å±‚é¢è‡ªè¡Œè¿‡æ»¤ã€‚ å®è·µä¸­è¯·æ ¹æ®ä¸šåŠ¡å…·ä½“æƒ…å†µè¿›è¡Œé€‰æ‹©ï¼Œä¹Ÿå¯ä»¥ç»¼åˆè¿ç”¨ä¸Šé¢ä¸¤ç§åŠæ³•ã€‚ 2.11 æ¶ˆæ¯å¹¿æ’­ Kafka è‡ªèº«æ²¡æœ‰æ¶ˆæ¯å¹¿æ’­çš„è¯­ä¹‰ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºä¸åŒçš„ Consumer Group æ¥æ¨¡æ‹Ÿå®ç°ã€‚ 2.12 è®¢é˜…å…³ç³» åŒä¸€ä¸ª Consumer Group å†…ï¼Œå„ä¸ªæ¶ˆè´¹å®ä¾‹è®¢é˜…çš„ Topic æœ€å¥½ä¿æŒä¸€è‡´ï¼Œé¿å…ç»™æ’æŸ¥é—®é¢˜å¸¦æ¥å¹²æ‰°ã€‚ ä¸‰ã€å¼€å§‹æŠ›ä»£ç  æˆ‘ä»¬çš„é—®é¢˜æ˜¯ç”±äºæ¶ˆè´¹çš„é€Ÿåº¦ä¸å¤Ÿå¼•èµ·çš„ã€‚æ ¹æ®2.9çš„åŠæ³•ã€‚æˆ‘æä¾›äº†ä»¥ä¸‹ä»£ç  æ¶ˆè´¹è€…é…ç½®ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980package com.xxx.xxxxxx.kafka;import org.apache.kafka.clients.CommonClientConfigs;import org.apache.kafka.clients.consumer.ConsumerConfig;import org.apache.kafka.common.config.SaslConfigs;import org.apache.kafka.common.config.SslConfigs;import org.apache.kafka.common.serialization.StringDeserializer;import org.springframework.beans.factory.annotation.Value;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.kafka.annotation.EnableKafka;import org.springframework.kafka.config.ConcurrentKafkaListenerContainerFactory;import org.springframework.kafka.config.KafkaListenerContainerFactory;import org.springframework.kafka.core.ConsumerFactory;import org.springframework.kafka.core.DefaultKafkaConsumerFactory;import org.springframework.kafka.listener.BatchLoggingErrorHandler;import org.springframework.kafka.listener.ConcurrentMessageListenerContainer;import java.util.HashMap;import java.util.Map;/** * @Author ï¼šyaxuSong * @Description: * @Date: 18:15 2018/4/24 * @Modified by: */@Configuration@EnableKafkapublic class ReceiverConfig &#123; @Value(\"$&#123;spring.kafka.bootstrap-servers&#125;\") private String bootstrapServers; @Value(\"$&#123;app.group.id&#125;\") private String groupId; @Value(\"$&#123;kafka.client.truststore&#125;\") private String kafkaClientTruststore; @Value(\"$&#123;app.topic.test&#125;\") private String topic; @Bean public Map&lt;String, Object&gt; consumerConfigs() &#123; Map&lt;String, Object&gt; props = new HashMap&lt;&gt;(); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers); props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class); props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class); props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId); props.put(SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG,kafkaClientTruststore); props.put(SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG,\"KafkaOnsClient\"); props.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG,\"SASL_SSL\"); props.put(SaslConfigs.SASL_MECHANISM,\"ONS\"); props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,false); props.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,1000); props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG,50); props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,\"latest\"); return props; &#125; @Bean public ConsumerFactory&lt;String, String&gt; consumerFactory() &#123; return new DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs()); &#125; @Bean public ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; kafkaListenerContainerFactory() &#123; ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory = new ConcurrentKafkaListenerContainerFactory&lt;&gt;(); factory.setConsumerFactory(consumerFactory()); factory.setBatchListener(true); factory.setAutoStartup(true); factory.setAckDiscarded(true); factory.setConcurrency(1); return factory; &#125;&#125; ä»¥ä¸‹æ˜¯æ¶ˆè´¹ä»£ç  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667package com.xxx.xxxxxx.kafka;import com.alibaba.fastjson.JSONObject;import com.xxx.xxxxxx.common.Constants;import com.xxx.xxxxxx.entry.vo.TrendInfoVO;import lombok.extern.slf4j.Slf4j;import org.apache.commons.lang3.StringUtils;import org.apache.kafka.clients.consumer.ConsumerRecord;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.kafka.annotation.KafkaListener;import org.springframework.kafka.listener.KafkaDataListener;import org.springframework.kafka.listener.MessageListener;import org.springframework.kafka.support.KafkaHeaders;import org.springframework.messaging.handler.annotation.Header;import org.springframework.messaging.handler.annotation.Payload;import org.springframework.scheduling.annotation.Async;import org.springframework.scheduling.annotation.EnableAsync;import org.springframework.stereotype.Service;import java.util.Calendar;import java.util.List;/** * @Author ï¼šyaxuSong * @Description: * @Date: 17:09 2018/4/24 * @Modified by: */@Service@EnableAsync@Slf4jpublic class TrendConsumer&#123; @Autowired private RedisTemplate&lt;String, String&gt; redisTemplate; static Long timestart = System.currentTimeMillis(); static int count = 0; @Async(\"kafkaExecutor\") @KafkaListener(id = \"list\", topics = \"$&#123;app.topic.test&#125;\") public void receive(@Payload List&lt;String&gt; messages, @Header(KafkaHeaders.RECEIVED_PARTITION_ID) List&lt;Integer&gt; partitions, @Header(KafkaHeaders.OFFSET) List&lt;Long&gt; offsets) &#123; for (String str :messages) &#123; doRedisTask(str); count++; if (System.currentTimeMillis()-timestart&gt;=10000) &#123; log.info(\"æ—¶é—´ï¼š&#123;&#125;kafkaæ¶ˆè´¹æ•°é‡ï¼š&#123;&#125;\", Calendar.getInstance().getTime(),count); count = 0; timestart = System.currentTimeMillis(); &#125; &#125; &#125; @Async(\"redisExecutor\") public void doRedisTask(String message)&#123; JSONObject json = JSONObject.parseObject(message); String exchange = json.getString(\"exchange\"); String symbol = json.getString(\"symbol\"); redisTemplate.opsForValue().set(Constants.KAFKA_TRADE_PREFIX+exchange+symbol,message); &#125;&#125; è¿™é‡Œä½¿ç”¨äº†å¼‚æ­¥çº¿ç¨‹å»æ¶ˆè´¹ã€‚æé«˜æ¶ˆè´¹çš„é€Ÿåº¦ã€‚ å››ã€ç‰¹åˆ«æ³¨æ„ æ³¨æ„ä»¥ä¸‹å‡ ç‚¹é…ç½® 123456789props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,false);props.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,1000);props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG,50);props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,\"latest\");factory.setBatchListener(true);actory.setConcurrency(1); äº”ã€å‚è€ƒåœ°å€ é˜¿é‡Œäº‘kafkaè®¢é˜…è€…æœ€ä½³å®è·µ:https://help.aliyun.com/document_detail/68166.html?spm=a2c4g.11186623.6.566.nnWMLo Spring KAFKAåœ°å€ï¼šhttps://docs.spring.io/spring-kafka/docs/2.1.5.RELEASE/reference/html/","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"chapter-08-AIR","slug":"2018-04-30/TensorFlowçº¿æ€§å›å½’è¯¦è§£(2)","date":"2018-05-06T03:30:48.000Z","updated":"2018-05-29T01:27:49.888Z","comments":true,"path":"posts/839e2740/","link":"","permalink":"http://weafteam.github.io/posts/839e2740/","excerpt":"","text":"TensorFlow Linear Regression 2 å›é¡¾ä¸€ä¸‹çº¿æ€§å›å½’çš„losså‡½æ•°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsdef run(): ops.reset_default_graph() sess = tf.Session() batch_size = 100 x_vals = np.linspace(0, 10, 100) y_vals = x_vals + np.random.normal(0, 1, 100) x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32) y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32) # Create variables for linear regression A = tf.Variable(tf.random_normal(shape=[1, 1])) b = tf.Variable(tf.random_normal(shape=[1, 1])) # Declare model operations model_output = tf.add(tf.matmul(x_data, A), b) loss_l1 = tf.reduce_mean(tf.abs(y_target - model_output)) # Declare optimizers my_opt_l1 = tf.train.GradientDescentOptimizer(0.0001) train_step_l1 = my_opt_l1.minimize(loss_l1) # Initialize variables init = tf.global_variables_initializer() sess.run(init) loss_vec_l1 = [] for i in range(1000): rand_index = np.random.choice(len(x_vals), size=batch_size) rand_x = np.transpose([x_vals[rand_index]]) rand_y = np.transpose([y_vals[rand_index]]) sess.run(train_step_l1, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss_l1 = sess.run(loss_l1, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec_l1.append(temp_loss_l1) if (i + 1) % 25 == 0: print('Step #' + str(i + 1) + ' A = ' + str(sess.run(A)) + ' b = ' + str(sess.run(b))) ops.reset_default_graph() # Create graph sess = tf.Session() x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32) y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32) # Create variables for linear regression A = tf.Variable(tf.random_normal(shape=[1, 1])) b = tf.Variable(tf.random_normal(shape=[1, 1])) # Declare model operations model_output = tf.add(tf.matmul(x_data, A), b) loss_l2 = tf.reduce_mean(tf.square(y_target - model_output)) # Declare optimizers my_opt_l2 = tf.train.GradientDescentOptimizer(0.0001) train_step_l2 = my_opt_l2.minimize(loss_l2) # Initialize variables init = tf.global_variables_initializer() sess.run(init) loss_vec_l2 = [] for i in range(1000): rand_index = np.random.choice(len(x_vals), size=batch_size) rand_x = np.transpose([x_vals[rand_index]]) rand_y = np.transpose([y_vals[rand_index]]) sess.run(train_step_l2, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss_l2 = sess.run(loss_l2, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec_l2.append(temp_loss_l2) if (i + 1) % 25 == 0: print('Step #' + str(i + 1) + ' A = ' + str(sess.run(A)) + ' b = ' + str(sess.run(b))) plt.plot(loss_vec_l1, 'k-', label='L1 Loss') plt.plot(loss_vec_l2, 'r--', label='L2 Loss') plt.title('L1 and L2 Loss per Generation') plt.xlabel('Generation') plt.ylabel('L1 Loss') plt.legend(loc='upper right') plt.show()def main(_): run()if __name__ == '__main__': tf.app.run() æˆ´æ˜å›å½’: çœ‹å›¾ï¼šæ‰¾ä¸åŒï¼š losså‡½æ•°æ˜¯å…³é”®:ä¸‹é¢æ˜¯deming regressionçš„losså‡½æ•° \\[ \\frac{\\mid{A*x+b-y}\\mid}{\\sqrt{A^2 + 1}} \\] 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182#!/usr/bin/env python# -*- coding: utf-8 -*-# @Time : 2018/5/6 14:32# @Author : milittle# @Site : www.weaf.top# @File : deming_lr.py# @Software: PyCharmimport matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()def run(): x_vals = np.linspace(0, 10, 100) y_vals = x_vals + np.random.normal(0, 1, 100) batch_size = 125 x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32) y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32) A = tf.Variable(tf.random_normal(shape=[1, 1])) b = tf.Variable(tf.random_normal(shape=[1, 1])) model_output = tf.add(tf.matmul(x_data, A), b) # æ³¨æ„è¿™é‡Œçš„losså‡½æ•°çš„æ±‚è§£ demming_numerator = tf.abs(tf.subtract(tf.add(tf.matmul(x_data, A), b), y_target)) demming_denominator = tf.sqrt(tf.add(tf.square(A), 1)) loss = tf.reduce_mean(tf.truediv(demming_numerator, demming_denominator)) my_opt = tf.train.GradientDescentOptimizer(0.01) train_step = my_opt.minimize(loss) # Initialize variables init = tf.global_variables_initializer() sess.run(init) loss_vec = [] for i in range(1500): rand_index = np.random.choice(len(x_vals), size=batch_size) rand_x = np.transpose([x_vals[rand_index]]) rand_y = np.transpose([y_vals[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec.append(temp_loss) if (i + 1) % 100 == 0: print(&apos;Step #&apos; + str(i + 1) + &apos; A = &apos; + str(sess.run(A)) + &apos; b = &apos; + str(sess.run(b))) print(&apos;Loss = &apos; + str(temp_loss)) [W] = sess.run(A) [bias] = sess.run(b) # Get best fit line best_fit = [] for i in x_vals: best_fit.append(W * i + bias) plt.plot(x_vals, y_vals, &apos;o&apos;, label=&apos;Data Points&apos;) plt.plot(x_vals, best_fit, &apos;r-&apos;, label=&apos;Best fit line&apos;, linewidth=3) plt.legend(loc=&apos;upper left&apos;) plt.title(&apos;Sepal Length vs Pedal Width&apos;) plt.xlabel(&apos;Pedal Width&apos;) plt.ylabel(&apos;Sepal Length&apos;) plt.show() # Plot loss over time plt.plot(loss_vec, &apos;k-&apos;) plt.title(&apos;Demming Loss per Generation&apos;) plt.xlabel(&apos;Iteration&apos;) plt.ylabel(&apos;Demming Loss&apos;) plt.show()def main(_): run()if __name__ == &apos;__main__&apos;: tf.app.run() LASSO and Ridge Regression(å…³é”®çš„åœ°æ–¹è¿˜æ˜¯losså‡½æ•°çš„ä¸åŒï¼Œå…¶ä»–æ­¥éª¤æ˜¯ä¸€è‡´çš„) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104#!/usr/bin/env python# -*- coding: utf-8 -*-# @Time : 2018/5/6 14:46# @Author : milittle# @Site : www.weaf.top# @File : LASSO_Ridge_lr.py# @Software: PyCharmimport matplotlib.pyplot as pltimport sysimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()regression_type = 'LASSO'def run(): sess = tf.Session() x_vals = np.linspace(0, 10, 100) y_vals = x_vals + np.random.normal(0, 1, 100) batch_size = 125 x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32) y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32) seed = 13 np.random.seed(seed) tf.set_random_seed(seed) A = tf.Variable(tf.random_normal(shape=[1, 1])) b = tf.Variable(tf.random_normal(shape=[1, 1])) model_output = tf.add(tf.matmul(x_data, A), b) if regression_type == 'LASSO': lasso_param = tf.constant(0.9) heavyside_step = tf.truediv(1., tf.add(1., tf.exp(tf.multiply(-50., tf.subtract(A, lasso_param))))) regularization_param = tf.multiply(heavyside_step, 99.) loss = tf.add(tf.reduce_mean(tf.square(y_target - model_output)), regularization_param) elif regression_type == 'Ridge': ridge_param = tf.constant(1.) ridge_loss = tf.reduce_mean(tf.square(A)) loss = tf.expand_dims( tf.add(tf.reduce_mean(tf.square(y_target - model_output)), tf.multiply(ridge_param, ridge_loss)), 0) else: print('Invalid regression_type parameter value', file=sys.stderr) my_opt = tf.train.GradientDescentOptimizer(0.001) train_step = my_opt.minimize(loss) init = tf.global_variables_initializer() sess.run(init) # Training loop loss_vec = [] for i in range(1500): rand_index = np.random.choice(len(x_vals), size=batch_size) rand_x = np.transpose([x_vals[rand_index]]) rand_y = np.transpose([y_vals[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec.append(temp_loss[0]) if (i + 1) % 300 == 0: print('Step #' + str(i + 1) + ' A = ' + str(sess.run(A)) + ' b = ' + str(sess.run(b))) print('Loss = ' + str(temp_loss)) print('\\n') [W] = sess.run(A) [bias] = sess.run(b) # Get best fit line best_fit = [] for i in x_vals: best_fit.append(W * i + bias) # Plot the result plt.plot(x_vals, y_vals, 'o', label='Data Points') plt.plot(x_vals, best_fit, 'r-', label='Best fit line', linewidth=3) plt.legend(loc='upper left') plt.title('Sepal Length vs Pedal Width') plt.xlabel('Pedal Width') plt.ylabel('Sepal Length') plt.show() # Plot loss over time plt.plot(loss_vec, 'k-') plt.title(regression_type + ' Loss per Generation') plt.xlabel('Generation') plt.ylabel('Loss') plt.show()def main(_): run()if __name__ == '__main__': tf.app.run() Elastic Net Regression(åˆ©ç”¨å¤šä¸ªlosså‡½æ•°çš„å åŠ è¿›è¡Œè®­ç»ƒ)å¼¹æ€§çš„æ–¹å¼ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465#!/usr/bin/env python# -*- coding: utf-8 -*-# @Time : 2018/5/6 14:57# @Author : milittle# @Site : www.weaf.top# @File : Elastic_Net_Regression.py# @Software: PyCharmimport matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opssess = tf.Session()x_vals = np.linspace(0, 10, 100)y_vals = x_vals + np.random.normal(0, 1, 100)batch_size = 16seed = 13np.random.seed(seed)tf.set_random_seed(seed)x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32, name='input')y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32, name='output')A = tf.Variable(tf.random_normal(shape=[1, 1]))b = tf.Variable(tf.random_normal(shape=[1, 1]))model_output = tf.add(tf.matmul(x_data, A), b)elastic_param1 = tf.constant(1.)elastic_param2 = tf.constant(1.)l1_a_loss = tf.reduce_mean(tf.abs(A))l2_a_loss = tf.reduce_mean(tf.square(A))e1_term = tf.multiply(elastic_param1, l1_a_loss)e2_term = tf.multiply(elastic_param2, l2_a_loss)loss = tf.expand_dims(tf.add(tf.add(tf.reduce_mean(tf.square(y_target - model_output)), e1_term), e2_term), 0)my_opt = tf.train.GradientDescentOptimizer(0.001)train_step = my_opt.minimize(loss)init = tf.global_variables_initializer()sess.run(init)# Training looploss_vec = []for i in range(1000): rand_index = np.random.choice(len(x_vals), size=batch_size) rand_x = np.transpose([x_vals[rand_index]]) rand_y = np.transpose([y_vals[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec.append(temp_loss[0]) if (i + 1) % 250 == 0: print('Step #' + str(i + 1) + ' A = ' + str(sess.run(A)) + ' b = ' + str(sess.run(b))) print('Loss = ' + str(temp_loss))W = sess.run(A)bias = sess.run(b)plt.plot(loss_vec, 'k-')plt.title('Loss per Generation')plt.xlabel('Generation')plt.ylabel('Loss')plt.show() å¥½ï¼Œä»Šå¤©åˆ°æ­¤æŠŠä¸€äº›çº¿æ€§æ¨¡å‹çš„åº”ç”¨é—®é¢˜å¤§ä½“è®²å®Œäº†ï¼Œè¿˜æ˜¯æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥ç§¯æè®¨è®ºï¼Œå¯ä»¥ç»™æˆ‘å‘é‚®ä»¶air@weaf.topï¼Œä¸Šé¢çš„ä»£ç ç”±äºå¾ˆç®€å•ï¼Œæ‰€ä»¥æˆ‘æƒ³å¤§å®¶éƒ½å¯ä»¥çœ‹æ‡‚çš„ã€‚å…¶å®è¿™ä¹ˆå¤šç±»å‹çš„å›å½’é—®é¢˜ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯losså‡½æ•°ä¸ä¸€æ ·ï¼Œåªè¦å°†losså‡½æ•°ç†è§£äº†ï¼Œé‚£ä¹ˆé—®é¢˜å°±è¿åˆƒè€Œè§£ã€‚","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"chapter-07-AIR","slug":"2018-04-23/TenosrFlowçº¿æ€§å›å½’è¯¦è§£(1)","date":"2018-05-06T03:29:55.000Z","updated":"2018-05-29T01:27:49.874Z","comments":true,"path":"posts/1ceb091/","link":"","permalink":"http://weafteam.github.io/posts/1ceb091/","excerpt":"","text":"TensorFlow Linear Regression 1 äº²çˆ±çš„å°ä¼™ä¼´ä»¬ï¼Œä¸Šå‘¨åˆäº‹æƒ…ç»™è€½æäº†ï¼Œè¿™å‘¨å°†ä¸Šå‘¨çš„å†…å®¹ä¸€èµ·è¡¥å……ä¸€ä¸‹ã€‚æˆ‘ä»¬å‰é¢çš„å†…å®¹å°†TensorFlowçš„åŸºç¡€å†…å®¹éƒ½ä»‹ç»äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€äº›åŸºæœ¬çš„ç®—æ³•ï¼Œå¦‚æœå¤§å®¶æƒ³è·‘ä¸€äº›ç°åœ¨ä¸»æµçš„ä¸€äº›ç½‘ç»œç»“æ„ï¼Œå¤§å®¶å¯ä»¥ç§»æ­¥åˆ°æˆ‘çš„GitHub MLModelè¿™ä¸ªä»“åº“MLModelï¼Œé‡Œé¢ä¼šå®šæœŸæ›´æ–°ä¸€äº›ä¸»æµçš„ç½‘ç»œæ¡†æ¶ã€‚å–œæ¬¢çš„è¯ï¼Œç»™ä¸ªstarå¯å¥½ã€‚æ¥ä¸‹æ¥å‘¢æˆ‘ä»¬å¼€å§‹æˆ‘ä»¬ä»Šå¤©çš„çº¿æ€§å›å½’æ¨¡å‹çš„å„ç§æ±‚è§£æ–¹æ³•ã€‚ åœ¨TensorFlowä¸­ä½¿ç”¨çŸ©é˜µçš„é€†æ¥è§£å†³çº¿æ€§æ¨¡å‹ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œç›¸æ¯”å­¦è¿‡çº¿æ€§ä»£æ•°çš„ä½ ï¼Œéƒ½ä¼šè§£ã€‚ å¤§å®¶å¯æ›¾è®°å¾—çº¿æ€§ä»£æ•°é‡Œé¢çš„çº¿æ€§æ–¹ç¨‹ç»„ï¼š \\[ A * x + b = y \\] xå°±æ˜¯æˆ‘ä»¬è¦è§£çš„æœªçŸ¥è§£ï¼Œé‚£xè¯¥æ€ä¹ˆè§£æ¥ç€ï¼Ÿ \\[ x = {(A^T * A)}^{-1} * A^T * y - b \\] ä¸Šé¢çš„å…¬å¼ä¸€ä¸‹å°±èƒ½çœ‹å‡ºæ¥æ˜¯æ€ä¹ˆå›äº‹å¯¹ä¸å¯¹ï¼Ÿ æ¨å¯¼è¿‡ç¨‹ï¼š \\[ ç¬¬ä¸€æ­¥:A^T * A * x = A^T*y-b\\\\ç¬¬äºŒæ­¥ï¼š{(A^T*A)}^{-1} *{(A^T*A)} * x = {(A^T*A)}^{-1} * A^T*y-b\\\\ç¬¬ä¸‰æ­¥ï¼šå·¦è¾¹æ˜¯ä¸æ˜¯å°±æ˜¯ä¸€ä¸ªå•ä½çŸ©é˜µäº†ï¼Ÿ\\\\å¾—åˆ°æœ€åçš„ç»“æœæ˜¯ï¼šx = {(A^T * A)}^{-1} * A^T * y-b \\] æˆ‘ä»¬ä¸‹é¢ä½¿ç”¨çš„Açš„ç‰¹å¾ç»´åº¦æ˜¯ä¸€ç»´ï¼Œ(å†åŠ ä¸Šbè¿™ä¸ªç»´åº¦)è¿™æ˜¯ä¸ºäº†å¯ä»¥å¯è§†åŒ–ç»“æœï¼šåœ¨ç›´æ¥åˆ©ç”¨çŸ©é˜µè¿ç®—è€Œå¾—åˆ°çš„è§£å¯¹äºè¿™äº›æ•°æ®æ¥è¯´ï¼Œæ˜¯æœ€å¥½çš„ç»“æœã€‚ä¹Ÿæ˜¯å”¯ä¸€è§£ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()def run(): # æ„é€ æ•°æ® x_vals = np.linspace(0, 10, 100) y_vals = x_vals + np.random.normal(0, 1, 100) x_vals_column = np.transpose(np.matrix(x_vals)) ones_column = np.transpose(np.matrix(np.repeat(1, 100))) A = np.column_stack((x_vals_column, ones_column)) y = np.transpose(np.matrix(y_vals)) A_tensor = tf.constant(A) y_tensor = tf.constant(y) #åˆ©ç”¨çŸ©é˜µçš„é€†è§£å†³è¿™ä¸ªçº¿æ€§é—®é¢˜ã€‚ t_A_A = tf.matmul(tf.transpose(A_tensor), A_tensor) #æ±‚çŸ©é˜µè½¬ç½®å’Œæœ¬èº«çš„ä¹˜ç§¯ t_A_A_inverse = tf.matrix_inverse(t_A_A) # æ±‚çŸ©é˜µçš„é€† product = tf.matmul(t_A_A_inverse, tf.transpose(A_tensor)) solution = tf.matmul(product, y_tensor) solution_eval = sess.run(solution) W = solution_eval[0][0] bias = solution_eval[1][0] print('W: ' + str(W)) print('bias: ' + str(bias)) # Get best fit line best_fit = [] for i in x_vals: best_fit.append(W * i + bias) plt.plot(x_vals, y_vals, 'o', label = 'data') plt.plot(x_vals, best_fit, 'r-', label = 'best fit line', linewidth = 3) plt.legend(loc='upper left') plt.show()def main(_): run()if __name__ == '__main__': tf.app.run() å…¶å®å¤§å®¶ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä½¿ç”¨çŸ©é˜µçš„é€†å»æ±‚çº¿æ€§æ¨¡å‹æ˜¯åˆå¿«åˆå‡†ï¼Œä½†æ˜¯ä½ ä»¬æƒ³è¿‡æ²¡æœ‰ä¸ºå•¥ç¥ç»ç½‘ç»œé‡Œé¢åœ¨æ±‚è§£çº¿æ€§å›å½’çš„æ—¶å€™è¿˜è¦ç”¨åˆ°åå‘ä¼ æ’­æ¢¯åº¦ä¸‹é™çš„æ–¹å¼å‘¢ï¼Œç»™ä½ ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ç°åœ¨ä¸€ä¸ªæ ·æœ¬æœ‰ä¸Šä¸‡æˆ–è€…åä¸‡ä¸ªç‰¹å¾ç»´åº¦ï¼Œä½ æƒ³æƒ³æˆ‘ä»¬åœ¨æ±‚è§£çŸ©é˜µé€†çš„æ—¶å€™è¦èŠ±è´¹å¤šé•¿æ—¶é—´ï¼Œé‚£æ˜¯ä½ æ„æƒ³ä¸åˆ°çš„ï¼Œæ‰€ä»¥æ‰ä¼šä½¿ç”¨æ–¹å‘ä¼ æ’­ç®—æ³•å»è§£å†³Wçš„æ±‚è§£é—®é¢˜ã€‚è¯¦ç»†éœ€è¦èŠ±è´¹çš„æ—¶é—´ã€‚ ç¬¬äºŒç§æ±‚è§£æ–¹å¼ï¼šCholesky Method \\[ A*x=y \\] æ€è·¯å¦‚ä¸‹ï¼šåœ¨Cholesky methodæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†Aåˆ†è§£ä¸ºLå’ŒLçš„è½¬ç½®çš„ä¹˜ç§¯ï¼Œç„¶åå†è¿›è¡Œxçš„æ±‚è§£ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢?å½“ç„¶æ˜¯ä¸ºäº†é¿å…æ±‚çŸ©é˜µçš„é€†ï¼Œå®ƒå¾ˆè€—è´¹æ—¶é—´ã€‚ å› ä¸ºAè¦æ±‚åœ¨æ±‚è§£Cholesky Depcompositionçš„æ—¶å€™æ˜¯squareä¹Ÿå°±æ˜¯æ–¹é˜µã€‚ä½†æ˜¯ä¸€èˆ¬çš„Aéƒ½ä¸æ˜¯æ–¹é˜µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ„é€ å‡ºæ¥ä¸€ä¸ªæ–¹é˜µï¼š \\[ A^T*A \\] å®ƒå°±æ˜¯ä¸€ä¸ªæ–¹é˜µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ±‚Aè½¬ç½®å’ŒAä¹˜ç§¯çš„Cholesky Decompositionã€‚ é¦–å…ˆæ˜ç¡®åˆ†è§£æ­¥éª¤ï¼š \\[ ç¬¬ä¸€æ­¥ï¼šA^T*A=L^T*L\\\\ç¬¬äºŒæ­¥ï¼šL^T*L*x=A^T*Y\\\\ç¬¬ä¸‰æ­¥ï¼šL^T*z=A^T*Y\\\\where z = L*x \\] å…¶æ¬¡æ˜ç¡®æ±‚è§£æ­¥éª¤ï¼š \\[ ç¬¬ä¸€æ­¥ï¼šè®¡ç®—Açš„Cholesky Decomposition\\\\where A^T*A=L^T*L\\\\ç¬¬äºŒæ­¥ï¼šæ±‚è§£zï¼Œåˆ©ç”¨L^T*z=A^T*yè¿™ä¸ªå…¬å¼\\\\ç¬¬ä¸‰æ­¥ï¼šæ±‚è§£xï¼Œåˆ©ç”¨L*x=zè¿™ä¸ªå…¬å¼ \\] 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()def run(): # æ„é€ æ•°æ® x_vals = np.linspace(0, 10, 100) y_vals = x_vals + np.random.normal(0, 1, 100) x_vals_column = np.transpose(np.matrix(x_vals)) ones_column = np.transpose(np.matrix(np.repeat(1, 100))) A = np.column_stack((x_vals_column, ones_column)) y = np.transpose(np.matrix(y_vals)) A_tensor = tf.constant(A) y_tensor = tf.constant(y) tA_A = tf.matmul(tf.transpose(A_tensor), A_tensor) L = tf.cholesky(tA_A) tA_y = tf.matmul(tf.transpose(A_tensor), y) sol1 = tf.matrix_solve(L, tA_y) sol2 = tf.matrix_solve(tf.transpose(L), sol1) solution_eval = sess.run(sol2) W = solution_eval[0][0] bias = solution_eval[1][0] print('slope: ' + str(W)) print('y_intercept: ' + str(bias)) best_fit = [] for i in x_vals: best_fit.append(W * i + bias) plt.plot(x_vals, y_vals, 'o', label='Data') plt.plot(x_vals, best_fit, 'r-', label='Best fit line', linewidth=3) plt.legend(loc='upper left') plt.show()def main(_): run()if __name__ == '__main__': tf.app.run() ä½¿ç”¨åå‘ä¼ æ’­æ¢¯åº¦ä¸‹é™çš„æ–¹å¼æ±‚è§£çº¿æ€§æ¨¡å‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()def run(): # æ„é€ æ•°æ® batch_size = 32 x_vals = np.linspace(0, 10, 100) y_vals = x_vals + np.random.normal(0, 1, 100) x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32) y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32) A = tf.Variable(tf.random_normal(shape=[1, 1])) b = tf.Variable(tf.random_normal(shape=[1, 1])) model_output = tf.add(tf.matmul(x_data, A), b) loss = tf.reduce_mean(tf.square(y_target - model_output)) my_opt = tf.train.GradientDescentOptimizer(0.00001) train_step = my_opt.minimize(loss) sess.run(tf.global_variables_initializer()) loss_vec = [] for i in range(10000): rand_index = np.random.choice(len(x_vals), size = batch_size) rand_x = np.transpose([x_vals[rand_index]]) rand_y = np.transpose([y_vals[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) loss_vec.append(temp_loss) if (i + 1) % 25 == 0: print('Step #' + str(i + 1) + ' A = ' + str(sess.run(A)) + ' b = ' + str(sess.run(b))) print('Loss = ' + str(temp_loss)) [W] = sess.run(A) [b] = sess.run(b) best_fit = [] for i in x_vals: best_fit.append(W * i + b) plt.plot(x_vals, y_vals, 'o', label='Data Points') plt.plot(x_vals, best_fit, 'r-', label='Best fit line', linewidth=3) plt.legend(loc='upper left') plt.title('Sepal Length vs Pedal Width') plt.xlabel('Pedal Width') plt.ylabel('Sepal Length') plt.show() plt.plot(loss_vec, 'b-') plt.title('L2 Loss per Generation') plt.xlabel('Generation') plt.ylabel('L2 Loss') plt.show()def main(_): run()if __name__ == '__main__': tf.app.run() è¿™ä¸‰ç§æ–¹å¼æ±‚è§£çš„çº¿æ€§æ¨¡å‹ï¼Œå¤§å®¶éƒ½ç†Ÿæ‚‰ä¸€ä¸‹ã€‚æœ‰ä»€ä¹ˆä¸ç¡®å®šçš„åœ°æ–¹ï¼Œå¯ä»¥å‘é‚®ä»¶ç»™æˆ‘air@weaf.topã€‚ä¸Šé¢çš„æ–¹å¼å…¶å®åœ¨ç°å®é‡Œé¢éƒ½å¯ä»¥ä½¿ç”¨ï¼Œåªä¸è¿‡å‰ä¸¤ç§æ–¹æ³•ï¼Œåœ¨æ•°æ®ç»´åº¦è¾ƒå¤§çš„æ—¶å€™ï¼Œè®¡ç®—è€—æ—¶ã€‚æ‰€ä»¥æ‰ä¼šä½¿ç”¨æ¢¯åº¦ä¸‹é™çš„å»æ±‚æœ€ä¼˜è§£ã€‚è¿™æ¬¡çš„æ–‡ç« å°±åˆ°è¿™é‡Œã€‚å¦‚æœå“ªé‡Œè¡¨è¿°ä¸æ¸…çš„åœ°æ–¹æˆ–è€…é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤§å®¶æŒ‡å‡ºã€‚","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆå››ï¼‰","slug":"2018-04-30/guide-to-asyncio-4","date":"2018-05-04T14:32:16.000Z","updated":"2018-08-07T08:56:41.619Z","comments":true,"path":"posts/7eb3a479/","link":"","permalink":"http://weafteam.github.io/posts/7eb3a479/","excerpt":"","text":"ä¹¦æ¥ä¸Šæ–‡ã€‚ åŒæ­¥åŸè¯­ è™½ç„¶ä½¿ç”¨ asyncio çš„ç¨‹åºé€šå¸¸éƒ½ä»¥å•çº¿ç¨‹è¿è¡Œï¼Œä½†ä»ç„¶å¯ä»¥ä½œä¸ºå¹¶å‘ç¨‹åºã€‚æ¯ä¸ªåç¨‹æˆ–ä»»åŠ¡å¯ä»¥æ ¹æ®æ¥è‡ª I / O æˆ–å…¶ä»–å¤–éƒ¨äº‹ä»¶çš„å»¶è¿Ÿå’Œä¸­æ–­ä»¥ä¸å¯é¢„æµ‹çš„é¡ºåºæ‰§è¡Œã€‚ä¸ºäº†æ”¯æŒå®‰å…¨å¹¶å‘ï¼Œå’Œ threadingå’Œ multiprocessing æ¨¡å—ä¸€æ ·ï¼Œasyncio åŒ…å«äº†ä¸€äº›ç›¸åŒçš„ä½çº§åŸè¯­çš„å®ç°ã€‚ é” é”å¯¹å…±äº«èµ„æºçš„è®¿é—®æä¾›äº†ä¿æŠ¤ã€‚åªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½ä½¿ç”¨èµ„æºã€‚ç¬¬äºŒæ¬¡åŠä»¥ä¸Šè·å–é”çš„å°è¯•å°†è¢«é˜»æ­¢ï¼Œå› æ­¤æ¯æ¬¡åªæœ‰ä¸€ä¸ªæŒæœ‰è€…ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546import asyncioimport functoolsdef unlock(lock): print('callback releasing lock') lock.release()async def coro1(lock): print('`coro1` waiting for the lock') with await lock: print('`coro1` acquired lock') print('`coro1` released lock')async def coro2(lock): print('`coro2` waiting for the lock') await lock try: print('`coro2` acquired lock') finally: print('`coro2` released lock') lock.release()async def main(loop): # åˆ›å»ºå¹¶æŒæœ‰ä¸€ä¸ªé” lock = asyncio.Lock() print('acquiring the lock before starting coroutines') await lock.acquire() print(f'lock acquired: &#123;lock.locked()&#125;') # å®‰æ’ä¸€ä¸ªå›è°ƒé‡Šæ”¾é” loop.call_later(0.1, functools.partial(unlock, lock)) # è¿è¡Œå¸Œæœ›æŒæœ‰é”çš„åç¨‹ print('waiting for coroutines') await asyncio.wait([coro1(lock), coro2(lock)])event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(event_loop))finally: event_loop.close() å¯ä»¥ä½¿ç”¨ await æŒæœ‰ä¸€ä¸ªé”ï¼Œå¹¶ç”¨ release() é‡Šæ”¾ï¼Œå°±åƒcoro2() çš„åšæ³•ä¸€æ ·ï¼›åŒæ—¶ä¹Ÿå¯ä»¥åƒ coro1() ä¸€æ ·ï¼Œç”¨å¸¦æœ‰ await çš„å¼‚æ­¥ä¸Šä¸‹æ–‡å¤„ç†å™¨æ¥æŒæœ‰å¹¶é‡Šæ”¾ä¸€ä¸ªé”ï¼š 12345678910acquiring the lock before starting coroutineslock acquired: Truewaiting for coroutines`coro1` waiting for the lock`coro2` waiting for the lockcallback releasing lock`coro1` acquired lock`coro1` released lock`coro2` acquired lock`coro2` released lock Event asyncio.Event ä¸ threading.Event ç±»ä¼¼ï¼Œç”¨äºå…è®¸å¤šä¸ªåç¨‹ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿï¼Œè€Œä¸éœ€è¦ç›‘å¬ä¸€ä¸ªç‰¹å®šå€¼æ¥å®ç°ç±»ä¼¼é€šçŸ¥çš„åŠŸèƒ½ï¼š 123456789101112131415161718192021222324252627282930313233343536import asyncioimport functoolsdef set_event(event): print('setting event in callback') event.set()async def coro1(event): print('coro1 waiting for event') await event.wait() print('coro1 triggered')async def coro2(event): print('coro2 waiting for event') await event.wait() print('coro2 triggered')async def main(loop): event = asyncio.Event() print(f'event start state: &#123;event.is_set()&#125;') loop.call_later(0.1, functools.partial(set_event, event)) await asyncio.gather(coro1(event), coro2(event)) print(f'event end state: &#123;event.is_set()&#125;')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(event_loop))finally: event_loop.close() ä¸é”ä¸€æ ·ï¼Œcoro1() å’Œ coro2() éƒ½ä¼šç­‰å¾… event è¢«è®¾ç½®ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä»¬å¯ä»¥åœ¨ event çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ç«‹å³å¯åŠ¨ï¼Œå¹¶ä¸”å®ƒä»¬ä¸éœ€è¦è·å– event å¯¹è±¡çš„å”¯ä¸€ä½¿ç”¨æƒï¼š 1234567event start state: Falsecoro2 waiting for eventcoro1 waiting for eventsetting event in callbackcoro2 triggeredcoro1 triggeredevent end state: True Condition Conditionçš„ä½œç”¨ç±»ä¼¼äº Eventï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼ŒCondition ä¸ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…ä¸­çš„åç¨‹ï¼Œå”¤é†’çš„æ•°é‡ç”± notify() çš„å‚æ•°æ§åˆ¶ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344import asyncioasync def consumer(condition, n): with await condition: print(f'consumer &#123;n&#125; is waiting') await condition.wait() print(f'consumer &#123;n&#125; triggered') print(f'ending consumer &#123;n&#125;')async def manipulate_condition(condition): print('starting manipulate_condition') await asyncio.sleep(0.1) for i in range(1, 3): with await condition: print(f'notifying &#123;i&#125; consumers') condition.notify(n=i) await asyncio.sleep(0.1) with await condition: print('notifying remaining consumers') condition.notify_all() print('ending manipulate_condition')async def main(loop): condition = asyncio.Condition() consumers = [consumer(condition, i) for i in range(5)] loop.create_task(manipulate_condition(condition)) await asyncio.gather(*consumers)event_loop = asyncio.get_event_loop()try: result = event_loop.run_until_complete(main(event_loop))finally: event_loop.close() è¿™ä¸ªä¾‹å­ä¸­å¯åŠ¨äº†äº”ä¸ª Condition çš„æ¶ˆè´¹è€…ã€‚æ¯ä¸ªéƒ½ä½¿ç”¨ wait() æ–¹æ³•ç­‰å¾…é€šçŸ¥å®ƒä»¬ç»§ç»­çš„æ¶ˆæ¯ã€‚manipulate_condition() é€šçŸ¥ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç„¶åé€šçŸ¥ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œæœ€åé€šçŸ¥æ‰€æœ‰å‰©ä½™çš„æ¶ˆè´¹è€…ï¼š 1234567891011121314151617181920starting manipulate_conditionnotifying 1 consumersconsumer 2 is waitingconsumer 3 is waitingconsumer 0 is waitingconsumer 4 is waitingconsumer 1 is waitingnotifying 2 consumersconsumer 2 triggeredending consumer 2consumer 3 triggeredending consumer 3notifying remaining consumersending manipulate_conditionconsumer 0 triggeredending consumer 0consumer 4 triggeredending consumer 4consumer 1 triggeredending consumer 1 Queue asyncio.Queue ä¸ºåç¨‹æä¾›äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äºä¸å¤šçº¿ç¨‹ä¸­çš„ queue.Queueï¼Œå¤šè¿›ç¨‹ä¸­çš„ multiprocessing.Queueï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354import asyncioasync def consumer(n, q): print(f'consumer &#123;n&#125;: starting') while True: print(f'consumer &#123;n&#125;: waiting for item') item = await q.get() print(f'consumer &#123;n&#125;: has item &#123;item&#125;') # None è¡¨ç¤ºç»ˆæ­¢ä¿¡å· if item is None: q.task_done() break else: await asyncio.sleep(0.01 * item) q.task_done() print(f'consumer &#123;n&#125;: ending')async def producer(q, num_workers): print('producer: starting') # å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€äº›æ•°æ® for i in range(num_workers * 3): await q.put(i) print(f'producer: added task &#123;i&#125; to the queue') # ä¼ å…¥ç»ˆæ­¢ä¿¡å· print('producer: adding stop signals to the queue') for i in range(num_workers): await q.put(None) print('producer: waiting for queue to empty') await q.join() print('producer: ending')async def main(loop, num_consumers): # åˆ›å»ºæŒ‡å®šå¤§å°çš„é˜Ÿåˆ— # è¶…è¿‡é˜Ÿåˆ—å¤§å°æ—¶ç”Ÿäº§è€…ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ¶ˆè´¹è€…å–å‡ºæ•°æ® q = asyncio.Queue(maxsize=num_consumers) # è°ƒåº¦æ¶ˆè´¹è€… consumers = [loop.create_task(consumer(i, q)) for i in range(num_consumers)] # è°ƒåº¦ç”Ÿäº§è€… prod = loop.create_task(producer(q, num_consumers)) # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ await asyncio.gather(*consumers, prod)event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(event_loop, 2))finally: event_loop.close() ä½¿ç”¨ put() æ·»åŠ é¡¹æˆ–ä½¿ç”¨ get() è·å–å¹¶åˆ é™¤é¡¹éƒ½æ˜¯å¼‚æ­¥æ“ä½œï¼Œå› ä¸ºé˜Ÿåˆ—å¤§å°å¯èƒ½æ˜¯å›ºå®šçš„ï¼ˆé˜»å¡æ·»åŠ æ“ä½œï¼‰ï¼Œæˆ–è€…é˜Ÿåˆ—å¯èƒ½æ˜¯ç©ºçš„ï¼ˆé˜»å¡è·å–é¡¹çš„æ“ä½œï¼‰ï¼š 123456789101112131415161718192021222324252627282930consumer 0: startingconsumer 0: waiting for itemconsumer 1: startingconsumer 1: waiting for itemproducer: startingproducer: added task 0 to the queueproducer: added task 1 to the queueconsumer 0: has item 0consumer 1: has item 1producer: added task 2 to the queueproducer: added task 3 to the queueconsumer 0: waiting for itemconsumer 0: has item 2producer: added task 4 to the queueconsumer 1: waiting for itemconsumer 1: has item 3producer: added task 5 to the queueproducer: adding stop signals to the queueconsumer 0: waiting for itemconsumer 0: has item 4consumer 1: waiting for itemconsumer 1: has item 5producer: waiting for queue to emptyconsumer 0: waiting for itemconsumer 0: has item Noneconsumer 0: endingconsumer 1: waiting for itemconsumer 1: has item Noneconsumer 1: endingproducer: ending ç”¨ Protocol æŠ½è±¡ç±»å®ç°å¼‚æ­¥ I / O åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™äº›ç¤ºä¾‹éƒ½é¿å…äº†å°†å¹¶å‘å’Œ I / O æ“ä½œæ··åˆåœ¨ä¸€èµ·ï¼Œä¸€æ¬¡åªå…³æ³¨ä¸€ä¸ªæ¦‚å¿µã€‚ä½†æ˜¯ï¼Œåœ¨ I / O é˜»å¡æ—¶åˆ‡æ¢ä¸Šä¸‹æ–‡æ˜¯ asyncio çš„ä¸»è¦ä½¿ç”¨æƒ…å½¢ä¹‹ä¸€ã€‚åœ¨å·²ç»ä»‹ç»çš„å¹¶å‘æ¦‚å¿µçš„åŸºç¡€ä¸Šï¼Œæœ¬èŠ‚å°†å®ç°ç®€å•çš„ echo æœåŠ¡å™¨ç¨‹åºå’Œå®¢æˆ·ç«¯ç¨‹åºã€‚å®¢æˆ·ç«¯å¯ä»¥è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå‘é€ä¸€äº›æ•°æ®ï¼Œç„¶åæ¥æ”¶ä¸å“åº”ç›¸åŒçš„æ•°æ®ã€‚æ¯æ¬¡å¯åŠ¨ I / O æ“ä½œæ—¶ï¼Œæ‰§è¡Œä»£ç éƒ½ä¼šæ”¾å¼ƒå¯¹äº‹ä»¶å¾ªç¯çš„æ§åˆ¶ï¼Œä»è€Œå…è®¸å…¶ä»–ä»»åŠ¡è¿è¡Œï¼Œç›´åˆ° I / O æ“ä½œå°±ç»ªã€‚ Echo æœåŠ¡å™¨ æœåŠ¡å™¨é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„ asyncio å’Œ logging æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š 1234567891011121314import asyncioimport loggingimport sysSERVER_ADDRESS = ('localhost', 10000)logging.basicConfig( level=logging.DEBUG, format='%(name)s: %(message)s', stream=sys.stderr,)log = logging.getLogger('main')event_loop = asyncio.get_event_loop() ç„¶åå®šä¹‰äº†ä¸€ä¸ª asyncio.Protocol çš„å­ç±»ï¼Œç”¨æ¥å¤„ç†ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ã€‚Protocol å¯¹è±¡çš„æ–¹æ³•æ˜¯åŸºäºä¸æœåŠ¡å™¨ socket å…³è”çš„äº‹ä»¶è°ƒç”¨çš„ï¼š 1class EchoServer(asyncio.Protocol): æ¯ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥éƒ½ä¼šè§¦å‘å¯¹ connection_made() çš„è°ƒç”¨ã€‚transport å‚æ•°æ˜¯asyncio.Transport çš„å®ä¾‹ï¼Œå®ƒæä¾›äº†ä½¿ç”¨ socket è¿›è¡Œå¼‚æ­¥ I / O çš„æŠ½è±¡ã€‚ä¸åŒç±»å‹çš„é€šä¿¡æä¾›ä¸åŒçš„ tansport å®ç°ï¼Œæ‰€æœ‰è¿™äº›å®ç°éƒ½å…·æœ‰ç›¸åŒçš„ APIã€‚ä¾‹å¦‚ï¼Œæœ‰å•ç‹¬çš„ transport ç±»ç”¨äºä¸ socket é€šä¿¡ã€ä¸å­è¿›ç¨‹é€šè¿‡ç®¡é“é€šä¿¡ã€‚ä¼ å…¥å®¢æˆ·ç«¯çš„åœ°å€å¯ä»¥é€šè¿‡ transport çš„ get_extra_info() è·å–ï¼Œè¿™æ˜¯ä¸€ç§ç‰¹å®šäºå®ç°çš„æ–¹æ³•ï¼š 12345def connection_made(self, transport): self.transport = transport self.address = transport.get_extra_info('peername') self.log = logging.getLogger('EchoServer_&#123;&#125;_&#123;&#125;'.format(*self.address)) self.log.debug('connection accepted') å»ºç«‹è¿æ¥åï¼Œå½“æ•°æ®ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨æ—¶ï¼Œå°†è°ƒç”¨åè®®çš„ data_received() æ–¹æ³•å°†æ•°æ®ä¼ å…¥ä»¥è¿›è¡Œå¤„ç†ã€‚æ•°æ®ä»¥å­—èŠ‚ä¸²çš„å½¢å¼ä¼ é€’ï¼Œç”±åº”ç”¨ç¨‹åºä»¥é€‚å½“çš„æ–¹å¼å¯¹å…¶è¿›è¡Œè§£ç ã€‚åœ¨è¿™é‡Œè®°å½•ç»“æœï¼Œç„¶åé€šè¿‡è°ƒç”¨ transport.write() ç«‹å³å°†å“åº”å‘é€å›å®¢æˆ·ç«¯ï¼š 1234def data_received(self, data): self.log.debug('received &#123;!r&#125;'.format(data)) self.transport.write(data) self.log.debug('sent &#123;!r&#125;'.format(data)) æŸäº› transport æ”¯æŒç‰¹æ®Šçš„æ–‡ä»¶ç»“æŸæ ‡è¯†ç¬¦ï¼ˆEOFï¼‰ã€‚é‡åˆ° EOF æ—¶ï¼Œå°†è°ƒç”¨ eof_received() æ–¹æ³•ã€‚åœ¨è¿™ä¸ªå®ç°ä¸­ï¼ŒEOF è¢«å‘é€å›å®¢æˆ·ç«¯æ¥è¡¨ç¤ºå®ƒå·²è¢«æ¥æ”¶ã€‚ç”±äºå¹¶éæ‰€æœ‰ transport éƒ½æ”¯æŒæ˜¾å¼ EOFï¼Œå› æ­¤ protocol é¦–å…ˆè¯¢é—® transport å‘é€ EOF æ˜¯å¦å®‰å…¨ï¼š 1234def eof_received(self): self.log.debug('received EOF') if self.transport.can_write_eof(): self.transport.write_eof() å½“è¿æ¥å…³é—­æ—¶ï¼Œæ— è®ºæ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯é”™è¯¯å…³é—­ï¼Œéƒ½ä¼šè°ƒç”¨ protocol çš„ connection_lost() æ–¹æ³•ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå‚æ•°ä¼šåŒ…å«é€‚å½“çš„å¼‚å¸¸å¯¹è±¡ï¼Œå¦åˆ™ä¸º Noneï¼š 123456def connection_lost(self, error): if error: self.log.error(f'ERROR: &#123;error&#125;') else: self.log.debug('closing') super().connection_lost(error) å¯åŠ¨æœåŠ¡å™¨æœ‰ä¸¤ä¸ªæ­¥éª¤ã€‚é¦–å…ˆï¼Œåº”ç”¨ç¨‹åºå‘Šè¯‰äº‹ä»¶å¾ªç¯è¦ä½¿ç”¨çš„ protocol ç±»ä»¥åŠè¦ä¾¦å¬çš„ä¸»æœºåå’Œ socketï¼Œç”¨æ¥åˆ›å»ºæ–°çš„æœåŠ¡å™¨å¯¹è±¡ã€‚create_server() æ–¹æ³•æ˜¯åç¨‹ï¼Œå› æ­¤å¿…é¡»ç”±äº‹ä»¶å¾ªç¯å¤„ç†ç»“æœï¼Œæ‰èƒ½çœŸæ­£çš„å¯åŠ¨æœåŠ¡å™¨ã€‚ç„¶åï¼Œåç¨‹å®Œæˆåäº§ç”Ÿäº†ä¸€ä¸ªç»‘å®šåˆ°äº‹ä»¶å¾ªç¯çš„ asyncio.Server å®ä¾‹ï¼š 123factory = event_loop.create_server(EchoServer, *SERVER_ADDRESS)server = event_loop.run_until_complete(factory)log.debug('starting up on &#123;&#125; port &#123;&#125;'.format(*SERVER_ADDRESS)) ç„¶åï¼Œéœ€è¦è¿è¡Œäº‹ä»¶å¾ªç¯ä»¥å¤„ç†äº‹ä»¶å’Œå®¢æˆ·ç«¯è¯·æ±‚ã€‚å¯¹äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ï¼Œrun_forever() æ–¹æ³•æ˜¯æœ€ç®€å•çš„æ–¹æ³•ã€‚å½“äº‹ä»¶å¾ªç¯åœæ­¢æ—¶ï¼Œæ— è®ºæ˜¯é€šè¿‡åº”ç”¨ç¨‹åºä»£ç è¿˜æ˜¯é€šè¿‡å‘ä¿¡å·é€šçŸ¥è¿›ç¨‹ï¼ŒæœåŠ¡å™¨éƒ½å¯ä»¥å…³é—­ï¼Œä»¥ä¾¿æ­£ç¡®æ¸…ç† socketï¼Œç„¶åå¯ä»¥å…³é—­äº‹ä»¶å¾ªç¯ï¼Œä»¥ä¾¿åœ¨ç¨‹åºé€€å‡ºä¹‹å‰å®Œæˆå¯¹ä»»ä½•å…¶ä»–äº‹åŠ¡çš„å¤„ç†ï¼š 12345678try: event_loop.run_forever()finally: log.debug('closing server') server.close() event_loop.run_until_complete(server.wait_closed()) log.debug('closing event loop') event_loop.close() Echo å®¢æˆ·ç«¯ ä½¿ç”¨ protocol ç±»æ„é€ å®¢æˆ·ç«¯éå¸¸ç±»ä¼¼äºæ„é€ æœåŠ¡å™¨ã€‚é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„ asyncio å’Œ logging æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š 1234567891011121314151617181920import asyncioimport functoolsimport loggingimport sysMESSAGES = [ b'This is the message. ', b'It will be sent ', b'in parts.',]SERVER_ADDRESS = ('localhost', 10000)logging.basicConfig( level=logging.DEBUG, format='%(name)s: %(message)s', stream=sys.stderr,)log = logging.getLogger('main')event_loop = asyncio.get_event_loop() å®¢æˆ·ç«¯ protocol ç±»å®šä¹‰äº†ä¸æœåŠ¡å™¨ç›¸åŒçš„æ–¹æ³•ï¼Œä½†å®ç°æ–¹å¼ä¸åŒã€‚ç±»æ„é€ å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯è¦å‘é€çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªæ˜¯ future çš„å®ä¾‹ï¼Œç”¨äºé€šè¿‡æ¥æ”¶æ¥è‡ªæœåŠ¡å™¨çš„å“åº”æ¥è¡¨æ˜å®¢æˆ·ç«¯å·²ç»å®Œæˆäº†ä¸€ä¸ªå·¥ä½œå‘¨æœŸï¼š 1234567class EchoClient(asyncio.Protocol): def __init__(self, messages, future): super().__init__() self.messages = messages self.log = logging.getLogger('EchoClient') self.f = future å½“å®¢æˆ·ç«¯æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼Œå®ƒå°†ç«‹å³å¼€å§‹é€šä¿¡ã€‚æ¶ˆæ¯åºåˆ—ä¸€æ¬¡å‘é€ä¸€æ¡ï¼Œå°½ç®¡åº•å±‚ç½‘ç»œä»£ç å¯ä»¥å°†å¤šä¸ªæ¶ˆæ¯ç»„åˆæˆä¸€ä¸ªä¼ è¾“ã€‚å½“æ‰€æœ‰æ¶ˆæ¯éƒ½ç”¨å°½æ—¶ï¼Œå°†å‘é€ EOFã€‚ è™½ç„¶çœ‹èµ·æ¥æ•°æ®éƒ½æ˜¯ç«‹å³å‘é€çš„ï¼Œä½†å®é™…ä¸Š transport å¯¹è±¡ç¼“å†²ä¼ å‡ºçš„æ•°æ®ï¼Œå¹¶åœ¨å½“ socket çš„ç¼“å†²åŒºå‡†å¤‡å¥½æ¥æ”¶æ•°æ®æ—¶è®¾ç½®å›è°ƒæ¥è¿›è¡Œå®é™…çš„ä¼ è¾“ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯é€æ˜å¤„ç†çš„ï¼Œå› æ­¤å¯ä»¥ç¼–å†™åº”ç”¨ç¨‹åºä»£ç ï¼Œå°±å¥½åƒ I / O æ“ä½œæ­£åœ¨ç«‹å³å‘ç”Ÿä¸€æ ·ï¼š 123456789101112def connection_made(self, transport): self.transport = transport self.address = transport.get_extra_info('peername') self.log.debug('connecting to &#123;&#125; port &#123;&#125;'.format(*self.address)) # è¿™é‡Œå¯ä»¥æ˜¯ transport.writelines() # ä½†è¿™ä¼šä½¿æ˜¾ç¤ºè¦å‘é€çš„æ¶ˆæ¯çš„æ¯ä¸ªéƒ¨åˆ†å˜å¾—æ›´åŠ å›°éš¾ for msg in self.messages: transport.write(msg) self.log.debug(f'sending &#123;msg!r&#125;') if transport.can_write_eof(): transport.write_eof() æ”¶åˆ°æ¥è‡ªæœåŠ¡å™¨çš„å“åº”æ—¶ï¼Œå°†è®°å½•è¯¥å“åº”ï¼š 12def data_received(self, data): self.log.debug(f'received &#123;data!r&#125;') å½“ä»æœåŠ¡å™¨ç«¯æ¥æ”¶åˆ° EOF æˆ–è€…è¿æ¥è¢«å…³é—­æ—¶ï¼Œæœ¬åœ° transport å¯¹è±¡è¢«å…³é—­ï¼Œå¹¶é€šè¿‡è®¾ç½®ç»“æœå°† future å¯¹è±¡æ ‡è®°ä¸ºå®Œæˆï¼š 123456789101112def eof_received(self): self.log.debug('received EOF') self.transport.close() if not self.f.done(): self.f.set_result(True)def connection_lost(self, exc): self.log.debug('server closed connection') self.transport.close() if not self.f.done(): self.f.set_result(True) super().connection_lost(exc) é€šå¸¸ï¼Œprotocol ç±»è¢«ä¼ é€’åˆ°äº‹ä»¶å¾ªç¯ä»¥åˆ›å»ºè¿æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºäº‹ä»¶å¾ªç¯æ²¡æœ‰å‘ protocol æ„é€ å‡½æ•°ä¼ é€’é¢å¤–å‚æ•°çš„å·¥å…·ï¼Œå› æ­¤éœ€è¦ functools.partial() æ¥åŒ…è£…å®¢æˆ·ç«¯ç±»ï¼Œå¹¶ä¼ é€’è¦å‘é€çš„æ¶ˆæ¯åˆ—è¡¨å’Œ future çš„å®ä¾‹ã€‚ç„¶åï¼Œåœ¨è°ƒç”¨ create_connection() å»ºç«‹å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå°†ä½¿ç”¨è¯¥æ–°çš„å¯è°ƒç”¨å¯¹è±¡ä»£æ›¿ protocol ç±»ï¼š 1234567891011client_completed = asyncio.Future()client_factory = functools.partial( EchoClient, messages=MESSAGES, future=client_completed,)factory_coroutine = event_loop.create_connection( client_factory, *SERVER_ADDRESS,) ä¸ºäº†è§¦å‘å®¢æˆ·ç«¯è¿è¡Œï¼Œäº‹ä»¶å¾ªç¯å°†è°ƒç”¨ä¸€æ¬¡åˆ›å»ºå®¢æˆ·ç«¯çš„åç¨‹ï¼Œç„¶åå†è°ƒç”¨ä¸€æ¬¡æŒ‡å®šç»™å®¢æˆ·ç«¯çš„ future å®ä¾‹ï¼Œä»¥ä¾¿åœ¨å®Œæˆåè¿›è¡Œé€šä¿¡ã€‚ä½¿ç”¨è¿™æ ·çš„ä¸¤ä¸ªè°ƒç”¨é¿å…äº†å®¢æˆ·ç«¯ç¨‹åºä¸­çš„æ— é™å¾ªç¯ï¼Œå®¢æˆ·ç«¯ç¨‹åºå¯èƒ½å¸Œæœ›åœ¨å®Œæˆä¸æœåŠ¡å™¨çš„é€šä¿¡åé€€å‡ºã€‚å¦‚æœä»…ä½¿ç”¨ç¬¬ä¸€ä¸ªè°ƒç”¨æ¥ç­‰å¾…åç¨‹åˆ›å»ºå®¢æˆ·ç«¯ï¼Œé‚£å®ƒå¯èƒ½æ— æ³•å¤„ç†æ‰€æœ‰å“åº”æ•°æ®å¹¶æ­£ç¡®æ¸…ç†ä¸æœåŠ¡å™¨çš„è¿æ¥ï¼š 1234567log.debug('waiting for client to complete')try: event_loop.run_until_complete(factory_coroutine) event_loop.run_until_complete(client_completed)finally: log.debug('closing event loop') event_loop.close() è¾“å‡º åœ¨ä¸€ä¸ªçª—å£ä¸­è¿è¡ŒæœåŠ¡å™¨è€Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­è¿è¡Œå®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š 12345678910asyncio: Using selector: KqueueSelectormain: waiting for client to completeEchoClient: connecting to ::1 port 10000EchoClient: sending b'This is the message. 'EchoClient: sending b'It will be sent 'EchoClient: sending b'in parts.'EchoClient: received b'This is the message. It will be sent in parts.'EchoClient: received EOFEchoClient: server closed connectionmain: closing event loop è™½ç„¶å®¢æˆ·ç«¯æ€»æ˜¯å•ç‹¬å‘é€æ¶ˆæ¯ï¼Œä½†å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ”¶åˆ°ä¸€æ¡å¤§æ¶ˆæ¯ï¼Œå¹¶å°†è¯¥æ¶ˆæ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ ¹æ®ç½‘ç»œçš„ç¹å¿™ç¨‹åº¦ä»¥åŠæ˜¯å¦åœ¨å‡†å¤‡æ‰€æœ‰æ•°æ®ä¹‹å‰åˆ·æ–°ç½‘ç»œç¼“å†²åŒºï¼Œè¿™äº›ç»“æœåœ¨åç»­è¿è¡Œä¸­ä¼šæœ‰æ‰€ä¸åŒï¼š 12345678asyncio: Using selector: KqueueSelectormain: starting up on localhost port 10000EchoServer_::1_55307: connection acceptedEchoServer_::1_55307: received b'This is the message. It will be sent in parts.'EchoServer_::1_55307: sent b'This is the message. It will be sent in parts.'EchoServer_::1_55307: received EOFEchoServer_::1_55307: closing 1234567EchoServer_::1_55309: connection acceptedEchoServer_::1_55309: received b'This is the message. 'EchoServer_::1_55309: sent b'This is the message. 'EchoServer_::1_55309: received b'It will be sent in parts.'EchoServer_::1_55309: sent b'It will be sent in parts.'EchoServer_::1_55309: received EOFEchoServer_::1_55309: closing","categories":[],"tags":[]},{"title":"Javaä¸­Stringã€StringBufferä¸StringBuilderçš„åŒºåˆ«","slug":"2018-04-23/Javaä¸­Stringã€StringBufferä¸StringBuilderçš„åŒºåˆ«","date":"2018-05-03T07:39:02.000Z","updated":"2018-05-29T01:27:49.865Z","comments":true,"path":"posts/2870b42a/","link":"","permalink":"http://weafteam.github.io/posts/2870b42a/","excerpt":"","text":"æœ€è¿‘å‡†å¤‡å¼€å§‹åˆ·ç‰›å®¢ç½‘ä¸Šçš„é¢˜ç›®ï¼Œä¸ºæ‰¾å·¥ä½œé¢è¯•åšå‡†å¤‡ï¼Œä»Šåæˆ‘ä¼šå°†å…¶ä¸­æ„Ÿè§‰æ¯”è¾ƒä¸é”™çš„çŸ¥è¯†ç‚¹æ€»ç»“å‡ºæ¥å½¢æˆåšå®¢ï¼Œè´´å‡ºæ¥ä¸å¤§å®¶å…±åŒå­¦ä¹ ï¼Œå¦‚æœå…¶ä¸­å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶ä¸åæŒ‡æ•™ï¼Œé‚®ç®±åœ°å€ä¸ºwell@weaf.topã€‚ ä¸‹é¢å¼€å§‹æœ¬æ¬¡çš„å†…å®¹æ•´ç†å§~ String é¦–å…ˆè¯´ä¸€ä¸‹Stringç±»çš„å£°æ˜,é€šè¿‡æŸ¥é˜…æºç å¯çŸ¥å®ƒçš„å£°æ˜æ˜¯public finalï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„å­—ç¬¦ä¸²çš„å€¼ä¸€æ—¦æ”¹å˜ï¼Œæˆ‘ä»¬å°±å¾—å†å‘å†…å­˜é‡æ–°ç”³è¯·ä¸€å—åœ°æ–¹å­˜æ”¾æ”¹å˜ä¹‹åçš„å­—ç¬¦ä¸²ã€‚å¾ˆæ˜¾ç„¶ï¼ŒStringæ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼Œå­—ç¬¦é•¿åº¦ä¸å¯å˜ã€‚å…¶å®è¿™æ˜¯ä¸€ä»¶å¾ˆææ€–çš„äº‹æƒ…ï¼Œå½“ä½ éœ€è¦å¤šæ¬¡æ”¹å˜æ—¶ï¼Œå¤šæ¬¡çš„æ”¹å˜äº§ç”Ÿçš„ä»£ä»·ä¸è¨€è€Œå–»ã€‚ StringBuffer StringBufferæ˜¯å­—ç¬¦ä¸²å˜é‡ï¼Œæ”¯æŒå¤šçº¿ç¨‹è¿›è¡Œå­—ç¬¦æ“ä½œï¼Œè€Œä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€‚åˆåœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ã€‚åŸå› æ˜¯åœ¨æºä»£ç ä¸­StringBuilderçš„å¾ˆå¤šæ–¹æ³•éƒ½è¢«å…³é”®å­—synchronizedä¿®é¥°äº†ï¼Œè¿™ä¹Ÿæ˜¯StringBufferå’ŒStringBuilderçš„æœ€å¤§åŒºåˆ«çš„åœ°æ–¹ã€‚ StringBuilder StringBuilderä¹Ÿæ˜¯å­—ç¬¦ä¸²å˜é‡ï¼Œä½†æ˜¯åŒºåˆ«äºStringBufferï¼Œå®ƒå¹¶ä¸æ”¯æŒå¹¶å‘æ“ä½œï¼Œéçº¿ç¨‹å®‰å…¨ï¼Œä¸é€‚åˆåœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯å…¶åœ¨å•çº¿ç¨‹ä¸­çš„æ€§èƒ½æ¯”StringBufferé«˜ã€‚ æµ‹è¯• ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839public class StringTest &#123; public static final int EchoNum = 10000; public static void TestStr()&#123; String A = new String(\"AAA\"); long StartTime = System.currentTimeMillis(); for(int i = 0;i&lt;EchoNum;i++)&#123; A+=\"A\"; &#125; long EndTime = System.currentTimeMillis(); System.out.println(\"String: \"+ (EndTime-StartTime)+\" millis has been used\"); &#125; public static void TestStrBuffer()&#123; StringBuffer A = new StringBuffer(\"AAA\"); long StartTime = System.currentTimeMillis(); for(int i = 0;i&lt;EchoNum;i++)&#123; A = A.append(\"A\"); &#125; long EndTime = System.currentTimeMillis(); System.out.println(\"StringBuffer: \"+ (EndTime-StartTime)+\" millis has been used\"); &#125; public static void TestStrBuilder()&#123; StringBuilder A = new StringBuilder(\"AAA\"); long StartTime = System.currentTimeMillis(); for(int i = 0;i&lt;EchoNum;i++)&#123; A = A.append(\"A\"); &#125; long EndTime = System.currentTimeMillis(); System.out.println(\"StringBuilder: \"+ (EndTime-StartTime)+\" millis has been used\"); &#125; public static void main(String[] args) &#123; // TODO Auto-generated method stub TestStr(); TestStrBuffer(); TestStrBuilder(); &#125;&#125; ç»“æœ ç»“æœå°±å¾ˆæ˜æ˜¾äº†ï¼ŒStringçš„æ•ˆç‡æœ€ä½ä¸‹ï¼Œåªè€ƒè™‘å•çº¿ç¨‹çš„è¯ï¼Œæ¨èä½¿ç”¨StringBuilderï¼›ä½†æ˜¯å¦‚æœæ˜¯è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„è¯ï¼Œè‚¯å®šè¦ä½¿ç”¨StringBufferã€‚ ç¨å¾®æ€»ç»“ä¸€ä¸‹ï¼š å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨æ•´ä¸ªç¨‹åºä¸­ä¸éœ€è¦ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼ŒStringæ˜¯é¦–é€‰ã€‚ å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº«çš„åŠ¨æ€å­—ç¬¦ä¸²ï¼ŒStringBufferæ˜¯æˆ‘ä»¬çš„é€‰æ‹©ã€‚ å¦‚æœä»¥ä¸Šä¸¤ç§æƒ…å†µéƒ½ä¸å­˜åœ¨ï¼ŒStringBuilderæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ ç»ƒæ‰‹ ç„¶åæ¥çœ‹ä¸€é“é˜¿é‡Œå·´å·´çš„é¢è¯•é¢˜å§ï¼Œé¢˜ç›®å†…å®¹å¦‚ä¸‹ï¼š é¢˜ç›®ï¼š (å•é€‰é¢˜)Javaä¸­ï¼ŒStringBuilderå’ŒStringBufferçš„åŒºåˆ«ï¼Œä¸‹é¢è¯´æ³•é”™è¯¯çš„æ˜¯ï¼Ÿ Aï¼š StringBufferæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ Bï¼š StringBuilderæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚ Cï¼š StringBufferå¯¹Stringç±»å‹è¿›è¡Œæ”¹å˜çš„æ—¶å€™ï¼Œå…¶å®éƒ½ç­‰åŒäºç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„Stringå¯¹è±¡ï¼Œç„¶åå°†æŒ‡é’ˆæŒ‡å‘æ–°çš„Stringå¯¹è±¡ã€‚ Dï¼š æ•ˆç‡æ¯”è¾ƒ String &lt; StringBuffer &lt; StringBuilderï¼Œä½†æ˜¯åœ¨ String S1 = â€œThis is only aâ€ + &quot; simple&quot; + &quot; testâ€œæ—¶ï¼ŒStringçš„æ•ˆç‡æœ€é«˜ã€‚ åˆ†æï¼š Aï¼ŒBå°±ä¸ç”¨å¤šè¯´äº†ï¼Œè‚¯å®šæ˜¯æ­£ç¡®çš„ã€‚Cé¡¹ä¸€çœ¼å…¶å®å°±èƒ½çœ‹å‡ºæ¥æ˜¯é”™è¯¯çš„ï¼ŒStringBufferå’ŒStringBuilderéƒ½æ˜¯å­—ç¬¦ä¸²å˜é‡ï¼Œå¹¶ä¸éœ€è¦é‡æ–°ç”³è¯·å†…å­˜å­˜æ”¾æ–°çš„å¯¹è±¡ã€‚Dé¡¹ä¸­çš„åä¸€éƒ¨åˆ†String S1 = â€œThis is only aâ€+ â€œSimpleâ€+â€œTestâ€ï¼Œå…¶å®è¿™ä¸ªåœ°æ–¹å¹¶æ²¡æœ‰å­—ç¬¦ä¸²æ“ä½œå¤„ç†ï¼Œåªæ˜¯ç®€å•çš„String S1 = â€œThis is only a simple testâ€ï¼Œæ‰€ä»¥æ•ˆç‡æœ€é«˜ã€‚","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"é¢è¯•","slug":"é¢è¯•","permalink":"http://weafteam.github.io/tags/é¢è¯•/"}]},{"title":"å¾®ä¿¡å…¬ä¼—å·åå°åœ¨SpringBoot2.0ä¸­çš„å®ç°ï¼ˆä¸Šï¼‰","slug":"2018-04-30/wechat-for-java-backend","date":"2018-05-01T10:13:02.000Z","updated":"2018-05-29T01:27:49.896Z","comments":true,"path":"posts/637facd6/","link":"","permalink":"http://weafteam.github.io/posts/637facd6/","excerpt":"","text":"ç°åœ¨å¾®ä¿¡åœ¨ä¸­å›½ä½œä¸ºæœ€é‡è¦çš„ç¤¾äº¤è½¯ä»¶ï¼Œç›¸ä¿¡å¾ˆå¤šäººéƒ½ä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·ã€‚ è€Œä¸”å¾®ä¿¡å…¬ä¼—å·ä¹Ÿæˆä¸ºä¸€äº›ä¼ä¸šä¼ æ’­èµ„è®¯æœ€å¥½çš„å¹³å°ã€‚ é‚£ä¹ˆä»Šå¤©å°±æ¥è®²ä¸‹å¾®ä¿¡å…¬ä¼—å·åå°å…·ä½“å¦‚ä½•æ¥å®ç°ã€‚ ä¸€ã€ç”³è¯·å…¬ä¼—å· â€”â€”- é¦–å…ˆæˆ‘ä»¬æ ¹æ®è‡ªå·±æ´»ç€ä¼ä¸šçš„æ‰€éœ€çš„ä¸œè¥¿ï¼Œé€‰å®šå¥½ä¸€ä¸‹å‡ ç§ç±»åˆ«çš„è´¦å·ã€‚ ä¸åŒçš„è´¦æˆ·æ‹¥æœ‰çš„æƒé™ä¸å°½ç›¸åŒã€‚ è¿™ä¸ªæˆ‘ä»¬å¯ä»¥æ ¹æ®æƒé™æ–‡æ¡£è¿›è¡ŒæŸ¥çœ‹ï¼ æ¥å£æƒé™ï¼šhttps://mp.weixin.qq.com/advanced/advanced?action=table&amp;token=1776791094&amp;lang=zh_CN ç„¶åå°±æ˜¯æ ¹æ®è‡ªå·±çš„æ¥å£çš„è¦æ±‚ï¼Œå»å®¡æ‰¹ã€‚ äºŒã€è®¾ç½®åŸºæœ¬é…ç½® â€”â€”â€” è¿™é‡Œéœ€è¦æˆ‘ä»¬å…ˆå¼€å¯è‡ªå·±çš„å¼€å‘è€…å¯†ç ã€‚ï¼ˆè¿™ä¸ªæ˜¯æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨çš„ï¼‰ æœåŠ¡å™¨åœ°å€ï¼ˆURLï¼‰:è¿™é‡Œéœ€è¦è®¾ç½®å…¬ç½‘å¯è®¿é—®çš„æ¥å£ ä»¤ç‰Œï¼ˆTokenï¼‰ï¼šè¿™å—æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ª32ä¸ºUUIDçš„å­—ç¬¦ä¸²ã€‚ æ›´å¤šç»†èŠ‚è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319 ä¸‰ã€ä»£ç çš„å®ç° å…¶ä»–çš„ä¹Ÿå°±ä¸å¤šè¯´äº†ï¼Œç›´æ¥ä¸Šä»£ç ã€‚ æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªä»‹å…¥æŒ‡å—ä¸­ï¼Œå¾®ä¿¡éœ€è¦éªŒè¯çš„æ¥å£ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpSession;import java.io.UnsupportedEncodingException;import java.security.MessageDigest;import java.security.NoSuchAlgorithmException;import java.util.*;/**---------*/@RequestMapping(\"verification\")public String weChatVerification(String signature, String timestamp, String nonce, String echostr, HttpServletRequest request) throws AesException &#123; log.info(\"å¾®ä¿¡æ ¡éªŒå‚æ•°ï¼šsignature=&#123;&#125;ï¼Œtimestamp=&#123;&#125;ï¼Œnonce=&#123;&#125;ï¼Œechostr=&#123;&#125;\",signature,timestamp,nonce,echostr); if(signature.equals(getSHA1(token,timestamp,nonce))) return echostr; else &#123; return \"\"; &#125;&#125;private String getSHA1(String token, String timestamp, String nonce) throws AesException &#123; try &#123; String[] array = new String[] &#123; token, timestamp, nonce &#125;; StringBuffer sb = new StringBuffer(); // å­—ç¬¦ä¸²æ’åº Arrays.sort(array); for (int i = 0; i &lt; 3; i++) &#123; sb.append(array[i]); &#125; String str = sb.toString(); // SHA1ç­¾åç”Ÿæˆ MessageDigest md = MessageDigest.getInstance(\"SHA-1\"); md.update(str.getBytes()); byte[] digest = md.digest(); StringBuffer hexstr = new StringBuffer(); String shaHex = \"\"; for (int i = 0; i &lt; digest.length; i++) &#123; shaHex = Integer.toHexString(digest[i] &amp; 0xFF); if (shaHex.length() &lt; 2) &#123; hexstr.append(0); &#125; hexstr.append(shaHex); &#125; return hexstr.toString(); &#125; catch (Exception e) &#123; e.printStackTrace(); throw new AesException(AesException.ComputeSignatureError); &#125; &#125; ç°åœ¨å°±å·²ç»æ¥å…¥äº†å¾®ä¿¡å…¬ä¼—å¹³å°ã€‚","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆä¸‰ï¼‰","slug":"2018-04-23/guide-to-asyncio-3","date":"2018-05-01T03:58:22.000Z","updated":"2018-08-07T08:56:41.618Z","comments":true,"path":"posts/c99ebd1c/","link":"","permalink":"http://weafteam.github.io/posts/c99ebd1c/","excerpt":"","text":"ä¹¦æ¥ä¸Šæ–‡ã€‚ å¹¶è¡Œæ‰§è¡Œä»»åŠ¡ ä»»åŠ¡æ˜¯ä¸äº‹ä»¶å¾ªç¯äº¤äº’çš„ä¸»è¦æ–¹å¼ä¹‹ä¸€ã€‚ä»»åŠ¡åŒ…è£…åç¨‹å¹¶è·Ÿè¸ªå®ƒä»¬å®Œæˆçš„æ—¶é—´ã€‚ä»»åŠ¡æ˜¯ future çš„å­ç±»ï¼Œå› æ­¤å…¶å®ƒåç¨‹å¯ä»¥ç­‰å¾…ä»»åŠ¡ï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªç»“æœï¼Œå¯ä»¥åœ¨ä»»åŠ¡å®Œæˆåè·å–ã€‚ å¯åŠ¨ä»»åŠ¡ ä½¿ç”¨ create_task() åˆ›å»ºä»»åŠ¡å®ä¾‹ã€‚åªè¦äº‹ä»¶å¾ªç¯æ­£åœ¨è¿è¡Œä¸”åç¨‹ä¸è¿”å›ï¼Œç”Ÿæˆçš„ä»»åŠ¡å°†ä½œä¸ºäº‹ä»¶å¾ªç¯ç®¡ç†çš„å¹¶å‘æ“ä½œçš„ä¸€éƒ¨åˆ†è¿è¡Œï¼š 12345678910111213141516171819202122import asyncioasync def task_func(): print('in task_func') return 'the result'async def main(loop): print('creating task') task = loop.create_task(task_func()) print(f'waiting for &#123;task!r&#125;') return_value = await task print(f'task completed &#123;task!r&#125;') print(f'return value: &#123;return_value!r&#125;')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(event_loop))finally: event_loop.close() main() å‡½æ•°åœ¨é€€å‡ºå‰ç­‰å¾…ä»»åŠ¡è¿”å›ç»“æœï¼š 12345creating taskwaiting for &lt;Task pending coro=&lt;task_func() running at *.py:4&gt;&gt;in task_functask completed &lt;Task finished coro=&lt;task_func() done, defined at *.py:4&gt; result='the result'&gt;return value: 'the result' å–æ¶ˆä»»åŠ¡ é€šè¿‡ä¿ç•™ create_task() è¿”å›çš„ä»»åŠ¡å¯¹è±¡ï¼Œå¯ä»¥åœ¨ä»»åŠ¡å®Œæˆä¹‹å‰å–æ¶ˆå…¶æ“ä½œï¼š 1234567891011121314151617181920212223242526272829import asyncioasync def task_func(): print('in task_func') return 'the result'async def main(loop): print('creating task') task = loop.create_task(task_func()) print('canceling task') task.cancel() print(f'canceled task &#123;task!r&#125;') try: await task except asyncio.CancelledError: print('caught error from canceled task') else: print(f'task result: &#123;task.result()!r&#125;')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(event_loop))finally: event_loop.close() åœ¨å¯åŠ¨äº‹ä»¶å¾ªç¯ä¹‹å‰å–æ¶ˆä»»åŠ¡æ—¶ï¼Œawait task ä¼šæŠ›å‡º CancelledError å¼‚å¸¸ï¼š 1234creating taskcanceling taskcanceled task &lt;Task cancelling coro=&lt;task_func() running at *.py:4&gt;&gt;caught error from canceled task å¦‚æœæŸä¸ªä»»åŠ¡åœ¨ç­‰å¾…å¦ä¸€ä¸ªå¹¶å‘æ“ä½œæ—¶è¢«å–æ¶ˆï¼Œåˆ™ä¼šé€šè¿‡åœ¨å…¶ç­‰å¾…çš„ä½ç½®æŠ›å‡º CancelledError å¼‚å¸¸æ¥é€šçŸ¥è¯¥ä»»åŠ¡ï¼š 12345678910111213141516171819202122232425262728293031323334import asyncioasync def task_func(): print('in task_func, sleeping') try: await asyncio.sleep(1) except asyncio.CancelledError: print('task_func was canceled') raise return 'the result'def task_canceller(t): print('in task_canceller') t.cancel() print('canceled the task')async def main(loop): print('creating task') task = loop.create_task(task_func()) loop.call_soon(task_canceller, task) try: await task except asyncio.CancelledError: print('main() also sees task as canceled')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(event_loop))finally: event_loop.close() æ•è·è¯¥å¼‚å¸¸å¯ä»¥æ¸…ç†å·²å®Œæˆå·¥ä½œï¼š 123456creating taskin task_func, sleepingin task_cancellercanceled the tasktask_func was canceledmain() also sees task as canceled ä»åç¨‹åˆ›å»ºä»»åŠ¡ ensure_future() è¿”å›ä¸€ä¸ªä¸åç¨‹çš„æ‰§è¡Œç›¸å…³è”çš„ä»»åŠ¡ã€‚ç„¶åï¼Œå¯ä»¥å°†è¯¥ä»»åŠ¡å®ä¾‹ä¼ é€’ç»™å…¶ä»–ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥åœ¨ä¸çŸ¥é“åŸå§‹çš„åç¨‹æ˜¯å¦‚ä½•æ„é€ æˆ–è°ƒç”¨çš„æƒ…å†µä¸‹ç­‰å¾…å®ƒï¼š 1234567891011121314151617181920212223242526272829import asyncioasync def wrapped(): print('wrapped') return 'result'async def inner(task): print('inner: starting') print(f'inner: waiting for &#123;task!r&#125;') result = await task print(f'inner: task returned &#123;result!r&#125;')async def starter(): print('starter: creating task') task = asyncio.ensure_future(wrapped()) print('starter: waiting for inner') await inner(task) print('starter: inner returned')event_loop = asyncio.get_event_loop()try: print('entering event loop') result = event_loop.run_until_complete(starter())finally: event_loop.close() å¯ä»¥æ³¨æ„åˆ°ä¼ å…¥ ensure_future() çš„åç¨‹ä¸ä¼šé©¬ä¸Šå¯åŠ¨ï¼Œè€Œæ˜¯ç›´åˆ°æŸä¸ªåœ°æ–¹ç”¨ await è°ƒç”¨äº†ç”¨å®ƒåˆ›å»ºçš„ä»»åŠ¡ï¼š 12345678entering event loopstarter: creating taskstarter: waiting for innerinner: startinginner: waiting for &lt;Task pending coro=&lt;wrapped() running at *.py:4&gt;&gt;wrappedinner: task returned 'result'starter: inner returned ç”¨æ§åˆ¶ç»“æ„ç»„åˆåç¨‹ ä¸€ç³»åˆ—çº¿æ€§æ‰§è¡Œçš„åç¨‹å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨å…³é”®å­— await ç®¡ç†ã€‚å¯¹äºå¤æ‚çš„æ§åˆ¶ç»“æ„ï¼Œä¾‹å¦‚ä¸€ä¸ªåç¨‹ç­‰å¾…å…¶ä»–å‡ ä¸ªåç¨‹å¹¶è¡Œå®Œæˆï¼Œä¹Ÿå¯ä»¥ç”¨ asyncio ä¸­çš„å·¥å…·å®ç°ã€‚ ç­‰å¾…å¤šä¸ªåç¨‹ å°†ä¸€ä¸ªæ“ä½œåˆ†æˆè®¸å¤šéƒ¨åˆ†å¹¶åˆ†åˆ«æ‰§è¡Œå®ƒä»¬æ˜¯å¾ˆå¸¸è§çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œä¸‹è½½å¤šä¸ªè¿œç¨‹èµ„æºï¼Œæˆ–æŸ¥è¯¢è¿œç¨‹ APIã€‚åœ¨æ‰§è¡Œé¡ºåºæ— å…³ç´§è¦ï¼Œå¹¶ä¸”å¯èƒ½å­˜åœ¨ä»»æ„æ•°é‡çš„æ“ä½œçš„æƒ…å†µä¸‹ï¼Œwait() å¯ä»¥ç”¨äºæš‚åœä¸€ä¸ªåç¨‹ï¼Œç›´åˆ°å…¶ä»–åå°æ“ä½œå®Œæˆï¼š 123456789101112131415161718192021222324import asyncioasync def phase(i): print(f'in phase &#123;i&#125;') await asyncio.sleep(0.1 * i) print(f'done with phase &#123;i&#125;') return f'phase &#123;i&#125; result'async def main(num_phases): print('starting main') phases = [phase(i) for i in range(num_phases)] print('waiting for phases to complete') completed, pending = await asyncio.wait(phases) results = [t.result() for t in completed] print(f'results: &#123;results!r&#125;')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(3))finally: event_loop.close() åœ¨å†…éƒ¨ï¼Œwait() ä½¿ç”¨ä¸€ä¸ªé›†åˆæ¥ä¿å­˜å®ƒåˆ›å»ºçš„ä»»åŠ¡å®ä¾‹ï¼Œæ‰€ä»¥ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ã€‚wait() çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé›†åˆçš„å…ƒç»„ï¼Œç¬¬ä¸€ä¸ªä¿å­˜äº†çŠ¶æ€ä¸º done çš„ä»»åŠ¡ï¼Œç¬¬äºŒä¸ªä¿å­˜äº†çŠ¶æ€ä¸º pending çš„ä»»åŠ¡ã€‚ 123456789starting mainwaiting for phases to completein phase 1in phase 0in phase 2done with phase 0done with phase 1done with phase 2results: ['phase 1 result', 'phase 0 result', 'phase 2 result'] è°ƒç”¨ wait() æ—¶å¦‚æœæŒ‡å®šäº† timeout å‚æ•°ï¼Œæ‰ä¼šå‡ºç°çŠ¶æ€ä¸º pending çš„ä»»åŠ¡ï¼š 12345678910111213141516171819202122232425262728293031323334import asyncioasync def phase(i): print(f'in phase &#123;i&#125;') try: await asyncio.sleep(0.1 * i) except asyncio.CancelledError: print(f'phase &#123;i&#125; canceled') raise else: print(f'done with phase &#123;i&#125;') return f'phase &#123;i&#125; result'async def main(num_phases): print('starting main') phases = [phase(i) for i in range(num_phases)] print('waiting 0.1 for phases to complete') completed, pending = await asyncio.wait(phases, timeout=0.1) print(f'&#123;len(completed)&#125; completed and &#123;len(pending)&#125; pending') # å–æ¶ˆçŠ¶æ€ä¸º pending çš„ä»»åŠ¡ if pending: print('canceling tasks') for t in pending: t.cancel() print('exiting main')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(3))finally: event_loop.close() è¿™äº›çŠ¶æ€ä¸º pending çš„ä»»åŠ¡åº”è¢«å–æ¶ˆæˆ–è€…ç»§ç»­ç­‰å¾…å®ƒä»¬å®Œæˆã€‚äº‹ä»¶å¾ªç¯ç»§ç»­è¿è¡Œæ—¶è¿™äº›ä»»åŠ¡å°†ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœwait() å‡½æ•°çš„å®Œæˆè¢«è®¤ä¸ºæ‰€æœ‰æ“ä½œéƒ½å·²ç»ç»ˆæ­¢äº†ï¼Œé‚£è¿™æ ·çš„ç»“æœæ˜¯ä¸æ­£ç¡®çš„ï¼›å¦‚æœåœ¨äº‹ä»¶å¾ªç¯ç»“æŸæ—¶ä»æœªå®Œæˆè¿™äº›ä»»åŠ¡ï¼Œåˆ™ä¼šç”Ÿæˆè­¦å‘Šã€‚æ‰€ä»¥æœ‰å¿…è¦åœ¨ wait() å‡½æ•°ç»“æŸåå–æ¶ˆæ‰€æœ‰çŠ¶æ€ä¸º pending çš„ä»»åŠ¡ã€‚ 1234567891011starting mainwaiting 0.1 for phases to completein phase 0in phase 1in phase 2done with phase 01 completed and 2 pendingcanceling tasksexiting mainphase 1 canceledphase 2 canceled æ”¶é›†åç¨‹çš„ç»“æœ å¦‚æœè¦æ‰§è¡Œçš„å¤šä¸ªåç¨‹å·²ç»è¢«å®šä¹‰å¥½ï¼Œå¹¶ä¸”åªå…³å¿ƒå®ƒä»¬çš„ç»“æœï¼Œé‚£ä¹ˆ gather() æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„æ”¶é›†ç»“æœçš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132import asyncioasync def phase1(): print('in phase1') await asyncio.sleep(2) print('done with phase1') return 'phase1 result'async def phase2(): print('in phase2') await asyncio.sleep(1) print('done with phase2') return 'phase2 result'async def main(): print('starting main') print('waiting for phases to complete') results = await asyncio.gather( phase1(), phase2(), ) print(f'results: &#123;results!r&#125;')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main())finally: event_loop.close() gather() åˆ›å»ºçš„ä»»åŠ¡ä¸ä¼šå…¬å¼€ï¼Œå› æ­¤æ— æ³•å–æ¶ˆã€‚è¿”å›å€¼æ˜¯ä¸€ä¸ªç»“æœåˆ—è¡¨ï¼Œé¡ºåºä¸ä¼ é€’ç»™ gather() çš„å‚æ•°çš„é¡ºåºç›¸åŒï¼Œä¸å®é™…å®Œæˆçš„é¡ºåºæ— å…³ï¼š 1234567starting mainwaiting for phases to completein phase2in phase1done with phase2done with phase1results: [&apos;phase1 result&apos;, &apos;phase2 result&apos;] åœ¨ä»»åŠ¡å®Œæˆååšä¸€äº›äº‹ as_completed() æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå®ƒç®¡ç†å½“ä½œå‚æ•°ä¼ é€’ç»™å®ƒçš„åç¨‹åˆ—è¡¨çš„æ‰§è¡Œï¼Œæ¯æ¬¡è¿­ä»£éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ‰§è¡Œå®Œçš„åç¨‹ã€‚ä¸ wait() ä¸€æ ·ï¼Œas_completed() ä¹Ÿä¸ä¿è¯é¡ºåºï¼›ä¸ wait() ä¸åŒçš„æ˜¯å®ƒä¸ä¼šç­‰åˆ°æ‰€æœ‰åå°æ“ä½œå®Œæˆåæ‰å¯ä»¥æ‰§è¡Œå…¶å®ƒæ“ä½œï¼š 1234567891011121314151617181920212223242526272829import asyncioasync def phase(i): print(f'in phase &#123;i&#125;') await asyncio.sleep(0.5 - (0.1 * i)) print(f'done with phase &#123;i&#125;') return f'phase &#123;i&#125; result'async def main(num_phases): print('starting main') phases = [phase(i) for i in range(num_phases)] print('waiting for phases to complete') results = [] for next_to_complete in asyncio.as_completed(phases): print(f'start &#123;next_to_complete&#125;') answer = await next_to_complete print(f'received answer &#123;answer!r&#125;') results.append(answer) print(f'results: &#123;results!r&#125;') return resultsevent_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(3))finally: event_loop.close() è¿™ä¸ªä¾‹å­å¯åŠ¨äº†å‡ ä¸ªåç¨‹ï¼Œè¿™äº›åç¨‹ä»¥å®ƒä»¬å¼€å§‹é¡ºåºçš„ç›¸åé¡ºåºç»“æŸã€‚å½“ç”Ÿæˆå™¨è¢«æ¶ˆè€—æ—¶ï¼Œå¾ªç¯ä½¿ç”¨ awaitç­‰å¾…åç¨‹çš„ç»“æœï¼š 123456789101112starting mainwaiting for phases to completein phase 0in phase 1in phase 2done with phase 2received answer 'phase 2 result'done with phase 1received answer 'phase 1 result'done with phase 0received answer 'phase 0 result'results: ['phase 2 result', 'phase 1 result', 'phase 0 result'] å‚è€ƒèµ„æ–™ Executing Tasks Concurrently Composing Coroutines with Control Structures","categories":[],"tags":[]},{"title":"asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆäºŒï¼‰","slug":"2018-04-16/guide-to-asyncio-2","date":"2018-04-24T15:43:20.000Z","updated":"2018-08-07T08:56:41.617Z","comments":true,"path":"posts/84801e4e/","link":"","permalink":"http://weafteam.github.io/posts/84801e4e/","excerpt":"","text":"ä¹¦æ¥ä¸Šæ–‡ã€‚ è°ƒåº¦å¸¸è§„å‡½æ•° é™¤äº†ç®¡ç†åç¨‹å’Œ I / O å›è°ƒä¹‹å¤–ï¼Œasyncio äº‹ä»¶å¾ªç¯è¿˜å¯ä»¥æ ¹æ®å¾ªç¯ä¸­çš„è®¡æ—¶å™¨è°ƒåº¦å¸¸è§„å‡½æ•°ã€‚ ç«‹å³è°ƒåº¦ å¦‚æœå‡½æ•°æ‰§è¡Œçš„æ—¶æœºæ— å…³ç´§è¦ï¼Œcall_soon() å¯ä»¥ç”¨äºåœ¨äº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€æ¬¡è¿­ä»£ä¸­è°ƒåº¦å‡½æ•°ã€‚ 123456789101112131415161718192021222324import asyncioimport functoolsdef callback(arg, *, kwarg='default'): print(f'callback invoked with &#123;arg&#125; and &#123;kwarg&#125;')async def main(loop): print('registering callbacks') loop.call_soon(callback, 1) wrapped = functools.partial(callback, kwarg='not default') loop.call_soon(wrapped, 2) await asyncio.sleep(0.1)event_loop = asyncio.get_event_loop()try: print('entering event loop') event_loop.run_until_complete(main(event_loop))finally: print('closing event loop') event_loop.close() call_soon() çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°ï¼Œå‰©ä¸‹çš„ä½ç½®å‚æ•°éƒ½ä¼šè¢«ä¼ é€’ç»™å›è°ƒå‡½æ•°ã€‚å¦‚æœæƒ³ä¼ å…¥å…³é”®å­—å‚æ•°ï¼Œå°±éœ€è¦ç”¨åˆ° functools.partical()ã€‚ å›è°ƒå‡½æ•°æŒ‰ç…§è°ƒåº¦é¡ºåºè¢«ä¾æ¬¡è°ƒç”¨ï¼š 12345entering event loopregistering callbackscallback invoked with 1 and defaultcallback invoked with 2 and not defaultclosing event loop æœ‰å»¶è¿Ÿçš„è°ƒåº¦ è¦å°†å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ¨è¿Ÿåˆ°å°†æ¥çš„æŸä¸ªæ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨ call_later()ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»¥ç§’ä¸ºå•ä½çš„å»¶è¿Ÿï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°ã€‚ 1234567891011121314151617181920212223import asynciodef callback(n): print(f'callback &#123;n&#125; invoked')async def main(loop): print('registering callbacks') loop.call_later(0.2, callback, 1) loop.call_later(0.1, callback, 2) loop.call_soon(callback, 3) await asyncio.sleep(0.4)event_loop = asyncio.get_event_loop()try: print('entering event loop') event_loop.run_until_complete(main(event_loop))finally: print('closing event loop') event_loop.close() åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç›¸åŒçš„å›è°ƒå‡½æ•°å‚ä¸äº†ä¸‰æ¬¡è°ƒåº¦ï¼Œåˆ†åˆ«ä½¿ç”¨äº†å‡ ä¸ªä¸åŒçš„å»¶è¿Ÿå’Œä¸åŒçš„å‚æ•°ã€‚æœ€åä½¿ç”¨äº† call_soon()ï¼Œå®ƒä½¿å›è°ƒå‡½æ•°åœ¨æ‰€æœ‰å»¶è¿Ÿè°ƒåº¦ä¹‹å‰è°ƒç”¨ï¼Œè¿™è¡¨æ˜ call_soon() é€šå¸¸æ„å‘³ç€æœ€å°å»¶è¿Ÿï¼š 123456entering event loopregistering callbackscallback 3 invokedcallback 2 invokedcallback 1 invokedclosing event loop åœ¨ç‰¹å®šæ—¶é—´è°ƒåº¦ è¿˜å¯ä»¥åœ¨ç‰¹å®šæ—¶é—´è°ƒåº¦å‡½æ•°ã€‚äº‹ä»¶å¾ªç¯ä½¿ç”¨å•è°ƒæ—¶é’Ÿï¼Œè€Œä¸æ˜¯ Unix æ—¶é’Ÿï¼Œä»¥ç¡®ä¿å½“å‰çš„å€¼æ°¸ä¸å›å½’ã€‚è¦åœ¨ç‰¹å®šçš„æ—¶é—´è°ƒåº¦ï¼Œå¿…é¡»ä½¿ç”¨äº‹ä»¶å¾ªç¯çš„time()æ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728import asyncioimport timedef callback(n, loop): print(f'callback &#123;n&#125; invoked at &#123;loop.time()&#125;')async def main(loop): now = loop.time() print(f'clock time: &#123;time.time()&#125;') print(f'loop time: &#123;now&#125;') print('registering callbacks') loop.call_at(now + 0.2, callback, 1, loop) loop.call_at(now + 0.1, callback, 2, loop) loop.call_soon(callback, 3, loop) await asyncio.sleep(1)event_loop = asyncio.get_event_loop()try: print('entering event loop') event_loop.run_until_complete(main(event_loop))finally: print('closing event loop') event_loop.close() å¯ä»¥æ³¨æ„åˆ°äº‹ä»¶å¾ªç¯å†…çš„æ—¶é—´ä¸ time.time() ä¸ä¸€è‡´ï¼š 12345678entering event loopclock time: 1524502404.7036376loop time: 4562.515registering callbackscallback 3 invoked at 4562.515callback 2 invoked at 4562.625callback 1 invoked at 4562.718closing event loop å¼‚æ­¥äº§ç”Ÿç»“æœ futureæ˜¯å°šæœªå®Œæˆçš„å·¥ä½œçš„ç»“æœã€‚äº‹ä»¶å¾ªç¯å¯ä»¥ç›‘è§†futureå¯¹è±¡çš„çŠ¶æ€ç›´åˆ°å®ƒå®Œæˆï¼Œä»è€Œå…è®¸åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ç­‰å¾…å¦ä¸€éƒ¨åˆ†å®ŒæˆæŸäº›å·¥ä½œã€‚ ç­‰å¾… future futureå°±åƒåç¨‹ï¼Œæ‰€ä»¥ä»»ä½•ç”¨äºå¤„ç†åç¨‹çš„æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç†futureã€‚è¿™ä¸ªä¾‹å­å°†futureä¼ é€’ç»™äº‹ä»¶å¾ªç¯çš„run_until_complete()æ–¹æ³•ã€‚è®°ä½æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡ä¸­æåˆ°çš„ï¼Œé€šå¸¸æˆ‘ä»¬ä¸åº”è¯¥è‡ªè¡Œåˆ›å»º future å¯¹è±¡ï¼Œè¿™é‡Œåªä¸ºæ¼”ç¤ºã€‚ 1234567891011121314151617181920212223import asynciodef mark_done(future, result): print(f'setting future result to &#123;result!r&#125;') future.set_result(result)event_loop = asyncio.get_event_loop()try: all_done = asyncio.Future() print('scheduling mark_done') event_loop.call_soon(mark_done, all_done, 'the result') print('entering event loop') result = event_loop.run_until_complete(all_done) print(f'returned result: &#123;result!r&#125;')finally: print('closing event loop') event_loop.close()print(f'future result: &#123;all_done.result()!r&#125;') è°ƒç”¨ set_result() æ—¶ï¼Œfuture çš„çŠ¶æ€ä¼šè¢«æ›´æ”¹ä¸ºå·²å®Œæˆï¼Œfutureçš„å®ä¾‹å°†ä¿å­˜ç»“æœï¼Œå¹¶è¿”å›ï¼š 123456scheduling mark_doneentering event loopsetting future result to 'the result'returned result: 'the result'closing event loopfuture result: 'the result' future ä¹Ÿå¯ä»¥ä¸ await ä¸€èµ·ä½¿ç”¨ï¼š 1234567891011121314151617181920212223import asynciodef mark_done(future, result): print(f'setting future result to &#123;result!r&#125;') future.set_result(result)async def main(loop): all_done = asyncio.Future() print('scheduling mark_done') loop.call_soon(mark_done, all_done, 'the result') result = await all_done print(f'returned result: &#123;result!r&#125;')event_loop = asyncio.get_event_loop()try: event_loop.run_until_complete(main(event_loop))finally: event_loop.close() future çš„ç»“æœç”± await è¿”å›ï¼š 123scheduling mark_donesetting future result to 'the result'returned result: 'the result' future çš„å›è°ƒ é™¤äº†åƒåç¨‹ä¸€æ ·å·¥ä½œä¹‹å¤–ï¼Œfutureè¿˜å¯ä»¥åœ¨å®Œæˆæ—¶è°ƒç”¨å›è°ƒå‡½æ•°ã€‚ 1234567891011121314151617181920212223242526import asyncioimport functoolsdef callback(future, n): print(f'&#123;n&#125;: future done: &#123;future.result()&#125;')async def register_callbacks(all_done): print('registering callbacks on future') all_done.add_done_callback(functools.partial(callback, n=1)) all_done.add_done_callback(functools.partial(callback, n=2))async def main(all_done): await register_callbacks(all_done) print('setting result of future') all_done.set_result('the result')event_loop = asyncio.get_event_loop()try: all_done = asyncio.Future() event_loop.run_until_complete(main(all_done))finally: event_loop.close() æ·»åŠ å›è°ƒçš„å‡½æ•°åªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œå³å›è°ƒå‡½æ•°ï¼›å›è°ƒå‡½æ•°ä¹Ÿåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³ future å®ä¾‹ã€‚è‹¥è¦ä¼ é€’å…¶ä»–å‚æ•°ç»™å›è°ƒå‡½æ•°ï¼Œè¦ä½¿ç”¨ functools.partical() ã€‚å›è°ƒå‡½æ•°æŒ‰æ³¨å†Œé¡ºåºè¢«è°ƒç”¨ï¼š 1234registering callbacks on futuresetting result of future1: future done: the result2: future done: the result å‚è€ƒèµ„æ–™ Scheduling Calls to Regular Functions Producing Results Asynchronously","categories":[],"tags":[]},{"title":"Kafkaåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ","slug":"2018-04-23/SpringBoot-integration-with-Kafka","date":"2018-04-23T10:13:02.000Z","updated":"2018-08-12T09:51:01.068Z","comments":true,"path":"posts/23949c22/","link":"","permalink":"http://weafteam.github.io/posts/23949c22/","excerpt":"","text":"ä¸€ã€Windowså¹³å°Kafkaçš„ç¯å¢ƒæ­å»º æ³¨æ„ï¼šç¡®ä¿JAVAç¯å¢ƒå˜é‡çš„æ­£ç¡® 1.ZooKeeperçš„å®‰è£… Kafkaçš„è¿è¡Œä¾èµ–äºZookeeperï¼Œæ‰€ä»¥éœ€è¦å…ˆå®‰è£…Zookeeper. Zookeeperä¸‹è½½åœ°å€ï¼šZookeeper è§£å‹å‡ºæ¥ï¼Œæ”¾åœ¨æŒ‡å®šä½ç½®ã€‚ åœ¨confæ–‡ä»¶å¤¹ä¸‹ä¿®æ”¹zoo_sample.cfgåä¸ºzoo.cfg ç„¶åæ‰“å¼€zoo.cfg æ·»åŠ ä¸€ä¸‹å˜é‡ï¼ˆå¦‚æœæ²¡æœ‰è¯·æ·»åŠ ï¼Œå­˜åœ¨è¯·ä¿®æ”¹ï¼‰ 12dataDir=D:\\data\\logs\\zookeeper dataLogDir=D:\\data\\logs\\zookeeper ç„¶åè¿›å…¥binç›®å½•åŒå‡»zkServer.cmdè¿è¡Œã€‚å¦‚ä¸‹å›¾ï¼š 2.Kafkaçš„å®‰è£… Kafkaä¸‹è½½åœ°å€ï¼šKafka è§£å‹æ–‡ä»¶åˆ°æŒ‡å®šåœ°æ–¹ æ‰“å¼€configä¸‹çš„server.properties ä¿®æ”¹ä»¥ä¸‹å˜é‡ 1log.dirs=D:\\data\\logs\\kafka æˆ‘ä»¬å¯ä»¥çœ‹åˆ°binç›®å½•ä¸‹çš„æ˜¯linuxçš„å¯åŠ¨è„šæœ¬ï¼Œç„¶åæœ‰ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹è£…ç€windowsçš„è„šæœ¬ã€‚ æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹æ‰“å¼€å‘½ä»¤è¡Œï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨Kafkaã€‚ æˆ‘ä»¬åœ¨è¿è¡Œå‰éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ ç¡®è®¤JAVAç¯å¢ƒå˜é‡æ²¡æœ‰é—®é¢˜ è·¯å¾„ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œä¸ç„¶å¯èƒ½ä¼šå‡ºç°æ— æ³•åŠ è½½ä¸»ç±»çš„é”™è¯¯ã€‚ å‡ºç°æ— æ³•åŠ è½½ä¸»ç±»é”™è¯¯ï¼Œå¯ä¿®æ”¹bin-run-class.batä¸­ set COMMAND=%JAVA% %KAFKA_HEAP_OPTS% %KAFKA_JVM_PERFORMANCE_OPTS% %KAFKA_JMX_OPTS% %KAFKA_LOG4J_OPTS% -cp %CLASSPATH% %KAFKA_OPTS% %* ä¸­â€œ%CLASSPATH%â€åŠ ä¸ŠåŒå¼•å· 1.\\bin\\windows\\kafka-server-start.bat .\\config\\server.properties äºŒã€SpringBoot2.0ç›¸å…³é…ç½® pomæ–‡ä»¶åŠ å…¥ä»¥ä¸‹ä¾èµ– pom.xml 123456&lt;!-- kafka --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt; &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt; &lt;version&gt;2.1.5.RELEASE&lt;/version&gt; &lt;/dependency&gt; æˆ‘è¿™é‡ŒSpringBootçš„é…ç½®æ–‡ä»¶ä½¿ç”¨çš„æ˜¯YAMLã€‚ åœ¨ç›¸åº”ç¯å¢ƒä¸­é…ç½®Kafka ##### application-local.yml 12345678910111213141516171819202122232425262728293031323334server: port: 7777spring: datasource: name: test driverClassName: com.mysql.jdbc.Driver url: jdbc:mysql://..... username: ... password: .... redis: database: 0 host: localhost port: 6379 jedis: pool: min-idle: 0 max-idle: 8 max-active: 8 max-wait: -1ms password: 123456 kafka: consumer: group-id: foo auto-offset-reset: earliest key-deserializer: org.apache.kafka.common.serialization.StringDeserializer value-deserializer: org.apache.kafka.common.serialization.StringDeserializer producer: key-serializer: org.apache.kafka.common.serialization.StringSerializer value-serializer: org.apache.kafka.common.serialization.StringSerializer bootstrap-servers: localhost:9092app: topic: foo: foo.t å¯ä»¥ä»…å…³æ³¨spring.kafkaå’Œapp.topicèŠ‚ç‚¹ æ›´å¤šspring.kafkaé…ç½®ä¿¡æ¯è¯·æŸ¥çœ‹å®˜ç½‘æ–‡æ¡£ ä¸‰ã€ä»£ç  ä¸»è¦ä»£ç ç»“æ„ æ¶ˆè´¹è€…ä»£ç  12345678910111213141516171819202122package com.xxx.kafka.consumer;import lombok.extern.slf4j.Slf4j;import org.springframework.kafka.annotation.KafkaListener;import org.springframework.messaging.handler.annotation.Payload;import org.springframework.stereotype.Service;/** * @Author ï¼šyaxuSong * @Description: * @Date: 17:56 2018/4/23 * @Modified by: */@Slf4j@Servicepublic class Receiver &#123; @KafkaListener(topics = \"$&#123;app.topic.foo&#125;\") public void listen(@Payload String message) &#123; log.info(\"received message='&#123;&#125;'\", message); &#125;&#125; ç”Ÿäº§è€…ä»£ç  1234567891011121314151617181920212223242526272829package com.xxx.kafka.producer;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.kafka.core.KafkaTemplate;import org.springframework.stereotype.Service;/** * @Author ï¼šyaxuSong * @Description: * @Date: 17:57 2018/4/23 * @Modified by: */@Service@Slf4jpublic class Sender &#123; @Autowired private KafkaTemplate&lt;String, String&gt; kafkaTemplate; @Value(\"$&#123;app.topic.foo&#125;\") private String topic; public void send(String message)&#123; log.info(\"sending message='&#123;&#125;' to topic='&#123;&#125;'\", message, topic); kafkaTemplate.send(topic, message); &#125;&#125; æµ‹è¯•ä»£ç  1234567891011121314151617181920212223242526272829package com.xxx.controller;import com.xxx.controller.entry.ResMsg;import com.xxx.Sender;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;/** * @Author ï¼šyaxuSong * @Description: * @Date: 11:21 2018/4/21 * @Modified by: */@Slf4j@RequestMapping(\"test\")@RestControllerpublic class TestController &#123; @Autowired private Sender sender; @RequestMapping(\"send\") public ResMsg send(String content)&#123; sender.send(\"Spring Kafka and Spring Boot Send Message:\"+content); return ResMsg.success(); &#125;&#125; å››ã€ç®€å•çš„æµ‹è¯• è¿è¡Œé¡¹ç›® æµ‹è¯•å‘é€ æŸ¥çœ‹æ¥æ”¶ç»“æœï¼š äº”ã€SpringBoot-Demo æœ¬äººæœ€è¿‘ä½¿ç”¨é˜¿é‡Œäº‘çš„Kafkaå‘ç°æ²¡æœ‰SpringBootçš„Demoä¾¿å†™äº†ä¸€ä¸ªã€‚ ä»£ç åœ°å€ï¼šhttps://github.com/songyaxu/kafka-springboot-demo æœ¬æ–‡å‚è€ƒåœ°å€https://docs.spring.io/spring-kafka/docs/2.1.5.RELEASE/reference/html/","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"chapter-06-AIR","slug":"2018-04-16/TensorFlowåŸºç¡€æ“ä½œ(3)","date":"2018-04-22T06:31:24.000Z","updated":"2018-05-29T01:27:49.852Z","comments":true,"path":"posts/3cae9921/","link":"","permalink":"http://weafteam.github.io/posts/3cae9921/","excerpt":"","text":"TensorFlow åŸºç¡€ï¼ˆ3ï¼‰ hello,å¤§å®¶å¥½ï¼Œå‡ å¤©æˆ‘ä»¬ç»§ç»­å­¦ä¹ åŸºç¡€çŸ¥è¯†ï¼Œä¸ºæˆ‘ä»¬ä»¥åå»ºç«‹æ¨¡å‹æ‰“ä¸‹åŸºç¡€ã€‚ä¸»è¦æ˜¯æœ€è¿‘æœ‰ç‚¹å¿™ï¼Œæ‰€ä»¥æ¯ä¸€å‘¨çš„å†…å®¹ä¼šå°‘ä¸€äº›ï¼Œè¯·å¤§å®¶è°…è§£ï¼Œéšåæ…¢æ…¢åŠ å¿«è¿›åº¦ã€‚ è¿™ä¸€æ¬¡æˆ‘ä»¬è®²ä¸€ä¸‹batchçš„æ¦‚å¿µï¼Œä»¥åŠä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®²è¿‡batchè¿™ä¸ªæ¦‚å¿µçš„ã€‚å¤§å®¶åº”è¯¥ä¸ä¼šé™Œç”Ÿ Working with Batch and Stochastic Training 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091import tensorflow as tfimport matplotlib.pyplot as pltimport numpy as npfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()# éšæœºæ¢¯åº¦è®­ç»ƒ# ç”Ÿæˆæ•°æ®x_vals = np.random.normal(1., 0.1, 100)y_vals = np.repeat(10., 100)x_data = tf.placeholder(shape = [1], dtype = tf.float32)y_target = tf.placeholder(shape = [1], dtype = tf.float32)# Aå°±ç›¸å½“äºæƒé‡å’¯A = tf.Variable(tf.random_normal(shape = [1]))my_output = tf.multiply(x_data, A)# æ³¨æ„æˆ‘ä»¬ä¸Šä¸€æ¬¡çš„losså‡½æ•°å“¦loss = tf.square(my_output - y_target)my_opt = tf.train.GradientDescentOptimizer(0.02) # 0.02å°±æ˜¯å­¦ä¹ ç‡train_step = my_opt.minimize(loss)init = tf.global_variables_initializer()sess.run(init)# å¼€å§‹è®­ç»ƒæ¨¡å‹loss_stochastic = []for i in range(100): rand_index = np.random.choice(100) # éšæœºé€‰å–ä¸€ä¸ªæ ·æœ¬è¿›è¡Œè®­ç»ƒ rand_x = [x_vals[rand_index]] rand_y = [y_vals[rand_index]] sess.run(train_step, feed_dict = &#123;x_data: rand_x, y_target: rand_y&#125;) if (i + 1) % 5 == 0: print('Step #' + str(i + 1) + ' A = ' + str(sess.run(A))) temp_loss = sess.run(loss, feed_dict = &#123;x_data: rand_x, y_target: rand_y&#125;) print('Loss = ' + str(temp_loss)) loss_stochastic.append(temp_loss) # batch train ops.reset_default_graph()sess = tf.Session()batch_size = 25x_vals = np.random.normal(1, 0.1, 100)y_vals = np.repeat(10., 100)x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32) # çœ‹å‡ºæ¥å˜åŒ–äº†å§ï¼Ÿy_target = tf.placeholder(shape=[None, 1], dtype=tf.float32) # è¿™é‡Œä¹Ÿæ˜¯A = tf.Variable(tf.random_normal(shape=[1,1]))my_output = tf.matmul(x_data, A)# æ˜¯ä¸æ˜¯l2lossloss = tf.reduce_mean(tf.square(my_output - y_target))# è¿™é‡Œå·²ç»å¼ºè°ƒè¿‡å¾ˆå¤šéäº†init = tf.global_variables_initializer()sess.run(init)# è¿™é‡Œæ˜¯ä¼˜åŒ–å™¨my_opt = tf.train.GradientDescentOptimizer(0.02)train_step = my_opt.minimize(loss)loss_batch = []# Run Loopfor i in range(100): rand_index = np.random.choice(100, size=batch_size) # çœ‹å‡ºæ¥åŒºåˆ«äº†ä¹ˆï¼Ÿ rand_x = np.transpose([x_vals[rand_index]]) rand_y = np.transpose([y_vals[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) if (i+1)%5==0: print('Step #' + str(i+1) + ' A = ' + str(sess.run(A))) temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) print('Loss = ' + str(temp_loss)) loss_batch.append(temp_loss)plt.plot(range(0, 100, 5), loss_stochastic, 'b-', label='Stochastic Loss')plt.plot(range(0, 100, 5), loss_batch, 'r--', label='Batch Loss, size=20')plt.legend(loc='upper right', prop=&#123;'size': 11&#125;)plt.show() è®©ä½ æ„Ÿå—ä¸€äº›ï¼Œbatchè®­ç»ƒçš„lossæ”¶æ•›ï¼š ä½ å°±è¯´ä¸Šé¢çš„ä½ ç†è§£æ²¡ç†è§£ï¼Œæ²¡ç†è§£è¦å¥½å¥½ç†è§£ç†è§£äº†~ï¼ï¼ï¼ è¿™ä¸ªå°±æ˜¯ç»“åˆäº†ï¼ŒæŠŠæ‰€æœ‰ä¸Šé¢ä»‹ç»çš„åŸºç¡€ç»“åˆåœ¨ä¸€èµ·ï¼Œä½ è¯´è¯´æ˜¯ä¸æ˜¯å¾ˆæ£’ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172# è”åˆæ‰€æœ‰çš„åŸºç¡€æ“ä½œï¼Œå¼„ä¸€ä¸ªåˆ†ç±»çš„ä¾‹å­ï¼ŒæœŸä¸æœŸå¾…import matplotlib.pyplot as pltimport numpy as npfrom sklearn import datasetsimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()iris = datasets.load_iris() # å°†é¸¢å°¾èŠ±æ•°æ®é›†ä¸‹ä¸‹æ¥ æ€»å…±æ˜¯å››ä¸ªå±æ€§çš„æ•°æ®é›†ï¼Œæ ¹æ®å››ä¸ªç§ç±»ï¼Œé¢„æµ‹ç§ç±»ï¼Œæ€»å…±ä¸‰ç±»binary_target = np.array([1. if x==0 else 0. for x in iris.target]) # å°†labelä½œä¸ºäºŒåˆ†ç±»é—®é¢˜iris_2d = np.array([[x[2], x[3]] for x in iris.data]) # å°†åä¸¤ä¸ªå±æ€§å–å‡ºæ¥ç”¨ä½œç§ç±»é¢„æµ‹batch_size = 20sess = tf.Session()x1_data = tf.placeholder(shape=[None, 1], dtype=tf.float32)x2_data = tf.placeholder(shape=[None, 1], dtype=tf.float32)y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32)A = tf.Variable(tf.random_normal(shape=[1, 1]))b = tf.Variable(tf.random_normal(shape=[1, 1]))my_mult = tf.matmul(x2_data, A)my_add = tf.add(my_mult, b)my_output = tf.subtract(x1_data, my_add) # ä½ èƒ½ä¸èƒ½è‡ªå·±ä½¿ç”¨å…¬å¼å†™å‡ºæˆ‘ä»¬é¢„æµ‹ç§ç±»çš„å…¬å¼å‘¢ï¼Ÿxentropy = tf.nn.sigmoid_cross_entropy_with_logits(logits = my_output, labels = y_target)my_opt = tf.train.GradientDescentOptimizer(0.05)train_step = my_opt.minimize(xentropy)init = tf.global_variables_initializer()sess.run(init)for i in range(1000): rand_index = np.random.choice(len(iris_2d), size=batch_size) #rand_x = np.transpose([iris_2d[rand_index]]) rand_x = iris_2d[rand_index] rand_x1 = np.array([[x[0]] for x in rand_x]) rand_x2 = np.array([[x[1]] for x in rand_x]) #rand_y = np.transpose([binary_target[rand_index]]) rand_y = np.array([[y] for y in binary_target[rand_index]]) sess.run(train_step, feed_dict=&#123;x1_data: rand_x1, x2_data: rand_x2, y_target: rand_y&#125;) if (i+1)%200==0: print('Step #' + str(i+1) + ' A = ' + str(sess.run(A)) + ', b = ' + str(sess.run(b)))# Pull out slope/intercept[[slope]] = sess.run(A)[[intercept]] = sess.run(b)# Create fitted linex = np.linspace(0, 3, num=50)ablineValues = []for i in x: ablineValues.append(slope*i+intercept)# Plot the fitted line over the datasetosa_x = [a[1] for i,a in enumerate(iris_2d) if binary_target[i]==1]setosa_y = [a[0] for i,a in enumerate(iris_2d) if binary_target[i]==1]non_setosa_x = [a[1] for i,a in enumerate(iris_2d) if binary_target[i]==0]non_setosa_y = [a[0] for i,a in enumerate(iris_2d) if binary_target[i]==0]plt.plot(setosa_x, setosa_y, 'rx', ms=10, mew=2, label='setosa')plt.plot(non_setosa_x, non_setosa_y, 'ro', label='Non-setosa')plt.plot(x, ablineValues, 'b-')plt.xlim([0.0, 2.7])plt.ylim([0.0, 7.1])plt.suptitle('Linear Separator For I.setosa', fontsize=20)plt.xlabel('Petal Length')plt.ylabel('Petal Width')plt.legend(loc='lower right')plt.show() ä¸Šé¢æ˜¯åˆ†ç±»çš„ç»“æœå›¾ éªŒè¯æ¨¡å‹ï¼š æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šå®ç°ä¸€ä¸ªç®€å•çš„å›å½’æ¨¡å‹å’Œåˆ†ç±»æ¨¡å‹ï¼Œåˆ†åˆ«åšå‡ºä»–ä»¬çš„æµ‹è¯•æ ·ä¾‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113# å›å½’æ¨¡å‹import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()batch_size = 25x_vals = np.random.normal(1, 0.1, 100)y_vals = np.repeat(10., 100)x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32)y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32)# å°†æ•°æ®åˆ†ä¸ºè®­ç»ƒé›†80%å’Œæµ‹è¯•é›†20%train_indices = np.random.choice(len(x_vals), round(len(x_vals) * 0.8), replace = False)test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))x_vals_train = x_vals[train_indices]x_vals_test = x_vals[test_indices]y_vals_train = y_vals[train_indices]y_vals_test = y_vals[test_indices]# ä¸‹é¢è¿™äº›æˆ‘ä»¬æ˜¯ä¸æ˜¯å†™äº†å¥½å¤šéäº†ï¼ï¼ï¼A = tf.Variable(tf.random_normal(shape=[1,1]))my_output = tf.matmul(x_data, A)# è¿˜è®°å¾—æˆ‘ä¹ˆï¼Ÿä½ ä¹Ÿè§è¿‡æˆ‘å¥½å¤šæ¬¡äº†ï¼Œä¸ºä»€ä¹ˆåŠ reduce_mean? ä½ ä¹ŸçŸ¥é“batchå¯ä¸æ˜¯ä¸€ä¸ªæ•°æ®æ ·æœ¬å‘€~loss = tf.reduce_mean(tf.square(my_output - y_target))# åˆ›å»ºä¼˜åŒ–å™¨my_opt = tf.train.GradientDescentOptimizer(0.02)train_step = my_opt.minimize(loss)init = tf.global_variables_initializer()sess.run(init)# ç®—äº†ï¼Œæˆ‘éƒ½ä¸æƒ³å†™äº†ï¼Œä½ è¯´è¯´æˆ‘ä»¬å†™äº†å¤šå°‘éäº†ï¼Œè¯¥ä¼šäº†for i in range(100): rand_index = np.random.choice(len(x_vals_train), size=batch_size) rand_x = np.transpose([x_vals_train[rand_index]]) rand_y = np.transpose([y_vals_train[rand_index]]) sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) if (i+1)%25==0: print('Step #' + str(i+1) + ' A = ' + str(sess.run(A))) print('Loss = ' + str(sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)))# éªŒè¯å‘€ï¼Œä¸€èˆ¬è®­ç»ƒå‡ºæ¥çš„æ¨¡å‹ï¼Œæˆ‘ä»¬è¦åœ¨æµ‹è¯•é›†ä¸Šé¢è·‘çš„å¾ˆå¥½ï¼Œåœ¨æµ‹è¯•é›†ä¸Šé¢çš„å‡†ç¡®ç‡å¥½äº†ï¼Œæ²¡ç”¨ï¼Œå› ä¸ºæœ‰è¿‡æ‹Ÿåˆçš„å«Œç–‘ï¼Œå°±æ˜¯å¤ªè®¤çœŸäº†ã€‚æ³›åŒ–èƒ½åŠ›å¤ªå·®ã€‚# éªŒè¯å›å½’æ¨¡å‹ï¼Œé‚£å°±è¦ä½¿ç”¨losså»è¡¡é‡è¿™ä¸ªæ¨¡å‹çš„å¥½åäº†mse_test = sess.run(loss, feed_dict=&#123;x_data: np.transpose([x_vals_test]), y_target: np.transpose([y_vals_test])&#125;)mse_train = sess.run(loss, feed_dict=&#123;x_data: np.transpose([x_vals_train]), y_target: np.transpose([y_vals_train])&#125;)print('MSE on test:' + str(np.round(mse_test, 2)))print('MSE on train:' + str(np.round(mse_train, 2)))# åˆ†ç±»å·¥ä½œï¼Œå°ä¼™ä¼´æ˜¯ä¸æ˜¯ä¸€ç›´è§‰å¾—åˆ†ç±»å·¥ä½œæ€ä¹ˆèƒ½åšï¼Œé‚£æ˜¯å› ä¸ºä½¿ç”¨æ¦‚ç‡åšçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯”å¦‚æ¦‚ç‡å¤§äºæŸä¸€ä¸ªé˜ˆå€¼0.5 æˆ‘ä»¬å°±åˆ†ä¸ºæŸä¸€ç±»ï¼Œå¦‚æœå°äºæˆ‘ä»¬å°±åˆ†ä¸ºå¦ä¸€ç§ï¼Œè¿™æ˜¯äºŒåˆ†ç±»ï¼Œé‚£ä¹ˆå¤šåˆ†ç±»æ€ä¹ˆåŠï¼Œé‚£ä¹ˆå°±è¦å¼•å…¥one-hotç¼–ç ï¼Œè¿™ä¸ªæˆ‘ä»¬åæ¥æ…¢æ…¢æ·±å…¥ã€‚å…ˆæ¥çœ‹ä¾‹å­ops.reset_default_graph()sess = tf.Session()batch_size = 25# ä¸€æ¯›ä¸€æ ·x_vals = np.concatenate((np.random.normal(-1, 1, 50), np.random.normal(2, 1, 50)))y_vals = np.concatenate((np.repeat(0., 50), np.repeat(1., 50)))x_data = tf.placeholder(shape=[1, None], dtype=tf.float32)y_target = tf.placeholder(shape=[1, None], dtype=tf.float32)train_indices = np.random.choice(len(x_vals), round(len(x_vals)*0.8), replace=False)test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))x_vals_train = x_vals[train_indices]x_vals_test = x_vals[test_indices]y_vals_train = y_vals[train_indices]y_vals_test = y_vals[test_indices]A = tf.Variable(tf.random_normal(mean=10, shape=[1]))my_output = tf.add(x_data, A) # æˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ªåŠ æ³•æ“ä½œ# å…³é”®è¿˜æ˜¯losså‡½æ•°xentropy = tf.reduce_mean(tf.nn.sigmoid_cross_entropy_with_logits(logits = my_output, labels = y_target))my_opt = tf.train.GradientDescentOptimizer(0.05)train_step = my_opt.minimize(xentropy)init = tf.global_variables_initializer()sess.run(init)# Run loopfor i in range(1800): rand_index = np.random.choice(len(x_vals_train), size=batch_size) rand_x = [x_vals_train[rand_index]] rand_y = [y_vals_train[rand_index]] sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) if (i + 1) % 200 == 0: print('Step #' + str(i+1) + ' A = ' + str(sess.run(A))) print('Loss = ' + str(sess.run(xentropy, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)))# åœ¨æµ‹è¯•é›†ä¸Šé¢åšæµ‹è¯•y_prediction = tf.squeeze(tf.round(tf.nn.sigmoid(tf.add(x_data, A))))correct_prediction = tf.equal(y_prediction, y_target)accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))acc_value_test = sess.run(accuracy, feed_dict=&#123;x_data: [x_vals_test], y_target: [y_vals_test]&#125;)acc_value_train = sess.run(accuracy, feed_dict=&#123;x_data: [x_vals_train], y_target: [y_vals_train]&#125;)print('Accuracy on train set: ' + str(acc_value_train))print('Accuracy on test set: ' + str(acc_value_test))# ç”»å‡ºåˆ†ç±»ç»“æœA_result = -sess.run(A)bins = np.linspace(-5, 5, 50)plt.hist(x_vals[0:50], bins, alpha=0.5, label='N(-1,1)', color='white')plt.hist(x_vals[50:100], bins[0:50], alpha=0.5, label='N(2,1)', color='red')plt.plot((A_result, A_result), (0, 8), 'k--', linewidth=3, label='A = '+ str(np.round(A_result, 2)))plt.legend(loc='upper right')plt.title('Binary Classifier, Accuracy=' + str(np.round(acc_value_test, 2)))plt.show() æ€»ç»“ï¼šè¿™æ¬¡ä¸‹æ¥æˆ‘ä»¬å°±æŠŠTensorFlowçš„æ‰€æœ‰åŸºç¡€å†…å®¹è®²å®Œäº†ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥ç»™æˆ‘å‘é‚®ä»¶ï¼šair@weaf.top å¸Œæœ›å¤§å®¶æŠŠè¿™äº›åŸºç¡€çŸ¥è¯†å¥½å¥½ç¨³å›ºä¸€ä¸‹ï¼ŒåŠ¡å¿…ç‰¢è®°äºå¿ƒï¼Œéšåæˆ‘ä»¬å°±ä¼šå¾ˆé¡ºåˆ©ã€‚ ä¸‹ä¸€æ¬¡æˆ‘ä»¬å°±ä¼šå¼€å§‹ä¸€äº›åŸºæœ¬ç®—æ³•~ï¼ŒåŸºç¡€å­¦å®Œä¸å¾—å¥½å¥½ç»ƒä¹ ä¸€ä¸‹ä¹ˆï¼Ÿ","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"å”¯å¯†æ–‡è§£å¯†ï¼ˆé’ˆå¯¹VigenereåŠ å¯†ï¼‰","slug":"2018-04-16/å”¯å¯†æ–‡è§£å¯†ï¼ˆé’ˆå¯¹VigenereåŠ å¯†ï¼‰","date":"2018-04-21T01:38:12.000Z","updated":"2018-05-29T01:27:49.860Z","comments":true,"path":"posts/899ccb0/","link":"","permalink":"http://weafteam.github.io/posts/899ccb0/","excerpt":"","text":"ä¸Šæ¬¡è¯´åˆ°äº†VigenereåŠ å¯†ä»¥åŠè§£å¯†çš„ç®—æ³•ï¼Œä½†æ˜¯å¦‚ä½•ç ´è¯‘è¿™æ ·çš„å¯†ç ï¼Œä¹Ÿæ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œè¿™ç¯‡åšå®¢å°±æ˜¯å®ç°ä¸€ä¸ªè¿™æ ·çš„ç ´è¯‘ï¼Œä¸»è¦é’ˆå¯¹çš„æ˜¯é€šè¿‡VigenereåŠ å¯†çš„å¯†æ–‡ï¼Œé‚£ä¹ˆå°±å¼€å§‹å§~ ä»»åŠ¡è¦æ±‚ï¼š a.ç¼–ç¨‹å®ç°VigenereåŠ å¯†/è§£å¯†ç³»ç»Ÿï¼Œå¹¶åˆ†æå’Œè¯„ä¼°è¯¥ç®—æ³•çš„å®‰å…¨æ€§ã€‚ b.ç¼–ç¨‹å®ç°å”¯å¯†æ–‡ç ´è¯‘ç³»ç»Ÿï¼Œèƒ½å¤Ÿç ´è¯‘å¯†é’¥ä¸º2åˆ°4ä¸ªå­—ç¬¦çš„Vigenereå¯†æ–‡ï¼Œå¹¶åˆ†æå¦‚ä½•åŠ å¿«ç ´è¯‘é€Ÿåº¦ã€‚ æ—¶é—´è¦æ±‚ï¼š å¸ƒç½®ä»»åŠ¡åï¼Œåœ¨3å‘¨ä¹‹å†…å®Œæˆã€‚ æäº¤ç»“æœï¼šå·²è®¾è®¡å¹¶æµ‹è¯•å¥½çš„ç¨‹åºï¼ŒåŒ…æ‹¬æºç ã€å¯æ‰§è¡Œç¨‹åºã€æµ‹è¯•æ•°æ®é›†ã€å®éªŒæŠ¥å‘Šã€‚ åŸç†ä»‹ç»ï¼š æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„è¯´æ³•ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹CaesaråŠ å¯†çš„ç¼ºç‚¹ã€‚å¯¹äºä¸€ä¸ªç¨å¾®æœ‰ç‚¹ç‚¹å¯†ç å­¦åŠŸåº•çš„äººæ¥è¯´ï¼ŒCaesarå¯†ç çš„å®‰å…¨å¼ºåº¦å‡ ä¹ä¸ºé›¶ï¼Œæ­£å¦‚æˆ‘ä»¬æ˜¯ä¸Šç¯‡åšå®¢æ‰€è®²çš„CaesaråŠ å¯†ï¼ŒåŠ å¯†çš„å¯†é’¥å……å…¶é‡ä¹Ÿå°±24ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡ç§»åŠ¨å¤šå°‘ä¸ªå­—ç¬¦ï¼Œæœ€å¤šè¿›è¡Œ24æ¬¡çŒœè§£å°±å¯ä»¥ç ´è¯‘å‡ºæ¥ã€‚ å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ç§è§£å¯†æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒç¬¨çš„ä¸€ç§æ–¹æ³•ï¼Œè€Œä¸”è¿™ç§æ–¹æ³•å¹¶ä¸é€‚ç”¨äºæˆ‘ä»¬çš„Vigenereå¯†ç ç ´è§£ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡åŠæ³•åˆ—ä¸¾å‡ºæ‰€æœ‰çš„æƒ…å†µã€‚ è¿™é‡Œæˆ‘ä»¬ä»‹ç»ç ´è§£Caesarå¯†ç çš„å¦ä¸€ç±»æ–¹æ³•ï¼Œç§°ä¸ºï¼ˆå­—æ¯ï¼‰é¢‘åº¦åˆ†ææ³•ã€‚ å‡è®¾å¤§å®¶éƒ½çŸ¥é“ï¼Œè‹±è¯­ä¸­çš„å­—æ¯å‡ºç°æ¦‚ç‡æ˜¯æœ‰å·®åˆ«çš„ï¼Œå…¶å®å¯¹äºä¸€ç§ç‰¹å®šçš„è‡ªç„¶è¯­è¨€ï¼Œå¦‚æœæ–‡æœ¬è¶³å¤Ÿé•¿ï¼Œé‚£ä¹ˆå„ä¸ªå­—æ¯å‡ºç°çš„æ¦‚ç‡å°±æ˜¯ç›¸å¯¹ç¨³å®šçš„ï¼Œå…·ä½“çš„æ¦‚ç‡ç»Ÿè®¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™æ ·æˆ‘ä»¬æ ¹æ®ä»¥ä¸Šçš„é¢‘åº¦è¡¨ï¼Œä»¥åŠæ ¹æ®æˆ‘ä»¬çš„Caesarå¯†æ–‡ä¸­çš„ç»Ÿè®¡å‡ºæ¥çš„å„ä¸ªè¯çš„æ‹¼è¯»ï¼Œå¯¹åº”ä¸€ä¸‹å°±å¯ä»¥æ‰¾åˆ°å¯†æ–‡å¯¹åº”çš„æ˜æ–‡ï¼Œå†ç„¶åå¯¹åº”å¯†æ–‡ä¸æ˜æ–‡å°±å¯ä»¥æ‰¾åˆ°ç›¸åº”çš„åŠ å¯†çš„å¯†é’¥ã€‚å¾ˆç®€å•å§ï¼Œå…¶å®èƒ½æƒ³åˆ°è¿™ä¸ªæƒ³æ³•å¹¶ä¸ç®€å•çš„ã€‚ ç”±ä¸Šä¸€ç¯‡çš„åšå®¢ä»‹ç»ï¼Œä½ åº”è¯¥çŸ¥é“äº†Vigenereå¯†ç åˆ†è§£ä¹‹åå…¶å®å°±æ˜¯å¤šä¸ªCaesarå¯†ç ã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚æœçŸ¥é“å¯†é’¥çš„é•¿åº¦ï¼Œæ¯éš”è¿™ä¸ªé•¿åº¦å°†åŸæ¥çš„Vigenereå¯†æ–‡åˆ†è§£ä¸ºå¤šä¸ªCaesarå¯†æ–‡ï¼Œå†åšä¸Šè¿°çš„å·¥ä½œï¼Œæ˜¯ä¸æ˜¯å°±å®Œæˆäº†æˆ‘ä»¬çš„ç ´è¯‘å·¥ä½œï¼Ÿæ€è·¯å°±æ˜¯è¿™æ ·ï¼Œä½†æ˜¯æ€ä¹ˆç¡®å®šæˆ‘ä»¬çš„å¯†é’¥é•¿åº¦ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å°±è®²è®²æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å§ã€‚ ç¡®å®šå¯†é’¥é•¿åº¦ è¿™ä¸ªåœ¨ç½‘ä¸Šæœé›†åˆ°çš„èµ„æ–™å…¶å®æ˜¯æœ‰ä¸¤ç§æ–¹æ³•çš„ã€‚åˆ†åˆ«ç§°ä¸ºKasiskiæµ‹è¯•æ³•å’ŒFriedmanæµ‹è¯•æ³•ï¼Œä½†æ˜¯æœ¬æ–‡ç»™åˆ°çš„ä»£ç æ˜¯åŸºäºç¬¬äºŒä¸ªæ–¹æ³•çš„ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆè®²è®²è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ€è·¯å§ã€‚ Kasiskiæµ‹è¯•æ³• Kasiskiæµ‹è¯•æ³•æ˜¯ç”±Friedrich Kasiskiäº1863å¹´ç»™å‡ºäº†å…¶æè¿°ï¼Œç„¶è€Œæ—©åœ¨çº¦1854å¹´è¿™ä¸€æ–¹æ³•å°±ç”±Charles Babbageé¦–å…ˆå‘ç°ã€‚ å®ƒçš„æ€æƒ³æ˜¯åŸºäºè¿™æ ·çš„ä¸€ä¸ªäº‹å®ï¼šä¸¤ä¸ªç›¸åŒçš„æ˜æ–‡æ®µåŠ å¯†æˆç›¸åŒçš„å¯†æ–‡æ®µï¼Œå®ƒä»¬ä¹‹é—´çš„è·ç¦»ä¸ºLengthï¼Œé‚£ä¹ˆå¯†é’¥çš„é•¿åº¦å°±æ˜¯è·ç¦»Lengthçš„çº¦æ•°ã€‚ è€Œå½“å¯†æ–‡çš„é•¿åº¦å¾ˆé•¿æ—¶ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¤šæ‰¾å‡ ç»„è¿™æ ·æ‹¥æœ‰é‡å¤å¯†æ–‡æ®µï¼Œæ‰¾å‡ºä»–ä»¬é—´è·çš„ç›¸åŒçº¦æ•°å°±æ˜¯å¯†é’¥çš„é•¿åº¦ã€‚ å…³äºè¿™ä¸ªæ–¹æ³•çš„ä»£ç ï¼Œæœ¬æ–‡å¹¶æœªæ¶‰åŠï¼Œå¤§å®¶æœ‰å…´è¶£å¯è‡ªè¡ŒæŸ¥é˜…èµ„æ–™å®ç°ã€‚ å¦ï¼šæœºæ™ºçš„ä½ ä¹Ÿè®¸å‘ç°äº†ï¼Œæˆ‘ä»¬è¿™ç§æ–¹æ³•å…¶å®å¹¶æ²¡æœ‰æ¶‰åŠåˆ°æˆ‘ä»¬åˆšæ‰è¯´çš„ç»Ÿè®¡é¢‘åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹ä¸æ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœ¬æ–‡çš„é‡ç‚¹äº†ã€‚ Friedmanæµ‹è¯•æ³• é¦–å…ˆæˆ‘ä»¬è®²ä¸€ä¸ªæ¦‚å¿µï¼šé‡åˆæŒ‡æ•°ï¼ˆICï¼Œindex of coincidenceï¼‰ã€‚ç™¾åº¦ä¸€ä¸‹è¿™ä¸ªæ¦‚å¿µçš„è¯ï¼Œæœåˆ°çš„ç»“æœå¯èƒ½ä¸æ˜¯ä»¤äººå¾ˆæ»¡æ„ï¼Œæˆ‘ä¹Ÿæ˜¯æ‰¾äº†å¾ˆå¤šèµ„æ–™ï¼Œæ„Ÿè§‰å¦‚ä¸‹çš„æ¦‚å¿µè¯´çš„å¾ˆæ¸…æ¥šï¼Œåˆ†äº«ç»™å¤§å®¶ã€‚ é‡åˆæŒ‡æ•°è¡¨ç¤ºï¼šä¸¤ä¸ªéšæœºé€‰å‡ºçš„å­—æ¯æ˜¯ç›¸åŒçš„æ¦‚ç‡ï¼Œå¯¹äºæˆ‘ä»¬çš„è‹±æ–‡å­—æ¯æ¥è¯´ï¼Œå³ä»¥ä¸Šæ¦‚ç‡å³ä¸ºéšæœºé€‰å‡ºä¸¤ä¸ªAçš„æ¦‚ç‡+éšæœºé€‰å‡ºä¸¤ä¸ªBçš„æ¦‚ç‡+â€¦.+éšæœºé€‰å‡ºä¸¤ä¸ªZçš„æ¦‚ç‡ã€‚ å‰äººä¹Ÿä¸ºæˆ‘ä»¬ç»Ÿè®¡å‡ºäº†è¿™ä¸ªæ•°å­—ï¼Œä¸º0.65ã€‚ å³ P(A)^2 + P(B)^2 + P(C)^2 + â€¦ + P(Z)^2 = 0.65. è€Œåˆ©ç”¨è¿™ä¸€æ¦‚å¿µæ¨æµ‹å¯†é’¥é•¿åº¦çš„åŸç†ä¸ºï¼šå¯¹äºä¸€ä¸ªCaesarå¯†ç çš„åºåˆ—ï¼Œç”±äºæ‰€æœ‰å­—æ¯çš„ä½ç§»ç¨‹åº¦æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯†æ–‡çš„é‡åˆæŒ‡æ•°ç­‰äºåŸæ–‡çš„é‡åˆæŒ‡æ•°ã€‚ å°†è¿™ä¸€æ¦‚å¿µè¿ç§»åˆ°æˆ‘ä»¬çš„Vigenereå¯†æ–‡ä¸Šï¼Œæˆ‘ä»¬åªè¦è®¡ç®—ä¸åŒå¯†é’¥é•¿åº¦ä¸‹çš„é‡åˆæŒ‡æ•°ï¼Œåªè¦é‡åˆæŒ‡æ•°æ¥è¿‘æœŸæœ›çš„0.65æ—¶ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ¨æµ‹å½“å‰çš„é•¿åº¦å°±æ˜¯æˆ‘ä»¬çš„å¯†é’¥é•¿åº¦ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š å¯†æ–‡ä¸ºï¼šAAABBCCDDDDEEEFG é¦–å…ˆæˆ‘ä»¬æµ‹è¯•å¯†é’¥é•¿åº¦=1ï¼Œé¦–å…ˆç»Ÿè®¡ä¸Šè¿°å¯†æ–‡ä¸­æ¯ä¸ªå­—æ¯å‡ºç°çš„æ¬¡æ•°ï¼ˆA-Zï¼‰ï¼š Aï¼š3 Bï¼š2 Cï¼š2 Dï¼š4 Eï¼š3 F:1 G:1 H:0 â€¦ Zï¼š0 ç„¶åæˆ‘ä»¬æ ¹æ®ä¸Šè¿°å…¬å¼è®¡ç®—é‡åˆæŒ‡æ•°Pï¼Œå¦‚æœ P ï¼= 0.65ï¼Œæˆ‘ä»¬å°±å°è¯•å¯†é’¥é•¿åº¦2ã€‚ å‡è®¾ä¸º2çš„è¯ï¼Œå°†ä¸Šè¿°çš„å¯†æ–‡åˆ†æˆä¸¤ç»„ï¼š ç»„1ï¼šA A B C D D E F ç»„2ï¼šA B C D D E E G å†åˆ†åˆ«è®¡ç®—é‡åˆæŒ‡æ•°ï¼Œå¦‚æœè¿™ä¸¤ä¸ªçš„é‡åˆæŒ‡æ•°éƒ½æ¥è¿‘äº0.65ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åŸºæœ¬ç¡®å®šå¯†é’¥çš„é•¿åº¦ä¸º2äº†ã€‚å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆç»§ç»­å¾€ä¸‹åˆ†ã€‚ ç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬å¾—åˆ°çš„å¯†æ–‡é•¿åº¦è¶Šé•¿ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•åˆ†æå¾—åˆ°çš„æ•ˆæœä¼šæ›´å¥½ï¼Œå®é™…ä¸Šåœ¨æˆ‘æµ‹è¯•çš„ç»“æœä¸­ï¼Œä¹Ÿç¡®å®ç¬¦åˆåˆšæ‰çš„è¯´æ³•ã€‚ å®ç° Friedmanæµ‹è¯•æ³•ç¡®å®šå¯†é’¥é•¿åº¦ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859// Friedmanæµ‹è¯•æ³•ç¡®å®šå¯†é’¥é•¿åº¦ public int Friedman(String ciphertext) &#123; int keyLength = 1; // çŒœæµ‹å¯†é’¥é•¿åº¦ double[] IC; // é‡åˆæŒ‡æ•° double average; // å¹³å‡é‡åˆæŒ‡æ•° ArrayList&lt;String&gt; cipherGroup; // å¯†æ–‡åˆ†ç»„ while (true) &#123; IC = new double[keyLength]; cipherGroup = new ArrayList&lt;String&gt;(); average = 0; // 1 å…ˆæ ¹æ®å¯†é’¥é•¿åº¦åˆ†ç»„ for (int i = 0; i &lt; keyLength; ++i) &#123; StringBuffer temporaryGroup = new StringBuffer(); for (int j = 0; i + j * keyLength &lt; ciphertext.length(); ++j) &#123; temporaryGroup.append(ciphertext.charAt(i + j * keyLength)); &#125; cipherGroup.add(temporaryGroup.toString()); &#125; // 2 å†è®¡ç®—æ¯ä¸€ç»„çš„é‡åˆæŒ‡æ•° for (int i = 0; i &lt; keyLength; ++i) &#123; String subCipher = new String(cipherGroup.get(i)); // å­ä¸² HashMap&lt;Character, Integer&gt; occurrenceNumber = new HashMap&lt;Character, Integer&gt;(); // å­—æ¯åŠå…¶å‡ºç°çš„æ¬¡æ•° // 2.1 åˆå§‹åŒ–å­—æ¯åŠå…¶æ¬¡æ•°é”®å€¼å¯¹ for (int h = 0; h &lt; 26; ++h) &#123; occurrenceNumber.put((char) (h + 65), 0); &#125; // 2.2 ç»Ÿè®¡æ¯ä¸ªå­—æ¯å‡ºç°çš„æ¬¡æ•° for (int j = 0; j &lt; subCipher.length(); ++j) &#123; occurrenceNumber.put(subCipher.charAt(j), occurrenceNumber.get(subCipher.charAt(j)) + 1); &#125; // 2.3 è®¡ç®—é‡åˆæŒ‡æ•° double denominator = Math.pow((double) subCipher.length(), 2); for (int k = 0; k &lt; 26; ++k) &#123; double o = (double) occurrenceNumber.get((char) (k + 65)); IC[i] += o * (o - 1); &#125; IC[i] /= denominator; &#125; // 3 åˆ¤æ–­é€€å‡ºæ¡ä»¶,é‡åˆæŒ‡æ•°çš„å¹³å‡å€¼æ˜¯å¦å¤§äº0.065 for (int i = 0; i &lt; keyLength; ++i) &#123; average += IC[i]; &#125; average /= (double) keyLength; if (average &gt;= 0.06) &#123; break; &#125; else &#123; keyLength++; &#125; &#125; // while--end return keyLength; &#125;// Friedman--end ç ´è¯‘å¯†æ–‡ è¿™é‡Œç»™å‡ºæ¥çš„æ˜¯æ‰“å°å‡ºæ¥äº†å…·ä½“çš„å¯†é’¥å’Œæ˜æ–‡ï¼Œå®é™…ä¸Šå¯ä»¥ç›´æ¥å†™ä¸€ä¸ªç±»ï¼Œç±»ä¸­è®¾è®¡ä¸¤ä¸ªå±æ€§å€¼ï¼Œä¸€ä¸ªå¯†é’¥å±æ€§ï¼Œä¸€ä¸ªæ˜æ–‡å±æ€§ï¼Œç›´æ¥èµ‹å€¼ä¸‹å°±å¯ä»¥äº†ã€‚ç›¸ä¿¡æœºæ™ºçš„ä½ å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374public void decryptCipher(int keyLength, String ciphertext) &#123; int[] key = new int[keyLength]; ArrayList&lt;String&gt; cipherGroup = new ArrayList&lt;String&gt;(); double[] probability = new double[] &#123; 0.082, 0.015, 0.028, 0.043, 0.127, 0.022, 0.02, 0.061, 0.07, 0.002, 0.008, 0.04, 0.024, 0.067, 0.075, 0.019, 0.001, 0.06, 0.063, 0.091, 0.028, 0.01, 0.023, 0.001, 0.02, 0.001 &#125;; // 1 å…ˆæ ¹æ®å¯†é’¥é•¿åº¦åˆ†ç»„ for (int i = 0; i &lt; keyLength; ++i) &#123; StringBuffer temporaryGroup = new StringBuffer(); for (int j = 0; i + j * keyLength &lt; ciphertext.length(); ++j) &#123; temporaryGroup.append(ciphertext.charAt(i + j * keyLength)); &#125; cipherGroup.add(temporaryGroup.toString()); &#125; // 2 ç¡®å®šå¯†é’¥ for (int i = 0; i &lt; keyLength; ++i) &#123; double MG; // é‡åˆæŒ‡æ•° int flag; // ç§»åŠ¨ä½ç½® int g = 0; // å¯†æ–‡ç§»åŠ¨gä¸ªä½ç½® HashMap&lt;Character, Integer&gt; occurrenceNumber; // å­—æ¯å‡ºç°æ¬¡æ•° String subCipher; // å­ä¸² while (true) &#123; MG = 0; flag = 65 + g; subCipher = new String(cipherGroup.get(i)); occurrenceNumber = new HashMap&lt;Character, Integer&gt;(); // 1.1 åˆå§‹åŒ–å­—æ¯åŠå…¶æ¬¡æ•° for (int h = 0; h &lt; 26; ++h) &#123; occurrenceNumber.put((char) (h + 65), 0); &#125; // 1.2 ç»Ÿè®¡å­—æ¯å‡ºç°æ¬¡æ•° for (int j = 0; j &lt; subCipher.length(); ++j) &#123; occurrenceNumber.put(subCipher.charAt(j), occurrenceNumber.get(subCipher.charAt(j)) + 1); &#125; // 1.3 è®¡ç®—é‡åˆæŒ‡æ•° for (int k = 0; k &lt; 26; ++k, ++flag) &#123; double p = probability[k]; flag = (flag == 91) ? 65 : flag; double f = (double) occurrenceNumber.get((char) flag) / subCipher.length(); MG += p * f; &#125; // 1.4 åˆ¤æ–­é€€å‡ºæ¡ä»¶ if (MG &gt;= 0.055) &#123; key[i] = g; break; &#125; else &#123; ++g; &#125; &#125; // while--end &#125; // for--end // 3 æ‰“å°å¯†é’¥ StringBuffer keyString = new StringBuffer(); for (int i = 0; i &lt; keyLength; ++i) &#123; keyString.append((char) (key[i] + 65)); &#125; System.out.println(&quot;\\nå¯†é’¥ä¸º: &quot; + keyString.toString()); // 4 è§£å¯† StringBuffer plainBuffer = new StringBuffer(); for (int i = 0; i &lt; ciphertext.length(); ++i) &#123; int keyFlag = i % keyLength; int change = (int) ciphertext.charAt(i) - 65 - key[keyFlag]; char plainLetter = (char) ((change &lt; 0 ? (change + 26) : change) + 65); plainBuffer.append(plainLetter); &#125; System.out.println(&quot;\\næ˜æ–‡ä¸ºï¼š\\n&quot; + plainBuffer.toString().toLowerCase()); &#125; å‚è€ƒèµ„æ–™ï¼š ç»´å‰å°¼äºšå¯†ç åŠå…¶ç ´è§£ ã€å¯†ç å­¦ã€‘ç»´å‰å°¼äºšå¯†ç åŠ è§£å¯†åŸç†åŠå…¶ç ´è§£ç®—æ³•Javaå®ç° ä»¥ä¸Šæ˜¯æœ¬æ¬¡åšå®¢çš„å…¨éƒ¨å†…å®¹ï¼Œæ„Ÿè°¢é©»è¶³~","categories":[{"name":"å¯†ç å­¦","slug":"å¯†ç å­¦","permalink":"http://weafteam.github.io/categories/å¯†ç å­¦/"}],"tags":[{"name":"å¯†ç å­¦","slug":"å¯†ç å­¦","permalink":"http://weafteam.github.io/tags/å¯†ç å­¦/"}]},{"title":"Redisåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ","slug":"2018-04-16/SpringBoot-integration-with-Redis","date":"2018-04-18T09:57:12.000Z","updated":"2018-05-29T01:27:49.847Z","comments":true,"path":"posts/2b2e3e2f/","link":"","permalink":"http://weafteam.github.io/posts/2b2e3e2f/","excerpt":"ä»Šå¤©å¼€å§‹ç»™å¤§å®¶åˆ†äº«Javaç›¸å…³çš„æŠ€æœ¯å¼€å‘çŸ¥è¯†ï¼Œåœ¨ä»¥åçš„å¼€å‘å’Œå­¦ä¹ ä¸­ï¼Œè¿˜å¸Œæœ›å¤§å®¶å¤šå¤šæŒ‡æ•™ï¼Œå¯¹äºæˆ‘å‘è¡¨çš„ç›¸å…³å†…å®¹ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œè¯·å¤§å®¶æŒ‡å‡ºæ¥ï¼Œä¸€èµ·å­¦ä¹ ã€‚ æ›´è¦è®°ä½è¿™å¥è¯ï¼šStay Hungry, Stay Foolish. ä¸€ã€Redisçš„å®‰è£… ä¸ºäº†æ–¹ä¾¿æ•™ç¨‹è¿™é‡Œå…ˆç®€å•ä»‹ç»Redisçš„å®‰è£…ã€‚ 1. windowså¹³å°çš„å®‰è£… ç°åœ¨å®˜ç½‘å·²ç»ä¸æä¾›windowså¹³å°çš„ä¸‹è½½ï¼Œæ‰€ä»¥åªèƒ½å»githubä¸Šä¸‹è½½å®‰è£… githubä¸‹è½½ç½‘å€ è¿›å…¥ä¹‹åé€‰æ‹©å¥½ç‰ˆæœ¬ç‚¹å‡»msiä¸‹è½½ ç„¶ååŒå‡»å®‰è£…ã€‚ é»˜è®¤æ˜¯ç›´æ¥è¿è¡Œçš„ã€‚ å¯ä»¥é€šè¿‡æ§åˆ¶å°è®¿é—®å¦‚ å…·ä½“è¯­æ³•å¯ä»¥åœ¨ç›¸å…³ç½‘ä¸ŠæŸ¥é˜…ã€‚ ### 2. Linuxå¹³å°çš„å®‰è£… ç›´æ¥åˆ°å®˜ç½‘ä¸‹è½½ Redis.io è§£å‹å¹¶å®‰è£… 1234wget http://download.redis.io/releases/redis-4.0.9.tar.gztar xzf redis-4.0.9.tar.gzcd redis-4.0.9make","text":"ä»Šå¤©å¼€å§‹ç»™å¤§å®¶åˆ†äº«Javaç›¸å…³çš„æŠ€æœ¯å¼€å‘çŸ¥è¯†ï¼Œåœ¨ä»¥åçš„å¼€å‘å’Œå­¦ä¹ ä¸­ï¼Œè¿˜å¸Œæœ›å¤§å®¶å¤šå¤šæŒ‡æ•™ï¼Œå¯¹äºæˆ‘å‘è¡¨çš„ç›¸å…³å†…å®¹ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œè¯·å¤§å®¶æŒ‡å‡ºæ¥ï¼Œä¸€èµ·å­¦ä¹ ã€‚ æ›´è¦è®°ä½è¿™å¥è¯ï¼šStay Hungry, Stay Foolish. ä¸€ã€Redisçš„å®‰è£… ä¸ºäº†æ–¹ä¾¿æ•™ç¨‹è¿™é‡Œå…ˆç®€å•ä»‹ç»Redisçš„å®‰è£…ã€‚ 1. windowså¹³å°çš„å®‰è£… ç°åœ¨å®˜ç½‘å·²ç»ä¸æä¾›windowså¹³å°çš„ä¸‹è½½ï¼Œæ‰€ä»¥åªèƒ½å»githubä¸Šä¸‹è½½å®‰è£… githubä¸‹è½½ç½‘å€ è¿›å…¥ä¹‹åé€‰æ‹©å¥½ç‰ˆæœ¬ç‚¹å‡»msiä¸‹è½½ ç„¶ååŒå‡»å®‰è£…ã€‚ é»˜è®¤æ˜¯ç›´æ¥è¿è¡Œçš„ã€‚ å¯ä»¥é€šè¿‡æ§åˆ¶å°è®¿é—®å¦‚ å…·ä½“è¯­æ³•å¯ä»¥åœ¨ç›¸å…³ç½‘ä¸ŠæŸ¥é˜…ã€‚ ### 2. Linuxå¹³å°çš„å®‰è£… ç›´æ¥åˆ°å®˜ç½‘ä¸‹è½½ Redis.io è§£å‹å¹¶å®‰è£… 1234wget http://download.redis.io/releases/redis-4.0.9.tar.gztar xzf redis-4.0.9.tar.gzcd redis-4.0.9make æœåŠ¡ç«¯è¿è¡Œè„šæœ¬ 1src/redis-server å®¢æˆ·ç«¯è¿è¡Œè„šæœ¬ 1src/redis-cli 3. SpringBoot2.0ç›¸å…³é…ç½® pomæ–‡ä»¶åŠ å…¥ä»¥ä¸‹ä¾èµ– 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt; æˆ‘è¿™é‡ŒSpringBootçš„é…ç½®æ–‡ä»¶ä½¿ç”¨çš„æ˜¯YAMLã€‚ åœ¨ç›¸åº”ç¯å¢ƒä¸­é…ç½®Redis ##### application-local.yml 1234567891011121314151617spring: datasource: name: test driverClassName: com.mysql.jdbc.Driver url: jdbc:mysql://127.0.0.1:3306/local?useUnicode=true&amp;characterEncoding=UTF-8 username: root password: root redis: database: 0 host: localhost port: 6379 jedis: pool: min-idle: 0 max-idle: 8 max-active: 8 max-wait: -1ms 4.ä»£ç çº§åˆ«é…ç½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import com.xxx.controller.entry.entity.AccessToken;import org.springframework.cache.annotation.CachingConfigurerSupport;import org.springframework.cache.annotation.EnableCaching;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.data.redis.cache.RedisCacheManager;import org.springframework.data.redis.connection.RedisConnectionFactory;import org.springframework.data.redis.connection.jedis.JedisConnectionFactory;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.data.redis.core.convert.KeyspaceConfiguration;import org.springframework.data.redis.repository.configuration.EnableRedisRepositories;import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;import org.springframework.data.redis.serializer.StringRedisSerializer;import java.util.Collections;/** * @Author ï¼šyaxuSong * @Description: * @Date: 18:35 2018/4/17 * @Modified by: */@Configuration@EnableCaching//å¢åŠ Respositoryæ”¯æŒï¼Œå¹¶ä½¿å…¶æ”¯æŒ@TimeToLive@EnableRedisRepositories(keyspaceConfiguration = RedisCacheConfig.MyKeyspaceConfiguration.class)public class RedisCacheConfig extends CachingConfigurerSupport&#123; @Bean public RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) &#123; return RedisCacheManager.builder(connectionFactory).build(); &#125;// @Bean// public RedisConnectionFactory connectionFactory() &#123;// return new JedisConnectionFactory();// &#125; @Bean public RedisTemplate&lt;?, ?&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123; RedisTemplate&lt;byte[], byte[]&gt; template = new RedisTemplate&lt;byte[], byte[]&gt;(); template.setConnectionFactory(redisConnectionFactory); return template; &#125;// @Bean// public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory)&#123;// RedisTemplate&lt;Object, Object&gt; redisTemplate = new RedisTemplate&lt;Object, Object&gt;();// redisTemplate.setConnectionFactory(redisConnectionFactory);// redisTemplate.setKeySerializer(new StringRedisSerializer());//keyåºåˆ—åŒ–// redisTemplate.setValueSerializer(new Jackson2JsonRedisSerializer(Object.class)); //valueåºåˆ—åŒ–// redisTemplate.afterPropertiesSet();// return redisTemplate;// &#125; public static class MyKeyspaceConfiguration extends KeyspaceConfiguration &#123; @Override protected Iterable&lt;KeyspaceSettings&gt; initialConfiguration() &#123; return Collections.singleton(new KeyspaceSettings(AccessToken.class, \"accessToken\")); &#125; &#125;&#125; ç¼“å­˜å¯¹è±¡AccessToken 1234567891011121314151617181920import lombok.Data;import org.springframework.data.annotation.Id;import org.springframework.data.redis.core.RedisHash;import org.springframework.data.redis.core.TimeToLive;/** * @Author ï¼šyaxuSong * @Description: * @Date: 14:26 2018/4/18 * @Modified by: */@RedisHash(\"accessToken\")@Datapublic class AccessToken &#123; @Id String id; String accessToken; @TimeToLive Long expire;&#125; åˆ›å»ºRespository 123456789101112131415import com.xxx.controller.entry.entity.AccessToken;import org.springframework.data.repository.CrudRepository;import org.springframework.stereotype.Repository;/** * @Author ï¼šyaxuSong * @Description: * @Date: 14:34 2018/4/18 * @Modified by: */@Repository// ç»§æ‰¿è‡ªCURDï¼Œé‡Œè¾¹æœ‰æœ€åŸºæœ¬çš„æ–¹æ³•public interface AccessTokenRepository extends CrudRepository&lt;AccessToken, String&gt; &#123;&#125; æ¥ä¸‹æ¥å®Œæˆè‡ªå·±çš„ä¸šåŠ¡æœåŠ¡ç±» 12345678910111213141516import com.xxx.controller.entry.entity.AccessToken;/** * @Author ï¼šyaxuSong * @Description: * @Date: 14:50 2018/4/18 * @Modified by: */public interface AccessTokenService &#123; AccessToken save(AccessToken accessToken); void delete(AccessToken accessToken); AccessToken get(String id);&#125; ä¸šåŠ¡æœåŠ¡ç±»çš„å®ç° 123456789101112131415161718192021222324252627282930313233343536import com.xxx.controller.entry.entity.AccessToken;import com.xxx.dao.repository.AccessTokenRepository;import com.xxx.service.AccessTokenService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.Optional;/** * @Author ï¼šyaxuSong * @Description: * @Date: 14:52 2018/4/18 * @Modified by: */@Service(\"accessTokenService\")public class AccessTokenServiceImpl implements AccessTokenService &#123; @Autowired private AccessTokenRepository repo; @Override public AccessToken save(AccessToken accessToken) &#123; return repo.save(accessToken); &#125; @Override public void delete(AccessToken accessToken) &#123; repo.delete(accessToken); &#125; @Override public AccessToken get(String id) &#123; Optional&lt;AccessToken&gt; accessToken = repo.findById(id); return accessToken.orElse(null); &#125;&#125; ä»¥ä¸Šå®Œæˆäº†æ•´ä¸ªæ•´åˆè¿‡ç¨‹ã€‚ ### 5. ç®€å•çš„æµ‹è¯• 12345678910111213141516171819202122232425262728293031323334import com.xxx.controller.entry.entity.AccessToken;import com.xxx.service.AccessTokenService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;/** * @Author ï¼šyaxuSong * @Description: * @Date: 15:16 2018/4/18 * @Modified by: */@RestController@RequestMapping(\"test\")public class TestController &#123; @Autowired private AccessTokenService accessTokenService; @RequestMapping(\"add\") public String test()&#123; AccessToken accessToken = new AccessToken(); accessToken.setAccessToken(\"dadaadadsdadewqeqfskksdbfdbkfsdkdajdhwke2elhsbcslc/DNDAWDAWWAFEWFSD23E2342\"); accessToken.setExpire(60L); //å•ä½ ç§’ AccessToken at = accessTokenService.save(accessToken); return \"æˆåŠŸ\"+\"é”®å€¼ä¸ºï¼š\"+at.getId(); &#125; @RequestMapping(\"get\") public String get(String id)&#123; AccessToken accessToken = accessTokenService.get(id); return accessToken==null?\"å·²è¿‡æœŸ\":accessToken.toString(); &#125;&#125; æµ‹è¯•ç»“æœï¼š æˆ‘è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªè¿‡æœŸæ—¶é—´ä¸º60sçš„tokenã€‚ æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹å¯ä»¥çœ‹åˆ°æ—¶é—´çš„å˜åŒ– ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼š ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼š ç¬¬ä¸‰æ¬¡æŸ¥è¯¢ï¼š æˆ‘ä»¬æŸ¥çœ‹ä¸‹æœ¬åœ°Rdisæ‰€æœ‰é”®å€¼æƒ…å†µï¼š è¿‡ä¸€æ®µæ—¶é—´åæŸ¥è¯¢ï¼š æˆ‘ä»¬å‘ç°ä¹‹å‰è¿˜å­˜åœ¨é”®å€¼idä¸ºc07cde6a-aec7-40f3-ad39-41862209bc9fçš„ï¼Œä½†æ˜¯å†…å®¹æ²¡æœ‰äº†ã€‚ åæ¥æŸ¥è¯¢çš„å°±è¢«åˆ é™¤äº†ï¼ˆè¿‡æœŸåä¸ä¼šç›´æ¥åˆ é™¤ï¼Œä¼šç¨æœ‰å»¶è¿Ÿï¼Œåªæœ‰idå­˜åœ¨ï¼Œå…¶ä»–éƒ½å·²è¢«åˆ é™¤ï¼‰ æˆ‘ä»¬çœ‹åˆ°é”®å€¼ä¸ºï¼šd2b97d54-1c8b-4803-8f60-6aaf3384fc32çš„æ˜¯æˆ‘ä¹‹å‰å­˜çš„TTL=7200sçš„ã€‚ è‡³æ­¤æ‰€æœ‰ç›¸å…³çš„å†…å®¹å°±ä»‹ç»å®Œäº†ã€‚ æœ¬æ–‡å‚è€ƒåœ°å€ï¼šSpring-data-redis","categories":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/categories/JAVA/"}],"tags":[{"name":"JAVA","slug":"JAVA","permalink":"http://weafteam.github.io/tags/JAVA/"}]},{"title":"Linuxä¸‹MySQLå®‰è£…","slug":"2018-04-09/three-method-for-install-mysql","date":"2018-04-17T04:07:12.000Z","updated":"2018-05-29T01:27:49.843Z","comments":true,"path":"posts/2cd32dfc/","link":"","permalink":"http://weafteam.github.io/posts/2cd32dfc/","excerpt":"æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç»3ç§æ–¹æ³•å®‰è£…MySQL ç¬¬ä¸€ç§ ä¸€ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†MySQL ä½¿ç”¨å‘½ä»¤ï¼š 1rpm -qa|grep -i mysql å¦‚æœä½¿ç”¨centosï¼Œå¯èƒ½ä¼šå‡ºç°å†²çªï¼Œè§£å†³å†²çªéœ€è¦å¸è½½mariadb é¦–å…ˆæŸ¥çœ‹æ˜¯å¦å®‰è£…äº†Mariadb 1rpm -qa|grep mariadb","text":"æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç»3ç§æ–¹æ³•å®‰è£…MySQL ç¬¬ä¸€ç§ ä¸€ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†MySQL ä½¿ç”¨å‘½ä»¤ï¼š 1rpm -qa|grep -i mysql å¦‚æœä½¿ç”¨centosï¼Œå¯èƒ½ä¼šå‡ºç°å†²çªï¼Œè§£å†³å†²çªéœ€è¦å¸è½½mariadb é¦–å…ˆæŸ¥çœ‹æ˜¯å¦å®‰è£…äº†Mariadb 1rpm -qa|grep mariadb ç„¶åå¸è½½ 1rpm -e mariadb-libs-5.5.56-2.el7.x86_64 å¼ºåˆ¶å¸è½½(å¯é€‰): 1rpm -e --nodeps mariadb-libs-5.5.56-2.el7.x86_64 äºŒã€å¦‚æœå®‰è£…äº†éœ€åˆ é™¤å·²å®‰è£…ç‰ˆæœ¬ â€”â€” åˆ é™¤å‘½ä»¤ï¼š 12rpm -e --nodeps åŒ…å( rpm -ev mysql-4.1.12-3.RHEL4.1 ) åˆ é™¤è€ç‰ˆæœ¬mysqlçš„å¼€å‘å¤´æ–‡ä»¶å’Œåº“ å‘½ä»¤ï¼š 12rm -fr /usr/lib/mysqlrm -fr /usr/include/mysql æ³¨æ„ï¼šå¸è½½å/var/lib/mysqlä¸­çš„æ•°æ®åŠ/etc/my.cnfä¸ä¼šåˆ é™¤ï¼Œå¦‚æœç¡®å®šæ²¡ç”¨åå°±æ‰‹å·¥åˆ é™¤ 12rm -f /etc/my.cnfrm -fr /var/lib/mysql ä¸‰ã€å®‰è£…mysqlå‡†å¤‡ç¯å¢ƒ æˆ‘è‡ªmysqlå®˜ç½‘ä¸‹è½½é€šç”¨çš„Linuxç‰ˆæœ¬å®‰è£…åŒ… mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz å°†ä¸‹è½½å¥½çš„åŒ…æ”¾åœ¨ /usr/local ç›®å½•ä¸‹ï¼Œæˆ–è€…æ‰§è¡Œå‘½ä»¤ï¼š 12cd /usr/localwget https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz è§£å‹ä¸‹è½½çš„æ–‡ä»¶ 1tar -zxvf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz å°†è§£å‹ä¹‹åçš„æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°/usr/local/mysql 1mv ./mysql-5.7.20-linux-glibc2.12-x86_64/* ./mysql ä¸ºmysqlåˆ›å»ºç³»ç»Ÿç”¨æˆ·(å¯é€‰ï¼Œæ–°ç‰ˆæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºç›¸åº”ç”¨æˆ·) 12groupadd mysqluseradd -r -g mysql mysql //-rå‚æ•°è¡¨ç¤ºmysqlç”¨æˆ·æ˜¯ç³»ç»Ÿç”¨æˆ·ï¼Œä¸å¯ç”¨äºç™»å½•ç³»ç»Ÿ å¹¶å˜æ›´mysqlå®‰è£…ç›®å½•çš„æ‰€å±ç”¨æˆ·å’Œç”¨æˆ·ç»„ 12chown -R mysql:mysql mysql// -R è¿­ä»£å¤„ç† å››ã€ å®‰è£…å’Œåˆå§‹åŒ– â€”â€” åˆå§‹åŒ–æ•°æ®åº“ 1./bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --lc_messages_dir=/usr/local/mysql/share --lc_messages=en_US è®°å½•åˆšåˆšè¾“å‡ºçš„å¯†ç ï¼š jk9tEao&lt;94MC é…ç½®/etc/my.cnf my.cnf äº”ã€ å¯åŠ¨ç™»å½•å’Œè®¾ç½®å¯†ç  åˆ‡æ¢åˆ°mysqlå®‰è£…ç›®å½•çš„binä¸‹å¯åŠ¨ 1./mysqld_safe --user=mysql å¯åŠ¨åå¯èƒ½æ— æ³•ä½¿ç”¨å½“å‰çª—å£ ç™»å½•è¿›å»è®¾ç½®æ–°çš„å¯†ç ï¼š 1./mysql -u root -p 12set password=password(\"root\");flush privileges; å…­ã€ æ·»åŠ åˆ°æœåŠ¡ åˆ‡æ¢åˆ° support-filesç›®å½•ä¸‹ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ 1cp mysql.server /etc/init.d/mysql ç„¶ååœæ­¢å½“å‰è¿›ç¨‹ï¼Œä½¿ç”¨æœåŠ¡å¯åŠ¨mysql 1service mysql start å¹¶æ·»åŠ mysqlç¯å¢ƒå˜é‡ åœ¨ /etc/profile çš„æ–‡ä»¶æœ«å°¾è¿½åŠ ï¼š export PATH=$PATH:/usr/local/mysql/bin ä¿å­˜åæ‰§è¡Œ 1source /etc/profile æœ€åä½¿ç”¨æ–°å¯†ç ç™»å½•åˆ°mysql ç¬¬äºŒç§ ä¸€ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†MySQL ä½¿ç”¨å‘½ä»¤ï¼š 1rpm -qa|grep -i mysql å¦‚æœä½¿ç”¨centosï¼Œå¯èƒ½ä¼šå‡ºç°å†²çªï¼Œè§£å†³å†²çªéœ€è¦å¸è½½mariadb é¦–å…ˆæŸ¥çœ‹æ˜¯å¦å®‰è£…äº†Mariadb 1rpm -qa|grep mariadb ç„¶åå¸è½½ 1rpm -e mariadb-libs-5.5.56-2.el7.x86_64 å¼ºåˆ¶å¸è½½(å¯é€‰): 1rpm -e --nodeps mariadb-libs-5.5.56-2.el7.x86_64 äºŒã€å¦‚æœå®‰è£…äº†éœ€åˆ é™¤å·²å®‰è£…ç‰ˆæœ¬ â€”â€” åˆ é™¤å‘½ä»¤ï¼š 12rpm -e --nodeps åŒ…å( rpm -ev mysql-4.1.12-3.RHEL4.1 ) åˆ é™¤è€ç‰ˆæœ¬mysqlçš„å¼€å‘å¤´æ–‡ä»¶å’Œåº“ å‘½ä»¤ï¼š 12rm -fr /usr/lib/mysqlrm -fr /usr/include/mysql æ³¨æ„ï¼šå¸è½½å/var/lib/mysqlä¸­çš„æ•°æ®åŠ/etc/my.cnfä¸ä¼šåˆ é™¤ï¼Œå¦‚æœç¡®å®šæ²¡ç”¨åå°±æ‰‹å·¥åˆ é™¤ 12rm -f /etc/my.cnfrm -fr /var/lib/mysql ä¸‰ã€å‡†å¤‡å®‰è£…çš„ç¯å¢ƒ wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-1.el7.x86_64.rpm-bundle.tar æˆ–è€…ç”¨è‡ªå·±å‡†å¤‡å¥½çš„åŒ… mysql-5.7.20-1.el7.x86_64.rpm-bundle.tar è§£å‹åŒ… 1tar -xvf mysql-5.7.20-1.el7.x86_64.rpm-bundle.tar ç„¶åæŒ‰ç…§ä»¥ä¸‹é¡ºåºå®‰è£… 1234rpm -ivh mysql-community-common-5.7.20-1.el7.x86_64.rpm rpm -ivh mysql-community-libs-5.7.20-1.el7.x86_64.rpm rpm -ivh mysql-community-client-5.7.20-1.el7.x86_64.rpm rpm -ivh mysql-community-server-5.7.20-1.el7.x86_64.rpm å››ã€å¯åŠ¨å¹¶ä¿®æ”¹å¯†ç  å®‰è£…å®Œæˆåå°±å¯ä»¥å¯åŠ¨æœåŠ¡äº† 1service mysqld start å¯åŠ¨åæŸ¥çœ‹é…ç½®æ–‡ä»¶ 1vi /etc/my.cnf æ‰¾æ‰“logæ–‡ä»¶ è¿›å…¥æŸ¥æ‰¾é»˜è®¤rootå¯†ç  1cat /var/log/mysqld.log ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ç™»å½•å¹¶ä¿®æ”¹å¯†ç  1mysql -uroot -p ä¿®æ”¹å¯†ç  12SET PASSWORD FOR &apos;root&apos;@&apos;localhost&apos; = PASSWORD(&apos;newpass&apos;);FLUSH PRIVILEGES; ç¬¬ä¸‰ç§ ä¸€ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†MySQLæ•°æ®åº“ 1rpm -qa|grep mysql å¸è½½ 1rpm -e --nodeps mysql-libs-5.1.71-1.el6.x86_64 äºŒã€å®‰è£… å®‰è£…ä¸€ä¸‹åŒ… 123456rpm -ivh MySQL-devel-5.6.23-1.linux_glibc2.5.x86_64.rpmrpm -ivh MySQL-client-5.6.23-1.linux_glibc2.5.x86_64.rpmrpm -ivh MySQL-server-5.6.23-1.linux_glibc2.5.x86_64.rpmrpm -ivh MySQL-embedded-5.6.23-1.linux_glibc2.5.x86_64.rpmrpm -ivh MySQL-shared-5.6.23-1.linux_glibc2.5.x86_64.rpmrpm -ivh MySQL-shared-compat-5.6.23-1.linux_glibc2.5.x86_64.rpm ä¸‰ã€å¯åŠ¨ç™»å½•è®¾ç½®å¯†ç  ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¼€å¯æœåŠ¡ service mysql start è·å–åˆå§‹å¯†ç ï¼š ä½¿ç”¨rootç™»å½• mysql -uroot -p ç„¶åè¯•ç”¨ä¸€ä¸‹å‘½ä»¤è®¾ç½®å¯†ç  SET PASSWORD = PASSWORD(&#39;123456&#39;);","categories":[{"name":"Linux","slug":"Linux","permalink":"http://weafteam.github.io/categories/Linux/"}],"tags":[{"name":"Linuxè¿ç»´","slug":"Linuxè¿ç»´","permalink":"http://weafteam.github.io/tags/Linuxè¿ç»´/"}]},{"title":"chapter-05-AIR","slug":"2018-04-09/TenosrFlowåŸºç¡€æ“ä½œ(2)","date":"2018-04-15T14:14:23.000Z","updated":"2018-05-29T01:27:49.835Z","comments":true,"path":"posts/7b0ee3f1/","link":"","permalink":"http://weafteam.github.io/posts/7b0ee3f1/","excerpt":"","text":"TensorFlow åŸºç¡€ï¼ˆ2ï¼‰ ä»Šå¤©æœ‰å’Œå¤§å®¶è§é¢äº†ï¼Œä»Šå¤©çš„æ–‡ç« å¯èƒ½å†…å®¹æœ‰ç‚¹å°‘ï¼Œè¿™å‘¨æœ‰å¾ˆå¤šäº‹æƒ…ï¼Œæ‰€ä»¥å°‘å†™ç‚¹ã€‚ä¸‹ä¸€å‘¨æˆ‘å°½é‡å¤šå†™ç‚¹ã€‚å¼¥è¡¥å¤§å®¶ã€‚é‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©é—²è¯å°‘è¯´ï¼Œç›´æ¥å¼€å§‹ä»Šå¤©çš„TensorFlowçš„åŸºç¡€ä»‹ç»ã€‚æ¥ç€ä¸Šä¸€èŠ‚ç»§ç»­è®²èµ·ã€‚ Loss Functions ä»Šå¤©è¿™ä¸ªå¼€å¤´å°±æ˜¯æœ€å¸¸ç”¨çš„æŸå¤±å‡½æ•°çš„å®ç°ï¼Œä½¿ç”¨ã€‚ä¸»è¦æ¶‰åŠåˆ°ä¸¤ç§æŸå¤±å‡½æ•°çš„è®¾è®¡ï¼Œæ•°å€¼é¢„æµ‹çš„å›å½’æŸå¤±å‡½æ•°ï¼Œè¿˜æœ‰åˆ†ç±»çš„æŸå¤±å‡½æ•°è®¾è®¡ã€‚é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å¼€å§‹æˆ‘ä»¬çš„å®ç°ï¼Œæœ‰ä»€ä¹ˆéš¾ç‚¹æˆ‘ä¼šæ³¨é‡Šã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940# é¦–å…ˆæˆ‘ä»¬åƒå¾€å¸¸ä¸€åœºå¯¼å…¥æˆ‘ä»¬éœ€è¦çš„æ¨¡å—import tensorflow as tfimport matplotlib.pyplot as pltfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()x_vals = tf.linspace(-1., 1., 500)target = tf.constant(0.)# l2 loss å’Œl2èŒƒæ•°å·®ä¸€ä¸ªå¹³æ–¹æ ¹l2_y_vals = tf.square(target - x_vals)l2_y_out = sess.run(l2_y_vals)# l1 loss å°±æ˜¯l1èŒƒæ•°l1_y_vals = tf.abs(target - x_vals)l1_y_out = sess.run(l1_y_vals)# Pseudo-Huber loss ä¸ºäº†è®©lossæ›´åŠ çš„å…‰æ»‘ä¸€äº›# å…·ä½“çœ‹å…¬å¼ä¸€delta = tf.constant(0.25)phuber1_y_vals = tf.multiply(tf.square(delta), tf.sqrt(1. + tf.square((target - x_vals) / delta)) - 1.)phuber1_y_out = sess.run(phuber1_y_vals)delta2 = tf.constant(5.)phuber2_y_vals = tf.multiply(tf.square(delta2), tf.sqrt(1. + tf.square((target - x_vals)/delta2)) - 1.)phuber2_y_out = sess.run(phuber2_y_vals)# ç”»å‡ºè¿™äº›å›å½’æŸå¤±å‡½æ•°x_array = sess.run(x_vals)plt.plot(x_array, l2_y_out, 'b-', label='L2 Loss')plt.plot(x_array, l1_y_out, 'r--', label='L1 Loss')plt.plot(x_array, phuber1_y_out, 'k-.', label='P-Huber Loss (0.25)')plt.plot(x_array, phuber2_y_out, 'g:', label='P-Huber Loss (5.0)')plt.ylim(-0.2, 0.4)plt.legend(loc='lower right', prop=&#123;'size': 11&#125;)plt.show()# ä½ èƒ½ä»åé¢çš„ä¸¤ä¸ªæŸå¤±å‡½æ•°ä¸­å¾—åˆ°ä»€ä¹ˆè§„å¾‹å‘¢ï¼Ÿ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748import tensorflow as tffrom tensorflow.python.framework import opsimport matplotlib.pyplot as pltops.reset_default_graph()sess = tf.Session()# Various predicted X valuesx_vals = tf.linspace(-3., 5., 500)# Target of 1.0target = tf.constant(1.)targets = tf.fill([500,], 1.)# åˆ†ç±»æŸå¤±å‡½æ•°# Hinge Loss åˆé¡µæŸå¤±å‡½æ•°# å…·ä½“è¯·è§å…¬å¼äºŒhinge_y_vals = tf.maximum(0., 1. - tf.multiply(target, x_vals))hinge_y_out = sess.run(hinge_y_vals)# äº¤å‰ç†µæŸå¤±xentropy_y_vals = - tf.multiply(target, tf.log(x_vals)) - tf.multiply((1. - target), tf.log(1. - x_vals))xentropy_y_out = sess.run(xentropy_y_vals)# sigmoid äº¤å‰ç†µx_val_input = tf.expand_dims(x_vals, 1)target_input = tf.expand_dims(targets, 1)xentropy_sigmoid_y_vals = tf.nn.softmax_cross_entropy_with_logits(logits = x_val_input, labels = target_input)xentropy_sigmoid_y_out = sess.run(xentropy_sigmoid_y_vals)# æƒé‡softmax äº¤å‰ç†µæŸå¤±å‡½æ•°weight = tf.constant(0.5)xentropy_weighted_y_vals = tf.nn.weighted_cross_entropy_with_logits(x_vals, targets, weight)xentropy_weighted_y_out = sess.run(xentropy_weighted_y_vals)# ç”»å‡ºè¿™äº›æŸå¤±å‡½æ•°x_array = sess.run(x_vals)plt.plot(x_array, hinge_y_out, 'b-', label='Hinge Loss')plt.plot(x_array, xentropy_y_out, 'r--', label='Cross Entropy Loss')plt.plot(x_array, xentropy_sigmoid_y_out, 'k-.', label='Cross Entropy Sigmoid Loss')plt.plot(x_array, xentropy_weighted_y_out, 'g:', label='Weighted Cross Entropy Loss (x0.5)')plt.ylim(-1.5, 3)#plt.xlim(-1, 3)plt.legend(loc='lower right', prop=&#123;'size': 11&#125;)plt.show()# å…·ä½“æŸå¤±å‡½æ•°æ˜¯å¹²å˜›ç”¨çš„ï¼Œé‚£å°±æ˜¯ä¸ºäº†å…·ä½“çš„æ•°æ®é¢„æµ‹ç»™æä¾›ä¸€ä¸ªæœ€ä¼˜åŒ–çš„ç›®æ ‡ï¼Œä¸ºäº†è®©æ¯ä¸€ç±»ä»»åŠ¡æœ‰ä¸€ä¸ªæœ€å°åŒ–ç›®æ ‡è€Œæ„é€ å‡ºæ¥çš„losså‡½æ•°ï¼Œåœ¨æœºå™¨å­¦ä¹ é‡Œé¢æœ€é‡è¦çš„å…¶å®æœ‰ä¸€é¡¹å°±æ˜¯æŸå¤±å‡½æ•°çš„è®¾è®¡ï¼Œè®¾è®¡ä¸€ä¸ªå¥½çš„æŸå¤±å‡½æ•°ï¼Œä¼šè®©æˆ‘ä»¬çš„ç½‘ç»œæ›´åŠ çš„ç¨³å®šï¼Œæ›´åŠ å®¹æ˜“æ”¶æ•›å’Œæ”¶æ•›åˆ°ä¸€ä¸ªç›¸å¯¹æœ€ä¼˜å€¼# æ²¡æœ‰æŒæ¡è¿™äº›åŸºæœ¬æ¦‚å¿µçš„ï¼Œå¸Œæœ›è‡ªå·±å…ˆæ‰¾ä¸€äº›è¿™æ–¹é¢çš„çŸ¥è¯†æ¥çœ‹ä¸€çœ‹ï¼Œç„¶åå†ç†è§£çš„å†™ä»£ç ï¼Œè¿™æ ·ä¼šäº‹åŠåŠŸå€ã€‚ å…¬å¼ä¸€ï¼š \\[ L_{\\delta}(i) = {\\delta}^2 (\\sqrt{1 + (a/{\\delta})^2} - 1) \\] å…¬å¼äºŒï¼š \\[ max(0, 1 - (pre - y)) \\] å…¬å¼ä¸‰ï¼š \\[ L = -actual * (log(pre)) - (1- actual)(log(1-pre)) \\] å…¬å¼å››ï¼š \\[ L = -actual * (log(sigmoid(pre))) - (1- actual)(log(1- sigmoid(pre))) \\] å…¬å¼äº”ï¼š \\[ L = -actual * (log(pre)) * weights - (1-actual)(log(1-pre)) \\] Back Propagation è¿™ä¸ªåœ°æ–¹ä¸è¦ç´§å¼ ï¼Œæˆ‘è¿™é‡Œç»™ä½ æ¨èä¸€ä¸ªç½‘ç«™ï¼Œä¸Šé¢æœ‰å¾ˆå¥½ç†è§£è¿™ä¸ªç®—æ³•çš„è§£é‡Šã€‚ æœºå™¨å­¦ä¹ åŸºç¡€ä»¥åŠåå‘ä¼ æ’­ç®—æ³•ä»‹ç» 12345678910111213141516171819202122232425262728293031323334353637383940# ä¸‹é¢æ˜¯ä¸€ä¸ªå›å½’çš„ä¾‹å­# è€æ ·å­ï¼Œæˆ‘ä»¬åˆ›å»ºtensorflowçš„ä¼šè¯ï¼Œä½¿ç”¨é»˜è®¤çš„è®¡ç®—å›¾import tensorflow as tfimport numpy as npimport matplotlib.pyplot as pltfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()# ä¸€ä¸ªå›å½’çš„ä¾‹å­# åˆ›å»ºæ•°æ®x_vals = np.random.normal(1, 0.1, 100) # xæ•°æ®y_vals = np.repeat(10., 100) # y æ•°æ®x_data = tf.placeholder(shape=[1], dtype=tf.float32) # å ä½ç¬¦y_target = tf.placeholder(shape=[1], dtype=tf.float32) # labelï¼ˆçœŸå€¼ï¼‰A = tf.Variable(tf.random_normal(shape=[1]))my_output = tf.multiply(x_data, A)# ä½¿ç”¨l2 lossloss = tf.square(my_output - y_target)init = tf.global_variables_initializer()sess.run(init)# åˆ›å»ºäº†ä¸€ä¸ªåå‘ä¼ æ’­ä¼˜åŒ–å™¨my_opt = tf.train.GradientDescentOptimizer(0.02)train_step = my_opt.minimize(loss) # æœ€å°åŒ–loss# å¼€å§‹æˆ‘ä»¬çš„è¿­ä»£è®­ç»ƒfor i in range(100): rand_index = np.random.choice(100) rand_x = [x_vals[rand_index]] rand_y = [y_vals[rand_index]] sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) if (i+1)%25==0: print('Step #' + str(i+1) + ' A = ' + str(sess.run(A))) print('Loss = ' + str(sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;))) 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455# ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ†ç±»çš„ä¾‹å­import tensorflow as tfimport numpy as npimport matplotlib.pyplot as pltfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()# åˆ†ç±»çš„ä¾‹å­# åˆ›å»ºæ•°æ®x_vals = np.concatenate((np.random.normal(-1, 1, 50), np.random.normal(3, 1, 50)))y_vals = np.concatenate((np.repeat(0., 50), np.repeat(1., 50)))# åˆ›å»ºå ä½ç¬¦x_data = tf.placeholder(shape=[1], dtype=tf.float32)y_target = tf.placeholder(shape=[1], dtype=tf.float32)A = tf.Variable(tf.random_normal(mean=10, shape=[1]))my_output = tf.add(x_data, A)my_output_expanded = tf.expand_dims(my_output, 0)y_target_expanded = tf.expand_dims(y_target, 0)# æ˜¯ä¸æ˜¯ä½¿ç”¨çš„æ˜¯å¯¹åº”çš„åˆ†ç±»æŸå¤±å‡½æ•°å‘€ sigmoid cross entropyxentropy = tf.nn.sigmoid_cross_entropy_with_logits(logits = my_output_expanded, labels = y_target_expanded)my_opt = tf.train.GradientDescentOptimizer(0.05)train_step = my_opt.minimize(xentropy)init = tf.global_variables_initializer()sess.run(init)for i in range(1400): rand_index = np.random.choice(100) rand_x = [x_vals[rand_index]] rand_y = [y_vals[rand_index]] sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;) if (i+1)%200==0: print('Step #' + str(i+1) + ' A = ' + str(sess.run(A))) print('Loss = ' + str(sess.run(xentropy, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)))# æµ‹è¯• predictions = []for i in range(len(x_vals)): x_val = [x_vals[i]] prediction = sess.run(tf.round(tf.sigmoid(my_output)), feed_dict=&#123;x_data: x_val&#125;) predictions.append(prediction[0]) accuracy = sum(x==y for x,y in zip(predictions, y_vals))/100.print('Ending Accuracy = ' + str(np.round(accuracy, 2))) o^o,ä»Šå¤©æˆ‘ä»¬å°±è®²åˆ°è¿™é‡Œï¼Œä¸‹èŠ‚æˆ‘ä»¬å†è§ï¼Œæ€»çš„æ¥è¯´ï¼Œå°±æ˜¯åœ¨å›å½’å’Œåˆ†ç±»é—®é¢˜ä¸­ï¼Œè®¾è®¡ç›¸å¯¹åº”çš„losså‡½æ•°ï¼Œç„¶åä½¿ç”¨åå‘ä¼ æ’­ä¼˜åŒ–å™¨èµ·ä¼˜åŒ–lossï¼Œä½¿å¾—lossé€æ¸å‡å°","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆä¸€ï¼‰","slug":"2018-04-09/guide-to-asyncio-1","date":"2018-04-14T19:37:56.000Z","updated":"2018-08-07T08:56:41.616Z","comments":true,"path":"posts/b496f296/","link":"","permalink":"http://weafteam.github.io/posts/b496f296/","excerpt":"","text":"å‰è¨€ ä¼—æ‰€å‘¨çŸ¥ï¼ŒPython çš„å¹¶å‘ç¼–ç¨‹ä¸»è¦ç”±çº¿ç¨‹ã€è¿›ç¨‹å’Œåç¨‹ä¸‰ä¸ªç»„ä»¶ç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python æ¨¡å— threadingã€multiprocessing å’Œ yield å¥æ³•å»æ“çºµå®ƒä»¬ã€‚åæ¥ï¼Œåˆæœ‰äº†æ›´é«˜å±‚çš„å°è£…ï¼šconcurrent.futures å’Œ asyncio æ¨¡å—ã€‚concurrent.futuresæ˜¯å¯¹ threading å’Œ multiprocessing çš„å°è£…ï¼Œä¸æ˜¯è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼›asyncio æ˜¯ Python ä¸­çš„é‡å¤§å˜åŒ–ï¼Œä¹Ÿä»£è¡¨äº†æœªæ¥çš„å‘å±•è¶‹åŠ¿ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æ‰“ç®—è®²è®² asyncioã€‚ ä»€ä¹ˆæ˜¯ asyncio asyncio ä¸€å¼€å§‹æ˜¯ Python çš„ä½œè€… Guido van Rossum åœ¨ Python ä»“åº“ä¹‹å¤–å¼€å‘çš„ï¼Œä»£å·ä¸ºâ€œTulipâ€ï¼Œåœ¨ Python 3.4 æ—¶åŠ å…¥æ ‡å‡†åº“ã€‚asyncioæ¨¡å—ä½¿ç”¨äº‹ä»¶å¾ªç¯é©±åŠ¨çš„åç¨‹å®ç°å¹¶å‘ï¼Œæä¾›äº†åŸºäºåç¨‹æ¥æ„å»ºå¹¶å‘ç¨‹åºçš„å·¥å…·ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œthreading æ¨¡å—é€šè¿‡åº”ç”¨çº§çº¿ç¨‹å®ç°å¹¶å‘ï¼›multiprocessing æ¨¡å—ä½¿ç”¨ç³»ç»Ÿçº§è¿›ç¨‹å®ç°å¹¶å‘ï¼›è€Œ asyncioä½¿ç”¨å•çº¿ç¨‹ã€å•è¿›ç¨‹ï¼Œå…¶ä¸­åº”ç”¨ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†åœ¨äº‹ä»¶å¾ªç¯çš„é©±åŠ¨ä¸‹è¿›è¡Œåä½œï¼Œåœ¨æœ€ä½³æ—¶é—´æ˜¾å¼åˆ‡æ¢ä»»åŠ¡ã€‚asyncio ä¸ä½†æ”¯æŒé€šå¸¸æƒ…å†µä¸‹å‡ºç°é˜»å¡å‹ IO æ—¶çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿˜æ”¯æŒè°ƒåº¦ï¼Œæ¥è®©ä»£ç åœ¨æŒ‡å®šçš„å°†æ¥æ—¶é—´è¿è¡Œï¼Œå¹¶ä¸”è¿˜å¯ä»¥è®©ä¸€ä¸ªåç¨‹ç­‰å¾…å¦ä¸€ä¸ªåç¨‹å®Œæˆã€‚ asyncio ä¸­çš„å‡ ä¸ªæ¦‚å¿µ äº‹ä»¶å¾ªç¯ï¼šasyncio æä¾›çš„æ¡†æ¶ä»¥äº‹ä»¶å¾ªç¯ä¸ºä¸­å¿ƒï¼Œå®ƒæ˜¯è´Ÿè´£æœ‰æ•ˆå¤„ç† I / O äº‹ä»¶ã€ç³»ç»Ÿäº‹ä»¶å’Œåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡åˆ‡æ¢çš„ç¬¬ä¸€ç±»å¯¹è±¡ã€‚Python æä¾›äº†å‡ ä¸ªå¾ªç¯å®ç°ï¼Œé€šå¸¸ä¼šè‡ªåŠ¨é€‰æ‹©åˆç†çš„é»˜è®¤å€¼ï¼Œä½†ä¹Ÿå¯ä»¥é€‰æ‹©ç‰¹å®šçš„äº‹ä»¶å¾ªç¯å®ç°ã€‚åŒæ ·ä¹Ÿæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„å®ç°ï¼Œä¾‹å¦‚ uvloopã€‚åº”ç”¨ç¨‹åºå°†è¦æ‰§è¡Œçš„ä»£ç æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œä»£è¡¨å…è®¸äº‹ä»¶å¾ªç¯åœ¨å¿…è¦æ—¶å¯¹ä»£ç è¿›è¡Œè°ƒç”¨ã€‚å½“è°ƒç”¨ç»“æŸï¼Œæˆ–æ— æ³•ç»§ç»­æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè®©å‡ºæ§åˆ¶æƒï¼Œäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯ã€‚ åç¨‹ï¼ˆcoroutine ï¼‰ï¼šå°†æ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯çš„æœºåˆ¶æ¥è‡ªäº Python çš„åç¨‹ï¼Œè¿™æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œå®ƒå°†æ§åˆ¶æƒäº¤è¿˜ç»™è°ƒç”¨æ–¹è€Œä¸ä¼šä¸¢å¤±æœ¬èº«çŠ¶æ€ã€‚åç¨‹ç±»ä¼¼äºç”Ÿæˆå™¨å‡½æ•°ï¼Œäº‹å®ä¸Šå¯ä»¥åœ¨ Python 3.5 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ç”¨ç”Ÿæˆå™¨å®ç°åç¨‹ã€‚asyncio è¿˜ä¸º Protocols å’Œ Transports æä¾›äº†åŸºäºç±»çš„æŠ½è±¡å±‚ï¼Œä½¿ç”¨å›è°ƒçš„ä»£ç é£æ ¼ã€‚åœ¨åŸºäºç±»çš„æ¨¡å‹å’Œåç¨‹æ¨¡å‹ä¸­ï¼Œé€šè¿‡é‡æ–°è¿›å…¥äº‹ä»¶å¾ªç¯æ¥æ˜¾å¼æ›´æ”¹ä¸Šä¸‹æ–‡å°†å–ä»£ Python çº¿ç¨‹å®ç°ä¸­çš„éšå¼ä¸Šä¸‹æ–‡æ›´æ”¹ã€‚ futureï¼šfutureæ˜¯ä¸€ç§å¯¹è±¡ï¼Œè¡¨ç¤ºå¾…å®Œæˆçš„æ“ä½œçš„ç»“æœã€‚äº‹ä»¶å¾ªç¯å¯ä»¥ç›‘è§† future å¯¹è±¡ç›´åˆ°å®ƒå®Œæˆï¼Œä»è€Œå…è®¸åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ç­‰å¾…å¦ä¸€éƒ¨åˆ†å®ŒæˆæŸäº›å·¥ä½œã€‚é™¤äº† futureï¼Œasyncio è¿˜åŒ…æ‹¬å…¶ä»–å¹¶å‘åŸè¯­ï¼Œä¾‹å¦‚é”å’Œä¿¡å·é‡ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è‡ªè¡Œåˆ›å»º futureï¼Œåªèƒ½é€šè¿‡å¹¶å‘æ¡†æ¶ï¼ˆä¾‹å¦‚ asyncioï¼‰æ¥å®ä¾‹åŒ–ã€‚åŸå› æ˜¯ futureä»£è¡¨ç»ˆå°†å‘ç”Ÿçš„äº‹æƒ…ï¼Œè€ŒæŸä»¶äº‹çš„å‘ç”Ÿï¼Œæ˜¯é€šè¿‡å®‰æ’å¥½è¿™ä»¶äº‹çš„æ‰§è¡Œæ—¶é—´æ¥ç¡®å®šçš„ã€‚åªæœ‰å½“æˆ‘ä»¬æŠŠæŸä»¶äº‹äº¤ç»™äº‹ä»¶å¾ªç¯å¤„ç†æ—¶ï¼Œäº‹ä»¶å¾ªç¯æ‰ä¼šç»™è¿™ä»¶äº‹æ’æœŸï¼Œä»è€Œåˆ›å»ºä¸€ä¸ª futureå¯¹è±¡ã€‚ ä»»åŠ¡ï¼ˆTaskï¼‰ï¼šä»»åŠ¡æ˜¯ futureçš„å­ç±»ï¼Œå®ƒåŒ…è£…å¹¶ç®¡ç†åç¨‹çš„æ‰§è¡Œã€‚ä»»åŠ¡å¯ä»¥é€šè¿‡äº‹ä»¶å¾ªç¯è¿›è¡Œè°ƒåº¦ï¼Œä»¥ä¾¿åœ¨å®ƒä»¬éœ€è¦çš„èµ„æºå¯ç”¨æ—¶è¿è¡Œï¼Œå¹¶ç”Ÿæˆå¯ç”±å…¶ä»–åç¨‹ä½¿ç”¨çš„ç»“æœã€‚ ä½¿ç”¨åç¨‹å¤„ç†å¤šä»»åŠ¡åä½œ åç¨‹æ˜¯ä¸ºå¹¶å‘è®¾è®¡çš„è¯­è¨€æ¦‚å¿µã€‚åç¨‹å‡½æ•°åœ¨è°ƒç”¨æ—¶åˆ›å»ºåç¨‹å¯¹è±¡ï¼Œç„¶åè°ƒç”¨æ–¹å¯ä»¥ä½¿ç”¨åç¨‹çš„ send () æ–¹æ³•è¿è¡Œå‡½æ•°ã€‚åç¨‹å¯ä»¥åœ¨å¦ä¸€ä¸ªåç¨‹ä¸­ä½¿ç”¨ awaitå…³é”®å­—æš‚åœæ‰§è¡Œã€‚å½“å®ƒè¢«æš‚åœæ—¶ï¼Œåç¨‹çš„çŠ¶æ€è¢«ä¿æŒï¼Œå…è®¸å®ƒåœ¨ä¸‹æ¬¡è¢«å”¤é†’æ—¶æ¢å¤åˆ°å®ƒåœæ­¢çš„ä½ç½®ã€‚ å¯åŠ¨åç¨‹ å¯åŠ¨ä¸€ä¸ªåç¨‹æœ€ç®€å•çš„æ–¹å¼æ˜¯å°†ä¸€ä¸ªåç¨‹ä¼ é€’ç»™äº‹ä»¶å¾ªç¯çš„ run_until_complete() æ–¹æ³•ï¼š 123456789101112131415import asyncioasync def coroutine(): print('in coroutine')event_loop = asyncio.get_event_loop()try: print('starting coroutine') print('entering event loop') event_loop.run_until_complete(coroutine())finally: print('closing event loop') event_loop.close() 1234starting coroutineentering event loopin coroutineclosing event loop é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ asyncio.get_event_loop() è·å–äº†ä¸€ä¸ªé»˜è®¤äº‹ä»¶å¾ªç¯çš„å¼•ç”¨ã€‚run_until_complete() æ–¹æ³•æ¥å—ä¸€ä¸ªåç¨‹å¯¹è±¡ï¼Œå¹¶ç”¨å®ƒå¯åŠ¨äº‹ä»¶å¾ªç¯ï¼Œç„¶ååœ¨åç¨‹é€šè¿‡ return ç»“æŸæ—¶åœæ­¢äº‹ä»¶å¾ªç¯ã€‚ åç¨‹çš„è¿”å›å€¼ åç¨‹çš„è¿”å›å€¼è¿”å›ç»™å¯åŠ¨å¹¶ç­‰å¾…å®ƒçš„ç¨‹åºï¼š 1234567891011121314import asyncioasync def coroutine(): print('in coroutine') return 'result'event_loop = asyncio.get_event_loop()try: return_value = event_loop.run_until_complete(coroutine()) print(f'it returned: &#123;return_value!r&#125;')finally: event_loop.close() 12in coroutineit returned: 'result' é“¾å¼è°ƒç”¨åç¨‹ ä¸€ä¸ªåç¨‹å¯ä»¥å¯åŠ¨å¦ä¸€ä¸ªåç¨‹å¹¶ç­‰å¾…å®ƒè¿”å›ç»“æœã€‚ä¸‹é¢çš„ç¤ºä¾‹åŒ…å«ä¸¤ä¸ªé˜¶æ®µï¼Œå®ƒä»¬å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†å¯ä»¥ä¸å¦å¤–çš„æ“ä½œåŒæ—¶è¿è¡Œï¼š 12345678910111213141516171819202122232425262728import asyncioasync def phase1(): print('in phase1') return 'result1'async def phase2(arg): print('in phase2') return f'result2 derived from &#123;arg&#125;'async def main(): print('in main') print('waiting for result1') result1 = await phase1() print('waiting for result2') result2 = await phase2(result1) return (result1, result2)event_loop = asyncio.get_event_loop()try: return_value = event_loop.run_until_complete(main()) print(f'return value: &#123;return_value!r&#125;')finally: event_loop.close() 123456in mainwaiting for result1in phase1waiting for result2in phase2return value: ('result1', 'result2 derived from result1') åœ¨è¿™é‡Œä½¿ç”¨äº† await å…³é”®å­—ï¼Œå¹¶æ²¡æœ‰å°†æ–°çš„åç¨‹æ·»åŠ åˆ°äº‹ä»¶å¾ªç¯ä¸­ã€‚å› ä¸ºæ§åˆ¶æµå·²ç»åœ¨ç”±äº‹ä»¶å¾ªç¯ç®¡ç†çš„åç¨‹å†…éƒ¨ï¼Œæ‰€ä»¥ä¸éœ€è¦é€šçŸ¥äº‹ä»¶å¾ªç¯ç®¡ç†æ–°çš„åç¨‹ã€‚ ä½¿ç”¨ç”Ÿæˆå™¨è¯­æ³• async å’Œ await å…³é”®å­—å‡ºç°äº Python 3.5ï¼Œå¯¹äº Python 3.5 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ asyncio.coroutine è£…é¥°å™¨å’Œ yield from æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼š 12345678910111213141516171819202122232425262728293031import asyncio@asyncio.coroutinedef phase1(): print('in phase1') return 'result1'@asyncio.coroutinedef phase2(arg): print('in phase2') return f'result2 derived from &#123;arg&#125;'@asyncio.coroutinedef main(): print('in main') print('waiting for result1') result1 = yield from phase1() print('waiting for result2') result2 = yield from phase2(result1) return (result1, result2)event_loop = asyncio.get_event_loop()try: return_value = event_loop.run_until_complete(main()) print(f'return value: &#123;return_value!r&#125;')finally: event_loop.close() å‚è€ƒèµ„æ–™ Asynchronous Concurrency Concepts Cooperative Multitasking with Coroutines","categories":[],"tags":[]},{"title":"Vigenereå¯†ç åŠ å¯†è§£å¯†","slug":"2018-04-09/Vigenereå¯†ç åŠ å¯†è§£å¯†","date":"2018-04-14T14:11:24.000Z","updated":"2018-05-29T01:27:49.829Z","comments":true,"path":"posts/8b092926/","link":"","permalink":"http://weafteam.github.io/posts/8b092926/","excerpt":"","text":"ä»Šå¤©æ¢ä¸ªå£å‘³ï¼Œå†™ç‚¹åŸæ¥ä»æ²¡æ¥è§¦è¿‡çš„ä¸œè¥¿â€“å¯†ç å­¦ã€‚å‰ä¸€é˜µä¿¡æ¯å®‰å…¨è¯¾ä¸Šç•™äº†ä¸€ä¸ªä½œä¸šï¼Œå®ç°VigenereåŠ å¯†è§£å¯†ï¼Œå€Ÿç€æœºä¼šå†™ç¯‡åšå®¢ã€‚è¿™æ¬¡åšå®¢ç”±äºæ¯”è¾ƒä»“ä¿ƒï¼Œè¿™æ¬¡åªå†™åŠ å¯†è§£å¯†ç³»ç»Ÿçš„å®ç°ï¼Œä¸æ¶‰åŠå”¯å¯†æ–‡ç ´è§£ã€‚ ä»»åŠ¡è¦æ±‚ï¼š a.ç¼–ç¨‹å®ç°VigenereåŠ å¯†/è§£å¯†ç³»ç»Ÿï¼Œå¹¶åˆ†æå’Œè¯„ä¼°è¯¥ç®—æ³•çš„å®‰å…¨æ€§ã€‚ b.ç¼–ç¨‹å®ç°å”¯å¯†æ–‡ç ´è¯‘ç³»ç»Ÿï¼Œèƒ½å¤Ÿç ´è¯‘å¯†é’¥ä¸º2åˆ°4ä¸ªå­—ç¬¦çš„Vigenereå¯†æ–‡ï¼Œå¹¶åˆ†æå¦‚ä½•åŠ å¿«ç ´è¯‘é€Ÿåº¦ã€‚ æ—¶é—´è¦æ±‚ï¼š å¸ƒç½®ä»»åŠ¡åï¼Œåœ¨3å‘¨ä¹‹å†…å®Œæˆã€‚ æäº¤ç»“æœï¼šå·²è®¾è®¡å¹¶æµ‹è¯•å¥½çš„ç¨‹åºï¼ŒåŒ…æ‹¬æºç ã€å¯æ‰§è¡Œç¨‹åºã€æµ‹è¯•æ•°æ®é›†ã€å®éªŒæŠ¥å‘Šã€‚ åŸç†ä»‹ç»ï¼š å…ˆæ™®åŠä¸‹Caesarå¯†ç ï¼Œä½œä¸ºå•å¯†ç ç®€å•æ›¿æ¢å¯†ç å±Šçš„æ‰›æŠŠå­ï¼Œä»–æœ‰ç€ä¸å¯åŠ¨æ‘‡çš„åœ°ä½ï¼Œå®ƒçš„åŸç†å¾ˆç®€å•ï¼Œå¯¹äºéœ€è¦åŠ å¯†çš„æ¯ä¸ªå­—ç¬¦éƒ½è¿›è¡Œç›¸åŒå¤§å°çš„å¹³ç§»ã€‚å…ˆç»™å‡ºCaesarå¯†ç åŠ å¯†çš„å­—ç¬¦å¯¹åº”è¡¨ï¼Œå¦‚ä¸‹ï¼š ä¸¾ä¸ªä¾‹å­å§ï¼šæ˜æ–‡ä¸ºChinaï¼Œå®ƒå¯¹åº”çš„æ•°å­—åº”ä¸º2 7 8 13 0.æ¯”å¦‚æˆ‘ä»¬å¹³ç§»è·ç¦»ä¸º3ï¼Œé‚£ä¹ˆåŠ å¯†ä¹‹åçš„å¯†æ–‡åº”è¯¥ä¸ºFKLQDï¼Œç®€å•åˆ°ç‚¸ã€‚ æˆ‘ä»¬å…ˆä¸è°ˆä¸Šè¿°åŠ å¯†æ–¹æ³•çš„ç¼ºç‚¹ï¼Œè¿™äº›æˆ‘ä»¬æ”¾åˆ°å”¯å¯†æ–‡è§£å¯†ä¸­èŠã€‚æœ‰äº†ä»¥ä¸Šçš„åŸºç¡€ä¹‹åæˆ‘ä»¬å†èŠVigenereåŠ å¯†ä»¥åŠè§£å¯†ï¼Œå®ƒæ˜¯ä½¿ç”¨ä¸€ç³»åˆ—å‡¯æ’’å¯†ç ç»„æˆå¯†ç å­—æ¯è¡¨çš„åŠ å¯†ç®—æ³•ï¼Œå±äºå¤šè¡¨å¯†ç çš„ä¸€ç§ç®€å•å½¢å¼ã€‚åŒæ ·å…ˆç»™å‡ºå®ƒçš„å¯†ç åŠ å¯†å­—ç¬¦å¯¹åº”è¡¨ï¼ˆè‡ªå·±ç”»å¤ªéº»çƒ¦äº†ï¼Œæˆ‘å°±åœ¨ç™¾ç§‘ä¸Šæ‰’äº†ä¸€ä¸ªå›¾ï¼Œæºœã€‚ã€‚ï¼‰ï¼š ä¸Šå›¾ä¸­çš„ç»´å‰å°¼äºšè¡¨çš„ç¬¬ä¸€åˆ—ä»£è¡¨ç€å¯†é’¥å­—æ¯ï¼ˆè¿™æ˜¯æœ‰åˆ«äºCaesarå¯†ç çš„åœ°æ–¹ï¼‰ï¼Œç¬¬ä¸€è¡Œä»£è¡¨ç€æ˜æ–‡å­—æ¯ï¼Œè¡Œåˆ—åˆ†åˆ«ä½¿ç”¨å½“å‰éœ€è¦åŠ å¯†å­—ç¬¦å’Œå½“å‰çš„å¯†é’¥å­—ç¬¦ç¡®å®šå½“å‰æ˜æ–‡å­—ç¬¦å¯¹åº”ç€çš„å¯†æ–‡å­—ç¬¦ã€‚ è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç»™å‡ºçš„å¯†é’¥æ˜¯çŸ­äºæˆ‘ä»¬çš„æ˜æ–‡é•¿åº¦çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åšVigenereåŠ å¯†çš„æ—¶å€™ç¬¬ä¸€æ­¥åšçš„å°±æ˜¯å¯¹ç…§æ˜æ–‡é•¿åº¦ï¼Œè¡¥é½å¯†é’¥å­—ä¸²ã€‚ è¯´äº†è¿™ä¹ˆå¤šï¼Œä¸¾ä¸ªä¾‹å­è¯´ä¸‹å§ï¼š ä¾‹å¦‚æˆ‘ä»¬çš„æ˜æ–‡å­—ä¸²ä¸ºï¼šdata security å¯†é’¥ï¼šbest æŒ‰ç…§ä¸Šè¿°çš„è§„åˆ™ï¼Œç¬¬bè¡Œï¼Œç¬¬dåˆ—ï¼Œå¯¹åº”çš„å­—ç¬¦ä¸ºEï¼Œâ€¦.. åŠ å¯†ä¹‹åçš„å¯†æ–‡åº”ä¸ºï¼šEELTTIUNSMLRï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ã€‚ å®ç° ç¬¬ä¸€æ­¥ï¼šä½¿å¾—å¯†é’¥å­—ç¬¦ä¸²é•¿åº¦ä¸æ˜æ–‡é•¿åº¦ç›¸åŒ 1234567891011121314151617181920public String dealKey(String str,String Key)&#123; Key=Key.toUpperCase();// å°†å¯†é’¥è½¬æ¢æˆå¤§å†™ Key=Key.replaceAll(\"[^A-Z]\", \"\");//å»é™¤æ‰€æœ‰éå­—æ¯çš„å­—ç¬¦ StringBuilder stringBuilder = new StringBuilder(Key); String newKey=\"\"; if(sstringBuilder.length()!=str.length())&#123; //å¦‚æœå¯†é’¥é•¿åº¦ä¸strä¸åŒï¼Œåˆ™éœ€è¦ç”Ÿæˆå¯†é’¥å­—ç¬¦ä¸² if(stringBuilder.length()&lt;str.length())&#123; //å¦‚æœå¯†é’¥é•¿åº¦æ¯”strçŸ­ï¼Œåˆ™ä»¥ä¸æ–­é‡å¤å¯†é’¥çš„æ–¹å¼ç”Ÿæˆå¯†é’¥å­—ç¬¦ä¸² while(stringBuilder.length()&lt;str.length())&#123; stringBuilder.append(Key); &#125; &#125; //æ­¤æ—¶ï¼Œå¯†é’¥å­—ç¬¦ä¸²çš„é•¿åº¦å¤§äºæˆ–ç­‰äºstré•¿åº¦ //å°†å¯†é’¥å­—ç¬¦ä¸²æˆªå–ä¸ºä¸strç­‰é•¿çš„å­—ç¬¦ä¸² newKey=stringBuilder.substring(0, str.length()); &#125; return newKey; &#125; ç¬¬äºŒæ­¥ï¼šåŠ å¯† å…¶å®æˆ‘ä»¬ä¸ç”¨å°†ä¸Šè¿°çš„Vigenereå¯†ç è¡¨åˆ—å‡ºæ¥ï¼Œä¸€æ˜¯åˆ—å‡ºæ¥è´¹æ—¶è´¹åŠ›è´¹ç©ºé—´ï¼ŒäºŒæ˜¯ä¸€ä¸ªç®€å•çš„å–ä½™æ“ä½œå°±èƒ½è§£å†³è¿™ä¸ªäº‹æƒ…ã€‚ 12345678910111213141516private String PwTable = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";public String Encryption(String P,String K)&#123; P = P.toUpperCase();// å°†æ˜æ–‡è½¬æ¢æˆå¤§å†™ P = P.replaceAll(\"[^A-Z]\", \"\");//å»é™¤æ‰€æœ‰éå­—æ¯çš„å­—ç¬¦ K = dealKey(P,K); int len = K.length(); StringBuilder stringBuilder = new StringBuilder(); for(int i = 0;i &lt; len;i++)&#123; int row=PwTable.indexOf(K.charAt(i));//è¡Œå· int col=PwTable.indexOf(P.charAt(i));//åˆ—å· int index = (row+col)%26; stringBuilder.append(PwTable.charAt(index)); &#125; return stringBuilder.toString(); &#125; ç¬¬ä¸‰æ­¥ï¼šè§£å¯† è¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ï¼Œæˆ‘ä»¬å–å¯†é’¥æ‰€åœ¨è¡Œä¸ºè§£å¯†çš„è¡Œå·ï¼Œå¯†æ–‡æ‰€åœ¨åˆ—ä½œä¸ºæˆ‘ä»¬çš„åˆ—å·ï¼Œæˆ‘ä»¬éœ€è¦åˆ†ä¸¤ç§æƒ…å†µè€ƒè™‘ï¼š é¦–å…ˆè¯´ä¸€ä¸‹ç¬¬ä¸€ç§æƒ…å†µï¼Œå°†ä¸Šè¿°çš„å¯†ç è¡¨ä»ä¸»å¯¹è§’çº¿åˆ†å¼€ï¼Œä¸€æ˜¯å¯†æ–‡åœ¨æˆ‘ä»¬çš„å¯†ç è¡¨çš„å³ä¸Šéƒ¨ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåŠ å¯†è¿‡ç¨‹çš„é€†è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ­¤æ—¶çš„å¯†æ–‡å­—ç¬¦åœ¨å¯†ç è¡¨ä¸­çš„ä½ç½®è‚¯å®šæ˜¯ä¸æ¯”å…¶å¯¹åº”çš„æ˜æ–‡é åçš„ï¼ˆç†è§£è¿™å¥è¯ï¼Œè¿™ç§æƒ…å†µå…¶å®ä¹Ÿå°±æ˜ç™½äº†ï¼Œå†ç®€å•ç‚¹è®²å°±æ˜¯PwTable.indexof(å¯†æ–‡)&gt;PwTable.indexof(å¯¹åº”çš„æ˜æ–‡)ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬åªè¦è®©åˆ—å·å‡å»è¡Œå·ï¼Œç„¶åå°†ç»“æœåšindexofæ“ä½œå°±èƒ½å¾—åˆ°ç›¸åº”çš„æ˜æ–‡ã€‚ å¦‚æœä½ ç†è§£äº†ç¬¬ä¸€ç§æƒ…å†µï¼Œç¬¬äºŒç§æƒ…å†µä¹Ÿå°±å¥½ç†è§£äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„å¯†æ–‡å­—ç¬¦åœ¨æˆ‘ä»¬çš„å¯†ç è¡¨ä¸­çš„ä½ç½®è‚¯å®šæ˜¯ä¸æ¯”å…¶å¯¹åº”çš„æ˜æ–‡çš„ä½ç½®é å‰çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†åˆ—å·åŠ ä¸€åœˆå­—ç¬¦è¡¨å†å»å‡è¡Œå·ã€‚ ç†è§£ä¹‹åä¸‹é¢çš„è¿™äº›ä»£ç åº”è¯¥å°±ä¸éš¾ç†è§£äº†ã€‚ 12345678910111213141516171819public String Decryption(String C,String K)&#123; C=C.toUpperCase();// å°†å¯†æ–‡è½¬æ¢æˆå¤§å†™ C=C.replaceAll(\"[^A-Z]\", \"\");//å»é™¤æ‰€æœ‰éå­—æ¯çš„å­—ç¬¦ K=dealKey(C,K); int len = K.length(); StringBuilder stringBuilder=new StringBuilder(); for(int i = 0;i&lt;len;i++)&#123; int row = PwTable.indexOf(K.charAt(i));//è¡Œå· int col = PwTable.indexOf(C.charAt(i));//åˆ—å· int index; if(row&gt;col)&#123; index=col+26-row; &#125;else&#123; index=col-row; &#125; stringBuilder.append(PwTable.charAt(index)); &#125; return sb.toString(); &#125; ä»¥ä¸Šæ˜¯æœ¬ç¯‡åšå®¢çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ„Ÿè°¢é©»è¶³~","categories":[{"name":"å¯†ç å­¦","slug":"å¯†ç å­¦","permalink":"http://weafteam.github.io/categories/å¯†ç å­¦/"}],"tags":[{"name":"å¯†ç å­¦","slug":"å¯†ç å­¦","permalink":"http://weafteam.github.io/tags/å¯†ç å­¦/"}]},{"title":"å¦‚ä½•ç†è§£ä¸˜å¥‡è®¡æ•°","slug":"2018-04-02/how-to-understand-church-numerals","date":"2018-04-07T19:39:29.000Z","updated":"2018-08-07T08:56:41.615Z","comments":true,"path":"posts/cd89a3b2/","link":"","permalink":"http://weafteam.github.io/posts/cd89a3b2/","excerpt":"","text":"å‰è¨€ ä¸æƒ³å†™ Python äº†ï¼Œè¿™æ¬¡æ¢ä¸ªä¸»é¢˜ï¼šä¸˜å¥‡è®¡æ•°ï¼Œåˆå lambda æ¼”ç®—çš„è‡ªç„¶æ•°è¡¨ç¤ºæ³•ã€‚ ä»€ä¹ˆæ˜¯ lambda æ¼”ç®— lambda æ¼”ç®—ï¼ˆä¹Ÿç§°ä¸º Î» æ¼”ç®—ï¼‰æ˜¯æ•°å­¦é€»è¾‘ä¸­çš„ä¸€ç§å½¢å¼ç³»ç»Ÿï¼Œå®ƒåŸºäºå‡½æ•°æŠ½è±¡å’Œåº”ç”¨ï¼Œä½¿ç”¨å˜é‡ç»‘å®šå’Œæ›¿æ¢æ¥è¡¨ç¤ºè®¡ç®—ã€‚ æ²¡é”™ï¼Œä¸Šé¢è¿™å¥è¯æ¥è‡ªç»´åŸºç™¾ç§‘ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€å¥æ­£ç¡®çš„åºŸè¯ï¼Œçœ‹å®Œäº†ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ˜¯ lambda æ¼”ç®—ã€‚ä¸è¿‡è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹ä¸åœ¨ lambda æ¼”ç®—ä¸Šï¼Œå¸Œæœ›ä½ å·²ç»äº†è§£äº†ä¸€äº›å…³äº lambda æ¼”ç®—çš„çŸ¥è¯†ã€‚å¦‚æœæœ‰æœºä¼šä¸‹ä¸€ç¯‡å†å±•å¼€è¯´ï¼ˆå¯èƒ½ ä»€ä¹ˆæ˜¯è‡ªç„¶æ•° åœ¨è®¡ç®—æœºç§‘å­¦å’Œé›†åˆè®ºä¸­ï¼Œæˆ‘ä»¬æŠŠéè´Ÿæ•´æ•° \\((0, 1, 2, 3, 4...)\\) ç§°ä¸ºè‡ªç„¶æ•°ã€‚çš®äºšè¯ºç»™å‡ºäº†è‡ªç„¶æ•°çš„ä¸¥æ ¼å®šä¹‰ï¼š \\(0\\) æ˜¯è‡ªç„¶æ•°ï¼› å¦‚æœ \\(n\\) æ˜¯è‡ªç„¶æ•°ï¼Œé‚£ä¹ˆ \\(n+1\\) ä¹Ÿæ˜¯è‡ªç„¶æ•°ï¼ˆ\\(n+1\\) ä»£è¡¨ \\(n\\) çš„åç»§ï¼‰ï¼› \\(0\\) ä¸æ˜¯ä»»ä½•ä¸€ä¸ªæ•°çš„åç»§ï¼› å¦‚æœ \\(m\\) ä¸ \\(n\\) éƒ½æ˜¯è‡ªç„¶æ•°ä¸” \\(m\\neq n\\)ï¼Œé‚£ä¹ˆ \\(n+1 \\neq m+1\\)ï¼› è®¾ \\(P(n)\\) ä¸ºå…³äºè‡ªç„¶æ•° \\(n\\) çš„ä¸€ä¸ªæ€§è´¨ï¼Œå¦‚æœ \\(P(0)\\) æ­£ç¡®ï¼Œ ä¸”å‡è®¾ \\(P(n)\\) æ­£ç¡®ï¼Œåˆ™ \\(P(n+1)\\) äº¦æ­£ç¡®ã€‚é‚£ä¹ˆ \\(P(n)\\) å¯¹ä¸€åˆ‡è‡ªç„¶æ•° \\(n\\) éƒ½æ­£ç¡®ã€‚ å­˜åœ¨ä¸€ä¸ªé›†åˆ \\(N\\)ï¼Œç§°å…¶å…ƒç´ ä¸ºè‡ªç„¶æ•°ï¼Œå½“ä¸”ä»…å½“è¿™äº›å…ƒç´ æ»¡è¶³å…¬ç† 1 - 5ï¼ˆä¹Ÿå°±æ˜¯çš®äºšè¯ºå…¬ç†ï¼‰ã€‚ åœ¨è‡ªç„¶æ•°é›†åˆä¸Šå¯ä»¥å®šä¹‰ä¸€ç»„è¿ç®—ï¼šåŠ æ³•ã€ä¹˜æ³•ç­‰ç­‰ï¼Œè¿™é‡Œç”¨åŠ æ³•ä¸¾ä¸ªä¾‹å­ï¼š 1234def add(m, n): if n == 0: return m return add(m, n - 1) + 1 å¯ä»¥çœ‹å‡ºåŠ æ³•æ˜¯ç”±ä¸¤æ¡è§„åˆ™é€’å½’å®šä¹‰çš„ï¼š $ m + 0 = m$ \\(m + (n + 1) = (m + n) + 1\\) lambda æ¼”ç®—çš„è‡ªç„¶æ•°è¡¨ç¤ºæ³• è‡ªç„¶æ•°å½“ç„¶ä¸æ­¢å¯ä»¥ç”¨çš®äºšè¯ºå…¬ç†å®šä¹‰ï¼Œä¸˜å¥‡é¦–å…ˆæŠŠè‡ªç„¶æ•°å’Œè‡ªç„¶æ•°ä¸Šçš„è¿ç®—å®šä¹‰åœ¨äº† lambda æ¼”ç®—ä¸Šï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºä¸˜å¥‡è®¡æ•°ã€‚ ä¸‹é¢å°±è¦å¼€å§‹ä¸˜å¥‡è®¡æ•°çš„å®šä¹‰äº†ï¼Œç”±äº lambda æ¼”ç®—çš„æ ·å­ä¸å¤ªå‹å¥½ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨ Python è¡¨ç¤ºã€‚ é¦–å…ˆå®šä¹‰ 0ï¼š 1zero = lambda f: lambda x: x å…ˆä¸ç®¡å®ƒä¸ºä»€ä¹ˆæ˜¯ 0ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªè¯­å¥ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªæ¥å—ä¸€ä¸ªå‚æ•° f çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° xï¼Œç„¶åè¿”å›å®ƒã€‚ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†æ˜¯å®ƒä¸ºä»€ä¹ˆæ˜¯ 0ï¼Ÿ æŠŠå®ƒæ”¾åœ¨ä¸€è¾¹ï¼Œçœ‹çœ‹ 1 çš„å®šä¹‰ï¼š 1one = lambda f: lambda x: f(x) è¿™ä¸ªè¯­å¥æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®šä¹‰äº†ä¸€ä¸ªæ¥å—ä¸€ä¸ªå‚æ•° f çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° xï¼Œç„¶åè¿”å› f(x) çš„è°ƒç”¨ç»“æœã€‚å¥½åƒæœ‰äº›è§„å¾‹äº†ï¼Œå†çœ‹çœ‹ 2ï¼š 1two = lambda f: lambda x: f(f(x)) å®šä¹‰äº†ä¸€ä¸ªæ¥å—ä¸€ä¸ªå‚æ•° f çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° xï¼Œç„¶åè¿”å› f(f(x)) çš„è°ƒç”¨ç»“æœã€‚ ç°åœ¨å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œæ¯ä¸ªè‡ªç„¶æ•°çš„åç»§éƒ½å¤šè°ƒç”¨äº†ä¸€æ¬¡ fï¼Œè‡ªç„¶æ•°è¢«è¡¨ç¤ºä¸º f çš„è°ƒç”¨æ¬¡æ•°ã€‚ äºæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„å†™å‡ºåç»§å‡½æ•°ï¼š 1succ = lambda n: lambda f: lambda x: f(n(f)(x)) è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° nï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢è¢«å®šä¹‰çš„ 0ï¼Œ1ï¼Œ2 ç­‰ç­‰ï¼‰ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨ n çš„åŸºç¡€ä¸Šå¤šæ‰§è¡Œäº†ä¸€æ¬¡ fï¼Œè¾¾åˆ°äº†æ±‚ n çš„åç»§çš„ç›®çš„ã€‚ ç°åœ¨è®©æˆ‘ä»¬å¿˜è®° 1 çš„å®šä¹‰ï¼Œç”¨ 0 å’Œåç»§é‡æ–°å®šä¹‰ä¸€æ¬¡ï¼š 12345678zero = lambda f: lambda x: xsucc = lambda n: lambda f: lambda x: f(n(f)(x))one = succ(zero) = (lambda n: lambda f: lambda x: f(n(f)(x)))(lambda f: lambda x: x) = lambda f: lambda x: f(((lambda f: lambda x: x)(f))(x)) = lambda f: lambda x: f((lambda x: x)(x)) = lambda f: lambda x: f(x) å’Œæˆ‘ä»¬é¢„æƒ³çš„å®Œå…¨ä¸€è‡´ã€‚ åŠ æ³• æ¥ä¸‹æ¥è¯•ç€å®šä¹‰ä¸€ä¸‹åŠ æ³•ï¼ŒåŠ æ³•æ˜¯ä¸¤ä¸ªæ•°ç›¸åŠ è¿”å›ä¸€ä¸ªæ•°ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ æ³•æ˜¯å®šä¹‰åœ¨è‡ªç„¶æ•°ä¸Šçš„å¹ºåŠç¾¤ï¼‰ï¼Œæ‰€ä»¥ç­¾åé•¿è¿™æ ·ï¼š 1add = lambda m: lambda n: lambda f: lambda x: ... å‡½æ•°ä½“å‘¢ï¼Ÿæˆ‘ä»¬æ¨å¹¿ä¸€ä¸‹åç»§å‡½æ•°ï¼šåç»§å‡½æ•°åœ¨nçš„åŸºç¡€ä¸Šå¤šè°ƒç”¨äº†ä¸€æ¬¡ fï¼Œç›¸å½“äº +1ï¼›é‚£åŠ æ³•ç›¸å½“äº +mï¼Œä¹Ÿå°±æ˜¯å¤šè°ƒç”¨ m æ¬¡ fï¼Œäºæ˜¯å¯ä»¥å¾—å‡ºï¼š 1add = lambda m: lambda n: lambda f: lambda x: m(f)(n(f)(x)) ä¹˜æ³• ä¹˜æ³•çš„ç­¾åä¹Ÿæ˜¯ä¸€æ ·ï¼š 1mul = lambda m: lambda n: lambda f: lambda x: ... æˆ‘ä»¬éƒ½çŸ¥é“ä¹˜æ³•æ˜¯ä»åŠ æ³•æ¨å¹¿è€Œæ¥çš„ï¼šm * n ç›¸å½“äºåŠ  m æ¬¡ nï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨åŠ æ³•çš„å®šä¹‰ï¼š 1mul = lambda m: lambda n: lambda f: lambda x: m(add(n))(zero)(f)(x) ä¸Šé¢çš„å†™æ³•æ­£ç¡®ï¼Œä¸è¿‡å¤ªä¸‘äº†ï¼Œå¯ä»¥åŒ–ç®€ä¸ºï¼š 1mul = lambda m: lambda n: lambda f: lambda x: m(n(f))(x) æ±‚å¹‚ æ±‚å¹‚çš„ç­¾åä¹Ÿä¸€æ ·ï¼š 1pow = lambda m: lambda n: lambda f: lambda x: ... æ±‚å¹‚æ˜¯ç”±ä¹˜æ³•æ¨å¹¿è€Œæ¥çš„ï¼šmn ç›¸å½“äºä¹˜ n æ¬¡ mï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ä¹˜æ³•çš„å®šä¹‰ï¼š 1pow = lambda m: lambda n: lambda f: lambda x: n(mul(m))(one)(f)(x) åŒæ ·å¯ä»¥åŒ–ç®€ä¸ºï¼š 1pow = lambda m: lambda n: lambda f: lambda x: n(m)(f)(x) ç»“è¯­ æœºæ™ºçš„åŒå­¦ä¸€å®šå‘ç°æˆ‘ä»¬å¹¶æ²¡æœ‰å®ç°å‡æ³•ï¼Œè¿™æ˜¯å› ä¸ºå‡æ³•çš„å®ç°å¤ªå¤æ‚äº†ã€‚è‡³äºä¸ºä»€ä¹ˆå‡æ³•çš„å®ç°å¾ˆå¤æ‚ï¼Œä»¥åŠå¦‚ä½•å®ç°å‡æ³•ï¼Œè¿™é‡Œæœ‰ä¸€ç¯‡å‚è€ƒèµ„æ–™ ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œäº†è§£ä¸€ä¸‹ã€‚","categories":[],"tags":[]},{"title":"chapter-04-AIR","slug":"2018-04-02/TensorFlowåŸºç¡€æ“ä½œ(1)","date":"2018-04-05T02:13:07.000Z","updated":"2018-05-29T01:27:49.820Z","comments":true,"path":"posts/466eca41/","link":"","permalink":"http://weafteam.github.io/posts/466eca41/","excerpt":"","text":"TensorFLow åŸºç¡€ï¼ˆ1ï¼‰ hi,åˆå’Œå¤§å®¶è§é¢äº†ï¼Œä¸Šä¸€æ¬¡æˆ‘ä»¬è®²äº†å»ºç«‹æ¨¡å‹æ­¥éª¤å’Œä¸€äº›åŸºç¡€çš„æ¦‚å¿µï¼ˆTensorã€Placeholderï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™æ¬¡å°±ç»§ç»­æˆ‘ä»¬çš„çŸ©é˜µæ“ä½œï¼Œå› ä¸ºåœ¨TensorFlowå¤„ç†ä¸€äº›æ•°å­¦é—®é¢˜çš„æ—¶å€™ï¼Œå¾€å¾€éƒ½æ˜¯é€šè¿‡çŸ©é˜µæ¥å­˜å‚¨æ•°æ®ï¼Œé€šè¿‡ç‰¹å®šçš„çŸ©é˜µè¿ç®—ï¼Œæˆ‘ä»¬å®ç°æ•°æ®çš„å¤„ç†ï¼Œä»è€Œå¾—åˆ°ä¸€äº›æ•°æ®çš„ç‰¹æ€§ã€‚è¿˜æœ‰ä¸€äº›å…¶ä»–çš„Tensorflowçš„æ¦‚å¿µï¼Œæˆ‘å¸Œæœ›å¤§å®¶èƒ½åšæŒä¸‹å»ï¼Œåªè¦å°†è¿™äº›åŸºç¡€çš„æ¦‚å¿µå­¦ä¼šï¼Œé‚£ä¹ˆä»¥åè¿ç”¨TensorFlowå°±ä¼šå¾—å¿ƒåº”æ‰‹ã€‚ å’ŒTensorFlowä¸€èµ·å·¥ä½œçš„Matrices 12345678910111213141516171819202122232425262728293031# çŸ©é˜µå’ŒçŸ©é˜µæ“ä½œimport tensorflow as tfimport numpy as npfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()identity_matrix = tf.diag([1., 1., 1])print(sess.run(identity_matrix)) #æ³¨æ„è¿™ä¸ªåœ°æ–¹ï¼Œå¦‚æœæ˜¯TensorFlowçš„Tensorï¼Œ# é‚£ä¹ˆä½¿ç”¨sessçš„runæ–¹æ³•æ‰èƒ½å°†ç»“æœæ˜¾ç¤º# æˆ–è€…ä¸‹é¢è¿™ç§æ–¹å¼print(identity_matrix.eval(session = sess))A = tf.truncated_normal([2, 3]) # 2 * 3 å¤§å° å‡å€¼0 æ–¹å·®ä¸º1.print(sess.run(A))B = tf.fill([2, 3], 5.) # 2 * 3 ä½¿ç”¨5.å¡«å……print(sess.run(B))C = tf.random_uniform([3, 2]) # 3 * 2 éšæœºåˆå§‹åŒ–print(sess.run(C))D = tf.convert_to_tensor(np.array([[1., 2., 3.], [-3., -7., -1.], [0., 5., -2.]]))print(sess.run(D))print(sess.run(A+B)) # åŠ æ³•å’Œ tf.add() ä¸€æ ·print(sess.run(B-B)) # å‡æ³•å’Œ tf.subtract() ä¸€æ ·print(sess.run(tf.matmul(B, identity_matrix))) # çŸ©é˜µä¹˜æ³•print(sess.run(tf.transpose(C))) # çŸ©é˜µè½¬ç½®print(sess.run(tf.matrix_determinant(D))) # è®¡ç®—è¡Œåˆ—å¼print(sess.run(tf.matrix_inverse(D))) # çŸ©é˜µçš„é€†print(sess.run(tf.cholesky(identity_matrix))) # choleskåˆ†è§£ï¼ˆå¹³æ–¹æ ¹åˆ†è§£ï¼‰eigenvalues, eigenvectors = sess.run(tf.self_adjoint_eig(D)) # æ±‚ç‰¹å¾å‘é‡å’Œç‰¹å¾å€¼print(eigenvalues)print(eigenvectors) Math Operationï¼ˆæ•°å­¦æ“ä½œï¼‰ 123456789101112131415161718192021222324252627282930import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()# math operationprint(sess.run(tf.div(3, 4)))print(sess.run(tf.truediv(3, 4)))print(sess.run(tf.floordiv(3., 4.)))print(sess.run(tf.mod(22., 5.)))print(sess.run(tf.cross([1., 0., 0.], [0., 1., 0.])))# Trig operationprint(sess.run(tf.sin(3.1416)))print(sess.run(tf.cos(3.1416)))print(sess.run(tf.div(tf.sin(3.1416 / 4.), tf.cos(3.1416 / 4.))))# custom operation# f(x) = 3 * x^2 - X + 10test_nums = range(15) # ç”Ÿæˆä¸€ä¸ªlistdef custom_polynomial(x_val): return (tf.subtract(3 * tf.square(x_val), x_val) + 10)print(sess.run(custom_polynomial(11)))# list expendexpected_output = [3 * x * x - x + 10 for x in test_nums]print(expected_output)for num in test_nums: print(sess.run(custom_polynomial(num))) Activation Functionï¼ˆæ¿€æ´»å‡½æ•°ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445# æ¿€æ´»å‡½æ•°ä¸»è¦æ˜¯ä¸ºäº†è®©ç¥ç»ç½‘ç»œæ¨¡å‹å…·æœ‰éçº¿æ€§çš„ç‰¹æ€§import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()x_vals = np.linspace(start = -10, stop = 10, num = 100)# Relu Activation-&gt; max(0, x)print(sess.run(tf.nn.relu([-3., 3., 10.])))y_relu = sess.run(tf.nn.relu(x_vals))# Relu6 Activation-&gt; min(max(x, 0), 6)print(sess.run(tf.nn.relu6([-3., 3., 10.])))y_relu6 = sess.run(tf.nn.relu6(x_vals))# Sigmoidactivation-&gt; è§å…¬å¼1print(sess.run(tf.nn.sigmoid([-1., 0., 1.])))y_sigmoid = sess.run(tf.nn.sigmoid(x_vals))# Hyper Tangent activation-&gt;è§å…¬å¼2print(sess.run(tf.nn.tanh([-1., 0., 1.])))y_tanh = sess.run(tf.nn.tanh(x_vals))# softsign activation-&gt;è§å…¬å¼3print(sess.run(tf.nn.softsign([-1., 0., 1.])))y_softsign = sess.run(tf.nn.softsign(x_vals))# softplus activation-&gt;è§å…¬å¼4print(sess.run(tf.nn.softplus([-1., 0., 1.])))y_softplus = sess.run(tf.nn.softplus(x_vals))# Exponential linear activation-&gt;è§å…¬å¼5print(sess.run(tf.nn.elu([-1., 0., 1.])))y_elu = sess.run(tf.nn.elu(x_vals))plt.plot(x_vals, y_softplus, 'r--', label='Softplus', linewidth=2)plt.plot(x_vals, y_relu, 'b:', label='ReLU', linewidth=2)plt.plot(x_vals, y_relu6, 'g-.', label='ReLU6', linewidth=2)plt.plot(x_vals, y_elu, 'k-', label='ExpLU', linewidth=0.5)plt.ylim([-1.5,7])plt.legend(loc='upper left')plt.show()plt.plot(x_vals, y_sigmoid, 'r--', label='Sigmoid', linewidth=2)plt.plot(x_vals, y_tanh, 'b:', label='Tanh', linewidth=2)plt.plot(x_vals, y_softsign, 'g-.', label='Softsign', linewidth=2)plt.ylim([-2,2])plt.legend(loc='upper left')plt.show()ä¸‹å›¾ç»™å‡ºæ¿€æ´»å‡½æ•°çš„æ›²çº¿å›¾ å…¬å¼1ï¼š \\[ \\sigma(x)=\\frac{1}{1+e^{-x}} \\] å…¬å¼2ï¼š \\[ f(x)=\\frac{e^x-e^{-x}}{e^x + e^{-x}} \\] å…¬å¼3ï¼š \\[ f(x) = \\frac{1}{1 + |x|} \\] å…¬å¼4 \\[ f(x) = \\log(1 + e^x) \\] å…¬å¼5ï¼š \\[ elu(x) = \\begin{cases} x &amp; x &gt; 0 \\\\ \\alpha(exp(x) - 1) &amp; x \\leq 0 \\end{cases} \\] Operations on a Computational Graph 1234567891011121314151617181920212223242526272829import osimport matplotlib.pyplot as pltimport numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()# åˆ›å»ºçš„æ•°æ®æ˜¯è¦å–‚ç»™ä¸‹é¢çš„placeholderçš„x_vals = np.array([1., 3., 5., 7., 9.])# åˆ›å»ºplaceholderx_data = tf.placeholder(tf.float32)# åˆ›å»ºä¸€ä¸ªä¹˜æ•°m = tf.constant(3.)# ä¹˜æ³•prod = tf.multiply(x_data, m)for x_val in x_vals: print(sess.run(prod, feed_dict = &#123;x_data: x_val&#125;))#ä¸‹é¢å°†æ•°æ®è®¡ç®—å›¾è¾“å‡ºåˆ°æ–‡ä»¶é‡Œé¢ï¼Œä¾›æˆ‘ä»¬åæ¥å¯åŠ¨tensorboardä½¿ç”¨merged = tf.summary.merge_all(key = 'summary')if not os.path.exists('tensorboard_logs/'): os.makedirs('tensorboard_logs/')my_writer = tf.summary.FileWriter('./tensorboard_logs/', sess.graph) Layering Nested Operations 123456789101112131415161718192021222324252627282930313233343536373839404142import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tfimport osfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()# åˆ›å»ºæ•°æ®ä¸ºäº†feedmy_array = np.array([[1., 3., 5., 7., 9.], [-2., 0., 2., 4., 6.], [-6., -3., 0., 3., 6.]])# å¤åˆ¶x_vals = np.array([my_array, my_array + 1])# å£°æ˜placeholderx_data = tf.placeholder(tf.float32, shape = [3, 5])# å£°æ˜å¸¸æ•°æ¥æ“ä½œm1 = tf.constant([[1.], [0.], [-1.], [2.], [4]])m2 = tf.constant([[2.]])a1 = tf.constant([[10.]])# å£°æ˜æ“ä½œprod1 = tf.matmul(x_data, m1)prod2 = tf.matmul(prod1, m2)add1 = tf.matmul(prod2, a1)# æ‰“å°éªŒè¯ç»“æœfor x_val in x_vals: print(sess.run(add1, feed_dict = &#123;x_data: x_val&#125;)) #ä¸‹é¢å°†æ•°æ®è®¡ç®—å›¾è¾“å‡ºåˆ°æ–‡ä»¶é‡Œé¢ï¼Œä¾›æˆ‘ä»¬åæ¥å¯åŠ¨tensorboardä½¿ç”¨merged = tf.summary.merge_all(key = 'summaries')if not os.path.exists('tensorboard_logs/'): os.makedirs('tensorflow_logs/')my_writer = tf.summary.FileWriter('tensorboard_logs/', sess.graph)#ä¸‹å›¾å°±æ˜¯åœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œtensorflowå»ºç«‹çš„å›¾è¿ç®—æ¨¡å‹ Working With Multiple Layers 123456789101112131415161718192021222324252627282930313233343536373839404142434445import matplotlib.pyplot as pltimport numpy as npimport tensorflow as tfimport osfrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()x_shape = [1, 4, 4, 1]# å®šä¹‰ä¸€ä¸ª4 * 4 å¤§å°çš„éšæœºçŸ©é˜µx_val = np.randim.uniform(size = x_shape)x_data = tf.placeholder(tf.float32, shape = x_shape)# å®šä¹‰ä¸€ä¸ªç©ºé—´ç§»åŠ¨çª—å£ï¼Œä¹Ÿå°±æ˜¯å·ç§¯æ“ä½œçš„å·ç§¯æ ¸# å¤§å°æ˜¯2 * 2ï¼Œ æ­¥é•¿æ˜¯ 2# filterçš„å€¼æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼0.25my_filter = tf.constant(0.25, shape = [1, 2, 2, 1])my_strides = [1, 2, 2, 1]mov_avg_layer = tf.nn.conv2d(x_data, my_filter, my_strides, padding = 'SAME', name = 'Moving_Avg_Window')# ç¬¬äºŒå±‚def custom_layer(input_matrix): input_matrix_sqeezed = tf.squeeze(input_matrix) A = tf.constant([1., 2.], [-1., 3.]) b = tf.constant(1., shape = [2, 2]) output = tf.add(tf.matmul(A, input_matrix_sqeezed), b) return tf.nn.relu(output)with tf.name_scope('custom_layer') as scope: custom_layer1 = custom_layer(mov_avg_layer)# è¿è¡Œç»“æœprint(sess.run(mov_avg_layer, feed_dict = &#123;x_data: x_val&#125;))print(sess.run(custom_layer1, feed_dict = &#123;x_data: x_val&#125;))#ä¸‹é¢å°†æ•°æ®è®¡ç®—å›¾è¾“å‡ºåˆ°æ–‡ä»¶é‡Œé¢ï¼Œä¾›æˆ‘ä»¬åæ¥å¯åŠ¨tensorboardä½¿ç”¨merged = tf.summary.merge_all(key = 'summaries')if not os.path.exists('tensorboard_logs/'): os.makedirs('tensorboard_logs/')my_writer = tf.summary.FileWriter('tensorboard_logs', sess.graph)# ä¸‹å›¾æ˜¯è®¡ç®—å›¾ æ€»ç»“ï¼šè¿™ä¸€æ¬¡ï¼Œä¸€å¼€å§‹ä¸»è¦è®²äº†çŸ©é˜µçš„ä¸€äº›æ“ä½œï¼Œåç»­åˆè¿›è¡Œäº†æ•°å­¦æ“ä½œï¼Œæ¿€æ´»å‡½æ•°ï¼Œè¿ç®—å›¾ã€å±‚å†…å…ƒç´ åµŒå¥—è¿ç®—è¿˜æœ‰æœ€å¥½çš„å¤šå±‚è¿ç®—ï¼Œå¹¶ç»™å‡ºäº†tensorboardçš„è®¡ç®—å›¾ç»“æ„ã€‚å¤§å®¶ä¸ä»…ä»…è¦çœ‹ä¸€çœ‹ï¼Œä¹Ÿè¦åŠ¨æ‰‹åšä¸€åšå“¦ã€‚ ä¸€å¦‚æ—¢å¾€çš„æœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥ç›´æ¥è”ç³»milittleï¼Œair@weaf.topé‚®ç®±","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"Nginxå’ŒGitçš„ç¦»çº¿å®‰è£…","slug":"2018-03-26/offline-install-git-and-nginx","date":"2018-04-01T04:07:12.000Z","updated":"2018-05-29T01:27:49.810Z","comments":true,"path":"posts/a86291b8/","link":"","permalink":"http://weafteam.github.io/posts/a86291b8/","excerpt":"ä¸€ã€å‡†å¤‡å·¥ä½œ ä¸€èˆ¬æƒ…å†µä¸‹ä¸ºäº†ç¡®ä¿å®‰è£…æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨æœ‰ç½‘ç»œç¯å¢ƒçš„ä¸‹å®‰è£…çš„æ–¹æ³•ï¼Œå»æ£€æµ‹å½“å‰æœºå™¨å…·ä½“éœ€è¦å®‰è£…ä»€ä¹ˆå†¬å¤©é“¾æ¥åº“ï¼Œç„¶åæŒ‰ç…§æç¤ºç¼ºå¤±çš„åº“å»ä¸‹è½½ç›¸åº”çš„åº“ã€‚ æˆ‘ä»¬æŒ‰ç…§æ­£å¸¸çš„æµç¨‹ï¼Œå»è§£å‹nginx 1tar -zxvf nginx-1.13.8.tar.gz è¿›å…¥è§£å‹åçš„ç›®å½•æ‰§è¡Œ 12cd nginx-1.13.8./configure å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š æˆ‘ä»¬æŒ‰ç…§æœ‰ç½‘ç»œç¯å¢ƒçš„æ–¹æ³•å»æ£€æµ‹ç¼ºå¤±çš„åº“åŠå…¶ç‰ˆæœ¬ã€‚ 1yum -y install gcc gcc-c++ autoconf automake make","text":"ä¸€ã€å‡†å¤‡å·¥ä½œ ä¸€èˆ¬æƒ…å†µä¸‹ä¸ºäº†ç¡®ä¿å®‰è£…æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨æœ‰ç½‘ç»œç¯å¢ƒçš„ä¸‹å®‰è£…çš„æ–¹æ³•ï¼Œå»æ£€æµ‹å½“å‰æœºå™¨å…·ä½“éœ€è¦å®‰è£…ä»€ä¹ˆå†¬å¤©é“¾æ¥åº“ï¼Œç„¶åæŒ‰ç…§æç¤ºç¼ºå¤±çš„åº“å»ä¸‹è½½ç›¸åº”çš„åº“ã€‚ æˆ‘ä»¬æŒ‰ç…§æ­£å¸¸çš„æµç¨‹ï¼Œå»è§£å‹nginx 1tar -zxvf nginx-1.13.8.tar.gz è¿›å…¥è§£å‹åçš„ç›®å½•æ‰§è¡Œ 12cd nginx-1.13.8./configure å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š æˆ‘ä»¬æŒ‰ç…§æœ‰ç½‘ç»œç¯å¢ƒçš„æ–¹æ³•å»æ£€æµ‹ç¼ºå¤±çš„åº“åŠå…¶ç‰ˆæœ¬ã€‚ 1yum -y install gcc gcc-c++ autoconf automake make æ˜¾ç¤ºå¦‚ä¸‹ï¼š æˆ‘ä»¬ä¸‹è½½å·ç›¸åº”çš„åº“ ä¸‹è¾¹æä¾›å‡ ä¸ªä¸‹è½½çš„ç½‘å€ï¼š http://mirrors.163.com/centos/6/os/x86_64/Packages/ http://rpmfind.net/ https://pkgs.org ä¸‹è¾¹æ˜¯ä¸‹è½½å¥½çš„åº“ å®‰è£…ç›¸åº”çš„åº“ï¼ˆé›†ä½“å®‰è£…æƒ…å†µå…·ä½“åˆ†æï¼‰ï¼š 12345678910111213rpm -ivh mpfr-2.4.1-6.el6.x86_64.rpmrpm -ivh cpp-4.4.7-18.el6.x86_64.rpmrpm -Uvh tzdata-2016j-1.el6.noarch.rpmrpm -Uvh glibc-common-2.12-1.209.el6.x86_64.rpm glibc-2.12-1.209.el6.x86_64.rpm glibc-headers-2.12-1.209.el6.x86_64.rpm glibc-devel-2.12-1.209.el6.x86_64.rpm kernel-headers-2.6.32-696.el6.x86_64.rpmrpm -ivh libgomp-4.4.7-18.el6.x86_64.rpmrpm -Uvh libstdc++-4.4.7-18.el6.x86_64.rpmrpm -ivh libstdc++-devel-4.4.7-18.el6.x86_64.rpmrpm -ivh ppl-0.10.2-11.el6.x86_64.rpmrpm -ivh cloog-ppl-0.15.7-1.2.el6.x86_64.rpmrpm -Uvh libgcc-4.4.7-18.el6.x86_64.rpmrpm -ivh gcc-4.4.7-18.el6.x86_64.rpmrpm -ivh gcc-c++-4.4.7-18.el6.x86_64.rpmrpm -ivh automake-1.11.1-4.el6.noarch.rpm autoconf-2.63-5.1.el6.noarch.rpm ç„¶åæ‰§è¡Œ./configure å‘ç°é”™è¯¯ï¼š ç„¶åå®‰è£…ä¸€ä¸‹åº“ 1234567rpm -Uvh pcre-7.8-7.el6.x86_64.rpmrpm -ivh pcre-devel-7.8-7.el6.x86_64.rpmrpm -Uvh zlib-1.2.3-29.el6.x86_64.rpmrpm -ivh zlib-devel-1.2.3-29.el6.x86_64.rpmrpm -i --force --nodeps krb5-devel-1.10.3-65.el6.x86_64.rpmrpm -Uvh openssl-1.0.1e-57.el6.x86_64.rpmrpm -ivh openssl-devel-1.0.1e-57.el6.x86_64.rpm ç„¶åæ‰§è¡Œ 123./configuremakemake install å®‰è£…å®Œæˆ äºŒã€æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯ ===== æ ¹æ®å®‰è£…å®Œæˆçš„ä¿¡æ¯æŸ¥çœ‹nginx. ä¸‰ã€ç®€ä»‹ â€”â€“ ä¸åŒæ“ä½œç³»ç»Ÿçš„Linuxçš„å®‰è£…å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚ æœ¬æ•™ç¨‹ä½¿ç”¨çš„æ˜¯CentOSæˆ–è€…RHELã€‚ å››ã€å‡†å¤‡ç¯å¢ƒ â€”- å¦‚æœæœ‰ç½‘ç»œçš„æƒ…å†µä¸‹è‚¯å®šç›¸å½“å®¹æ˜“ï¼š 123yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel gcc perl-ExtUtils-MakeMakeryum install git è‹¥æœyumæºå®‰è£…çš„ç‰ˆæœ¬è¾ƒä½ï¼Œä¸æ‰§è¡Œyum install gitå‘½ä»¤ï¼Œå¹¶æŒ‰ç…§å››ã€äº”æ­¥éª¤æ“ä½œã€‚ å¦‚æœæ˜¯ç¦»çº¿éœ€è¦å®Œæˆåç»­æ“ä½œï¼š é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ°å®˜ç½‘ä¸‹è½½ç›¸åº”çš„å®‰è£…åŒ… https://www.kernel.org/pub/software/scm/git/ é€‰æ‹©tar.gz ä¸‰ã€ä¸‹è½½å’Œå®‰è£…ä¾èµ– â€”â€” ç„¶åæœ€éº»çƒ¦çš„åœ°æ–¹å°±æ˜¯ä¾èµ–åŠ¨æ€é“¾æ¥åº“çš„ä¸‹è½½ã€‚ éœ€è¦ä¸‹è½½çš„åº“å¯ä»¥åˆ°è¿™ä¸¤ä¸ªç½‘ç«™ä¸Šå»æ‰¾ï¼š fr2.rpmfind.net Linux Packages Search-pkgs.org æˆ‘è¿™é‡Œæä¾›äº†ä¸€äº› 1234567891011121314151617181920212223cpio-2.11-24.el7.x86_64.rpmcurl-7.29.0-42.el7.x86_64.rpmexpat-2.1.0-10.el7_3.x86_64.rpmexpat-devel-2.1.0-10.el7_3.x86_64.rpmgdbm-devel-1.10-8.el7.x86_64.rpmgettext-0.19.8.1-2.el7.x86_64.rpmgettext-devel-0.19.8.1-2.el7.x86_64.rpmkrb5-devel-1.15.1-8.el7.x86_64.rpmlibcurl-7.29.0-42.el7.x86_64.rpmlibcurl-devel-7.29.0-42.el7.x86_64.rpmlibdb-devel-5.3.21-20.el7.x86_64.rpmopenssl-1.0.2k-8.el7.x86_64.rpmopenssl-devel-1.0.2k-8.el7.x86_64.rpmperl-5.16.3-292.el7.x86_64.rpmperl-devel-5.16.3-292.el7.x86_64.rpmperl-ExtUtils-CBuilder-0.28.2.6-292.el7.noarch.rpmperl-ExtUtils-Install-1.58-292.el7.noarch.rpmperl-ExtUtils-MakeMaker-6.68-3.el7.noarch.rpmperl-ExtUtils-Manifest-1.61-244.el7.noarch.rpmperl-ExtUtils-ParseXS-3.18-3.el7.noarch.rpmsystemtap-sdt-devel-3.1-3.el7.x86_64.rpmzlib-1.2.7-17.el7.x86_64.rpmzlib-devel-1.2.7-17.el7.x86_64.rpm è¿™æ˜¯gitéœ€è¦çš„ä¸€äº›åº“ï¼Œéœ€è¦å®‰è£…çš„ä¸æ˜¯å¾ˆå¤šï¼Œä½†æ˜¯å®‰è£…çš„åº“ä¹Ÿéœ€è¦ä¾èµ–ã€‚ 123456789rpm -ivh perl-5.16.3-292.el7.x86_64.rpmrpm -ivh perl-devel-5.16.3-292.el7.x86_64.rpmrpm -ivh zlib-devel-1.2.7-17.el7.x86_64.rpmrpm -ivh libcurl-devel-7.29.0-42.el7.x86_64.rpmrpm -ivh curl-7.29.0-42.el7.x86_64.rpmrpm -ivh zlib-devel-1.2.7-17.el7.x86_64.rpmrpm -ivh openssl-devel-1.0.2k-8.el7.x86_64.rpmrpm -ivh perl-ExtUtils-MakeMaker-6.68-3.el7.noarch.rpmrpm -ivh gettext-devel-0.19.8.1-2.el7.x86_64.rpm ä»¥ä¸Šåº“éœ€è¦å®‰è£…ï¼Œå¹¶éœ€è¦å®‰è£…å¯¹åº”ä¾èµ–ã€‚ æœ‰æ—¶å€™æœ‰äº›åŒ…å¯èƒ½äº’ç›¸ä¾èµ–ï¼Œå®‰è£…æ—¶å¯ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ 1rpm -ivh perl-ExtUtils-MakeMaker-6.68-3.el7.noarch.rpm perl-ExtUtils-Install-1.58-292.el7.noarch.rpm zlib-devel-1.2.7-17.el7.x86_64.rpm ç¼–è¯‘å®‰è£…å¯èƒ½éœ€è¦çš„åŒ… 12345678910rpm -ivh cloog-ppl-0.15.7-1.2.el6.x86_64.rpmrpm -ivh cpp-4.4.7-18.el6.x86_64.rpmrpm -ivh gcc-4.4.7-18.el6.x86_64.rpmrpm -ivh gcc-c++-4.4.7-18.el6.x86_64.rpmrpm -ivh libgcc-4.4.7-18.el6.x86_64.rpmrpm -ivh libgomp-4.4.7-18.el6.x86_64.rpmrpm -ivh libstdc++-4.4.7-18.el6.x86_64.rpmrpm -ivh libstdc++-devel-4.4.7-18.el6.x86_64.rpmrpm -ivh mpfr-2.4.1-6.el6.x86_64.rpmrpm -ivh ppl-0.10.2-11.el6.x86_64.rpm æœ‰æ—¶ä¼šå‘ç”Ÿå†²çªå¯ä»¥ä½¿ç”¨æªæ”¯å¸è½½ï¼Œæˆ–è€…ä¸è€ƒè™‘ä¾èµ–å®‰è£…ã€‚ 12345rpm -e --nodeps mariadb-libs-5.5.56-2.el7.x86_64 //å¼ºåˆ¶å¸è½½rpm -i --force --nodeps krb5-devel-1.15.1-8.el7.x86_64.rpm //å¼ºåˆ¶å®‰è£… --forceå¯é€‰ äº”ã€è§£å‹å’Œå®‰è£… è§£å‹å®‰è£…åŒ… 1tar -zxvf git-2.15.1.tar.gz è¿›å…¥è§£å‹åçš„æ–‡ä»¶å¤¹ æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ 1./configure æ£€æŸ¥æ²¡æœ‰ä»»ä½•å‡ºé”™ ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ 1make æ£€æŸ¥æ²¡æœ‰é—®é¢˜æ‰§è¡Œå®‰è£… 1make install æ£€æŸ¥æ²¡æœ‰ä»»ä½•å‡ºé”™ å…­ã€æŸ¥çœ‹å®‰è£…ç»“æœ â€”- 1git --version","categories":[{"name":"Linux","slug":"Linux","permalink":"http://weafteam.github.io/categories/Linux/"}],"tags":[{"name":"Linuxè¿ç»´","slug":"Linuxè¿ç»´","permalink":"http://weafteam.github.io/tags/Linuxè¿ç»´/"}]},{"title":"TensorFlow å»ºç«‹ç½‘ç»œæ¨¡å‹","slug":"2018-03-26/TensorFlowå»ºç«‹ç½‘ç»œæ¨¡å‹è¯¦è§£","date":"2018-03-31T10:23:35.000Z","updated":"2018-05-29T01:27:49.806Z","comments":true,"path":"posts/5b7df854/","link":"","permalink":"http://weafteam.github.io/posts/5b7df854/","excerpt":"","text":"TensorFlow å»ºç«‹ç½‘ç»œæ¨¡å‹ ä¸Šæ¬¡ä¸€æˆ‘ä»¬åœ¨fashion-mnistä¸Šé¢ä½“éªŒäº†ä¸€æŠŠï¼Œä½†æ˜¯é‡Œé¢æœ‰ä¸€äº›å»ºç«‹æ¨¡å‹å’Œä¸€äº›TensorFlowçš„åŸºç¡€æ¦‚å¿µéƒ½æ²¡æœ‰ç»™å¤§å®¶è®²ï¼Œæ‰€ä»¥è¿™èŠ‚å†³å®šå°†è¿™æ–¹é¢çš„çŸ¥è¯†ä»‹ç»ä¸€äº›ï¼Œä¸ŠèŠ‚æ˜¯ä¸ºäº†å¼•èµ·å¤§å®¶çš„æ³¨æ„ï¼ŒTensorFlowå…·æœ‰å¾ˆå¼ºå¤§çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªèƒ½åç»­æ…¢æ…¢çš„å­¦ä¹ ã€‚ å…¶å®åœ¨ä¸Šä¸€æ¬¡çš„å®ä¾‹ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹ç¡®å®æ˜¯å¾ˆå›°æƒ‘çš„ï¼Œå¦‚æœæ²¡æœ‰æ¥è§¦è¿‡æœºå™¨å­¦ä¹ çš„å°ä¼™ä¼´å¯èƒ½ç†è§£èµ·æ¥ä¼šæœ‰ä¸€äº›é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘å¼€å¤´å°±ç¨å¾®è®²ä¸€ä¸‹ï¼Œæœºå™¨å­¦ä¹ æœ‰ä¸€äº›ä»€ä¹ˆï¼Ÿå°±æˆ‘ç°åœ¨äº†è§£çš„ä¸€äº›å†…å®¹ç»™å¤§å®¶ä»‹ç»ï¼Œæœ‰å¯èƒ½æœ‰ä¸€äº›ä¸åˆ°ä½çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤šå¤šåŒ…æ¶µï¼š å…¶å®æœºå™¨å­¦ä¹ ï¼Œæ€»çš„å®—æ—¨å°±æ˜¯åˆ©ç”¨æ•°æ®çš„ç‰¹å¾æ¥åšè¯†åˆ«å’Œåˆ†ç±»ç­‰ä»»åŠ¡ ç¬¬ä¸€å¤§ç±»æ˜¯åˆ†ç±»å·¥ä½œï¼Œå‡è®¾æœ‰ä¸€ç™¾ç±»ï¼Œç»å…¸çš„åšæ³•ï¼Œå°±æ˜¯ä½¿ç”¨ç¥ç»ç½‘ç»œæå–ä¸€äº›æ•°æ®çš„ç‰¹å¾ï¼Œç„¶ååˆ©ç”¨softmaxè¾“å‡ºå±‚è¿›è¡Œä¸åŒç§ç±»æ¦‚ç‡çš„é¢„æµ‹ï¼š \\[ softmax(i) = \\frac{X_i}{\\sum_{i=0,99}X_i} \\] ä¸Šé¢æ˜¯softmaxå±‚è®¡ç®—çš„å…¬å¼ï¼Œä»ä¸€ç™¾ç±»é‡Œé¢æ‰¾å‡ºæ¯ä¸€ç±»çš„æ¦‚ç‡å€¼ï¼Œç„¶åæŒ‰ç…§æ¦‚ç‡å€¼æ¥é¢„æµ‹è¾“å…¥æ•°æ®æ˜¯å“ªä¸€ç§ç±»å‹ï¼Œå°±åƒä¸Šä¸€æ¬¡æ–‡ç« é‡Œé¢çš„fashion-mnistçš„æ•°æ®ä¸€æ ·ï¼Œä¼šé¢„æµ‹å‡ºè¾“å‡ºçš„ç±»åˆ«ã€‚softmax(i)ä»£è¡¨çš„å°±æ˜¯è¿™ä¸ªç§ç±»çš„æ¦‚ç‡å€¼ï¼Œå–æœ€å¤§å€¼ä½œä¸ºé¢„æµ‹ç±»åˆ«ã€‚ ä½ å¯ä»¥æŠŠä¸€ä¸ªçŸ©é˜µçœ‹æˆä¸€ä¸ªæ•°æ®é›†åˆï¼Œä¸€è¡Œæ˜¯ä¸€ä¸ªæ•°æ®ä¿¡æ¯ï¼Œå°±å’Œæˆ‘ä»¬çš„å…³ç³»å‹æ•°æ®ä¸€æ ·ï¼Œä¸€è¡Œä»£è¡¨ä¸€ä¸ªè¡¨çš„ä¸€æ¡ä¿¡æ¯ï¼Œé‚£ä¹ˆæ¯åˆ—å°±æ˜¯æ¯ä¸€è¡Œæ•°æ®çš„ä¸€ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåœ¨æœºå™¨å­¦ä¹ é‡Œé¢å°±æ˜¯æ•°æ®çš„ç‰¹å¾äº†ï¼Œå› ä¸ºåœ¨ç½‘ç»œæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªç‰¹å¾éƒ½æœ‰å¯¹åº”çš„æƒé‡ï¼Œé‚£ä¹ˆï¼Œå¯¹äºæ¯ä¸ªç‰¹å¾æ¥è¯´ï¼Œå¯¹äºæœ€åçš„åˆ†ç±»ï¼Œè¯†åˆ«ç­‰å·¥ä½œèµ·çš„é‡è¦ç¨‹åº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™ä¹Ÿå’Œæˆ‘ä»¬çš„æ•°æ®åº“ä¿¡æ¯å·®ä¸å¤šï¼Œæœ‰ä¸€äº›ä¿¡æ¯ä¹Ÿæ˜¯æ— å…³ç´§è¦çš„ã€‚æœ‰äº›ä¿¡æ¯å¯ä»¥ä¸»è¦å†³å®šè¿™ä¸€è¡Œæ•°æ®ã€‚ ç¬¬äºŒå¤§ç±»å°±æ˜¯å›å½’ï¼Œå›å½’å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè¿ç»­çš„åˆ†ç±»ï¼Œå¯¹äºäºŒç»´æ•°æ®æ¥è¯´ï¼Œå…¶å®å°±æ˜¯æ ¹æ®ä½ ç»™å‡ºçš„æ•°æ®æ¥æ‹Ÿåˆä¸€æ¡çº¿ã€‚å¯¹äºä¸‰ç»´æ¥è®²å°±æ˜¯æ‹Ÿåˆä¸€ä¸ªå¹³é¢ã€‚å†é«˜ç»´å°±æ˜¯è¶…å¹³é¢ã€‚ æœ€è¿‘ï¼Œä¹Ÿå°±æ˜¯2018å¹´3æœˆ31åœ¨åŠ åˆ©ç¦å°¼äºšå·å±±æ™¯åŸçš„è®¡ç®—æœºå†å²åšç‰©é¦†ä¸¾åŠäº†ç¬¬äºŒå±ŠTensorFlowå¼€å‘è€…å³°ä¼šï¼Œä¼šä¸Šæœ‰è¶…è¿‡500åä½¿ç”¨TensorFlowçš„ç”¨æˆ·ï¼Œè¿˜æœ‰ä¸€äº›è§‚ä¼—ï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥å…³æ³¨youtubeçš„TensorFlowå®˜æ–¹é¢‘é“ã€‚å¯ä»¥æŸ¥çœ‹å¼€ä¼šçš„è§†é¢‘ã€‚ TensorFlowåº”ç”¨å¹¿æ³›ï¼Œå…¶ä¸­æœ‰ä½¿ç”¨TensorFlowæ¥åšå¼€æ™®å‹’ä»»åŠ¡åˆ†æçš„ ä¹Ÿæœ‰ä½¿ç”¨TensorFlowé¢„æµ‹å¿ƒè„å‘ä½œå’Œä¸­é£æ¦‚ç‡ è¿˜æœ‰ä¸€äº›åº”ç”¨åœ¨ç°å®å½“ä¸­çš„é¡¹ç›®ã€‚ è¿™è®©æˆ‘ä»¬è®¤è¯†åˆ°TensorFlowå¯¹äºå®é™…é¢†åŸŸä¸­åº”ç”¨çš„è¶Šæ¥è¶Šå¹¿æ³›ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å­¦ä¹ æ˜¯ä¸æ˜¯æœ‰ç‚¹äºã€‚è¿™ä¹ˆå¥½çš„å¼€æºé¡¹ç›®ã€‚ ä¸Šä¸€æ¬¡æˆ‘ä»¬æ—¢ç„¶åšè¿‡äº†ä¸€æ¬¡æœè£…ç±»åˆ«è¯†åˆ«ï¼Œé‚£ä¹ˆè¿™æ¬¡æˆ‘ä¸»è¦ä»TensorFlowå»ºç«‹æ¨¡å‹çš„æ­¥éª¤è®²èµ·ï¼šè®©å¤§å®¶å†æ·±å…¥ç†è§£ä¸€ä¸‹TensorFlowã€‚ ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œé‚£å°±æ˜¯å¯¼å…¥æ•°æ®ã€‚ ç¬¬äºŒæ­¥ä¸€èˆ¬å°±æ˜¯å¯¹æ•°æ®è¿›è¡Œçš„é¢„å¤„ç†ï¼Œä¸€èˆ¬åŒ…æ‹¬å½’ä¸€åŒ–æ•°æ®ï¼Œè½¬æ¢æ•°æ®ç­‰æ“ä½œã€‚ ç¬¬ä¸‰æ­¥è®¾ç½®ç®—æ³•çš„è¶…å‚æ•°ï¼Œä¸€èˆ¬ä¹Ÿå°±æ˜¯å­¦ä¹ ç‡ï¼Œbatch_size(æ‰¹å¤„ç†ä¸ªæ•°)ï¼Œepoch(è½®æ¬¡)ã€‚è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡å¦‚ä½ æœ‰10000æ¡è®­ç»ƒæ•°æ®ã€‚é‚£ä¹ˆï¼Œbatch_sizeè®¾ç½®ä¸º100ï¼Œé‚£ä¹ˆä½ çš„ä¸€ä¸ªepochå°±è¿­ä»£100æ¬¡æ‰èƒ½å°†æ‰€æœ‰æ•°æ®è®­ç»ƒä¸€éï¼Œæ¯æ¬¡è¾“å…¥æ•°æ®æ˜¯100æ¡ï¼Œå› ä¸ºä¸€ä¸ªepochçš„æ„æ€å°±æ˜¯è®­ç»ƒå®Œä¸€æ¬¡è®­ç»ƒæ•°æ®ï¼Œæ‰€ä»¥ä¸€ä¸ªepochæ˜¯è¿­ä»£100æ¬¡å°±å¯ä»¥ç»“æŸä¸€è½®äº†ã€‚learning_rateä¸€èˆ¬è®¾ç½®ä¸º0.1-0.0001ä¹‹é—´ï¼Œä½†æ˜¯ä¹Ÿä¸æ’é™¤ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œä¸»è¦æ˜¯learning_rateè®¾ç½®çš„è¿‡å°ï¼Œåå‘ä¼ æ’­æ›´æ–°å‚æ•°çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œè®¾ç½®çš„è¿‡å¤§ï¼Œä¼šå‡ºç°æ— æ³•æ”¶æ•›çš„æƒ…å†µã€‚ ç¬¬å››æ­¥è®¾ç½®å˜é‡å’Œplaceholdersï¼Œå˜é‡æ˜¯è®°å½•æƒé‡å’Œåç½®é¡¹ä¿¡æ¯çš„ï¼Œä¸€èˆ¬åœ¨æœ€å°åŒ–losså‡½æ•°çš„æ—¶å€™ï¼Œåå‘ä¼ æ’­ç®—æ³•ä¼šæ›´æ–°æƒé‡å’Œåç½®é¡¹ï¼ŒTensorFlowå¯¼å…¥æ•°æ®æ˜¯é€šè¿‡placeholdersæ¥å®ç°çš„ï¼Œå¤§å®¶è¿˜è®°å¾—æˆ‘ä»¬ä¸Šæ¬¡çš„fashion-mnistè¯†åˆ«ï¼Œæˆ‘çš„æ•°æ®å°±æ˜¯é€šè¿‡å…ˆå®šä¹‰placeholdersï¼Œæœ€ååœ¨Sessionè¿è¡Œçš„æ—¶å€™ï¼Œåœ¨feed_dictè¿™ä¸ªå­—å…¸å‚æ•°é‡Œé¢å°†è®­ç»ƒæ•°æ®å–‚è¿›å»çš„ã€‚ 1234a_var = tf.constant(42)x_input = tf.placeholder(tf.float32, [n_x, None], name=\"X\")x_output = tf.placeholder(tf.float32, [n_y, None], name=\"y\")# å®šä¹‰è¾“å…¥æ•°æ®çš„ä¸€äº›æ–¹å¼ ç¬¬äº”æ­¥å®šä¹‰å›¾æ¨¡å‹ï¼Œæˆ‘ä»¬æœ‰äº†æ•°æ®ï¼Œåˆå§‹åŒ–äº†å˜é‡å’Œplaceholdersï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å®šä¹‰ä¸€ä¸ªå›¾æ¨¡å‹ï¼Œæ¥ç”ŸæˆTensorFlowçš„å›¾æ¨¡å‹ï¼ˆè®¡ç®—å›¾ï¼‰æˆ‘ä»¬å¿…é¡»å‘Šè¯‰TensorFlowå¯¹æˆ‘ä»¬çš„æ•°æ®è¿›è¡Œå“ªäº›æ“ä½œï¼Œæ¥è®©æˆ‘ä»¬çš„æ¨¡å‹å…·æœ‰é¢„æµ‹èƒ½åŠ›ï¼ˆæ›´åŠ æ·±å…¥çš„è¿ç®—æˆ‘ä»¬åœ¨åç»­çš„åšå®¢é‡Œé¢ä¼šé™†ç»­è®²åˆ°ï¼‰ 1h_pre_output = tf.add(tf.matmul(W, x_input) + B) ç¬¬å…­æ­¥å£°æ˜losså‡½æ•°ï¼Œåœ¨ä¸Šé¢è®¡ç®—å›¾ä¸­æˆ‘ä»¬å®šä¹‰äº†ä¸€äº›å¯¹æˆ‘ä»¬æ•°æ®çš„æ“ä½œã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦éªŒè¯æˆ‘ä»¬é¢„æµ‹çš„è¾“å‡ºï¼Œå’Œæˆ‘ä»¬çœŸå®ä¹‹é—´çš„å·®è·ï¼Œä¸€èˆ¬å¯¹äºå›å½’ä»»åŠ¡æ¥è®²çš„è¯ï¼Œå°±æ˜¯å¹³æ–¹è¯¯å·®ï¼šè¿™æ ·å°±æ±‚å¾—äº†å¹³æ–¹è¯¯å·®ã€‚ä½†æ˜¯å¯¹äºåˆ†ç±»ä»»åŠ¡ï¼Œé‚£å°±æ˜¯äº¤å‰ç†µè¯¯å·®ã€‚å°±åƒä¸Šä¸€èŠ‚æˆ‘ä»¬ç”¨åˆ°çš„lossç”Ÿæˆå‡½æ•°å°±æ˜¯softmaxè¿™ç§æ–¹å¼ã€‚ï¼Œäº¤å‰ç†µçš„å…¬å¼åç»­ç”¨åˆ°å†ç»™å¤§å®¶ä»‹ç»ã€‚ \\[ loss(i)=\\frac{1}{N}\\sum{_i}(y\\_pre_i-y\\_true_i)^2 \\] 12TensorFlowæ±‚æ³•ï¼šloss = tf.reduce_mean(tf.square(y_pre - y_true)) ç¬¬ä¸ƒæ­¥å£°æ˜äº†losså‡½æ•°ä»¥åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨BPç®—æ³•ä¹Ÿå°±æ˜¯åå‘ä¼ æ’­ç®—æ³•æ¥æ›´æ–°æƒé‡å’Œåç½®é¡¹ã€‚åœ¨TenorFlowæ¡†æ¶é‡Œé¢æœ‰å¥½å¤šè¿™æ ·çš„ä¼˜åŒ–å™¨ï¼Œéƒ½åœ¨ tf.trainè¿™ä¸ªæ¨¡å—é‡Œé¢ã€‚ 12optimizer = tf.train.AdamOptimizer(learning_rate = 0.001).minimize(loss)è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¸Šæ¬¡ä½¿ç”¨çš„ä¼˜åŒ–å™¨ï¼Œæ¥ä¼˜åŒ–æˆ‘ä»¬çš„loss æœ€åä¸€æ­¥é‚£å°±æ˜¯åˆå§‹åŒ–ä¼šè¯Session()ï¼Œå¼€å§‹è®­ç»ƒæ¨¡å‹ 123with tf.Session() as session: session.run(init) ..... ç”±ä¸Šé¢çš„æ­¥éª¤ï¼Œå¤§å®¶å†ç»“åˆä¸Šä¸€æ¬¡çš„ç½‘ç»œä»£ç ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£äº†TensorFlowåœ¨å»ºç«‹ä¸€ä¸ªç½‘ç»œæ¨¡å‹çš„æ—¶å€™çš„å…·ä½“æ­¥éª¤ã€‚ å…¶å®åœ¨TensorFlowä¸­è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯Tensorï¼Œä¸Šæ¬¡è¯´è¿‡äº†å®ƒçš„æ¦‚å¿µï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘è®²ä¸€ä¸‹TensorFlowé‡Œé¢çš„Tensorã€‚ 1234567891011121314151617181920212223242526import tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()# å®šä¹‰ä¸€ä¸ªä¼šè¯ï¼Œè®°å¾—ï¼ŒTensorFlowé‡Œé¢éƒ½æ˜¯é€šè¿‡sessionæ¥æ‰§è¡Œçš„sess = tf.Session()# åˆ›å»ºä¸€ä¸ª1 * 20çš„å‘é‡tensor_zeros = tf.zeros([1, 20])sess.run(tensor_zeros) # ä½ å¯ä»¥è¿è¡Œä¸€ä¸‹çœ‹çœ‹my_var = tf.Variable(tf.zeros([1, 20])) # ä½¿ç”¨tensoæ¥åˆå§‹åŒ–å˜é‡sess.run(my_var.initializer) # åˆä¸€ç§è¿è¡Œå˜é‡åˆå§‹åŒ–å™¨çš„æ–¹å¼sess.run(my_var) #æ‰“å°å‡ºæ¥çœ‹çœ‹# tf.ones() ç”Ÿæˆå…¨æ˜¯1# tf.zeros() ç”Ÿæˆå…¨æ˜¯0# tf.constant() ç”Ÿæˆä¸€ä¸ªå¸¸é‡Tensor# å¦‚æœæˆ‘ä»¬æƒ³è¦é€šè¿‡ä¸€ä¸ªå·²çŸ¥çš„Tensoræ¥åˆ›å»ºå¦ä¸€ä¸ªï¼Œåˆ™å¯ä»¥ä½¿ç”¨ones_like()å’Œzeros_like()è¿™ä¸¤ä¸ªå‡½æ•°zero_similar = tf.Variable(tf.zeros_like(tensor_zeros))sess.run(zero_similar.initializer)print(sess.run(zero_similar))# æ³¨æ„ä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ä¸ºäº†ç¡®å®šç”ŸæˆTensorçš„å¤§å°ï¼Œè€Œäº§ç”Ÿçš„å€¼æ˜¯é€šè¿‡å‡½æ•°å†³å®šçš„tf.fill([row, col], -1) # ç”¨å…·ä½“çš„æ•°å­—å¡«å……tf.linspace(start=0.0, stop=1.0, num=3) # çº¿æ€§åˆ†å¸ƒ åŒ…æ‹¬endtf.range(start=6, limit=15, delta=3) # ä¹Ÿæ˜¯çº¿æ€§å‡åŒ€ ä¸åŒ…æ‹¬endtf.random_normal([row_dim, col_dim], mean=0.0, stddev=1.0) # éšæœº å‡å€¼0 æ–¹å·®1.0tf.random_uniform([row_dim, col_dim], minval=0, maxval=4) # æˆ–è€…æœ€å°æœ€å¤§å€¼éšæœºåˆå§‹åŒ– 1234567891011121314151617import tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()my_var = tf.Variable(tf.zeros([1,20]))merged = tf.summary.merge_all()writer = tf.summary.FileWriter(\"./tmp/variable_logs\", graph=sess.graph)initialize_op = tf.global_variables_initializer()sess.run(initialize_op)# ä¸Šé¢çš„å°±æ˜¯ä¸€ä¸ªTensoræ”¾åœ¨ä¸€ä¸ªå˜é‡é‡Œé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€æ¡è¯­å¥ merged = tf.summary.merge_all() è¿˜æœ‰writer = tf.summary.FileWriter(\"/tmp/variable_logs\", graph=sess.graph)ï¼Œè¿™ä¸¤å¥è¿™æ˜¯ä¸ºäº†å°†å˜é‡åœ¨TensorBoardé‡Œé¢æ˜¾ç¤ºå‡ºæ¥ï¼Œè®©æˆ‘ä»¬æ›´åŠ äº†è§£TensorFLowçš„ä¸€äº›æ“ä½œã€‚# ä¸Šé¢çš„æ“ä½œè¿‡ç¨‹ä¼šåœ¨å½“å‰æ–‡ä»¶å¤¹é‡Œé¢åˆ›å»ºä¸€ä¸ª/tmp/variable_logsæ–‡ä»¶å¤¹ç„¶åä¼šå°†å˜é‡ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ é‚£æ€ä¹ˆä½¿ç”¨tensorboard 12#è¿›å»æˆ‘ä»¬çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åæ‰§è¡Œtensorboard --logdir=tmpçš„ç»å¯¹è·¯å¾„ å¯ä»¥çœ‹åˆ°æˆ‘ä¸Šé¢æ‰§è¡Œçš„å‘½ä»¤ã€‚ç„¶ååœ¨æµè§ˆå™¨é‡Œé¢è¾“å…¥127.0.0.1:6006ç„¶åä½ å°±å¯ä»¥çœ‹åˆ°åˆšæ‰é‚£ä¸ªå˜é‡çš„æ“ä½œè¿‡ç¨‹ï¼Œè¿™å°±æ˜¯tensorboardçš„é­…åŠ› ä¸Šé¢å°±æ˜¯ä¸€ä¸ªå˜é‡åœ¨è¿›è¡Œåˆå§‹åŒ–æ—¶å€™å¯è§†åŒ–æ˜¾ç¤º Placeholdersä½¿ç”¨(ä¸€æ ·å¯ä»¥ä½¿ç”¨tensorboardæ¥æŸ¥çœ‹) 123456789101112131415import numpy as npimport tensorflow as tffrom tensorflow.python.framework import opsops.reset_default_graph()sess = tf.Session()# å®šä¹‰ä¸€ä¸ªplaceholderx = tf.placeholder(tf.float32, shape = (4, 4))# éšæœºç”Ÿæˆ4 * 4çš„çŸ©é˜µreand_array = np.random.rand(4, 4)y = tf.identity(x) # è¿”å›ä¸è¾“å…¥å¯¹è±¡ç›¸åŒçš„å†…å®¹å’Œå¤§å°print(sess.run(y, feed_dict=&#123;x: rand_array&#125;))merged = tf.summary.merge_all()writer = tf.summary.FileWriter(&quot;./tmp/variable_logs&quot;, sess.graph) æ€»ç»“ è¿™æ¬¡æˆ‘ä»¬å°±TensorFlowçš„ä¸€äº›åŸºç¡€æ¦‚å¿µçš„ä»‹ç»ï¼Œä¹Ÿæ˜¯ä¸ºäº†è®©å¤§å®¶åœ¨ä»¥åçš„TensorFlowä½¿ç”¨è¿‡ç¨‹ä¸­å°‘ä¸€äº›ç–‘é—®ï¼Œåé¢çš„ç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šæ…¢æ…¢æ·±å…¥ã€‚å°ä¼™ä¼´ä»¬ä¸è¦ç€æ€¥ï¼Œæˆ‘çš„é‚®ç®±æ˜¯air@weaf.topï¼Œä¾æ—§æ˜¯é‚£ä¸ªå¯ä»¥äº¤æµå­¦ä¹ çš„milittleã€‚è°¢è°¢å¤§å®¶çš„é©»è¶³ã€‚ ç¬¬ä¸€ç¯‡ TensorFlowå®‰è£… ç¬¬äºŒç¯‡ TensorFlowåˆä½“éªŒï¼ˆfasion-mnistè¯†åˆ«ï¼‰ ä¿®æ”¹pipå…¨å±€é•œåƒæ–¹æ³•","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆä¸‰ï¼‰æ„å»ºè¯è¢‹ç©ºé—´VSMï¼ˆVector Space Modelï¼‰","slug":"2018-03-26/æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆä¸‰ï¼‰æ„å»ºè¯è¢‹ç©ºé—´VSMï¼ˆVector-Space-Modelï¼‰","date":"2018-03-30T06:00:08.000Z","updated":"2018-05-29T01:27:49.814Z","comments":true,"path":"posts/a751f7e5/","link":"","permalink":"http://weafteam.github.io/posts/a751f7e5/","excerpt":"","text":"å’±ä»¬ä»Šå¤©å…ˆèŠä¸ªæ¦‚å¿µå§ï¼Œè‘—åçš„èšç±»å‡è®¾ï¼Œè¿™ä¹Ÿæ˜¯æ–‡æœ¬èšç±»çš„ä¾æ®ï¼Œå†…å®¹å¦‚ä¸‹ï¼šè¯¥å‡è®¾è®¤ä¸ºï¼ŒåŒç±»çš„æ–‡æ¡£ç›¸ä¼¼åº¦è¾ƒå¤§ï¼Œè€Œä¸åŒç±»çš„æ–‡æ¡£ç›¸ä¼¼åº¦è¾ƒå°ã€‚ æ¦‚å¿µï¼š å¯¹äºä¸Šè¿°æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯åšæ–‡æœ¬èšç±»çš„åŸºç¡€ï¼Œå¦‚æœä¸ç›¸å…³çš„æ–‡æ¡£åè€Œç›¸ä¼¼åº¦é«˜ï¼Œæˆ‘ä»¬ä¾¿æ— æ³•åšæ–‡æœ¬èšç±»ã€‚ æ¥ä¸‹æ¥å†è¯´VSM(Vector Space Model),å¯¹äºVSMçš„å®šä¹‰ï¼Œæˆ‘åœ¨ç½‘ä¸Šæœç½—äº†äº›èµ„æ–™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š Vector space model (or term vector model) is an algebraic model for representing text documents (and any objects, in general) as vectors of identifiers, such as, for example, index terms. It is used in information filtering, information retrieval, indexing and relevancy rankings. Its first use was in the SMART Information Retrieval System. A document is represented as a vector. Each dimension corresponds to a separate term. If a term occurs in the document, its value in the vector is non-zero. Several different ways of computing these values, also known as (term) weights, have been developed. One of the best known schemes is tf-idf weighting. The definition of term depends on the application. Typically terms are single words, keywords, or longer phrases. If the words are chosen to be the terms, the dimensionality of the vector is the number of words in the vocabulary (the number of distinct words occurring in the corpus). æ‹™åŠ£çš„ç¿»è¯‘ï¼š å‘é‡ç©ºé—´æ¨¡å‹æ˜¯ç”¨æ¥è¡¨ç¤ºæ–‡æœ¬æ–‡æ¡£ï¼ˆé€šå¸¸ä¹ŸåŒ…å«ä¸€äº›å¯¹è±¡ï¼‰çš„ç‰¹å¾å‘é‡çš„ä»£æ•°æ¨¡å‹ï¼Œä¾‹å¦‚ç´¢å¼•è¯é¡¹ã€‚å®ƒè¢«åº”ç”¨äºä¿¡æ¯è¿‡æ»¤ã€ä¿¡æ¯æ£€ç´¢ã€ç´¢å¼•å’Œç›¸å…³åº¦è®¡ç®—ã€‚è¿™ä¸ªæ¨¡å‹æœ€æ—©è¢«åº”ç”¨äºSMARTä¿¡æ¯æ£€ç´¢ç³»ç»Ÿã€‚ ä¸€ä¸ªæ–‡æœ¬æ–‡æ¡£è¡¨ç¤ºä¸€ä¸ªå‘é‡ã€‚æ¯ä¸€ä¸ªç»´åº¦ç›¸å½“äºä¸€ä¸ªå•ç‹¬çš„è¯é¡¹ï¼ˆtermï¼‰ã€‚å¦‚æœä¸€ä¸ªè¯é¡¹ï¼ˆtermï¼‰å‡ºç°åœ¨ä¸€ä¸ªæ–‡æ¡£ä¸­ï¼Œé‚£ä¹ˆå®ƒåœ¨è¡¨ç¤ºè¯¥æ–‡æ¡£çš„å‘é‡ä¸­å¯¹åº”é¡¹ä¸ä¸º0.æœ‰ä¸€äº›è®¡ç®—è¿™äº›è¯é¡¹ï¼ˆtermï¼‰æƒé‡çš„æ–¹æ³•è¢«é€æ¸æå‡ºæ¥ï¼Œå…¶ä¸­æœ€è‘—åçš„æ–¹æ³•å°±æ˜¯tf-idfæƒé‡è®¡ç®—æ–¹æ³•ã€‚ å¯¹äºè¯é¡¹ï¼ˆtermï¼‰çš„å®šä¹‰ä¾èµ–äºåº”ç”¨ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œè¯é¡¹ï¼ˆtermï¼‰å¯ä»¥æ˜¯å•è¯ã€å…³é”®å­—ã€æˆ–è€…é•¿çŸ­è¯­ã€‚å¦‚æœå•è¯ä½œä¸ºè¯é¡¹ï¼ˆtermï¼‰ï¼Œé‚£ä¹ˆå‘é‡ä¸­çš„ç»´åº¦å°±æ˜¯è¯æ±‡è¡¨ä¸­çš„å•è¯çš„ä¸ªæ•°ï¼ˆå‡ºç°åœ¨æ–‡æ¡£å…¨é›†ä¸­æ‰€æœ‰ä¸åŒçš„å•è¯çš„æ•°é‡ï¼‰ã€‚ å°è”æï¼š ä¸¾ä¸ªè”æå§ ï¼Œæ–¹ä¾¿ç†è§£ä¸Šè¿°çš„æ¦‚å¿µã€‚é¦–å…ˆå‡è®¾æœ‰è¿™æ ·ä¸¤ä¸ªæ–‡æœ¬ 1.æˆ‘æ¥åˆ°åŒ—äº¬æ¸…åå¤§å­¦ 2.ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦ åˆ†è¯ç»“æœä¸ºï¼šæˆ‘/æ¥åˆ°/åŒ—äº¬/æ¸…åå¤§å­¦å’Œä»–/æ¥åˆ°/äº†/ç½‘æ˜“/æ­ç ”/å¤§å¦ç»Ÿè®¡æ‰€æœ‰æ–‡æ¡£çš„è¯é›†åˆï¼šæˆ‘/æ¥åˆ°/åŒ—äº¬/æ¸…åå¤§å­¦/ä»–/äº†/ç½‘æ˜“/æ­ç ”/å¤§å¦ï¼ŒæŒ‰ç…§1983åœç”¨è¯å»é™¤åœç”¨è¯åç»“æœä¸ºï¼šæ¥åˆ°/åŒ—äº¬/æ¸…åå¤§å­¦/ç½‘æ˜“/æ­ç ”/å¤§å¦ æˆ‘ä»¬å¯¹è¿™ä¸¤ä¸ªæ–‡æœ¬æ„å»ºå‘é‡ï¼Œç»“æœå¦‚ä¸‹ æ¥åˆ° åŒ—äº¬ æ¸…åå¤§å­¦ ç½‘æ˜“ æ­ç ” å¤§å¦ æ–‡æœ¬1 1 1 1 0 0 0 æ–‡æœ¬2 1 0 0 1 1 1 ç›¸ä¿¡ä½ å·²ç»å¯¹VSMçš„è®¤è¯†æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„è½®å»“ï¼Œä½†æ˜¯ç»†å¿ƒçš„ä½ ä¹Ÿå¯èƒ½å‘ç°äº†ï¼Œæˆ‘ä»¬åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­è®¡ç®—termå€¼çš„æ–¹æ³•ä»…ä»…åªæ˜¯è®¡æ•°ï¼Œè¿™æ ·çš„termå€¼æ˜¯å¦æœ‰æ„ä¹‰å‘¢ï¼Ÿæˆ‘ä»¬æ˜¯å¦èƒ½ç”¨è¿™æ ·çš„æ–¹æ³•ç›´æ¥è¿›è¡Œæ¥ä¸‹æ¥çš„è®¡ç®—å‘¢ï¼Ÿå¯¹äºå‰ä¸€ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ä¸ç®¡åœ¨æ­¤åŸºç¡€ä¸Šåšä»€ä¹ˆæ ·çš„æ”¹è¿›ï¼Œæˆ‘ä»¬æœ€åŸºç¡€çš„å°±æ˜¯ç»Ÿè®¡å•è¯å‡ºç°çš„æ¬¡æ•°ï¼Œé‚£å°±è®©æˆ‘ä»¬å…ˆæŠŠä¸Šè¿°çš„ä»£ç å®ç°ä¸€ä¸‹å§(ä¸è¯¥æ–‡ä»¶åŒç›®å½•ä¸‹æœ‰ä¸ªåä¸ºtxt1çš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰1.txtå’Œ2.txtä¸¤ä¸ªæ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«æ˜¯ä¸Šè¿°æ‰€è¯´çš„ä¸¤ä¸ªæ–‡æ¡£ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ¬¡RmStopWord.pyçš„åŸºç¡€ä¸Šå†åšä¿®æ”¹)ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162import sysimport jiebaimport osimport numpy as npfrom os import pathd = path.dirname(__file__) # è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„stopwords_path = 'stopwords1893.txt' # åœç”¨è¯è¡¨è·¯å¾„#text = open(path.join(d, text_path),'rb').read()def read_from_file(file_name): with open(file_name,\"r\") as fp: words = fp.read() return wordsdef RmStopWords(text): mywordlist = [] seg_list = jieba.cut(text, cut_all=False) liststr=\"/ \".join(seg_list) # æ·»åŠ åˆ‡åˆ†ç¬¦ f_stop = open(stopwords_path) try: f_stop_text = f_stop.read() finally: f_stop.close( ) f_stop_seg_list=f_stop_text.split('\\n') # åœç”¨è¯æ˜¯æ¯è¡Œä¸€ä¸ªï¼Œæ‰€ä»¥ç”¨/nåˆ†ç¦» for myword in liststr.split('/'): #å¯¹äºæ¯ä¸ªåˆ‡åˆ†çš„è¯éƒ½å»åœç”¨è¯è¡¨ä¸­å¯¹æ¯” if not(myword.strip() in f_stop_seg_list) and len(myword.strip())&gt;1: mywordlist.append(myword) return mywordlistdef get_all_vector(file_path): names = [ os.path.join(file_path,f) for f in os.listdir(file_path) ] txts = [ open(name).read() for name in names] docs = [] word_set = set() for txt in txts: doc = RmStopWords(txt) docs.append(doc) word_set |= set(doc) word_set = list(word_set) docs_vsm = [] # è¿™é‡Œåªæ˜¯æƒ³æ˜¾ç¤ºæœ‰å¤šå°‘term for word in word_set[:30]: print(word) for doc in docs: temp_vector = [] for word in word_set: temp_vector.append(doc.count(word) * 1.0) docs_vsm.append(temp_vector) docs_matrix = np.array(docs_vsm) return docs_matrix # txt2 = RmStopWords(read_from_file(text1_path))# print(txt2)#æ–‡ä»¶è·¯å¾„ä¸ºtxt1/1.txtå’Œ2.txtï¼Œåªä¸è¿‡æˆ‘è®©ç¨‹åºå¾ªç¯æ‰«ætxt1ä¸‹æ‰€æœ‰çš„æ–‡æœ¬æ–‡ä»¶txt3 = get_all_vector('txt1')print(txt3) è¿è¡Œç»“æœï¼š åˆ†æï¼š ä¸Šè¿°ç»“æœä¸è¨€è€Œå–»ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç€è®¨è®ºï¼Œæ˜¾è€Œæ˜“è§ï¼Œæˆ‘æ—¢ç„¶æå‡ºäº†ç¬¬äºŒä¸ªç–‘é—®å°±ä¸€å®šæœ‰å®ƒè¢«æå‡ºçš„é“ç†ï¼Œä»…ä»…åªè®¡ç®—termå€¼çš„æ–¹æ³•æ˜¾ç„¶å­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä»¬å†éšä¾¿ä¸¾ä¸ªä¾‹å­ï¼Œæ–‡æœ¬1ä¸­åŒ—äº¬åªå‡ºç°äº†1æ¬¡ï¼Œä½†æ˜¯æ–‡æœ¬1ä¸­åªæœ‰3ä¸ªå•è¯ï¼Œæ–‡æœ¬2ä¸­åŒ—äº¬å‡ºç°äº†10æ¬¡ä½†æ˜¯æ–‡æœ¬2ä¸­æœ‰1000ä¸ªå•è¯ï¼Œé‚£æˆ‘ä»¬ç”¨ä¸Šè¿°çš„æ–¹æ³•æ˜¾ç„¶ä¸åˆé€‚ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿è¦è®²ä¸€ä¸ªæœ€è‘—åçš„æ–¹æ³•tf-idfè®¡ç®—æƒå€¼çš„æ–¹æ³•ã€‚ TF-IDF(term frequencyâ€“inverse document frequency) ç»´åŸºç™¾ç§‘å’Œç™¾åº¦ç™¾ç§‘ä¸Šçš„è®²çš„å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œæˆªå–æ¦‚å¿µæ–¹ä¾¿å¤§å®¶é˜…è¯»ï¼Œæ›´è¯¦ç»†çš„å†…å®¹è¯·å‚è€ƒå‰é¢æ‰€è¯´çš„ä¸¤ä¸ªç™¾ç§‘ã€‚ TF-IDFæ˜¯ä¸€ç§ç»Ÿè®¡æ–¹æ³•ï¼Œç”¨ä»¥è¯„ä¼°ä¸€ä¸ªè¯(term)å¯¹äºä¸€ä¸ªæ–‡ä»¶é›†æˆ–è€…ä¸€ä¸ªè¯­æ–™åº“ä¸­çš„ä¸€ä»½æ–‡ä»¶çš„é‡è¦ç¨‹åº¦ã€‚ä¸€ä¸ªè¯(term)çš„é‡è¦æ€§éšç€å®ƒåœ¨æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°æˆæ­£æ¯”å¢åŠ ï¼Œä½†åŒæ—¶ä¼šéšç€å®ƒåœ¨è¯­æ–™åº“ä¸­å‡ºç°çš„é¢‘ç‡æˆåæ¯”ä¸‹é™ã€‚ åŸç†ï¼š TF-IDFçš„ä¸»è¦æ€æƒ³æ˜¯ï¼šå¦‚æœæŸä¸ªè¯æˆ–çŸ­è¯­(term)åœ¨ä¸€ç¯‡æ–‡ç« ä¸­å‡ºç°çš„é¢‘ç‡TFé«˜ï¼Œå¹¶ä¸”åœ¨å…¶ä»–æ–‡ç« ä¸­å¾ˆå°‘å‡ºç°ï¼Œåˆ™è®¤ä¸ºæ­¤è¯æˆ–è€…çŸ­è¯­(term)å…·æœ‰å¾ˆå¥½çš„ç±»åˆ«åŒºåˆ†èƒ½åŠ›ï¼Œé€‚åˆç”¨æ¥åˆ†ç±»ã€‚å¦‚æœåŒ…å«è¯æ¡termçš„æ–‡æ¡£è¶Šå°‘ï¼Œä¹Ÿå°±æ˜¯nè¶Šå°ï¼Œåˆ™IDFè¶Šå¤§ï¼Œåˆ™è¯´æ˜è¯æ¡termä¹Ÿå…·æœ‰å¾ˆå¥½çš„ç±»åˆ«åŒºåˆ†èƒ½åŠ›ã€‚ æ€è€ƒï¼š ç°åœ¨æƒ³ä¸€ä¸‹æˆ‘ä»¬åˆšæ‰æå‡ºçš„é—®é¢˜ï¼Œé’ˆå¯¹æˆ‘ä»¬ä¸Šè¿°çš„é—®é¢˜ï¼šåŒä¸€è¯è¯­åœ¨é•¿æ–‡ä»¶é‡Œå¯èƒ½ä¼šæ¯”çŸ­æ–‡ä»¶æœ‰æ›´é«˜çš„è¯æ•°ï¼Œè€Œä¸ç®¡è¯¥è¯é‡è¦ä¸å¦ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯¹è¯æ•°åšå½’ä¸€åŒ–å°±å¯ä»¥äº†ï¼Œè€ŒTFå°±å¸®æˆ‘ä»¬åšäº†è¿™æ ·çš„äº‹ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å…ˆç»™å‡ºTFçš„è¿ç®—å…¬å¼å§ã€‚ \\(tf_i,_j = \\frac{n_i,_j}{\\sum_k n_k,_j}\\) TFå…¬å¼è§£è¯»ï¼šä¸Šå¼ä¸­åˆ†å­æ˜¯è¯¥è¯åœ¨æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œè€Œåˆ†æ¯åˆ™æ˜¯è¯¥è¯åœ¨æ–‡ä»¶ä¸­å‡ºç°çš„è¯æ•°ä¹‹å’Œã€‚ æˆ‘ä»¬å†è®²ä¸ªå°é—®é¢˜ï¼š å¦‚æœæŸä¸€ç±»æ–‡æ¡£Cä¸­åŒ…å«è¯æ¡tçš„æ–‡æ¡£æ•°ä¸ºmï¼Œè€Œå…¶ä»–ç±»åŒ…å«tçš„æ–‡æ¡£æ€»æ•°ä¸ºkï¼Œæ˜¾ç„¶æ‰€æœ‰åŒ…å«tçš„æ–‡æ¡£æ•°n=m+kï¼Œè€Œå½“må˜å¤§çš„æ—¶å€™ï¼Œnä¹Ÿå˜å¤§ï¼Œè¿™æ˜¯åæŒ‰ç…§IDFçš„è®¡ç®—æ–¹æ³•è®¡ç®—å¾—åˆ°çš„IDFå€¼ä¼šå˜å°ï¼Œä¹Ÿå°±ç›¸å¯¹åº”çš„è¯´æ˜è¯¥è¯æ¡tç±»åˆ«åŒºåˆ†èƒ½åŠ›ä¸å¼ºã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œå¦‚æœä¸€ä¸ªè¯æ¡åœ¨ä¸€ä¸ªç±»çš„æ–‡ä»¶ä¸­é¢‘ç¹å‡ºç°ï¼Œåˆ™è¯´æ˜è¯¥è¯æ¡èƒ½å¤Ÿå¾ˆå¥½çš„ä»£è¡¨è¿™ä¸ªç±»çš„æ–‡æœ¬çš„ç‰¹å¾ï¼Œè¿™æ ·çš„è¯æ¡åº”è¯¥ç»™å®ƒä»¬èµ‹äºˆè¾ƒé«˜çš„æƒé‡ï¼Œå¹¶é€‰æ¥ä½œä¸ºè¯¥ç±»æ–‡æœ¬çš„ç‰¹å¾è¯ä»¥åŒºåˆ«ä¸å…¶å®ƒç±»æ–‡æ¡£ã€‚å…¶å®è¿™å°±æ˜¯IDFçš„ä¸è¶³ã€‚ é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯TF-IDFç”¨æ¥åšä¿¡æ¯æ£€ç´¢å’Œæ•°æ®æŒ–æ˜ï¼Œä¸ºäº†è·å–æ›´ç²¾å‡†çš„æ•ˆæœï¼Œæˆ‘ä»¬å®æ„¿å¿½ç•¥è¿™æ ·ä¸è¶³æ¥æ¢å–æ›´åŠ ç†æƒ³çš„æ•ˆæœï¼ˆä¹Ÿå°±æ˜¯TF-IDFè®¡ç®—å‡ºæ›´å¤§çš„æƒå€¼ï¼‰ã€‚ï¼ˆè¿™é‡Œæˆ‘çš„ç†è§£æ˜¯è¿™æ ·çš„ï¼Œå¦‚æœæœ‰äººæœ‰æ›´å¥½çš„è§£é‡Šï¼Œæ¬¢è¿ä¸æˆ‘è¿›è¡Œè®¨è®ºï¼Œé‚®ç®±ï¼šwell@weaf.topï¼‰ é‚£ä¹ˆæ¥ä¸‹æ¥å°±è¯¥ç»™å‡ºIDFçš„è®¡ç®—å…¬å¼äº†ï¼š \\(idf(t,D) = log(\\frac{N}{\\lvert {d \\in D, t \\in d}\\rvert})\\) IDFå…¬å¼è§£è¯»ï¼š |D|ï¼šè¯­æ–™åº“ä¸­æ–‡ä»¶çš„æ€»æ•° åˆ†å­ä¸ºåŒ…å«è¯¥è¯æ¡tçš„æ–‡ä»¶æ•°ç›®ï¼Œå¦‚æœè¯¥è¯æ¡ä¸åœ¨è¯­æ–™åº“ä¸­ï¼Œå°±ä¼šå¯¼è‡´åˆ†æ¯ä¸ºé›¶ï¼Œå› æ­¤ä¸€èˆ¬ä½¿ç”¨1ã€‚ é‚£å°±æ¥ç€æˆ‘ä»¬ä¸Šè¿°ä»£ç ï¼Œè¿ç”¨TF-IDFï¼ŒæŠŠå¯¹åº”çš„çŸ©é˜µçš„å•çº¯è®¡æ•°è½¬æ¢æˆæƒå€¼è®¡ç®—å§ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445Â·Â·Â·def get_all_vector(file_path): names = [ os.path.join(file_path,f) for f in os.listdir(file_path) ] posts = [ open(name).read() for name in names] docs = [] word_set = set() for post in posts: doc = RmStopWords(post) docs.append(doc) word_set |= set(doc) word_set = list(word_set) docs_vsm = [] for word in word_set[:30]: print(word) for doc in docs: temp_vector = [] for word in word_set: temp_vector.append(doc.count(word) * 1.0) docs_vsm.append(temp_vector) docs_matrix = np.array(docs_vsm) #return docs_matrix column_sum = [ float(len(np.nonzero(docs_matrix[:,i])[0])) for i in range(docs_matrix.shape[1]) ] column_sum = np.array(column_sum) column_sum = docs_matrix.shape[0] / column_sum idf = np.log(column_sum) idf = np.diag(idf) i = 0 for doc_v in docs_matrix: if doc_v.sum() == 0: docs_matrix[i] = docs_matrix[i]/1 else: docs_matrix[i] = docs_matrix[i] / (doc_v.sum()) i+=1 tfidf = np.dot(docs_matrix,idf) return names,tfidftxt3 = get_all_vector(&apos;txt1&apos;)print(txt3) ç»“æœï¼š æœ¬æ¬¡çš„å­¦ä¹ ä¼šç”¨åˆ°å¾ˆå¤šnumpyçš„çŸ¥è¯†ï¼Œè¯·å¤§å®¶è‡ªè¡ŒæŸ¥é˜…ã€‚å¦‚æœ‰å…´è¶£ï¼Œè¯·æ€è€ƒä¸ºä»€ä¹ˆåœ¨æ–°çš„æƒå€¼çŸ©é˜µä¸­â€œæ¥åˆ°â€ä¸€è¯çš„æƒé‡å˜æˆäº†0ã€‚æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»~","categories":[{"name":"æ–‡æœ¬èšç±»","slug":"æ–‡æœ¬èšç±»","permalink":"http://weafteam.github.io/categories/æ–‡æœ¬èšç±»/"}],"tags":[{"name":"æ–‡æœ¬èšç±»","slug":"æ–‡æœ¬èšç±»","permalink":"http://weafteam.github.io/tags/æ–‡æœ¬èšç±»/"}]},{"title":"ä¿®æ”¹pipå…¨å±€é•œåƒ","slug":"2018-03-26/alterM","date":"2018-03-27T12:29:36.000Z","updated":"2018-05-29T01:27:49.802Z","comments":true,"path":"posts/233074e6/","link":"","permalink":"http://weafteam.github.io/posts/233074e6/","excerpt":"","text":"ä¿®æ”¹pipå…¨å±€é•œåƒ ç¬¬ä¸€æ¬¡æˆ‘ä»¬åœ¨windowsä¸Šé¢å®‰è£…äº†Anacondaï¼Œåœ¨ä½¿ç”¨pipå®‰è£…Tensorflowä¸­é€Ÿåº¦è¿‡æ…¢ï¼Œæ‰€ä»¥æˆ‘ä¸ºå¤§å®¶ä»‹ç»ä¸€ä¸­ä¿®æ”¹å…¨å±€pipæºçš„æ–¹æ³•ï¼ˆè¿™æ ·åœ¨ä½¿ç”¨pipä¸‹è½½ä¾èµ–åº“çš„æ—¶å€™å°±ä¼šå¿«ä¸€äº›ï¼‰ï¼š æ‰“å¼€ç”¨æˆ·ä¸»ç›®å½•ï¼šæˆ‘çš„æ˜¯C:\\Users\\milittleã€‚ åœ¨é‡Œé¢æ–°å»ºpipæ–‡ä»¶å¤¹ï¼Œåœ¨pipæ–‡ä»¶å¤¹ä¸­å»ºç«‹pip.iniæ–‡ä»¶ã€‚ åœ¨pip.iniæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä½¿ç”¨çš„è±†ç“£æºï¼š 123[global]timeout = 6000index-url = https://pypi.douban.com/simple æœ€åçš„ç›®å½•ç»“æ„å°±æ˜¯ï¼šC:\\Users\\milittle\\pip\\pip.ini","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"å¦‚ä½•ç†è§£æè¿°ç¬¦","slug":"2018-03-19/how-to-understand-descriptor","date":"2018-03-25T15:52:32.000Z","updated":"2018-08-07T08:56:41.613Z","comments":true,"path":"posts/5dd0238f/","link":"","permalink":"http://weafteam.github.io/posts/5dd0238f/","excerpt":"","text":"å‰è¨€ ä¸Šç¯‡æ–‡ç« ä¸­æŒ–äº† property å’Œæè¿°ç¬¦çš„å‘ï¼Œè¿™ç¯‡å°±æŠŠå®ƒå¡«ä¸Šå¥½äº†_(:Ğ·)âˆ )_ property æ˜¯ç”¨æè¿°ç¬¦å®ç°çš„ï¼Œæ‰€ä»¥å…ˆè¯´è¯´ propertyã€‚ property property æœ¬èº«æ˜¯ä¸€ä¸ªå®ç°äº†æè¿°ç¬¦åè®®çš„ç±»ï¼Œåœ¨ä¸æ”¹å˜ç±»æ¥å£çš„æƒ…å†µä¸‹ï¼Œæä¾›äº†ä¸€ç»„å¯¹å®ä¾‹å±æ€§çš„è¯»å–ã€å†™å…¥å’Œåˆ é™¤æ“ä½œã€‚ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªé“¶è¡Œè´¦æˆ·çš„æŠ½è±¡ï¼Œå¾ˆå®¹æ˜“å®ç°ï¼š 12345class Account: def __init__(self, name, balance): self.name = name self.balance = balance é“¶è¡Œè´¦æˆ·æœ€å¸¸è§çš„æ“ä½œå°±æ˜¯å­˜æ¬¾å’Œå–æ¬¾äº†ï¼š 1234567891011121314In [1]: account = Account('zhang', 100) # åˆ›å»ºä¸€ä¸ªæœ‰ 100 å—å­˜æ¬¾çš„è´¦æˆ·In [2]: account.balanceOut[2]: 100In [3]: account.balance -= 90 # å– 90 å—In [4]: account.balance # è¿˜å‰© 10 å—Out[4]: 10In [5]: account.balance += 30 # å­˜ 30 å—In [6]: account.balance # ç°åœ¨æœ‰ 40 å—Out[6]: 40 ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼š 123456...In [7]: account.balance -= 50 # å†å– 50 å—In [8]: account.balance # å­˜æ¬¾å˜æˆäº†è´Ÿæ•°ï¼Out[8]: -10 å½“ç„¶è¿™ç§æ“ä½œæ˜¯ä¸è¯¥è¢«å…è®¸çš„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ balance çš„å†™å…¥åšé™åˆ¶ã€‚Jawa ä¹‹ç±»çš„è¯­è¨€ä¼šåˆ›å»ºä¸€ç»„ getterã€setter æ–¹æ³•æ¥ç®¡ç†å±æ€§ï¼Œä½†æ˜¯è¿™å¹¶ä¸ Pythonï¼Œä¹Ÿå¯¹ç°æœ‰çš„ä»£ç ä¸å‹å¥½ã€‚æ­£ç¡®çš„æ–¹å¼æ˜¯ä½¿ç”¨ propertyã€‚ 12345678910111213141516class Account: def __init__(self, name, balance): self.name = name self.balance = balance @property def balance(self): return self._balance @balance.setter def balance(self, value): if value &lt; 0: raise ValueError('balance must greater than 0.') else: self._balance = value ç°åœ¨ balance è¢«ç¦æ­¢è®¾ä¸ºå°äº 0 çš„æ•°ï¼š 123456789101112131415161718192021In [1]: account = Account('zhang', 100)In [2]: account.balanceOut[2]: 100In [3]: account.balance += 40In [4]: account.balance -= 200---------------------------------------------------------------------------ValueError Traceback (most recent call last)...ValueError: balance must greater than 0.In [5]: account.balanceOut[5]: 140In [6]: account = Account('zhang', -1) # åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿä¸è¡Œï¼---------------------------------------------------------------------------ValueError Traceback (most recent call last)...ValueError: balance must greater than 0. å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨ balance çš„æ–¹å¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å¯¹å€¼çš„é™åˆ¶å·²ç»ç”Ÿæ•ˆäº†ã€‚ property è¿˜æœ‰ä¸€ä¸ª deleter è£…é¥°å™¨ï¼Œå¤„ç†åº”ç”¨äºå±æ€§çš„ delï¼›å½“ç„¶ï¼Œdel æœ¬èº«ç”¨çš„ä¹Ÿä¸å¤šï¼Œå¤§å¤šæ•°æ—¶å€™æŠŠé”€æ¯æ“ä½œäº¤ç»™ Python å°±å¯ä»¥äº†ã€‚ä¸è¿‡å¦‚æœæ¶‰åŠåˆ°å¤æ‚å¯¹è±¡çš„å¼•ç”¨ï¼Œè¦åšåˆ° RAIIï¼ˆè¯¯ï¼Œè¿˜æ˜¯è¦æ‰‹åŠ¨å®ç°çš„ã€‚ property æ˜¯ç±» property æœ¬èº«æ˜¯ç”¨ C å®ç°çš„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªçº¯ Python çš„å®ç°ã€‚æ­£å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªç±»ï¼Œæ„é€ æ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š 123class property(object): def __init__(self, fget=None, fset=None, fdel=None, doc=None): pass ç†Ÿæ‚‰ä¸€ç‚¹è£…é¥°å™¨ç”¨æ³•çš„è¯å°±å¯ä»¥çœ‹å‡ºä¸Šé¢çš„ 123456class Account: ... @property def balance(self): pass å®é™…ä¸Šå°±æ˜¯ 1234567class Account: ... def get_balance(self): pass balance = property(fget=get_balance) å¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œä¸‹ä¸€ç¯‡å°±è®²è£…é¥°å™¨å¥½äº†ï¼ˆè¯¯ property çš„å®ä¾‹æ˜¯ç±»å±æ€§ ä¸Šé¢çš„ä»£ç æ®µåŒæ—¶å±•ç¤ºäº†è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šproperty çš„å®ä¾‹æ˜¯ç±»å±æ€§ã€‚è¿™å°±æ¶‰åŠåˆ°äº†å±æ€§æŸ¥æ‰¾é¡ºåºçš„é—®é¢˜ï¼Œç®€å•è¯•ä¸€ä¸‹ï¼š 123456class Foo: data = 'data!' @property def bar(self): return 'bar!' 123456789101112In [1]: f = Foo()In [2]: f.dataOut[2]: 'data!'In [3]: f.data = 'f.data!'In [4]: f.dataOut[4]: 'f.data!'In [5]: Foo.dataOut[5]: 'data!' å®ä¾‹å±æ€§è¦†ç›–äº†ç±»å±æ€§ï¼Œç¬¦åˆç›´è§‰ã€‚é‚£ä¹ˆå¯¹ property çš„å®ä¾‹æ¥è¯´å‘¢ï¼Ÿ 12345678In [6]: f.barOut[6]: 'bar!'In [7]: f.bar = 'bar'---------------------------------------------------------------------------AttributeError Traceback (most recent call last)...AttributeError: can't set attribute å°è¯•ç»™ bar èµ‹å€¼ï¼Œå¤±è´¥äº†ï¼Œä¹Ÿç¬¦åˆ property çš„å·¥ä½œæ–¹å¼ï¼šæ‰§è¡Œèµ‹å€¼æ—¶ï¼Œå¦‚æœæ²¡æœ‰ setter æ–¹æ³•å°±æŠ›å‡ºå¼‚å¸¸ã€‚é‚£ä¹ˆç›´æ¥ä¿®æ”¹ f.__dict__ å‘¢ï¼Ÿ 1234In [8]: f.__dict__['bar'] = 'bar'In [9]: f.barOut[9]: 'bar!' ä¹Ÿä¸è¡Œï¼Œproperty çš„å®ä¾‹å®Œå…¨è¦†ç›–äº†å®ä¾‹å±æ€§ã€‚ä½†æ˜¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±»å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š 123456789101112In [10]: Foo.barOut[10]: &lt;property at 0x29c44800408&gt;In [11]: Foo.bar = 'bar'In [12]: f.barOut[12]: 'bar'In [13]: f.bar = 'ba'In [14]: f.barOut[14]: 'ba' å¯¹ç±»å±æ€§çš„è¦†ç›–ä½¿ bar ä¸å†æ˜¯ä¸€ä¸ª property çš„å®ä¾‹ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸ä¼šè¦†ç›–åç»­çš„èµ‹å€¼äº†ã€‚ å½“ç„¶æˆ‘ä»¬ä»ç„¶å¯ä»¥ç”¨ä¸€ä¸ª property çš„å®ä¾‹å†æ¬¡è¦†ç›– Foo.barï¼š 1234In [15]: Foo.bar = property(fget=lambda self: 'bar!')In [16]: f.barOut[16]: 'bar!' æ¢å¤åŸæ ·ã€‚ property çš„å®ä¾‹è¿™ç§å…ˆä»ç±»ä¸­å¼€å§‹å±æ€§æŸ¥æ‰¾çš„æ–¹å¼ï¼Œæ˜¯ä¸€ç±»æè¿°ç¬¦çš„å·¥ä½œæ¨¡å¼ã€‚æ¥ä¸‹æ¥å°±è¯´è¯´æè¿°ç¬¦ã€‚ æè¿°ç¬¦ æè¿°ç¬¦æ˜¯æŒ‡å®ç°äº†æè¿°ç¬¦åè®®çš„ç±»ï¼Œè¿™ä¸ªåè®®åŒ…å«å››ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ __get__ï¼Œ__set__ï¼Œ__delete__ å’Œ Python 3.6 æ–°å¢çš„ __set_name__ã€‚é€šå¸¸ï¼Œåªè¦å®ç°äº† __get__ æˆ– __set__ï¼Œå°±å¯ä»¥è¢«ç§°ä¹‹ä¸ºæè¿°ç¬¦ã€‚åœ¨æŸä¸ªè§’åº¦ä¸Šè¯´ï¼Œæè¿°ç¬¦çš„ä½œç”¨ç›¸å½“äºæŠ½è±¡çš„ propertyï¼Œå¯ä»¥ä¸ºä¸€ç»„å±æ€§æä¾›ç›¸åŒçš„è¯»å–ã€å†™å…¥å’Œåˆ é™¤é€»è¾‘ã€‚æ¥ä¸‹æ¥ï¼Œè¿˜æ˜¯ä»æ•°æ®éªŒè¯çš„ä¾‹å­å¼€å§‹ã€‚ ä¸‹é¢æ˜¯å•†åº—ä¸­ä¸€é¡¹å•†å“çš„æŠ½è±¡ï¼ŒåŒ…å«å•†å“åã€æ•°é‡å’Œå•ä»·ï¼š 12345678class Item: amount = Storage('amount') price = Storage('price') def __init__(self, name, amount, price): self.name = name self.amount = amount self.price = price å…¶ä¸­çš„ amount å’Œ price éƒ½å¿…é¡»å¤§äº 0ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ç»Ÿä¸€çš„æè¿°ç¬¦å®ç°ï¼š 12345678910class Storage: def __init__(self, name): self.name = name def __set__(self, instance, value): if value &gt; 0: instance.__dict__[self.name] = value else: raise ValueError(f'&#123;self.name&#125; must greater than 0.') ç”±äºæˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è¯»å–æ–¹æ³•æœ‰ç‰¹åˆ«çš„éœ€æ±‚ï¼Œæ‰€ä»¥ä¸ç”¨å®ç° __get__ æ–¹æ³•ã€‚ è¯•ä¸€ä¸‹ï¼š 1234567891011In [1]: item = Item('orange', 100, 0)---------------------------------------------------------------------------ValueError Traceback (most recent call last)...ValueError: price must greater than 0.In [2]: item = Item('orange', 0, 100)---------------------------------------------------------------------------ValueError Traceback (most recent call last)...ValueError: amount must greater than 0. å¦‚æœ amount æˆ– price ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸å¤§äº 0ï¼Œéƒ½ä¼šè¢«ç¦æ­¢ã€‚ è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ __set__ çš„ç­¾åä¸­çš„ instanceï¼š 12def __set__(self, instance, value): pass instance æ˜¯ Item çš„å®ä¾‹ã€‚å› ä¸ºæè¿°ç¬¦åº”è¯¥ç®¡ç†å®ä¾‹çš„å±æ€§ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–çš„å‚æ•°æä¾›ç›¸åº”çš„å®ä¾‹ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½è¿™æ ·å†™ï¼š 12def __set__(self, instance, value): self.__dict__[self.name] = value è¿™å®é™…ä¸Šæ˜¯ä¸ºæè¿°ç¬¦å®ä¾‹è®¾ç½®äº†å€¼ï¼Œè€Œæè¿°ç¬¦å®ä¾‹æ˜¯Item ç±»çš„ç±»å±æ€§ï¼Œæ‰€æœ‰çš„ Item å®ä¾‹éƒ½å…±äº«ç›¸åŒçš„æè¿°ç¬¦å®ä¾‹ã€‚ä¿®æ”¹äº†æŸä¸ªæè¿°ç¬¦å®ä¾‹ï¼Œç›¸å½“äºä¿®æ”¹äº†æ‰€æœ‰çš„ Item å®ä¾‹ã€‚ ä¸Šé¢çš„ä¾‹å­æœ‰ä¸ªç¼ºç‚¹ï¼Œåˆå§‹åŒ–æè¿°ç¬¦å®ä¾‹çš„æ—¶å€™éœ€è¦é‡å¤å±æ€§çš„åå­—ã€‚æˆ‘ä»¬å¸Œæœ›å¯ä»¥ç®€å•çš„å†™æˆï¼š 1234class Item: amount = Storage() price = Storage() ... è€Œä¸éœ€è¦åœ¨æè¿°ç¬¦çš„æ„é€ æ–¹æ³•ä¸­é‡å¤å±æ€§åã€‚è¿™å°±æ˜¯ Python 3.6 æ–°å¢çš„ __set_name__ æ–¹æ³•çš„ä½œç”¨ã€‚åªè¦å®ç° __set_name__ æ–¹æ³•ï¼š 12345class Storage: ... def __set_name__(self, owner, name): self.name = name åŒæ ·è§£é‡Šä¸€ä¸‹å‡½æ•°ç­¾åï¼š 12def __set_name__(self, owner, name): pass owner æ˜¯ Item ç±»æœ¬èº«ï¼Œname æ˜¯å¼•ç”¨æè¿°ç¬¦å®ä¾‹çš„å˜é‡çš„åå­—ã€‚ å¦‚æœä½¿ç”¨çš„ Python ç‰ˆæœ¬åœ¨ 3.6 ä»¥ä¸‹å‘¢ï¼Ÿæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šç¬¬ä¸€ä¸ªæ˜¯ç”¨å…ƒç±»æ¥ç®¡Itemç±»çš„åˆ›å»ºè¿‡ç¨‹ï¼Œè¿™ä¸ªä¸åœ¨è¿™ç¯‡æ–‡ç« çš„å†…å®¹ä¹‹å†…ï¼ˆå¯èƒ½åˆæŒ–äº†ä¸€ä¸ªå‘ï¼›ç¬¬äºŒä¸ªå°±æ˜¯ä¸ºæ¯ä¸ªæè¿°ç¬¦å®ä¾‹ç”Ÿæˆä¸å±æ€§åæ— å…³ä½†æ˜¯å”¯ä¸€å­—ç¬¦ä¸²ï¼Œç”¨æ¥ä»£æ›¿å±æ€§åï¼š 1234567891011121314151617class Storage: _counter = 0 def __init__(self): cls = self.__class__ self.name = f'_&#123;cls.__name__&#125;#&#123;cls._counter&#125;' cls._counter += 1 def __get__(self, instance, owner): return getattr(instance, self.name) def __set__(self, instance, value): if value &gt; 0: setattr(instance, self.name, value) else: raise ValueError('must greater than 0.') ç”±äº Item ä¸­çš„å±æ€§åå’Œæˆ‘ä»¬å®é™…ä¿å­˜çš„å±æ€§åä¸åŒï¼Œæ‰€ä»¥éœ€è¦å®ç° __get__ æ–¹æ³•ã€‚ä¸ __set_name__ ç­¾åä¸­çš„ owner å«ä¹‰ç›¸åŒï¼Œ__get__ æ–¹æ³•ç­¾åä¸­çš„ owner ä¹Ÿæ˜¯ Item ç±»æœ¬èº«ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ _Storage#N è¿™æ ·çš„åç§°åœ¨ Item å®ä¾‹ä¸­ä¿å­˜å±æ€§ã€‚å½“ç„¶ï¼Œè¿™æ ·çš„åç§°ä¼šè®©äººæœ‰ç‚¹å›°æƒ‘ï¼Œç‰¹åˆ«æ˜¯ä»¥ç±»å±æ€§è®¿é—®çš„æ—¶å€™ï¼š 12345In [1]: Item.amount---------------------------------------------------------------------------AttributeError Traceback (most recent call last)...AttributeError: 'NoneType' object has no attribute '_Storage#0' ä¸ºäº†é¿å…åœ¨å¦‚æ­¤æ˜æ˜¾çš„åœ°æ–¹æš´éœ²æˆ‘ä»¬çš„å®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å¼‚å¸¸çš„é”™è¯¯æ¶ˆæ¯ï¼Œæˆ–è€…ï¼Œå†…çœæè¿°ç¬¦å®ä¾‹ï¼š 12345def __get__(self, instance, owner): if instance is None: return self else: return getattr(instance, self.name) ä¸¤ç±»æè¿°ç¬¦ ä¸Šè¿°ä¾‹å­ä¸­å¯¹æ•°æ®å±æ€§çš„æ§åˆ¶å’Œç®¡ç†æ˜¯æè¿°ç¬¦çš„å…¸å‹ç”¨é€”ä¹‹ä¸€ã€‚è¿™ç§å®ç°äº† __set__ æ–¹æ³•ï¼Œæ¥ç®¡äº†è®¾ç½®å±æ€§è¡Œä¸ºçš„æè¿°ç¬¦ï¼Œè¢«ç§°ä¸ºè¦†ç›–å‹æè¿°ç¬¦ï¼Œæ²¡æœ‰å®šä¹‰ __set__ æ–¹æ³•çš„æè¿°ç¬¦ï¼Œè¢«ç§°ä¸ºéè¦†ç›–å‹æè¿°ç¬¦ã€‚ç”±äº Python ä¸­å¯¹å®ä¾‹å±æ€§å’Œç±»å±æ€§çš„å¤„ç†æ–¹å¼ä¸åŒï¼Œè¿™ä¸¤ç±»æè¿°ç¬¦ä¹Ÿæœ‰ä¸åŒçš„è¡Œä¸ºã€‚ è¦†ç›–å‹æè¿°ç¬¦ å®ç°äº† __set__ æ–¹æ³•çš„æè¿°ç¬¦å°±æ˜¯è¦†ç›–å‹æè¿°ç¬¦ã€‚è¿™ç±»æè¿°ç¬¦è™½ç„¶æ˜¯ç±»å±æ€§ï¼Œä½†æ˜¯ä¼šè¦†ç›–å®ä¾‹å±æ€§çš„èµ‹å€¼æ“ä½œï¼š 123456789101112class Override: def __get__(self, instance, owner): print('get!') def __set__(self, instance, value): print('set!')class Manager: override = Override() ä¸‹é¢åšä¸€äº›å®éªŒï¼š 123456789101112131415161718In [1]: m = Manager()In [2]: m.overrideget!In [3]: m.override = 1set!In [4]: Manager.overrideget!In [5]: m.__dict__['override'] = 1In [6]: m.__dict__Out[6]: &#123;'override': 1&#125;In [7]: m.overrideget! å¯ä»¥çœ‹å‡ºï¼Œæ— è®ºä»¥å®ä¾‹å±æ€§è¿˜æ˜¯ç±»å±æ€§è®¿é—® overrideï¼Œéƒ½ä¼šè§¦å‘ __get__ æ–¹æ³•ï¼›ä¸ºå®ä¾‹å±æ€§ override èµ‹å€¼ä¼šè§¦å‘ __set__ æ–¹æ³•ï¼›å³ä½¿è·³è¿‡æè¿°ç¬¦ç›´æ¥ä¸º m.__dict__ èµ‹å€¼ï¼Œè¯»å– override çš„æ“ä½œä»ç„¶ä¼šè¢«æè¿°ç¬¦è¦†ç›–ã€‚ æ²¡æœ‰ __get__ æ–¹æ³•çš„è¦†ç›–å‹æè¿°ç¬¦ å¦‚æœåªå®ç°äº† __set__ ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ 123456789class OverrideNoGet: def __set__(self, instance, value): print('set!')class Manager: override_no_get = OverrideNoGet() 123456789101112131415161718192021222324In [1]: m = Manager()In [2]: m.override_no_getOut[2]: &lt;__main__.OverrideNoGet at 0x29c44a97668&gt;In [3]: Manager.override_no_getOut[3]: &lt;__main__.OverrideNoGet at 0x29c44a97668&gt;In [4]: m.override_no_get = 1set!In [5]: m.override_no_getOut[5]: &lt;__main__.OverrideNoGet at 0x29c44a97668&gt;In [6]: m.__dict__['override_no_get'] = 1In [7]: m.override_no_getOut[7]: 1In [8]: m.override_no_get = 2set!In [9]: m.override_no_getOut[9]: 1 å¯ä»¥çœ‹åˆ°ï¼Œæ²¡å®ç° __get__ æ–¹æ³•ï¼Œæ— è®ºä»¥å®ä¾‹å±æ€§è¿˜æ˜¯ç±»å±æ€§è®¿é—® override_no_getï¼Œéƒ½ä¼šè¿”å›æè¿°ç¬¦å®ä¾‹ï¼›è€Œèµ‹å€¼æ“ä½œå¯ä»¥è§¦å‘ __set__ æ–¹æ³•ï¼›ç”±äºæˆ‘ä»¬çš„ __set__ æ–¹æ³•å¹¶æ²¡æœ‰çœŸæ­£ä¿®æ”¹å®ä¾‹å±æ€§ï¼Œæ‰€ä»¥å†æ¬¡è®¿é—® override_no_get ä»ç„¶ä¼šå¾—åˆ°æè¿°ç¬¦å®ä¾‹ï¼›é€šè¿‡ m.__dict__ ä¿®æ”¹å®ä¾‹å±æ€§åï¼Œå®ä¾‹å±æ€§å°±ä¼šè¦†ç›–æè¿°ç¬¦ï¼›ä¸è¿‡åªæœ‰è®¿é—®å®ä¾‹å±æ€§æ—¶æ‰æ˜¯å¦‚æ­¤ï¼Œèµ‹å€¼ä»ç„¶ç”± __set__ å¤„ç†ã€‚ éè¦†ç›–å‹æè¿°ç¬¦ æ²¡æœ‰å®ç° __set__ æ–¹æ³•çš„æè¿°ç¬¦å°±æ˜¯éè¦†ç›–å‹æè¿°ç¬¦ï¼š 123456789class NonOverride: def __get__(self, instance, owner): print('get!')class Manager: non_override = NonOverride() 1234567891011121314151617181920In [1]: m = Manager()In [2]: m.non_overrideget!In [3]: Manager.non_overrideget!In [4]: m.non_override = 1In [5]: m.non_overrideOut[5]: 1In [6]: Manager.non_overrideget!In [7]: del m.non_overrideIn [8]: m.non_overrideget! æ— è®ºè®¿é—®å®ä¾‹å±æ€§è¿˜æ˜¯ç±»å±æ€§ï¼Œéƒ½ä¼šè§¦å‘ __get__ æ–¹æ³•ï¼›ç”±äºæ²¡æœ‰ __set__ æ–¹æ³•ï¼Œå¯¹å±æ€§çš„èµ‹å€¼ä¸ä¼šè¢«å¹²æ¶‰ï¼›å¯¹å±æ€§å¤åˆ¶ä¹‹åï¼Œå®ä¾‹å±æ€§å°±ä¼šè¦†ç›–åŒåçš„æè¿°ç¬¦ï¼Œä½†æ˜¯è®¿é—®ç±»å±æ€§ä»ç„¶å¯ä»¥è§¦å‘ __get__ æ–¹æ³•ï¼›å¦‚æœæŠŠ non_override ä»å®ä¾‹ä¸­åˆ é™¤ï¼Œè®¿é—® non_override çš„æ“ä½œåˆä¼šäº¤ç»™ __get__ã€‚ å½“ç„¶ï¼Œæè¿°ç¬¦éƒ½æ˜¯å®šä¹‰åœ¨ç±»ä¸Šçš„ï¼Œå¦‚æœå¯¹åŒåçš„ç±»å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œå°±ä¼šå®Œå…¨æ›¿æ¢æ‰æè¿°ç¬¦ã€‚è¿™é‡Œè¡¨ç°å‡ºè¯»ã€å†™å±æ€§æ—¶çš„ä¸å¯¹ç­‰ï¼šå¯¹ç±»å±æ€§çš„è¯»æ“ä½œå¯ä»¥è¢« __get__ å¤„ç†ï¼Œä½†æ˜¯å†™æ“ä½œä¸ä¼šã€‚å½“ç„¶ï¼Œäº†è§£ä¸€äº› Python çš„è¯å°±ä¼šçŸ¥é“è¿˜å­˜åœ¨ç€å¦ä¸€ç§ä¸å¯¹ç­‰ï¼šè¯»å–å®ä¾‹å±æ€§æ—¶ï¼Œä¼šè¿”å›å®ä¾‹å±æ€§ï¼Œå¦‚æœå®ä¾‹å±æ€§ä¸å­˜åœ¨ï¼Œä¼šè¿”å›ç±»å±æ€§ï¼›ä½†æ˜¯ä¸ºå®ä¾‹å±æ€§èµ‹å€¼æ—¶ï¼Œå¦‚æœå®ä¾‹å±æ€§ä¸å­˜åœ¨ï¼Œä¼šåœ¨å®ä¾‹ä¸­åˆ›å»ºå±æ€§ï¼Œä¸ä¼šå½±å“åˆ°ç±»å±æ€§ã€‚ ç»“è¯­ æè¿°ç¬¦å……æ–¥åœ¨ Python åº•å±‚ï¼ˆä¸¾ä¸ªä¾‹å­ï¼šPython ä¸­çš„æ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿï¼‰ä¸å„ç§æ¡†æ¶ä¸­ï¼Œç†è§£æè¿°ç¬¦æ˜¯ä½“ä¼š Python ä¸–ç•Œå·¥ä½œåŸç†å’Œè®¾è®¡ç¾å­¦çš„é‡è¦æ–¹å¼ã€‚","categories":[],"tags":[]},{"title":"TensorFlow åˆä½“éªŒ ï¼ˆFashion-mnistï¼‰","slug":"2018-03-19/TenosrFlowå®ç°fashion mnistè¯†åˆ«","date":"2018-03-25T13:18:37.000Z","updated":"2018-05-29T01:27:49.784Z","comments":true,"path":"posts/b0821049/","link":"","permalink":"http://weafteam.github.io/posts/b0821049/","excerpt":"","text":"TensorFlow åˆä½“éªŒï¼ˆFashion-mnistï¼‰ æ¥ç€ä¸Šä¸€è®²çš„å†…å®¹ï¼Œæƒ³å¿…å¤§å®¶å·²ç»é€šè¿‡æˆ‘çš„æ•™ç¨‹å®‰è£…å¥½äº†TensorFlowäº†å§ï¼Œé‚£æˆ‘ä»¬è¿™èŠ‚è¯¾é€šè¿‡å®‰è£…ç®€å•çš„è·¨å¹³å°çš„é›†æˆå¼€å‘ç¯å¢ƒSpyderï¼Œåœ¨è¿™ä¸ªé›†æˆå¼€å‘ç¯å¢ƒä¸Šé¢å®ç°ä¸€äº›pythonç¨‹åºã€‚å…·ä½“å®‰è£…è¿‡ç¨‹è§å¦‚ä¸‹é˜è¿°ï¼š é¦–å…ˆåœ¨åº”ç”¨ç¨‹åºé‡Œé¢æ‰¾åˆ°Anacondaåº”ç”¨ç¨‹åºï¼Œæ‰“å¼€é‡Œé¢çš„Anaconda Navigatorï¼Œç„¶åæ‰“å¼€ä»¥åï¼Œé€‰ä¸­æˆ‘ä»¬ä¸Šæ¬¡å»ºç«‹å¥½çš„ç¯å¢ƒtensorflowã€‚ é€‰ä¸­tensorflowè¿™ä¸ªç¯å¢ƒå˜é‡ä»¥åï¼Œçœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ªé›†æˆå¼€å‘ç¯å¢ƒå«spyderï¼Œè¿™ä¸ªå·¥å…·å°±æ˜¯ä»Šå¤©æˆ‘ä»¬è¦å®‰è£…çš„ï¼Œæˆ‘çš„å·²ç»å®‰è£…å¥½äº†ï¼Œæ‰€ä»¥æ˜¯Launchï¼Œä½ ä»¬çš„æ²¡æœ‰å®‰è£…å¥½ï¼Œæ‰€ä»¥æ˜¯installçŠ¶æ€ï¼Œç‚¹è§£å®‰è£…å°±å¥½ã€‚ï¼ˆè¿™ä¸ªåœ°æ–¹ä¹Ÿå¯èƒ½éœ€è¦ç¿»å¢™ï¼‰ã€‚ è¿™ä¸ªå®‰è£…å¥½ä»¥åï¼Œä½ å°±ä¼šåœ¨åº”ç”¨æ–‡ä»¶å¤¹é‡Œé¢å‡ºç°ä¸€ä¸ªSpyder(tensorflow)è¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œä»¥åä½ å°±ä»åº”ç”¨æ–‡ä»¶å¤¹å¯åŠ¨å°±å¥½ã€‚ é‚£ä¹ˆå¯åŠ¨ä»¥åï¼šæˆ‘ä¹Ÿæ˜¯å¯åŠ¨äº†ï¼Œå‡ºç°äº†ä»¥ä¸‹çš„æƒ…å†µï¼šä¸æ…Œï¼Œæ…¢æ…¢æ¥ã€‚ çœ‹åˆ°ä¸Šé¢çš„é”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯æç¤ºæ˜¯å› ä¸ºæ²¡æœ‰å®‰è£…jediè¿™ä¸ªä¾èµ–åº“ï¼Œè€Œä¸”è¦æ±‚ç‰ˆæœ¬è¦å¤§äº0.9.0ã€‚é‚£æˆ‘ä»¬æ¥ä¸‹æ¥è§£å†³ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚ å°æ’æ›²ï¼Œä¸€ä¸‹å°±å¯ä»¥è§£å†³ï¼Œå…·ä½“æ“ä½œæ­¥éª¤: è¿˜æ˜¯æ‰“å¼€ä¸Šæ¬¡é‚£ä¸ªAnacondaPromptçš„å‘½ä»¤è¡Œ è¿›å»ä»¥åï¼Œæ‰§è¡Œactivate tensorflow ç›¸å½“äºä½ è¦åœ¨è¿™ä¸ªç¯å¢ƒä¸‹é¢ç»™è¿™ä¸ªspyderå®‰è£…è¿™ä¸ªä¾èµ– è¿›å»ä»¥åï¼Œæ‰§è¡Œpip install jedi==0.9.0 å°±å¯ä»¥äº†ï¼Œç„¶åé‡å¯spyderï¼ˆå¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªç¯å¢ƒé‡Œé¢è¾“å…¥spyderå‘½ä»¤å°±å¯ä»¥å®ç°spyderçš„å¯åŠ¨ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨åº”ç”¨æ–‡ä»¶å¤¹é‡Œé¢å¯åŠ¨ï¼Œæ€§è´¨æ˜¯ä¸€æ ·çš„ï¼‰ ä¸å‡ºä»€ä¹ˆæ„å¤–çš„è¯ï¼Œspyderä½¿ç”¨å°±æ²¡æœ‰é—®é¢˜äº†ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥å‘é‚®ä»¶ç»™æˆ‘ï¼ï¼ï¼ è§£å†³äº†ä¸Šé¢çš„å°æ’æ›²ä»¥åï¼Œæˆ‘ä»¬åœ¨spyderä¸­è¾“å…¥ä»¥ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•ã€‚ 123456789101112import tensorflow as tfsess = tf.Session()init = tf.global_variables_initializer() # æ­¤å¤„çš„initæ˜¯å…¨å±€å˜é‡åˆå§‹åŒ–å™¨ï¼Œ# TensorFlowçš„sessionå¿…é¡»æ‰§è¡Œè¿™ä¸ªåˆå§‹åŒ–å™¨æ‰èƒ½æ‰§è¡Œå‰é¢å»ºç«‹å¥½çš„å›¾ï¼Œ# æ‰€ä»¥ï¼Œè¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œåç»­ä¹Ÿä¼šå¼ºè°ƒ#ï¼ˆä¹Ÿå°±æ˜¯åç»­å†ç½‘ç»œä¸­å»ºç«‹å˜é‡å°±æ˜¯é€šè¿‡é‚£ä¸ªåˆå§‹åŒ–å™¨æ¥è¿›è¡Œåˆå§‹åŒ–å·¥ä½œçš„ï¼‰# å…¶å®åœ¨æ²¡æœ‰å˜é‡çš„æ—¶å€™ï¼Œè¿™ä¸ªåˆå§‹åŒ–å™¨æ˜¯ä¸éœ€è¦çš„# ä½†æ˜¯ä¸ºäº†è®©å¤§å®¶å½¢æˆä¹ æƒ¯ï¼Œè¿˜æ˜¯å†™ä¸Šsess.run(init)hello = tf.constant('hello world')print(sess.run(hello)) ä¸Šå›¾ä¸­å·¦é¢æ˜¯ä»£ç ä¹¦å†™åŒºåŸŸï¼Œå³é¢ä¸ŠåŠéƒ¨åˆ†æ˜¯å˜é‡æŸ¥çœ‹åŒºåŸŸï¼Œè¿˜æœ‰æ–‡ä»¶å¤¹åŒºåŸŸå¯ä»¥åˆ‡æ¢ï¼Œå³é¢ä¸‹åŠéƒ¨åˆ†æ˜¯æ‰§è¡ŒconsoleåŒºåŸŸï¼Œæˆ‘è¾“å…¥ä¸Šé¢çš„ä»£ç ï¼Œæ‰§è¡Œä»¥åconsoleåŒºåŸŸæ‰“å‡ºhello worldå­—ç¬¦ä¸²ã€‚ ä»ä¸Šé¢çš„ä¸€äº›ç®€å•çš„æµ‹è¯•ä»¥åï¼Œæˆ‘ä»¬è¿›å…¥ä»Šå¤©çš„ä¸»é¢˜ï¼Œfashion-ministçš„è¯†åˆ«ï¼Œfashion-ministæ˜¯ä¸€ä¸ªæœè£…è¯†åˆ«çš„ä¸€ä¸ªæ•°æ®é›†ï¼Œåœ¨è¿™ä¸ªæ•°æ®é›†ä¹‹å‰æœ‰ä¸€ä¸ªmnistæ‰‹å†™ä½“è¯†åˆ«æ•°æ®é›†ï¼Œè¿™ä¸ªæ‰‹å†™æ•°æ®é›†å¯¹åº”æˆ‘ä»¬æ‰‹å†™çš„åä¸ªæ•°å­—ï¼Œç„¶åé€šè¿‡è®¾è®¡ç½‘ç»œæ¥è¯†åˆ«æ‰‹å†™ä½“ã€‚ä½†æ˜¯ä»Šå¤©æˆ‘ä»¬ä¸åšæ‰‹å†™ä½“è¯†åˆ«ï¼Œç›´æ¥æ¥åšfashion-ministè¯†åˆ«ã€‚ é—²è¯å°‘è¯´ï¼Œä¸Šä»£ç ï¼Œè¾¹å†™è¾¹è¯´ã€‚ é¦–å…ˆç›®æ ‡æ˜¯å®ç°è¡£æœç§ç±»çš„è¯†åˆ«ã€‚ æ•°æ®å¯ä»¥åœ¨ Zalando_Fashion_MNIST_repositoryè¿™ä¸ªGithubä»“åº“è·å–ã€‚ æ•°æ®åˆ†ä¸º60000è®­ç»ƒæ•°æ®å’Œ10000æµ‹è¯•æ•°æ®ï¼Œå›¾ç‰‡éƒ½æ˜¯ç°åº¦å›¾ç‰‡ï¼Œå¤§å°ä¸º28 X 28ï¼Œæ€»å…±ä¹Ÿæ˜¯ç”±10ç±»ç»„æˆã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305# -*- coding: utf-8 -*-\"\"\"Created on Sun Mar 25 15:16:23 2018@author: milittle\"\"\"# å¯¼å…¥ä¸€äº›å¿…è¦çš„åº“import numpy as np # æ•°å­¦è®¡ç®—åº“import matplotlib.pyplot as plt # ç”»å›¾çš„ä¸€ä¸ªåº“import tensorflow as tf # TensorFlowçš„åº“from tensorflow.examples.tutorials.mnist import input_datafashion_mnist = input_data.read_data_sets('input/data', one_hot = True)# å®šä¹‰ä¸€ä¸ªæœè£…å¯¹åº”è¡¨label_dict = &#123; 0: 'T-shirt/top', 1: 'Trouser', 2: 'Pullover', 3: 'Dress', 4: 'Coat', 5: 'Sandal', 6: 'Shirt', 7: 'Sneaker', 8: 'Bag', 9: 'Ankle boot'&#125;# è·å–éšæœºçš„æ•°æ®å’Œå®ƒçš„labelsample_1 = fashion_mnist.train.images[47].reshape(28,28)sample_label_1 = np.where(fashion_mnist.train.labels[47] == 1)[0][0]sample_2 = fashion_mnist.train.images[23].reshape(28,28)sample_label_2 = np.where(fashion_mnist.train.labels[23] == 1)[0][0]# ç”¨matplotç”»å‡ºè¿™ä¸ªimageå’Œlabelprint(\"y = &#123;label_index&#125; (&#123;label&#125;)\".format(label_index=sample_label_1, label=label_dict[sample_label_1]))plt.imshow(sample_1, cmap='Greys')plt.show()print(\"y = &#123;label_index&#125; (&#123;label&#125;)\".format(label_index=sample_label_2, label=label_dict[sample_label_2]))plt.imshow(sample_2, cmap='Greys')plt.show()# æ¥ä¸‹æ¥å°±æ˜¯è®¾è®¡ç½‘ç»œå‚æ•°n_hidden_1 = 128 # ç¬¬ä¸€ä¸ªéšè—å±‚çš„å•å…ƒä¸ªæ•°n_hidden_2 = 128 # ç¬¬äºŒä¸ªéšè—å±‚çš„å•å…ƒä¸ªæ•°n_input = 784 # fashion mnistè¾“å…¥å›¾ç‰‡çš„ç»´åº¦ï¼ˆå•å…ƒä¸ªæ•°ï¼‰ (å›¾ç‰‡å¤§å°: 28*28)n_classes = 10 # fashion mnistçš„ç§ç±»æ•°ç›® (0-9 æ•°å­—)# åˆ›å»º placeholdersdef create_placeholders(n_x, n_y): \"\"\" ä¸ºsessåˆ›å»ºä¸€ä¸ªå ä½å¯¹è±¡ã€‚ å‚æ•°: n_x -- å‘é‡, å›¾ç‰‡å¤§å° (28*28 = 784) n_y -- å‘é‡, ç§ç±»æ•°ç›® (ä» 0 åˆ° 9, æ‰€ä»¥æ˜¯ -&gt; 10ç§) è¿”å›å‚æ•°: X -- ä¸ºè¾“å…¥å›¾ç‰‡å¤§å°çš„placeholder shapeæ˜¯[784, None] Y -- ä¸ºè¾“å‡ºç§ç±»å¤§å°çš„placeholder shapeæ˜¯[10, None] Noneåœ¨è¿™é‡Œè¡¨ç¤ºä»¥åè¾“å…¥çš„æ•°æ®å¯ä»¥ä»»æ„å¤šå°‘ \"\"\" X = tf.placeholder(tf.float32, [n_x, None], name=\"X\") Y = tf.placeholder(tf.float32, [n_y, None], name=\"Y\") return X, Y# æµ‹è¯•ä¸Šé¢çš„create_placeholders()X, Y = create_placeholders(n_input, n_classes)print(\"Shape of X: &#123;shape&#125;\".format(shape=X.shape))print(\"Shape of Y: &#123;shape&#125;\".format(shape=Y.shape))# å®šä¹‰åˆå§‹åŒ–å‚æ•°å‚æ•°def initialize_parameters(): \"\"\" å‚æ•°åˆå§‹åŒ–ï¼Œä¸‹é¢æ˜¯æ¯ä¸ªå‚æ•°çš„shapeï¼Œæ€»å…±æœ‰ä¸‰å±‚ W1 : [n_hidden_1, n_input] b1 : [n_hidden_1, 1] W2 : [n_hidden_2, n_hidden_1] b2 : [n_hidden_2, 1] W3 : [n_classes, n_hidden_2] b3 : [n_classes, 1] è¿”å›: åŒ…å«æ‰€æœ‰æƒé‡å’Œåç½®é¡¹çš„dic \"\"\" # è®¾ç½®éšæœºæ•°ç§å­ tf.set_random_seed(42) # ä¸ºæ¯ä¸€å±‚çš„æƒé‡å’Œåç½®é¡¹è¿›è¡Œåˆå§‹åŒ–å·¥ä½œ W1 = tf.get_variable(\"W1\", [n_hidden_1, n_input], initializer = tf.contrib.layers.xavier_initializer(seed = 42)) b1 = tf.get_variable(\"b1\", [n_hidden_1, 1], initializer = tf.zeros_initializer()) W2 = tf.get_variable(\"W2\", [n_hidden_2, n_hidden_1], initializer = tf.contrib.layers.xavier_initializer(seed = 42)) b2 = tf.get_variable(\"b2\", [n_hidden_2, 1], initializer = tf.zeros_initializer()) W3 = tf.get_variable(\"W3\", [n_classes, n_hidden_2], initializer=tf.contrib.layers.xavier_initializer(seed = 42)) b3 = tf.get_variable(\"b3\", [n_classes, 1], initializer = tf.zeros_initializer()) # å°†å‚æ•°å­˜å‚¨åœ¨ä¸€ä¸ªdictå¯¹è±¡é‡Œé¢è¿”å›å» parameters = &#123; \"W1\": W1, \"b1\": b1, \"W2\": W2, \"b2\": b2, \"W3\": W3, \"b3\": b3 &#125; return parameters# æµ‹è¯•åˆå§‹åŒ–å‚æ•°tf.reset_default_graph()with tf.Session() as sess: parameters = initialize_parameters() print(\"W1 = &#123;w1&#125;\".format(w1=parameters[\"W1\"])) print(\"b1 = &#123;b1&#125;\".format(b1=parameters[\"b1\"])) print(\"W2 = &#123;w2&#125;\".format(w2=parameters[\"W2\"])) print(\"b2 = &#123;b2&#125;\".format(b2=parameters[\"b2\"])) # å‰å‘ä¼ æ’­ç®—æ³•ï¼ˆå°±æ˜¯ç¥ç»ç½‘ç»œçš„å‰å‘æ­¥éª¤ï¼‰def forward_propagation(X, parameters): \"\"\" å®ç°å‰å‘ä¼ æ’­çš„æ¨¡å‹ LINEAR -&gt; RELU -&gt; LINEAR -&gt; RELU -&gt; LINEAR -&gt; SOFTMAX ä¸Šé¢çš„æ˜¾ç¤ºå°±æ˜¯ä¸‰ä¸ªçº¿æ€§å±‚ï¼Œæ¯ä¸€å±‚ç»“æŸä»¥åï¼Œå®ç°reluçš„ä½œç”¨ï¼Œå®ç°éçº¿æ€§åŠŸèƒ½ï¼Œæœ€åä¸‰å±‚ä»¥åç”¨softmaxå®ç°åˆ†ç±» å‚æ•°: X -- è¾“å…¥è®­ç»ƒæ•°æ®çš„ä¸ªæ•°[784, n] è¿™é‡Œçš„nä»£è¡¨å¯ä»¥ä¸€æ¬¡è®­ç»ƒå¤šä¸ªæ•°æ® parameters -- åŒ…æ‹¬ä¸Šé¢æ‰€æœ‰çš„å®šä¹‰å‚æ•°ä¸‰ä¸ªç½‘ç»œä¸­çš„æƒé‡Wå’Œåç½®é¡¹B è¿”å›: Z3 -- æœ€åçš„ä¸€ä¸ªçº¿æ€§å•å…ƒè¾“å‡º \"\"\" # ä»å‚æ•°dicté‡Œé¢å–åˆ°æ‰€æœ‰çš„å‚æ•° W1 = parameters['W1'] b1 = parameters['b1'] W2 = parameters['W2'] b2 = parameters['b2'] W3 = parameters['W3'] b3 = parameters['b3'] # å‰å‘ä¼ æ’­è¿‡ç¨‹ Z1 = tf.add(tf.matmul(W1,X), b1) # Z1 = np.dot(W1, X) + b1 A1 = tf.nn.relu(Z1) # A1 = relu(Z1) Z2 = tf.add(tf.matmul(W2,A1), b2) # Z2 = np.dot(W2, a1) + b2 A2 = tf.nn.relu(Z2) # A2 = relu(Z2) Z3 = tf.add(tf.matmul(W3,A2), b3) # Z3 = np.dot(W3,Z2) + b3 return Z3# æµ‹è¯•å‰å‘ä¼ æ’­å–Šå‡ºtf.reset_default_graph()with tf.Session() as sess: X, Y = create_placeholders(n_input, n_classes) parameters = initialize_parameters() Z3 = forward_propagation(X, parameters) print(\"Z3 = &#123;final_Z&#125;\".format(final_Z=Z3))# å®šä¹‰è®¡ç®—æŸå¤±å‡½æ•°# æ˜¯è®¡ç®—lossçš„æ—¶å€™äº†def compute_cost(Z3, Y): \"\"\" è®¡ç®—cost å‚æ•°: Z3 -- å‰å‘ä¼ æ’­çš„æœ€ç»ˆè¾“å‡ºï¼ˆ[10, n]ï¼‰nä¹Ÿæ˜¯ä½ è¾“å…¥çš„è®­ç»ƒæ•°æ®ä¸ªæ•° Y -- è¿”å›: cost - æŸå¤±å‡½æ•° å¼ é‡ï¼ˆTensorï¼‰ \"\"\" # è·å¾—é¢„æµ‹å’Œå‡†ç¡®çš„label logits = tf.transpose(Z3) labels = tf.transpose(Y) # è®¡ç®—æŸå¤± cost = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits = logits, labels = labels)) return cost# æµ‹è¯•è®¡ç®—æŸå¤±å‡½æ•°tf.reset_default_graph()with tf.Session() as sess: X, Y = create_placeholders(n_input, n_classes) parameters = initialize_parameters() Z3 = forward_propagation(X, parameters) cost = compute_cost(Z3, Y) print(\"cost = &#123;cost&#125;\".format(cost=cost))# è¿™ä¸ªå°±æ˜¯å…³é”®äº†ï¼Œå› ä¸ºæ¯ä¸€å±‚çš„å‚æ•°éƒ½æ˜¯é€šè¿‡åå‘ä¼ æ’­æ¥å®ç°æƒé‡å’Œåç½®é¡¹å‚æ•°æ›´æ–°çš„# æ€»ä½“çš„åŸç†å°±æ˜¯ç»è¿‡å‰å‘ä¼ æ’­ï¼Œè®¡ç®—åˆ°æœ€åçš„å±‚ï¼Œåˆ©ç”¨softmaxåŠ äº¤å‰ç†µï¼Œç®—å‡ºç½‘ç»œçš„æŸå¤±å‡½æ•°# ç„¶åå¯¹æŸå¤±å‡½æ•°è¿›è¡Œæ±‚åå¯¼ï¼Œåˆ©ç”¨åå‘ä¼ æ’­ç®—æ³•å®ç°æ¯ä¸€å±‚çš„æƒé‡å’Œåç½®é¡¹çš„æ›´æ–°def model(train, test, learning_rate=0.0001, num_epochs=16, minibatch_size=32, print_cost=True, graph_filename='costs'): \"\"\" å®ç°äº†ä¸€ä¸ªä¸‰å±‚çš„ç½‘ç»œç»“æ„: LINEAR-&gt;RELU-&gt;LINEAR-&gt;RELU-&gt;LINEAR-&gt;SOFTMAX. å‚æ•°: train -- è®­ç»ƒé›† test -- æµ‹è¯•é›† learning_rate -- ä¼˜åŒ–æƒé‡æ—¶å€™æ‰€ç”¨åˆ°çš„å­¦ä¹ ç‡ num_epochs -- è®­ç»ƒç½‘ç»œçš„è½®æ¬¡ minibatch_size -- æ¯ä¸€æ¬¡é€è¿›ç½‘ç»œè®­ç»ƒçš„æ•°æ®ä¸ªæ•°ï¼ˆä¹Ÿå°±æ˜¯å…¶ä»–å‡½æ•°é‡Œé¢é‚£ä¸ªnå‚æ•°ï¼‰ print_cost -- æ¯ä¸€è½®ç»“æŸä»¥åçš„æŸå¤±å‡½æ•° è¿”å›: parameters -- è¢«ç”¨æ¥å­¦ä¹ çš„å‚æ•° \"\"\" # ç¡®ä¿å‚æ•°ä¸è¢«è¦†ç›–é‡å†™ tf.reset_default_graph() tf.set_random_seed(42) seed = 42 # è·å–è¾“å…¥å’Œè¾“å‡ºå¤§å° (n_x, m) = train.images.T.shape n_y = train.labels.T.shape[0] costs = [] # åˆ›å»ºè¾“å…¥è¾“å‡ºæ•°æ®çš„å ä½ç¬¦ X, Y = create_placeholders(n_x, n_y) # åˆå§‹åŒ–å‚æ•° parameters = initialize_parameters() # è¿›è¡Œå‰å‘ä¼ æ’­ Z3 = forward_propagation(X, parameters) # è®¡ç®—æŸå¤±å‡½æ•° cost = compute_cost(Z3, Y) # ä½¿ç”¨AdamOptimizerä¼˜åŒ–å™¨å®ç°åå‘ä¼ æ’­ç®—æ³•ï¼ˆæœ€å°åŒ–costï¼‰ # å…¶å®æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹çš„åå‘æ›´æ–°å‚æ•°çš„è¿‡ç¨‹éƒ½æ˜¯tensorflowç»™åšäº† optimizer = tf.train.AdamOptimizer(learning_rate).minimize(cost) # å˜é‡åˆå§‹åŒ–å™¨ init = tf.global_variables_initializer() # å¼€å§‹tensorflowçš„sess æ¥è®¡ç®—tensorflowæ„å»ºå¥½çš„å›¾ with tf.Session() as sess: # è¿™ä¸ªå°±æ˜¯ä¹‹å‰è¯´è¿‡çš„è¦è¿›è¡Œåˆå§‹åŒ–çš„ sess.run(init) # è®­ç»ƒè½®æ¬¡ for epoch in range(num_epochs): epoch_cost = 0. num_minibatches = int(m / minibatch_size) seed = seed + 1 for i in range(num_minibatches): # è·å–ä¸‹ä¸€ä¸ªbatchçš„è®­ç»ƒæ•°æ®å’Œlabelæ•°æ® minibatch_X, minibatch_Y = train.next_batch(minibatch_size) # æ‰§è¡Œä¼˜åŒ–å™¨ _, minibatch_cost = sess.run([optimizer, cost], feed_dict=&#123;X: minibatch_X.T, Y: minibatch_Y.T&#125;) # æ›´æ–°æ¯ä¸€è½®çš„æŸå¤± epoch_cost += minibatch_cost / num_minibatches # æ‰“å°æ¯ä¸€è½®çš„æŸå¤± if print_cost == True: print(\"Cost after epoch &#123;epoch_num&#125;: &#123;cost&#125;\".format(epoch_num=epoch, cost=epoch_cost)) costs.append(epoch_cost) # ä½¿ç”¨matplotç”»å‡ºæŸå¤±çš„å˜åŒ–æ›²çº¿å›¾ plt.figure(figsize=(16,5)) plt.plot(np.squeeze(costs), color='#2A688B') plt.xlim(0, num_epochs-1) plt.ylabel(\"cost\") plt.xlabel(\"iterations\") plt.title(\"learning rate = &#123;rate&#125;\".format(rate=learning_rate)) plt.savefig(graph_filename, dpi = 300) plt.show() # ä¿å­˜å‚æ•° parameters = sess.run(parameters) print(\"Parameters have been trained!\") # è®¡ç®—é¢„æµ‹å‡†ç‡ correct_prediction = tf.equal(tf.argmax(Z3), tf.argmax(Y)) # è®¡ç®—æµ‹è¯•å‡†ç‡ accuracy = tf.reduce_mean(tf.cast(correct_prediction, \"float\")) print (\"Train Accuracy:\", accuracy.eval(&#123;X: train.images.T, Y: train.labels.T&#125;)) print (\"Test Accuracy:\", accuracy.eval(&#123;X: test.images.T, Y: test.labels.T&#125;)) return parameters# è¦å¼€å§‹è®­ç»ƒæˆ‘ä»¬çš„fashion mnistç½‘ç»œäº†train = fashion_mnist.train # è®­ç»ƒçš„æ•°æ®test = fashion_mnist.test # æµ‹è¯•çš„æ•°æ®parameters = model(train, test, learning_rate = 0.001, num_epochs = 16, graph_filename = 'fashion_mnist_costs') ä¸Šé¢çš„ä»£ç æ˜¯å†™å¥½äº†ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªpythonçš„ä¾èµ–åº“ï¼ˆmatplotlibï¼‰éœ€è¦å®‰è£…ä»¥ä¸‹ï¼ŒåŒæ ·çš„åŠæ³•ï¼Œå°±æ˜¯è¿›å»tensorflowè¿™ä¸ªç¯å¢ƒé‡Œé¢ï¼Œç„¶åæ‰§è¡Œpip install matplotlibå°±å¯ä»¥äº†ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä»tensorflowä¸‹è½½æ•°æ®çš„æ—¶å€™ä¼šå¾ˆæ…¢ã€‚ï¼ˆæˆ‘ä»¬é€‰æ‹©ç›´æ¥ä»ä¸Šé¢ç»™å‡ºä¸‹è½½æ•°æ®é›†çš„githubç½‘å€ï¼Œç›´æ¥ä¸‹è½½ä»¥åï¼Œå°†æ•°æ®æ‹·è´åœ¨ä»£ç æ‰€åœ¨æ–‡ä»¶å¤¹çš„input/data/æ–‡ä»¶å¤¹é‡Œé¢ï¼Œæ€»å…±ç”±å››ä¸ªæ–‡ä»¶ç»„æˆï¼‰åˆ†åˆ«æ˜¯è®­ç»ƒæ•°æ®å›¾ç‰‡ã€è®­ç»ƒæ•°æ®labelå’Œæµ‹è¯•æ•°æ®å›¾ç‰‡ã€æµ‹è¯•æ•°æ®labelã€‚è¿™æ ·å°±å¯ä»¥çœå»ä¸‹è½½æ•°æ®æ—¶å€™æ¼«é•¿çš„ç­‰å¾…ã€‚ ä¸Šé¢å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨TensorFlowå®ç°çš„fashion-mnistçš„è¯†åˆ«ï¼Œæ€»ä½“æ ¹æ®å®éªŒç»“æœæ¥è¯´ï¼Œä»æµ‹è¯•é›†çš„æ•°æ®æ¥çœ‹ï¼Œæˆ‘è¾¾åˆ°çš„å‡†ç¡®ç‡ç»“æœæ˜¯88.5%ï¼Œè¿˜ç®—å¯ä»¥ã€‚åç»­æˆ‘ä»¬å¯èƒ½ä½¿ç”¨å…¶ä»–ä¸€äº›ç°æœ‰çš„ç½‘ç»œç»“æ„æ¥å®ç°fashion-mnistçš„è¯†åˆ«ï¼Œçœ‹çœ‹å‡†ç¡®ç‡ä¼šä¸ä¼šæé«˜ã€‚ å¦‚ä¸‹æ˜¯æˆ‘å¯¹ä¸Šé¢TensorFLowå‡ºç°çš„æ–¹æ³•ä»‹ç»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748tf.placeholders( dtype, shape=None, name=None)ä»å‚æ•°ä¸Šé¢çœ‹åˆ°ï¼Œæ€»å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼š dtypeï¼šåœ¨tensorä¸­è¢«å–‚æ•°æ®çš„å…ƒç´ ç±»å‹ shape: tensorçš„shape nameï¼šå‘½åè¯´æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªtensorï¼Œåœ¨TensorFlowé‡Œé¢ï¼Œtensoræ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œå¤§å®¶åŠ¡å¿…æŒæ¡ï¼Œä¹Ÿå«å¼ é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ä¸€ä¸ªæ•°:å°±æ˜¯0-é˜¶å¼ é‡ï¼Œä¹Ÿå«æ ‡é‡ã€‚ä¸€ä¸ªå‘é‡ï¼Œå°±æ˜¯1-é˜¶å¼ é‡ã€‚ä¸€ä¸ªçŸ©é˜µï¼Œå°±æ˜¯2-é˜¶å¼ é‡ï¼Œåé¢çš„å°±æ˜¯ä¸€ç›´å¾€é«˜ç»´äº†èµ°ï¼Œå¯¹åº”çš„å°±æ˜¯å¤šå°‘é˜¶å¼ é‡ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œå¾ˆé‡è¦çš„åŸå› ä¹Ÿåœ¨äºå®ƒæ˜¯å®šä¹‰åœ¨Sessionæ‰§è¡Œrunçš„æ—¶å€™ï¼Œåœ¨åé¢å¡«å……æ•°æ®çš„å ä½ç¬¦ï¼Œä¹Ÿå°±æ˜¯feed_dictè¿™ä¸ªå˜é‡é‡Œé¢çš„æ•°æ®ï¼Œæ‰€ä»¥å¤§å®¶ï¼ŒåŠ¡å¿…è®°ä½è¿™ä¸€å…³é”®çš„æ¦‚å¿µã€‚åç»­ç”¨èµ·æ¥å°±ä¼šå¾ˆé¡ºæ‰‹ã€‚tf.get_variable()è¿™ä¸ªæ–¹æ³•åç»­åœ¨å±•å¼€æ¥è¯´ï¼Œä½ å…ˆç†è§£å°±æ˜¯ä½¿ç”¨å®ƒå¯ä»¥å®šä¹‰å˜é‡ï¼ˆä¿å­˜æƒé‡å’Œåç½®é¡¹çš„ï¼‰ï¼Œè¿˜å¯ä»¥åŠ ä¸€äº›ä¼˜åŒ–å™¨ï¼Œæ¯”å¦‚è¯´æ­£åˆ™ä¼˜åŒ–å™¨ç­‰ç­‰tf.matmul( a, b,)å±•ç¤ºç»™ä½ ä»¬åˆ—å‡ºè¿™ä¸¤ä¸ªå‚æ•°ï¼š aï¼šå°±æ˜¯å¾…æ“ä½œçš„çŸ©é˜µ1 b: å°±æ˜¯å¾…æ“ä½œçš„çŸ©é˜µ2å‡½æ•°åŠŸèƒ½å°±æ˜¯å®ç°çŸ©é˜µçš„ç›¸ä¹˜è¿ç®—ï¼ˆå½“ç„¶è¦ç¬¦åˆåŸºæœ¬çš„çŸ©é˜µè¿ç®—æ ¼å¼ï¼‰tf.transpose( a,)å…ˆåˆ—å‡ºæ¥ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯çŸ©é˜µçš„è½¬ç½®Session().run( fetches, feed_list=None, )è¿™ä¸ªæ–¹æ³•å°±æ˜¯è¿è¡Œå›¾ã€‚å¾ˆå…³é”®ï¼Œå…ˆæŒæ¡ä¸¤ä¸ªå‚æ•°: fetches: ä½ è¦ä»å›¾é‡Œé¢å–å‡ºçš„æ•°æ®ï¼ˆï¼‰ feed_list: ä½ è¦ç»™å›¾å–‚çš„æ•°æ®ï¼ˆè¾“å…¥å’Œlabelæ•°æ®å°±æ˜¯ç”¨è¿™æ ·çš„æ–¹å¼æ¥åšçš„ï¼‰ æ¯”å¦‚æˆ‘ä»¬è®­ç»ƒçš„ç½‘ç»œä¸­è¾“å…¥çš„å›¾ç‰‡ä¿¡æ¯å’Œå¯¹åº”çš„labelä¿¡æ¯tf.reduce_mean( input_tensor, axis=None, keepdims=None, name=None, redcution_indices=None, keep_dims=None )è®¡ç®—è¾“å…¥tensorçš„æ€»å’Œï¼š input_tensor: è¦å åŠ çš„tensor axis: é€‰æ‹©é‚£ä¸ªç»´åº¦å åŠ  keepdims: å åŠ å…ƒç´ ä»¥åï¼Œä¿ç•™åŸæ¥çš„ç»´åº¦ä¿¡æ¯ nameï¼šå°±æ˜¯åå­— redcution_indicesï¼šè¢«axiså–ä»£ keep_dimsï¼šè¢«keepdimså–ä»£ æˆ‘ä»¬ä»Šå¤©çš„ä»»åŠ¡é‡å¯èƒ½æœ‰ä¸€äº›å¤§ï¼Œå¤§å®¶åšæŒã€‚æ€»çš„æ¥è¯´å°±æ˜¯ä½¿ç”¨ç¥ç»ç½‘ç»œå¯¹å®é™…çš„ä¸€ä¸ªfashion-mnistæ•°æ®é›†è¿›è¡Œæœè£…ç§ç±»çš„è¯†åˆ«ï¼Œå¤§å®¶ä¸»è¦çœ‹çœ‹æˆ‘çš„ä»£ç ã€‚æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„æˆ‘åœ¨ä»£ç é‡Œé¢éƒ½åšå‡ºäº†æ³¨é‡Šã€‚ é‚®ç®±â€”â€”air@weaf.topæ¬¢è¿æ¥æ¢è®¨","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]},{"title":"rsyncçš„ä½¿ç”¨ä¸é…ç½®","slug":"2018-03-19/rsync-configuration-and-use","date":"2018-03-25T13:08:56.000Z","updated":"2018-05-29T01:27:49.793Z","comments":true,"path":"posts/cfc65600/","link":"","permalink":"http://weafteam.github.io/posts/cfc65600/","excerpt":"ä¸€ã€ä»€ä¹ˆæ˜¯rsync rsyncï¼Œremote synchronizeé¡¾åæ€æ„å°±çŸ¥é“å®ƒæ˜¯ä¸€æ¬¾å®ç°è¿œç¨‹åŒæ­¥åŠŸèƒ½çš„è½¯ä»¶ï¼Œå®ƒåœ¨åŒæ­¥æ–‡ä»¶çš„åŒæ—¶ï¼Œå¯ä»¥ä¿æŒåŸæ¥æ–‡ä»¶çš„æƒé™ã€æ—¶é—´ã€è½¯ç¡¬é“¾æ¥ç­‰é™„åŠ ä¿¡æ¯ã€‚ rsyncæ˜¯ç”¨ â€œrsync ç®—æ³•â€æä¾›äº†ä¸€ä¸ªå®¢æˆ·æœºå’Œè¿œç¨‹æ–‡ä»¶æœåŠ¡å™¨çš„æ–‡ä»¶åŒæ­¥çš„å¿«é€Ÿæ–¹æ³•ï¼Œè€Œä¸”å¯ä»¥é€šè¿‡sshæ–¹å¼æ¥ä¼ è¾“æ–‡ä»¶ï¼Œè¿™æ ·å…¶ä¿å¯†æ€§ä¹Ÿéå¸¸å¥½ï¼Œå¦å¤–å®ƒè¿˜æ˜¯å…è´¹çš„è½¯ä»¶ã€‚ äºŒã€rsyncçš„å®‰è£… rysncçš„å®˜æ–¹ç½‘ç«™ï¼šhttp://rsync.samba.org å¯ä»¥ä»ä¸Šé¢å¾—åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚ç›®å‰æœ€æ–°ç‰ˆæ˜¯3.1.2ã€‚å½“ç„¶ï¼Œå› ä¸ºrsyncæ˜¯ä¸€æ¬¾å¦‚æ­¤æœ‰ç”¨çš„è½¯ä»¶ï¼Œæ‰€ä»¥å¾ˆå¤šLinuxçš„å‘è¡Œç‰ˆæœ¬éƒ½å°†å®ƒæ”¶å½•åœ¨å†…äº†ã€‚","text":"ä¸€ã€ä»€ä¹ˆæ˜¯rsync rsyncï¼Œremote synchronizeé¡¾åæ€æ„å°±çŸ¥é“å®ƒæ˜¯ä¸€æ¬¾å®ç°è¿œç¨‹åŒæ­¥åŠŸèƒ½çš„è½¯ä»¶ï¼Œå®ƒåœ¨åŒæ­¥æ–‡ä»¶çš„åŒæ—¶ï¼Œå¯ä»¥ä¿æŒåŸæ¥æ–‡ä»¶çš„æƒé™ã€æ—¶é—´ã€è½¯ç¡¬é“¾æ¥ç­‰é™„åŠ ä¿¡æ¯ã€‚ rsyncæ˜¯ç”¨ â€œrsync ç®—æ³•â€æä¾›äº†ä¸€ä¸ªå®¢æˆ·æœºå’Œè¿œç¨‹æ–‡ä»¶æœåŠ¡å™¨çš„æ–‡ä»¶åŒæ­¥çš„å¿«é€Ÿæ–¹æ³•ï¼Œè€Œä¸”å¯ä»¥é€šè¿‡sshæ–¹å¼æ¥ä¼ è¾“æ–‡ä»¶ï¼Œè¿™æ ·å…¶ä¿å¯†æ€§ä¹Ÿéå¸¸å¥½ï¼Œå¦å¤–å®ƒè¿˜æ˜¯å…è´¹çš„è½¯ä»¶ã€‚ äºŒã€rsyncçš„å®‰è£… rysncçš„å®˜æ–¹ç½‘ç«™ï¼šhttp://rsync.samba.org å¯ä»¥ä»ä¸Šé¢å¾—åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚ç›®å‰æœ€æ–°ç‰ˆæ˜¯3.1.2ã€‚å½“ç„¶ï¼Œå› ä¸ºrsyncæ˜¯ä¸€æ¬¾å¦‚æ­¤æœ‰ç”¨çš„è½¯ä»¶ï¼Œæ‰€ä»¥å¾ˆå¤šLinuxçš„å‘è¡Œç‰ˆæœ¬éƒ½å°†å®ƒæ”¶å½•åœ¨å†…äº†ã€‚ è½¯ä»¶åŒ…å®‰è£… å‘½ä»¤ å¹³å° # sudo apt-get install rsync æ³¨ï¼šåœ¨debianã€ubuntu ç­‰åœ¨çº¿å®‰è£…æ–¹æ³•ï¼› # yum install rsync æ³¨ï¼šFedoraã€Redhat ç­‰åœ¨çº¿å®‰è£…æ–¹æ³•ï¼› # rpm -ivh rsync æ³¨ï¼šFedoraã€Redhat ç­‰rpmåŒ…å®‰è£…æ–¹æ³•ï¼› å…¶å®ƒLinuxå‘è¡Œç‰ˆï¼Œè¯·ç”¨ç›¸åº”çš„è½¯ä»¶åŒ…ç®¡ç†æ–¹æ³•æ¥å®‰è£…ã€‚ æºç åŒ…å®‰è£… 123 tar xvf rsync-xxx.tar.gz cd rsync-xxx ./configure --prefix=/usr ;make ;make install æ³¨ï¼šåœ¨ç”¨æºç  åŒ…ç¼–è¯‘å®‰è£…ä¹‹å‰ï¼Œæ‚¨å¾—å®‰è£…gccç­‰ç¼–è¯‘å¼€å…·æ‰è¡Œï¼› ä¸‰ã€rsyncçš„é…ç½® â€”â€”â€”â€“ rsyncçš„ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªé…ç½®æ–‡ä»¶rsyncd.conf(ä¸»é…ç½®æ–‡ä»¶)ã€rsyncd.secrets(å¯†ç æ–‡ä»¶)ã€rsyncd.motd(rysncæœåŠ¡å™¨ä¿¡æ¯) æ¯”å¦‚æˆ‘ä»¬è¦å¤‡ä»½æœåŠ¡å™¨ä¸Šçš„/homeå’Œ/optï¼Œåœ¨/homeä¸­æˆ‘æƒ³æŠŠeasylifeå’Œsambaç›®å½•æ’é™¤åœ¨å¤–ï¼› 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849 # Distributed under the terms of the GNU General Public License v2 # Minimal configuration file for rsync daemon # See rsync(1) and rsyncd.conf(5) man pages for help # This line is required by the /etc/init.d/rsyncd script pid file = /var/run/rsyncd.pid port = 873 address = 192.168.1.171 #uid = nobody #gid = nobody uid = root gid = root use chroot = yes read only = yes #limit access to private LANs hosts allow=192.168.1.0/255.255.255.0 10.0.1.0/255.255.255.0 hosts deny=* max connections = 5 motd file = /etc/rsyncd.motd #This will give you a separate log file #log file = /var/log/rsync.log #This will log every file transferred - up to 85,000+ per user, per sync #transfer logging = yes log format = %t %a %m %f %b syslog facility = local3 timeout = 300 [rhel4home] path = /home list=yes ignore errors auth users = root secrets file = /etc/rsyncd.secrets comment = This is RHEL 4 data exclude = easylife/ samba/ [rhel4opt] path = /opt list=no ignore errors comment = This is RHEL 4 opt auth users = easylife secrets file = /etc/rsyncd/rsyncd.secrets æ³¨ï¼šå…³äºauth usersæ˜¯å¿…é¡»åœ¨æœåŠ¡å™¨ä¸Šå­˜åœ¨çš„çœŸå®çš„ç³»ç»Ÿç”¨æˆ·ï¼Œå¦‚æœä½ æƒ³ç”¨å¤šä¸ªç”¨æˆ·ä»¥,å·éš”å¼€ï¼Œæ¯”å¦‚auth users = easylife,root è®¾å®šå¯†ç æ–‡ä»¶ å¯†ç æ–‡ä»¶æ ¼å¼å¾ˆç®€å•ï¼Œrsyncd.secretsçš„å†…å®¹æ ¼å¼ä¸ºï¼š ç”¨æˆ·å:å¯†ç  æˆ‘ä»¬åœ¨ä¾‹å­ä¸­rsyncd.secretsçš„å†…å®¹å¦‚ä¸‹ç±»ä¼¼çš„ï¼›åœ¨æ–‡æ¡£ä¸­è¯´ï¼Œæœ‰äº›ç³»ç»Ÿä¸æ”¯æŒé•¿å¯†ç ï¼Œè‡ªå·±å°è¯•ç€è®¾ç½®ä¸€ä¸‹å§ã€‚ 12 easylife:keer root:mike 12 chown root.root rsyncd.secrets #ä¿®æ”¹å±ä¸» chmod 600 rsyncd.secrets #ä¿®æ”¹æƒé™ æ³¨ï¼š1ã€å°†rsyncd.secretsè¿™ä¸ªå¯†ç æ–‡ä»¶çš„æ–‡ä»¶å±æ€§è®¾ä¸ºrootæ‹¥æœ‰, ä¸”æƒé™è¦è®¾ä¸º600, å¦åˆ™æ— æ³•å¤‡ä»½æˆåŠŸ! å‡ºäºå®‰å…¨ç›®çš„ï¼Œæ–‡ä»¶çš„å±æ€§å¿…éœ€æ˜¯åªæœ‰å±ä¸»å¯è¯»ã€‚ 2ã€è¿™é‡Œçš„å¯†ç å€¼å¾—æ³¨æ„ï¼Œä¸ºäº†å®‰å…¨ä½ ä¸èƒ½æŠŠç³»ç»Ÿç”¨æˆ·çš„å¯†ç å†™åœ¨è¿™é‡Œã€‚æ¯”å¦‚ä½ çš„ç³»ç»Ÿç”¨æˆ·easylifeå¯†ç æ˜¯000000ï¼Œä¸ºäº†å®‰å…¨ä½ å¯ä»¥è®©rsyncä¸­çš„easylifeä¸ºkeerã€‚è¿™å’Œsambaçš„ç”¨æˆ·è®¤è¯çš„å¯†ç åŸç†æ˜¯å·®ä¸å¤šçš„ã€‚ è®¾å®šrsyncd.motd æ–‡ä»¶; å®ƒæ˜¯å®šä¹‰rysncæœåŠ¡å™¨ä¿¡æ¯çš„ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ç™»å½•ä¿¡æ¯ã€‚æ¯”å¦‚è®©ç”¨æˆ·çŸ¥é“è¿™ä¸ªæœåŠ¡å™¨æ˜¯è°æä¾›çš„ç­‰ï¼›ç±»ä¼¼ftpæœåŠ¡å™¨ç™»å½•æ—¶ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„ linuxsir.org ftp â€¦â€¦ã€‚ å½“ç„¶è¿™åœ¨å…¨å±€å®šä¹‰å˜é‡æ—¶ï¼Œå¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½ å¯ä»¥ç”¨#å·æ³¨æ‰ï¼Œæˆ–åˆ é™¤ï¼›æˆ‘åœ¨è¿™é‡Œå†™äº†ä¸€ä¸ª rsyncd.motdçš„å†…å®¹ä¸ºï¼š 1234 ++++++++++++++++++++++++++++++++++++++++++++++ Welcome to use the mike.org.cn rsync services!2002------2009 ++++++++++++++++++++++++++++++++++++++++++++++ å››ã€å¯åŠ¨rsyncæœåŠ¡å™¨ ç›¸å½“ç®€å•ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³• Aã€â€“daemonå‚æ•°æ–¹å¼ï¼Œæ˜¯è®©rsyncä»¥æœåŠ¡å™¨æ¨¡å¼è¿è¡Œ 1 #/usr/bin/rsync --daemon --config=/etc/rsyncd/rsyncd.conf #--configç”¨äºæŒ‡å®šrsyncd.confçš„ä½ç½®,å¦‚æœåœ¨/etcä¸‹å¯ä»¥ä¸å†™ Bã€xinetdæ–¹å¼ 12345 ä¿®æ”¹servicesåŠ å…¥å¦‚ä¸‹å†…å®¹ # nano -w /etc/services rsync 873/tcp # rsync rsync 873/udp # rsync è¿™ä¸€æ­¥ä¸€èˆ¬å¯ä»¥ä¸åšï¼Œé€šå¸¸éƒ½æœ‰è¿™ä¸¤è¡Œ(æˆ‘çš„RHEL4å’ŒGENTOOé»˜è®¤éƒ½æœ‰)ã€‚ä¿®æ”¹çš„ç›®çš„æ˜¯è®©ç³»ç»ŸçŸ¥é“873ç«¯å£å¯¹åº”çš„æœåŠ¡åä¸ºrsyncã€‚å¦‚æ²¡æœ‰çš„è¯å°±è‡ªè¡ŒåŠ å…¥ã€‚ è®¾å®š /etc/xinetd.d/rsync, ç®€å•ä¾‹å­å¦‚ä¸‹: 12345678910111213 # default: off # description: The rsync server is a good addition to am ftp server, as it \\ # allows crc checksumming etc. service rsync &#123;disable = nosocket_type = streamwait = nouser = rootserver = /usr/bin/rsyncserver_args = --daemonlog_on_failure += USERID &#125; ä¸Šè¿°, ä¸»è¦æ˜¯è¦æ‰“å¼€rsyncé€™å€‹daemon, ä¸€æ—¦æœ‰rsync clientè¦è¿æ¥æ™‚, xinetdä¼šæŠŠå®ƒè½¬ä»‹çµ¦ rsyncd(port 873)ã€‚ç„¶åservice xinetd restart, ä½¿ä¸Šè¿°è®¾å®šç”Ÿæ•ˆ. rsyncæœåŠ¡å™¨å’Œé˜²ç«å¢™ Linux é˜²ç«å¢™æ˜¯ç”¨iptablesï¼Œæ‰€ä»¥æˆ‘ä»¬è‡³å°‘åœ¨æœåŠ¡å™¨ç«¯è¦è®©ä½ æ‰€å®šä¹‰çš„rsync æœåŠ¡å™¨ç«¯å£é€šè¿‡ï¼Œå®¢æˆ·ç«¯ä¸Šä¹Ÿåº”è¯¥è®©é€šè¿‡ã€‚ 12 #iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 873 -j ACCEPT #iptables -L æŸ¥çœ‹ä¸€ä¸‹é˜²ç«å¢™æ˜¯ä¸æ˜¯æ‰“å¼€äº† 873ç«¯å£ å¦‚æœä½ ä¸å¤ªæ‡‚é˜²ç«å¢™çš„é…ç½®ï¼Œå¯ä»¥å…ˆservice iptables stop å°†é˜²ç«å¢™å…³æ‰ã€‚å½“ç„¶åœ¨ç”Ÿäº§ç¯å¢ƒè¿™æ˜¯å¾ˆå±é™©çš„ï¼Œåšå®éªŒæ‰å¯ä»¥è¿™ä¹ˆåšå“Ÿï¼ äº”ã€é€šè¿‡rsyncå®¢æˆ·ç«¯æ¥åŒæ­¥æ•°æ® B1ã€åˆ—å‡ºrsync æœåŠ¡å™¨ä¸Šçš„æ‰€æä¾›çš„åŒæ­¥å†…å®¹ï¼› é¦–å…ˆï¼šæˆ‘ä»¬çœ‹çœ‹rsyncæœåŠ¡å™¨ä¸Šæä¾›äº†å“ªäº›å¯ç”¨çš„æ•°æ®æº # rsync â€“list-only root@192.168.145.5:: ++++++++++++++++++++++++++++++++++++++++++++++ Welcome to use the mike.org.cn rsync services! 2002â€”â€”2009 ++++++++++++++++++++++++++++++++++++++++++++++ rhel4home This is RHEL 4 data æ³¨ï¼šå‰é¢æ˜¯rsyncæ‰€æä¾›çš„æ•°æ®æºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨rsyncd.confä¸­æ‰€å†™çš„[rhel4home]æ¨¡å—ã€‚è€Œâ€œThis is RHEL 4 dataâ€æ˜¯ç”±[rhel4home]æ¨¡å—ä¸­çš„ comment = This is RHEL 4 data æä¾›çš„ï¼›ä¸ºä»€ä¹ˆæ²¡æœ‰æŠŠrhel4optæ•°æ®æºåˆ—å‡ºæ¥å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨[rhel4opt]ä¸­å·²ç»æŠŠlist=noäº†ã€‚ $ rsync â€“list-only root@192.168.145.5::rhel4home ++++++++++++++++++++++++++++++++++++++++++++++ Welcome to use the mike.org.cn rsync services! 2002â€”â€”2009 ++++++++++++++++++++++++++++++++++++++++++++++ Password: drwxr-xr-x 4096 2009/03/15 21:33:13 . -rw-râ€“râ€“ 1018 2009/03/02 02:33:41 ks.cfg -rwxr-xr-x 21288 2009/03/15 21:33:13 wgetpaste drwxrwxr-x 4096 2008/10/28 21:04:05 cvsroot drwxâ€”â€” 4096 2008/11/30 16:30:58 easylife drwsr-sr-x 4096 2008/09/20 22:18:05 giddir drwxâ€”â€” 4096 2008/09/29 14:18:46 quser1 drwxâ€”â€” 4096 2008/09/27 14:38:12 quser2 drwxâ€”â€” 4096 2008/11/14 06:10:19 test drwxâ€”â€” 4096 2008/09/22 16:50:37 vbird1 drwxâ€”â€” 4096 2008/09/19 15:28:45 vbird2 åé¢çš„root@ipä¸­ï¼Œrootæ˜¯æŒ‡å®šå¯†ç æ–‡ä»¶ä¸­çš„ç”¨æˆ·åï¼Œä¹‹åçš„::rhel4homeè¿™æ˜¯rhel4homeæ¨¡å—å ### B2ã€rsyncå®¢æˆ·ç«¯åŒæ­¥æ•°æ®ï¼› #rsync -avzP root@192.168.145.5::rhel4home rhel4home Password: è¿™é‡Œè¦è¾“å…¥rootçš„å¯†ç ï¼Œæ˜¯æœåŠ¡å™¨ç«¯rsyncd.secretsæä¾›çš„ã€‚åœ¨å‰é¢çš„ä¾‹å­ä¸­æˆ‘ä»¬ç”¨çš„æ˜¯mikeï¼Œè¾“å…¥çš„å¯†ç å¹¶ä¸å›æ˜¾ï¼Œè¾“å¥½å°±å›è½¦ã€‚ æ³¨ï¼š è¿™ä¸ªå‘½ä»¤çš„æ„æ€å°±æ˜¯è¯´ï¼Œç”¨rootç”¨æˆ·ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šï¼ŒæŠŠrhel4homeæ•°æ®ï¼ŒåŒæ­¥åˆ°æœ¬åœ°å½“å‰ç›®å½•rhel4homeä¸Šã€‚å½“ç„¶æœ¬åœ°çš„ç›®å½•æ˜¯å¯ä»¥ä½ è‡ªå·± å®šä¹‰çš„ã€‚å¦‚æœå½“ä½ åœ¨å®¢æˆ·ç«¯ä¸Šå½“å‰æ“ä½œçš„ç›®å½•ä¸‹æ²¡æœ‰rhel4homeè¿™ä¸ªç›®å½•æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸€ä¸ªï¼›å½“å­˜åœ¨rhel4homeè¿™ä¸ªç›®å½•ä¸­ï¼Œä½ è¦æ³¨æ„ å®ƒçš„å†™æƒé™ã€‚ 1 #rsync -avzP --delete linuxsir@linuxsir.org::rhel4home rhel4home è¿™å›æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªâ€“delete é€‰é¡¹ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ä¸Šçš„æ•°æ®è¦ä¸æœåŠ¡å™¨ç«¯å®Œå…¨ä¸€è‡´ï¼Œå¦‚æœ linuxsirhomeç›®å½•ä¸­æœ‰æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œåˆ™åˆ é™¤ã€‚æœ€ç»ˆç›®çš„æ˜¯è®©linuxsirhomeç›®å½•ä¸Šçš„æ•°æ®å®Œå…¨ä¸æœåŠ¡å™¨ä¸Šä¿æŒä¸€è‡´ï¼›ç”¨çš„æ—¶å€™è¦ å°å¿ƒç‚¹ï¼Œæœ€å¥½ä¸è¦æŠŠå·²ç»æœ‰é‡è¦æ•°æ‰€æ®çš„ç›®å½•ï¼Œå½“åšæœ¬åœ°æ›´æ–°ç›®å½•ï¼Œå¦åˆ™ä¼šæŠŠä½ çš„æ•°æ®å…¨éƒ¨åˆ é™¤ï¼› è¨­å®š rsync client è®¾å®šå¯†ç æ–‡ä»¶ 1 #rsync -avzP --delete --password-file=rsyncd.secrets root@192.168.145.5::rhel4home rhel4home è¿™æ¬¡æˆ‘ä»¬åŠ äº†ä¸€ä¸ªé€‰é¡¹ â€“password-file=rsyncd.secretsï¼Œè¿™æ˜¯å½“æˆ‘ä»¬ä»¥rootç”¨æˆ·ç™»å½•rsyncæœåŠ¡å™¨åŒæ­¥æ•°æ®æ—¶ï¼Œå¯†ç å°†è¯»å–rsyncd.secretsè¿™ä¸ªæ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å†…å®¹åªæ˜¯rootç”¨æˆ·çš„å¯†ç ã€‚æˆ‘ä»¬è¦å¦‚ä¸‹åšï¼› # touch rsyncd.secrets # chmod 600 rsyncd.secrets # echo â€œmikeâ€&gt; rsyncd.secrets # rsync -avzP â€“delete â€“password-file=rsyncd.secrets root@192.168.145.5::rhel4home rhel4home æ³¨ï¼šè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä»½å¯†ç æ–‡ä»¶æƒé™å±æ€§è¦è®¾å¾—åªæœ‰å±ä¸»å¯è¯»ã€‚ è¿™æ ·å°±ä¸éœ€è¦å¯†ç äº†ï¼›å…¶å®è¿™æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œå› ä¸ºæœåŠ¡å™¨é€šè¿‡crond è®¡åˆ’ä»»åŠ¡è¿˜æ˜¯æœ‰å¿…è¦çš„ï¼› ### B3ã€è®©rsyncå®¢æˆ·ç«¯è‡ªåŠ¨ä¸æœåŠ¡å™¨åŒæ­¥æ•°æ® æœåŠ¡å™¨æ˜¯é‡é‡çº§åº”ç”¨ï¼Œæ‰€ä»¥æ•°æ®çš„ç½‘ç»œå¤‡ä»½è¿˜æ˜¯æä¸ºé‡è¦çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§å‹æœåŠ¡å™¨ä¸Šé…ç½®å¥½rsync æœåŠ¡å™¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸€å°è£…æœ‰rysncæœºå™¨å½“åšæ˜¯å¤‡ä»½æœåŠ¡å™¨ã€‚è®©è¿™å°å¤‡ä»½æœåŠ¡å™¨ï¼Œæ¯å¤©åœ¨æ—©ä¸Š4ç‚¹å¼€å§‹åŒæ­¥æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼›å¹¶ä¸”æ¯ä¸ªå¤‡ä»½éƒ½æ˜¯å®Œæ•´å¤‡ä»½ã€‚æœ‰æ—¶ ç¡¬ç›˜åæ‰ï¼Œæˆ–è€…æœåŠ¡å™¨æ•°æ®è¢«åˆ é™¤ï¼Œå®Œæ•´å¤‡ä»½è¿˜æ˜¯ç›¸å½“é‡è¦çš„ã€‚è¿™ç§å¤‡ä»½ç›¸å½“äºæ¯å¤©ä¸ºæœåŠ¡å™¨çš„æ•°æ®åšä¸€ä¸ªé•œåƒï¼Œå½“ç”Ÿäº§å‹æœåŠ¡å™¨å‘ç”Ÿäº‹æ•…æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾æ¢å¤æ•° æ®ï¼Œèƒ½æŠŠæ•°æ®æŸå¤±é™åˆ°æœ€ä½ï¼›æ˜¯ä¸æ˜¯è¿™ä¹ˆå›äº‹ï¼Ÿï¼Ÿ step1ï¼šåˆ›å»ºåŒæ­¥è„šæœ¬å’Œå¯†ç æ–‡ä»¶ 12345678 #mkdir /etc/cron.daily.rsync #cd /etc/cron.daily.rsync #touch rhel4home.sh rhel4opt.sh #chmod 755 /etc/cron.daily.rsync/*.sh #mkdir /etc/rsyncd/ #touch /etc/rsyncd/rsyncrhel4root.secrets #touch /etc/rsyncd/rsyncrhel4easylife.secrets #chmod 600 /etc/rsyncd/rsync.* æ³¨ï¼š æˆ‘ä»¬åœ¨ /etc/cron.daily/ä¸­åˆ›å»ºäº†ä¸¤ä¸ªæ–‡ä»¶rhel4home.shå’Œrhel4opt.sh ï¼Œå¹¶ä¸”æ˜¯æƒé™æ˜¯755çš„ã€‚åˆ›å»ºäº†ä¸¤ä¸ªå¯†ç æ–‡ä»¶rootç”¨æˆ·ç”¨çš„æ˜¯rsyncrhel4root.secrets ï¼Œeasylifeç”¨æˆ·ç”¨çš„æ˜¯ rsyncrhel4easylife.secretsï¼Œæƒé™æ˜¯600ï¼› æˆ‘ä»¬ç¼–è¾‘rhel4home.shï¼Œå†…å®¹æ˜¯å¦‚ä¸‹çš„ï¼š 123 #!/bin/sh #backup 192.168.145.5:/home /usr/bin/rsync -avzP --password-file=/etc/rsyncd/rsyncrhel4root.secrets root@192.168.145.5::rhel4home /home/rhel4homebak/$(date +&apos;%m-%d-%y&apos;) æˆ‘ä»¬ç¼–è¾‘ rhel4opt.sh ï¼Œå†…å®¹æ˜¯ï¼š 123 #!/bin/sh #backup 192.168.145.5:/opt /usr/bin/rsync -avzP --password-file=/etc/rsyncd/rsyncrhel4easylife.secrets easylife@192.168.145.5::rhel4opt /home/rhel4hoptbak/$(date +&apos;%m-%d-%y&apos;) æ³¨ï¼šä½ å¯ä»¥æŠŠrhel4home.shå’Œrhel4opt.shçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚éƒ½å†™åˆ°rhel4bak.shä¸­ï¼› æ¥ç€æˆ‘ä»¬ä¿®æ”¹ /etc/rsyncd/rsyncrhel4root.secretså’Œrsyncrhel4easylife.secretsçš„å†…å®¹ï¼› 12 # echo &quot;mike&quot; &gt; /etc/rsyncd/rsyncrhel4root.secrets # echo &quot;keer&quot;&gt; /etc/rsyncd/rsyncrhel4easylife.secrets ç„¶åæˆ‘ä»¬å†/homeç›®å½•ä¸‹åˆ›å»ºrhel4homebak å’Œrhel4optbakä¸¤ä¸ªç›®å½•ï¼Œæ„æ€æ˜¯æœåŠ¡å™¨ç«¯çš„rhel4homeæ•°æ®åŒæ­¥åˆ°å¤‡ä»½æœåŠ¡å™¨ä¸Šçš„/home/rhel4homebak ä¸‹ï¼Œrhel4optæ•°æ®åŒæ­¥åˆ° /home/rhel4optbak/ç›®å½•ä¸‹ã€‚å¹¶æŒ‰å¹´æœˆæ—¥å½’æ¡£åˆ›å»ºç›®å½•ï¼›æ¯å¤©å¤‡ä»½éƒ½å­˜æ¡£ï¼› 12 #mkdir /home/rhel4homebak #mkdir /home/rhel4optbak step2ï¼šä¿®æ”¹crondæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ åŠ å…¥åˆ°è®¡åˆ’ä»»åŠ¡ 1 #crontab -e åŠ å…¥ä¸‹é¢çš„å†…å®¹ï¼š # Run daily cron jobs at 4:10 every day backup rhel4 data: 10 4 * * * /usr/bin/run-parts /etc/cron.daily.rsync 1&gt; /dev/null æ³¨ï¼šç¬¬ä¸€è¡Œæ˜¯æ³¨é‡Šï¼Œæ˜¯è¯´æ˜å†…å®¹ï¼Œè¿™æ ·èƒ½è‡ªå·±è®°ä½ã€‚ ç¬¬äºŒè¡Œè¡¨ç¤ºåœ¨æ¯å¤©æ—©ä¸Š4ç‚¹10åˆ†çš„æ—¶å€™ï¼Œè¿è¡Œ /etc/cron.daily.rsync ä¸‹çš„å¯æ‰§è¡Œè„šæœ¬ä»»åŠ¡ï¼› é…ç½®å¥½åï¼Œè¦é‡å¯crond æœåŠ¡å™¨ï¼› 123456 # killall crond æ³¨ï¼šæ€æ­»crond æœåŠ¡å™¨çš„è¿›ç¨‹ï¼› # ps aux |grep crond æ³¨ï¼šæŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦è¢«æ€æ­»ï¼› # /usr/sbin/crond æ³¨ï¼šå¯åŠ¨ crond æœåŠ¡å™¨ï¼› # ps aux |grep crond æ³¨ï¼šæŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦å¯åŠ¨äº†ï¼Ÿ root 3815 0.0 0.0 1860 664 ? S 14:44 0:00 /usr/sbin/crond root 3819 0.0 0.0 2188 808 pts/1 S+ 14:45 0:00 grep crond","categories":[{"name":"Linux","slug":"Linux","permalink":"http://weafteam.github.io/categories/Linux/"}],"tags":[{"name":"Linuxè¿ç»´","slug":"Linuxè¿ç»´","permalink":"http://weafteam.github.io/tags/Linuxè¿ç»´/"}]},{"title":"æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆäºŒï¼‰jiebaä¸­æ–‡åˆ†è¯å·¥å…·è¿›é˜¶","slug":"2018-03-19/æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆäºŒï¼‰jiebaä¸­æ–‡åˆ†è¯å·¥å…·è¿›é˜¶","date":"2018-03-19T11:57:19.000Z","updated":"2018-05-29T01:27:49.796Z","comments":true,"path":"posts/931939a5/","link":"","permalink":"http://weafteam.github.io/posts/931939a5/","excerpt":"","text":"jiebaä¸­æ–‡åˆ†è¯å·¥å…·ä½¿ç”¨è¿›é˜¶ç¯‡ï¼ŒåºŸè¯ä¸å¤šè¯´å—ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬æ¬¡çš„å­¦ä¹ å§~ å¦‚ä½•è®©åˆ†è¯çš„æ›´åŠ å‡†ç¡® æˆ‘ä»¬ä¹‹å‰ä¸¾å¾—ä¾‹å­æœ‰äº›æ–‡æœ¬å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬åæ¥ç¡®å®æ¢äº†å®˜æ–¹çš„æµ‹è¯•æ–‡æœ¬ã€Šå›´åŸã€‹ï¼Œä½†æ˜¯å‡æ²¡é¿å…ä¸€ä¸ªé—®é¢˜ï¼Œè¿™äº›æµ‹è¯•ä¾‹éƒ½ååˆ†åœ°ä¸­è§„ä¸­çŸ©ã€‚åœ¨å®é™…ä¸­éœ€è¦æˆ‘ä»¬åšåˆ†è¯çš„æ–‡æœ¬å¯èƒ½æ˜¯å¤šç§å¤šæ ·çš„ï¼Œè¿™æ—¶å€™çš„åˆ‡è¯æœ‰å¯èƒ½ä¼šä¸å¤ªç‰¹åˆ«ç†æƒ³ï¼Œå¯¼è‡´åˆ†è¯çš„ä¸å‡†ç¡®ã€‚ é‚£æˆ‘ä»¬ä¸å¦¨ä¸‹ä¸€ä¸ªåˆ«çš„ç”µå­ä¹¦ï¼ˆè¿™é‡Œæˆ‘ä¸‹è½½çš„æ˜¯ã€Šæ–—ç ´è‹ç©¹ã€‹ï¼Œä¸ºäº†æµ‹è¯•æˆ‘åªç”¨äº†ç¬¬ä¸€ç« çš„æ–‡æœ¬ï¼‰ï¼Œç„¶åå†è¿›è¡Œåˆ‡è¯ï¼Œçœ‹ä¸‹æ˜¯å¦å­˜åœ¨è¿™æ ·çš„é—®é¢˜ã€‚è¿™é‡Œæˆ‘ä»¬ç¨å¾®æ”¹æ”¹ä¸Šæ¬¡çš„å»åœç”¨è¯çš„ä»£ç ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223import sysimport jiebafrom os import pathd = path.dirname(__file__) # è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„text_path = 'txt/chapter2.txt' #ã€Šæ–—ç ´è‹ç©¹ã€‹ç¬¬ä¸€ç« çš„æ–‡æœ¬è·¯å¾„text = open(path.join(d, text_path),'rb').read()def CutWords(text): mywordlist = [] seg_list = jieba.cut(text, cut_all=False) liststr=\"/ \".join(seg_list) # æ·»åŠ åˆ‡åˆ†ç¬¦ for myword in liststr.split('/'): if len(myword.strip())&gt;1: mywordlist.append(myword) return ''.join(mywordlist) #è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²txt5 = CutWords(text)text_write = 'txt/5.txt'with open(text_write,'w') as f: f.write(txt5) print(\"Success\") ç»“æœå¦‚ä¸‹ï¼š ç»ˆäºè¢«æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªåˆ‡è¯é”™è¯¯ï¼ŒåŸæ–‡æ˜¯è¿™æ ·çš„ï¼š è§åªšè„‘ä¸­å¿½ç„¶æµ®ç°å‡ºä¸‰å¹´å‰é‚£æ„æ°”é£å‘çš„å°‘å¹´ æŒ‰ç…§æˆ‘ä»¬æ­£å¸¸çš„æ–­å¥ï¼Œåº”ä¸ºï¼š è§åªš/è„‘ä¸­/å¿½ç„¶/æµ®ç°â€¦.ï¼Œè€Œjiebaå´è®¤ä¸ºâ€œè§åªšè„‘â€æ˜¯ä¸€ä¸ªå•è¯ï¼Œä»è€Œå¯¼è‡´æ­¤å¤„åˆ†è¯ä¸ç†æƒ³ã€‚ jiebaè€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œè€Œä¸”æœ‰å¾ˆå¤šçš„åº”å¯¹æ–¹æ¡ˆï¼Œä¸‹é¢æˆ‘ä»¬å…ˆè¯´æœ€ç®€å•çš„ã€‚ è°ƒæ•´è¯å…¸ æ–¹æ³•1ï¼šåŠ¨æ€ä¿®æ”¹è¯å…¸ ä½¿ç”¨add_word(word,freq=None,tag=None)å’Œdel_word(word)å¯åœ¨ç¨‹åºä¸­åŠ¨æ€çš„ä¿®æ”¹è¯å…¸ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š 12345678910import sysimport jiebafrom os import pathd = path.dirname(__file__) # è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„# æ­¤å¤„å¢åŠ ä»£ç jieba.add_word('è„‘ä¸­') Â·Â·Â·Â· ç»“æœå¦‚ä¸‹ï¼š æœç„¶ï¼Œè¿™æ ·çš„æ–¹æ³•å¾ˆç›´æ¥çš„æŠŠæˆ‘ä»¬åŸæ¥åˆ‡é”™çš„è¯å˜æˆäº†æ­£ç¡®çš„è¯ã€‚ä¸add_word()ç›¸å¯¹åº”çš„æ˜¯delete_word()æ–¹æ³•ï¼Œæ ¹æ®å­—é¢æ„æ€æˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“ç†è§£delete_word()æ–¹æ³•çš„ä½œç”¨ï¼Œè¿™é‡Œæˆ‘å°±ä¸åšè¿‡å¤šçš„æ¼”ç¤ºäº†ï¼Œå¤§å®¶åœ¨å®é™…åœºæ™¯ä¸­ç›´æ¥è¿ç”¨å°±å¥½äº†ã€‚ æ–¹æ³•2ï¼šè°ƒèŠ‚è¯é¢‘ ä½¿ç”¨suggest_freq(segment, tune=True)è°ƒèŠ‚å•ä¸ªè¯è¯­çš„è¯é¢‘ï¼Œä½¿å¾—å®ƒæ›´å®¹æ˜“è¢«åˆ†å‡ºæ¥ï¼Œæˆ–è€…ä¸è¢«åˆ†å‡ºæ¥ã€‚ ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè‡ªåŠ¨è®¡ç®—çš„è¯é¢‘åœ¨ä½¿ç”¨ HMM æ–°è¯å‘ç°åŠŸèƒ½æ—¶å¯èƒ½æ— æ•ˆã€‚ æ‰€ä»¥æ­¤æ—¶æˆ‘ä»¬åœ¨åšåˆ‡è¯çš„æ—¶å€™éœ€è¦æŠŠæ˜¯HMMç½®ä¸ºFalseã€‚æˆ‘ä»¬çœ‹ä¸‹å®˜æ–¹ç»™çš„Demoï¼ˆå¦‚æœå…³é—­HMMï¼Œå¾ˆå¤šæ–°å‘ç°çš„è¯éƒ½æ¶ˆå¤±äº†ï¼Œæ‰€ä»¥â€˜è§åªšè„‘â€™ä¹Ÿæ¶ˆå¤±äº†ï¼Œæ— æ³•åšæµ‹è¯•ï¼Œæˆ‘ä»¬çš„ä¾‹å­ä¹Ÿæ˜¯ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œæ‰€ä»¥ä¹Ÿæ²¡å¿…è¦éå¾—é’ˆå¯¹è¿™ä¸€ä¸ªè¯åšè¯é¢‘è°ƒèŠ‚ï¼‰ï¼Œå…·ä½“çš„åšæ³•å¦‚ä¸‹ï¼š 12345678910111213import jiebaprint('/'.join(jieba.cut('å¦‚æœæ”¾åˆ°postä¸­å°†å‡ºé”™ã€‚', HMM=False)))jieba.suggest_freq(('ä¸­', 'å°†'), True)print('/'.join(jieba.cut('å¦‚æœæ”¾åˆ°postä¸­å°†å‡ºé”™ã€‚', HMM=False)))print('/'.join(jieba.cut('ã€Œå°ä¸­ã€æ­£ç¡®åº”è¯¥ä¸ä¼šè¢«åˆ‡å¼€', HMM=False)))jieba.suggest_freq('å°ä¸­', True)print('/'.join(jieba.cut('ã€Œå°ä¸­ã€æ­£ç¡®åº”è¯¥ä¸ä¼šè¢«åˆ‡å¼€', HMM=False))) ç»“æœï¼š å¯¹æ¯”ä¸‹ç»“æœï¼Œä¸éš¾å‘ç°suggest_freq()çš„ä½¿ç”¨æ–¹æ³•ï¼Œé€šè¿‡è¿™æ ·çš„å¼ºè°ƒé«˜é¢‘è¯å’Œä½é¢‘è¯çš„æ–¹æ³•å¯ä»¥åšåˆ°åˆ†è¯æ›´å‡†ç¡®ã€‚ æ·»åŠ è‡ªå®šä¹‰è¯å…¸ æ¯”èµ·é»˜è®¤çš„è¯å…¸ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è¯å…¸æ›´é€‚åˆæˆ‘ä»¬è‡ªå·±çš„æ–‡æœ¬ï¼Œè¿™ä¸€ç‚¹æ˜¯æ¯‹åº¸ç½®ç–‘çš„ã€‚ è¯å…¸æ ¼å¼å’Œ dict.txt ä¸€æ ·ï¼Œä¸€ä¸ªè¯å ä¸€è¡Œï¼›æ¯ä¸€è¡Œåˆ†ä¸‰éƒ¨åˆ†ï¼šè¯è¯­ã€è¯é¢‘ï¼ˆå¯çœç•¥ï¼‰ã€è¯æ€§ï¼ˆå¯çœç•¥ï¼‰ï¼Œç”¨ç©ºæ ¼éš”å¼€ï¼Œé¡ºåºä¸å¯é¢ å€’ã€‚file_name è‹¥ä¸ºè·¯å¾„æˆ–äºŒè¿›åˆ¶æ–¹å¼æ‰“å¼€çš„æ–‡ä»¶ï¼Œåˆ™æ–‡ä»¶å¿…é¡»ä¸º UTF-8 ç¼–ç ã€‚ è¿™é‡Œæˆ‘ä»¬çš„è¯å…¸ä¸ºï¼š 12345678910äº‘è®¡ç®— 5æå°ç¦ 2 nråˆ›æ–°åŠ 3 ieasy_install 3 engå¥½ç”¨ 300éŸ©ç‰èµé‰´ 3 nzå…«ä¸€åŒé¹¿ 3 nzå°ä¸­å‡±ç‰¹ç³ nzEdu Trustè®¤è¯ 2000 æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¹Ÿç”¨å®˜æ–¹çš„Demoï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334import syssys.path.append(\"../\")import jiebajieba.load_userdict(\"userdict.txt\")# jiebaåœ¨0.28ç‰ˆæœ¬ä¹‹åé‡‡ç”¨å»¶è¿ŸåŠ è½½æ–¹å¼# â€œimport jiebaâ€ä¸ä¼šç«‹å³è§¦å‘è¯å…¸çš„åŠ è½½ï¼Œè€Œæ˜¯åœ¨æœ‰å¿…è¦çš„æ—¶å€™æ‰ä¼šåŠ è½½è¯å…¸# å¦‚æœæƒ³æ‰‹åŠ¨åŠ è½½ï¼Œå¯æ‰§è¡Œä»£ç ï¼š jieba.initialize() è¿›è¡Œæ‰‹åŠ¨åˆå§‹åŒ–æ“ä½œ# ä¹Ÿæ­£æ˜¯æœ‰äº†å»¶è¿ŸåŠ è½½æœºåˆ¶ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ”¹å˜ä¸»è¯å…¸çš„è·¯å¾„ï¼š# jieba.set_dictionary('data/dict.txt.big')# å®˜æ–¹è¿˜æä¾›äº†å ç”¨å†…å­˜è¾ƒå°çš„è¯å…¸å’Œé€‚ç”¨äºç¹ä½“å­—çš„è¯å…¸ï¼Œå‡åœ¨å®˜æ–¹çš„GitHubä¸Šï¼Œæœ‰éœ€è¦çš„å¯ä»¥è‡ªè¡Œä¸‹è½½ã€‚import jieba.posseg as pseg# psegåˆ‡åˆ†å¯ä»¥æ˜¾ç¤ºè¯æ€§# ä»¥ä¸‹ä¸‰ä¸ªæ“ä½œæ˜¯ä¿®æ”¹è¯å…¸çš„å·©å›ºjieba.add_word('çŸ³å¢¨çƒ¯')jieba.add_word('å‡±ç‰¹ç³')jieba.del_word('è‡ªå®šä¹‰è¯')test_sent = (\"æå°ç¦æ˜¯åˆ›æ–°åŠä¸»ä»»ä¹Ÿæ˜¯äº‘è®¡ç®—æ–¹é¢çš„ä¸“å®¶; ä»€ä¹ˆæ˜¯å…«ä¸€åŒé¹¿\\n\"\"ä¾‹å¦‚æˆ‘è¾“å…¥ä¸€ä¸ªå¸¦â€œéŸ©ç‰èµé‰´â€çš„æ ‡é¢˜ï¼Œåœ¨è‡ªå®šä¹‰è¯åº“ä¸­ä¹Ÿå¢åŠ äº†æ­¤è¯ä¸ºNç±»\\n\"\"ã€Œå°ä¸­ã€æ­£ç¢ºæ‡‰è©²ä¸æœƒè¢«åˆ‡é–‹ã€‚macä¸Šå¯åˆ†å‡ºã€ŒçŸ³å¢¨çƒ¯ã€ï¼›æ­¤æ™‚åˆå¯ä»¥åˆ†å‡ºä¾†å‡±ç‰¹ç³äº†ã€‚\")words = jieba.cut(test_sent)print('/'.join(words))print(\"=\"*40)result = pseg.cut(test_sent)for w in result: print(w.word, \"/\", w.flag, \", \", end=' ') ç»“æœå¦‚ä¸‹ï¼š åƒâ€˜äº‘è®¡ç®—â€™ã€â€˜åˆ›æ–°åŠâ€™ç­‰è¯åœ¨æ²¡åŠ è½½è¯å…¸çš„æ—¶å€™æ˜¯ä¸èƒ½è¢«è¯†åˆ«å‡ºæ¥çš„ã€‚åƒâ€˜çŸ³å¢¨çƒ¯â€™ç­‰åœ¨æ²¡æœ‰add_word()çš„æ—¶å€™ä¹Ÿæ˜¯ä¸èƒ½è¯†åˆ«å‡ºæ¥çš„ã€‚å¯è§æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚ å¹¶è¡Œåˆ†è¯ åŸç†ï¼šå°†ç›®æ ‡æ–‡æœ¬æŒ‰è¡Œåˆ†éš”åï¼ŒæŠŠå„è¡Œæ–‡æœ¬åˆ†é…åˆ°å¤šä¸ª Python è¿›ç¨‹å¹¶è¡Œåˆ†è¯ï¼Œç„¶åå½’å¹¶ç»“æœï¼Œä»è€Œè·å¾—åˆ†è¯é€Ÿåº¦çš„å¯è§‚æå‡ ä½†æ˜¯ä»¤äººé—æ†¾çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡å—å¹¶ä¸æ”¯æŒWindowså¹³å°ï¼ŒåŸå› æ˜¯å› ä¸ºjiebaçš„è¯¥æ¨¡å—æ˜¯åŸºäºpythonè‡ªå¸¦çš„ multiprocessing æ¨¡å—ï¼Œè€Œè¿™ä¸ªæ¨¡å—å¹¶ä¸æ”¯æŒWindowsã€‚è¿™é‡Œæˆ‘å°±è´´ä¸€ä¸‹ç”¨æ³•ï¼Œä½¿ç”¨Linuxç³»ç»Ÿçš„åŒå­¦å¯ä»¥è‡ªè¡Œä½“éªŒä¸‹è¿™ä¸ªå¯è§‚çš„é€Ÿåº¦æå‡ã€‚ ç”¨æ³•ï¼š jieba.enable_parallel(4) # å¼€å¯å¹¶è¡Œåˆ†è¯æ¨¡å¼ï¼Œå‚æ•°ä¸ºå¹¶è¡Œè¿›ç¨‹æ•° jieba.disable_parallel() # å…³é—­å¹¶è¡Œåˆ†è¯æ¨¡å¼ æœ€å ä»¥ä¸Šæ‰€è®²çš„å†…å®¹åœ¨æ—¥å¸¸çš„ä½¿ç”¨ä¸­åº”è¯¥æ˜¯å¤Ÿç”¨äº†ï¼Œå½“ç„¶åƒåŸºäºTextRankç®—æ³•çš„å…³é”®è¯æŠ½å–ç­‰å†…å®¹ï¼Œæˆ‘è¿™é‡Œå¹¶æ²¡æ¶‰åŠï¼Œå¹¶ä¸æ˜¯å› ä¸ºä¸é‡è¦ï¼Œè€Œæ˜¯æˆ‘å¯¹è¿™ä¸ªç®—æ³•è¿˜ä¸æ˜¯å¾ˆäº†è§£ï¼Œç¡¬ç€å¤´çš®å†™è‚¯å®šä¹Ÿæ˜¯ç…§æœ¬å®£ç§‘ï¼Œæ•ˆæœè‚¯å®šå¾ˆå·®ï¼Œæ‰€ä»¥å…ˆæŒ–ä¸ªå‘å§ï¼Œä»¥åå†å¡«ã€‚ æ„Ÿè°¢é˜…è¯»~","categories":[{"name":"æ–‡æœ¬èšç±»","slug":"æ–‡æœ¬èšç±»","permalink":"http://weafteam.github.io/categories/æ–‡æœ¬èšç±»/"}],"tags":[{"name":"æ–‡æœ¬èšç±»","slug":"æ–‡æœ¬èšç±»","permalink":"http://weafteam.github.io/tags/æ–‡æœ¬èšç±»/"}]},{"title":"æ™®é€šçš„ SQLAlchemy ORM ä½¿ç”¨å§¿åŠ¿","slug":"2018-03-12/usage-of-sqlalchemy","date":"2018-03-18T13:38:54.000Z","updated":"2018-08-07T08:56:41.610Z","comments":true,"path":"posts/39277c31/","link":"","permalink":"http://weafteam.github.io/posts/39277c31/","excerpt":"","text":"å‰è¨€ SQLAlchemy æ˜¯ Python ä¸–ç•Œä¸­æœ€å¸¸ç”¨çš„ SQL å·¥å…·ä¹‹ä¸€ï¼ŒåŒ…å« SQL æ¸²æŸ“å¼•æ“å’Œ ORM ä¸¤å¤§éƒ¨åˆ†ï¼Œå¹³æ—¶ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯ ORMã€‚åœ¨æˆ‘çœ‹æ¥å¹³æ—¶å¾ˆå¤šä½¿ç”¨ ORM çš„å§¿åŠ¿æ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ–è€…è¯´æ˜¯ä¸ä¼˜é›…çš„ã€‚æ‰€ä»¥è¿™ç¯‡æ–‡ç« æ‰“ç®—è®²è®²ï¼ˆæ¬è¿ï¼‰å…¶ä¸­ä¸€äº›æ™®é€šçš„å§¿åŠ¿å’ŒæŠ€å·§ï¼ˆAPI æ–‡æ¡£ï¼‰ã€‚ property å’Œæ··åˆå±æ€§ property ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æˆ·è¡¨æ˜ å°„ï¼š 12345class User(Base): __tablename__ = 'user' id = Column(Integer, primary_key=True) name = Column(String(64)) password = Column(String(128)) é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåŠ å¯†ç”¨æˆ·çš„å¯†ç ï¼Œåœ¨æ•°æ®åº“ä¸­ä¿å­˜å¯†æ–‡ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾—è¿™ä¹ˆå†™ï¼š 1234# åˆ›å»ºç”¨æˆ·user = User(name='zhang', password=encrypt('123456'))# ä¿®æ”¹å¯†ç user.password = encrypt('654321') è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸æ–­çš„é‡å¤ä¹¦å†™ encrypt å‡½æ•°æ¥ä¿è¯åŠ å¯†äº†ç”¨æˆ·å¯†ç ã€‚ æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•èƒ½çœå»è¿™ä¸€æ­¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ propertyã€‚ ç°åœ¨æŠŠç”¨æˆ·è¡¨æ˜ å°„æ”¹æˆè¿™æ ·ï¼š 12345678910111213class User(Base): __tablename__ = 'user' id = Column(Integer, primary_key=True) name = Column(String(64)) _password = Column(String(128)) @property def password(self): raise ValueError('write only!') @password.setter def password(self, value): self._password = encrypt(value) ç°åœ¨åªéœ€è¦ç®€å•çš„å†™æˆï¼š 1234# åˆ›å»ºç”¨æˆ·user = User(name='zhang', password='123456')# ä¿®æ”¹å¯†ç user.password = '654321' å°±å¯ä»¥äº†ã€‚ å…³äº Python ä¸­ propertyå’Œæè¿°ç¬¦çš„ä½¿ç”¨å€¼å¾—å†å¦å†™ä¸€ç¯‡æ–‡ç« æè¿°ï¼Œåœ¨è¿™é‡Œå°±ä¸è¯¦ç»†è¯´æ˜äº†ã€‚ æ··åˆå±æ€§ï¼ˆhybrid_propertyï¼‰ ä¸Šé¢çš„ä¾‹å­çœ‹ä¸Šå»è®©ä»£ç æ¸…çˆ½äº†ä¸å°‘ï¼Œä½†æ˜¯æœ‰æ—¶å€™è¿™ç§ç”¨æ³•æ˜¯æ— æ³•æ»¡è¶³éœ€è¦çš„ï¼Œè­¬å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š 12345class Student(Base): __tablename__ = 'student' id = Column(Integer, primary_key=True) name = Column(String(64)) birthday = Column(DateTime) è¿™æ˜¯ä¸€ä¸ªå­¦ç”Ÿè¡¨æ˜ å°„ï¼Œå¢åŠ äº† birthday å­—æ®µã€‚é€šå¸¸æˆ‘ä»¬ä¼šä¿å­˜ç”¨æˆ·çš„ç”Ÿæ—¥ï¼Œå†é€šè¿‡ç”Ÿæ—¥è·å–ç”¨æˆ·å¹´é¾„ã€‚æœ‰äº†ä¸Šé¢çš„ä¾‹å­ï¼Œå¾ˆå®¹æ˜“å†™å‡ºè·å–å¹´é¾„çš„ä»£ç ï¼š 123456class Student(Base): ... @property def age(self): return datetime.now().year - self.birthday.year ç°åœ¨å¯ä»¥ç®€å•çš„ä½¿ç”¨ student.age è·å–å…·ä½“çš„ç”Ÿæ—¥ã€‚ è¿™æ ·åšæ˜¯æœ‰ç¼ºé™·çš„ï¼šå¦‚æœéœ€è¦è·å–æ‰€æœ‰ 18 å²çš„å­¦ç”Ÿå‘¢ï¼Ÿæˆ‘ä»¬å¸Œæœ›å¯ä»¥è¿™æ ·å†™ï¼š 1session.query(Student).filter_by(age=18).all() ä½†æ˜¯å´æ²¡æœ‰ä»»ä½•ç»“æœè¿”å›ã€‚å¦‚æœæ”¹æˆè¿™æ ·å‘¢ï¼Ÿ 1234now = datetime.now()start = datetime(now.year - 18, 1, 1)end = end = datetime(now.year + 1 - 18, 1, 1)session.query(Student).filter(Student.birthday &gt;= start, Student.birthday &lt; end).all() è¿™æ ·å€’æ˜¯å¯ä»¥è·å–æ­£ç¡®çš„ç»“æœäº†ï¼Œä½†æ˜¯ä¹Ÿå¤ªä¸‘äº†ç‚¹å§ï¼Ÿéš¾é“æ²¡åŠæ³•å†™å‡ºåƒç¬¬ä¸€æ¡ä¸€æ ·çš„æ—¢æ¸…æ™°åˆç®€æ´çš„æŸ¥è¯¢ä¹ˆï¼Ÿ ç­”æ¡ˆè‡ªç„¶æ˜¯æœ‰çš„ï¼ŒSQLAlchemy æä¾›äº†æ··åˆå±æ€§ï¼ˆhybrid_propertyï¼‰æ¥å¤„ç†ç±»ä¼¼çš„æƒ…å†µï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥æ”¹å†™è·å–å¹´é¾„çš„ä»£ç ï¼š 12345678910111213from sqlalchemy.ext.hybrid import hybrid_propertyfrom sqlalchemy import funcclass Student(Base): ... @hybrid_property def age(self): return datetime.now().year - self.birthday.year @age.expression def age(self): return datetime.now().year - func.year(self.birthday) è¿™é‡Œå°†åŸæœ¬çš„ property æ›¿æ¢ä¸º SQLAlchemy ä¸­çš„ hybrid_propertyï¼ŒåŒæ—¶æä¾›äº†ä¸€ä¸ª expression è£…é¥°å™¨ï¼Œåœ¨è¢«è£…é¥°çš„æ–¹æ³•ä¸­æŠŠ Python ä»£ç ç¿»è¯‘æˆ SQLï¼ˆä»£ç ç¤ºä¾‹çš„ç›®æ ‡æ•°æ®åº“ä¸º MySQLï¼Œè·å–æ—¥æœŸä¸­çš„å¹´ä»½çš„å‡½æ•°ä¸ºYEAR()ï¼Œä½¿ç”¨å…¶ä»–æ•°æ®åº“è¯·æŸ¥é˜…å¯¹åº”æ•°æ®åº“çš„ç›¸å…³æ–‡æ¡£ï¼‰ã€‚æœ‰äº†è¿™ä¸ªæ–¹æ³•ï¼ŒSQLAlchemy å°±çŸ¥é“å¦‚ä½•åœ¨ SQL è¯­å¥ä¸­å¤„ç† age å±æ€§äº†ã€‚ æ¥ä¸‹æ¥ç¨å¾®æä¸€ä¸‹ hybrid_methodã€‚ å’Œ hybrid_property ç±»ä¼¼ï¼Œåªä¸è¿‡å¯ä»¥ç»™ hybrid_method ä¼ å‚æ•°ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸å¤ªåˆé€‚ï¼Œåªä¸ºäº†å±•ç¤ºhybrid_method çš„åŠŸèƒ½ã€‚ å¦‚ä½•æ‰¾åˆ°æ‰€æœ‰ 90 ååŒå­¦ï¼Ÿå½“ç„¶æˆ‘ä»¬å¯ä»¥å¤ç”¨ä¸Šé¢çš„ age å±æ€§ï¼Œå…ˆè®¡ç®—ä¸€ä¸‹ 90 åçš„åŒå­¦ç°åœ¨å¤šå°‘å²ï¼Œç„¶åç›´æ¥å†™åœ¨æŸ¥è¯¢é‡Œå°±å¥½ï¼š 1session.query(Student).filter(Student.age &gt;= now.year - 1990, Student.age &lt; now.year - 2000).all() å¦‚æœè¦åˆ¤æ–­æŸä¸ªå­¦ç”Ÿæ˜¯å¦æ˜¯ 90 åå‘¢ï¼Ÿåˆéœ€è¦å†å†™ä¸€éï¼š 12if now.year - 2000 &gt; student.age &gt;= now.year - 1990: ... å‡ºç°äº†å¾ˆå¤šä¸ç›´è§‚çš„ä»£ç ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ hybrid_method ç®€åŒ–ï¼š 123456789class Student(Base): ... @hybrid_method def born_after(self, years): return years + 10 &gt; self.birthday.year &gt;= years @born_after.expression def born_after(self, years): return and_(func.year(self.birthday) &lt; years + 10, func.year(self.birthday) &gt;= years) äºæ˜¯ç°åœ¨å¯ä»¥è¿™æ ·åšï¼š 1234session.query(Student).filter(Student.born_after(1990)).all()if student.born_after(1990): ... çœ‹ä¸Šå»å¥½äº†ä¸€äº›ï¼ˆè¯¯ è¿™ä¸€éƒ¨åˆ†å°±åˆ°æ­¤ä¸ºæ­¢ï¼Œå½“ç„¶ hybrid åœ¨ SQLAlchemy ä¸­çš„ç”¨æ³•ä¸æ­¢ä¸Šè¿°è¿™äº›ï¼Œæ›´è¯¦ç»†å’Œå¤æ‚çš„å†…å®¹å‚è§å®˜æ–¹æ–‡æ¡£ã€‚ å…³è”ä»£ç†ï¼ˆassociation_proxyï¼‰ ç®€åŒ–æ ‡é‡é›†åˆ å…³è”ä»£ç†ç”¨åœ¨æœ‰å…³è”çš„è¡¨ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ›å»ºå¦‚ä¸‹æ˜ å°„å…³ç³»ï¼š 1234567891011121314151617association = Table('association', Base.metadata, Column('blog_id', Integer, ForeignKey('blog.id'), primary_key=True), Column('tag_id', Integer, ForeignKey('tag.id'), primary_key=True))class Blog(Base): __tablename__ = 'blog' id = Column(Integer, primary_key=True) name = Column(String(64)) tags = relationship( 'Tag', secondary=association, backref=backref('blogs', lazy='dynamic'), lazy='dynamic')class Tag(Base): __tablename__ = 'tag' id = Column(Integer, primary_key=True) name = Column(String(64)) ä¸€ä¸ªç»å¸¸è¢«æ‹¿å‡ºæ¥ä½œä¸ºæ¼”ç¤ºçš„ Many-To-Many æ¨¡å‹ã€‚ å…ˆå¡«å……ä¸€äº›æ•°æ®ï¼š 12345In [1]: blog = Blog(name='first')In [2]: blog.tags.append(Tag(name='t1'))In [3]: blog.tags.append(Tag(name='t2'))In [4]: session.add(blog)In [5]: session.commit() æ¥ä¸‹æ¥å°±å¯ä»¥è·å–è¿™äº›å¯¹è±¡çš„æ‰€æœ‰ä¿¡æ¯äº†ï¼š 12345678In [4]: blog.tags.all()Out[4]: [&lt;Tag at 0x1fdbab6f198&gt;, &lt;Tag at 0x1fdbab6f208&gt;]In [5]: blog.tags.all()[0].nameOut[5]: 't1'In [6]: [t.name for t in blog.tags]Out[6]: ['t1', 't2'] ä¸Šé¢çš„æ“ä½œæœ‰ç‚¹å¤æ‚ã€‚å¯¹æˆ‘ä»¬è€Œè¨€ï¼ŒTag å¯¹è±¡åªæœ‰ name å­—æ®µæ˜¯æœ‰ç”¨çš„ï¼Œä¸ºäº†è·å– name å­—æ®µï¼Œæˆ‘ä»¬è¦å†™å¾ˆå¤šé¢å¤–çš„ä»£ç æŠŠ name å­—æ®µä» Tag å¯¹è±¡ä¸­å‰¥ç¦»å‡ºæ¥ã€‚association_proxy å°±å¯ä»¥ç”¨æ¥ç®€åŒ–è¿™ä¸ªæ“ä½œã€‚ ç°åœ¨ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ Blog æ˜ å°„ï¼š 123456789from sqlalchemy.ext.associationproxy import association_proxyclass Blog(Base): ... tag_objects = relationship( 'Tag', secondary=association, backref=backref('blogs', lazy='dynamic'), lazy='dynamic') tags = association_proxy('tag_objects', 'name') å¢åŠ äº†ä¸€è¡Œ association_proxy å¯¹è±¡çš„å£°æ˜ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š 12In [7]: blog.tagsOut[7]: ['t1', 't2'] ç°åœ¨æŸ¥è¯¢æ“ä½œå˜å¾—å¾ˆç®€å•äº†ï¼Œä½†æ˜¯æ–°å¢æ ‡ç­¾çš„æ“ä½œè¿˜æ˜¯å¾ˆéº»çƒ¦ï¼š 1blog.tag_objects.append(Tag(name='t3')) è¿˜æ˜¯éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª Tag å¯¹è±¡ï¼Œèƒ½ä¸èƒ½ç›´æ¥å†™ï¼š 1blog.tags.append('t4') å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œåªè¦å†ä¿®æ”¹ä¸€ä¸‹ association_proxy çš„å£°æ˜ï¼š 1234class Blog(Base): ... tags = association_proxy('tag_objects', 'name', creator=lambda name: Tag(name=name)) å‚æ•° creator æ¥å—ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå®ƒå‘Šè¯‰ association_proxy å¦‚ä½•å¤„ç†â€œæ–°å¢â€æ“ä½œã€‚ æ³¨æ„ï¼šcreator çš„é»˜è®¤å‚æ•°æ˜¯è¢«ä»£ç†å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œå¦‚æœæä¾›äº†ä¸€ä¸ªå•å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆå¯ä»¥çœç•¥ creator å‚æ•°ã€‚ ç®€åŒ–å…³è”å¯¹è±¡ ä¸Šé¢çš„ä¾‹å­é‡ŒæŠŠ association è¡¨ä½œä¸ºä¸€ä¸ªæ™®é€šçš„ Table å¯¹è±¡ï¼Œæ˜¯å› ä¸º association ä¸­ä¸éœ€è¦ä¿å­˜é¢å¤–ä¿¡æ¯ï¼Œåªéœ€è¦ä½œä¸º Blog å’Œ Tag çš„ä¸­è½¬ã€‚ç°åœ¨æœ‰äº†æ–°çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ¯ç¯‡åšå®¢çš„æ ‡ç­¾æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åŠ ä¸Šçš„ï¼Œè¿™å°±éœ€è¦åœ¨ association è¡¨ä¸­å¢åŠ ä¸€ä¸ªé¢å¤–çš„å­—æ®µç”¨æ¥è¡¨ç¤ºåˆ›å»ºæ—¶é—´ï¼ŒåŒæ—¶ä¸ºäº†è·å–è¿™ä¸ªæ—¶é—´ï¼Œè¿˜è¦æŠŠ association æ”¹é€ æˆä¸€ä¸ªçœŸæ­£çš„æ˜ å°„ï¼š 123456789101112131415161718192021class Association(Base): __tablename__ = 'association' blog_id = Column(Integer, ForeignKey('blog.id'), primary_key=True) tag_id = Column(Integer, ForeignKey('tag.id'), primary_key=True) created_at = Column(DateTime, default=datetime.now) blog = relationship('Blog', backref=backref('blog_tags', lazy='dynamic'), lazy='joined') tag = relationship('Tag', backref=backref('tag_blogs', lazy='dynamic'), lazy='joined')class Tag(Base): __tablename__ = 'tag' id = Column(Integer, primary_key=True) name = Column(String(64))class Blog(Base): __tablename__ = 'blog' id = Column(Integer, primary_key=True) name = Column(String(64)) è¿™é‡Œå®é™…ä¸Šæ˜¯æŠŠ Many-To-Many æ‹†æˆäº†ä¸¤ä¸ª One-To-Manyã€‚ ç„¶åæ„é€ ä¸€äº›æ•°æ®ï¼š 1234567In [1]: blog = Blog(name='first') ...: tags = [Tag(name='t1'), Tag(name='t2')] ...: for tag in tags: ...: session.add(Association(blog=blog, tag=tag)) ...: session.add(blog) ...: session.add_all(tags) ...: session.commit() ç°åœ¨å°±å¯ä»¥è·å– Tag å’Œè¢«æ·»åŠ çš„æ—¶é—´äº†ï¼š 12345In [2]: blog.blog_tags[0].tag.nameOut[2]: 't1'In [3]: blog.blog_tags[0].created_atOut[3]: datetime.datetime(2018, 3, 18, 16, 4, 17) å¯ä»¥çœ‹åˆ°ï¼Œç»™ Blog å¢åŠ æ ‡ç­¾è¦ç»è¿‡ Association è¿™ä¸ªä¸­é—´å¯¹è±¡ã€‚è™½ç„¶è¡¨ç»“æ„çš„ç¡®å¦‚æ­¤ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¸Œæœ› Association è¡¨æ˜¯é€æ˜çš„ï¼Œä»…å½“éœ€è¦è·å–å…¶ä¸­çš„åˆ›å»ºæ—¶é—´æ—¶æ‰æ˜ç¡®è·å– Association å¯¹è±¡ã€‚åªéœ€è¦åœ¨ Blog ä¸­å£°æ˜ä¸€ä¸ªå…³è”ä»£ç†ï¼š 1234class Blog(Base): ... tags = association_proxy('blog_tags', 'tag', creator=lambda tag: Association(tag=tag)) ç„¶åå°±å¯ä»¥è¿™æ ·å†™äº†ï¼š 12In [4]: blog.tags[0].nameOut[4]: 't1' æ·»åŠ æ–°çš„ Tag ä¹Ÿæ–¹ä¾¿äº†å¾ˆå¤šï¼š 12In [3]: for tag in [Tag(name='t3'), Tag(name='t4')]: ...: blog.tags.append(tag) æ··åˆå…³è”ä»£ç† ç°åœ¨å›åˆ°äº†ç¬¬ä¸€ä¸ªé—®é¢˜çš„å‡ºå‘ç‚¹ï¼Œèƒ½ä¸èƒ½åœ¨ä¸Šä¸€ä¸ªä¾‹å­çš„åŸºç¡€ä¸Šç®€åŒ– tags çš„è°ƒç”¨å‘¢ï¼ŸåŒæ ·æ²¡é—®é¢˜ï¼Œåªè¦åœ¨ Association ä¸­åŠ ä¸€ä¸ªå…³è”ä»£ç†ï¼š 12345class Association(Base): ... tag_objects = relationship('Tag', backref=backref('tag_blogs', lazy='dynamic'), lazy='joined') tags = association_proxy('tag_objects', 'name', creator=lambda name: Tag(name=name)) ç„¶åç”¨èµ·æ¥å°±å’Œç¬¬ä¸€ä¸ªä¾‹å­ä¸€æ ·äº†ï¼š 123456In [1]: blog.tagsOut[1]: ['t1', 't2']In [2]: blog.tags.append('t3')In [3]: blog.tagsOut[3]: ['t1', 't2', 't3'] ç»“è¯­ ä¸Šè¿°å†…å®¹å¹¶æ²¡æœ‰å¾ˆå¤æ‚çš„æ“ä½œï¼Œéƒ½æ˜¯ä¸€äº›æ˜“äºå®ç°å¹¶ä¸”å¯ä»¥æ”¹å–„æ—¥å¸¸ä½¿ç”¨ä½“éªŒçš„æ–¹æ³•ã€‚SQLAlchemy è¿˜æœ‰å¾ˆå¤šéªšæ“ä½œå¯ä»¥è®²ï¼Œä½†æ˜¯å—é™äºæœ¬äººçš„å§¿åŠ¿æ°´å¹³ï¼Œå¾ˆå¤šå¹¶æ²¡æœ‰å®é™…ä½¿ç”¨è¿‡ï¼Œä¹Ÿè°ˆä¸ä¸Šæœ‰ä»€ä¹ˆè§è§£ã€‚é‚£å°±è¿™æ ·å§~","categories":[],"tags":[]},{"title":"æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆä¸€ï¼‰jiebaä¸­æ–‡åˆ†è¯å·¥å…·å…¥é—¨","slug":"2018-03-12/æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆä¸€ï¼‰jiebaä¸­æ–‡åˆ†è¯å·¥å…·å…¥é—¨","date":"2018-03-17T09:20:22.000Z","updated":"2018-05-29T01:27:49.779Z","comments":true,"path":"posts/575e441b/","link":"","permalink":"http://weafteam.github.io/posts/575e441b/","excerpt":"","text":"æœ€è¿‘åœ¨å­¦ä¹ æ–‡æœ¬åˆ†ç±»ï¼ˆèšç±»ï¼‰çš„ç›¸å…³çŸ¥è¯†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å‡†å¤‡å…ˆå†™ä¸€ä¸ªå…³äºè¿™ä¸ªæ–¹é¢çš„ç³»åˆ—åšå®¢ã€‚ å†™åœ¨å‰é¢ï¼š å…ˆä»‹ç»ä¸‹ç”±æˆ‘ä»¬å››ä¸ªäººç»„æˆçš„ç»„ç»‡ï¼šFOUR ELEMENTSã€‚å››å…ƒç´ åˆ†åˆ«å¯¹åº”WELLã€EARTHã€AIRã€FLAMEï¼Œæ ¹æ®é¦–å­—æ¯ç¼©å†™ï¼Œæˆ‘ä»¬çš„åšå®¢ä¸»é¡µå¾—åWEAFã€‚ æ¥ä¸‹æ¥ä»‹ç»ä¸‹æˆ‘è‡ªå·±ï¼Œæˆ‘å«Lenoï¼Œå¯¹åº”äºå››å…ƒç´ é‡Œé¢çš„Wellï¼Œç›®å‰ç ”ç©¶ç”Ÿåœ¨è¯»ï¼Œæ–¹å‘ä¸ºæ™ºèƒ½ä¿¡æ¯å¤„ç†ã€‚æˆ‘çš„åšå®¢ä¸»è¦ä¼šä»¥æ—¥å¸¸é‡åˆ°çš„é—®é¢˜ä»¥åŠå­¦ä¹ çš„çŸ¥è¯†ä¸ºä¸»ã€‚ ç®€å•çš„ä»‹ç»ï¼š é¦–å…ˆï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯å¯¹ä¸­æ–‡æ–‡æœ¬çš„èšç±»ï¼Œå¦‚æœåšèšç±»çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ–‡æœ¬çš„å†…å®¹åšåˆ†æï¼Œè€Œåˆ†æçš„æœ€å°å•ä½è‚¯å®šæ˜¯è¯ã€‚ å…¶æ¬¡ï¼Œä¸­æ–‡å’Œè‹±æ–‡çš„è¯æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ä¸­æ–‡çš„è¯ä¸è¯ä¹‹é—´å¹¶ä¸æ˜¯ç”¨ç©ºæ ¼åˆ†éš”å¼€çš„ï¼Œè€Œä¸”ç”±äºä¸­å›½æ–‡åŒ–çš„åšå¤§ç²¾æ·±ï¼Œåˆ‡è¯çš„æ—¶å€™æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„è¯è¯­ç»„åˆæƒ…å†µå°±æ›´å¤šäº†ã€‚æ˜¾ç„¶è®©æˆ‘ä»¬è‡ªå·±å»é€ ä¸€ä¸ªè¿™æ ·çš„è½®å­æœ‰ç‚¹ä¸ç°å®ï¼Œå…¶å®åƒè¿™æ ·çš„å·¥å…·ï¼Œå‰è¾ˆä»¬å·²ç»ä¸ºæˆ‘ä»¬åšå¥½äº†ï¼Œè€Œä¸”è¶…å¥½ç”¨ã€‚ æœ¬æ–‡ä»‹ç»çš„å°±æ˜¯jiebaä¸­æ–‡åˆ†è¯ï¼Œæ­£å¦‚å®ƒçš„å£å·é‚£æ ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å½“ç„¶ï¼Œè¿™é‡Œæœ‰ä¸¤æœ¬ç§˜ç±GitHub &amp;&amp; OSChinaï¼Œæ—¢ç„¶ä½ æˆ‘æœ‰ç¼˜ï¼Œä¾¿å…è´¹èµ äºˆä½ ã€‚ å®‰è£… è¿™å¹´å¤´ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸€å¥pip install è§£å†³ä¸äº†çš„ã€‚ä¸ç®¡2æˆ–è€…3ï¼Œç›´æ¥pipå³å¯ã€‚ 1pip install jieba ç»“åˆå®˜æ–¹Demoç†è§£jiebaçš„ä¸‰ç§åˆ‡è¯æ¨¡å¼ ä¸‰ç§æ¨¡å¼ï¼š ç²¾ç¡®æ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ï¼šå®ƒä¼šè¯•å›¾å°†å¥å­æœ€ç²¾ç¡®çš„åˆ‡å¼€ï¼Œé€‚åˆæ–‡æœ¬åˆ†æã€‚ å…¨æ¨¡å¼ï¼šä¸è€ƒè™‘æ­§ä¹‰ï¼Œè¿™ä¸ªæ¨¡å¼ä¼šå°†æ‰€æœ‰çš„å¯ä»¥æˆè¯çš„è¯è¯­éƒ½æ‰«æå‡ºæ¥ï¼Œå› è€Œé€Ÿåº¦ä¼šéå¸¸å¿«ã€‚ æœç´¢å¼•æ“æ¨¡å¼ï¼šè¯¥æ¨¡å¼æ˜¯åœ¨ç²¾ç¡®æ¨¡å¼çš„åŸºç¡€ä¸Šï¼Œå¯¹é•¿è¯å†è¿›è¡Œåˆ‡åˆ†ï¼Œæé«˜å¬å›ç‡ï¼Œé€‚ç”¨äºæœç´¢å¼•æ“åˆ†è¯ã€‚ å®˜æ–¹Demoï¼š 12345678910111213import jiebaseg_list = jieba.cut(&quot;æˆ‘æ¥åˆ°åŒ—äº¬æ¸…åå¤§å­¦&quot;, cut_all=True)print(&quot;å…¨æ¨¡å¼: &quot; + &quot;/ &quot;.join(seg_list)) # å…¨æ¨¡å¼seg_list = jieba.cut(&quot;æˆ‘æ¥åˆ°åŒ—äº¬æ¸…åå¤§å­¦&quot;, cut_all=False)print(&quot;ç²¾ç¡®æ¨¡å¼: &quot; + &quot;/ &quot;.join(seg_list)) # ç²¾ç¡®æ¨¡å¼seg_list = jieba.cut(&quot;ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦&quot;) # é»˜è®¤æ˜¯ç²¾ç¡®æ¨¡å¼print(&quot;é»˜è®¤æ¨¡å¼ï¼š&quot; + &quot;/ &quot;.join(seg_list))seg_list = jieba.cut_for_search(&quot;å°æ˜ç¡•å£«æ¯•ä¸šäºä¸­å›½ç§‘å­¦é™¢è®¡ç®—æ‰€ï¼Œååœ¨æ—¥æœ¬äº¬éƒ½å¤§å­¦æ·±é€ &quot;) # æœç´¢å¼•æ“æ¨¡å¼print(&quot;æœç´¢å¼•æ“æ¨¡å¼ï¼š&quot; + &quot;/ &quot;.join(seg_list)) ç»“æœï¼š æ¨¡å¼åˆ†æï¼š è¿™é‡Œæˆ‘ä»¬å…ˆåˆ†æè¿™ä¸‰ç§æ¨¡å¼ï¼Œå¯¹äºcutæ–¹æ³•çš„è®²è§£åœ¨åè¾¹ä¼šç»™å‡ºï¼Œsoä¸è¦é—®æˆ‘ä¸ºå•¥ä¸ç»™å‡ºcutæ–¹æ³•ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°HMMã€‚ é€šè¿‡å¯¹æ¯”å‰ä¸¤æ¡è¾“å‡ºå¯ä»¥çœ‹å‡ºå…¨æ¨¡å¼æƒ…å†µä¸‹ï¼Œå®ƒä¼šæ‰¾å‡ºæ‰€æœ‰å¯ä»¥ç»„æˆè¯çš„åˆ’åˆ†ï¼Œè€Œç²¾ç¡®æ¨¡å¼ä¸å…¶å¯¹æ¯”ç»™å‡ºçš„ç­”æ¡ˆå°±ä¼šå¾ˆæ¸…çˆ½ã€‚æ‰€ä»¥ç»“åˆä¸Šæ–‡æ‰€è¯´ï¼Œä¸éš¾ç†è§£è¿™ä¸¤ä¸ªæ¨¡å¼çš„åŒºåˆ«ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ç¬¬å››æ¡è¾“å‡ºï¼Œå®ƒæ˜¯åœ¨ç²¾ç¡®æ¨¡å¼çš„åŸºç¡€ä¸Šå¯¹é•¿è¯å†åšçš„åˆ’åˆ†ã€‚æ‰€ä»¥â€˜æ—¥æœ¬äº¬éƒ½å¤§å­¦â€™ï¼Œå®ƒä¼šå†æ¬¡åˆ‡åˆ†ä¸ºâ€˜æ—¥æœ¬â€™ï¼Œâ€˜äº¬éƒ½â€™ï¼Œâ€˜å¤§å­¦â€™ä¸‰ä¸ªè¯ï¼ŒåŒç†é€‚ç”¨äºâ€˜ä¸­å›½ç§‘å­¦é™¢â€™ã€‚æ‰€ä»¥è¿™ä¸ªæ¨¡å¼ä¹Ÿä¸éš¾ç†è§£å§ã€‚ è¡¥å……åˆ†æï¼š æœ€åçœ‹ç¬¬ä¸‰æ¡è¾“å‡ºå†…å®¹ï¼Œä¹Ÿè®¸ä½ ä¼šé—®ï¼Œæ—¢ç„¶çŸ¥é“é»˜è®¤æ¨¡å¼æ˜¯ç²¾ç¡®æ¨¡å¼äº†ï¼Œä¸ºå•¥è¿˜è¦ç»™å‡ºè¯•ä¾‹ï¼Œå†µä¸”è¿˜æ˜¯ä¸€ä¸ªä¸å…·æœ‰å¯¹æ¯”æ€§è´¨çš„å¯¹æ¯”ã€‚è¿™é‡Œå…¶å®æƒ³è¯´æ˜çš„æ˜¯ï¼š â€˜æ­ç ”â€™å¹¶æ²¡æœ‰åœ¨è¯å…¸ä¸­ï¼Œä½†æ˜¯jiebaçš„Viterbiç®—æ³•ä¹Ÿå°†å…¶è¯†åˆ«äº†å‡ºæ¥ã€‚ è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘HMMè¿™ä¸ªå‚æ•°äº†ï¼Œå…³äºHMMï¼ˆHidden Markov Modelï¼ŒHMMï¼šéšé©¬å°”å¯å¤«æ¨¡å‹ï¼‰ï¼Œå¦‚æœæ·±ç©¶ï¼Œé‚£å°±éœ€è¦å¦å¤–ä¸€ç¯‡åšæ–‡äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦èƒ½ç†è§£å®˜æ–¹ç»™å‡ºçš„è¿™å¥è¯å³å¯ï¼šå¯¹äºæœªç™»å½•è¯ï¼Œé‡‡ç”¨äº†åŸºäºæ±‰å­—æˆè¯èƒ½åŠ›çš„ HMM æ¨¡å‹ï¼Œä½¿ç”¨äº† Viterbi ç®—æ³•ã€‚ å¯èƒ½è¯´çš„æ¯”è¾ƒå¹²æ¶©ï¼Œæˆ‘ä»¬å®é™…æµ‹ä¸€ä¸‹å§ã€‚ è¡¥å……æµ‹è¯•ä»£ç ï¼š 1234567import jiebaseg_list = jieba.cut(&quot;ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦&quot;,HMM=False)print(&quot;HMMä¸ºFalseï¼š&quot; + &quot;/ &quot;.join(seg_list))seg_list = jieba.cut(&quot;ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦&quot;,HMM=True)print(&quot;HMMä¸ºTrueï¼š&quot; + &quot;/ &quot;.join(seg_list)) è¡¥å……æµ‹è¯•ç»“æœï¼š æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨cutæ–¹æ³•ï¼Œä¸ç”¨è€ƒè™‘HMMè¿™ä¸ªå‚æ•°å°±å¯ä»¥ï¼Œè®©å®ƒé»˜è®¤ä¸ºTrueå³å¯ï¼Œè®©Viterbiç®—æ³•ä¸ºæˆ‘ä»¬è¯†åˆ«æ–°è¯ã€‚HMMä¹Ÿèƒ½æœ‰æ•ˆçš„è§£å†³ä¸­æ–‡ä¸­çš„æ­§ä¹‰é—®é¢˜ã€‚ å¯ç”¨HMMå¹¶ä¸é€‚ç”¨æ‰€æœ‰æƒ…å†µï¼Œæ ¹æ®éœ€è¦å¼€å¯ï¼ï¼ï¼ å…³äºåˆ‡è¯çš„æ–¹æ³•ä»¥åŠåˆ‡è¯çš„æ³¨æ„äº‹é¡¹ï¼Œè¯·å¤§å®¶å‚è€ƒä¸Šæ–‡ç»™å‡ºçš„ä¸¤ä¸ªé“¾æ¥ï¼Œè¿™é‡Œæˆ‘ä¸å†èµ˜è¿°ã€‚ åŸºäºTF-IDFçš„å…³é”®è¯æå– ç›¸å…³çŸ¥è¯†ï¼š å¯¹äºä¸€ä¸ªæ–‡æ¡£ï¼Œæˆ‘ä»¬è‚¯å®šä¸ä¼šå¯¹æ‰€æœ‰çš„è¯è¿›è¡Œèšç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹æ–‡æ¡£è¿›è¡Œå…³é”®è¯æå–ã€‚ ä¸‹é¢æˆ‘ä»¬å¯¹TF-IDFåšä¸€ä¸‹ç®€å•çš„è¯´æ˜ã€‚å¦‚æœå•è®²è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œæ‹¿å‡ºæ¥åˆæ˜¯ä¸€ç¯‡åšæ–‡ã€‚ä¸è¿‡åç»­æˆ‘ä¹Ÿä¼šå†™ä¸€ç¯‡å…³äºå®ƒçš„åšæ–‡ã€‚æš‚æ—¶è¯·å¤§å®¶è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™å­¦ä¹ ã€‚ TF-IDFæ˜¯ä¸€ç§ç»Ÿè®¡æ–¹æ³•ï¼Œç”¨äºè¯„ä¼°ä¸€ä¸ªè¯å¯¹äºä¸€ä¸ªæ–‡ä»¶é›†æˆ–è€…è¯­æ–™åº“ä¸­çš„ä¸€ä»½æ–‡ä»¶çš„é‡è¦ç¨‹åº¦ã€‚ TF(term frequency)ï¼šæŒ‡çš„æ˜¯æŸä¸€ä¸ªç»™å®šçš„è¯è¯­åœ¨è¯¥æ–‡ä»¶ä¸­å‡ºç°çš„é¢‘ç‡ã€‚å…¬å¼å¦‚ä¸‹ï¼š \\(tf_i,_j = \\frac{n_i,_j}{\\sum_k n_k,_j}\\) IDF(Inverse document frequency)ï¼šæ˜¯ä¸€ä¸ªè¯è¯­æ™®éé‡è¦æ€§çš„åº¦é‡ã€‚æŸä¸€ç‰¹å®šè¯è¯­çš„IDFï¼Œå¯ä»¥ç”±æ€»æ–‡ä»¶æ•°ç›®é™¤ä»¥åŒ…å«è¯¥è¯è¯­ä¹‹æ–‡ä»¶çš„æ•°ç›®ï¼Œå†å°†å¾—åˆ°çš„å•†å–å¯¹æ•°å¾—åˆ°ï¼š \\(idf(t,D) = log(\\frac{N}{\\lvert {d \\in D, t \\in d}\\rvert})\\) å…³é”®è¯æå–ï¼š å®˜æ–¹ç»™äº†ä¸€ä¸ªä»£ç ç¤ºä¾‹æ–‡ä»¶ï¼Œæºä»£ç åœ¨è¿™é‡Œï¼šå…³é”®è¯æå–æºç  ä½†æ˜¯ä¸ºäº†ç»“æœæ˜¾ç¤ºå¾—æ›´æ¸…æ™°ä¸€ç‚¹ï¼Œæˆ‘åšäº†äº›è®¸çš„æ”¹åŠ¨ï¼š 12345678910111213141516171819202122232425262728293031import syssys.path.append(&apos;../&apos;)import jiebaimport jieba.analysefrom optparse import OptionParserUSAGE = &quot;usage: python extract_tags.py [file name] -k [top k]&quot;parser = OptionParser(USAGE)parser.add_option(&quot;-k&quot;, dest=&quot;topK&quot;)opt, args = parser.parse_args()if len(args) &lt; 1: print(USAGE) sys.exit(1)file_name = args[0]if opt.topK is None: topK = 20else: topK = int(opt.topK)content = open(file_name, &apos;rb&apos;).read()tags = jieba.analyse.extract_tags(content, topK=topK,withWeight=True)for i in tags : print(i) å…ˆè¯´ä¸‹ç”¨æ³•ï¼Œå®˜æ–¹åœ¨æ–‡ä»¶çš„ç¬¬8è¡Œç»™å‡ºäº†ç”¨æ³•ï¼Œå³ï¼š 1python extract_tags.py [file name] -k [top k] å°†è¿™ä¸ªExtract_tags.pyæ–‡ä»¶å’Œæ–‡æœ¬æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œç„¶åç»™åˆ©ç”¨å¦‚ä¸Šå‘½ä»¤ä¾¿å¯å¾—åˆ°æ–‡æœ¬çš„å…³é”®è¯ã€‚é»˜è®¤å–å¾—æ˜¯top10ï¼Œæˆ‘æ”¹äº†ä¸‹å–äº†top20ï¼Œæˆ‘ä»¬è¿™é‡Œåšä¸‹æµ‹è¯•ï¼ˆä½¿ç”¨jiebaçš„å®˜æ–¹æµ‹è¯•æ–‡æ¡£ï¼šã€Šå›´åŸã€‹ï¼‰ï¼Œç»“æœå¦‚ä¸‹ï¼š åˆ†æï¼š å®˜æ–¹ç»™çš„ä»£ç çœ‹ç€æŒºé•¿ï¼Œå®é™…ä¸Šè¶…ç®€å•ï¼Œå…¶ä¸­é‡è¦çš„æ— éä¸¤å¥è¯ï¼Œä¸€å¥æ˜¯è¯»æ–‡ä»¶ï¼Œå¦ä¸€å¥åˆ™æ˜¯è°ƒç”¨extract_tags()æ–¹æ³•ï¼Œæˆ‘åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šè®¾ç½®äº†withWight=Trueï¼Œå› è€Œè¿”å›äº†ä¸€ä¸ªæƒé‡å€¼ã€‚å¤§å®¶å¦‚æœå«Œéº»çƒ¦å¯ä»¥å¯¹ä¸Šè¿°å…³é”®ä»£ç è¿›è¡ŒæŠ½å–ï¼Œå†™ä¸€ä¸ªè‡ªå·±çš„æµ‹è¯•ã€‚ æ­£å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œâ€˜è‡ªå·±â€™ã€â€˜çŸ¥é“â€™ã€â€˜å…ˆç”Ÿâ€™ç­‰ç­‰ç­‰ç­‰ï¼Œåƒè¿™äº›è¯è¯­éƒ½æ˜¯äº›æ²¡æœ‰å®é™…æ„ä¹‰çš„å•è¯ï¼Œæ‰€ä»¥åœ¨èšç±»çš„æ—¶å€™è¿™äº›å•è¯ä¸åº”è¯¥åšä¸ºèšç±»ï¼ˆæˆ–è€…åˆ†ç±»ï¼‰çš„æ ‡å‡†ï¼Œå®ƒä»¬å±äºstop_wordsï¼Œä¸­æ–‡çš„æ„æ€å°±æ˜¯åœç”¨è¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚ å»é™¤åœç”¨è¯ å»é™¤åœç”¨è¯ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å“ªäº›å±äºåœç”¨è¯ï¼Œæˆ‘åœ¨CSDNä¸Šæ‰¾åˆ°äº†ä¸€ä¸ª1893è§„æ¨¡çš„åœç”¨è¯è¡¨ï¼Œé“¾æ¥å¦‚ä¸‹ï¼šæœ€å…¨ä¸­æ–‡åœç”¨è¯è¡¨æ•´ç†ï¼ˆ1893ä¸ªï¼‰ã€‚ æˆ‘ä»¬æ¥ä¸‹æ¥çš„å·¥ä½œæ€è·¯æ˜¯è¿™æ ·çš„ï¼Œå¯¹ã€Šå›´åŸã€‹ï¼ˆæ–‡ä»¶1.txtï¼‰è¿›è¡Œåˆ‡è¯ï¼Œæ–¹æ³•å°±æ˜¯ä¹‹å‰çš„cut()ï¼Œè¯»å–StopWordsæ–‡ä»¶ï¼Œå¯¹æ¯”æ¯ä¸ªåˆ‡åˆ†å‡ºæ¥çš„å•è¯æ˜¯å¦æ˜¯åœç”¨è¯ï¼Œå¦‚æœä¸æ˜¯åˆ™åŠ å…¥åˆ°ä¸€ä¸ªlistä¸­ï¼Œç„¶åå†å°†è¿™ä¸ªlistçš„å†…å®¹å­˜åˆ°å¦ä¸€ä¸ªæ–‡ä»¶2.txtä¸­ï¼Œå¯¹æ–‡ä»¶2.txtä½¿ç”¨ä¹‹å‰è¯´åˆ°çš„å®˜æ–¹ç»™çš„å…³é”®è¯æå–æ–‡ä»¶åšå…³é”®è¯æå–å³å¯ã€‚ å»é™¤åœç”¨è¯ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031import sysimport jiebafrom os import pathd = path.dirname(__file__) # è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„stopwords_path = &apos;stopwords1893.txt&apos; # åœç”¨è¯è¡¨è·¯å¾„text_path = &apos;txt/1.txt&apos; #ã€Šå›´åŸã€‹çš„æ–‡æœ¬è·¯å¾„text = open(path.join(d, text_path),&apos;rb&apos;).read()def RmStopWords(text): mywordlist = [] seg_list = jieba.cut(text, cut_all=False) liststr=&quot;/ &quot;.join(seg_list) # æ·»åŠ åˆ‡åˆ†ç¬¦ f_stop = open(stopwords_path) try: f_stop_text = f_stop.read() finally: f_stop.close( ) f_stop_seg_list=f_stop_text.split(&apos;\\n&apos;) # åœç”¨è¯æ˜¯æ¯è¡Œä¸€ä¸ªï¼Œæ‰€ä»¥ç”¨/nåˆ†ç¦» for myword in liststr.split(&apos;/&apos;): #å¯¹äºæ¯ä¸ªåˆ‡åˆ†çš„è¯éƒ½å»åœç”¨è¯è¡¨ä¸­å¯¹æ¯” if not(myword.strip() in f_stop_seg_list) and len(myword.strip())&gt;1: mywordlist.append(myword) return &apos;&apos;.join(mywordlist) #è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²txt2 = RmStopWords(text)text_write = &apos;txt/2.txt&apos;with open(text_write,&apos;w&apos;) as f: f.write(txt2) print(&quot;Success&quot;) ç»“æœï¼š åˆ†æï¼š ç”±ä¸Šå›¾å¯è§ï¼Œæˆ‘ä»¬çš„å»åœç”¨è¯çš„æ•ˆæœè¿˜ä¸é”™ã€‚ æœ€åï¼š è¿™ç¯‡åšå®¢å…ˆå†™åˆ°è¿™é‡Œï¼Œä¸‹ä¸€ç¯‡åšå®¢æˆ‘ä¼šè®²åˆ°jiebaä¸­æ–‡åˆ†è¯çš„è¿›é˜¶ç¯‡ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœ‰é—®é¢˜å¯ä»¥é€šè¿‡é‚®ä»¶ä¸æˆ‘äº¤æµï¼Œé‚®ç®±ï¼šcliugeek@us-forever.com","categories":[{"name":"æ–‡æœ¬èšç±»","slug":"æ–‡æœ¬èšç±»","permalink":"http://weafteam.github.io/categories/æ–‡æœ¬èšç±»/"}],"tags":[{"name":"æ–‡æœ¬èšç±»","slug":"æ–‡æœ¬èšç±»","permalink":"http://weafteam.github.io/tags/æ–‡æœ¬èšç±»/"}]},{"title":"MySQLä¸»ä»æ•°æ®åº“çš„è®¾ç½®ä¸Xtrabackupå¤‡ä»½InnoDB(MySQL)","slug":"2018-03-12/linux-mysql","date":"2018-03-17T08:08:56.000Z","updated":"2018-05-29T01:27:49.771Z","comments":true,"path":"posts/2f5dded6/","link":"","permalink":"http://weafteam.github.io/posts/2f5dded6/","excerpt":"ä¸€ã€å‡†å¤‡ç¯å¢ƒ ä¸¤å°æœåŠ¡å™¨ï¼šæœåŠ¡å™¨Aã€æœåŠ¡å™¨B æœåŠ¡å™¨Aï¼šRed Hat Enterprise Linux Server release 6.5 (Santiago) æœåŠ¡å™¨Bï¼šRed Hat Enterprise Linux Server release 6.5 (Santiago) æœåŠ¡å™¨A IPï¼š172.16.125.50 æœåŠ¡å™¨B IPï¼š172.16.125.52 MySQLç‰ˆæœ¬ï¼š5.6.23 äºŒã€å®‰è£…MySQL å…·ä½“å®‰è£…è¯·è§ LinuxMySQLçš„å®‰è£…(1) LinuxMySQLçš„å®‰è£…(2) LinuxMySQLçš„å®‰è£…(3)","text":"ä¸€ã€å‡†å¤‡ç¯å¢ƒ ä¸¤å°æœåŠ¡å™¨ï¼šæœåŠ¡å™¨Aã€æœåŠ¡å™¨B æœåŠ¡å™¨Aï¼šRed Hat Enterprise Linux Server release 6.5 (Santiago) æœåŠ¡å™¨Bï¼šRed Hat Enterprise Linux Server release 6.5 (Santiago) æœåŠ¡å™¨A IPï¼š172.16.125.50 æœåŠ¡å™¨B IPï¼š172.16.125.52 MySQLç‰ˆæœ¬ï¼š5.6.23 äºŒã€å®‰è£…MySQL å…·ä½“å®‰è£…è¯·è§ LinuxMySQLçš„å®‰è£…(1) LinuxMySQLçš„å®‰è£…(2) LinuxMySQLçš„å®‰è£…(3) ä¸‰ã€ä¸»ä»åº“é…ç½® 1ã€ä¸»åº“åœ¨/etc/my.cnfé‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹ 12345678910#logæ—¥å¿—log_bin=mysql_bin#server IDserver_id=2#å¿½ç•¥åŒæ­¥çš„åº“binlog-ignore-db=information_schemabinlog-ignore-db=clusterbinlog-ignore-db=mysql#éœ€è¦åŒæ­¥çš„åº“binlog-do-db=test 2ã€ä»åº“åœ¨/etc/my.cnfé‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹ 12345678910log_bin=mysql_binserver_id=3binlog-ignore-db=information_schemabinlog-ignore-db=clusterbinlog-ignore-db=mysqlreplicate-do-db=ufind_dbreplicate-ignore-db=mysqllog-slave-updatesslave-skip-errors=allslave-net-timeout=60 å››ã€ä¸»ä»åº“è®¾ç½® 1ã€è¿›å…¥ä¸»åº“ï¼Œæˆ‘ä»¬åœ¨ä¸»åº“ä¸­åˆ›å»ºä¸€ä¸ªçš„è´¦æˆ·ï¼Œä»åº“é€šè¿‡ä½¿ç”¨è¿™ä¸ªè´¦å·æ¥åŒæ­¥æ•°æ®ã€‚ 1CREATE USER 'repl'@'172.16.125.52' IDENTIFIED BY '123456'; 2ã€èµ‹äºˆç›¸åº”çš„æƒé™ 12345GRANT FILE ON *.* TO 'repl'@'172.16.125.52' IDENTIFIED BY '123456';GRANT REPLICATION SLAVE ON *.* TO 'repl'@'172.16.125.52' IDENTIFIED BY '123456';FLUSH PRIVILEGES; 3ã€é‡å¯æ•°æ®åº“ï¼ˆä¸»åº“ï¼‰æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ 1SHOW MASTER STATUS; è¦è®°ä½ä»¥ä¸Šçš„ä¿¡æ¯ï¼Œåœ¨è®¾ç½®ä»åº“çš„æ—¶å€™éœ€è¦å¡«å†™å¹¶è®¾ç½®ã€‚ 4ã€åœ¨ä»åº“é‡Œè¾¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ 123stop slave;change master to master_host=&apos;172.16.125.50&apos;,master_user=&apos;repl&apos;,master_password=&apos;123456&apos;,master_log_file=&apos;mysql_bin.000023&apos;, master_log_pos=120;start slave; 5ã€ç„¶åæ‰§è¡Œä¸€ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€ 1show slave status \\G; å†…å®¹å¦‚ä¸‹ï¼š 6ã€æµ‹è¯•ä¸æç¤º åæœŸçš„æµ‹è¯•ä¸­æˆ‘ä»¬åªé’ˆå¯¹teståº“è¿›è¡Œäº†åŒæ­¥ã€‚ æ‰€ä»¥åªèƒ½é’ˆå¯¹testè¿›è¡Œçš„æ“ä½œæ‰æœ‰æ•ˆã€‚ å¦‚æœåæœŸå¯¹ä¸€äº›åˆ—åº“è¿›è¡Œæ“ä½œï¼Œéœ€è¦ æ·»åŠ ç›¸åº”çš„é…ç½® 1234#ä¸»åº“é…ç½®æ–‡ä»¶binlog-do-db=test#ä»åº“é…ç½®æ–‡ä»¶replicate-do-db=test å¹¶æŸ¥è¯¢å‡ºæœ€æ–°çš„masterçš„çŠ¶æ€ï¼Œåœæ­¢ä»åº“ã€‚å¹¶æ”¹å˜ä»åº“çš„é…ç½®é‡å¯åŒæ­¥ã€‚ äº”ã€Xtrabackupçš„ç®€å•ä»‹ç» â€”â€”â€”â€”â€”â€”- Percona XtraBackup æ˜¯ä¸–ç•Œä¸Šå”¯ä¸€çš„å¼€æºå…è´¹çš„MySQLçƒ­å¤‡ä»½è½¯ä»¶ï¼Œå¯ä»¥æ‰§è¡Œéé˜»å¡æ“ä½œ InnoDBå’ŒXtraDBæ•°æ®åº“çš„å¤‡ä»½ã€‚ Percona XtraBackupå¯æä¾›ä»¥ä¸‹ä¼˜ç‚¹ï¼š å¤‡ä»½å¿«é€Ÿå®‰å…¨å¯é  å¤‡ä»½æœŸé—´ä¸é—´æ–­çš„äº‹åŠ¡å¤„ç† èŠ‚çœç£ç›˜ç©ºé—´å’Œç½‘ç»œå¸¦å®½ è‡ªåŠ¨å¤‡ä»½éªŒè¯ æ›´å¿«çš„æ¢å¤æ—¶é—´ä¿è¯æ­£å¸¸å·¥ä½œ Percona XtraBackup ä¸ºæ‰€æœ‰ç‰ˆæœ¬çš„PerconaæœåŠ¡å™¨ï¼ŒMySQLå’ŒMariaDBæä¾›MySQLçƒ­å¤‡ä»½ã€‚ å®ƒå¯æ‰§è¡Œ æµåª’ä½“ï¼Œå‹ç¼©å’Œå¢é‡MySQLå¤‡ä»½ã€‚ å…­ã€Xtrabackupçš„å®‰è£… å¦‚æœåœ¨äº’è”ç½‘ä¸‹ å¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£… 1wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm è·å–ç›¸åº”rpmåŒ… å®‰è£…éƒ¨åˆ†ä¾èµ–(ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯èƒ½å·²å®‰è£…çš„åº“ä¸å°½ç›¸åŒ) 1234rpm -ivh mysql-community-libs-compat-5.7.20-1.el7.x86_64.rpm#æ ¹æ®mysqlç‰ˆæœ¬è€Œå®šyum list|grep perlyum -y install perl-DBI.x86_64 perl-DBD-MySQL.x86_64 ç„¶åå®‰è£…Xtrabackup 1rpm -ivh percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm å‚è€ƒï¼š 1yum install cmake gcc gcc-c++ libaio libaio-devel automake autoconf bison libtool ncurses-devel libgcrypt-devel libev-devel libcurl-devel vim-common ä¸ƒã€Xtrabackupå¤‡ä»½MySQL 12xtrabackup --defaults-file=/etc/my.cnf --user=root --password=root --host=localhost --backup --target-dir=/data/backups/å¯æŒ‡å®šæ•°æ®åº“--databases=test å…«ã€Xtrabackupçš„å¤‡ä»½æ¢å¤ å¤‡ä»½ä¹‹å‰å¿…é¡»å…ˆå…³é—­MySQL server ç„¶ååˆ é™¤dataç›®å½•ï¼ˆ/var/lib/mysqlä¸€èˆ¬æƒ…å†µæ˜¯è¿™ä¸ªï¼‰ 1xtrabackup --copy-back --target-dir=/data/backups/ æ‰§è¡Œå®Œæ¢å¤ä¹‹åéœ€è¦è®¾ç½®æ–‡ä»¶æƒé™ 1chown -R mysql:mysql /var/lib/mysql ç„¶åå¯åŠ¨mysql 123systemctl start mysqld.service#æˆ–è€…ä½¿ç”¨æœåŠ¡service mysqld start ä¹ã€ä½¿ç”¨è„šæœ¬è‡ªåŠ¨å¤‡ä»½7å¤©ä¹‹å†…çš„æ•°æ® 12345678910111213141516171819202122#!/bin/sh# Database infoDB_USER=\"root\"DB_PASS=\"root\"DB_HOST=\"localhost\"# Others varsBCK_DIR=\"/opt/app/mysqlbackup\" #the backup file directoryCONF_DIR=\"/etc/my.cnf\"DATE=`date +%F`RMDATE=`date -d '-7 day' +%F`# TODOmkdir -p $BCK_DIR/$DATE/#Create dir for save backup dataxtrabackup --defaults-file=$CONF_DIR --user=$DB_USER --password=$DB_PASS --host=$DB_HOST --backup --target-dir=$BCK_DIR/$DATE/#Backup mysql datarm -rf $BCK_DIR/$RMDATE#Delete the backup 7 days ago#çƒ­å¤‡ä»½æ•°æ®åº“ åŠ å…¥crontab 130 2 * * * /bin/sh /home/scripts/mysqlbackup.sh æ›´å¤šè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£","categories":[{"name":"Linux","slug":"Linux","permalink":"http://weafteam.github.io/categories/Linux/"}],"tags":[{"name":"Linuxè¿ç»´","slug":"Linuxè¿ç»´","permalink":"http://weafteam.github.io/tags/Linuxè¿ç»´/"}]},{"title":"chapter-01-AIR","slug":"2018-03-12/TensorFlowå®‰è£…è¯¦è§£","date":"2018-03-14T10:49:23.000Z","updated":"2018-05-29T01:27:49.767Z","comments":true,"path":"posts/8e8e4531/","link":"","permalink":"http://weafteam.github.io/posts/8e8e4531/","excerpt":"","text":"ç¬¬ä¸€ç¯‡æ–‡ç« -TensorFlow Install é¦–å…ˆä»‹ç»ä¸€äº›æˆ‘ä»¬è¿™ä¸ªç»„ç»‡ï¼Œè¿™æ˜¯æœ‰å››ä¸ªäººæ„æˆå¾—ä¸€ä¸ªç»„ç»‡ï¼Œç»„ç»‡å¯ä»¥å«FOUR ELEMENTSã€‚ï¼ˆä¹Ÿå¯ä»¥å«WEAFï¼‰åˆ†åˆ«å¯¹åº”WELLã€EARTHã€AIRã€FLAMEã€‚ï¼ˆWEAFï¼‰ã€‚ å…¶æ¬¡æˆ‘æƒ³åšä¸€ä¸‹è‡ªæˆ‘ä»‹ç»ï¼Œæˆ‘çš„è‹±æ–‡å­¦åå«milittleã€‚æˆ‘å¼€è®¾çš„è¿™ä¸ªå‘¨åˆŠåå­—å«AIR-å‘¨åˆŠã€‚å¸Œæœ›æŠŠè‡ªå·±å­¦ä¹ çš„ä¸€äº›å†…å®¹åˆ†äº«ç»™å¤§å®¶ï¼Œä¹Ÿæ¿€åŠ±è‡ªå·±ã€‚å­¦æ›´å¤šçš„çŸ¥è¯†ã€‚ä»¥åå¤§å®¶æœ‰ä»€ä¹ˆè¦äº¤æµçš„ï¼Œä¹Ÿå¯ä»¥ä¸€èµ·äº¤æµã€‚ï¼ˆé‚®ç®±åœ°å€ä¼šåœ¨æ–‡ç« æœ«å°¾ç»™å‡ºï¼‰ æ¥ä¸‹æ¥æˆ‘è®²ä¸€ä¸‹æˆ‘åç»­æ¯å‘¨åœ¨AIR-å‘¨åˆŠé‡Œé¢ä¼šè®²åˆ°çš„å†…å®¹ï¼š ä¸»è¦æ¶‰åŠTensorFlowæ¡†æ¶ä½¿ç”¨å¤šä¸€äº› åç»­ä¹Ÿä¼šåˆ†äº«ä¸€äº›æœºå™¨å­¦ä¹ æ–¹é¢çš„ç®—æ³• ä¹Ÿä¼šæœ‰ä¸€äº›åœ¨äººå·¥æ™ºèƒ½æ–¹é¢çš„æ‚è°ˆ ä¸Šé¢è¯´äº†ä¸€äº›ï¼Œæˆ‘æƒ³æŠŠè¿™å—åšå¥½ï¼Œæ–‡ç« å†…å®¹æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œåç»­çš„æ–‡ç« é‡Œé¢ä¼šæœ‰æ‰€æåŠã€‚ ä»Šå¤©å°±ä»‹ç»ä¸€äº›TensorFlowçš„ç®€è¿°å’Œå®‰è£…ï¼š TensorFlowæ˜¯Googleå…¬å¸åœ¨2015å¹´12æœˆä»½å¼€æºçš„ä¸€ä¸ªæœºå™¨å­¦ä¹ åº“ï¼Œä»£ç é“¾æ¥TensorFLowã€‚ ç¬¬äºŒç‚¹ä¸ºä»€ä¹ˆç°åœ¨TensorFlowè¿™ä¹ˆç«ï¼Œåœ¨äººå·¥æ™ºèƒ½ç•Œå·²ç»ç®—å¾—ä¸Šæ˜¯ç§°éœ¸çš„åœ°ä½ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢çš„å›¾ä¸­å¯ä»¥çœ‹å‡ºTensorFlowçš„æ•°æ®å æ®äº†ä¸€å¤§åŠå¸‚åœºã€‚ åŸå› æ˜¯ä»€ä¹ˆå‘¢ æœ€ä¸»è¦çš„åŸå› å°±æ˜¯æœ¬èº«å…·æœ‰å›¾è¿ç®—çš„è¿™ä¸ªæ¦‚å¿µã€‚ä½¿ç”¨ç®€å•ï¼Œè€Œä¸”å¯ä»¥è®©ç¨‹åºå‘˜å¿«æ·çš„å®ç°ä¸€äº›ç®—æ³•ã€‚ä»è€Œå¯ä»¥ç”¨TensorFlowè§£å†³ä¸€äº›ç°å®ä¸­çš„é—®é¢˜ã€‚å›¾è¿ç®—çš„æ¦‚å¿µæˆ‘ä»¬åç»­ä¼šæ…¢æ…¢æ·±å…¥ã€‚å¤§å®¶ä¸è¦ç€æ€¥ã€‚ è¿˜æœ‰ä¸€ä¸ªåŸå› ï¼Œæˆ‘æƒ³ä¸ç”¨è¯´å¤§å®¶ä¹Ÿéƒ½çŸ¥é“ï¼Œæ—¢ç„¶è¯´äº†æ˜¯Googleçš„å¼€æºæ¡†æ¶ï¼Œé‚£ä¹ˆæŠ€æœ¯å°±ä¸€å®šå¾ˆç‰›é€¼ã€‚å¼•å¾—å¹¿å¤§ç¨‹åºå‘˜çš„å–œçˆ±ä¹Ÿæ˜¯å¿…ç„¶å‘ç”Ÿçš„äº‹æƒ…ã€‚ è€Œä¸”ç”¨è¿™ä¸ªæ¡†æ¶å¯ä»¥å¿«é€Ÿçš„è§£å†³ä¸€äº›æœºå™¨å­¦ä¹ çš„ç®—æ³•é—®é¢˜ã€‚æ˜¯çš„ç¼–ç¨‹æ•ˆç‡ä¹Ÿä¸æ–­æé«˜ã€‚ TensorFlowæ”¯æŒMacã€Windowsã€Linuxã€‚ä»¥åæˆ‘ä»¬çš„å®éªŒæœ‰å¯èƒ½é€šè¿‡Windowsè¿›è¡Œï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨Linuxè¿›è¡Œï¼Œè€Œä¸”ä»¥åçš„ä»£ç éƒ½æ˜¯åŸºäºpython3.Xï¼Œæ‰€ä»¥å¸Œæœ›å¤§å®¶å¯ä»¥å®ç°åŸºæœ¬çš„python3çš„è¯­æ³•çŸ¥è¯†å’Œç¼–ç¨‹çŸ¥è¯†ã€‚è¿˜æœ‰å°±æ˜¯TensorFlowæ”¯æŒCPUç‰ˆæœ¬å’ŒGPUç‰ˆæœ¬ï¼Œå®‰è£…çš„æ—¶å€™éƒ½æœ‰å¾ˆå¤šçš„æ³¨æ„äº‹é¡¹ï¼ŒåŸºäºGPUç‰ˆæœ¬çš„å¯èƒ½ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚ä½†æ˜¯åç»­æˆ‘ä¼šç»™å¤§å®¶å‡ºä¸€ä¸ªæ•™ç¨‹ï¼Œåˆ†åˆ«åœ¨Windowsä¸‹é¢å’ŒLinuxä¸‹é¢é…ç½®è‡ªå·±çš„ç‹¬ç«‹ç¯å¢ƒã€‚è®©ä½ çš„æœºå™¨å­¦ä¹ ç®—æ³•è·‘åœ¨ä½ è‡ªå·±çš„æœºå™¨ä¸Šé¢ã€‚å®Œæˆä¸€äº›çœ‹èµ·æ¥ç‚«é…·çš„ç¨‹åºã€‚ æ¥ä¸‹æ¥æˆ‘ä»‹ç»ä¸€ä¸‹TensorFlowçš„Windows CPUå®‰è£…æ–¹æ³•ï¼š é¦–å…ˆæ‰“å¼€ç”µè„‘ï¼Œè¿™ä¸ªæ˜¯ä¸€å®šçš„~ å»TensorFlowçš„å®˜ç½‘ä¸‹è½½Windowsçš„ç‰ˆæœ¬ã€‚ç‚¹å‡»ä¸‹é¢çº¢è‰²ç®­å¤´çš„åœ°æ–¹â€”éšæ„ï¼Œéƒ½å¯ä»¥è·³è½¬åˆ°ä¸€ä¸ªå…³äºwindowså®‰è£…çš„ç•Œé¢ã€‚ï¼ˆå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œé€ƒï¼‰ ç‚¹å¼€ç•Œé¢ä»¥åçš„æ³¨æ„äº‹é¡¹ï¼š windows7åŠå…¶ä»¥åçš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬ å†³å®šå®‰è£…å“ªä¸ªTensorFlowçš„ç‰ˆæœ¬ï¼ŒGPUè¿˜æ˜¯CPUï¼ˆGPUä¼šæœ‰æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„åº“ä¾èµ–ï¼ŒCUDAï¼‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çš„æ•™ç¨‹æ˜¯CPUç‰ˆæœ¬å®‰è£…ã€‚ å†³å®šæ€ä¹ˆå®‰è£…TensorFlowï¼šå¯é€‰æ–¹å¼æœ‰native pip å’Œ Anacondaç­‰ï¼ˆæˆ‘ä»¬ä½¿ç”¨Anacondaï¼‰ æœ€åä¸€æ­¥éªŒè¯ä½ çš„å®‰è£…æ•ˆæœ æ¥ä¸‹æ¥ä¸€æ­¥ä¸€æ­¥æ¥ï¼š ç¬¬ä¸€æ­¥ã€æˆ‘ä»¬å†³å®šç”¨Anacondaæ¥å®‰è£…TensorFlowï¼Œä½ è¦çŸ¥é“Anacondaæ˜¯ä»€ä¹ˆå‘¢ï¼Œå®ƒå°±æ˜¯å¯ä»¥å¾ˆå¥½çš„ç®¡ç†pythonçš„ä¸€äº›ä¾èµ–åº“ã€‚è®©ä½ åœ¨ä¸åŒpythonç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢è‡ªå¦‚ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥å®‰è£…æˆ‘ä»¬çš„TensorFlowã€‚Anacondaä¹Ÿå¯ä»¥é›†æˆSpyderè¿™äº›ç¼–ç¨‹å·¥å…·ï¼Œä½¿å¾—ä½ ç¼–å†™ä»£ç ä¼šæ–¹ä¾¿ä¸€äº›ã€‚ ç¬¬äºŒæ­¥ã€é¦–å…ˆä½ å»Anacondaå®˜ç½‘ä¸‹è½½windowsç‰ˆæœ¬çš„Anacondaï¼Œå…·ä½“å®‰è£…å°±å’Œæ™®é€šçš„å®‰è£…è½¯ä»¶ç±»ä¼¼ã€‚è¿™ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒpythonç‰ˆæœ¬éœ€è¦ä¸åŒçš„Anacondaï¼Œåˆ«ä¸‹é”™äº†ã€‚ ç¬¬ä¸‰æ­¥ã€å®‰è£…å¥½ä»¥åï¼Œæˆ‘ä»¬æ‰“å¼€Anacondaçš„æ§åˆ¶å°ï¼Œå°±æ˜¯å¼€å§‹é‡Œé¢æ‰¾åˆ°Anacondaçš„åº”ç”¨ï¼Œç„¶åé‡Œé¢æœ‰ä¸€ä¸ªAnaconda Promptã€‚æ‰“å¼€ä»¥åï¼Œæˆ‘ä»¬å°±å¼€å§‹äº†æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„TensorFlowç‹¬ç«‹çš„ç¯å¢ƒã€‚ conda create -n tensorflow pip python=3.5 ä¸Šé¢è¿™å‘½ä»¤çš„æ„æ€å°±æ˜¯è¯´åœ¨Anacondaç®¡ç†çš„ç¯å¢ƒé‡Œé¢ç»™æˆ‘ç‹¬ç«‹çš„åˆ›å»ºä¸€ä¸ªpythonç¯å¢ƒæ¥ï¼Œè¿™ä¸ªé‡Œé¢pythonçš„ç‰ˆæœ¬æ˜¯3.5ã€‚æ³¨æ„ä¸€ä¸‹ï¼Œè¿™ä¸ªåœ°æ–¹è¿˜æ²¡æœ‰å®‰è£…tensorflowå‘¢ï¼Œä¸Šé¢çš„tensorflowåªä¸è¿‡æ˜¯åˆ›å»ºçš„ä¸€ä¸ªç¯å¢ƒåå­—è€Œå·²ã€‚ activate tensorflow ä¸Šé¢çš„å‘½ä»¤æ˜¯æ¿€æ´»è¿™ä¸ªtensorflowçš„ç¯å¢ƒï¼Œä½ å¯ä»¥é€šè¿‡è¿™ä¸ªç¯å¢ƒï¼Œæ·»åŠ ä¸€äº›ä½ è‡ªå·±çš„pythonåº“ï¼Œå®šåˆ¶è‡ªå·±çš„pythonç¯å¢ƒï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä½¿ç”¨Anacondaçš„åŸå› ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯åªæœ‰Anacondaæ”¯æŒè¿™æ ·çš„æ–¹å¼ã€‚ä¸è¦å’Œæˆ‘æŠ¬æ ã€‚ ç¬¬å››æ­¥ï¼Œä¹Ÿå°±æ˜¯æ­£å„¿å…«ç»çš„å®‰è£…TensorFlowçš„é˜¶æ®µï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œä¸Šé¢ä¸ºä»€ä¹ˆæˆ‘æ‰§è¡Œçš„æ˜¯tensorflow1ï¼Œå› ä¸ºæˆ‘çš„ç”µè„‘ä¸Šé¢å·²ç»æœ‰tensorflowè¿™ä¸ªç¯å¢ƒäº† pip install --ignore-installed --upgrade tensorflow è¿™ä¸ªå‘½ä»¤å°±æ˜¯ä½¿ç”¨pipæ­£å¸¸çš„å®‰è£…tensorflowï¼Œè¿™é‡Œçš„pipç®¡ç†èµ·æ¥å’Œæ™®é€šçš„pipç®¡ç†æ˜¯ä¸€ä¸ªé“ç†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚ ç¬¬äº”æ­¥ï¼Œæµ‹è¯•TensorFlowæ˜¯å¦å®‰è£…ä¸Š python ä¸Šé¢çš„å‘½ä»¤æ˜¯è¿›å…¥pythonè§£é‡Šå™¨ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„importè¯­å¥ import tensorflow as tf å¦‚æœä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œå®Œï¼Œå¦‚ä¸‹å›¾ä¸­ä¸€æ ·ï¼Œå°±ç®—å®‰è£…æˆåŠŸäº†ï¼Œä¸‹é¢çš„é‚£äº›è¯­å¥æ˜¯å†™äº†ä¸€ä¸ªhello worldï¼ï¼ï¼ ä»Šå¤©æ˜¯ä¸ºäº†æˆ‘ä»¬ä»¥ååœ¨TensorFlowä¸Šå¼€å‘æ‰€åšçš„å‡†å¤‡ã€‚å¸Œæœ›å¤§å®¶å®‰è£…é¡ºåˆ©ã€‚æˆ‘çš„ä¸ªäººé‚®ç®±æ˜¯air@weaf.topã€‚æœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥å•ç‹¬å‘é‚®ä»¶é—®æˆ‘ã€‚æ„Ÿè°¢ä½ ä»¬çš„é©»è¶³ã€‚æœ‰ä»€ä¹ˆä¸å¥½çš„åœ°æ–¹ï¼Œå¯ä»¥ç»™å‡ºæ„è§ã€‚","categories":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/categories/TensorFlow/"}],"tags":[{"name":"TensorFlow","slug":"TensorFlow","permalink":"http://weafteam.github.io/tags/TensorFlow/"}]}]}