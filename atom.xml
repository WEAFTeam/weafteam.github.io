<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>WEAF å‘¨åˆŠ</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://weafteam.github.io/"/>
  <updated>2018-08-22T14:45:52.938Z</updated>
  <id>http://weafteam.github.io/</id>
  
  <author>
    <name>WEAF</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>TensorRT-å¼€å‘å…¥é—¨</title>
    <link href="http://weafteam.github.io/posts/e0818c8b/"/>
    <id>http://weafteam.github.io/posts/e0818c8b/</id>
    <published>2018-08-12T09:56:37.000Z</published>
    <updated>2018-08-22T14:45:52.938Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorrt-å¼€å‘å…¥é—¨">TensorRT-å¼€å‘å…¥é—¨</h1><h1 id="docker-for-ubuntu-16.04å¿ƒè·¯å†ç¨‹">Docker For Ubuntu 16.04ï¼ˆå¿ƒè·¯å†ç¨‹ï¼‰</h1><h2 id="ä»¥åŠåœ¨ubuntuä¸Šdockerä¸­ä½¿ç”¨tensorrtçš„å¿ƒè·¯å†ç¨‹è¿™ä¹Ÿæ˜¯æˆ‘ä¸ºä»¥ååƒæ­å»ºå‡ºè¦ç»™å®å®åœ¨åœ¨èƒ½ç”¨çš„æ·±åº¦å­¦ä¹ åº”ç”¨è€Œåšçš„å‡†å¤‡">ä»¥åŠåœ¨Ubuntuä¸ŠDockerä¸­ä½¿ç”¨TensorRTçš„å¿ƒè·¯å†ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä¸ºä»¥ååƒæ­å»ºå‡ºè¦ç»™å®å®åœ¨åœ¨èƒ½ç”¨çš„æ·±åº¦å­¦ä¹ åº”ç”¨è€Œåšçš„å‡†å¤‡</h2><p>è¿™ç¯‡è®°å½•åœ¨Ubuntuä¸Šå®‰è£…Dockerï¼Œå¹¶ä¸”å®‰è£…nvidia-dockerçš„å¿ƒè·¯å†ç¨‹ï¼Œè¿˜æœ‰NGCï¼ˆNvidia GPU Cloud ï¼‰çš„é‡Œé¢çš„containerçš„ä½¿ç”¨ã€‚ï¼ˆå°¤å…¶æ˜¯TensorRT containerçš„ä¸€ä¸ªä½¿ç”¨ï¼‰</p><h2 id="ä¸€åœ¨ubuntuä¸Šå®‰è£…docker-ce">ä¸€ã€åœ¨Ubuntuä¸Šå®‰è£…docker-ce</h2><p>è¿™é‡Œçš„docker-ceæ˜¯dockerçš„ç¤¾åŒºç‰ˆï¼Œå› ä¸ºç¤¾åŒºç‰ˆæ˜¯ä¸æ”¶è´¹çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å·²ç»å¤Ÿç”¨äº†ã€‚å…ˆå»å®˜ç½‘ï¼Œ<a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener">Docker For Ubuntu</a> è¿™é‡Œå¯ä»¥æ‰¾åˆ°å®‰è£…çš„æ•™ç¨‹ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨debæ–‡ä»¶å®‰è£…ã€‚</p><ol type="1"><li><p>å»ï¼ˆ1ï¼‰<a href="https://download.docker.com/linux/ubuntu/dists/" target="_blank" rel="noopener">ubuntuçš„docker debæ–‡ä»¶</a>ï¼Œ æ ¹æ®ä½ çš„ubuntuçš„ç‰ˆæœ¬ï¼ŒæŸ¥çœ‹Ubuntuç‰ˆæœ¬å‘½ä»¤ï¼Œ <code>cat /etc/issue</code> ä¼šæ˜¾ç¤ºå‡ºubuntuçš„ç‰ˆæœ¬å·ï¼Œæ ¹æ®ç‰ˆæœ¬å·åœ¨è¿™ä¸ªç½‘ç«™ä¸Šï¼ˆ2ï¼‰<a href="https://blog.csdn.net/zhengmx100/article/details/78352773" target="_blank" rel="noopener">ubuntuç‰ˆæœ¬å·åå­—å¯¹åº”å…³ç³»è¡¨</a>ï¼Œ ç„¶ååœ¨ï¼ˆ1ï¼‰é“¾æ¥ä¸­æ‰¾åˆ°è‡ªå·±ç³»ç»Ÿçš„å¯¹åº”åå­—ï¼Œç‚¹è¿›å»<code>åå­—/pool/stable/</code> åˆ°äº†è¿™ä¸€çº§ç›®å½•ï¼Œå°±åˆ°äº†é€‰æ‹©ä¸»æœºä½æ•°çš„æ—¶å€™äº†ï¼Œä¸æ¸…æ¥šçš„å°ä¼™ä¼´ï¼Œä½¿ç”¨<code>cat /proc/version</code> å‘½ä»¤æŸ¥çœ‹ï¼Œæˆ‘çš„æ˜¯amd64ã€‚ï¼ˆéœ€è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯æˆ‘çš„ubuntuçš„åå­—æ˜¯xenialï¼‰ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°å°çš„æç¤ºï¼Œåœ¨åé¢å®‰è£…nvidia-docker2çš„æ—¶å€™ï¼Œéœ€è¦docker-ce 18.06çš„æ”¯æŒï¼Œæ‰€ä»¥å¤§å®¶åœ¨ä¸‹è½½çš„æ—¶å€™ï¼Œéœ€è¦ä¸‹è½½è¿™ä¸ªç‰ˆæœ¬çš„ã€‚ï¼ˆä¸€å¼ å›¾èƒœè¿‡åƒè¨€ä¸‡è¯­ï¼Œä¸‹é¢æ˜¯debæ–‡ä»¶å±•ç¤ºï¼Œä¸Šé¢æ˜¯è·¯å¾„ï¼Œæˆ‘ä¸‹è½½çš„ç‰ˆæœ¬æ˜¯çº¢è‰²ç®­å¤´æŒ‡å‘çš„é‚£ä¸ªç‰ˆæœ¬ï¼‰</p><p><img src="https://s1.ax1x.com/2018/08/12/PcyAWn.png" alt="1533028434101"></p></li><li><p>ä¸‹é¢å°±å¼€å§‹å®‰è£…äº†ï¼Œå®‰è£…ä¹‹å‰éœ€è¦åºŸè¯ä¸¤å¥ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿä¸Šå·²ç»æœ‰äº†dockeræ€ä¹ˆåŠï¼Œé‚£è¦çœ‹ä½ æ˜¯é€šè¿‡aptè¿˜æ˜¯apt-getå®‰è£…çš„ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> æŸ¥çœ‹æ˜¯å¦å®‰è£…å‘½ä»¤</span><br><span class="line">apt list --installed | grep docker</span><br><span class="line"><span class="meta">#</span> æˆ–è€…</span><br><span class="line">apt-get list --installed | grep docker</span><br><span class="line"><span class="meta">#</span> ä»¥ä¸Šçš„ä¸¤æ¡å‘½ä»¤å¯ä»¥æŸ¥åˆ°å®‰è£…ä¿¡æ¯ï¼Œå¦‚æœä½ çš„ç‰ˆæœ¬å’Œè¿™ä¸ªç³»ç»Ÿçš„ç‰ˆæœ¬æ˜¯å†²çªçš„ï¼Œé‚£ä¹ˆä½ å¯ä»¥é€šè¿‡å¸è½½è¿™ä¸ªå½“å‰çš„ç‰ˆæœ¬ï¼Œå®‰è£…æ–°çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯å‰ææ˜¯ä½ æœ‰è¿™ä¸ªæƒåˆ©åšè¿™ä»¶äº‹æƒ…ï¼Œsudoæƒé™ï¼Œè€Œä¸”ï¼Œä½ å¸è½½äº†å¯¹å…¶ä»–ç”¨æˆ·ä¸ä¼šé€ æˆå½±å“çš„å‰æä¸‹ï¼Œå¦‚æœä½ å¸è½½äº†ï¼Œå¯¹å…¶ä»–ç”¨æˆ·äº§ç”Ÿå½±å“ï¼Œåæœè‡ªè´Ÿã€‚</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 1 å¼€å§‹å®‰è£…ï¼Œå¦‚æœä½ æ˜¯rootç”¨æˆ·ï¼Œåˆ™ä¸éœ€è¦åŠ ä¸‹é¢çš„sudoï¼Œå¦‚æœä½ çš„ç”¨æˆ·æ²¡æœ‰sudoæƒé™ï¼Œé‚£ä¹ˆéœ€è¦ä½ è®©ç®¡ç†å‘˜å®‰è£…ï¼Œæˆ–è€…ï¼Œè®©ç®¡ç†å‘˜æŠŠä½ åŠ è½½sudoç»„é‡Œã€‚</span><br><span class="line">sudo dpkg -i docker-ce_18.06.0_ce_3-0_ubuntu_amd64.deb</span><br><span class="line"><span class="meta">#</span> 2 å®‰è£…ç»“æŸä»¥åï¼Œéœ€è¦æµ‹è¯•ä¸€ä¸‹å®‰è£…æ˜¯å¦æˆåŠŸ</span><br><span class="line">sudo docker run hello-world</span><br><span class="line"><span class="meta">#</span> å¦‚æœä»¥ä¸Šå‘½ä»¤å‡ºç°ä¸€äº›å›¾2çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±æ˜¯æˆåŠŸäº†</span><br></pre></td></tr></table></figure><p><img src="C:\Users\milittle\AppData\Local\Temp\1533029081395.png" alt="1533029081395"></p><p>å›¾2</p><h2 id="äºŒåœ¨ubuntuä¸Šå®‰è£…nvidia-dockerå’Œä½¿ç”¨ngc-container">äºŒã€åœ¨ubuntuä¸Šå®‰è£…nvidia-dockerå’Œä½¿ç”¨NGC container</h2><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¤§å‰ææ˜¯ï¼Œä½ çš„ä¸»æœºä¸Šå·²ç»å®‰è£…è¿‡nvidiaçš„é©±åŠ¨äº†ï¼Œè¯¦ç»†çš„è¿‡ç¨‹è¯·æŸ¥çœ‹<a href="https://docs.nvidia.com/ngc/ngc-titan-setup-guide/index.html#installing-nvidia-driver" target="_blank" rel="noopener">å®‰è£…nvidia driver</a>ã€‚</p><ol type="1"><li>å®‰è£…nvidia-docker(è¿™ä¸ªæ­¥éª¤ä¸€å®šè¦åœ¨å®‰è£…dockerä¹‹å)</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpkey | \</span><br><span class="line">sudo apt-key add -</span><br><span class="line"><span class="meta">#</span> ä¸Šé¢æ˜¯ä¸€æ¡å‘½ä»¤</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/ubuntu16.04/amd64/nvidia-docker.list | \</span><br><span class="line">sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line"><span class="meta">#</span> ä¸Šé¢æ˜¯ä¸€æ¡å‘½ä»¤</span><br><span class="line"><span class="meta">#</span># ä¸Šé¢çš„ä¸¤æ¡å‘½ä»¤éƒ½æ˜¯å°†æºæŒ‚è½½åœ¨æœ¬åœ°</span><br><span class="line">sudo apt-get update </span><br><span class="line">sudo apt-get install -y nvidia-docker2 # è¿™æ˜¯å®‰è£…å‘½ä»¤</span><br><span class="line">sudo usermod -aG docker $USER # è¿™ä¸€æ¡æ˜¯å°†ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ä¸­</span><br></pre></td></tr></table></figure><ol type="1"><li>ç„¶åå»æ³¨å†ŒNGC<a href="https://docs.nvidia.com/ngc/ngc-getting-started-guide/index.html" target="_blank" rel="noopener">æ³¨å†Œæ•™ç¨‹</a></li></ol><p>ä¸Šé¢çš„æ•™ç¨‹å·²ç»å¾ˆæ¸…æ¥šäº†ã€‚ï¼ˆæœ€ä¸»è¦çš„æ˜¯ç”Ÿæˆé‚£ä¸ªapi keyï¼‰</p><p><img src="https://s1.ax1x.com/2018/08/12/PcyEzq.png" alt="1533044008307"></p><p>é™„ä¸€å¼ æ³¨å†Œä»¥åçš„ä¸»é¡µ</p><p>è¿™é‡Œé¢æ˜¯æ‰€æœ‰çš„container</p><p>åé¢è¿è¡Œç¤ºä¾‹çš„æ—¶å€™ä¼šä¸‹è½½TensorRTçš„æ ·ä¾‹ã€‚</p><ol type="1"><li>æœ¬åœ°å®‰è£…NGC imageï¼ˆè¿™æ˜¯Dockerçš„é•œåƒæ–‡ä»¶ï¼Œå¯ä»¥å½“ä½œä¸€ä¸ªapplicationï¼‰ï¼Œä»¥åŠè¿è¡Œimageä¸ºcontainer</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo docker login nvcr.io</span><br><span class="line"><span class="meta">#</span>ä¸Šé¢çš„å‘½ä»¤æ˜¯ç™»å½•nvcr imageæœåŠ¡å™¨</span><br><span class="line">sudo docker run --runtime=nvidia --rm nvcr.io/nvidia/cuda:9.0-cudnn7-devel-ubuntu16.04 nvidia-smi</span><br><span class="line"><span class="meta">#</span> ä¸Šé¢è¿™æ¡å‘½ä»¤æ˜¯è¿è¡Œcudaç¯å¢ƒï¼Œåé¢çš„é‚£ä¸ªnvidia-smiæ˜¯æŸ¥çœ‹GPUä¿¡æ¯çš„ï¼Œç›¸æ¯”å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ã€‚</span><br><span class="line"><span class="meta">#</span> è¿™å°±æµ‹è¯•äº†dockerçš„ç¯å¢ƒæ˜¯å¦æ˜¯å¯è¿è¡Œäº†</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> ä¸‹é¢æ˜¯å®‰è£…NGC é‡Œé¢çš„é‚£äº›image</span><br><span class="line"><span class="meta">#</span> ä¸€ä¸‹çš„ç¤ºä¾‹æ˜¯TensorRTçš„ç¤ºä¾‹</span><br><span class="line">sudo docker pull nvcr.io/nvidia/tensorrt:18.07-py2</span><br><span class="line"><span class="meta">#</span> ä¸Šé¢çš„å‘½ä»¤æ˜¯å°†tensorrtçš„iamgeæ–‡ä»¶ä¸‹åˆ°æœ¬åœ°ï¼Œå¯èƒ½éœ€è¦ç‚¹æ—¶é—´ã€‚å¤§çº¦2.61G</span><br><span class="line"><span class="meta">#</span> åé¢å°±æ˜¯è¿è¡Œç¤ºä¾‹</span><br><span class="line">sudo nvidia-docker run -it --rm nvcr.io/nvidia/tensorrt:18.07-py2</span><br><span class="line"><span class="meta">#</span> ç„¶åå°±ä¼šè¿›å…¥linux containerï¼Œè¿™é‡Œé¢å·²ç»å«æœ‰tensorrtçš„ç¤ºä¾‹äº†ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> ä¸‹é¢æ˜¯tensorrtçš„ç¤ºä¾‹è¿è¡Œã€‚</span><br><span class="line"><span class="meta">#</span> c++ exampleç¤ºä¾‹è¿è¡Œ</span><br><span class="line"><span class="meta">#</span> å›¾4æ‰€ç¤º</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> python exampleç¤ºä¾‹è¿è¡Œ</span><br><span class="line"><span class="meta">#</span> å›¾5æ‰€ç¤º</span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2018/08/12/PcykJs.png" alt="1533046538343"></p><p>å›¾3</p><p><img src="https://s1.ax1x.com/2018/08/12/PcyeyV.png" alt="1533046802225"></p><p>å›¾4</p><p><img src="https://s1.ax1x.com/2018/08/12/PcyFij.png" alt="1533047137981"></p><p>å›¾5</p><h2 id="ä¸‰åˆ°æ­¤æˆ‘ä»¬å°±ç»“æŸäº†å¯èƒ½æœ‰å¾ˆå¤šå°ä¼™ä¼´è¯´è¿™äº›å¤ªç®€å•äº†å…¶å®ä¸ç®€å•è¿™äº›å†…å®¹æ˜¯æˆ‘èŠ±äº†ä¸€æ•´å¤©æ—¶é—´æŸ¥å„ç§æ–‡æ¡£æœ€åç®€ç»ƒçš„å°†è¿™äº›ä¸œè¥¿æ•´åˆåˆ°ä¸€èµ·çš„å¦‚æœå¤§å®¶æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„åœ°æ–¹å¯ä»¥ç›´æ¥ç»™æˆ‘å‘é‚®ä»¶æˆ–è€…ç›´æ¥åŠ æˆ‘qqæˆ‘æˆ–è®¸å¯ä»¥è§£ç­”ä½ çš„ç–‘æƒ‘">ä¸‰ã€åˆ°æ­¤æˆ‘ä»¬å°±ç»“æŸäº†ï¼Œå¯èƒ½æœ‰å¾ˆå¤šå°ä¼™ä¼´è¯´è¿™äº›å¤ªç®€å•äº†ï¼Œå…¶å®ä¸ç®€å•ï¼Œè¿™äº›å†…å®¹æ˜¯æˆ‘èŠ±äº†ä¸€æ•´å¤©æ—¶é—´ï¼ŒæŸ¥å„ç§æ–‡æ¡£ï¼Œæœ€åç®€ç»ƒçš„å°†è¿™äº›ä¸œè¥¿æ•´åˆåˆ°ä¸€èµ·çš„ã€‚å¦‚æœå¤§å®¶æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¯ä»¥ç›´æ¥ç»™æˆ‘å‘é‚®ä»¶æˆ–è€…ç›´æ¥åŠ æˆ‘qqï¼Œæˆ‘æˆ–è®¸å¯ä»¥è§£ç­”ä½ çš„ç–‘æƒ‘ã€‚</h2><p>qqï¼š329804334</p><p>Emailï¼šair@weaf.top</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorrt-å¼€å‘å…¥é—¨&quot;&gt;TensorRT-å¼€å‘å…¥é—¨&lt;/h1&gt;
&lt;h1 id=&quot;docker-for-ubuntu-16.04å¿ƒè·¯å†ç¨‹&quot;&gt;Docker For Ubuntu 16.04ï¼ˆå¿ƒè·¯å†ç¨‹ï¼‰&lt;/h1&gt;
&lt;h2
        
      
    
    </summary>
    
      <category term="TensorRT" scheme="http://weafteam.github.io/categories/TensorRT/"/>
    
    
      <category term="TensorRT" scheme="http://weafteam.github.io/tags/TensorRT/"/>
    
  </entry>
  
  <entry>
    <title>Android æ··æ·†</title>
    <link href="http://weafteam.github.io/posts/df5d12f4/"/>
    <id>http://weafteam.github.io/posts/df5d12f4/</id>
    <published>2018-08-10T18:04:44.000Z</published>
    <updated>2018-08-22T14:45:52.634Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä¸€å¼€å¯æ··æ·†">ä¸€ï¼šå¼€å¯æ··æ·†</h4><p>Android studioä¸­å¼€å¯æ··æ·†å¾ˆç®€å•ï¼Œæ‰¾åˆ°build.gradleæ–‡ä»¶ï¼Œè®¾ç½®minifyEnabled=trueã€‚å¦‚ä¸‹ï¼š</p><pre><code>     buildTypes {        release {            minifyEnabled true            shrinkResources true               proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39;        }    }</code></pre><p>shrinkResourcesè®¾ç½®ä¸ºtrueå¯ä»¥åœ¨å¼€å¯æ··æ·†åå»æ‰æ— ç”¨çš„èµ„æºæ–‡ä»¶ï¼Œå‡å°åº”ç”¨çš„ä½“ç§¯</p><h4 id="äºŒé…ç½®æ··æ·†æ–‡ä»¶">äºŒï¼šé…ç½®æ··æ·†æ–‡ä»¶</h4><p>æ‰¾åˆ°proguard-rules.proæ–‡ä»¶ï¼Œå°±å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„æ··æ·†è§„åˆ™äº†ã€‚ ä¸€äº›ç®€å•çš„è§„åˆ™éœ€è¦æˆ‘ä»¬äº†è§£ä¸‹</p><pre><code># ä»£è¡¨è¡Œæ³¨é‡Šç¬¦- è¡¨ç¤ºä¸€æ¡è§„åˆ™çš„å¼€å§‹keep ä¿ç•™ ï¼šdont ä¸è¦ : dontwarnï¼šè¡¨ç¤ºä¸è¦æç¤ºè­¦å‘Šignore å¿½ç•¥ï¼Œä¾‹å¦‚ignorewarningï¼šè¡¨ç¤ºå¿½ç•¥è­¦å‘Š# ä¸ä¼˜åŒ–-dontoptimize# ä»£ç å¾ªç¯ä¼˜åŒ–æ¬¡æ•°ï¼Œ0-7ï¼Œé»˜è®¤ä¸º5-optimizationpasses 5# ä¸åšé¢„æ ¡éªŒ-dontpreverify</code></pre><p>é¦–å…ˆéœ€è¦åŒºåˆ†ä¸‹ * å’Œ **ï¼›</p><pre><code>-keep class xxxx.info.**-keep class xxxx.info.*</code></pre><p>å‰è€…è¡¨ç¤ºæœ¬åŒ…ä»¥åŠå­åŒ…ä¸‹çš„ç±»åéƒ½ä¿æŒï¼Œè€Œåè€…è¡¨ç¤ºæœ¬åŒ…ä¸æ··æ·†ï¼Œå­åŒ…ä¸‹çš„ç±»åä¼šè¢«æ··æ·†ã€‚ å½“ç„¶è¿™ä¸¤è€…éƒ½æ˜¯ä¼šæ··æ·†å…·ä½“çš„æ–¹æ³•åå’Œå˜é‡çš„ï¼Œæ‰€ä»¥ä½ å¦‚æœæƒ³è¦éƒ½ä¿æŒï¼Œä¸è¢«æ··æ·†å¤„ç†çš„è¯ï¼Œéœ€è¦å†™æˆä¸‹é¢è¿™ç§ï¼š</p><pre><code>-keep class xxxx.info.* {*;}</code></pre><p>å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä¿ç•™ç±»ä¸­çš„æŸäº›éƒ¨åˆ†ä¸è¢«æ··æ·†ï¼Œå¦‚ï¼š</p><pre><code>-keep class xxxx.info.One {     public &lt;methods&gt;;}</code></pre><p>æˆ–è®¸ä½ è§‰å¾—ç±»åä¹Ÿä¸éœ€è¦ä¿ç•™ï¼Œé‚£å°±ä¸èƒ½ä½¿ç”¨keepäº†ï¼Œè¿™é‡Œè¿˜æœ‰å‡ ç§åˆ«çš„ï¼Œå¦‚</p><pre><code>-keepclassmembers ä¸ä¿ç•™åŒ…å é˜²æ­¢æˆå‘˜è¢«ç§»é™¤æˆ–è€…è¢«é‡å‘½å-keepclasseswithmembers ä¿ç•™ç±»åå’Œæˆå‘˜å</code></pre><h5 id="åŸºæœ¬è§„åˆ™">1ï¼šåŸºæœ¬è§„åˆ™</h5><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ä¿å­˜å››å¤§ç»„ä»¶ï¼Œè‡ªå®šä¹‰viewä¸è¢«æ··æ·†ï¼Œå› ä¸º è¿™äº›å­ç±»éƒ½æœ‰å¯èƒ½è¢«å¤–éƒ¨è°ƒç”¨ã€‚</p><pre><code>-keep public class * extends android.app.Activity-keep public class * extends android.app.Application-keep public class * extends android.support.multidex.MultiDexApplication-keep public class * extends android.app.Service-keep public class * extends android.content.BroadcastReceiver-keep public class * extends android.content.ContentProvider-keep public class * extends android.app.backup.BackupAgentHelper-keep public class * extends android.preference.Preference-keep public class * extends android.view.View-keep class android.support.** {*;}</code></pre><h5 id="åå°„">2ï¼šåå°„</h5><p>åå°„ç”¨åˆ°çš„ç±»ä¸€èˆ¬éœ€è¦ä¿ç•™ï¼Œå¦åˆ™ä¼šå‡ºç°é—®é¢˜ã€‚ å®ä½“ç±»ä¸è¢«æ··æ·†</p><pre><code> -keep class xxxx.info.Bean.** { *; }</code></pre><h5 id="æšä¸¾ä¸èƒ½è¢«æ··æ·†">3ï¼šæšä¸¾ä¸èƒ½è¢«æ··æ·†</h5><pre><code>-keepclassmembers enum * {    public static **[] values();    public static ** valueOf(java.lang.String);}</code></pre><h5 id="ç»§æ‰¿çš„ä¿ç•™">4ï¼šç»§æ‰¿çš„ä¿ç•™</h5><pre><code>-keep public class * extends android.support.v4.**-keep public class * extends android.support.v7.**-keep public class * extends android.support.annotation.**-keep class * implements android.os.Parcelable {     public static final android.os.Parcelable$Creator *;}</code></pre><h5 id="jni-æ–¹æ³•ä¸å¯æ··æ·†">5ï¼šjni æ–¹æ³•ä¸å¯æ··æ·†</h5><pre><code>-keepclasseswithmembernames class * {        native &lt;methods&gt;;</code></pre><p>}</p><h5 id="èµ„æºæ–‡ä»¶ä¸è¢«æ··æ·†">6ï¼š èµ„æºæ–‡ä»¶ä¸è¢«æ··æ·†</h5><pre><code>-keep class **.R$* {    *;}-keepclassmembers class **.R$* {     public static &lt;fields&gt;;}</code></pre><h5 id="webviewçš„ä¸€äº›å¤„ç†">7ï¼šwebviewçš„ä¸€äº›å¤„ç†</h5><pre><code>-keepclassmembers class fqcn.of.javascript.interface.for.Webview {      public *; } -keepclassmembers class * extends android.webkit.WebViewClient {  public void *(android.webkit.WebView, java.lang.String, android.graphics.Bitmap);  public boolean *(android.webkit.WebView, java.lang.String);}-keepclassmembers class * extends android.webkit.WebViewClient { public void *(android.webkit.WebView, jav.lang.String);}</code></pre><p>åœ¨appä¸­ä¸HTML5çš„JavaScriptçš„äº¤äº’è¿›è¡Œç‰¹æ®Šå¤„ç† æˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™äº›jsè¦è°ƒç”¨çš„åŸç”Ÿæ–¹æ³•ä¸èƒ½å¤Ÿè¢«æ··æ·†ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦åšå¦‚ä¸‹å¤„ç†ï¼š</p><pre><code>-keepclassmembers class com.ljd.example.JSInterface { &lt;methods&gt;; }   </code></pre><h5 id="å…¶ä»–çš„ä¸€äº›æ“ä½œ">8ï¼šå…¶ä»–çš„ä¸€äº›æ“ä½œ</h5><p>åˆ é™¤ä»£ç ä¸­Logç›¸å…³çš„ä»£ç </p><pre><code>-assumenosideeffects class android.util.Log {    public static boolean isLoggable(java.lang.String, int);    public static int v(...); public static int i(...);    public static int w(...); public static int d(...);     public static int e(...);}</code></pre><p>ä¿ç•™æµ‹è¯•ç›¸å…³çš„ä»£ç </p><pre><code> -dontnote junit.framework.** -dontnote junit.runner.** -dontwarn android.test.** -dontwarn android.support.test.** -dontwarn org.junit.**</code></pre><p>å¦å¤–è¿˜æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„æˆ‘è¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†ï¼Œæ¥å…¥æ—¶æ–‡æ¡£éƒ½ä¼šç»™å‡ºæ··æ·†ç­–ç•¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      Android æ··æ·†
    
    </summary>
    
      <category term="ANDROID" scheme="http://weafteam.github.io/categories/ANDROID/"/>
    
    
      <category term="ANDROID" scheme="http://weafteam.github.io/tags/ANDROID/"/>
    
  </entry>
  
  <entry>
    <title>Python ç±»å‹ç³»ç»Ÿçš„ä¸‹ä¸€æ­¥</title>
    <link href="http://weafteam.github.io/posts/684b8f9/"/>
    <id>http://weafteam.github.io/posts/684b8f9/</id>
    <published>2018-08-10T17:35:33.000Z</published>
    <updated>2018-08-12T09:51:01.089Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢</h2><p>æœ¬æ–‡ç¿»è¯‘è‡ª <a href="https://blog.daftcode.pl/next-steps-with-python-type-system-efc4df5251c9" target="_blank" rel="noopener">Next Steps with Python Type System</a>ã€‚</p><p>è‡ªè±ªçš„é‡‡ç”¨æœç‹—ç¿»è¯‘ã€‚</p><p>è¿™æ˜¯ Python ç±»å‹ç³»ç»Ÿçš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å±•ç¤º Python ç±»å‹çš„ä¸€äº›æ›´é«˜çº§çš„ç‰¹æ€§ã€‚æ­¤å¤–ä¹Ÿä¼šåŒ…æ‹¬ä¸€äº›å…³äºä½¿ç”¨ç‰¹å®šç±»å‹åŠŸèƒ½çš„æç¤ºï¼Œå’Œä¸€ä¸ªå¦‚ä½•å°†ç±»å‹ç³»ç»Ÿå¼•å…¥ä½ çš„ä»£ç åº“ä¸­çš„ç®€çŸ­æŒ‡å—ã€‚</p><h2 id="çº¦æŸç±»å‹">1. çº¦æŸç±»å‹</h2><p>åœ¨ä¸Šä¸€ç¯‡åšå®¢æ–‡ç« ä¸­æè¿°äº† <code>Optional</code> ç±»å‹ã€‚è®©æˆ‘ä»¬å›åˆ°å±•ç¤ºå…¶ç”¨æ³•çš„ç‰‡æ®µï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Optional</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_id</span><span class="params">()</span> -&gt; Optional[int]:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_user_id</span><span class="params">(user_id: int)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user_id = get_user_id()</span><br><span class="line">process_user_id(user_id)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument 1 to "process_user_id" has incompatible type "Optional[int]"; expected "int"</span></span><br></pre></td></tr></table></figure><p>mypy ç±»å‹æ£€æŸ¥å™¨æŠ¥å‘Šçš„é”™è¯¯ç¡®å®æ˜¯æ­£ç¡®å’Œæœ‰ç”¨çš„ã€‚ä½†æ˜¯å¦‚æœä½ çœŸçš„çŸ¥é“åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­ <code>get_user_id()</code> ä¼šè¿”å›ä¸€ä¸ª <code>int</code>ï¼Œè€Œä½ åªæƒ³æŠŠå®ƒä¼ é€’ç»™ <code>process_user_id()</code> æ€ä¹ˆåŠï¼Ÿé¦–å…ˆï¼Œè€ƒè™‘ä¸€ä¸‹ä½ çš„ç¨‹åºç»“æ„æ˜¯å¦ä¸å¤æ‚ï¼Œæ˜¯å¦éœ€è¦é‡æ„ã€‚ä½ è¿˜æƒ³è¿™ä¹ˆåšå—ï¼Ÿå—¯ï¼Œæˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼é€šçŸ¥mypy ç±»å‹å·²ç»æ”¹å˜äº†ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ç§å˜åŒ–å®é™…ä¸Šæ˜¯é™åˆ¶æ€§çš„ï¼šä» <code>Optional[int]</code> ï¼ˆå³ <code>Union[int, None]</code>ï¼‰åˆ° <code>int</code>ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°è¯•æœ€æ˜¾è€Œæ˜“è§çš„æ–¹æ³•æ¥å®ç°å®ƒã€‚</p><h3 id="å…·æœ‰æ–°çš„ç±»å‹æ³¨è§£çš„ç±»å‹çº¦æŸ-ä¸æ­£ç¡®">1.1 å…·æœ‰æ–°çš„ç±»å‹æ³¨è§£çš„ç±»å‹çº¦æŸ [ä¸æ­£ç¡®]</h3><p>æœ€ç®€å•çš„æ–¹æ³•ä¼¼ä¹æ˜¯ç”¨æ›´ä¸¥æ ¼çš„ç±»å‹æ³¨è§£å˜é‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user_id: int = get_user_id()  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Incompatible types in assignment (expression has type "Optional[int]",</span></span><br><span class="line"><span class="comment">#   variable has type "int")</span></span><br><span class="line"></span><br><span class="line">process_user_id(user_id)</span><br></pre></td></tr></table></figure><p>ç„¶è€Œæˆ‘ä»¬ä¸èƒ½è¿™æ ·åšã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºç±»å‹æ³¨è§£ä¸ä¼šå¼ºåˆ¶å˜é‡ä½¿ç”¨ç±»å‹ï¼Œå®ƒå‘ŠçŸ¥ç±»å‹ã€‚å¦‚æœæœ‰ä»»ä½•ä¸ä¸€è‡´ï¼Œç±»å‹æ£€æŸ¥å™¨ä¼šæŠ¥å‘Šå®ƒã€‚äº‹å®ä¸Šï¼Œå¦‚æœè¿™ç§æ–¹æ³•æ˜¯æ­£ç¡®çš„ï¼Œæ•´ä¸ªç±»å‹æ£€æŸ¥æ€æƒ³å°±ä¼šå´©æºƒã€‚</p><p>ç±»å‹æ£€æŸ¥æ€æƒ³ä¼šå´©æºƒï¼Œç‰¹åˆ«æ˜¯å½“ä¸€ä¸ªæ–°ç±»å‹ä¸æ˜¯æ—§ç±»å‹çš„å­ç±»å‹æ—¶ï¼ˆå¦‚ <code>int</code> å’Œ <code>str</code>ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸€ç§å‡è®¾çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œmypy ä¼šæ¥å—ç±»å‹çº¦æŸï¼ˆé€šè¿‡ä½¿ç”¨æ³¨è§£å°†ç±»å‹ä»æ›´ä¸€èˆ¬çš„ç±»å‹å˜ä¸ºä¸å¤ªä¸€èˆ¬çš„ç±»å‹ï¼‰ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒå°†ä¼šä» <code>Union[int, None]</code> çº¦æŸåˆ° <code>int</code>ã€‚ä½†æ˜¯ï¼Œç›®å‰å®ƒä¸å—æ”¯æŒã€‚</p><p>è‡³å°‘æœ‰ä¸¤ç§æ­£ç¡®çš„æ–¹æ³•å¯ä»¥é€šçŸ¥ mypy ç±»å‹æ£€æŸ¥å™¨ä¸åŒäºé¢„æœŸçš„ç±»å‹ã€‚</p><h3 id="å…·æœ‰ç±»å‹æ£€æŸ¥çš„ç±»å‹çº¦æŸ-æ­£ç¡®">1.2 å…·æœ‰ç±»å‹æ£€æŸ¥çš„ç±»å‹çº¦æŸ [æ­£ç¡®]</h3><p>æ›´æ”¹ç±»å‹çš„æ­£ç¡®æ–¹æ³•æ˜¯ç¡®ä¿æ–°ç±»å‹çš„ <code>isinstance</code> è¿”å› <code>True</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user_id = get_user_id()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> isinstance(user_id, int):</span><br><span class="line">    process_user_id(user_id)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line"><span class="keyword">assert</span> isinstance(user_id, int)</span><br><span class="line">process_user_id(user_id)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å¯ä»¥</span></span><br><span class="line"><span class="keyword">if</span> user_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">    process_user_id(user_id)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œmypy ç¡®ä¿¡ <code>user_id</code> å…·æœ‰æ­£ç¡®çš„ç±»å‹â€”â€”å¦åˆ™ï¼Œå°†ä¸ä¼šæ‰§è¡Œå¯¹ <code>process_user_id</code> çš„è°ƒç”¨ã€‚</p><p>è¯·æ³¨æ„ï¼Œä½¿ç”¨ <code>isinstance</code> ä¼šå¸¦æ¥å°‘é‡è¿è¡Œæ—¶å¼€é”€ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šå¾—åˆ°é¢å¤–çš„è¿è¡Œæ—¶æ£€æŸ¥ï¼Œè¿™å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚</p><h3 id="å…·æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢çš„ç±»å‹çº¦æŸ-æ­£ç¡®">1.3 å…·æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢çš„ç±»å‹çº¦æŸ [æ­£ç¡®]</h3><p>å‘Šè¯‰ mypy è¯¥ç±»å‹å—åˆ°çº¦æŸï¼ˆæˆ–ä»¥å…¶ä»–æ–¹å¼æ›´æ”¹ï¼‰çš„å¦ä¸€ä¸ªæ­£ç¡®æ–¹æ³•æ˜¯ä½¿ç”¨ <code>cast</code> å‡½æ•°ã€‚è¿™åœ¨ <a href="https://www.python.org/dev/peps/pep-0484/#casts" target="_blank" rel="noopener">PEP 484</a> ä¸­æœ‰æ˜ç¡®æè¿°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> cast</span><br><span class="line"></span><br><span class="line">user_id = cast(int, get_user_id())</span><br><span class="line">process_user_id(user_id)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨ <code>typing</code> æ¨¡å—ä¸­å®šä¹‰çš„ã€‚ç±»å‹ç³»ç»Ÿä¸åº”å¯¹è¿è¡Œæ—¶äº§ç”Ÿä»»ä½•å½±å“ï¼Œè¿™ä¸ªå‡½æ•°ä¿æŒäº†è¿™ä¸ªæ‰¿è¯ºï¼ˆé™¤äº†ç©ºå‡½æ•°è°ƒç”¨ï¼‰â€”â€”åœ¨ Python çš„æºä»£ç ä¸­ï¼Œå®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªèº«ä»½å‡½æ•° ï¼ˆåˆ é™¤äº† docstringï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cast</span><span class="params">(typ, val)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> val</span><br></pre></td></tr></table></figure><p>å› æ­¤ä¸æ‰§è¡Œè¿è¡Œæ—¶æ£€æŸ¥ã€‚å½“ä½¿ç”¨ <code>cast</code> æ—¶ï¼Œå¯¹äºç±»å‹æ£€æŸ¥è€…æ¥è¯´ï¼Œç›²ç›®ç›¸ä¿¡è¿™ç§æ–°ç±»å‹æ˜¯ä¸€æ¡å‘½ä»¤ã€‚</p><p>è¯·æ³¨æ„ï¼Œä½¿ç”¨ <code>cast</code> å¯èƒ½ä¼šæ©ç›–é”™è¯¯ï¼šå‰ä¸€ç§ç±»å‹â€”â€”å¯èƒ½æ˜¯æ­£ç¡®çš„â€”â€”ä¼šè¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒçš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº <code>Any</code> å’Œ <code>#type: ignore</code>ï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œå› æ­¤è¦å°å¿ƒä½¿ç”¨ã€‚</p><h2 id="ç»„åˆç±»å‹å¹¶å®šä¹‰ç±»å‹åˆ«å">2. ç»„åˆç±»å‹å¹¶å®šä¹‰ç±»å‹åˆ«å</h2><p>Python çš„ç±»å‹å¯ä»¥è‡ªç”±ç»„åˆã€‚æƒ³è¦ä¸€ä¸ªæ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²æˆ– <code>None</code> çš„åˆ—è¡¨å—ï¼Ÿåªéœ€ä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List[Union[int, float, str, <span class="keyword">None</span>]]</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List[Optional[Union[int, float, str]]]</span><br></pre></td></tr></table></figure><p>éšä¾¿ä½ ã€‚</p><p>ç”±å­—ç¬¦ä¸²ç»„æˆçš„å…ƒç»„å’Œç”±æ•´æ•°ç»„æˆçš„å…ƒç»„åˆ—è¡¨ä»¥åŠç”±æ•´æ•°ã€å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²åˆ—è¡¨ç»„æˆçš„å…ƒç»„åˆ—è¡¨æ€ä¹ˆæ ·ï¼Ÿä¹Ÿå¾ˆç›´ç™½ğŸ˜…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tuple[str, List[Tuple[int, List[Tuple[int, str, List[str]]]]]]</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥å¾ˆæœ‰è¶£ï¼ä¸æ˜¯å—ï¼Ÿäº‹å®ä¸Šï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šåœ¨ç¨‹åºä¸­ä½¿ç”¨è¿™äº›å¤æ‚çš„æ•°æ®ç±»å‹ã€‚å¦‚ä½•å°†ç±»å‹æ³¨è§£ä¸å®ƒä»¬ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸è¦å¤±å»ç†æ™ºï¼Ÿ</p><p>è¦ä½¿ç±»å‹æ›´æ˜“äºç®¡ç†å’Œé˜…è¯»ï¼Œè¯·ä½¿ç”¨ç±»å‹åˆ«åã€‚è¦åˆ›å»ºåˆ«åï¼Œåªéœ€ä¸ºå˜é‡åˆ†é…ä¸€ä¸ªç±»å‹ï¼š<code>alias = T</code>ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>alias</code> ä»£æ›¿ <code>T</code>ã€‚</p><p>è¿™é‡Œçš„å…³é”®æ˜¯æ­£ç¡®å‘½ååˆ«åã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆ›å»ºåæ˜ å‘½åç±»å‹ç»“æ„çš„åˆ«åï¼Œå¦‚ <code>ListOfListsOfDictsFromStrToIntOrFloat</code>ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ„ä¹‰ã€‚è¦ä½¿ç”¨å†…éƒ¨åæ˜ â€œä¸šåŠ¡å¯¹è±¡â€çš„åç§°ã€‚åŒæ ·ï¼Œç›¸åº”åœ°åµŒå¥—åˆ«åã€‚åƒè¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List, Tuple</span><br><span class="line"></span><br><span class="line">ItemId = int</span><br><span class="line">ItemName = str</span><br><span class="line">ItemTag = str</span><br><span class="line">ItemTags = List[ItemTag]</span><br><span class="line">Item = Tuple[ItemId, ItemName, ItemTags]</span><br><span class="line">Items = List[Item]</span><br><span class="line"></span><br><span class="line">OrderId = int</span><br><span class="line">Order = Tuple[OrderId, Items]</span><br><span class="line">Orders = List[Order]</span><br><span class="line"></span><br><span class="line">ShipmentId = str</span><br><span class="line">Shipment = Tuple[ShipmentId, Orders]</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>NamedTuple</code> æ¥å®šä¹‰ <code>Item</code>ã€<code>Order</code> å’Œ <code>Shipment</code> å°†ä¼šè¿›ä¸€æ­¥æé«˜æˆ‘ä»¬ä»£ç çš„å¯è¯»æ€§ã€‚å¦å¤–ï¼Œåœ¨ç°å®çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨è‡ªå®šä¹‰ç±»æ¥ä»£æ›¿ã€‚å°½ç®¡å¦‚æ­¤ï¼Œç±»å‹åˆ«åä»ç„¶æ˜¯æœ‰ç”¨çš„ã€‚</p><p><code>Shipment</code> çœ‹èµ·æ¥æ¯” <code>Tuple[str, List[Tuple[int, List[Tuple[int, str, List[str]]]]]]</code> å¥½å¾—å¤šï¼Œä¸æ˜¯å—ï¼Ÿéœ€è¦é”®å…¥çš„å­—ç¬¦ä¹Ÿå°‘å¾—å¤šã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥ç”¨ä¸šåŠ¡ç›¸å…³çš„ç±»å‹æ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_item_id</span><span class="params">()</span> -&gt; ItemId:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_item</span><span class="params">(name: ItemName, tags: ItemTags)</span> -&gt; Item:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_order</span><span class="params">(items: Items)</span> -&gt; Order:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_order</span><span class="params">(order: Order)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰ç­‰</span></span><br></pre></td></tr></table></figure><p>ä»£ç æ›´æ¸…æ™°ï¼Œä¸šåŠ¡é€»è¾‘æ˜æ˜¾ã€‚æ­¤å¤–ï¼Œç±»å‹æ³¨è§£å’Œç±»å‹æœ¬èº«çš„é”™è¯¯æ›´å®¹æ˜“è¢«å‘ç°ã€‚</p><h2 id="newtype-å‡½æ•°">3. NewType å‡½æ•°</h2><p>åœ¨æœ€åä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸ºä¸€ä¸ªç®€å•çš„ç±»å‹åˆ†é…äº†åˆ«åï¼Œå¦‚ <code>ItemId = int</code>ã€‚å³ä½¿æ˜¯è¿™ä¸ªç®€å•çš„åˆ«åä¹Ÿæœ‰æ„ä¹‰ï¼Œå› ä¸ºå®ƒè¡¨ç¤ºè¿™ä¸ªç‰¹å®šæ•´æ•°çš„â€œæ„ä¹‰â€ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒå¹¶ä¸èƒ½ä¿æŠ¤æˆ‘ä»¬å…å—ä»¥ä¸‹é”™è¯¯çš„å½±å“ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ItemId = int</span><br><span class="line">OrderId = int</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_item_id</span><span class="params">()</span> -&gt; ItemId:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_order_id</span><span class="params">()</span> -&gt; OrderId:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_order</span><span class="params">(id_: OrderId)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order_id = get_last_item_id()</span><br><span class="line">order = get_order(order_id)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>mypy å¾ˆå¼€å¿ƒï¼ŒIDE å¾ˆå¼€å¿ƒï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå¼€å¿ƒã€‚è®©æˆ‘ä»¬ç¥ˆç¥·è¿›è¡Œä»£ç å®¡æŸ¥çš„äººä¼šå‘ç°é”™è¯¯ï¼</p><p>ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é¢å¤–å®šä¹‰ç›´æ¥ä» <code>int</code> ç»§æ‰¿çš„å­ç±»ï¼ˆå­ç±»å‹ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemId</span><span class="params">(int)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderId</span><span class="params">(int)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_item_id</span><span class="params">()</span> -&gt; ItemId:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_order_id</span><span class="params">()</span> -&gt; OrderId:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_order</span><span class="params">(id_: OrderId)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order_id = get_last_item_id()</span><br><span class="line">order = get_order(order_id)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument 1 to "get_order" has incompatible type "ItemId"; expected "OrderId"</span></span><br></pre></td></tr></table></figure><p>å¾ˆå¥½ï¼Œé”™è¯¯è¢«å‘ç°äº†ã€‚ä¸å¹¸çš„æ˜¯ï¼Œé€šè¿‡é¢å¤–çš„æ„é€ å‡½æ•°ä¼ é€’å€¼ä¼šå¸¦æ¥è¿è¡Œæ—¶å¼€é”€ã€‚å½“æˆ‘ä»¬å¿…é¡»å¤„ç†è®¸å¤šå®ä¾‹æ—¶ï¼Œè¿™å°¤å…¶ç—›è‹¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>typing</code> æ¨¡å—å…·æœ‰ <code>NewType</code> å‡½æ•°ã€‚å®ƒç”¨äºå®šä¹‰ä¸åŒçš„å­ç±»å‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> NewType</span><br><span class="line"></span><br><span class="line">ItemId = NewType(<span class="string">"ItemId"</span>, int)</span><br><span class="line">OrderId = NewType(<span class="string">"OrderId"</span>, int)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_item_id</span><span class="params">()</span> -&gt; ItemId:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_order_id</span><span class="params">()</span> -&gt; OrderId:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_order</span><span class="params">(id_: OrderId)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">order_id = get_last_item_id()</span><br><span class="line">order = get_order(order_id)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument 1 to "get_order" has incompatible type "ItemId"; expected "OrderId"</span></span><br></pre></td></tr></table></figure><p><code>NewType</code> åªæ˜¯è¿”å›ä¸€ä¸ªèº«ä»½å‡½æ•°ï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶æ²¡æœ‰å®šä¹‰å­ç±»ã€‚æ­¤å¤–ï¼Œè¿™åªä¼šå¸¦æ¥æœ€å°çš„å¼€é”€ã€‚è¯·å‚è§<a href="https://github.com/python/typing/blob/master/src/typing.py#L2210-L2234" target="_blank" rel="noopener">è¿™é‡Œ</a>çš„æºä»£ç ã€‚</p><p>ä½¿ç”¨ç”¨ <code>NewType</code> å®šä¹‰çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­æ·»åŠ é¢å¤–çš„ç±»å‹â€œè·Ÿè¸ªâ€ã€‚è¿™åœ¨å®‰å…¨ç¯å¢ƒä¸­å¯èƒ½å¾ˆæ–¹ä¾¿â€”â€”ä¾‹å¦‚åŒºåˆ†å®‰å…¨å’Œï¼ˆæ½œåœ¨çš„ï¼‰ä¸å®‰å…¨å­—ç¬¦ä¸²ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> NewType</span><br><span class="line"></span><br><span class="line">SafeStr = NewType(<span class="string">'SafeStr'</span>, str)</span><br><span class="line"></span><br><span class="line">safe_code = SafeStr(<span class="string">'2 + 2'</span>)</span><br><span class="line">user_provided_code = <span class="string">'import sys; sys.melt_cpu()'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_code</span><span class="params">(string: SafeStr)</span>:</span></span><br><span class="line">    exec(string)</span><br><span class="line"></span><br><span class="line">exec_code(safe_code)</span><br><span class="line">exec_code(user_provided_code)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument 1 to "exec_code" has incompatible type "str"; expected "SafeStr"</span></span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œè·å– <code>user_provided_code</code> çš„å€¼å¯èƒ½ç¦»å¯¹ <code>exec_code</code> çš„è°ƒç”¨å¾ˆè¿œï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ mypy å¸®åŠ©ï¼Œå¾ˆéš¾å‘ç°å®ƒæ˜¯ä¸å®‰å…¨çš„ã€‚</p><p>åœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ <code>NewType</code>â€”â€”åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ <code>SafeStr('2 + 2')</code>ï¼ˆç¬¬ 5 è¡Œï¼‰â€”â€”ä¼ é€’å€¼å‡ ä¹æ²¡æœ‰å¼€é”€ï¼Œå®é™…ä¸Šæ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚å¯¹ mypy æ¥è¯´ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼å°±åƒ <code>cast(SafeStr, '2 + 2')</code>ã€‚</p><h2 id="å¯è°ƒç”¨ç±»å‹">4. å¯è°ƒç”¨ç±»å‹</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®šä¹‰äº†å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†ä¸€ä¸ªå‡½æ•°æœ¬èº«ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼ˆåœ¨ Python ä¸­ï¼Œå‡½æ•°æ˜¯ç¬¬ä¸€ç±»å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·åšï¼‰æ€ä¹ˆåŠâ€”â€”æˆ‘ä»¬å¦‚ä½•è¡¨è¾¾ä¼ é€’å‡½æ•°çš„ç±»å‹ï¼Ÿ</p><p>è®©æˆ‘ä»¬ç¦»é¢˜ä¸€ä¼šå„¿â€¦â€¦åœ¨ Python çš„ç±»å‹ç³»ç»Ÿä¸­ï¼Œå‡½æ•°çš„ç±»å‹å°±åƒä»»ä½•å…¶ä»–ç±»å‹ä¸€æ ·ï¼ˆè®°ä½ï¼šå‡½æ•°æ˜¯ç¬¬ä¸€ç±»å¯¹è±¡ï¼Œå°±åƒæ•´æ•°æˆ–å­—ç¬¦ä¸²ä¸€æ ·ï¼‰ã€‚èµ·åˆè¿™å¯èƒ½ä»¤äººæƒŠè®¶ï¼Œä½†å¦‚æœä½ ä»”ç»†æƒ³æƒ³ï¼Œè¿™æ˜¯å¾ˆè‡ªç„¶çš„ã€‚ä¾‹å¦‚ï¼Œè¿™æ ·æ³¨è§£çš„å‡½æ•°ç±»å‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">(arg: str)</span> -&gt; int:</span> ...</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¢«è®¤ä¸ºæ˜¯â€œ<code>str</code> åˆ° <code>int</code>â€ã€‚äº‹å®ä¸Šï¼Œå‡½æ•°çš„ç±»å‹åœ¨æŸç§ç¨‹åº¦ä¸Šéå¸¸ç±»ä¼¼äº <code>Dict</code> ç±»å‹ï¼Œå®ƒå°†ä¸€ä¸ªå€¼â€œæ˜ å°„â€åˆ°å¦ä¸€ä¸ªå€¼ï¼›åƒ <code>Dict[str, int]</code> å°† <code>str</code> æ˜ å°„åˆ° <code>int</code>ã€‚ä»ç±»å‹çš„è§’åº¦æ¥çœ‹ï¼Œå‡½æ•°æ›´å¤æ‚â€”â€”å¯ä»¥æ²¡æœ‰ã€ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œå­—å…¸åªæœ‰ä¸€ä¸ªé”®ã€‚ç„¶è€Œï¼Œæ˜ å°„çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚</p><p>åœ¨ Python ä¸­ï¼Œæè¿°å‡½æ•°ç±»å‹ï¼ˆå’Œå…¶ä»–å¯è°ƒç”¨ç±»å‹ï¼‰æ—¶ä½¿ç”¨ <code>Callable</code> ç±»å‹ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p><code>Callable[[t1, t2,Â â€¦, tn], tr]</code> å…·æœ‰ä½ç½®å‚æ•°ç±»å‹ <code>t1</code> ç­‰çš„å‡½æ•°ï¼Œè¿”å›ç±»å‹ <code>tr</code>ã€‚[<a href="https://www.python.org/dev/peps/pep-0483/#fundamental-building-blocks" target="_blank" rel="noopener">æ¥æº</a>]</p></blockquote><p>è®©æˆ‘ä»¬çœ‹çœ‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Callable, List</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_function_on_value</span><span class="params">(func: Callable[[str], int], value: str)</span> -&gt; int:</span></span><br><span class="line">    <span class="keyword">return</span> func(value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">text_length</span><span class="params">(text: str)</span> -&gt; int:</span></span><br><span class="line">    <span class="keyword">return</span> len(text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result1 = apply_function_on_value(</span><br><span class="line">    func=text_length, value=<span class="string">"I know a dead parrot when I see one."</span></span><br><span class="line">)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br></pre></td></tr></table></figure><p><code>apply_function_on_value</code> å°†ä¸€ä¸ªå‡½æ•° <code>func</code> ä½œä¸ºå®ƒç¬¬ä¸€ä¸ªå‚æ•°å¹¶å°†å®ƒåº”ç”¨äºå…¶ç¬¬äºŒä¸ªå‚æ•° <code>value</code>ã€‚è¿™ä¸ªå‡½æ•°çš„ç±»å‹ä¸ºâ€œ<code>str</code> åˆ° <code>int</code>â€ï¼Œæˆ–è€… <code>Callable[[str], int]</code>ã€‚æ‰€ä»¥å°† <code>text_length</code> å‡½æ•°ï¼ˆå®ƒåªæ˜¯å®šä¹‰åœ¨å­—ç¬¦ä¸²ä¸Šçš„ <code>len</code> å‡½æ•°ï¼‰ä¼ é€’ç»™å®ƒæ˜¯æ­£ç¡®çš„ï¼Œå› ä¸º <code>func</code> è¢«å®šä¹‰ä¸ºè·å– <code>str</code> å¹¶è¿”å› <code>int</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">append_parrot</span><span class="params">(text: str)</span> -&gt; str:</span></span><br><span class="line">    <span class="keyword">return</span> text + <span class="string">' Parrot!'</span></span><br><span class="line"></span><br><span class="line">result2 = apply_function_on_value(</span><br><span class="line">    func=append_parrot,</span><br><span class="line">    value=<span class="string">"Now that's what I call a dead parrot."</span>,</span><br><span class="line">)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument "func" to "apply_function_on_value" has incompatible type</span></span><br><span class="line"><span class="comment">#   "Callable[[str], str]"; expected "Callable[[str], int]"</span></span><br></pre></td></tr></table></figure><p><code>append_parrot</code> æ— æ³•æ­£ç¡®ä¼ é€’ç»™ <code>apply_function_on_value</code>ï¼Œå› ä¸ºå®ƒä¸ <code>func</code> ç±»å‹ä¸å…¼å®¹ï¼šè¿”å›ä¸€ä¸ª <code>str</code>ï¼Œè€Œä¸æ˜¯ <code>int</code>ã€‚</p><h2 id="any-ç±»å‹ä¸å…³é—­-mypy-æ£€æŸ¥">5. Any ç±»å‹ä¸å…³é—­ mypy æ£€æŸ¥</h2><p>Python çš„ç±»å‹è§„åˆ™éå¸¸ä¸¥æ ¼ï¼Œä½†æ˜¯ Python ä¸ºä½ ä¸æƒ³è®© mypy æŠ±æ€¨æŸä¸ªç±»å‹çš„æƒ…å†µæä¾›äº†æ¼æ´ã€‚è¿™ä¸ªæ¼æ´æ˜¯ <code>Any</code> ç±»å‹ã€‚<code>Any</code> ä¸æ¯ç§ç±»å‹éƒ½ä¸€è‡´ï¼Œæ¯ç§ç±»å‹éƒ½ä¸ <code>Any</code> ä¸€è‡´ã€‚</p><blockquote><p>å½“ä¸€ä¸ªå€¼å…·æœ‰ç±»å‹ <code>Any</code> æ—¶ï¼Œç±»å‹æ£€æŸ¥å™¨å°†å…è®¸å¯¹å…¶è¿›è¡Œæ‰€æœ‰æ“ä½œï¼Œå¹¶ä¸”ç±»å‹ <code>Any</code> çš„å€¼å¯ä»¥åˆ†é…ç»™ä¸€ä¸ªæ›´å—çº¦æŸç±»å‹çš„å˜é‡ï¼ˆæˆ–è€…ç”¨ä½œè¿”å›å€¼ï¼‰ã€‚[<a href="https://www.python.org/dev/peps/pep-0484/#the-any-type" target="_blank" rel="noopener">æ¥æº</a>]</p></blockquote><p>è®©æˆ‘ä»¬è¯æ˜ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Any</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span>:</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç±»å‹</span></span><br><span class="line">lassie: Dog</span><br><span class="line">anything1: Any</span><br><span class="line">lassie = anything1  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">scooby: Dog</span><br><span class="line">anything2: Any</span><br><span class="line">anything2 = scooby  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å±æ€§</span></span><br><span class="line">anything3: Any</span><br><span class="line">anything3.enter_hiperspace()  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>æ­£å¦‚æ–‡æ¡£æ‰€è¿°ï¼š</p><blockquote><p><code>Any</code> å¯ä»¥è¢«è®¤ä¸ºæ˜¯å…·æœ‰æ‰€æœ‰å€¼å’Œæ‰€æœ‰æ–¹æ³•çš„ç±»å‹ã€‚ç»“åˆä¸Šé¢çš„å­ç±»å‹å®šä¹‰ï¼Œè¿™å°† <code>Any</code> éƒ¨åˆ†çš„æ”¾åœ¨ç±»å‹å±‚æ¬¡ç»“æ„çš„é¡¶éƒ¨ï¼ˆå®ƒæœ‰æ‰€æœ‰å€¼ï¼‰å’Œåº•éƒ¨ï¼ˆå®ƒæœ‰æ‰€æœ‰æ–¹æ³•ï¼‰ã€‚<a href="https://www.python.org/dev/peps/pep-0483/#summary-of-gradual-typing" target="_blank" rel="noopener">æ¥æº</a></p></blockquote><p>å¯ä»¥è¿™æ ·è¡¨ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                      Any                     &lt;- æ‰€æœ‰ç±»å‹éƒ½æ˜¯ Any</span><br><span class="line">                      / \                        (å°±åƒ `object`</span><br><span class="line">                     /*  \*                       -- æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ `object`)</span><br><span class="line">                    /     \</span><br><span class="line">            SomeType1     SomeType2</span><br><span class="line">           /       |       |       \</span><br><span class="line">          /        |       |        \</span><br><span class="line">         /         |       |         \</span><br><span class="line"> Subtype1_1  Subtype1_2  Subtype2_1  Subtype2_2</span><br><span class="line">     |          |           |           |</span><br><span class="line">     |*         |*          |*          |*</span><br><span class="line">     |          |           |           |</span><br><span class="line">    Any        Any         Any         Any       &lt;- Any æœ‰æ‰€æœ‰å±æ€§</span><br><span class="line">                                                     (ä¸åƒ `object`</span><br><span class="line">                                                      -- `object` æ²¡æœ‰å±æ€§)</span><br><span class="line">* ä¸€è‡´æ€§å…³ç³»ï¼Œä¸æ˜¯å­ç±»å‹ï¼Œè§ä¸‹æ–‡</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œ<code>Any</code> ç±»å‹å’Œå…¶ä»–ç±»å‹ä¹‹é—´çš„å…³ç³»ä¸æ˜¯å¾®å¦™çš„å…³ç³»ï¼Œè€Œæ˜¯ä¿æŒä¸€è‡´çš„å…³ç³»ã€‚æœ‰å…³æ­£å¼å®šä¹‰å’Œæ›´å¤šä¸Šä¸‹æ–‡ï¼Œè¯·å‚è§<a href="https://www.python.org/dev/peps/pep-0483/#summary-of-gradual-typing" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><p>å®é™…ä¸Šï¼Œ<code>Any</code> åªæ˜¯å…³é—­å®ƒæ­£åœ¨æ³¨è§£çš„é¡¹ç›®çš„ mypy æ£€æŸ¥ã€‚ç¦ç”¨ mypy æ£€æŸ¥çš„å¦ä¸€ç§æ›´æ®‹é…·çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code># type: ignore</code>ã€‚åœ¨ä½ æƒ³è®© mypy é”™è¯¯æ¶ˆå¤±çš„è¡Œä¸Šä½¿ç”¨å®ƒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">height: int</span><br><span class="line">height = <span class="string">'25'</span>  <span class="comment"># type: ignore</span></span><br><span class="line"><span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">lassie: Dog</span><br><span class="line">lassie.fly()  <span class="comment"># type: ignore</span></span><br><span class="line"><span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br></pre></td></tr></table></figure><p><code>Any</code> çš„ä½¿ç”¨åº”è¯¥å°½å¯èƒ½å°‘ï¼Œè€Œä½¿ç”¨ <code># type: ignore</code> åº”è¯¥æ˜¯æœ€åä¸€æ‹›ã€‚å°¤å…¶æ˜¯å½“ä½ è®¤çœŸå¯¹å¾…æ•´ä¸ªç±»å‹å·¥ä½œçš„æ—¶å€™ã€‚</p><p>ä½ ç»å¯¹ä¸åº”è¯¥åœ¨ä¸‹åˆ—æƒ…å†µä¸‹ä½¿ç”¨å®ƒä»¬ï¼š</p><ul><li>ä½ æƒ³æ¨è¿Ÿæ³¨è§£ä¸€äº›ä¸œè¥¿ã€‚å¦‚æœä½ ç°åœ¨ä¸æƒ³æ·»åŠ ä¸€ä¸ªç±»å‹ï¼Œå°±è®©è¿™ä¸ªä¸œè¥¿æ²¡æœ‰ç±»å‹ã€‚Python ç±»å‹ç³»ç»Ÿæ˜¯å®Œå…¨å¯é€‰çš„â€”â€”æ‚¨å¯ä»¥è‡ªç”±æ³¨è§£ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ³¨è§£å¦ä¸€éƒ¨åˆ†ã€‚</li><li>ä½ ä¸ç†è§£ mypy çš„é”™è¯¯ä¿¡æ¯ï¼Œåªæƒ³æ‘†è„±å®ƒã€‚æœ‰æ—¶å€™å®ƒå¯èƒ½æ˜¯å¤ªç¥ç§˜æˆ–è€…å¤ªæ™®é€šäº†ï¼Œä½†æ˜¯çœŸçš„å€¼å¾—æ·±å…¥ç ”ç©¶è¿™ä¸ªé—®é¢˜ã€‚åœ¨æˆ‘çš„ç»éªŒä¸­ï¼Œå‡ ä¹æ¯æ¬¡ mypy éƒ½å‘ç°äº†ä»€ä¹ˆã€‚</li></ul><p><code>Any</code> åœ¨å“ªå¯èƒ½æœ‰ç”¨ï¼Ÿ</p><ul><li>å½“ä½ çœŸçš„ä¸çŸ¥é“å˜é‡çš„ç±»å‹æ—¶ï¼Œä½¿ç”¨ <code>Any</code>ã€‚å…¸å‹çš„ä¾‹å­æ˜¯ä»å¤–éƒ¨æä¾›çš„ JSON åˆ›å»ºçš„æ•°æ®ã€‚è¿™æ ·åˆ›å»ºçš„å˜é‡çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯ä¸€ä¸ª <code>list</code>ï¼Œ<code>dict</code>ï¼Œ<code>int</code>ï¼Œ<code>float</code>ï¼Œ<code>bool</code> è¿˜æ˜¯ <code>None</code>ï¼Ÿä¹Ÿå¯ä»¥æ˜¯ <code>Any</code>ã€‚è¯·æ³¨æ„ï¼Œä½¿ç”¨åµŒå¥—ç±»å‹ï¼ˆ<code>Dict</code>ã€<code>List</code> ç­‰ï¼‰æ­£ç¡®å®šä¹‰ JSON æ ¼å¼æ˜¯ä¸å¯èƒ½çš„ï¼ˆæˆ–è€…è‡³å°‘éå¸¸å›°éš¾ï¼‰ï¼Œå› ä¸º <a href="https://www.json.org/" target="_blank" rel="noopener">JSON çš„é€’å½’ç»“æ„</a>ã€‚</li></ul><p><code># type: ignore</code> åœ¨å“ªå¯èƒ½æœ‰ç”¨ï¼Ÿ</p><ul><li>å½“ mypy ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œè¿è¡Œæ—¶å‘ç”Ÿäº†ä¸€äº›å˜åŒ–â€”â€”å°±åƒæ–¹æ³•è¢«åŠ¨æ€æ·»åŠ åˆ°ç±»ä¸­æˆ–è€…ç±»å±‚æ¬¡ç»“æ„å‘ç”Ÿäº†å˜åŒ–ã€‚å¦‚æœ mypy çš„é”™è¯¯çœŸçš„ä¸å¤ªèƒœä»»ï¼Œå¹¶ä¸”ä½ æ— æ³•æƒ³å‡ºå¦ä¸€ç§æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ <code># type: ignore</code> ã€‚ä½†æ˜¯é¦–å…ˆï¼Œè¯•ç€ç†è§£ä¸ºä»€ä¹ˆ mypy åœ¨æŠ±æ€¨ã€‚äº‹å®ä¸Šï¼Œmypy æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„åå‘³é“ä»£ç æ£€æµ‹å™¨ã€‚</li><li>å½“æŸäº›ä¸œè¥¿è¿˜ä¸å…¼å®¹ mypy æ—¶ï¼ˆæ¯”å¦‚ <a href="https://docs.python.org/3.6/library/enum.html" target="_blank" rel="noopener">enums</a>ï¼Œä¸€å¼€å§‹ä¸æ”¯æŒï¼‰ã€‚</li><li>mypy ä¸­æœ‰ bugã€‚è®°å¾—åœ¨ <a href="https://github.com/python/mypy/issues" target="_blank" rel="noopener">github</a> ä¸Šæå‡ºè¿™ä»¶äº‹ï¼</li></ul><h2 id="qa">Q&amp;A</h2><p>å¦‚æœä½ è¿˜ä¸èƒ½è¢«è¯´æœå¼€å§‹ä½¿ç”¨ Python ç±»å‹ç³»ç»Ÿï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚</p><h3 id="æˆ‘å–œæ¬¢æˆ‘çš„-python-ä»£ç å…·æœ‰åŠ¨æ€æ€§å’Œé¸­å­ç±»å‹ç±»å‹ä¼šæ¯äº†è¿™ä¸€åˆ‡æ˜¯å—">æˆ‘å–œæ¬¢æˆ‘çš„ Python ä»£ç å…·æœ‰åŠ¨æ€æ€§å’Œé¸­å­ç±»å‹ã€‚ç±»å‹ä¼šæ¯äº†è¿™ä¸€åˆ‡ã€‚æ˜¯å—ï¼Ÿ</h3><p>é¦–å…ˆï¼Œmypy ç¡®å®ä¸ä¼šç†è§£ä¸€äº›ä¸è¯­è¨€çš„åŠ¨æ€ç‰¹æ€§ç›¸å…³çš„è¿è¡Œæ—¶é»‘ç§‘æŠ€ã€‚ç„¶è€Œï¼Œä½œä¸ºå›æŠ¥ï¼Œä½ ä¼šå¾—åˆ°æ›´å¯é çš„ä»£ç ã€‚</p><p>å…¶æ¬¡ï¼ŒPython ç±»å‹ç³»ç»Ÿ<a href="https://www.python.org/dev/peps/pep-0544/" target="_blank" rel="noopener">æ”¯æŒåè®®</a>ï¼ˆä¹Ÿç§°ä¸ºâ€œé¸­å­ç±»å‹â€ï¼‰ï¼Œæ—¢æ”¯æŒå†…ç½®åè®®ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·å®šä¹‰çš„åè®® ï¼ˆæœ¬ä¸»é¢˜ä¸åœ¨æ­¤è®¨è®ºï¼‰ã€‚æ‰€ä»¥ä¸ç”¨æ‹…å¿ƒã€‚</p><h3 id="å¦ç™½åœ°è¯´æˆ‘ä¸å–œæ¬¢è¿™æ•´ä»¶ç±»å‹ç³»ç»Ÿçš„äº‹æƒ…æ˜¯ä¸æ˜¯æ…¢æ…¢åœ°å°†-python-å˜æˆäº†-java">å¦ç™½åœ°è¯´ï¼Œæˆ‘ä¸å–œæ¬¢è¿™æ•´ä»¶ç±»å‹ç³»ç»Ÿçš„äº‹æƒ…ã€‚æ˜¯ä¸æ˜¯æ…¢æ…¢åœ°å°† Python å˜æˆäº† Javaï¼Ÿ</h3><p>ä¸è¦æ‹…å¿ƒï¼Œä¸ Java ä¸åŒï¼ŒPython çš„ç±»å‹ç³»ç»Ÿï¼š</p><ul><li>å®Œå…¨å¯é€‰ï¼ˆ*ï¼‰ï¼Œ</li><li>ä¸ä¼šå½±å“è¿è¡Œæ—¶ï¼ˆ**ï¼‰ã€‚</li></ul><p>ï¼ˆ*ï¼‰å¥½å§ï¼Œä¸å®Œå…¨æ˜¯ï¼Œ<code>dataclasses</code> <a href="https://docs.python.org/3/library/dataclasses.html" target="_blank" rel="noopener">å¼ºè¿«ä½ ä½¿ç”¨ç±»å‹</a>ã€‚å¸Œæœ›è¿™æ˜¯ä¸€ä¸ªå¼‚ç«¯ã€‚</p><p>ï¼ˆ**ï¼‰å¥½å§ï¼Œä¸å®Œå…¨æ˜¯â€¦â€¦ é¦–å…ˆï¼Œä» <code>typing</code> ä¸­å¯¼å…¥ä¼šå½±å“ã€‚å…¶æ¬¡ï¼Œä¸€äº›å€¼â€”â€”ä¾‹å¦‚ <code>cast</code> å’Œ <code>NewType</code> â€”â€”é€šè¿‡èº«ä»½å‡½æ•°ä¼ é€’ã€‚ç¬¬ä¸‰ï¼Œ<a href="https://docs.python.org/3/library/typing.html#typing.Generic" target="_blank" rel="noopener">æ³›å‹ç±»å‹</a>ï¼ˆæœ¬æ–‡ä¸­æœªæ¶µç›–ï¼‰ä½¿ç”¨è‡ªå®šä¹‰å…ƒç±»ï¼Œè¿™å¯èƒ½ä¸ç”¨æˆ·å®šä¹‰çš„å…ƒç±»å†²çªï¼›<a href="https://www.python.org/dev/peps/pep-0560/" target="_blank" rel="noopener">åœ¨ Python 3.7 ä¸­ï¼Œè¿™ä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜</a>ã€‚</p><h3 id="æ²¡é”™ä½†æ˜¯çœ‹çœ‹ç±»å‹åŒ–çš„-python-ä»£ç æ›´åƒ-javaè€Œä¸æ˜¯å¥½çš„è€-python">æ²¡é”™ï¼Œä½†æ˜¯çœ‹çœ‹ç±»å‹åŒ–çš„ Python ä»£ç ï¼šæ›´åƒ Javaï¼Œè€Œä¸æ˜¯å¥½çš„è€ Pythonã€‚</h3><p>è¿™å¯èƒ½æ˜¯ç¬¬ä¸€å°è±¡ï¼Œä½†æ˜¯ä½ çœŸçš„çœ‹è¿‡ä¼ä¸š Java ä»£ç åº“å—ï¼Ÿæˆ‘ä¸å¦è®¤ç±»å‹åŒ–çš„ Python ä»£ç çœ‹èµ·æ¥ä¸éç±»å‹åŒ–ä»£ç ä¸åŒï¼Œä½ éœ€è¦ä¹ æƒ¯é˜…è¯»å®ƒã€‚ä½†æ˜¯å½“ä½ è¿™æ ·åšçš„æ—¶å€™â€”â€”å¹¶ä¸”ä»£ç æœ¬èº«æ˜¯ä»¥ä¸€ç§èªæ˜çš„æ–¹å¼å…·æœ‰ç±»å‹çš„ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨åˆ«åï¼‰â€”â€”å®ƒä¼šå˜å¾—æ¯”æ·»åŠ ç±»å‹ä¹‹å‰æ›´åŠ æ˜“è¯»æ˜“æ‡‚ã€‚å®ƒä»ç„¶æ˜¯ Pythonic çš„ï¼Œå› ä¸ºå®ƒå¢åŠ äº†ä»£ç çš„æ¸…æ™°æ€§å’Œå¯è¯»æ€§ã€‚</p><h3 id="å¥½å§è®©æˆ‘è¯•è¯•è¿™ä¸ª-æˆ‘å¦‚ä½•å¼€å§‹åœ¨ä»£ç åº“ä¸­ä½¿ç”¨ç±»å‹æ³¨è§£">å¥½å§ï¼Œè®©æˆ‘è¯•è¯•è¿™ä¸ªâ€¦ æˆ‘å¦‚ä½•å¼€å§‹åœ¨ä»£ç åº“ä¸­ä½¿ç”¨ç±»å‹æ³¨è§£ï¼Ÿ</h3><p>æˆ‘æ¨èä»¥ä¸‹æ­¥éª¤ï¼š</p><ol type="1"><li>ä»åœ¨ä½ çš„éç±»å‹åŒ–ä»£ç ä¸Šè¿è¡Œ mypy å¼€å§‹ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä½ å¯èƒ½ä¼šæƒŠè®¶äºå®ƒå·²ç»ç†è§£äº†è¿™ä¹ˆå¤šã€‚ï¼ˆæ‚¨å¯èƒ½å¸Œæœ›é¦–å…ˆä½¿ç”¨ <code>--ignore-missing-imports</code> å’Œ <code>--follow-imports skip</code> å‚æ•°æ¥è¿è¡Œå®ƒã€‚ï¼‰</li><li>ä¿®å¤æ‰€æœ‰åˆå§‹çš„ mypy é”™è¯¯ã€‚</li><li>ç°åœ¨ï¼Œåªéœ€å¼€å§‹å‘ä»£ç ä¸­æ·»åŠ ç±»å‹æ³¨è§£ã€‚ä½ å¯ä»¥ä»ä»»ä½•åœ°æ–¹å¼€å§‹ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºæœ€å¥½ä»æœ€é‡è¦çš„ä»£ç å¼€å§‹ã€‚è¿™æ ·ï¼Œä½ çš„ä»£ç åº“å°†ä¼šæ›´å¯é ã€‚ä¸è¦æ‹…å¿ƒé”™è¯¯çš„ç±»å‹æ³¨è§£ä¼šç ´åä½ çš„ä»£ç ï¼šç±»å‹ä¼šå°½å¯èƒ½å°‘åœ°å½±å“ Python çš„è¿è¡Œæ—¶ã€‚</li><li>ç»§ç»­æ·»åŠ ç±»å‹æ³¨è§£ã€‚è¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œæ·»åŠ ç±»å‹æ³¨è§£å°†å¼€å§‹è§æ•ˆã€‚ä½ å¯èƒ½ä¼šæ”¶åˆ°è¶Šæ¥è¶Šå¤šçš„æ•æ‰åˆ°çœŸæ­£é”™è¯¯çš„ mypy é”™è¯¯ã€‚ï¼ˆåªæ˜¯ä¸è¦å¿˜è®°è¿è¡Œ mypyã€‚ï¼‰</li><li>ä¸‹ä¸€æ­¥æ˜¯å°† mypy æ£€æŸ¥æ·»åŠ åˆ° CI æµç¨‹ï¼ˆä¹Ÿè®¸æ˜¯é¢„æäº¤é’©å­ï¼‰ä¸­ï¼Œå¹¶ä½¿ä»£ç å§‹ç»ˆæ›´åŠ å¯é ã€‚</li></ol><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä½ è‡´åŠ›äºç±»å‹ï¼Œæœ€å¥½æ³¨è§£æ‰€æœ‰æ–°ä»£ç ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œå½“æ‚¨åªæƒ³å¿«é€ŸåŸå‹åŒ–åŠŸèƒ½æ—¶ï¼Œè·³è¿‡æ³¨è§£é˜¶æ®µã€‚å½“ä½ çŸ¥é“ä»£ç ä¼šç¨³å®šä¸‹æ¥ï¼Œä½ å¯ä»¥æ·»åŠ ç±»å‹æ³¨è§£ã€‚</p><p>æ‚¨ä¹Ÿå¯ä»¥å°è¯•ä»ä½¿ç”¨è‡ªåŠ¨å·¥å…·æ·»åŠ ç±»å‹æ³¨è§£å¼€å§‹ã€‚<a href="https://github.com/dropbox/pyannotate" target="_blank" rel="noopener">pyannotate</a> åº“ä»è¿è¡Œæ—¶è§‚å¯Ÿå®é™…ç±»å‹ä¸­è·å–ç±»å‹ä¿¡æ¯ã€‚ç±»ä¼¼åœ°ï¼Œ<a href="https://github.com/kensho-technologies/pytest-annotate" target="_blank" rel="noopener">pytest-annotate</a> é€šè¿‡è¿è¡Œæµ‹è¯•å’Œè§‚å¯Ÿç±»å‹æ·»åŠ ç±»å‹æ³¨è§£ã€‚å¦å¤–ï¼Œ<a href="https://github.com/google/pytype" target="_blank" rel="noopener">pytype</a> å¯ä»¥åŸºäºä»£ç çš„é™æ€åˆ†ææ·»åŠ æ³¨è§£ã€‚æˆ‘æ²¡æœ‰ä½¿ç”¨è¿™äº›å·¥å…·çš„ç»éªŒï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºä»”ç»†éªŒè¯å…¶ä¸­ä»»ä½•ä¸€ä¸ªå·¥å…·ç»™å‡ºçš„æ³¨è§£æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ç ”ç©¶è¿™äº›æ³¨è§£ç”šè‡³å¯èƒ½å¯¼è‡´å‘ç°ä»£ç ä¸­çš„ä¸€äº›é”™è¯¯ã€‚</p><h3 id="å½“æˆ‘æ²¡æœ‰æ—¶é—´ç†è§£-mypy-çš„é”™è¯¯æ—¶è¯¥æ€ä¹ˆåŠ">å½“æˆ‘æ²¡æœ‰æ—¶é—´ç†è§£ mypy çš„é”™è¯¯æ—¶è¯¥æ€ä¹ˆåŠï¼Ÿ</h3><p>æ‰¾åˆ°æ—¶é—´ï¼Œå®ƒå¯èƒ½ä¼šæœ‰å›æŠ¥ã€‚ä¸è¦ç”¨ <code># type: ignore</code>ï¼Œä½†æ˜¯å…ˆè¯•ç€ç†è§£è¿™ä¸ªé—®é¢˜ï¼ˆæœ‰æ—¶åœ¨ <a href="https://github.com/python/mypy/issues" target="_blank" rel="noopener">mypy é—®é¢˜é¡µé¢</a>ä¸Šæœç´¢æ˜¯å”¯ä¸€çš„æ–¹æ³•ï¼‰ï¼Œåªæœ‰å½“ä½ ç¡®ä¿¡æ²¡æœ‰å¥½çš„é€‰æ‹©æ—¶ï¼Œæ‰ä½¿ç”¨å®ƒã€‚mypy å¯èƒ½ï¼Œå¾ˆå¯èƒ½ï¼Œå‘ç°äº†ä»€ä¹ˆä¸œè¥¿ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œæ— è®ºä»£ä»·æ˜¯ä»€ä¹ˆï¼Œä¸è¦è¯•å›¾å–æ‚¦ mypyã€‚ç»éªŒæ³•åˆ™æ˜¯ï¼šä¸è¦ä»…ä»…ä¸ºäº†æŠ‘åˆ¶ mypy é”™è¯¯è€Œè®©ä»£ç å˜å¾—æ›´ç³Ÿã€‚å®ƒä»ç„¶åªæ˜¯ä¸€ç§å·¥å…·ã€‚</p><p>è¯·è®°ä½ï¼Œmypy æ­£åœ¨ä¸æ–­å‘å±•ã€‚å®ƒçš„é”™è¯¯ä¿¡æ¯è¶Šæ¥è¶Šå¥½ï¼Œè¯¯æŠ¥ï¼ˆä¸æ—¶è¢«å‘ç°ï¼‰ä¹Ÿè¶Šæ¥è¶Šå°‘ã€‚æ‰€ä»¥ï¼Œè®°å¾—åœ¨æ–°ç‰ˆæœ¬å‘å¸ƒæ—¶æ›´æ–° mypyã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å†™åœ¨å‰é¢&quot;&gt;å†™åœ¨å‰é¢&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡ç¿»è¯‘è‡ª &lt;a href=&quot;https://blog.daftcode.pl/next-steps-with-python-type-system-efc4df5251c9&quot; target=&quot;_blank&quot;
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Python ç±»å‹ç³»ç»Ÿçš„ç¬¬ä¸€æ­¥</title>
    <link href="http://weafteam.github.io/posts/cde2bcff/"/>
    <id>http://weafteam.github.io/posts/cde2bcff/</id>
    <published>2018-08-08T13:52:35.000Z</published>
    <updated>2018-08-12T09:51:01.082Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢</h2><p>æœ¬æ–‡ç¿»è¯‘è‡ª <a href="https://blog.daftcode.pl/first-steps-with-python-type-system-30e4296722af" target="_blank" rel="noopener">First Steps with Python Type System</a>ã€‚</p><p>è‡ªè±ªçš„é‡‡ç”¨æœç‹—ç¿»è¯‘ã€‚</p><h2 id="è¿™æ˜¯ä»€ä¹ˆç©æ„">è¿™æ˜¯ä»€ä¹ˆç©æ„ï¼Ÿ</h2><p>åœ¨è¿‡å»å‡ å¹´ä¸­ï¼Œç±»å‹æ³¨è§£çš„è¯­æ³•å’Œè¯­ä¹‰é€æ¸è¢«å¼•å…¥ Python è¯­è¨€ã€‚ç±»å‹åœ¨ Python ä¸­ä»ç„¶æ˜¯ä¸€ä¸ªéå¸¸æ–°é¢–å¹¶ä¸”ç»å¸¸è¢«è¯¯è§£çš„ä¸»é¢˜ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šä»‹ç»å®ƒçš„åŸºç¡€çŸ¥è¯†ï¼Œè€Œä¸€äº›æ›´é«˜çº§çš„åŠŸèƒ½å°†å‡ºç°åœ¨æœ¬æ–‡çš„åç»­éƒ¨åˆ†ä¸­ã€‚</p><p>è¿™ç¯‡æ–‡ç« åŸºäºÂ <a href="https://www.python.org/dev/peps/pep-0483" target="_blank" rel="noopener">PEP 483: The Theory of Type Hints</a>ï¼Œ<a href="https://www.python.org/dev/peps/pep-0484" target="_blank" rel="noopener">PEP 484: Type Hints</a>ï¼ŒPython ç±»å‹<a href="https://docs.python.org/3/library/typing.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ï¼Œmypy çš„Â <a href="https://github.com/python/mypy/issues" target="_blank" rel="noopener">github issues</a>ï¼Œå’Œæˆ‘ä¸ªäººå¯¹äºç±»å‹åœ¨ç°å®ä»£ç æ–¹é¢çš„ç»éªŒã€‚æˆ‘åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬ä¸º Python 3.6 å’Œ mypy 0.620ã€‚</p><h2 id="ç±»å‹å’Œç±»">1. ç±»å‹å’Œç±»</h2><p>ä¸ºäº†æ›´å¥½åœ°æŒæ¡ Python çš„ç±»å‹ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†ç±»å‹å’Œç±»ã€‚åœ¨å‘å¸ƒ PEP 483 å’Œ 484 ä¹‹å‰ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæœ‰äº›æ··ä¹±ã€‚ç°åœ¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œç±»å‹æ˜¯ç±»å‹æ£€æŸ¥å™¨æ¦‚å¿µï¼Œç±»æ˜¯è¿è¡Œæ—¶æ¦‚å¿µã€‚åœ¨è¿™ä¸¤è€…çš„åŸºæœ¬æè¿°ä¸­ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†å…³é”®ä¿¡æ¯ï¼šç±»å‹ä¸åœ¨è¿è¡Œæ—¶çš„ â€œé¢†åŸŸâ€ ä¸­ã€‚å®é™…ä¸Šï¼Œç±»å‹æ˜¯ç¨‹åºçš„å¦ä¸€ä¸ª â€œå±‚â€ ä¸Šçš„ä¸œè¥¿ï¼Œä¸€ä¸ªç”¨äºç±»å‹æ£€æŸ¥çš„å±‚ã€‚</p><p>ä½†æ˜¯ä»€ä¹ˆæ˜¯ç±»å‹æ£€æŸ¥å™¨ï¼Ÿè¿™æ˜¯ä¸€ä¸ªåˆ†ææˆ‘ä»¬ä»£ç çš„å·¥å…·ï¼ˆç±»ä¼¼äº flake8ï¼Œä½†æ›´æ™ºèƒ½ï¼‰ã€‚å®ƒä¸ä»¥ä»»ä½•æ–¹å¼è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œåªä¼šé™æ€æ£€æŸ¥ä»£ç çš„ç±»å‹ä¸€è‡´æ€§ã€‚Python ç¤¾åŒºçš„å®˜æ–¹ç±»å‹æ£€æŸ¥å™¨æ˜¯ mypyã€‚æ­¤å¤–è¿˜æœ‰ Facebook çš„ <a href="https://github.com/facebook/pyre-check" target="_blank" rel="noopener">pyre-check</a> å’Œè°·æ­Œçš„ <a href="https://github.com/google/pytype" target="_blank" rel="noopener">pytype</a>ã€‚</p><h3 id="å¦‚ä½•å®šä¹‰ç±»å‹">1.1 å¦‚ä½•å®šä¹‰ç±»å‹ï¼Ÿ</h3><p>ç±»å‹æ£€æŸ¥å™¨éœ€è¦å…³äºç±»å‹çš„ä¿¡æ¯æ¥æ£€æŸ¥æˆ‘ä»¬çš„ç¨‹åºã€‚å®šä¹‰ç±»å‹æœ‰ä¸‰ç§åŸºæœ¬æ–¹æ³•ï¼š</p><ol type="1"><li>é€šè¿‡å®šä¹‰ä¸€ä¸ªç±»ï¼Œ</li><li>é€šè¿‡æŒ‡å®šä½¿ç”¨ç±»å‹å˜é‡çš„å‡½æ•°ï¼Œ</li><li>é€šè¿‡ä½¿ç”¨æ›´åŸºæœ¬çš„ç±»å‹æ¥åˆ›å»ºæ›´å¤æ‚çš„ç±»å‹ã€‚</li></ol><p>ç¬¬ä¸€ç§æƒ…å†µä¸­ï¼Œè¯­å¥ <code>class Animal: â€¦</code> åŒæ—¶å®šä¹‰äº† <code>Animal</code> ç±»å’Œ <code>Animal</code> ç±»å‹ã€‚è¿™ä¹Ÿé€‚ç”¨äºå†…ç½®ç±»å‹ï¼š<code>int</code>ï¼Œ<code>float</code>ï¼Œ<code>str</code>ï¼Œ<code>list</code>ï¼Œ<code>dict</code> ç­‰ç­‰ï¼Œå®ƒä»¬ä¹ŸåŒæ—¶æ˜¯ç±»å’Œç±»å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»è¢«ä¸€ä¸€æ˜ å°„åˆ°å­ç±»å‹å…³ç³»ã€‚å› æ­¤ï¼Œå¦‚æœ <code>Dog</code> æ˜¯ <code>Animal</code> çš„ä¸€ä¸ªå­ç±»ï¼Œé‚£ä¹ˆ <code>Dog</code> å°±æ˜¯ <code>Animal</code> çš„ä¸€ä¸ªå­ç±»å‹ï¼Œç­‰ç­‰ã€‚è¿™ç§å¤„ç†ç±»å‹çš„æ–¹æ³•è¢«ç§°ä¸ºâ€œå‘½åå­ç±»å‹â€ã€‚ä¸€ä¼šå„¿ï¼Œæˆ‘å°†å±•ç¤ºå®ƒåœ¨ç±»å‹æ£€æŸ¥çš„æƒ…å¢ƒä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p>ç¬¬äºŒç§æƒ…å†µæ˜¯é¸­å­ç±»å‹çš„ç²¾ç¥ï¼šæˆ‘ä»¬é€šè¿‡æŒ‡å®šå“ªäº›å‡½æ•°/æ–¹æ³•ä½¿ç”¨æ­¤ç±»å‹çš„å˜é‡æ¥å®šä¹‰ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æœ‰ <code>__len__</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå…·æœ‰ <code>Sized</code> ç±»å‹ã€‚è¿™ç§å¤„ç†ç±»å‹çš„æ–¹æ³•è¢«ç§°ä¸ºâ€œç»“æ„å­ç±»å‹â€ã€‚è¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¯é¢˜ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­åªä¼šç•¥åŠ è®¨è®ºã€‚</p><p>åœ¨ç¬¬ä¸‰ç§æƒ…å†µä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ—©æœŸå®šä¹‰çš„ç±»å‹ï¼ˆä»¥ä»»ä½•æ–¹å¼ï¼‰æ¥å®šä¹‰æ›´å¤æ‚çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹ç±»å‹ï¼šâ€œä»…åŒ…å«æ•´æ•°æˆ–å­—ç¬¦ä¸²å®ä¾‹çš„åˆ—è¡¨â€ã€‚ç¨åå°†ä»‹ç»è¿™äº›ç±»å‹ã€‚</p><h2 id="ç±»å‹æ³¨è§£è¯­æ³•">2. ç±»å‹æ³¨è§£è¯­æ³•</h2><p>ä¸ºäº†ç”¨ç±»å‹ä¿¡æ¯ç»™æˆ‘ä»¬çš„ä»£ç åšæ³¨è§£ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ç‰¹æ®Šçš„è¯­æ³•ã€‚è¿™ç§è¯­æ³•é€æ¸è¢«å¼•å…¥åˆ°è¯­è¨€ä¸­ï¼Œä½†æ˜¯ç°åœ¨åªå…³æ³¨å®ƒçš„å½“å‰ï¼ˆä¹Ÿå¾ˆå¯èƒ½æ˜¯æœ€ç»ˆï¼‰çŠ¶æ€ã€‚</p><h3 id="æ³¨è§£å˜é‡">2.1 æ³¨è§£å˜é‡</h3><p>è¦æ³¨è§£å˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨å˜é‡ååè·Ÿå†’å·å’Œç±»å‹åã€‚å˜é‡åˆå§‹åŒ–æ˜¯å¯é€‰çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name: Type</span><br></pre></td></tr></table></figure><p>ç±»å‹æ³¨è§£ä¸åˆå§‹åŒ–å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name: Type = initial_value</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä»ç°åœ¨å¼€å§‹ï¼Œmypy çŸ¥é“ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œ<code>name</code> åº”è¯¥å…·æœ‰ <code>Type</code> ç±»å‹ï¼Œå¹¶å°†æ£€æŸ¥æ˜¯å¦ç¡®å®å¦‚æ­¤ã€‚äº‹å®ä¸Šï¼Œç¬¬ä¸€æ¬¡æ£€æŸ¥æ˜¯åœ¨èµ‹å€¼é˜¶æ®µè¿›è¡Œçš„ï¼š<code>initial_value</code> æ˜¯ <code>Type</code> ç±»å‹çš„å—ï¼Ÿ</p><p>å¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ä½¿ç”¨å®ƒï¼ˆä¼šå¼•å‘ <code>NameError</code>ï¼‰ï¼Œä½†æ˜¯ç¨åï¼Œåœ¨æˆ‘ä»¬åˆå§‹åŒ–å®ƒä¹‹åï¼Œmypy ä¼šç”¨å£°æ˜çš„å˜é‡ç±»å‹æ¥æ£€æŸ¥å€¼çš„ç±»å‹ã€‚</p><p>è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯ä»€ä¹ˆæ ·çš„ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä¼šæŠŠæ‰€æœ‰çš„ mypy é”™è¯¯æ”¾åœ¨æ³¨é‡Šä¸­ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">width: int</span><br><span class="line">width = <span class="number">15</span>  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">height: int</span><br><span class="line">height = <span class="string">"25"</span>  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Incompatible types in assignment (expression has type "str", variable has type "int")</span></span><br><span class="line"></span><br><span class="line">depth: int = <span class="number">15.5</span>  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># error:Incompatible types in assignment (expression has type "float", variable has type "int")</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å³ä½¿åœ¨è¿™äº›ç®€å•çš„æƒ…å†µä¸‹ï¼Œmypy ä¹Ÿå·²ç»å¾ˆæœ‰ç”¨äº†ã€‚</p><h3 id="æ³¨è§£å‡½æ•°">2.2 æ³¨è§£å‡½æ•°</h3><p>æˆ‘ä»¬è¿˜å¯ä»¥æ³¨è§£å‡½æ•°çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ã€‚ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">function</span><span class="params">(arg1: Type1, arg2: Type2)</span> -&gt; ReturnType:</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬çœ‹çœ‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_ints</span><span class="params">(x: int, y: int)</span> -&gt; int:</span></span><br><span class="line">    <span class="keyword">return</span> x + y  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_ints(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line">add_ints(<span class="number">1</span>, <span class="number">2.0</span>)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument 2 to "add_ints" has incompatible type "float"; expected "int"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">broken_add</span><span class="params">(x: int, y: int)</span> -&gt; str:</span></span><br><span class="line">    <span class="keyword">return</span> x + y  <span class="comment"># é”™è¯¯:</span></span><br><span class="line">    <span class="comment"># Incompatible return value type (got "int", expected "str")</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œmypy é€šè¿‡æ£€æŸ¥ <code>+</code> è¿ç®—ç¬¦ï¼ˆå®é™…ä¸Šæ˜¯ <code>__add__</code> æ–¹æ³•ï¼‰çš„è¿”å›ç±»å‹çŸ¥é“ <code>broken_add</code> åœ¨ä¸¤ä¸ª <code>int</code> ä¸Šä½¿ç”¨æ—¶æœ‰é”™è¯¯çš„è¿”å›ç±»å‹ï¼šå®ƒæ˜¯ä¸€ä¸ª <code>int</code>ï¼Œè€Œä¸æ˜¯ <code>str</code>ï¼Œæ‰€ä»¥å‡½æ•°çš„è¿”å›ç±»å‹å£°æ˜ä¸æ­£ç¡®ã€‚</p><h2 id="å­ç±»å‹">3. å­ç±»å‹</h2><p>åœ¨æˆ‘ä»¬å¼€å§‹å°è¯•æ‰€æœ‰å…³äº Python ç±»å‹çš„ä¸œè¥¿ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¥½åœ°ç†è§£åŸºæœ¬çš„å­ç±»å‹å…³ç³»ã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šï¼Œå­ç±»å‹æ˜¯ä¸€ç§ä¸å¤ªæ™®éçš„ç±»å‹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ<code>Dog</code> æ²¡æœ‰ <code>Animal</code> ä¸€èˆ¬ï¼Œæ‰€ä»¥å®ƒæ˜¯ <code>Animal</code> çš„ä¸€ä¸ªå­ç±»å‹ã€‚ä½†æ˜¯è®©æˆ‘ä»¬æ·±å…¥ä¸€ç‚¹ï¼Œçœ‹çœ‹ Python ä¸­å¦‚ä½•å®šä¹‰å­ç±»å‹å…³ç³»ã€‚è¿™ä¸ªå®šä¹‰å°†å†³å®šèµ‹å€¼è§„åˆ™å’Œå±æ€§è§„åˆ™çš„ä½¿ç”¨ï¼Œè¿™äº›è§„åˆ™æ˜¯ mypy åœ¨ä»£ç ä¸Šå¼ºåˆ¶æ‰§è¡Œçš„ã€‚</p><h3 id="å®šä¹‰">3.1 å®šä¹‰</h3><p>æˆ‘ä»¬ç”¨ <code>&lt;:</code> è¡¨ç¤ºå­ç±»å‹å…³ç³»ã€‚ï¼ˆä¾‹å¦‚ <code>B &lt;: A</code> è¡¨ç¤º <code>B</code> æ˜¯ <code>A</code> çš„å­ç±»å‹ã€‚ï¼‰</p><p>ç°åœ¨ï¼Œ<code>B &lt;: A</code> å½“ä¸”ä»…å½“ï¼š</p><ol type="1"><li>ç±»å‹ <code>B</code> çš„æ¯ä¸ªå€¼ä¹Ÿåœ¨ç±»å‹ <code>A</code> çš„å€¼çš„é›†åˆä¸­ï¼›å¹¶ä¸”</li><li>ç±»å‹ <code>A</code> çš„æ¯ä¸ªå‡½æ•°ä¹Ÿåœ¨ç±»å‹ <code>B</code> çš„å‡½æ•°çš„é›†åˆä¸­ã€‚</li></ol><p>ï¼ˆâ€œç±»å‹ <code>A</code> çš„å‡½æ•°â€ åŸºæœ¬ä¸Šæ„å‘³ç€â€œæ¥å—ç±»å‹ <code>A</code> çš„å¯¹è±¡ä½œä¸ºå…¶å‚æ•°çš„å‡½æ•°â€ã€‚å› æ­¤ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå…·æœ‰ <code>A</code> ç±»å‹å‚æ•°çš„ç‹¬ç«‹å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ <code>A</code> ç±»ä¸Šå®šä¹‰çš„æ–¹æ³•ã€‚ï¼‰</p><p>å› æ­¤ï¼Œåœ¨å­ç±»å‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå€¼é›†åˆå˜å¾—æ›´å°ï¼Œè€Œå‡½æ•°é›†åˆå˜å¾—æ›´å¤§ï¼ˆå‚è§<a href="https://www.python.org/dev/peps/pep-0483/#subtype-relationships" target="_blank" rel="noopener">æ–‡æ¡£</a>å’Œ<a href="https://www.stephanboyer.com/post/132/what-are-covariance-and-contravariance" target="_blank" rel="noopener">è¿™ä¸ªåšå®¢</a>ï¼Œå®ƒå¯å‘äº†ç¬¦å·å’Œç¤ºä¾‹ï¼‰ã€‚</p><p>å°±æˆ‘ä»¬çš„ä¸¤ç§ç±»å‹è€Œè¨€ï¼Œ<code>Dog &lt;: Animal</code> æ„å‘³ç€ï¼š</p><ol type="1"><li>ä¸€ç»„ <code>Dog</code> æ˜¯ <code>Animal</code> çš„å­é›†ï¼ˆæ¯åª <code>Dog</code> éƒ½æ˜¯ <code>Animal</code>ï¼Œä½†ä¸æ˜¯æ¯åª <code>Animal</code> éƒ½æ˜¯ <code>Dog</code>ï¼‰ã€‚è¿™åŸºæœ¬ä¸Šæ„å‘³ç€ <code>Dog</code> æ¯” <code>Animal</code> å°‘ã€‚</li><li><code>Animal</code> çš„ä¸€ç»„å‡½æ•°æ˜¯ <code>Dog</code> çš„å‡½æ•°çš„å­é›†ï¼ˆ<code>Dog</code> å¯ä»¥åšä»»ä½• <code>Animal</code> èƒ½åšçš„äº‹æƒ…ï¼Œä½†æ˜¯ <code>Animal</code> ä¸èƒ½åšä»»ä½• <code>Dog</code> èƒ½åšçš„äº‹æƒ…ï¼‰ã€‚åŸºæœ¬ä¸Šï¼Œ<code>Animal</code> èƒ½åšçš„æ¯” <code>Dog</code> å°‘ã€‚</li></ol><h3 id="èµ‹å€¼è§„åˆ™">3.2 èµ‹å€¼è§„åˆ™</h3><p>è¿™ä¸ªå®šä¹‰å†³å®šäº†å“ªäº›èµ‹å€¼æ˜¯å¯æ¥å—çš„ï¼Œå“ªäº›æ˜¯ä¸å¯æ¥å—çš„ã€‚è®©æˆ‘ä»¬å°è¯•å°†ä¸€ç§ç±»å‹çš„å˜é‡åˆ†é…ç»™å¦ä¸€ç§ç±»å‹çš„å˜é‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dog &lt;: Animal</span></span><br><span class="line">scooby: Dog</span><br><span class="line">an_animal: Animal</span><br><span class="line"></span><br><span class="line">an_animal = scooby  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>å°† <code>scooby</code> èµ‹å€¼ç»™ <code>an_animal</code> æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸º <code>scooby</code> è¢«ä¿è¯æ˜¯ä¸€åª <code>Animal</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dog &lt;: Animal</span></span><br><span class="line">scooby: Dog</span><br><span class="line">an_animal: Animal</span><br><span class="line"></span><br><span class="line">scooby = an_animal  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Incompatible types in assignment (expression has type "Animal", variable has type "Dog")</span></span><br></pre></td></tr></table></figure><p>æŠŠ <code>an_animal</code> èµ‹å€¼ç»™ <code>scooby</code> ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸º <code>an_animal</code> å¯èƒ½ä¸æ˜¯ <code>Dog</code>ã€‚</p><p>æ£€æŸ¥ç»§æ‰¿å…³ç³»æ˜¯å‘½åå­ç±»å‹åŒ–æ–¹æ³•çš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="å±æ€§è§„åˆ™">3.3 å±æ€§è§„åˆ™</h3><p>mypy ä¸ä»…å…³æ³¨èµ‹å€¼ï¼Œè¿˜å…³æ³¨å±æ€§çš„ä½¿ç”¨ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œå®ƒæ£€æŸ¥å±æ€§æ˜¯å¦å®é™…å®šä¹‰åœ¨å¯¹è±¡ä¸Šã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span> ...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bark</span><span class="params">(self)</span>:</span> ...</span><br></pre></td></tr></table></figure><p>ç°åœ¨ <code>Animal</code> å¯ä»¥ <code>eat</code>ï¼Œ<code>Dog</code> å¯ä»¥ <code>eat</code> ï¼ˆé€šè¿‡ç»§æ‰¿ï¼‰å’Œ <code>bark</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dog &lt;: Animal</span></span><br><span class="line">an_animal: Animal</span><br><span class="line">snoopy: Dog</span><br><span class="line"></span><br><span class="line">an_animal.eat()  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line">snoopy.eat()  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">snoopy.bark()  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line">an_animal.bark()  <span class="comment"># é”™è¯¯: "Animal" has no attribute "bark"</span></span><br></pre></td></tr></table></figure><p>mypy ç¡®ä¿ç¡®å®åœ¨ç›¸å…³å¯¹è±¡ä¸Šå®šä¹‰äº†æ–¹æ³•ã€‚<code>an_animal</code> æ²¡æœ‰å®šä¹‰ <code>bark</code> æ–¹æ³•ï¼Œå› æ­¤ä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ã€‚</p><p>æ£€æŸ¥å±æ€§ï¼Œç‰¹åˆ«æ˜¯æ–¹æ³•ï¼Œæ˜¯ç»“æ„å­ç±»å‹åŒ–æ–¹æ³•çš„ä¸€éƒ¨åˆ†ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œâ€œå­ç±»å‹å…³ç³»æ˜¯ä»å£°æ˜çš„æ–¹æ³•ä¸­æ¨å¯¼å‡ºæ¥çš„â€[<a href="https://www.python.org/dev/peps/pep-0483/#background" target="_blank" rel="noopener">æ¥æº</a>]ã€‚</p><h2 id="å®šä¹‰å¤æ‚ç±»å‹">4. å®šä¹‰å¤æ‚ç±»å‹</h2><p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨æ›´åŸºæœ¬çš„ç±»å‹æ¥åˆ›å»ºæ›´å¤æ‚çš„ç±»å‹ã€‚è¿™æ˜¯åœ¨ Python ä¸­å®šä¹‰ç±»å‹çš„ç¬¬ä¸‰ç§æ–¹æ³•ã€‚æˆ‘å°†é›†ä¸­è®¨è®ºå‡ ä¸ªå…¸å‹çš„å¤æ‚ç±»å‹ï¼Œè€Œå…¶ä½™çš„å·¥ä½œæ–¹å¼åŸºæœ¬ç›¸åŒã€‚</p><h3 id="åˆ—è¡¨">4.1 åˆ—è¡¨</h3><p>å…¶ä¸­æœ€åŸºæœ¬çš„æ˜¯ <code>List</code>ã€‚é™¤äº†å¤§å†™å­—æ¯ <code>L</code> ä¹‹å¤–ï¼Œå®ƒçš„æ‹¼å†™ä¸å†…ç½® <code>list</code> ç›¸åŒã€‚è¯­æ³•å¦‚ä¸‹ï¼š<code>List[TypeOfElements]</code>ã€‚æ‰€ä»¥æ•´æ•°åˆ—è¡¨æ˜¯ <code>List[int]</code>ï¼Œå­—ç¬¦ä¸²åˆ—è¡¨æ˜¯ <code>List[str]</code> ç­‰ç­‰ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç :</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"></span><br><span class="line">my_list: List[int] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">my_other_list: List[int] = [<span class="number">1</span>, <span class="number">2</span>, <span class="string">"3"</span>]  <span class="comment">#  é”™è¯¯:</span></span><br><span class="line"><span class="comment"># List item 2 has incompatible type "str"; expected "int"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scooby = Dog()</span><br><span class="line">lassie = Dog()</span><br><span class="line">pinky = Animal()</span><br><span class="line"></span><br><span class="line">my_dogs: List[Dog] = [scooby, lassie, pinky]  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># List item 2 has incompatible type "Animal"; expected "Dog"</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æœ‰é“ç†çš„ï¼Œä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Python åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®å¤šç§ç±»å‹çš„é¡¹ç›®ï¼š <code>[1, 2, '3']</code> ä»ç„¶æ˜¯æœ‰æ•ˆçš„åˆ—è¡¨ã€‚ä¸€ä¼šå„¿ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•è¡¨è¾¾åƒ â€œæ•´æ•°æˆ–å­—ç¬¦ä¸²â€ è¿™æ ·çš„ç±»å‹ã€‚ä½†æ˜¯é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å…ƒç»„å’Œå­—å…¸ç±»å‹ã€‚</p><h3 id="å…ƒç»„">4.2 å…ƒç»„</h3><p>åœ¨ Python è¯­è¨€ä¸­ï¼Œå…ƒç»„ä¼ ç»Ÿä¸Šæœ‰ä¸¤ä¸ªç”¨é€”ã€‚é¦–å…ˆï¼Œè¿™æ˜¯ä¸€ä¸ª â€œä¸å¯æ”¹å˜çš„åˆ—è¡¨â€ã€‚ç¬¬äºŒï¼Œå®ƒæ˜¯ â€œè®°å½•â€ æˆ– â€œä¸€è¡Œå€¼â€ï¼Œå…¶ä¸­æ¯ä¸ªä½ç½®ä¸Šçš„å€¼é€šå¸¸éƒ½æœ‰ç‰¹å®šå®šä¹‰çš„ç±»å‹ï¼›æŠŠå®ƒæƒ³è±¡æˆ SQL æ•°æ®åº“ä¸­çš„ä¸€è¡Œã€‚<code>Tuple</code>ï¼ˆå¤§å†™ <code>T</code> ï¼‰ç±»å‹æ”¯æŒè¿™ä¸¤ç§æ–¹æ³•ã€‚</p><p>è¦å°†å…ƒç»„å®šä¹‰ä¸ºè®°å½•ï¼Œä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š<code>Tuple[Type1, Type2, Type3]</code>ï¼ˆç­‰ç­‰ï¼‰ã€‚</p><p>è¦å°†å…ƒç»„å®šä¹‰ä¸ºä¸å¯å˜åˆ—è¡¨ï¼Œä½¿ç”¨å…ƒç»„ä¸çœç•¥å·å¯¹è±¡ï¼ˆç”¨ä¸‰ä¸ªç‚¹æ‹¼å†™ï¼š<code>...</code>ï¼‰ï¼š<code>Tuple[TypeOfAllElements, ...]</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Tuple</span><br><span class="line"></span><br><span class="line">bob: Tuple[str, str, int] = (<span class="string">"Bob"</span>, <span class="string">"Smith"</span>, <span class="number">25</span>)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">frank: Tuple[str, str, int] = (<span class="string">"Frank"</span>, <span class="string">"Brown"</span>, <span class="number">43.4</span>)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Incompatible types in assignment (expression has type "Tuple[str, str, float]",</span></span><br><span class="line"><span class="comment">#   variable has type "Tuple[str, str, int]")</span></span><br><span class="line"></span><br><span class="line">ann: Tuple[str, str, int] = (<span class="string">"Ann"</span>, <span class="string">"X"</span>, <span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Incompatible types in assignment (expression has type "Tuple[str, str, int, int]",</span></span><br><span class="line"><span class="comment">#   variable has type "Tuple[str, str, int]")</span></span><br><span class="line"></span><br><span class="line">scores1: Tuple[int, ...] = (<span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">-1</span>)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">scores2: Tuple[int, ...] = (<span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">-1</span>, <span class="keyword">None</span>, <span class="number">7</span>)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Incompatible types in assignment (expression has type</span></span><br><span class="line"><span class="comment">#   "Tuple[int, int, int, int, None, int]", variable has type "Tuple[int, ...]")</span></span><br></pre></td></tr></table></figure><h3 id="å‘½åå…ƒç»„">4.3 å‘½åå…ƒç»„</h3><p>åœ¨ Python ä¸­ä¹Ÿæœ‰ <code>namedtuple</code>ã€‚å³ä½¿ä¸æ¶‰åŠç±»å‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„å…ƒç»„æ‰©å±•ã€‚å®ƒå¢åŠ äº†å­—æ®µåæŸ¥æ‰¾å’Œä¸€ä¸ªæ¼‚äº®çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line">    Person = namedtuple(<span class="string">'Person'</span>, <span class="string">'first_name last_name age'</span>)</span><br><span class="line"></span><br><span class="line">    bob = Person(first_name=<span class="string">'Bob'</span>, last_name=<span class="string">'Smith'</span>, age=<span class="number">41</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bob.age</span><br><span class="line"><span class="number">41</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bob</span><br><span class="line">Person(first_name=<span class="string">'Bob'</span>, last_name=<span class="string">'Smith'</span>, age=<span class="number">41</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># ä¾ç„¶å¯ä»¥ä½¿ç”¨æ—§çš„è®¿é—®æ–¹å¼ï¼š</span></span><br><span class="line">    bob[<span class="number">0</span>]</span><br><span class="line"><span class="string">'Bob'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bob[<span class="number">1</span>:]</span><br><span class="line">(<span class="string">'Smith'</span>, <span class="number">41</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(bob)</span><br><span class="line">[<span class="string">'Bob'</span>, <span class="string">'Smith'</span>, <span class="number">41</span>]</span><br></pre></td></tr></table></figure><p>åœ¨ Python 3 ä¸­ï¼Œ<code>namedtuple</code> æœ‰ä¸€ä¸ªæ›´å¹´è½»çš„ç±»å‹å…„å¼Ÿï¼š<code>NamedTuple</code>ï¼ˆåŒæ ·ï¼Œç”¨å¤§å†™å­—æ¯ <code>N</code> å’Œ <code>T</code> æ‹¼å†™ï¼‰ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå®ƒå…·æœ‰ä¸ <code>namedtuple</code> å®Œå…¨ç›¸åŒçš„ APIï¼Œä½†æ˜¯å¦å¤–ï¼Œå®ƒæ”¯æŒç±»å‹æ³¨è§£ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> NamedTuple</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(NamedTuple)</span>:</span></span><br><span class="line">    first_name: str</span><br><span class="line">    last_name: str</span><br><span class="line">    age: int</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Person(<span class="string">"Bob"</span>, <span class="string">"Smith"</span>, <span class="number">41</span>)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">Person(<span class="string">"Kate"</span>, <span class="string">"Smith"</span>, <span class="string">"32"</span>)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument 3 to "Person" has incompatible type "str"; expected "int"</span></span><br></pre></td></tr></table></figure><p>ä¸é”™ï¼Œæ˜“è¯»ï¼Œæ–¹ä¾¿ï¼</p><h3 id="å­—å…¸">4.4 å­—å…¸</h3><p>å¦ä¸€ç§é‡è¦çš„ Python ç±»å‹æ˜¯å­—å…¸ã€‚å…¶ç±»å‹çš„å®šä¹‰ç±»ä¼¼äºå…ƒç»„ï¼š<code>Dict[KeyType, ValueType]</code>ã€‚å› æ­¤ï¼Œå°†æ•´æ•°é”®æ˜ å°„åˆ°å­—ç¬¦ä¸²å€¼çš„å­—å…¸æ˜¯ <code>Dict[int, str]</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Dict</span><br><span class="line"></span><br><span class="line">id_to_name: Dict[int, str] = &#123;<span class="number">1</span>: <span class="string">"Bob"</span>, <span class="number">23</span>: <span class="string">"Ann"</span>, <span class="number">7</span>: <span class="string">"Kate"</span>&#125;  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line">id_to_age: Dict[int, int] = &#123;<span class="string">"1"</span>: <span class="number">41</span>, <span class="number">2</span>: <span class="number">22</span>&#125;  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Dict entry 0 has incompatible type "str": "int"; expected "int": "int"</span></span><br><span class="line"></span><br><span class="line">name_to_phone_no: Dict[str, str] = &#123;<span class="string">"Bob"</span>: <span class="string">"55534534"</span>, <span class="string">"Ann"</span>: <span class="number">55599412</span>&#125;  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Dict entry 1 has incompatible type "str": "int"; expected "str": "str"</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å…¶ä»– Python é›†åˆçš„ç±»å‹ï¼š<code>Set</code>ã€<code>FrozenSet</code>ã€<code>DefaultDict</code>ã€<code>Counter</code>ã€<code>Deque</code> å’Œè®¸å¤šå…¶ä»–ç±»å‹ã€‚æœ‰å…³å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚è§<a href="https://docs.python.org/3/library/typing.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬å…³æ³¨å¦ä¸€ç§åˆ›å»ºå¤æ‚ç±»å‹çš„æ–¹æ³•ã€‚</p><h3 id="union">4.5 Union</h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå˜é‡å¯ä»¥æœ‰ <code>str</code> ç±»å‹æˆ– <code>int</code> ç±»å‹ï¼Œè¿™å–å†³äºæƒ…å†µï¼ˆåƒä¸åŒçš„æ•°æ®æºï¼‰ã€‚ä¸ºäº†å®šä¹‰è¿™ç§ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>Union</code>ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒå°†æ˜¯<code>Union[str, int]</code>ã€‚åœ¨æ–¹æ‹¬å·ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦æ”¾ç½®ä»»æ„å¤šçš„ç±»å‹ï¼š<code>Union[Type1, Type2, Type3, Type4]</code>ï¼ˆç­‰ç­‰ï¼‰ã€‚å½¢å¼ä¸Šï¼š</p><blockquote><p><code>Union[t1, t2,Â ...]</code>. <code>t1, ...</code> ä¸­è‡³å°‘ä¸€ä¸ªçš„å­ç±»å‹æ˜¯è¿™ä¸ªç±»å‹çš„å­ç±»å‹ã€‚[<a href="https://www.python.org/dev/peps/pep-0483/#fundamental-building-blocks" target="_blank" rel="noopener">æ¥æº</a>]</p></blockquote><p>ä¸€äº›ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Union</span><br><span class="line"></span><br><span class="line">width1: Union[int, float] = <span class="number">20</span>  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line">width2: Union[int, float] = <span class="number">20.5</span>  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line">width3: Union[int, float] = <span class="string">"44"</span>  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Incompatible types in assignment (expression has type "str",</span></span><br><span class="line"><span class="comment">#   variable has type "Union[int, float]")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lizard</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_eat</span><span class="params">(animal: Union[Dog, Cat])</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    animal.eat()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a_dog: Dog</span><br><span class="line">restricted_eat(a_dog)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">a_cat: Cat</span><br><span class="line">restricted_eat(a_cat)  <span class="comment"># æ²¡æœ‰é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">a_lizard: Lizard</span><br><span class="line">restricted_eat(a_lizard)  <span class="comment"># é”™è¯¯:</span></span><br><span class="line"><span class="comment"># Argument 1 to "restricted_eat" has incompatible type "Lizard";</span></span><br><span class="line"><span class="comment">#   expected "Union[Dog, Cat]"</span></span><br></pre></td></tr></table></figure><h3 id="none-ç±»å‹å’Œå¯é€‰ç±»å‹">4.6 None ç±»å‹å’Œå¯é€‰ç±»å‹</h3><p>ä¸€ç§å¸¸è§çš„ç¼–ç¨‹æ¨¡å¼æ˜¯ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥è¡¨ç¤ºå…·ä½“çš„å€¼ï¼Œæˆ–è€…ç”¨ä¸€ä¸ªç¬¦å·æ¥è¡¨ç¤ºæ²¡æœ‰å€¼ï¼ˆå½“å€¼ä¸¢å¤±ã€æŸåã€è¿˜ä¸å¯ç”¨ã€åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­ä¸å……åˆ†ç­‰ç­‰ï¼‰ã€‚åœ¨ Python ä¸­ï¼Œä¸ºäº†è¡¨ç¤ºæ²¡æœ‰å€¼ï¼Œ<code>None</code> æ˜¯æœ€å¸¸ç”¨çš„å¯¹è±¡ã€‚</p><p>None çš„ç±»å‹æ˜¯ <code>NoneType</code>ï¼Œä½†æ˜¯åœ¨ç±»å‹ç³»ç»Ÿä¸­ï¼Œå®ƒæœ‰ä¸€ä¸ªåˆ«åï¼Œå³â€¦ <code>None</code> æœ¬èº«ã€‚åˆ«åéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä¸æ¶‰åŠå¯¼å…¥ä»»ä½•å†…å®¹ã€‚å› æ­¤ï¼Œè¡¨è¾¾ <code>T</code> ç±»å‹æˆ– <code>None</code> ç±»å‹çš„å€¼çš„æœ€è‡ªç„¶æ–¹å¼æ˜¯ <code>Union[T, None]</code>ã€‚æ‰€ä»¥æ•´å‹æˆ–æ— åº”è¯¥æ˜¯ <code>Union[int, None]</code>ã€‚</p><p>è¿™ç§ç±»å‹æˆ–æ— çš„æ¨¡å¼éå¸¸æ™®éï¼Œä»¥è‡³äºåœ¨ Python çš„ç±»å‹ç³»ç»Ÿä¸­ <code>Union[T, None]</code> æœ‰ä¸€ä¸ªåˆ«åï¼š<code>Optional[T]</code>ã€‚ä¾‹å¦‚ï¼Œè¦æƒ³è¡¨è¾¾ <code>Union[int, None]</code> åº”è¯¥ä½¿ç”¨ <code>Optional[int]</code>ã€‚</p><p>å¿˜è®°å˜é‡çš„â€œå¯é€‰æ€§â€å¸¸å¸¸ä¼šå¯¼è‡´é”™è¯¯ã€‚mypy çœŸçš„å¯ä»¥å¸®åˆ°æˆ‘ä»¬ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å†™åœ¨å‰é¢&quot;&gt;å†™åœ¨å‰é¢&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡ç¿»è¯‘è‡ª &lt;a href=&quot;https://blog.daftcode.pl/first-steps-with-python-type-system-30e4296722af&quot; target=&quot;_blank&quot;
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>å†…å­˜ä¸­çš„æ ˆã€å †å’Œé™æ€åŒºçš„ç”¨æ³•</title>
    <link href="http://weafteam.github.io/posts/978fb366/"/>
    <id>http://weafteam.github.io/posts/978fb366/</id>
    <published>2018-07-29T09:46:14.000Z</published>
    <updated>2018-08-08T06:25:10.793Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬å‘¨çš„ç¬¬ä¸‰ç¯‡åšå®¢ï¼Œè¿™ä¸ªé¢˜ç›®åº”è¯¥ä¹Ÿæ˜¯è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ã€‚</p></blockquote><h2 id="å †åŒº">1 å †åŒº</h2><p>å…ˆäº†è§£ä¸‹Heapçš„ä½œç”¨ï¼Œå †åŒºæ˜¯ä¸“é—¨ç”¨æ¥å­˜å‚¨å¯¹è±¡çš„å®ä¾‹çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶é€šè¿‡newå‡ºæ¥çš„å¯¹è±¡ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™é‡Œé¢ä¹Ÿåªæ˜¯ä¿å­˜äº†å¯¹è±¡å®ä¾‹çš„å±æ€§å€¼ï¼Œå±æ€§çš„ç±»å‹å’Œå¯¹è±¡æœ¬èº«çš„æ ‡è®°ç­‰ä¸€äº›å†…å®¹ï¼Œå…¶ä¸­å€¼å¾—æ³¨æ„çš„æ˜¯å®ƒé‡Œé¢å¹¶ä¸ä¿å­˜å¯¹è±¡çš„æ–¹æ³•ï¼ˆæ–¹æ³•ä¹Ÿå¯ä»¥ç†è§£æˆæŒ‡ä»¤ï¼Œä¿å­˜åœ¨stackä¸­ï¼‰</p><p>æ‰€ä»¥æˆ‘ä»¬åŠ ä»¥æ€»ç»“å’Œå»¶ä¼¸ä¸‹ï¼š</p><p><strong>1</strong> å®ƒå­˜å‚¨çš„éƒ½æ˜¯å¯¹è±¡ï¼Œè€Œä¸”æ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„classçš„ä¿¡æ¯ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯èƒ½å¤Ÿè®©å¯¹è±¡å¾—åˆ°æ“ä½œçš„æŒ‡ä»¤é›†ã€‚</p><p><strong>2</strong> éœ€è¦æ³¨æ„çš„æ˜¯JVMä¸­åªæœ‰ä¸€å—å †åŒºï¼ˆHeapï¼‰ï¼Œè€Œä¸”å®ƒæ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ã€‚å †åŒºä¸­å­˜æ”¾çš„åªæœ‰å¯¹è±¡æœ¬èº«ï¼Œä¸å­˜æ”¾åŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡çš„å¼•ç”¨ã€‚</p><p><strong>3</strong> å…³äºå †åŒºçš„åˆ†é…å’Œé‡Šæ”¾ä¸€èˆ¬æ˜¯ç”±ç¨‹åºå‘˜åšè¿™ä¸ªæ“ä½œã€‚å…¶å®è¿™ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œç¨‹åºå‘˜newä¸€ä¸ªå¯¹è±¡ç›¸å½“äºå¯¹è¿™å—åŒºåŸŸåšäº†åˆ†é…çš„å·¥ä½œï¼Œè€Œå½“ç¨‹åºå‘˜åšdeleteæ“ä½œæ—¶ï¼Œç›¸å½“äºé‡Šæ”¾äº†è¿™éƒ¨åˆ†ç©ºé—´ï¼ŒåŒæ—¶å¦‚æœç¨‹åºå‘˜çš„ä¹ æƒ¯ä¸å¥½ï¼Œä¸å¯¹æ— ç”¨çš„å¯¹è±¡è¿›è¡Œé‡Šæ”¾çš„è¯ï¼Œå½“ç¨‹åºç»“æŸæ—¶ï¼Œä¹Ÿä¼šç”±OSåšè¿™ä¸ªå·¥ä½œã€‚</p><h2 id="æ ˆ">2 æ ˆ</h2><p>ç„¶åæˆ‘ä»¬å†äº†è§£ä¸‹Stackçš„ä½œç”¨ï¼Œå½“æˆ‘ä»¬åœ¨å †åŒºä¸­ä¸ºæˆ‘ä»¬newå‡ºæ¥çš„å¯¹è±¡åˆ†é…å¥½ç©ºé—´ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ ˆä¸­ä¿å­˜ä¸€ä¸ª4å­—èŠ‚çš„Heapçš„åœ°å€ï¼Œç”¨æ¥å®šä½è¯¥å¯¹è±¡å®ä¾‹åœ¨Heapä¸­çš„ä½ç½®ï¼Œä¾¿äºæ‰¾åˆ°è¯¥å¯¹è±¡å®ä¾‹ã€‚</p><p>å…¶å®Stackçš„åŠŸèƒ½ä¸æ­¢äºæ­¤ï¼š</p><p><strong>1</strong> ä¸åŒäºHeapï¼ŒStackçš„ä¸ªæ•°æ˜¯å’Œçº¿ç¨‹æŒ‚é’©çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åŒ…å«ä¸€ä¸ªStackï¼Œè€Œä¸”æ ˆä¸­åªåŒ…å«äº†åŸºæœ¬çš„æ•°æ®ç±»å‹çš„å˜é‡å’Œå¯¹è±¡çš„å¼•ç”¨ã€‚</p><p><strong>2</strong> æ ˆä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥æ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ç§æœ‰çš„ï¼Œå…¶ä»–çš„æ ˆä¸èƒ½è®¿é—®ã€‚</p><p><strong>3</strong> æ ˆå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šåŸºæœ¬æ•°æ®ç±»å‹å˜é‡åŒºã€æ‰§è¡Œç¯å¢ƒçš„ä¸Šä¸‹æ–‡ã€æ“ä½œæŒ‡ä»¤åŒº</p><p><strong>4</strong> æ ˆç›¸å¯¹äºå †åŒºï¼Œå®ƒçš„åˆ†é…å’Œé‡Šæ”¾çš„å·¥ä½œæ˜¯ç³»ç»Ÿè‡ªå·±åšçš„</p><h2 id="é™æ€åŒºæ–¹æ³•åŒº">3 é™æ€åŒº/æ–¹æ³•åŒº</h2><p>ç±»ä¼¼äºå †åŒºï¼Œè€Œä¸”æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹æ‰€å…±äº«çš„ã€‚æ–¹æ³•åŒºä¸­å­˜æ”¾äº†æ•´ä¸ªç¨‹åºä¸­æ‰€æœ‰çš„æ°¸è¿œå”¯ä¸€çš„å˜é‡ï¼Œä¾‹å¦‚ï¼šclassä¿¡æ¯å’Œstaticå˜é‡ç­‰ã€‚</p><p>å®ƒä¹Ÿæ˜¯åˆ†äº†ä¸‰å—ï¼šå…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„å­˜å‚¨æ˜¯æ”¾åœ¨ä¸€å—çš„ï¼Œåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡åœ¨ä¸€å—åŒºåŸŸï¼Œ æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œæœªåˆå§‹åŒ–çš„é™æ€å˜é‡åœ¨ç›¸é‚»çš„å¦ä¸€å—åŒºåŸŸã€‚</p><h2 id="æ³¨æ„">æ³¨æ„</h2><p><strong>æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨æ—¶çš„å•ä½</strong></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå †å’Œæ ˆä¸éƒ½å¯ä»¥å­˜å‚¨æ•°æ®å—ï¼Œä¸ºä»€ä¹ˆè¦å°†è¿™ä¸¤è€…åŒºåˆ†å¼€æ¥ï¼Ÿ</p><p>** 1 ** é¦–å…ˆä»è½¯ä»¶è®¾è®¡çš„è§’åº¦æ¥çœ‹è¿™ä¸ªé—®é¢˜ï¼Œæ ˆå…¶å®ä»£è¡¨äº†å¤„ç†é€»è¾‘ï¼Œè€Œå †ä»£è¡¨äº†æ•°æ®å­˜å‚¨ã€‚è¿™ç§åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³ï¼Œä½¿å¾—æˆ‘ä»¬çš„å¤„ç†é€»è¾‘æ›´ä¸ºæ¸…æ™°ã€‚</p><p>** 2 ** å› ä¸ºå †æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å †ä¸­çš„å†…å®¹ä¹Ÿæ˜¯è¢«å¤šä¸ªæ ˆå…±äº«çš„ã€‚è¿™æ ·åšçš„æ”¶ç›Šæœ‰ä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ–¹é¢è¿™ç§å…±äº«æä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ•°æ®äº¤äº’æ–¹å¼ï¼Œå¦ä¸€æ–¹é¢ï¼Œå †ä¸­çš„å…±äº«å¸¸é‡å’Œç¼“å­˜å¯ä»¥è¢«æ‰€æœ‰çš„æ ˆè®¿é—®åˆ°ã€‚</p><p>ä»¥ä¸Šã€‚æ„Ÿè°¢é©»è¶³~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;æœ¬å‘¨çš„ç¬¬ä¸‰ç¯‡åšå®¢ï¼Œè¿™ä¸ªé¢˜ç›®åº”è¯¥ä¹Ÿæ˜¯è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;å †åŒº&quot;&gt;1
        
      
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="é¢è¯•" scheme="http://weafteam.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>StackOverflowä¸Šç®€å•æ•°å­—è¯†åˆ«æ¡ˆä¾‹å­¦ä¹ </title>
    <link href="http://weafteam.github.io/posts/8b09dcdd/"/>
    <id>http://weafteam.github.io/posts/8b09dcdd/</id>
    <published>2018-07-24T04:59:38.000Z</published>
    <updated>2018-08-07T08:56:41.652Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æ­£å¦‚é¢˜ç›®é‚£æ ·ï¼Œè¿™æ¬¡çš„å­¦ä¹ æ˜¯StackOverflowä¸Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå®ƒçš„åœ°å€ä¸º<a href="https://stackoverflow.com/questions/9413216/simple-digit-recognition-ocr-in-opencv-python" class="uri" target="_blank" rel="noopener">https://stackoverflow.com/questions/9413216/simple-digit-recognition-ocr-in-opencv-python</a>ï¼Œä½†æ˜¯æºåœ°å€ä¸Šçš„ä»£ç ç•¥å¾®æœ‰ç‚¹æ—§ï¼Œå¾ˆå¤šå‡½æ•°åœ¨OpenCV3ä¸­æœ‰äº†äº›è®¸çš„æ”¹åŠ¨ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯ä¼šè´´ä¸Šæˆ‘è‡ªå·±æ”¹æ­£è¿‡åçš„ä»£ç ï¼Œç„¶åé™„ä¸Šæˆ‘å¯¹ä½œè€…çš„æ€è·¯çš„ç†è§£æ•´ç†ä»¥åŠå¯¹æ‰€æœ‰ä»£ç çš„ç†è§£ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿å’Œæˆ‘è¿›è¡Œæ²Ÿé€šäº¤æµï¼Œé‚®ç®±åœ°å€ï¼šcliugeek@us-forever.com</p></blockquote><h1 id="æ€è·¯">æ€è·¯ï¼š</h1><p>æ•´ä½“çš„æ€è·¯ï¼šæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªè®­ç»ƒï¼ˆå…¶å®ä¸¥æ ¼æ„ä¹‰ä¸Šè¯´ä¸ä¸Šæ˜¯è®­ç»ƒï¼Œå…¶å®æˆ‘ä»¬æœ€ç»ˆè¦åšçš„æ˜¯æ¯ä¸ªæ•°å­—çš„ç‰¹å¾æå–å¹¶ä¸”å°†ä»–ä»¬ä¸å®é™…çš„æ•°å­—å­—ç¬¦ä¸€ä¸€å¯¹åº”èµ·æ¥ï¼Œå§‘ä¸”å°±ç§°è¿™ä¸ªè¿‡ç¨‹ä¸ºâ€œè®­ç»ƒâ€å§ï¼‰çš„å›¾åƒï¼Œç„¶åæˆ‘ä»¬æå–å…¶ä¸­æ‰€æœ‰çš„æ•°å­—çš„ç‰¹å¾ï¼Œç„¶åæ ¹æ®ä¸€ä¸€å¯¹åº”çš„çš„å…³ç³»ï¼Œå°†ç‰¹å¾å’Œå¯¹åº”çš„å­—ç¬¦å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿æˆ‘ä»¬åç»­åšå…¶ä»–å›¾åƒä¸­çš„æ•°å­—è¯†åˆ«ä½¿ç”¨ã€‚</p><p>æ‰€ä»¥å…ˆè´´ä¸€ä¸‹è®­ç»ƒç”¨åˆ°çš„æ•°æ®å›¾ï¼š</p><p><img src="https://i.loli.net/2018/07/24/5b56be2a72945.png" alt="digit.png"></p><p>å…¶å®è¿™æ ·çš„è®­ç»ƒæ•°æ®å­˜åœ¨ç€ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ‰€æœ‰çš„å­—æ¯éƒ½æ˜¯ç›¸åŒçš„å­—ä½“å’Œå¤§å°ï¼Œæ‰€ä»¥æ•´ä½“çš„é²æ£’æ€§å¾ˆå—å½±å“ã€‚æ‰€ä»¥è¿™æ˜¯æœ¬ç¨‹åºéœ€è¦åšç»§ç»­ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è®²å…·ä½“çš„è®­ç»ƒè¿‡ç¨‹ï¼š</p><pre><code>1 åŠ è½½å›¾åƒ2 æ£€æµ‹æ•°å­—ï¼ˆé€šè¿‡è½®å»“æŸ¥æ‰¾æ‰¾ï¼Œå¹¶ä¸”é€šè¿‡å¯¹æ£€æµ‹åˆ°çš„å­—æ¯çš„é¢ç§¯å’Œé«˜åº¦åšç›¸åº”çš„çº¦æŸï¼Œæ¥é¿å…é”™è¯¯çš„æ£€æµ‹ï¼‰3 å¯¹æ£€æµ‹åˆ°çš„å­—æ¯ç»˜åˆ¶è¾¹æ¡†4 æ¯ç»˜åˆ¶å‡ºä¸€ä¸ªè¾¹æ¡†ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨é”®ç›˜ä¸Šé”®å…¥ç›¸åº”çš„æ•°å­—é”®ï¼Œè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œå¦åˆ™ä¼šå¯¼è‡´æˆ‘ä»¬è®­ç»ƒè¿‡ç¨‹æ— æ•ˆï¼Œå¯¼è‡´åé¢ä¸€ç³»åˆ—çš„å·¥ä½œæ— æ³•è¿›è¡Œ5 å½“æˆ‘ä»¬æŒ‰ä¸‹ç›¸åº”çš„æ•°å­—é”®ä¹‹åï¼Œè¾¹æ¡†é‡Œé¢çš„ä¸œè¥¿ä¾¿ä¼šè¿›è¡Œé‡æ–°çš„resizeï¼Œå˜æˆ10x10çš„å¤§å°ï¼Œç„¶åå°†å…¶å­˜å…¥åˆ°ä¸€ä¸ª100ç»´çš„æ•°ç»„ä¸­ï¼ˆå…¶å®å°±æ˜¯å°†è¿™äº›åƒç´ å€¼éƒ½å­˜äº†è¿›å»ä½œä¸ºæˆ‘ä»¬çš„ç‰¹å¾æå–ï¼‰ï¼Œç›¸åº”çš„ä¹Ÿä¼šå°†æˆ‘ä»¬é”®å…¥çš„æ•°å­—å­˜åˆ°å¦ä¸€ä¸ªdataæ–‡ä»¶å½“ä¸­å»6 è®­ç»ƒè¿‡ç¨‹å®Œæˆä¹‹åï¼Œç³»ç»Ÿç”Ÿæˆä¸¤ä¸ªdataæ–‡ä»¶ã€‚</code></pre><p>åœ¨æ‰‹åŠ¨æ•°å­—åˆ†ç±»ç»“æŸæ—¶ï¼Œè®­ç»ƒæ•°æ®ï¼ˆå…¶å®å°±æ˜¯ä¸Šé¢ç»™å¤§å®¶çš„é‚£å¼ å›¾åƒï¼‰ä¸­æ‰€æœ‰çš„æ•°å­—ï¼Œéƒ½å·²ç»ç”±æˆ‘ä»¬æ‰‹å·¥æ ‡è®°ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://i.loli.net/2018/07/24/5b56bf1d8d153.png" alt="norm.png"></p><p>ä¸‹é¢å°±æ˜¯é’ˆå¯¹ä¸Šè¿°è¿‡ç¨‹çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">im = cv2.imread(<span class="string">'digit.png'</span>)</span><br><span class="line">im3 = im.copy()</span><br><span class="line"></span><br><span class="line">gray = cv2.cvtColor(im, cv2.COLOR_BGR2GRAY)</span><br><span class="line">blur = cv2.GaussianBlur(gray, (<span class="number">5</span>, <span class="number">5</span>), <span class="number">0</span>)</span><br><span class="line">thresh = cv2.adaptiveThreshold(blur, <span class="number">255</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#################      Now finding Contours         ###################</span></span><br><span class="line"></span><br><span class="line">image, contours, hierarchy = cv2.findContours(thresh, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)</span><br><span class="line"></span><br><span class="line">samples = np.empty((<span class="number">0</span>, <span class="number">100</span>))</span><br><span class="line">responses = []</span><br><span class="line">keys = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">48</span>, <span class="number">58</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> cnt <span class="keyword">in</span> contours:</span><br><span class="line">    <span class="keyword">if</span> cv2.contourArea(cnt) &gt; <span class="number">50</span>:</span><br><span class="line">        [x, y, w, h] = cv2.boundingRect(cnt)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> h &gt; <span class="number">28</span>:</span><br><span class="line">            cv2.rectangle(im, (x, y), (x + w, y + h), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line">            roi = thresh[y:y + h, x:x + w]</span><br><span class="line">            roismall = cv2.resize(roi, (<span class="number">10</span>, <span class="number">10</span>))</span><br><span class="line">            cv2.imshow(<span class="string">'norm'</span>, im)</span><br><span class="line">            key = cv2.waitKey(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> key == <span class="number">27</span>:  <span class="comment"># (escape to quit)</span></span><br><span class="line">                sys.exit()</span><br><span class="line">            <span class="keyword">elif</span> key <span class="keyword">in</span> keys:</span><br><span class="line">                responses.append(int(chr(key)))</span><br><span class="line">                sample = roismall.reshape((<span class="number">1</span>, <span class="number">100</span>))</span><br><span class="line">                samples = np.append(samples, sample, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">responses = np.array(responses, np.float32)</span><br><span class="line">responses = responses.reshape((responses.size, <span class="number">1</span>))</span><br><span class="line">print(<span class="string">"training complete"</span>)</span><br><span class="line"></span><br><span class="line">np.savetxt(<span class="string">'generalsamples.data'</span>, samples)</span><br><span class="line">np.savetxt(<span class="string">'generalresponses.data'</span>, responses)</span><br></pre></td></tr></table></figure><p>ä»£ç å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæ‰€ä»¥ç®€å•çš„è¯´ä¸€ä¸‹ï¼Œé¦–å…ˆå¯¹å›¾åƒè¿›è¡Œç°åº¦åŒ–ï¼Œç„¶åè¿›è¡Œé«˜æ–¯å»å™ªï¼Œå†ç„¶ååšäºŒå€¼åŒ–ã€‚æ¥ä¸‹æ¥è¿›è¡Œè½®å»“æ£€æµ‹ï¼Œç„¶åå¯¹æ¯ä¸ªæ£€æµ‹åˆ°çš„è½®å»“åœ¨é¢ç§¯å’Œé«˜åº¦ä¸Šè¿›è¡Œæ§åˆ¶ï¼Œå¦‚æœç¬¦åˆè®¾å®šçš„æ ‡å‡†å°±è¿›è¡Œç”»æ¡†ã€resizeå’Œdisplayï¼ŒåŒæ—¶å°†è¾“å…¥çš„keyè¿›è¡Œç›¸åº”çš„å­˜å‚¨ï¼Œåˆ°æœ€åè¿›è¡Œsaveï¼Œå°†ä»–ä»¬åˆ†åˆ«å­˜åˆ°generalsamples.dataå’Œgeneralresponses.dataä¸­ã€‚</p><p>æ¥ä¸‹æ¥è¿›è¡Œæµ‹è¯•éƒ¨åˆ†ï¼ŒåŒæ ·å…ˆç»™å‡ºæµ‹è¯•æ‰€ç”¨çš„å›¾åƒï¼š</p><p><img src="https://i.loli.net/2018/07/24/5b56ca87860f9.png" alt="dig.png"></p><p>å†ç„¶åå°±æ˜¯æµ‹è¯•éƒ¨åˆ†çš„æ­¥éª¤ï¼šé¦–å…ˆå°†åˆšæ‰æˆ‘ä»¬ç”Ÿæˆçš„dataæ–‡ä»¶loadè¿›æ¥ï¼Œä¹Ÿå°±æ˜¯å°†åˆšæ‰çš„æ¨¡å‹åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åæˆ‘ä»¬ç”¨KNNï¼ˆKé‚»è¿‘å€¼æ³•ï¼Œé€‰å–ä¸å½“å‰çš„æµ‹è¯•å›¾åƒä¸­æœ€ç›¸è¿‘çš„ä½œä¸ºæˆ‘ä»¬é¢„æµ‹å‡ºæ¥çš„å€¼ï¼‰åšé¢„æµ‹ï¼Œç„¶åé’ˆå¯¹äºæ£€æµ‹å‡ºæ¥çš„æ¯ä¸ªè½®å»“éƒ½è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œé¢„æµ‹å‡ºæ¥çš„å›¾åƒï¼Œæˆ‘ä»¬é€šè¿‡puttextæ–¹æ³•æ”¾åˆ°å°†è¦ç”Ÿæˆçš„å›¾åƒoutä¸Šï¼Œæœ€åå°†åŸå›¾imå’Œç”Ÿæˆå›¾outæ˜¾ç¤ºå‡ºæ¥ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment">#######   training part    ###############</span></span><br><span class="line">samples = np.loadtxt(<span class="string">'generalsamples.data'</span>, np.float32)</span><br><span class="line">responses = np.loadtxt(<span class="string">'generalresponses.data'</span>, np.float32)</span><br><span class="line">responses = responses.reshape((responses.size, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">model = cv2.ml.KNearest_create()</span><br><span class="line">model.train(samples, cv2.ml.ROW_SAMPLE, responses)</span><br><span class="line"><span class="comment"># model.train(samples,responses)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# testing part  #########################</span></span><br><span class="line"></span><br><span class="line">im = cv2.imread(<span class="string">'dig.png'</span>)</span><br><span class="line">out = np.zeros(im.shape, np.uint8)</span><br><span class="line">gray = cv2.cvtColor(im, cv2.COLOR_BGR2GRAY)</span><br><span class="line">thresh = cv2.adaptiveThreshold(gray, <span class="number">255</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">image, contours, hierarchy = cv2.findContours(thresh, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> cnt <span class="keyword">in</span> contours:</span><br><span class="line">    <span class="keyword">if</span> cv2.contourArea(cnt) &gt; <span class="number">50</span>:</span><br><span class="line">        [x, y, w, h] = cv2.boundingRect(cnt)</span><br><span class="line">        <span class="keyword">if</span> h &gt; <span class="number">28</span>:</span><br><span class="line">            cv2.rectangle(im, (x, y), (x + w, y + h), (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            roi = thresh[y:y + h, x:x + w]</span><br><span class="line">            roismall = cv2.resize(roi, (<span class="number">10</span>, <span class="number">10</span>))</span><br><span class="line">            roismall = roismall.reshape((<span class="number">1</span>, <span class="number">100</span>))</span><br><span class="line">            roismall = np.float32(roismall)</span><br><span class="line">            retval, results, neigh_resp, dists = model.findNearest(roismall, k=<span class="number">1</span>)</span><br><span class="line">            string = str(int((results[<span class="number">0</span>][<span class="number">0</span>])))</span><br><span class="line">            cv2.putText(out, string, (x, y + h), <span class="number">0</span>, <span class="number">1</span>, (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">'im'</span>, im)</span><br><span class="line">cv2.imshow(<span class="string">'out'</span>, out)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†çš„ä»£ç å…¶å®æŒ‰ç…§åˆšæ‰çš„æµç¨‹ç†è§£å°±å¯ä»¥ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ã€‚</p><p>æœ€åç»™å¤§å®¶çœ‹ä¸‹æ•ˆæœï¼š</p><p><img src="https://i.loli.net/2018/07/24/5b56dd88da6ad.png" alt="im.png"></p><p><img src="https://i.loli.net/2018/07/24/5b56dd88c14c9.png" alt="out.png"></p><p>æˆ‘ä»”ç»†å¯¹æ¯”äº†ä¸€éï¼Œå‡†ç¡®ç‡å¯ä»¥è¾¾åˆ°100%ã€‚å¯¹äºè¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¿™æ ·çš„ç»“æœå¯ä»¥ç§°å¾—ä¸Šå®Œç¾å§ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æœ¬æ¬¡å­¦ä¹ çš„æ‰€æœ‰å†…å®¹ã€‚æ„Ÿè°¢é©»è¶³~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;æ­£å¦‚é¢˜ç›®é‚£æ ·ï¼Œè¿™æ¬¡çš„å­¦ä¹ æ˜¯StackOverflowä¸Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå®ƒçš„åœ°å€ä¸º&lt;a
        
      
    
    </summary>
    
      <category term="OCR" scheme="http://weafteam.github.io/categories/OCR/"/>
    
    
      <category term="OpenCV-Python" scheme="http://weafteam.github.io/tags/OpenCV-Python/"/>
    
  </entry>
  
  <entry>
    <title>Threadå’ŒRunnableçš„åŒºåˆ«</title>
    <link href="http://weafteam.github.io/posts/42fb2e58/"/>
    <id>http://weafteam.github.io/posts/42fb2e58/</id>
    <published>2018-07-23T07:32:42.000Z</published>
    <updated>2018-08-07T08:56:41.651Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸¤å‘¨çš„å°æš‘å‡ä¹Ÿç®—æ˜¯è¿‡å®Œäº†ï¼Œæ¥ä¸‹æ¥å¾—å¥½å¥½åšä¸œè¥¿äº†ï¼Œåšå®¢ä»ä»Šå¤©å¼€å§‹ä¹Ÿè¦è·Ÿä¸Šè¿›åº¦äº†ã€‚</p></blockquote><h2 id="ä¸¤ç§åˆ›å»ºçš„æ–¹å¼">1. ä¸¤ç§åˆ›å»ºçš„æ–¹å¼</h2><pre><code>1 ç»§æ‰¿Threadç±»ï¼Œå¹¶ä¸”é‡å†™å…¶ä¸­çš„run()æ–¹æ³•2 å®ç°Runnableæ¥å£ï¼Œé‡å†™å…¶ä¸­çš„run()æ–¹æ³•</code></pre><p>ä½†æ˜¯åœ¨å®ç°åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å¤šç”¨å®ç°Runnableæ¥å£çš„æ–¹å¼ï¼Œè¿™æ˜¯å› ä¸ºJavaçš„å•ç»§æ‰¿å¤šå®ç°çš„æœºåˆ¶ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥é¿å…ç”±äºè¿™ä¸ªæœºåˆ¶ä»£ç çš„å±€é™æ€§ã€‚å…¶å®æˆ‘ä»¬ç”¨Runnableçš„åŸå› ä¸æ­¢äºæ­¤ï¼Œæœ€ä¸»è¦çš„ä¸€ç‚¹æ˜¯Runnableæ˜¯å¯ä»¥è¿›è¡Œæ•°æ®å…±äº«çš„ï¼Œä½†å› æ­¤å®ƒä¹Ÿæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ç°åœ¨å¯¹è¿™ä¸¤ç‚¹è¿›è¡Œé€ä¸€è§£é‡Šï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„å”®ç¥¨çš„ä¾‹å­ï¼Œå¯¹æ•°æ®å…±äº«è¿™ä¸€ç‚¹è¿›è¡Œè§£é‡Šã€‚</p><h2 id="ç¤ºä¾‹ä»£ç ">2. ç¤ºä¾‹ä»£ç </h2><p><strong>ç¤ºä¾‹ä»£ç 1</strong></p><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ªMyThreadï¼Œè®©å®ƒç»§æ‰¿Threadï¼Œç„¶åæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªcountï¼Œè¿™ä¸ªcountå‚æ•°å¯ä»¥æƒ³è±¡æˆæˆ‘ä»¬è¦å…±äº«çš„èµ„æºã€‚ç„¶åä»£ç å°±å¾ˆç®€å•äº†ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        MyThread thread1 = <span class="keyword">new</span> MyThread(<span class="string">"ä¸€å·çª—å£"</span>);</span><br><span class="line">        MyThread thread2 = <span class="keyword">new</span> MyThread(<span class="string">"äºŒå·çª—å£"</span>);</span><br><span class="line">        MyThread thread3 = <span class="keyword">new</span> MyThread(<span class="string">"ä¸‰å·çª—å£"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread3.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"å½“å‰å”®ç¥¨çª—å£ä¸ºï¼š"</span> + <span class="keyword">this</span>.name + <span class="string">"       å”®ç¥¨ï¼š"</span> + count--);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœ1ï¼š</strong></p><p><img src="https://i.loli.net/2018/07/24/5b569215608d6.png" alt="thread.png"></p><p>æˆ‘ä»¬å…ˆå°†ä¸¤ä¸ªä»£ç éƒ½ç»™å¤§å®¶ï¼Œç¨åå†åšåˆ†æã€‚</p><p><strong>ç¤ºä¾‹ä»£ç 2</strong></p><p>åŒæ ·ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè®©å®ƒå®ç°Runnableæ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testRunnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        MyThread mt = <span class="keyword">new</span> MyThread();</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(mt, <span class="string">"ä¸€å·çª—å£"</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(mt, <span class="string">"äºŒå·çª—å£"</span>);</span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(mt, <span class="string">"äºŒå·çª—å£"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"å½“å‰çº¿ç¨‹ä¸ºï¼š"</span> + Thread.currentThread().getName() + <span class="string">"  å”®ç¥¨ä¸ºï¼š"</span> + count--);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœ2ï¼š</strong></p><p><img src="https://i.loli.net/2018/07/24/5b56921561f91.png" alt="runnable.png"></p><h2 id="åˆ†æ">3. åˆ†æ</h2><p>é€šè¿‡ä»£ç è¿è¡Œç»“æœæˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„æˆªç„¶ä¸åŒï¼Œç›¸ä¿¡å¤§å®¶ç°åœ¨ä¹Ÿèƒ½ç†è§£äº†ï¼Œä¸ºä»€ä¹ˆè¯´Runnableæ˜¯å¯ä»¥è¿›è¡Œèµ„æºå…±äº«çš„ï¼Œä¸è¿‡è¿˜æ˜¯åœ¨å¤šè¯´ä¸€ç‚¹å§ã€‚</p><p>æˆ‘ä»¬ç»§æ‰¿äº†Threadçš„MyTheadç±»ï¼Œé€šè¿‡ä¸‰æ¬¡å®ä¾‹åŒ–ï¼Œåˆ†åˆ«çš„å°†è¿™ä¸‰ä¸ªå†startèµ·æ¥ï¼Œå°±ç›¸å½“äºç»™äº†ä¸‰ä¸ªå”®ç¥¨çª—å£æ¯äººä¸€ä¸ªå–5å¼ ç¥¨çš„ä»»åŠ¡ï¼Œä»–ä»¬å› ä¸ºæ˜¯ä¸‰ä¸ªå®ä¾‹ï¼Œå„è‡ªåšå„è‡ªçš„äº‹æƒ…ï¼Œå„è‡ªå®Œæˆè¿™ä¸ªå–ç¥¨çš„ä»»åŠ¡ã€‚</p><p>è€Œæˆ‘ä»¬å®ç°äº†Runnableçš„MyThreadç±»ï¼Œç›¸å½“äºå…ˆåˆ›å»ºäº†ä¸€ä¸ªä»»åŠ¡ï¼ˆå…¶å®å°±æ˜¯æˆ‘ä»¬new MyThreadè¿‡ç¨‹ï¼‰,ç„¶åé€šè¿‡å®ä¾‹åŒ–ä¸‰ä¸ªThreadï¼Œåˆ›å»ºäº†ä¸‰ä¸ªçº¿ç¨‹å…±åŒå»å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆè¯´Runnableæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„å‘¢ï¼Œç†ç”±å…¶å®å¾ˆç®€å•ï¼šå¦‚æœæˆ‘ä»¬åœ¨System.outâ€¦ä¹‹å‰åŠ ä¸Šä¸€ä¸ªçº¿ç¨‹ä¼‘çœ æ“ä½œçš„è¯ï¼Œå°±ä¼šå¾ˆæœ‰å¯èƒ½å¯¼è‡´æˆ‘ä»¬çš„countæœ€åèƒ½è¾“å‡º-1ï¼Œä¹Ÿå°±æ˜¯è¯´å­˜åœ¨ä¸€å¼ ç¥¨è¢«å”®å–ä¸¤æ¬¡çš„çŠ¶å†µã€‚å¦‚æœæƒ³å¯¹äºè¿™ä¸€ç‚¹è¿›è¡Œæµ‹è¯•çš„è¯ï¼Œå¤§å®¶è¦æ³¨æ„ä¸€ç‚¹ï¼Œç¥¨æ•°è¦è®¾ç½®çš„å¤§ä¸€äº›ï¼Œä¼‘çœ æ—¶é—´å†™æˆ1æ¯«ç§’å°±è¡Œï¼Œè¿™æ ·çš„æµ‹è¯•æ•ˆæœæ¯”è¾ƒæ˜æ˜¾ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•æ‰èƒ½ä¿è¯æˆ‘ä»¬ç”¨Runnableæ—¶çš„çº¿ç¨‹å®‰å…¨æ€§å‘¢ï¼Ÿæ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªåœ°æ–¹åŠ ä¸ŠåŒæ­¥æ“ä½œï¼ˆäº’æ–¥é”ï¼‰ï¼Œç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå”®ç¥¨çš„æ“ä½œã€‚è€Œæˆ‘ä»¬ä¹‹å‰çš„ç»§æ‰¿Threadçš„æ–¹æ³•å¹¶ä¸éœ€è¦è¿™ä¹ˆåšï¼ŒåŸå› å°±æ˜¯æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œè‡ªå·±çš„Threadå¯¹è±¡ä¸­çš„ä»£ç ï¼Œä¸å­˜åœ¨å¤šä¸ªçº¿ç¨‹å…±åŒæ‰§è¡ŒåŒä¸€ä¸ªæ–¹æ³•çš„æƒ…å†µã€‚</p><p>ä»¥ä¸Šæ˜¯æœ¬æ¬¡çš„æ‰€æœ‰å†…å®¹ï¼Œæ„Ÿè°¢é©»è¶³~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;ä¸¤å‘¨çš„å°æš‘å‡ä¹Ÿç®—æ˜¯è¿‡å®Œäº†ï¼Œæ¥ä¸‹æ¥å¾—å¥½å¥½åšä¸œè¥¿äº†ï¼Œåšå®¢ä»ä»Šå¤©å¼€å§‹ä¹Ÿè¦è·Ÿä¸Šè¿›åº¦äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ä¸¤ç§åˆ›å»ºçš„æ–¹å¼&quot;&gt;1. ä¸¤ç§åˆ›å»ºçš„æ–¹å¼&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;1
        
      
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="é¢è¯•" scheme="http://weafteam.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Javaä¸­Listå’ŒArrayListçš„åŒºåˆ«</title>
    <link href="http://weafteam.github.io/posts/e85880/"/>
    <id>http://weafteam.github.io/posts/e85880/</id>
    <published>2018-06-23T11:10:07.000Z</published>
    <updated>2018-08-07T08:56:41.620Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å¼€å§‹è¡¥åšå®¢äº†<sub>ä»5æœˆåˆåˆ°ç°åœ¨åº”è¯¥æœ‰8ç¯‡åšå®¢éœ€è¦è¡¥ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œå¼€å§‹å†™å§</sub></p></blockquote><h1 id="åŒºåˆ«">åŒºåˆ«</h1><p>è¿™ä¿©ä¸ªçš„åŒºåˆ«å¾ˆæ˜æ˜¾ï¼ŒListæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè€ŒArrayListæ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒç»§æ‰¿AbstractListæŠ½è±¡ç±»å¹¶ä¸”å®ç°äº†Listæ¥å£ã€‚</p><p>æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªListçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥çš„newä¸€ä¸ªListï¼ˆæ˜¾ç„¶æ˜¯åºŸè¯ï¼Œæ¥å£è‚¯å®šæ˜¯ä¸èƒ½é€šè¿‡newå®ä¾‹åŒ–çš„ï¼‰ï¼Œè€Œåªèƒ½æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªç»§æ‰¿å¹¶å®ç°å®ƒçš„ç±»çš„å®ä¾‹å¹¶å°†è¿™ä¸ªå®ä¾‹åŒ–çš„å€¼èµ‹å€¼ç»™æˆ‘ä»¬çš„listå®ç°Listçš„å®ä¾‹åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®å¯ä»¥ç”¨ä¸€è¡Œä»£ç æ¥è¡¨ç¤ºï¼ˆå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæŒ‡å‘Listå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™å°±æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­å¤šæ€çš„ä¼˜åŠ¿å§ï¼ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¾‹å¦‚æˆ‘ä»¬è¦æ‹¿æ¥æ¯”è¾ƒçš„ArrayList</span></span><br><span class="line">List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆ–è€…ç»§æ‰¿Listçš„å…¶ä»–ç±»</span></span><br><span class="line">List b = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥é€šè¿‡ä»¥ä¸Šçš„ä»£ç ï¼Œå¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ï¼ŒListçš„å®ä¾‹åŒ–çš„å…·ä½“æ“ä½œï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥çš„å†™ä¸€è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List list;</span><br></pre></td></tr></table></figure><p>åªä¸è¿‡è¿™æ ·åšå‡ºæ¥çš„listæ˜¯ä¸€ä¸ªç©ºçš„åˆ—è¡¨ï¼Œä½ å¯ä»¥åœ¨åç»­çš„æ“ä½œä¸ºå®ƒåšå¡«å……ã€‚</p><h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹ï¼š</h2><p>æˆ‘ä»¬æ¥ç€åˆšæ‰çš„ List list = new ArrayList(); æ¥è¯´ã€‚é¦–å…ˆlistæ˜¯ä¸€ä¸ªListç±»å‹çš„å¯¹è±¡ï¼Œè™½ç„¶æˆ‘ä»¬æ˜¯newçš„ä¸€ä¸ªArrayListçš„ï¼Œä½†æ˜¯æœ‰äº›ArrayListå…·æœ‰çš„è€ŒListç±»ä¸­æ²¡æœ‰çš„å±æ€§å’Œæ–¹æ³•ï¼Œlistéƒ½ä¸èƒ½å†ç”¨äº†ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•æ‰èƒ½ä¿è¯ArrayListä¸­ç‹¬æœ‰çš„æ–¹æ³•å’Œå±æ€§éƒ½èƒ½è¢«ä½¿ç”¨åˆ°å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œæ¯•ç«ŸArrayListæ˜¯ä¸€ä¸ªç±»ï¼Œç›´æ¥å®ä¾‹åŒ–æ˜¯æ²¡é—®é¢˜çš„ï¼Œè¿™æ ·å®ƒæ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•å°±éƒ½å¯ä»¥ä½¿ç”¨äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArrayList A = <span class="keyword">new</span> ArrayList();</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†æ¥ç€è®²List list = new ArrayList();å¦‚æœListå’ŒArrayListä¸­å­˜åœ¨ç›¸åŒçš„å±æ€§ï¼ˆä¾‹å¦‚ï¼šint iï¼‰å’Œç›¸åŒçš„æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼šf()ï¼‰ï¼Œè¿™æ—¶å€™list.içš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯Listä¸­çš„å±æ€§ï¼Œè€Œa.f()è°ƒç”¨çš„æ˜¯ArrayListä¸­çš„æ–¹æ³•f()ã€‚</p><h1 id="å…¶ä»–">å…¶ä»–</h1><p>æœ‰å…³äºListå’ŒArrayListæœ¬æ–‡ç”¨åˆ°çš„æ˜¯æ²¡æœ‰æŒ‡å®šæ³›åŒ–ç±»å‹çš„å†™æ³•ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œæœ‰å…³å®è£…ç®±å’Œæ‹†ç®±çš„å†…å®¹ï¼Œæˆ‘è¿™æä¾›ä¸€ä¸ªç½‘å€ã€‚</p><p><a href="http://www.cnblogs.com/a164266729/p/4561651.html" class="uri" target="_blank" rel="noopener">http://www.cnblogs.com/a164266729/p/4561651.html</a></p><h1 id="æœ¬æ–‡å‚è€ƒ">æœ¬æ–‡å‚è€ƒ</h1><p><a href="http://www.cnblogs.com/aisiteru/articles/1151874.html" class="uri" target="_blank" rel="noopener">http://www.cnblogs.com/aisiteru/articles/1151874.html</a></p><p><a href="https://blog.csdn.net/erlian1992/article/details/51298276" class="uri" target="_blank" rel="noopener">https://blog.csdn.net/erlian1992/article/details/51298276</a></p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;å¼€å§‹è¡¥åšå®¢äº†&lt;sub&gt;ä»5æœˆåˆåˆ°ç°åœ¨åº”è¯¥æœ‰8ç¯‡åšå®¢éœ€è¦è¡¥ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œå¼€å§‹å†™å§&lt;/sub&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1
        
      
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="é¢è¯•" scheme="http://weafteam.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootä½¿ç”¨Swagger2</title>
    <link href="http://weafteam.github.io/posts/d023fbc0/"/>
    <id>http://weafteam.github.io/posts/d023fbc0/</id>
    <published>2018-06-10T18:04:44.000Z</published>
    <updated>2018-08-22T14:45:52.634Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h1><p>Swagger2æ˜¯ä¸€æ¬¾å¯ä»¥ç”ŸæˆRESTfulæ¥å£æ–‡æ¡£çš„å·¥å…·ã€‚è€Œä¸”ä¹¦å†™èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œå¼€å‘äººå‘˜åªéœ€ç»´æŠ¤ä»£ç ï¼Œä¸ç”¨é¢å¤–ä¹¦å†™æ–‡æ¡£ã€‚ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ï¼Œè€Œä¸”å‘ˆç°çš„æ–¹å¼å¾ˆæ£’ã€‚è¿˜æ”¯æŒåœ¨çº¿æµ‹è¯•ã€‚</p><h1 id="äºŒspringbooté›†æˆ">äºŒã€SpringBooté›†æˆ</h1><p>æˆ‘è¿™é‡Œæ—¶ä½¿ç”¨çš„æœ€æ–°ç‰ˆæœ¬2.9.2 æˆ‘è¿™é‡Œé¡¹ç›®æ˜¯ä½¿ç”¨Mavenæ„å»ºçš„ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- start swagger --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- end swagger --&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Contact;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: å¢åŠ swaggerçš„rest APIæŸ¥çœ‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 13:20 2018/8/20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2Config</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ˜¯å¦å¼€å¯swaggerï¼Œæ­£å¼ç¯å¢ƒä¸€èˆ¬æ˜¯éœ€è¦å…³é—­çš„ï¼Œå¯æ ¹æ®springbootçš„å¤šç¯å¢ƒé…ç½®è¿›è¡Œè®¾ç½®</span></span><br><span class="line">    <span class="meta">@Value</span>(value = <span class="string">"$&#123;swagger.enabled&#125;"</span>)</span><br><span class="line">    Boolean swaggerEnabled;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo())</span><br><span class="line">            <span class="comment">// æ˜¯å¦å¼€å¯</span></span><br><span class="line">            .enable(swaggerEnabled).select()</span><br><span class="line">            <span class="comment">// æ‰«æçš„è·¯å¾„åŒ…</span></span><br><span class="line">            .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.xxx.controller"</span>))</span><br><span class="line">            <span class="comment">// æŒ‡å®šè·¯å¾„å¤„ç†PathSelectors.any()ä»£è¡¨æ‰€æœ‰çš„è·¯å¾„</span></span><br><span class="line">            .paths(PathSelectors.any()).build().pathMapping(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">            .title(<span class="string">"åç«¯æœåŠ¡æ¥å£è¯¦æƒ…"</span>)</span><br><span class="line">            .description(<span class="string">"yaxuSong"</span>)</span><br><span class="line">            <span class="comment">// ä½œè€…ä¿¡æ¯</span></span><br><span class="line">            .contact(<span class="keyword">new</span> Contact(<span class="string">"yaxuSong"</span>, <span class="string">"https://weaf.top"</span>, <span class="string">"earth@weaf.top"</span>))</span><br><span class="line">            .version(<span class="string">"1.0.0"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>éƒ¨åˆ†é¡¹ç›®é…ç½®ä¸åŒå¯èƒ½éœ€è¦é…ç½®è®¿é—®é™æ€æ–‡ä»¶çš„è·¯å¾„ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: å…è®¸è®¿é—®Swagger uié™æ€é¡µé¢</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 13:20 2018/8/20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/static/**"</span>).addResourceLocations(<span class="string">"classpath:/static/"</span>);</span><br><span class="line"></span><br><span class="line">        registry.addResourceHandler(<span class="string">"swagger-ui.html"</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">"classpath:/META-INF/resources/"</span>);</span><br><span class="line"></span><br><span class="line">        registry.addResourceHandler(<span class="string">"/webjars/**"</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">"classpath:/META-INF/resources/webjars/"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//è·¨åŸŸæ”¯æŒ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è®¾ç½®æ–‡æ¡£å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxx.annotation.EnableRequestLog;</span><br><span class="line"><span class="keyword">import</span> com.xxx.common.CommonConverter;</span><br><span class="line"><span class="keyword">import</span> com.xxx.common.Constants;</span><br><span class="line"><span class="keyword">import</span> com.xxxx.common.Restful;</span><br><span class="line"><span class="keyword">import</span> com.xxx.common.Restful.Result;</span><br><span class="line"> <span class="comment">//...........</span></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiImplicitParam;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiImplicitParams;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 17:17 2018/5/25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"ç”¨æˆ·API"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  type = 0 ä¸ºç²‰ä¸åˆ—è¡¨ 1 - ä¸ºå…³æ³¨è€…åˆ—è¡¨ é»˜è®¤0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EnableRequestLog</span>(<span class="string">"æŸ¥çœ‹ç²‰ä¸ï¼Œå…³æ³¨åˆ—è¡¨"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"list"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"æŸ¥çœ‹ç²‰ä¸å’Œå…³æ³¨åˆ—è¡¨"</span>,httpMethod = <span class="string">"POST"</span>,</span><br><span class="line">            notes = <span class="string">"type= 0,æ˜¯æŸ¥çœ‹ç²‰ä¸åˆ—è¡¨ï¼Œtype =1 æ˜¯æŸ¥çœ‹å…³æ³¨åˆ—è¡¨ï¼Œé»˜è®¤å€¼æ˜¯0"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">list</span><span class="params">(@RequestParam(value = <span class="string">"type"</span>,defaultValue = <span class="string">"0"</span>,required = <span class="keyword">false</span>)</span> <span class="keyword">int</span> type</span></span><br><span class="line"><span class="function">            ,<span class="keyword">int</span> limit,<span class="keyword">int</span> offset,HttpServletRequest request)</span>&#123;</span><br><span class="line">        AppUser appUser = getUser(request);</span><br><span class="line">        <span class="keyword">if</span> (appUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Restful.failure(RestfulResultEnum.USER_UNLOGIN);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Restful.success(userService.getFollowList(appUser.getId(),limit,offset));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List&lt;UserListVO&gt; list = userService.getFocusList(appUser.getId(), limit, offset);</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isEmpty(list)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Restful.success(list);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">                    list.get(i).setRank(Long.parseLong(rankService.getRank(list.get(i).getId())+<span class="string">""</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Restful.success(list);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnableRequestLog</span>(<span class="string">"åŒæ­¥å¾®ä¿¡ä¿¡æ¯"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"åŒæ­¥å¾®ä¿¡ä¿¡æ¯"</span>)</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"sync/wechat"</span>)</span><br><span class="line">    <span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">            <span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>, value = <span class="string">"å¾®ä¿¡å¯¹è±¡"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"WeChatDTO"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">syncWechat</span><span class="params">(WeChatDTO weChatDTO,HttpServletRequest request)</span></span>&#123;</span><br><span class="line">        AppUser appUser = getUser(request);</span><br><span class="line">        <span class="keyword">if</span> (appUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Restful.failure(RestfulResultEnum.USER_UNLOGIN);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"ã€ç”¨æˆ·ID = &#123;&#125;,ç±»å = UserController,æ–¹æ³•å = syncWechat, å‚æ•°ä¸º = &#123;&#125;ã€‘"</span>,appUser.getId(),weChatDTO.toString());</span><br><span class="line">        UserInfoVO vo = userService.syncWeChat(weChatDTO,appUser.getId());</span><br><span class="line">        <span class="keyword">if</span> (vo==<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Restful.failure(RestfulResultEnum.USER_SYNC_WECHAT_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Restful.success(vo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ä½“å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.entry.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 11:32 2018/5/29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeChatDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"æ‰‹æœºå·ç "</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"phone"</span>,example=<span class="string">"15300000000"</span>)</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"åç§°"</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"name"</span>,example=<span class="string">"æ„¿å¾—ä¸€äººå¿ƒ"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"æ€§åˆ«"</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"gender"</span>,example=<span class="string">"ç”·"</span>)</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"unionID"</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"unionId"</span>,example=<span class="string">"o17g2621sE-9Ak-Nva2QbHzeF4"</span>)</span><br><span class="line">    <span class="keyword">private</span> String unionId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"å¤´åƒè·¯å¾„"</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"avatar"</span>,example=<span class="string">"https://xxxx.png"</span>)</span><br><span class="line">    <span class="keyword">private</span> String avatar;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"openID"</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"openId"</span>,example=<span class="string">"othzc0VW0T8yyEk52C3lh2H_lTE0"</span>)</span><br><span class="line">    <span class="keyword">private</span> String openId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"çœä»½"</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"province"</span>,example=<span class="string">"åŒ—äº¬"</span>)</span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"å›½å®¶"</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"country"</span>,example=<span class="string">"ä¸­å›½"</span>)</span><br><span class="line">    <span class="keyword">private</span> String country;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"éªŒè¯ç "</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"code"</span>,example=<span class="string">"2341"</span>)</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"é‚€è¯·ç "</span>,dataType=<span class="string">"String"</span>,name=<span class="string">"inviteCode"</span>,example=<span class="string">"LTEtNTQzMDMtRkUwQzQzNjE3NkE0NEM1MzAzNTBGRjk1NkU2QzQ4MkQ="</span>)</span><br><span class="line">    <span class="keyword">private</span> String inviteCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä¸‰ç»“æœå±•ç¤º">ä¸‰ã€ç»“æœå±•ç¤º</h1><p>è®¿é—®è·¯å¾„ <a href="http://127.0.0.1:10086/swagger-ui.html#/" class="uri" target="_blank" rel="noopener">http://127.0.0.1:10086/swagger-ui.html#/</a> <img src="https://weaf.oss-cn-beijing.aliyuncs.com/swagger-1.png"></p><p>è®¾ç½®è¯·æ±‚æ–¹æ³•çš„â€œæŸ¥çœ‹ç²‰ä¸å’Œå…³æ³¨åˆ—è¡¨â€ï¼ˆ<strong>è®¾ç½®äº†è¯·æ±‚æ–¹æ³•</strong>ï¼‰ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/swagger-3.png"></p><p>æœªè®¾ç½®è¯·æ±‚æ–¹æ³•çš„api <img src="https://weaf.oss-cn-beijing.aliyuncs.com/swagger-4.png"></p><p>ä¸¤ç§è®¾ç½®æ–¹æ³•çš„è¯¦ç»†å†…å®¹ï¼ˆé€šè¿‡ç‚¹å‡»try itå¯ä»¥è¿›è¡Œæµ‹è¯•ï¼‰è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<strong>Postman</strong>è¿›è¡Œæµ‹è¯• <img src="https://weaf.oss-cn-beijing.aliyuncs.com/swagger-5.png"> <img src="https://weaf.oss-cn-beijing.aliyuncs.com/swagger-6.png"></p><h1 id="å››ç›¸å…³æ³¨è§£">å››ã€ç›¸å…³æ³¨è§£</h1><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/swagger-7.png"></p><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://swagger.io/" class="uri" target="_blank" rel="noopener">https://swagger.io/</a></p>]]></content>
    
    <summary type="html">
    
      SpringBootä½¿ç”¨Swagger2
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆä¸ƒï¼‰</title>
    <link href="http://weafteam.github.io/posts/a6235d78/"/>
    <id>http://weafteam.github.io/posts/a6235d78/</id>
    <published>2018-06-09T09:35:25.000Z</published>
    <updated>2018-08-07T08:56:41.657Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šæ–‡ã€‚</p><h2 id="ä½¿ç”¨-aiohttp-ä½œä¸º-web-æœåŠ¡å™¨">ä½¿ç”¨ aiohttp ä½œä¸º Web æœåŠ¡å™¨</h2><p>ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°ï¼Œaiohttp ä¸ä»…ä»…æ˜¯ä¸€ä¸ª http å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ã€‚åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ aiohttp å®ç°ä¸€ä¸ªç®€å•çš„ Web ç¨‹åºï¼ŒåŒæ—¶ä¸ flask æ¯”è¾ƒä¸€ä¸‹æ€§èƒ½ä¸Šçš„å·®åˆ«ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h3><p>é¦–å…ˆå®‰è£…æˆ‘ä»¬éœ€è¦çš„ç¬¬ä¸‰æ–¹åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install aiohttp</span><br><span class="line">pip install flask</span><br></pre></td></tr></table></figure><p>ç„¶åå‡†å¤‡å¥½è¦ä½¿ç”¨çš„ Web å®¹å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å¯¹ aiohttp å’Œ flask éƒ½å¾ˆå‹å¥½çš„ gunicornã€‚ä¸ºäº†è®© flask å¾—åˆ°å¼‚æ­¥æ”¯æŒï¼Œ éœ€è¦åŒæ—¶å®‰è£… geventï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install gunicorn[gevent]</span><br></pre></td></tr></table></figure><p>å®‰è£… wrkï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install wrk</span><br></pre></td></tr></table></figure><h3 id="hello-world">Hello, world</h3><p>æˆ‘ä»¬çš„èµ·æ‰‹å¼å½“ç„¶æ˜¯ Hello, worldã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨ flask å’Œ aiohttp å®ç°ä¸€ä¸ªè¿”å› Hello, world çš„ Web æœåŠ¡ã€‚</p><h4 id="flask">flask</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask_app.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(<span class="string">"flask_app"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello, world!"</span></span><br></pre></td></tr></table></figure><p>éå¸¸ç®€å•ï¼</p><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ€§èƒ½æµ‹è¯•çš„ç»“æœã€‚é¦–å…ˆç”¨ gunicorn å¯åŠ¨åº”ç”¨ï¼Œå°† socket ç»‘å®šåˆ° localhost:5000ï¼Œæ‰“å¼€è®¿é—®æ—¥å¿—ï¼Œä½¿ç”¨ 4 ä¸ª workerï¼Œå¹¶ä½¿ç”¨ gevent ä½œä¸º worker çš„ç±»å‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn -b localhost:5000 --access-logfile - -w 4 -k gevent flask_app:app</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥è¿›è¡Œæ€§èƒ½æµ‹è¯•äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ 8 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ 200 ä¸ªè¯·æ±‚ï¼Œå…±æµ‹è¯• 10 ç§’ï¼Œå¹¶å¼€å¯è¯¦ç»†æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrk -t8 -c200 -d10s --latency http://localhost:5000</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 10s test @ http://localhost:5000</span><br><span class="line">  8 threads and 200 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     9.80ms   94.91ms   1.67s    99.06%</span><br><span class="line">    Req/Sec     1.07k   555.92     2.14k    63.76%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.55ms</span><br><span class="line">     75%    1.82ms</span><br><span class="line">     90%    2.27ms</span><br><span class="line">     99%   20.89ms</span><br><span class="line">  23325 requests in 10.01s, 3.96MB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 8</span><br><span class="line">Requests/sec:   2330.74</span><br><span class="line">Transfer/sec:    405.20KB</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªå…³æ³¨å‡ ä¸ªé‡è¦çš„ä¿¡æ¯ï¼š</p><ul><li>Latencyï¼Œå¯ä»¥ç†è§£ä¸ºå“åº”æ—¶é—´ï¼Œwrk æä¾›äº†å¹³å‡å€¼ï¼Œæ ‡å‡†å·®ï¼Œæœ€å¤§å€¼ï¼Œä»¥åŠæ­£è´Ÿä¸€ä¸ªæ ‡å‡†å·®çš„å æ¯”ï¼›</li><li>Req/Secï¼Œæ¯ä¸ªçº¿ç¨‹æ¯ç§’é’Ÿçš„å®Œæˆçš„è¯·æ±‚æ•°ï¼ŒåŒæ ·æœ‰ä»¥ä¸Šæ•°æ®ç±»å‹ï¼›</li><li>Latency Distributionï¼Œå“åº”æ—¶é—´çš„åˆ†å¸ƒæƒ…å†µï¼Œ50%ã€75%ã€90%ã€99%çš„è¯·æ±‚åœ¨å¤šé•¿æ—¶é—´å†…ç»“æŸï¼›</li><li>Socket errorsï¼Œåœ¨æµ‹è¯•ä¸­æœ‰å¤šå°‘é”™è¯¯å‘ç”Ÿï¼›</li><li>Requests/secï¼Œæ¯ç§’é’Ÿå®Œæˆå¤šå°‘è¯·æ±‚ï¼›</li><li>Transfer/secï¼Œæ¯ç§’é’Ÿäº§ç”Ÿçš„æ•°æ®é‡ï¼›</li></ul><p>çŸ¥é“äº†ä¸Šè¿°ä¿¡æ¯çš„å«ä¹‰ï¼Œå°±å¯ä»¥å¯¹åº”ç”¨ç¨‹åºçš„æ€§èƒ½æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£äº†ã€‚</p><h4 id="aiohttp">aiohttp</h4><p>åŒæ ·æˆ‘ä»¬ç”¨ aiohttp å®ç°ä¸€ä¸ª Hello world åº”ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># aio_app.py</span></span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">routes = web.RouteTableDef()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@routes.get("/")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> web.Response(text=<span class="string">"Hello, world!"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = web.Application()</span><br><span class="line">app.add_routes(routes)</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ gunicorn å¯åŠ¨å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn -b localhost:5000 --access-logfile - -w 4 -k aiohttp.GunicornWebWorker aio_app:app</span><br></pre></td></tr></table></figure><p>å¤§éƒ¨åˆ†å‚æ•°éƒ½ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ä½¿ç”¨äº† aiohttp çš„ wroker ç±»å‹ã€‚</p><p>ä¹Ÿç”¨åŒæ ·çš„å‚æ•°å¯åŠ¨ wrkï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Running 10s test @ http://localhost:5000</span><br><span class="line">  8 threads and 200 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    32.58ms   15.57ms 120.43ms   68.40%</span><br><span class="line">    Req/Sec   773.91    167.40     1.16k    67.25%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   36.83ms</span><br><span class="line">     75%   42.40ms</span><br><span class="line">     90%   46.73ms</span><br><span class="line">     99%   66.48ms</span><br><span class="line">  61709 requests in 10.03s, 9.65MB read</span><br><span class="line">Requests/sec:   6150.18</span><br><span class="line">Transfer/sec:      0.96MB</span><br></pre></td></tr></table></figure><h4 id="å¯¹æ¯”">å¯¹æ¯”</h4><p>æˆ‘ä»¬æŠŠæ€§èƒ½æµ‹è¯•çš„ç»“æœæ”¾åœ¨ä¸€å—å¯¹æ¯”ä¸€ä¸‹ï¼Œå·¦è¾¹æ˜¯ flaskï¼Œå³è¾¹æ˜¯ aiohttpï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 10s test @ http://localhost:5000                    Running 10s test @ http://localhost:5000</span><br><span class="line">  8 threads and 200 connections                               8 threads and 200 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev           Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     9.80ms   94.91ms   1.67s    99.06%              Latency    32.58ms   15.57ms 120.43ms   68.40%</span><br><span class="line">    Req/Sec     1.07k   555.92     2.14k    63.76%              Req/Sec   773.91    167.40     1.16k    67.25%</span><br><span class="line">  Latency Distribution                                        Latency Distribution</span><br><span class="line">     50%    1.55ms                                               50%   36.83ms</span><br><span class="line">     75%    1.82ms                                               75%   42.40ms</span><br><span class="line">     90%    2.27ms                                               90%   46.73ms</span><br><span class="line">     99%   20.89ms                                               99%   66.48ms</span><br><span class="line">  23325 requests in 10.01s, 3.96MB read                       61709 requests in 10.03s, 9.65MB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 8</span><br><span class="line">Requests/sec:   2330.74                                     Requests/sec:   6150.18</span><br><span class="line">Transfer/sec:    405.20KB                                   Transfer/sec:      0.96MB</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º flask åœ¨å•ä¸ªè¯·æ±‚çš„è€—æ—¶ä¸Šæ˜æ˜¾èƒœäº aiohttpï¼Œä½†æ˜¯æ ‡å‡†å·®å·¨å¤§ï¼Œåœ¨å‹åŠ›åœºæ™¯ä¸‹æœ€å¤§è€—æ—¶é•¿è¾¾ 1.67sï¼Œç”šè‡³å‡ºç°äº† 8 ä¸ªè¶…æ—¶çš„è¿æ¥ï¼Œè€Œ aiohttp çš„è¯·æ±‚è€—æ—¶æ¯”è¾ƒç¨³å®šï¼›æœ€é‡è¦çš„åŒºåˆ«åœ¨äºï¼Œaiohttp æ¯ç§’å®Œæˆäº†å¤šè¾¾ 6150.18 ä¸ªè¯·æ±‚ï¼Œæ˜¯ flask çš„è¿‘ 3 å€ï¼flask ä¸­ 1% è¶…è¿‡ 20.89ms çš„è¯·æ±‚ä¸¥é‡å½±å“äº†æ•´ä½“çš„æ€§èƒ½ã€‚</p><h3 id="ç‚¹å‡»è®¡æ•°">ç‚¹å‡»è®¡æ•°</h3><p>é€šè¿‡ä¸Šé¢çš„ Hello, world ç¨‹åºæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä½¿ç”¨ aiohttp å¯ä»¥æ˜¾è‘—æå‡ Web ç¨‹åºçš„æ€§èƒ½ã€‚å½“ç„¶ Web ç¨‹åºå¹¶ä¸æ­¢äºæ­¤ï¼Œå®ƒè¿˜éœ€è¦æ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰ç»„ä»¶ååŒå·¥ä½œã€‚asyncio çš„å‘¨è¾¹è™½ç„¶åœ¨è¿…é€Ÿå‘å±•ï¼Œä¸è¿‡ä»ä¸å®Œå–„ã€‚å¥½æ¶ˆæ¯æ˜¯ RabbitMQ çš„ Python é©±åŠ¨åœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¹ŸåŠ å…¥äº† asyncio æ”¯æŒï¼ŒåŸºæœ¬ç»„ä»¶å¤§éƒ¨åˆ†éƒ½æ”¯æŒäº† asyncioã€‚åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬å¢åŠ  redis æ”¯æŒï¼Œåˆ¶ä½œä¸€ä¸ªç®€å•çš„ç‚¹å‡»è®¡æ•°å™¨ã€‚</p><h4 id="å‡†å¤‡å·¥ä½œ-1">å‡†å¤‡å·¥ä½œ</h4><p>åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… redisï¼Œå¹¶å¯åŠ¨å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install redis</span><br><span class="line">brew services start redis</span><br></pre></td></tr></table></figure><p>å‡†å¤‡å¥½æ”¯æŒ asyncio çš„ redis é©±åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install aioredis</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰-app">å®šä¹‰ App</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">app = web.Application()</span><br></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–-redis">åˆå§‹åŒ– redis</h4><p>åœ¨ aiohttp ä¸­ä½¿ç”¨ redis éœ€è¦åœ¨åº”ç”¨å¯åŠ¨å‰åˆå§‹åŒ–è¿æ¥æ± ï¼Œå¹¶åœ¨åº”ç”¨é€€å‡ºåå…³é—­è¿æ¥æ± ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aioredis</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">setup_redis</span><span class="params">(app)</span>:</span></span><br><span class="line">    redis_url = <span class="string">"redis://@localhost/0"</span></span><br><span class="line">    app[<span class="string">"redis"</span>] = <span class="keyword">await</span> aioredis.create_redis_pool(redis_url)</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    app[<span class="string">"redis"</span>].close()</span><br><span class="line">    <span class="keyword">await</span> app[<span class="string">"redis"</span>].wait_closed()</span><br></pre></td></tr></table></figure><p>å¹¶å°†åˆå§‹åŒ–å‡½æ•°æ³¨å†Œåˆ° app çš„æ¸…ç†ä¸Šä¸‹æ–‡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.cleanup_ctx.append(setup_redis)</span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™è·¯ç”±">ç¼–å†™è·¯ç”±</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">routes = web.RouteTableDef()</span><br><span class="line"></span><br><span class="line"><span class="meta">@routes.get("/hit")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(request)</span>:</span></span><br><span class="line">    redis = request.app[<span class="string">"redis"</span>]</span><br><span class="line">    <span class="keyword">return</span> web.json_response(&#123;<span class="string">"hit"</span>: <span class="keyword">await</span> redis.incr(<span class="string">"hit"</span>)&#125;)</span><br><span class="line"></span><br><span class="line">app.add_routes(routes)</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œä¸€ä¸ªç‚¹å‡»è®¡æ•°å™¨å°±å®Œæˆäº†ã€‚æˆ‘ä»¬è¯•ç€è¯·æ±‚ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> http localhost:5000/hit</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 10</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Date: Sat, 09 Jun 2018 08:37:33 GMT</span><br><span class="line">Server: Python/3.6 aiohttp/3.3.1</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "hit": 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæ¯æ¬¡è¯·æ±‚ hit çš„å€¼éƒ½ä¼š +1ã€‚</p><h4 id="å¯¹æ¯”-1">å¯¹æ¯”</h4><p>åŒæ ·ï¼Œæˆ‘ä¹Ÿç¼–å†™äº†ä¸€ä¸ª flask ç‰ˆæœ¬çš„ç‚¹å‡»è®¡æ•°å™¨ï¼Œåœ¨è¿™é‡Œåªå±•ç¤ºä¸€ä¸‹å¯¹æ¯”ç»“æœï¼š</p><p>aiohttp ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Running 10s test @ http://localhost:5000/hit</span><br><span class="line">  8 threads and 200 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    35.83ms    7.18ms  90.80ms   70.37%</span><br><span class="line">    Req/Sec   699.60     86.70     0.92k    68.62%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   35.01ms</span><br><span class="line">     75%   40.39ms</span><br><span class="line">     90%   44.61ms</span><br><span class="line">     99%   58.03ms</span><br><span class="line">  55816 requests in 10.04s, 9.10MB read</span><br><span class="line">Requests/sec:   5559.97</span><br><span class="line">Transfer/sec:      0.91MB</span><br></pre></td></tr></table></figure><p>flask ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Running 10s test @ http://localhost:5000/hit</span><br><span class="line">  8 threads and 200 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   123.99ms  171.06ms   1.89s    95.32%</span><br><span class="line">    Req/Sec   262.03    163.41   670.00     69.57%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  106.59ms</span><br><span class="line">     75%  156.67ms</span><br><span class="line">     90%  179.60ms</span><br><span class="line">     99%    1.05s</span><br><span class="line">  20484 requests in 10.07s, 3.33MB read</span><br><span class="line">  Socket errors: connect 0, read 19, write 0, timeout 0</span><br><span class="line">Requests/sec:   2033.33</span><br><span class="line">Transfer/sec:    338.51KB</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºå¢åŠ äº† redis çš„å†…å­˜ io æ“ä½œå aiohttp çš„é¢†å…ˆä¼˜åŠ¿å·¨å¤§ï¼Œè€Œ Web åº”ç”¨å¤§å¤šæ˜¯é‡ io çš„ï¼Œå¯ä»¥é¢„è§åˆ° asyncio åœ¨æœªæ¥ä¼šå æ®æ›´é‡è¦çš„åœ°ä½ã€‚</p><h2 id="ç»“è¯­">ç»“è¯­</h2><p>å†™å®Œè¿™ç¯‡ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°±åˆ°æ­¤ä¸ºæ­¢äº†ã€‚æ•´ä½“ä¸Š asyncio ä»åœ¨ç»§ç»­å‘å±•ï¼Œæœ‰è¶Šæ¥è¶Šå¤šçš„åŸºç¡€ç»„ä»¶å·²ç»æœ‰äº†å¯ç”¨çš„ asyncio ç‰ˆæœ¬ï¼Œä¸€äº›å¤§å‚å·²ç»æœ‰è½¬å‘ asyncio çš„è¶‹åŠ¿äº†ã€‚asyncio æ˜¯æœªæ¥ï¼Œæ˜¯ä¸€å®šè¦äº†è§£çš„~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¹¦æ¥ä¸Šæ–‡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä½¿ç”¨-aiohttp-ä½œä¸º-web-æœåŠ¡å™¨&quot;&gt;ä½¿ç”¨ aiohttp ä½œä¸º Web æœåŠ¡å™¨&lt;/h2&gt;
&lt;p&gt;ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°ï¼Œaiohttp ä¸ä»…ä»…æ˜¯ä¸€ä¸ª http å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ã€‚åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redisson çš„ä»‹ç»ä¸ä½¿ç”¨</title>
    <link href="http://weafteam.github.io/posts/eae731fe/"/>
    <id>http://weafteam.github.io/posts/eae731fe/</id>
    <published>2018-06-04T18:04:44.000Z</published>
    <updated>2018-08-08T11:54:45.491Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h1><p><img src="https://camo.githubusercontent.com/5664d7af9b355209fac47098d3b51f64c4e265c7/68747470733a2f2f7265646973736f6e2e6f72672f6c6f676f2e706e67" alt="Redisson-1"> Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ã€‚å…¶ä¸­åŒ…æ‹¬(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redissonæä¾›äº†ä½¿ç”¨Redisçš„æœ€ç®€å•å’Œæœ€ä¾¿æ·çš„æ–¹æ³•ã€‚Redissonçš„å®—æ—¨æ˜¯ä¿ƒè¿›ä½¿ç”¨è€…å¯¹Redisçš„å…³æ³¨åˆ†ç¦»ï¼ˆSeparation of Concernï¼‰ï¼Œä»è€Œè®©ä½¿ç”¨è€…èƒ½å¤Ÿå°†ç²¾åŠ›æ›´é›†ä¸­åœ°æ”¾åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚</p><h1 id="äºŒåˆ†å¸ƒå¼é”">äºŒã€åˆ†å¸ƒå¼é”</h1><p>ä»Šå¤©ä¹Ÿåªæ˜¯å°±Redissonåˆ†å¸ƒå¼é”è¿™ä¸€éƒ¨åˆ†è¿›è¡Œè®²è§£ã€‚ åœ¨å¾ˆå¤šæ—¶å€™ï¼Œä¸€ä¸ªæœåŠ¡å™¨å·²ç»ä¸æ»¡è¶³æˆ‘ä»¬å¯¹æœåŠ¡æ€§èƒ½çš„è¦æ±‚äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•è¿›å’Œå¾ˆå¤šç›¸å…³çš„æŠ€æœ¯ï¼Œå¼•å…¥äº†åˆ†å¸ƒå¼æœåŠ¡çš„æ–¹å¼ï¼Œä½†æ˜¯è¿™æ ·æ—¢å¸¦æ¥äº†æ–¹ä¾¿ï¼Œå…¶å®ä¹Ÿå¸¦æ¥äº†é—®é¢˜ï¼Œå¤šå°æœåŠ¡å™¨ä¸€èµ·è¿è¡Œç›¸åŒçš„ä»£ç ï¼Œä¸€æ—¦ä¸¤å°æœåŠ¡è¿è¡Œäº†ç›¸åŒçš„ä»£ç ï¼Œé‚£å°±è¦ä¿è¯æœåŠ¡â€œ<strong>å¹‚ç­‰æ€§</strong>â€çš„è®¾è®¡ã€‚è€Œä¸”è¦è€ƒè™‘æœåŠ¡å¹¶å‘å¸¦æ¥çš„å¯èƒ½æ€§é—®é¢˜ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å¼•å…¥åˆ†å¸ƒå¼é”çš„æ¦‚å¿µï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä½¿ç”¨é”ï¼Œå°†æˆ‘ä»¬è¦ç´§è¡Œæ“ä½œçš„å¯¹è±¡æˆ–è€…æ•°æ®åŠ é”ã€‚æ“ä½œåé‡Šæ”¾é”ã€‚ä½¿å¾—æ­¤æ—¶æ“ä½œè¿™ä¸ªå¯¹è±¡çš„æœåŠ¡å™¨åªæœ‰ä¸€ä¸ªï¼ˆæˆ–è€…è¯´åªèƒ½å¯¹å½“å‰å¯¹è±¡è¿›è¡Œå½“å‰æ‹¿åˆ°é”çš„æ“ä½œï¼Œæ‹¿ä¸åˆ°é”çš„éƒ½ä¸å…è®¸æ“ä½œï¼‰ã€‚è¿™æ ·ä¿è¯æ•°æ®çš„æ¯æ¬¡æ“ä½œå‰åéƒ½ä¸ä¼šæœ‰é—®é¢˜ã€‚å½“ç„¶åŒä¸€ä¸ªæœåŠ¡å™¨ä¹Ÿåªèƒ½å¯¹å½“å‰å¯¹è±¡è¿›è¡Œä¸€ä¸ªæ“ä½œã€‚</p><p>å…¶å®ä¸ºäº†ä¿è¯è¿™ä¸€ç‚¹ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šé”ï¼Œç›¸ä¿¡å¤§å®¶ä¹ŸçŸ¥é“ï¼Œä¹è§‚é”ï¼Œæ‚²è§‚é”ã€è¡¨é”ã€è¡Œé”ç­‰ã€‚</p><h1 id="ä¸‰å…·ä½“é…ç½®">ä¸‰ã€å…·ä½“é…ç½®</h1><p>æ­¤æ–‡æ˜¯ä»¥SpringBootä¸ºåŸºç¡€æ¥å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 11:30 2018/6/30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedissionServiceConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.host&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String redisHost;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String redisPort;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String redisPassword;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.database&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer redisDatabase;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"redisson"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redissionConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        config.useSingleServer().setAddress(redisHost + <span class="string">":"</span> + redisPort).setPassword(redisPassword)</span><br><span class="line">            .setDatabase(redisDatabase);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å››å®ç°ä¸åº”ç”¨">å››ã€å®ç°ä¸åº”ç”¨</h1><p>å®ç°éƒ¨åˆ† <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xxx.ExceptionCodeEnum;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 11:30 2018/6/30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span>(<span class="string">"redissonLockService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedissonLockServiceImpl</span> <span class="keyword">implements</span> <span class="title">LockService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"redisson"</span>)</span><br><span class="line">    <span class="keyword">private</span> RedissonClient redisson;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tryLock(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String key, <span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tryLock(key, timeout, LockService.DEFAULT_EXPIRE_TIME, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String key, <span class="keyword">long</span> waitTime, <span class="keyword">long</span> leaseTime, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RLock lock = redisson.getLock(key);</span><br><span class="line">            <span class="keyword">boolean</span> res = lock.tryLock(waitTime, leaseTime, unit);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            RedissonLockServiceImpl.log.error(<span class="string">"è·å–redissoné”å¼‚å¸¸, key is &#123;&#125;, timeout is &#123;&#125;,leaseTime is &#123;&#125;, unit is &#123;&#125;."</span>, key,</span><br><span class="line">                    waitTime, leaseTime, unit, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(ExceptionCodeEnum.CACHE_EXCEPTION_LOCK_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        RLock lock = redisson.getLock(key);</span><br><span class="line">        lock.lock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RLock lock = redisson.getLock(key);</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            RedissonLockServiceImpl.log.error(<span class="string">"redissonè§£é”å¤±è´¥,key=&#123;&#125;"</span>, key, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åº”ç”¨ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String lockKey = <span class="string">"xxxx"</span>;</span><br><span class="line">   <span class="keyword">if</span>(!lockService.tryLock(lockKey))&#123;</span><br><span class="line">       log.warn(<span class="string">"current request can't not be locked!"</span>);</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> LockException(code,msg);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">lockService.unLock(lockKey);</span><br></pre></td></tr></table></figure></p><h1 id="äº”ç›¸å…³é—®é¢˜">äº”ã€ç›¸å…³é—®é¢˜</h1><p>å¤§å®¶éƒ½çŸ¥é“ï¼Œå¦‚æœè´Ÿè´£å‚¨å­˜è¿™ä¸ªåˆ†å¸ƒå¼é”çš„RedisèŠ‚ç‚¹å®•æœºä»¥åï¼Œè€Œä¸”è¿™ä¸ªé”æ­£å¥½å¤„äºé”ä½çš„çŠ¶æ€æ—¶ï¼Œè¿™ä¸ªé”ä¼šå‡ºç°é”æ­»çš„çŠ¶æ€ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼ŒRedissonå†…éƒ¨æä¾›äº†ä¸€ä¸ªç›‘æ§é”çš„çœ‹é—¨ç‹—ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨Redissonå®ä¾‹è¢«å…³é—­å‰ï¼Œä¸æ–­çš„å»¶é•¿é”çš„æœ‰æ•ˆæœŸã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œçœ‹é—¨ç‹—çš„æ£€æŸ¥é”çš„è¶…æ—¶æ—¶é—´æ˜¯30ç§’é’Ÿï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹Config.lockWatchdogTimeoutæ¥å¦è¡ŒæŒ‡å®šã€‚</p><p>å‚è€ƒæ–‡ç«  ï¼š<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener">https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95</a></p>]]></content>
    
    <summary type="html">
    
      Redisson çš„ä»‹ç»ä¸ä½¿ç”¨
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>chapter-11-AIR</title>
    <link href="http://weafteam.github.io/posts/45d29694/"/>
    <id>http://weafteam.github.io/posts/45d29694/</id>
    <published>2018-05-29T03:27:34.000Z</published>
    <updated>2018-08-12T11:03:56.319Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-å®ç°siamese-network">TensorFlow å®ç°Siamese Network</h1><ol type="1"><li>è¿™æ¬¡æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªåŸºäºlenetçš„Siamese Networkï¼Œå¤§å®¶å¦‚æœæƒ³äº†è§£Siamese Networkï¼Œç»™å¤§å®¶æ¨èAndrew NGçš„è¯¾<a href="https://www.coursera.org/learn/convolutional-neural-networks/lecture/bjhmj/siamese-network" target="_blank" rel="noopener">deeplearning.ai</a>ä½œä¸ºäº†è§£</li><li>æ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥ä¸Šcodeï¼šå¤§å®¶ä¹Ÿå¯ä»¥ç›´æ¥ç§»æ­¥åˆ°æˆ‘çš„github ä»“åº“é‡Œé¢æ‰¾ä»£ç <a href="https://github.com/Milittle/MLModel/blob/milittle/siameasenetwork/mnist/train.py" target="_blank" rel="noopener">ä»£ç </a></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ä»£ç ç›®å½•ç»„ç»‡ç»“æ„ï¼š</span><br><span class="line">siameasenetwork</span><br><span class="line">__init__.py</span><br><span class="line">mnistï¼š</span><br><span class="line">__init__.py</span><br><span class="line">train.py</span><br><span class="line">lenet.py</span><br><span class="line">util.py</span><br><span class="line">DataShuffler.py</span><br></pre></td></tr></table></figure><p>train.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2018/5/25 22:16</span></span><br><span class="line"><span class="comment"># @Author  : milittle</span></span><br><span class="line"><span class="comment"># @Site    : www.weaf.top</span></span><br><span class="line"><span class="comment"># @File    : train.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> siameasenetwork.mnist <span class="keyword">import</span> util <span class="comment"># è¿™æ˜¯å¤–éƒ¨ä¾èµ–æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">from</span> siameasenetwork.mnist.DataShuffler <span class="keyword">import</span> * <span class="comment">#è¿™æ˜¯æ‰“ä¹±æ•°æ®æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">from</span> siameasenetwork.mnist.lenet <span class="keyword">import</span> Lenet <span class="comment"># ä¸»ç½‘ç»œç»“æ„</span></span><br><span class="line"></span><br><span class="line">SEED = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_euclidean_distance</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Computes the euclidean distance between two tensorflow variables</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'euclidean_distance'</span>) <span class="keyword">as</span> scope:</span><br><span class="line">        <span class="comment">#d = tf.square(tf.sub(x, y))</span></span><br><span class="line">        <span class="comment">#d = tf.sqrt(tf.reduce_sum(d)) # What about the axis ???</span></span><br><span class="line">        d = tf.sqrt(tf.reduce_sum(tf.square(tf.subtract(x, y)), <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_contrastive_loss</span><span class="params">(left_feature, right_feature, label, margin, is_target_set_train=True)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Compute the contrastive loss as in</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    http://yann.lecun.com/exdb/publis/pdf/hadsell-chopra-lecun-06.pdf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    L = 0.5 * (Y) * D^2 + 0.5 * (1-Y) * &#123;max(0, margin - D)&#125;^2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    OR MAYBE THAT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    L = 0.5 * (1-Y) * D^2 + 0.5 * (Y) * &#123;max(0, margin - D)&#125;^2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **Parameters**</span></span><br><span class="line"><span class="string">     left_feature: First element of the pair</span></span><br><span class="line"><span class="string">     right_feature: Second element of the pair</span></span><br><span class="line"><span class="string">     label: Label of the pair (0 or 1)</span></span><br><span class="line"><span class="string">     margin: Contrastive margin</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **Returns**</span></span><br><span class="line"><span class="string">     Return the loss operation</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"contrastive_loss"</span>):</span><br><span class="line">        label = tf.to_float(label)</span><br><span class="line">        one = tf.constant(<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">        d = compute_euclidean_distance(left_feature, right_feature)</span><br><span class="line"></span><br><span class="line">        d_sqrt = tf.sqrt(d)</span><br><span class="line"></span><br><span class="line">        loss = label * tf.square(tf.maximum(<span class="number">0.</span>, margin - d_sqrt)) + (<span class="number">1</span> - label) * d</span><br><span class="line"></span><br><span class="line">        loss = <span class="number">0.5</span> * tf.reduce_mean(loss)</span><br><span class="line">        <span class="comment"># #first_part = tf.mul(one - label, tf.square(d))  # (Y-1)*(d^2)</span></span><br><span class="line">        <span class="comment"># #first_part = tf.mul(label, tf.square(d))  # (Y-1)*(d^2)</span></span><br><span class="line">        <span class="comment"># between_class = tf.exp(tf.multiply(one-label, tf.square(d)))  # (1-Y)*(d^2)</span></span><br><span class="line">        <span class="comment"># max_part = tf.square(tf.maximum(margin-d, 0))</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># within_class = tf.multiply(label, max_part)  # (Y) * max((margin - d)^2, 0)</span></span><br><span class="line">        <span class="comment"># #second_part = tf.mul(one-label, max_part)  # (Y) * max((margin - d)^2, 0)</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># loss = 0.5 * tf.reduce_mean(within_class + between_class)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># return loss, tf.reduce_mean(within_class), tf.reduce_mean(between_class)</span></span><br><span class="line">        <span class="keyword">return</span> loss</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_contrastive_loss_andre</span><span class="params">(left_feature, right_feature, label, margin, is_target_set_train=True)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Compute the contrastive loss as in</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    https://gitlab.idiap.ch/biometric/xfacereclib.cnn/blob/master/xfacereclib/cnn/scripts/experiment.py#L156</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    With Y = [-1 +1] --&gt; [POSITIVE_PAIR NEGATIVE_PAIR]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    L = log( m + exp( Y * d^2)) / N</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **Parameters**</span></span><br><span class="line"><span class="string">     left_feature: First element of the pair</span></span><br><span class="line"><span class="string">     right_feature: Second element of the pair</span></span><br><span class="line"><span class="string">     label: Label of the pair (0 or 1)</span></span><br><span class="line"><span class="string">     margin: Contrastive margin</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **Returns**</span></span><br><span class="line"><span class="string">     Return the loss operation</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">"contrastive_loss_andre"</span>):</span><br><span class="line">        label = tf.to_float(label)</span><br><span class="line">        d = compute_euclidean_distance(left_feature, right_feature)</span><br><span class="line"></span><br><span class="line">        loss = tf.log(tf.exp(tf.multiply(label, d)))</span><br><span class="line">        loss = tf.reduce_mean(loss)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Within class part</span></span><br><span class="line">        genuine_factor = tf.multiply(label<span class="number">-1</span>, <span class="number">0.5</span>)</span><br><span class="line">        within_class = tf.reduce_mean(tf.log(tf.exp(tf.multiply(genuine_factor, d))))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Between class part</span></span><br><span class="line">        impostor_factor = tf.multiply(label + <span class="number">1</span>, <span class="number">0.5</span>)</span><br><span class="line">        between_class = tf.reduce_mean(tf.log(tf.exp(tf.multiply(impostor_factor, d))))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># first_part = tf.mul(one - label, tf.square(d))  # (Y-1)*(d^2)</span></span><br><span class="line">        <span class="keyword">return</span> loss, between_class, within_class</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    BATCH_SIZE = <span class="number">128</span></span><br><span class="line">    BATCH_SIZE_TEST = <span class="number">128</span></span><br><span class="line">    <span class="comment">#BATCH_SIZE_TEST = 300</span></span><br><span class="line">    ITERATIONS = <span class="number">10000</span></span><br><span class="line">    VALIDATION_TEST = <span class="number">100</span></span><br><span class="line">    perc_train = <span class="number">0.9</span></span><br><span class="line">    CONTRASTIVE_MARGIN = <span class="number">1</span></span><br><span class="line">    USE_GPU = <span class="keyword">True</span></span><br><span class="line">    ANDRE_LOSS = <span class="keyword">False</span></span><br><span class="line">    LOG_NAME = <span class="string">'logs'</span></span><br><span class="line"></span><br><span class="line">    train_data, train_labels, test_data, test_labels = util.load_mnist()</span><br><span class="line"></span><br><span class="line">    data = np.concatenate((train_data, test_data), axis=<span class="number">0</span>)</span><br><span class="line">    label = np.concatenate((train_labels, test_labels), axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    data_shuffler = DataShuffler(train_data, train_labels, scale=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Creating the variables</span></span><br><span class="line">    lenet_architecture = Lenet(seed=SEED, use_gpu=USE_GPU)</span><br><span class="line">    <span class="comment"># Siamease place holders - Training</span></span><br><span class="line">    train_left_data = tf.placeholder(tf.float32, shape=(BATCH_SIZE*<span class="number">2</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>), name=<span class="string">"left"</span>)</span><br><span class="line">    train_right_data = tf.placeholder(tf.float32, shape=(BATCH_SIZE*<span class="number">2</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>), name=<span class="string">"right"</span>)</span><br><span class="line">    labels_data = tf.placeholder(tf.int32, shape=BATCH_SIZE*<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># Creating the graphs for training</span></span><br><span class="line">    lenet_train_left = lenet_architecture.create_lenet(train_left_data)</span><br><span class="line">    lenet_train_right = lenet_architecture.create_lenet(train_right_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Siamease place holders - Validation</span></span><br><span class="line">    validation_data = tf.placeholder(tf.float32, shape=(data_shuffler.validation_data.shape[<span class="number">0</span>], <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>), name=<span class="string">"validation"</span>)</span><br><span class="line">    labels_data_validation = tf.placeholder(tf.int32, shape=BATCH_SIZE_TEST)</span><br><span class="line">    <span class="comment"># Creating the graphs for validation</span></span><br><span class="line">    lenet_validation = lenet_architecture.create_lenet(validation_data, train=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ANDRE_LOSS:</span><br><span class="line">        loss, between_class, within_class = compute_contrastive_loss_andre(lenet_train_left, lenet_train_right, labels_data, CONTRASTIVE_MARGIN)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Regular contrastive loss</span></span><br><span class="line">        loss = compute_contrastive_loss(lenet_train_left, lenet_train_right, labels_data, CONTRASTIVE_MARGIN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    distances = compute_euclidean_distance(lenet_train_left, lenet_train_right)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#regularizer = (tf.nn.l2_loss(lenet_architecture.W_fc1) + tf.nn.l2_loss(lenet_architecture.b_fc1) +</span></span><br><span class="line">    <span class="comment">#                tf.nn.l2_loss(lenet_architecture.W_fc2) + tf.nn.l2_loss(lenet_architecture.b_fc2))</span></span><br><span class="line">    <span class="comment">#loss += 5e-4 * regularizer</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Defining training parameters</span></span><br><span class="line">    batch = tf.Variable(<span class="number">0</span>)</span><br><span class="line">    learning_rate = tf.train.exponential_decay(</span><br><span class="line">        <span class="number">0.01</span>, <span class="comment"># Learning rate</span></span><br><span class="line">        batch * BATCH_SIZE,</span><br><span class="line">        data_shuffler.train_data.shape[<span class="number">0</span>],</span><br><span class="line">        <span class="number">0.95</span> <span class="comment"># Decay step</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#optimizer = tf.train.GradientDescentOptimizer(learning_rate).minimize(loss, global_step=batch)</span></span><br><span class="line">    optimizer = tf.train.AdamOptimizer(<span class="number">0.01</span>, name=<span class="string">'Adam'</span>).minimize(loss, global_step=batch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pp = PdfPages("groups.pdf")</span></span><br><span class="line">    <span class="comment"># Training</span></span><br><span class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> session:</span><br><span class="line"></span><br><span class="line">        <span class="comment">#Trying to write things on tensor board</span></span><br><span class="line">        train_writer = tf.summary.FileWriter(LOG_NAME + <span class="string">'/train'</span>,</span><br><span class="line">                                              session.graph)</span><br><span class="line"></span><br><span class="line">        test_writer = tf.summary.FileWriter(LOG_NAME + <span class="string">'/test'</span>,</span><br><span class="line">                                              session.graph)</span><br><span class="line"></span><br><span class="line">        tf.summary.scalar(<span class="string">'loss'</span>, loss)</span><br><span class="line">        <span class="comment"># tf.summary.scalar('between_class', between_class)</span></span><br><span class="line">        <span class="comment"># tf.summary.scalar('within_class', within_class)</span></span><br><span class="line">        tf.summary.scalar(<span class="string">'lr'</span>, learning_rate)</span><br><span class="line">        merged = tf.summary.merge_all()</span><br><span class="line"></span><br><span class="line">        init = tf.global_variables_initializer()</span><br><span class="line">        session.run(init)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> range(ITERATIONS+<span class="number">1</span>):</span><br><span class="line"></span><br><span class="line">            batch_left, batch_right, labels = data_shuffler.get_pair(BATCH_SIZE, zero_one_labels=<span class="keyword">not</span> ANDRE_LOSS)</span><br><span class="line"></span><br><span class="line">            feed_dict = &#123;train_left_data: batch_left,</span><br><span class="line">                         train_right_data: batch_right,</span><br><span class="line">                         labels_data: labels&#125;</span><br><span class="line"></span><br><span class="line">            _, l, lr, summary = session.run([optimizer, loss, learning_rate, merged], feed_dict=feed_dict)</span><br><span class="line">            train_writer.add_summary(summary, step)</span><br><span class="line"></span><br><span class="line">            print(<span class="string">"Step &#123;0&#125;. Loss Validation = &#123;1&#125;"</span>.</span><br><span class="line">                  format(step, l))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> step % VALIDATION_TEST == <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Siamese validation</span></span><br><span class="line">                batch_left, batch_right, labels = data_shuffler.get_pair(n_pair=BATCH_SIZE_TEST,</span><br><span class="line">                                                                         is_target_set_train=<span class="keyword">False</span>,</span><br><span class="line">                                                                         zero_one_labels=<span class="keyword">not</span> ANDRE_LOSS)</span><br><span class="line">                feed_dict = &#123;train_left_data: batch_left,</span><br><span class="line">                             train_right_data: batch_right,</span><br><span class="line">                             labels_data: labels&#125;</span><br><span class="line"></span><br><span class="line">                d, lv, summary = session.run([distances, loss, merged], feed_dict=feed_dict)</span><br><span class="line">                test_writer.add_summary(summary, step)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">###################################</span></span><br><span class="line">                <span class="comment"># Siamese as a feature extractor</span></span><br><span class="line">                <span class="comment">###################################</span></span><br><span class="line">                batch_train_data, batch_train_labels = data_shuffler.get_batch(</span><br><span class="line">                    data_shuffler.validation_data.shape[<span class="number">0</span>],</span><br><span class="line">                    train_dataset=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">                features_train = session.run(lenet_validation,</span><br><span class="line">                                             feed_dict=&#123;validation_data: batch_train_data[:]&#125;)</span><br><span class="line"></span><br><span class="line">                batch_validation_data, batch_validation_labels = data_shuffler.get_batch(</span><br><span class="line">                    data_shuffler.validation_data.shape[<span class="number">0</span>],</span><br><span class="line">                    train_dataset=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">                features_validation = session.run(lenet_validation,</span><br><span class="line">                                                  feed_dict=&#123;validation_data: batch_validation_data[:]&#125;)</span><br><span class="line"></span><br><span class="line">                acc = util.compute_accuracy(features_train, batch_train_labels, features_validation, batch_validation_labels, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">                print(<span class="string">"Step &#123;0&#125;. Loss Validation = &#123;1&#125;, acc = &#123;2&#125;"</span>.</span><br><span class="line">                      format(step, lv, acc))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># fig = util.plot_embedding_lda(features_validation, batch_validation_labels)</span></span><br><span class="line">                <span class="comment"># pp.savefig(fig)</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">#if ANDRE_LOSS:</span></span><br><span class="line">                <span class="comment">#    positive_scores = d[numpy.where(labels == -1)[0]].astype("float")</span></span><br><span class="line">                <span class="comment">#    negative_scores = d[numpy.where(labels == 1)[0]].astype("float")</span></span><br><span class="line">                <span class="comment">#else:</span></span><br><span class="line">                <span class="comment">#    positive_scores = d[numpy.where(labels == 1)[0]].astype("float")</span></span><br><span class="line">                <span class="comment">#    negative_scores = d[numpy.where(labels == 0)[0]].astype("float")</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">#threshold = bob.measure.eer_threshold(negative_scores, positive_scores)</span></span><br><span class="line">                <span class="comment">#far, frr = bob.measure.farfrr(negative_scores, positive_scores, threshold)</span></span><br><span class="line">                <span class="comment">#eer = ((far + frr) / 2.) * 100.</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">"End !!"</span>)</span><br><span class="line">        train_writer.close()</span><br><span class="line">        test_writer.close()</span><br><span class="line">        <span class="comment"># pp.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>lenet.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># vim: set fileencoding=utf-8 :</span><br><span class="line"># @author: Tiago de Freitas Pereira &lt;tiago.pereira@idiap.ch&gt;</span><br><span class="line"># @date: Wed 11 May 2016 09:39:36 CEST </span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Class that creates the lenet architecture</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">from siameasenetwork.mnist.util import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Lenet(object):</span><br><span class="line"></span><br><span class="line">    def __init__(self,</span><br><span class="line">                 conv1_kernel_size=5,</span><br><span class="line">                 conv1_output=16,</span><br><span class="line"></span><br><span class="line">                 conv2_kernel_size=5,</span><br><span class="line">                 conv2_output=32,</span><br><span class="line"></span><br><span class="line">                 fc1_output=400,</span><br><span class="line">                 n_classes=10,</span><br><span class="line"></span><br><span class="line">                 seed=10, use_gpu = False):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Create all the necessary variables for this CNN</span><br><span class="line">        **Parameters**</span><br><span class="line">            conv1_kernel_size=5,</span><br><span class="line">            conv1_output=32,</span><br><span class="line">            conv2_kernel_size=5,</span><br><span class="line">            conv2_output=64,</span><br><span class="line">            fc1_output=400,</span><br><span class="line">            n_classes=10</span><br><span class="line">            seed = 10</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # First convolutional</span><br><span class="line">        self.W_conv1 = create_weight_variables([conv1_kernel_size, conv1_kernel_size, 1, conv1_output], seed=seed, name=&quot;W_conv1&quot;, use_gpu=use_gpu)</span><br><span class="line">        self.b_conv1 = create_bias_variables([conv1_output], name=&quot;bias_conv1&quot;, use_gpu=use_gpu)</span><br><span class="line"></span><br><span class="line">        # Second convolutional</span><br><span class="line">        self.W_conv2 = create_weight_variables([conv2_kernel_size, conv2_kernel_size, conv1_output, conv2_output], seed=seed, name=&quot;W_conv2&quot;, use_gpu=use_gpu)</span><br><span class="line">        self.b_conv2 = create_bias_variables([conv2_output], name=&quot;bias_conv2&quot;, use_gpu=use_gpu)</span><br><span class="line"></span><br><span class="line">        # First fc</span><br><span class="line">        self.W_fc1 = create_weight_variables([(28 // 4) * (28 // 4) * conv2_output, fc1_output], seed=seed, name=&quot;W_fc1&quot;, use_gpu=use_gpu)</span><br><span class="line">        self.b_fc1 = create_bias_variables([fc1_output], name=&quot;bias_fc1&quot;, use_gpu=use_gpu)</span><br><span class="line"></span><br><span class="line">        # Second FC fc</span><br><span class="line">        self.W_fc2 = create_weight_variables([fc1_output, n_classes], seed=seed, name=&quot;W_fc2&quot;, use_gpu=use_gpu)</span><br><span class="line">        self.b_fc2 = create_bias_variables([n_classes], name=&quot;bias_fc2&quot;, use_gpu=use_gpu)</span><br><span class="line"></span><br><span class="line">        self.seed = seed</span><br><span class="line"></span><br><span class="line">    def create_lenet(self, data, train=True):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Create the Lenet Architecture</span><br><span class="line">        **Parameters**</span><br><span class="line">          data: Input data</span><br><span class="line">          train:</span><br><span class="line">        **Returns</span><br><span class="line">          features_back: Features for backpropagation</span><br><span class="line">          features_val: Features for validation</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        # Creating the architecture</span><br><span class="line">        # First convolutional</span><br><span class="line">        with tf.name_scope(&apos;conv_1&apos;) as scope:</span><br><span class="line">            conv1 = create_conv2d(data, self.W_conv1)</span><br><span class="line">        # relu1 = create_relu(conv1, self.b_conv1)</span><br><span class="line">        # relu1 = create_sigmoid(conv1, self.b_conv1)</span><br><span class="line"></span><br><span class="line">        with tf.name_scope(&apos;tanh_1&apos;) as scope:</span><br><span class="line">            tanh_1 = create_tanh(conv1, self.b_conv1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        # Pooling</span><br><span class="line">        # pool1 = create_max_pool(relu1)</span><br><span class="line">        # pool1 = create_max_pool(relu1)</span><br><span class="line">        with tf.name_scope(&apos;pool_1&apos;) as scope:</span><br><span class="line">            pool1 = create_max_pool(tanh_1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        # Second convolutional</span><br><span class="line">        with tf.name_scope(&apos;conv_2&apos;) as scope:</span><br><span class="line">            conv2 = create_conv2d(pool1, self.W_conv2)</span><br><span class="line">        # relu2 = create_relu(conv2, self.b_conv2)</span><br><span class="line">        # relu2 = create_sigmoid(conv2, self.b_conv2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        with tf.name_scope(&apos;tanh_2&apos;) as scope:</span><br><span class="line">            # pool2 = create_max_pool(relu2)</span><br><span class="line">            #tanh_2 = create_relu(conv2, self.b_conv2)</span><br><span class="line">            # pool2 = create_max_pool(conv2)</span><br><span class="line">            tanh_2 = create_tanh(conv2, self.b_conv2)</span><br><span class="line"></span><br><span class="line">        # Pooling</span><br><span class="line">        with tf.name_scope(&apos;pool_2&apos;) as scope:</span><br><span class="line">            pool2 = create_max_pool(tanh_2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        #if train:</span><br><span class="line">            #pool2 = tf.nn.dropout(pool2, 0.5, seed=self.seed)</span><br><span class="line"></span><br><span class="line">        # Reshaping all the convolved images to 2D to feed the FC layers</span><br><span class="line">        # FC1</span><br><span class="line">        with tf.name_scope(&apos;fc_1&apos;) as scope:</span><br><span class="line">            pool_shape = pool2.get_shape().as_list()</span><br><span class="line">            reshape = tf.reshape(pool2, [pool_shape[0], pool_shape[1] * pool_shape[2] * pool_shape[3]])</span><br><span class="line">            #fc1 = tf.nn.relu(tf.matmul(reshape, self.W_fc1) + self.b_fc1)</span><br><span class="line">            fc1 = tf.nn.tanh(tf.matmul(reshape, self.W_fc1) + self.b_fc1)</span><br><span class="line"></span><br><span class="line">        #if train:</span><br><span class="line">            #fc1 = tf.nn.dropout(fc1, 0.5, seed=self.seed)</span><br><span class="line"></span><br><span class="line">        # FC2</span><br><span class="line">        with tf.name_scope(&apos;fc_2&apos;) as scope:</span><br><span class="line">            fc2 = tf.matmul(fc1, self.W_fc2) + self.b_fc2</span><br><span class="line">            #fc2 = tf.nn.softmax(tf.matmul(fc1, self.W_fc2) + self.b_fc2)</span><br><span class="line"></span><br><span class="line">        return fc2</span><br></pre></td></tr></table></figure><p>util.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># vim: set fileencoding=utf-8 :</span><br><span class="line"># @author: Tiago de Freitas Pereira &lt;tiago.pereira@idiap.ch&gt;</span><br><span class="line"># @date: Wed 11 May 2016 09:39:36 CEST </span><br><span class="line"></span><br><span class="line">import numpy</span><br><span class="line">import tensorflow as tf</span><br><span class="line">numpy.random.seed(10)</span><br><span class="line">from tensorflow.examples.tutorials.mnist import input_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_weight_variables(shape, seed, name, use_gpu=False):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Create gaussian random neurons with mean 0 and std 0.1</span><br><span class="line">    **Paramters**</span><br><span class="line">      shape: Shape of the layer</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    #import ipdb; ipdb.set_trace()</span><br><span class="line"></span><br><span class="line">    if len(shape) == 4:</span><br><span class="line">        in_out = shape[0] * shape[1] * shape[2] + shape[3]</span><br><span class="line">    else:</span><br><span class="line">        in_out = shape[0] + shape[1]</span><br><span class="line"></span><br><span class="line">    import math</span><br><span class="line">    stddev = math.sqrt(3.0 / in_out) # XAVIER INITIALIZER (GAUSSIAN)</span><br><span class="line"></span><br><span class="line">    initializer = tf.truncated_normal(shape, stddev=stddev, seed=seed)</span><br><span class="line">    </span><br><span class="line">    if use_gpu:</span><br><span class="line">        with tf.device(&quot;/gpu&quot;):</span><br><span class="line">            return tf.get_variable(name, initializer=initializer, dtype=tf.float32)</span><br><span class="line">    else:</span><br><span class="line">        with tf.device(&quot;/cpu&quot;):</span><br><span class="line">            return tf.get_variable(name, initializer=initializer, dtype=tf.float32)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_bias_variables(shape, name, use_gpu=False):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Create the bias term</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    initializer = tf.constant(0.1, shape=shape)</span><br><span class="line">    </span><br><span class="line">    if use_gpu:</span><br><span class="line">        with tf.device(&quot;/gpu&quot;):</span><br><span class="line">            return tf.get_variable(name, initializer=initializer, dtype=tf.float32)</span><br><span class="line">    else:</span><br><span class="line">        with tf.device(&quot;/cpu&quot;):</span><br><span class="line">            return tf.get_variable(name, initializer=initializer, dtype=tf.float32)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_conv2d(x, W):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Create a convolutional kernel with 1 pixel of stride</span><br><span class="line">    **Parameters**</span><br><span class="line">        x: input layer</span><br><span class="line">        W: Neurons</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return tf.nn.conv2d(x, W, strides=[1, 1, 1, 1], padding=&apos;SAME&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_max_pool(x):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Create max pooling using a patch of 2x2</span><br><span class="line">    **Parameters**</span><br><span class="line">        x: input layer</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return tf.nn.max_pool(x, ksize=[1, 2, 2, 1], strides=[1, 2, 2, 1], padding=&apos;SAME&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_tanh(x, bias):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Create the Tanh activations</span><br><span class="line">    **Parameters**</span><br><span class="line">        x: input layer</span><br><span class="line">        bias: bias term</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    return tf.nn.tanh(tf.nn.bias_add(x, bias))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_relu(x, bias):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Create the ReLU activations</span><br><span class="line">    **Parameters**</span><br><span class="line">        x: input layer</span><br><span class="line">        bias: bias term</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    return tf.nn.relu(tf.nn.bias_add(x, bias))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_sigmoid(x, bias):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Create the Sigmoid activations</span><br><span class="line">    **Parameters**</span><br><span class="line">        x: input layer</span><br><span class="line">        bias: bias term</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    return tf.nn.sigmoid(tf.nn.bias_add(x, bias))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def scale_mean_norm(data, scale=0.00390625):</span><br><span class="line">    mean = numpy.mean(data)</span><br><span class="line">    data = (data - mean) * scale</span><br><span class="line"></span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def evaluate_softmax(data, labels, session, network, data_node):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Evaluate the network assuming that the output layer is a softmax</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    predictions = numpy.argmax(session.run(</span><br><span class="line">        network,</span><br><span class="line">        feed_dict=&#123;data_node: data[:]&#125;), 1)</span><br><span class="line"></span><br><span class="line">    return 100. * numpy.sum(predictions == labels) / predictions.shape[0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def load_mnist():</span><br><span class="line">    mnist_data = input_data.read_data_sets(&quot;MNIST_data/&quot;, one_hot=True)</span><br><span class="line">    train_data = mnist_data.train.images</span><br><span class="line">    test_data = mnist_data.test.images</span><br><span class="line">    train_labels = mnist_data.train.labels</span><br><span class="line">    test_labels = mnist_data.test.labels</span><br><span class="line"></span><br><span class="line">    return train_data, train_labels, test_data, test_labels</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def plot_embedding_pca(features, labels):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Trains a PCA using bob, reducing the features to dimension 2 and plot it the possible clusters</span><br><span class="line">    :param features:</span><br><span class="line">    :param labels:</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    import bob.learn.linear</span><br><span class="line">    import matplotlib.pyplot as mpl</span><br><span class="line"></span><br><span class="line">    colors = [&apos;#FF0000&apos;, &apos;#FFFF00&apos;, &apos;#FF00FF&apos;, &apos;#00FFFF&apos;, &apos;#000000&apos;,</span><br><span class="line">             &apos;#AA0000&apos;, &apos;#AAAA00&apos;, &apos;#AA00AA&apos;, &apos;#00AAAA&apos;, &apos;#330000&apos;]</span><br><span class="line"></span><br><span class="line">    # Training PCA</span><br><span class="line">    trainer = bob.learn.linear.PCATrainer()</span><br><span class="line">    machine, lamb = trainer.train(features.astype(&quot;float64&quot;))</span><br><span class="line"></span><br><span class="line">    # Getting the first two most relevant features</span><br><span class="line">    projected_features = machine(features.astype(&quot;float64&quot;))[:, 0:2]</span><br><span class="line"></span><br><span class="line">    # Plotting the classes</span><br><span class="line">    n_classes = max(labels)+1</span><br><span class="line">    fig = mpl.figure()</span><br><span class="line"></span><br><span class="line">    for i in range(n_classes):</span><br><span class="line">        indexes = numpy.where(labels == i)[0]</span><br><span class="line"></span><br><span class="line">        selected_features = projected_features[indexes,:]</span><br><span class="line">        mpl.scatter(selected_features[:, 0], selected_features[:, 1],</span><br><span class="line">                 marker=&apos;.&apos;, c=colors[i], linewidths=0, label=str(i))</span><br><span class="line">    mpl.legend()</span><br><span class="line">    return fig</span><br><span class="line"></span><br><span class="line">def plot_embedding_lda(features, labels):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Trains a LDA using bob, reducing the features to dimension 2 and plot it the possible clusters</span><br><span class="line">    :param features:</span><br><span class="line">    :param labels:</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    import bob.learn.linear</span><br><span class="line">    import matplotlib.pyplot as mpl</span><br><span class="line"></span><br><span class="line">    colors = [&apos;#FF0000&apos;, &apos;#FFFF00&apos;, &apos;#FF00FF&apos;, &apos;#00FFFF&apos;, &apos;#000000&apos;,</span><br><span class="line">             &apos;#AA0000&apos;, &apos;#AAAA00&apos;, &apos;#AA00AA&apos;, &apos;#00AAAA&apos;, &apos;#330000&apos;]</span><br><span class="line">    n_classes = max(labels)+1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # Training PCA</span><br><span class="line">    trainer = bob.learn.linear.FisherLDATrainer(use_pinv=True)</span><br><span class="line">    lda_features = []</span><br><span class="line">    for i in range(n_classes):</span><br><span class="line">        indexes = numpy.where(labels == i)[0]</span><br><span class="line">        lda_features.append(features[indexes, :].astype(&quot;float64&quot;))</span><br><span class="line"></span><br><span class="line">    machine, lamb = trainer.train(lda_features)</span><br><span class="line"></span><br><span class="line">    #import ipdb; ipdb.set_trace();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # Getting the first two most relevant features</span><br><span class="line">    projected_features = machine(features.astype(&quot;float64&quot;))[:, 0:2]</span><br><span class="line"></span><br><span class="line">    # Plotting the classes</span><br><span class="line">    fig = mpl.figure()</span><br><span class="line"></span><br><span class="line">    for i in range(n_classes):</span><br><span class="line">        indexes = numpy.where(labels == i)[0]</span><br><span class="line"></span><br><span class="line">        selected_features = projected_features[indexes,:]</span><br><span class="line">        mpl.scatter(selected_features[:, 0], selected_features[:, 1],</span><br><span class="line">                 marker=&apos;.&apos;, c=colors[i], linewidths=0, label=str(i))</span><br><span class="line">    mpl.legend()</span><br><span class="line">    return fig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def compute_eer(data_train, labels_train, data_validation, labels_validation, n_classes):</span><br><span class="line">    from scipy.spatial.distance import cosine</span><br><span class="line"></span><br><span class="line">    # Creating client models</span><br><span class="line">    models = []</span><br><span class="line">    for i in range(n_classes):</span><br><span class="line">        labels_num = numpy.argmax(labels_train, axis=1)</span><br><span class="line">        indexes = numpy.where(labels_num == i)</span><br><span class="line">        models.append(numpy.mean(data_train[indexes, :], axis=0))</span><br><span class="line"></span><br><span class="line">    # Probing</span><br><span class="line">    positive_scores = numpy.zeros(shape=0)</span><br><span class="line">    negative_scores = numpy.zeros(shape=0)</span><br><span class="line"></span><br><span class="line">    for i in range(n_classes):</span><br><span class="line">        # Positive scoring</span><br><span class="line">        val_num = numpy.argmax(labels_validation)</span><br><span class="line">        indexes = numpy.where(val_num == i)</span><br><span class="line">        positive_data = data_validation[indexes, :]</span><br><span class="line">        p = [cosine(models[i], positive_data[j]) for j in range(positive_data.shape[0])]</span><br><span class="line">        positive_scores = numpy.hstack((positive_scores, p))</span><br><span class="line"></span><br><span class="line">        # negative scoring</span><br><span class="line">        indexes = numpy.where(val_num != i)</span><br><span class="line">        negative_data = data_validation[indexes, :]</span><br><span class="line">        n = [cosine(models[i], negative_data[j]) for j in range(negative_data.shape[0])]</span><br><span class="line">        negative_scores = numpy.hstack((negative_scores, n))</span><br><span class="line"></span><br><span class="line">    # Computing performance based on EER</span><br><span class="line">    negative_scores = (-1) * negative_scores</span><br><span class="line">    positive_scores = (-1) * positive_scores</span><br><span class="line"></span><br><span class="line">    # threshold = bob.measure.eer_threshold(negative_scores, positive_scores)</span><br><span class="line">    # far, frr = bob.measure.farfrr(negative_scores, positive_scores, threshold)</span><br><span class="line">    # eer = (far + frr) / 2.</span><br><span class="line"></span><br><span class="line">    return negative_scores, positive_scores</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def compute_accuracy(data_train, labels_train, data_validation, labels_validation, n_classes):</span><br><span class="line">    from scipy.spatial.distance import cosine</span><br><span class="line"></span><br><span class="line">    # Creating client models</span><br><span class="line">    models = []</span><br><span class="line">    for i in range(n_classes):</span><br><span class="line">        index = numpy.argmax(labels_train, axis=1)</span><br><span class="line">        indexes = numpy.where(index == i)[0]</span><br><span class="line">        data_t = [data_train[i] for i in indexes]</span><br><span class="line">        models.append(numpy.mean(data_t, axis=0))</span><br><span class="line"></span><br><span class="line">    # Probing</span><br><span class="line">    tp = 0</span><br><span class="line">    for i in range(data_validation.shape[0]):</span><br><span class="line"></span><br><span class="line">        d = data_validation[i,:]</span><br><span class="line">        l = labels_validation[i]</span><br><span class="line"></span><br><span class="line">        scores = [cosine(m, d) for m in models]</span><br><span class="line">        predict = numpy.argmin(scores)</span><br><span class="line"></span><br><span class="line">        ll = numpy.argmax(l, axis=0)</span><br><span class="line">        if predict == ll:</span><br><span class="line">            tp += 1</span><br><span class="line"></span><br><span class="line">    return (float(tp) / data_validation.shape[0]) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def compute_acc(data_val, labels_val):</span><br><span class="line">    tp = 0</span><br><span class="line">    data_size = data_val.shape[0]</span><br><span class="line">    for i in range(data_size):</span><br><span class="line">        index = numpy.argmax(data_val[i])</span><br><span class="line">        if index == numpy.argmax(labels_val[i]):</span><br><span class="line">            tp += 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return (float(tp) / data_size)</span><br></pre></td></tr></table></figure><p>DataShuffler.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># vim: set fileencoding=utf-8 :</span><br><span class="line"># @author: Tiago de Freitas Pereira &lt;tiago.pereira@idiap.ch&gt;</span><br><span class="line"># @date: Wed 11 May 2016 09:39:36 CEST </span><br><span class="line"></span><br><span class="line">import numpy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def scale_mean_norm(data, scale=0.00390625):</span><br><span class="line">    mean = numpy.mean(data)</span><br><span class="line">    data = (data - mean) * scale</span><br><span class="line"></span><br><span class="line">    return data, mean</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Data</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class DataShuffler(object):</span><br><span class="line">    def __init__(self, data, labels, perc_train=0.9, scale=True):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">         Some base functions for neural networks</span><br><span class="line">         **Parameters**</span><br><span class="line">           data:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        scale_value = 0.00390625</span><br><span class="line"></span><br><span class="line">        total_samples = data.shape[0] #æ€»å…±çš„æ ·æœ¬æ•°é‡</span><br><span class="line"></span><br><span class="line">        indexes = numpy.array(range(total_samples))</span><br><span class="line">        numpy.random.shuffle(indexes)</span><br><span class="line"></span><br><span class="line">        # Spliting train and validation</span><br><span class="line">        train_samples = int(round(total_samples * perc_train)) #è®­ç»ƒæ ·æœ¬æ•°ç›®</span><br><span class="line">        validation_samples = total_samples - train_samples #éªŒè¯é›†æ ·æœ¬æ•°ç›®</span><br><span class="line">        data = numpy.reshape(data, (data.shape[0], 28, 28, 1)) #æ‰€æœ‰è¾“å…¥æ ·æœ¬</span><br><span class="line"></span><br><span class="line">        self.train_data = data[indexes[0:train_samples], :, :, :] # è®­ç»ƒæ ·æœ¬</span><br><span class="line">        self.train_labels = labels[indexes[0:train_samples]] # è®­ç»ƒlabels</span><br><span class="line"></span><br><span class="line">        self.validation_data = data[indexes[train_samples:train_samples + validation_samples], :, :, :]</span><br><span class="line">        self.validation_labels = labels[indexes[train_samples:train_samples + validation_samples]]</span><br><span class="line">        self.total_labels = 10</span><br><span class="line"></span><br><span class="line">        if scale:</span><br><span class="line">            # data = scale_minmax_norm(data,lower_bound = -1, upper_bound = 1)</span><br><span class="line">            self.train_data, self.mean = scale_mean_norm(self.train_data)</span><br><span class="line">            self.validation_data = (self.validation_data - self.mean) * scale_value</span><br><span class="line"></span><br><span class="line">    def get_batch(self, n_samples, train_dataset=True):</span><br><span class="line"></span><br><span class="line">        if train_dataset:</span><br><span class="line">            data = self.train_data</span><br><span class="line">            label = self.train_labels</span><br><span class="line">        else:</span><br><span class="line">            data = self.validation_data</span><br><span class="line">            label = self.validation_labels</span><br><span class="line"></span><br><span class="line">        # Shuffling samples</span><br><span class="line">        indexes = numpy.array(range(data.shape[0]))</span><br><span class="line">        numpy.random.shuffle(indexes)</span><br><span class="line"></span><br><span class="line">        selected_data = data[indexes[0:n_samples], :, :, :]</span><br><span class="line">        selected_labels = label[indexes[0:n_samples]]</span><br><span class="line"></span><br><span class="line">        return selected_data.astype(&quot;float32&quot;), selected_labels</span><br><span class="line"></span><br><span class="line">    def get_pair(self, n_pair=1, is_target_set_train=True, zero_one_labels=True):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Get a random pair of samples</span><br><span class="line">        **Parameters**</span><br><span class="line">            is_target_set_train: Defining the target set to get the batch</span><br><span class="line">        **Return**</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        def get_genuine_or_not(input_data, input_labels, genuine=True):</span><br><span class="line"></span><br><span class="line">            if genuine:</span><br><span class="line">                # TODO: THIS KEY SELECTION NEEDS TO BE MORE EFFICIENT</span><br><span class="line"></span><br><span class="line">                # Getting a client</span><br><span class="line">                index = numpy.random.randint(self.total_labels)</span><br><span class="line"></span><br><span class="line">                # Getting the indexes of the data from a particular client</span><br><span class="line">                arg_max = numpy.argmax(input_labels, axis=1)</span><br><span class="line">                indexes = numpy.where(arg_max == index)[0]</span><br><span class="line">                numpy.random.shuffle(indexes)</span><br><span class="line"></span><br><span class="line">                # Picking a pair</span><br><span class="line">                data = input_data[indexes[0], :, :, :]</span><br><span class="line">                data_p = input_data[indexes[1], :, :, :]</span><br><span class="line"></span><br><span class="line">            else:</span><br><span class="line">                # Picking a pair from different clients</span><br><span class="line">                index = numpy.random.choice(self.total_labels, 2, replace=False)</span><br><span class="line"></span><br><span class="line">                # Getting the indexes of the two clients</span><br><span class="line">                arg_max = numpy.argmax(input_labels, axis=1)</span><br><span class="line">                indexes = numpy.where(arg_max == index[0])[0]</span><br><span class="line">                indexes_p = numpy.where(arg_max == index[1])[0]</span><br><span class="line">                numpy.random.shuffle(indexes)</span><br><span class="line">                numpy.random.shuffle(indexes_p)</span><br><span class="line"></span><br><span class="line">                # Picking a pair</span><br><span class="line">                data = input_data[indexes[0], :, :, :]</span><br><span class="line">                data_p = input_data[indexes_p[0], :, :, :]</span><br><span class="line"></span><br><span class="line">            return data, data_p</span><br><span class="line"></span><br><span class="line">        if is_target_set_train:</span><br><span class="line">            target_data = self.train_data</span><br><span class="line">            target_labels = self.train_labels</span><br><span class="line">        else:</span><br><span class="line">            target_data = self.validation_data</span><br><span class="line">            target_labels = self.validation_labels</span><br><span class="line"></span><br><span class="line">        total_data = n_pair * 2</span><br><span class="line">        c = target_data.shape[3]</span><br><span class="line">        w = target_data.shape[1]</span><br><span class="line">        h = target_data.shape[2]</span><br><span class="line"></span><br><span class="line">        data = numpy.zeros(shape=(total_data, w, h, c), dtype=&apos;float32&apos;)</span><br><span class="line">        data_p = numpy.zeros(shape=(total_data, w, h, c), dtype=&apos;float32&apos;)</span><br><span class="line">        labels_siamese = numpy.zeros(shape=total_data, dtype=&apos;float32&apos;)</span><br><span class="line"></span><br><span class="line">        genuine = True</span><br><span class="line">        for i in range(total_data):</span><br><span class="line">            data[i, :, :, :], data_p[i, :, :, :] = get_genuine_or_not(target_data, target_labels, genuine=genuine)</span><br><span class="line">            if zero_one_labels:</span><br><span class="line">                labels_siamese[i] = not genuine</span><br><span class="line">            else:</span><br><span class="line">                labels_siamese[i] = -1 if genuine else +1</span><br><span class="line">            genuine = not genuine</span><br><span class="line"></span><br><span class="line">        return data, data_p, labels_siamese</span><br><span class="line"></span><br><span class="line">    def get_triplet(self, n_labels, n_triplets=1, is_target_set_train=True):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Get a triplet</span><br><span class="line">        **Parameters**</span><br><span class="line">            is_target_set_train: Defining the target set to get the batch</span><br><span class="line">        **Return**</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        def get_one_triplet(input_data, input_labels):</span><br><span class="line"></span><br><span class="line">            # Getting a pair of clients</span><br><span class="line">            index = numpy.random.choice(n_labels, 2, replace=False)</span><br><span class="line">            label_positive = index[0]</span><br><span class="line">            label_negative = index[1]</span><br><span class="line"></span><br><span class="line">            # Getting the indexes of the data from a particular client</span><br><span class="line">            indexes = numpy.where(input_labels == index[0])[0]</span><br><span class="line">            numpy.random.shuffle(indexes)</span><br><span class="line"></span><br><span class="line">            # Picking a positive pair</span><br><span class="line">            data_anchor = input_data[indexes[0], :, :, :]</span><br><span class="line">            data_positive = input_data[indexes[1], :, :, :]</span><br><span class="line"></span><br><span class="line">            # Picking a negative sample</span><br><span class="line">            indexes = numpy.where(input_labels == index[1])[0]</span><br><span class="line">            numpy.random.shuffle(indexes)</span><br><span class="line">            data_negative = input_data[indexes[0], :, :, :]</span><br><span class="line"></span><br><span class="line">            return data_anchor, data_positive, data_negative, label_positive, label_positive, label_negative</span><br><span class="line"></span><br><span class="line">        if is_target_set_train:</span><br><span class="line">            target_data = self.train_data</span><br><span class="line">            target_labels = self.train_labels</span><br><span class="line">        else:</span><br><span class="line">            target_data = self.validation_data</span><br><span class="line">            target_labels = self.validation_labels</span><br><span class="line"></span><br><span class="line">        c = target_data.shape[3]</span><br><span class="line">        w = target_data.shape[1]</span><br><span class="line">        h = target_data.shape[2]</span><br><span class="line"></span><br><span class="line">        data_a = numpy.zeros(shape=(n_triplets, w, h, c), dtype=&apos;float32&apos;)</span><br><span class="line">        data_p = numpy.zeros(shape=(n_triplets, w, h, c), dtype=&apos;float32&apos;)</span><br><span class="line">        data_n = numpy.zeros(shape=(n_triplets, w, h, c), dtype=&apos;float32&apos;)</span><br><span class="line">        labels_a = numpy.zeros(shape=n_triplets, dtype=&apos;float32&apos;)</span><br><span class="line">        labels_p = numpy.zeros(shape=n_triplets, dtype=&apos;float32&apos;)</span><br><span class="line">        labels_n = numpy.zeros(shape=n_triplets, dtype=&apos;float32&apos;)</span><br><span class="line"></span><br><span class="line">        for i in range(n_triplets):</span><br><span class="line">            data_a[i, :, :, :], data_p[i, :, :, :], data_n[i, :, :, :], \</span><br><span class="line">            labels_a[i], labels_p[i], labels_n[i] = \</span><br><span class="line">                get_one_triplet(target_data, target_labels)</span><br><span class="line"></span><br><span class="line">        return data_a, data_p, data_n, labels_a, labels_p, labels_n</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-å®ç°siamese-network&quot;&gt;TensorFlow å®ç°Siamese Network&lt;/h1&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;è¿™æ¬¡æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªåŸºäºlenetçš„Siamese Networkï¼Œå¤§å®¶å¦‚æœæƒ³äº†è§£Siamese
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆå…­ï¼‰</title>
    <link href="http://weafteam.github.io/posts/74232ae7/"/>
    <id>http://weafteam.github.io/posts/74232ae7/</id>
    <published>2018-05-27T10:39:08.000Z</published>
    <updated>2018-08-07T08:56:41.653Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å‰äº”ç¯‡æ–‡ç« ä»‹ç»äº† <code>asyncio</code> çš„ APIï¼Œä»è¿™ç¯‡å¼€å§‹ï¼Œå°±è¦è®²ä¸€äº› Real Worldï¼ˆå¹¶ä¸ï¼‰çš„ä¸œè¥¿äº†ã€‚</p><h2 id="ä½¿ç”¨-aiohttp-ä½œä¸º-http-å®¢æˆ·ç«¯">ä½¿ç”¨ aiohttp ä½œä¸º HTTP å®¢æˆ·ç«¯</h2><p><a href="https://docs.aiohttp.org/en/stable/index.html" target="_blank" rel="noopener">aiohttp</a> æ˜¯ä¸€ä¸ªåŸºäº <code>asyncio</code> çš„å¼‚æ­¥ HTTP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åº“ï¼Œä¹Ÿæ˜¯ <code>asyncio</code> ç”Ÿæ€ä¸­å‘å±•æœ€è¿…é€Ÿçš„ç¬¬ä¸‰æ–¹åº“ä¹‹ä¸€ã€‚åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ aiohttp ä½œä¸º HTTP å®¢æˆ·ç«¯æ¥æ¯”è¾ƒä¸€ä¸‹åŒæ­¥ã€åŸºäºçº¿ç¨‹çš„å¼‚æ­¥å’ŒåŸºäº <code>asyncio</code> çš„å¼‚æ­¥çš„å·®åˆ«ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h3><p>é¦–å…ˆæˆ‘ä»¬å®‰è£…å¥½æ‰€éœ€çš„ç¬¬ä¸‰æ–¹åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install requests</span><br><span class="line">pip install aiohttp</span><br></pre></td></tr></table></figure><p>å‡†å¤‡ä¸€äº›ç”¨äºå¹¶å‘è¯·æ±‚çš„ urlï¼Œå…± 45 ä¸ªï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url.py</span></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">'http://caipiao.hao123.com/'</span>, <span class="string">'http://game.hao123.com/'</span>,</span><br><span class="line">    <span class="string">'http://mail.10086.cn/'</span>, <span class="string">'http://mail.126.com/'</span>, <span class="string">'http://mail.163.com/'</span>,</span><br><span class="line">    <span class="string">'http://mail.aliyun.com/'</span>, <span class="string">'http://mail.qq.com/'</span>,</span><br><span class="line">    <span class="string">'http://mail.sina.com.cn/'</span>, <span class="string">'http://music.163.com/'</span>,</span><br><span class="line">    <span class="string">'http://tuijian.hao123.com/'</span>, <span class="string">'http://www.12306.cn/'</span>, <span class="string">'http://www.163.com/'</span>,</span><br><span class="line">    <span class="string">'http://www.37.com/'</span>, <span class="string">'http://www.4399.com/'</span>, <span class="string">'http://www.abchina.com/'</span>,</span><br><span class="line">    <span class="string">'http://www.baidu.com/'</span>, <span class="string">'http://www.bankcomm.com/'</span>, <span class="string">'http://www.boc.cn/'</span>,</span><br><span class="line">    <span class="string">'http://www.ccb.com/'</span>, <span class="string">'http://www.chsi.com.cn/'</span>,</span><br><span class="line">    <span class="string">'http://www.cmbchina.com/'</span>, <span class="string">'http://www.cnki.net/'</span>,</span><br><span class="line">    <span class="string">'http://www.eastmoney.com/'</span>, <span class="string">'http://www.fang.com/'</span>,</span><br><span class="line">    <span class="string">'http://www.icbc.com.cn/icbc/'</span>, <span class="string">'http://www.ifeng.com'</span>,</span><br><span class="line">    <span class="string">'http://www.iqiyi.com/'</span>, <span class="string">'http://www.psbc.com/'</span>, <span class="string">'http://www.qq.com/'</span>,</span><br><span class="line">    <span class="string">'http://www.sina.com.cn/'</span>, <span class="string">'http://www.sohu.com/'</span>, <span class="string">'http://www.tianya.cn/'</span>,</span><br><span class="line">    <span class="string">'http://www.zhihu.com/'</span>, <span class="string">'http://wyyx.hao123.com/'</span>, <span class="string">'https://mail.qq.com/'</span>,</span><br><span class="line">    <span class="string">'https://mail.sohu.com/'</span>, <span class="string">'https://tieba.baidu.com/'</span>, <span class="string">'https://weibo.com/'</span>,</span><br><span class="line">    <span class="string">'https://www.autohome.com.cn/'</span>, <span class="string">'https://www.bilibili.com/'</span>,</span><br><span class="line">    <span class="string">'https://www.booking.com/'</span>, <span class="string">'https://www.douyu.com/'</span>,</span><br><span class="line">    <span class="string">'https://www.qunar.com/'</span>, <span class="string">'https://www.suning.com/'</span>,</span><br><span class="line">    <span class="string">'https://www.taobao.com/'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="åŒæ­¥çš„è¯·æ±‚">åŒæ­¥çš„è¯·æ±‚</h3><p>é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„åº“ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> url <span class="keyword">import</span> urls</span><br></pre></td></tr></table></figure><p>å®Œæˆè¯·æ±‚å•ä¸ª url çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä»¥ <code>bytes</code> å½¢å¼è¿”å›ç½‘ç«™å†…å®¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    resp = session.get(url)</span><br><span class="line">    <span class="keyword">return</span> resp.content</span><br></pre></td></tr></table></figure><p>åŒæ­¥è¯·æ±‚æ‰€æœ‰çš„ urlï¼Œæ‰“å°å‡ºå­—èŠ‚çš„é•¿åº¦ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    session = requests.Session()</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        data = fetch(session, url)</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;url&#125;</span>: <span class="subst">&#123;len(data)&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>è®°å½•å®Œæˆè¯·æ±‚æ‰€éœ€çš„æ—¶é—´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    main()</span><br><span class="line">    print(time.time() - start)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">http://caipiao.hao123.com/: 109299</span><br><span class="line">http://game.hao123.com/: 179707</span><br><span class="line">http://mail.10086.cn/: 52500</span><br><span class="line">http://mail.126.com/: 13063</span><br><span class="line">http://mail.163.com/: 137118</span><br><span class="line">http://mail.aliyun.com/: 725</span><br><span class="line">http://mail.qq.com/: 8206</span><br><span class="line">http://mail.sina.com.cn/: 2837</span><br><span class="line">http://music.163.com/: 92606</span><br><span class="line">...</span><br><span class="line">https://www.autohome.com.cn/: 656200</span><br><span class="line">https://www.bilibili.com/: 26642</span><br><span class="line">https://www.booking.com/: 457842</span><br><span class="line">https://www.douyu.com/: 75286</span><br><span class="line">https://www.qunar.com/: 140898</span><br><span class="line">https://www.suning.com/: 188523</span><br><span class="line">https://www.taobao.com/: 126283</span><br><span class="line">24.28531312942505</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ‰“å°çš„é¡ºåºæ˜¯å’Œ url åˆ—è¡¨çš„é¡ºåºå®Œå…¨ä¸€è‡´çš„ï¼ŒåŒæ­¥çš„ä»£ç è€—æ—¶çº¦ 24sã€‚</p><h3 id="åŸºäºçº¿ç¨‹çš„è¯·æ±‚">åŸºäºçº¿ç¨‹çš„è¯·æ±‚</h3><p>é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„åº“ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> url <span class="keyword">import</span> urls</span><br></pre></td></tr></table></figure><p>å®Œæˆå•ä¸ªè¯·æ±‚çš„å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    resp = session.get(url)</span><br><span class="line">    <span class="keyword">return</span> resp.content</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çº¿ç¨‹æ± è¯·æ±‚æ‰€æœ‰çš„ urlï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    session = requests.Session()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">        tasks = &#123;executor.submit(fetch, session, url): url <span class="keyword">for</span> url <span class="keyword">in</span> urls&#125;</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> as_completed(tasks.keys()):</span><br><span class="line">            data = task.result()</span><br><span class="line">            print(<span class="string">f'<span class="subst">&#123;tasks[task]&#125;</span>: <span class="subst">&#123;len(data)&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>è®°å½•å®Œæˆæ‰€éœ€çš„æ—¶é—´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    main()</span><br><span class="line">    print(time.time() - start)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">http://www.ccb.com/: 276</span><br><span class="line">http://www.12306.cn/: 1480</span><br><span class="line">http://www.cnki.net/: 59235</span><br><span class="line">http://mail.aliyun.com/: 725</span><br><span class="line">http://www.tianya.cn/: 7867</span><br><span class="line">http://www.icbc.com.cn/icbc/: 157227</span><br><span class="line">http://www.bankcomm.com/: 3473</span><br><span class="line">http://www.chsi.com.cn/: 34188</span><br><span class="line">http://mail.sina.com.cn/: 2837</span><br><span class="line">...</span><br><span class="line">http://www.sina.com.cn/: 584540</span><br><span class="line">https://tieba.baidu.com/: 137714</span><br><span class="line">https://www.autohome.com.cn/: 656154</span><br><span class="line">https://www.taobao.com/: 126283</span><br><span class="line">https://www.booking.com/: 457849</span><br><span class="line">http://www.iqiyi.com/: 599940</span><br><span class="line">http://tuijian.hao123.com/: 511465</span><br><span class="line">9.722297191619873</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿”å›ç»“æœçš„é¡ºåºå¹¶ä¸å’Œ url åˆ—è¡¨ä¸€è‡´ï¼Œå‡†ç¡®çš„è¯´ï¼Œæ˜¯æŒ‰ç…§è¯·æ±‚å®Œæˆçš„é¡ºåºæ’åˆ—çš„ã€‚åŒæ—¶ï¼Œè¯·æ±‚æ‰€éœ€çš„æ—¶é—´å¤§å¹…ç¼©çŸ­ï¼Œé™åˆ°äº†çº¦ 9sã€‚</p><h3 id="åŸºäº-asyncio-çš„è¯·æ±‚">åŸºäº <code>asyncio</code> çš„è¯·æ±‚</h3><p>é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„åº“ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> url <span class="keyword">import</span> urls</span><br></pre></td></tr></table></figure><p>å®Œæˆå•ä¸ªè¯·æ±‚çš„å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">return</span> url, <span class="keyword">await</span> resp.read()</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŒæ—¶è¿”å›äº†è¯·æ±‚çš„ url å’Œç½‘ç«™å†…å®¹ï¼Œæ˜¯å› ä¸ºåé¢çš„ä»£ç ä¸å®¹æ˜“åœ¨è¯·æ±‚å®Œæˆåè·å¾—è¯·æ±‚çš„ urlã€‚</p><p>ä½¿ç”¨ <code>aiohttp</code> è¯·æ±‚æ‰€æœ‰çš„ urlï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = [fetch(session, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> asyncio.as_completed(tasks):</span><br><span class="line">            url, data = <span class="keyword">await</span> task</span><br><span class="line">            print(<span class="string">f'<span class="subst">&#123;url&#125;</span>: <span class="subst">&#123;len(data)&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>å¼€å¯äº‹ä»¶å¾ªç¯ï¼Œå¹¶è®°å½•æ‰€éœ€çš„æ—¶é—´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(main())</span><br><span class="line">    print(time.time() - start)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http://www.psbc.com/: 404</span><br><span class="line">http://www.eastmoney.com/: 392883</span><br><span class="line">http://www.icbc.com.cn/icbc/: 157227</span><br><span class="line">http://www.ifeng.com: 438464</span><br><span class="line">http://mail.aliyun.com/: 725</span><br><span class="line">http://www.tianya.cn/: 7867</span><br><span class="line">...</span><br><span class="line">http://tuijian.hao123.com/: 510052</span><br><span class="line">http://mail.qq.com/: 8023</span><br><span class="line">http://game.hao123.com/: 179707</span><br><span class="line">https://tieba.baidu.com/: 137723</span><br><span class="line">http://www.iqiyi.com/: 599830</span><br><span class="line">https://www.taobao.com/: 126283</span><br><span class="line">https://weibo.com/: 6117</span><br><span class="line">http://www.zhihu.com/: 22696</span><br><span class="line">https://www.booking.com/: 457851</span><br><span class="line">2.0516560077667236</span><br></pre></td></tr></table></figure><p>å’Œä½¿ç”¨çº¿ç¨‹ä¸€æ ·ï¼Œè¿”å›ç»“æœæ˜¯æŒ‰ç…§è¯·æ±‚å®Œæˆé¡ºåºæ’åˆ—çš„ã€‚è¯·æ±‚çš„æ—¶é—´æ¯”çº¿ç¨‹æ›´çŸ­ï¼Œåªç”¨äº†çº¦ 2s å°±å®Œæˆäº†æ‰€æœ‰çš„è¯·æ±‚ã€‚å’Œä½¿ç”¨çº¿ç¨‹çš„æ–¹å¼ç›¸æ¯”ï¼Œ<code>asyncio</code> é¿å…äº†åˆ›å»ºçº¿ç¨‹çš„å¼€é”€ã€‚</p><h4 id="ä¿å­˜è¯·æ±‚çš„ç»“æœ">ä¿å­˜è¯·æ±‚çš„ç»“æœ</h4><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°è¯·æ±‚åªæ˜¯ç®€å•çš„è·å–äº†å†…å®¹ï¼Œè¿™äº› bytes åªåœ¨å†…å­˜ä¸­å­˜åœ¨ã€‚ä¸€æ—¦æˆ‘ä»¬éœ€è¦æŠŠç»“æœä¿å­˜åˆ°ç£ç›˜ï¼Œå°±ä¼šæœ‰å¦ä¸€ä¸ªä¼šå¯¼è‡´å¼‚æ­¥ä»£ç é€€åŒ–åˆ°åŒæ­¥çš„åœ°æ–¹ï¼šç£ç›˜ I / Oã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¢åŠ ä¸€ä¸ªä¿å­˜è¯·æ±‚å†…å®¹åˆ°ç£ç›˜çš„å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote_plus</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_file</span><span class="params">(filename, data)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">f'async_data/<span class="subst">&#123;quote_plus(filename)&#125;</span>.html'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(data)</span><br></pre></td></tr></table></figure><p>åŒæ—¶å¢åŠ ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥åŒæ—¶å‘èµ·è¯·æ±‚å¹¶æŠŠç»“æœä¿å­˜åˆ°æ–‡ä»¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch_and_save</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    url, data = <span class="keyword">await</span> fetch(session, url)</span><br><span class="line">    save_to_file(url, data * <span class="number">500</span>)  <span class="comment"># æŠŠæ–‡ä»¶å¤§å°æ‰©å¤§ 500 å€ï¼Œä½¿ç»“æœæ›´æ˜æ˜¾</span></span><br><span class="line">    <span class="keyword">return</span> url</span><br></pre></td></tr></table></figure><p>åŒæ—¶æ›´æ–°ä¸€ä¸‹ <code>main()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = [fetch_and_save(session, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> asyncio.as_completed(tasks):</span><br><span class="line">            url = <span class="keyword">await</span> task</span><br><span class="line">            print(<span class="string">f'save: <span class="subst">&#123;url&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">save: http://www.psbc.com/</span><br><span class="line">save: http://www.cnki.net/</span><br><span class="line">save: http://www.eastmoney.com/</span><br><span class="line">save: http://tuijian.hao123.com/</span><br><span class="line">save: http://caipiao.hao123.com/</span><br><span class="line">save: http://www.ifeng.com</span><br><span class="line">save: http://www.fang.com/</span><br><span class="line">save: http://www.qq.com/</span><br><span class="line">...</span><br><span class="line">save: https://www.bilibili.com/</span><br><span class="line">save: https://www.autohome.com.cn/</span><br><span class="line">save: https://www.booking.com/</span><br><span class="line">save: https://mail.sohu.com/</span><br><span class="line">save: https://weibo.com/</span><br><span class="line">save: http://mail.qq.com/</span><br><span class="line">save: http://mail.10086.cn/</span><br><span class="line">save: http://www.zhihu.com/</span><br><span class="line">10.63579511642456</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¶ˆè€—çš„æ—¶é—´å¢åŠ åˆ°äº†çº¦ 10sã€‚</p><p>æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å°†åŒæ­¥çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œå˜ä¸ºå¼‚æ­¥çš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ç»“åˆä½¿ç”¨çº¿ç¨‹å’Œ <code>asyncio</code>ã€‚ä¿®æ”¹ä¸€ä¸‹ <code>fetch_and_save()</code> å‡½æ•°ï¼Œä½¿å…¶åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œä¿å­˜æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch_and_save</span><span class="params">(session, url)</span>:</span></span><br><span class="line">    url, data = <span class="keyword">await</span> fetch(session, url)</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_in_executor(<span class="keyword">None</span>, save_to_file, url, data * <span class="number">500</span>)  <span class="comment"># é»˜è®¤ä½¿ç”¨ ThreadPoolExecutor</span></span><br><span class="line">    <span class="keyword">return</span> url</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åçš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">save: http://www.psbc.com/</span><br><span class="line">save: http://www.12306.cn/</span><br><span class="line">save: http://www.ccb.com/</span><br><span class="line">save: http://www.cnki.net/</span><br><span class="line">save: http://www.sohu.com/</span><br><span class="line">save: http://www.37.com/</span><br><span class="line">save: http://www.icbc.com.cn/icbc/</span><br><span class="line">save: http://mail.sina.com.cn/</span><br><span class="line">save: http://www.ifeng.com</span><br><span class="line">...</span><br><span class="line">save: https://mail.qq.com/</span><br><span class="line">save: http://mail.163.com/</span><br><span class="line">save: https://mail.sohu.com/</span><br><span class="line">save: https://weibo.com/</span><br><span class="line">save: http://mail.qq.com/</span><br><span class="line">save: http://mail.10086.cn/</span><br><span class="line">save: http://www.zhihu.com/</span><br><span class="line">save: https://www.booking.com/</span><br><span class="line">4.817075967788696</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¾ˆæ˜æ˜¾ï¼Œæ‰€éœ€çš„æ—¶é—´ç¼©çŸ­åˆ°äº†çº¦ 5sã€‚</p><p><strong>NOTEï¼š</strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸Šå¹¶æœªæä¾›æ–‡ä»¶ç³»ç»Ÿçš„å¼‚æ­¥ I / O æ“ä½œï¼ˆLinux kernel æä¾›äº†æ–‡ä»¶ç³»ç»Ÿå¼‚æ­¥ I / Oï¼Œä¸è¿‡å®ƒéœ€è¦ä¸€ä¸ªé¢å¤–çš„åº“ <a href="http://lse.sourceforge.net/io/aio.html" target="_blank" rel="noopener">aio</a>ï¼‰ï¼Œå¤§éƒ¨åˆ†çš„å¼‚æ­¥æ¡†æ¶éƒ½æ˜¯ä½¿ç”¨çº¿ç¨‹å¤„ç†æ–‡ä»¶ç³»ç»Ÿ I / O çš„ã€‚å¦‚æœéœ€è¦ç»Ÿä¸€çš„ APIï¼Œå¯ä»¥é€‰æ‹© <a href="https://github.com/Tinche/aiofiles/" target="_blank" rel="noopener">aiofiles</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;å‰äº”ç¯‡æ–‡ç« ä»‹ç»äº† &lt;code&gt;asyncio&lt;/code&gt; çš„ APIï¼Œä»è¿™ç¯‡å¼€å§‹ï¼Œå°±è¦è®²ä¸€äº› Real Worldï¼ˆå¹¶ä¸ï¼‰çš„ä¸œè¥¿äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä½¿ç”¨-aiohttp-ä½œä¸º-http-å®¢æˆ·ç«¯&quot;&gt;ä½¿ç”¨ aiohttp
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Lombokçš„ä½¿ç”¨</title>
    <link href="http://weafteam.github.io/posts/3859dc89/"/>
    <id>http://weafteam.github.io/posts/3859dc89/</id>
    <published>2018-05-26T18:04:44.000Z</published>
    <updated>2018-08-08T11:54:45.488Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h1><p>ä½¿ç”¨lombokå‡å°‘ä»£ç å†—ä½™ï¼ˆReducing Boilerplate Code with Project Lombokï¼‰ã€‚â€œBoilerplateâ€æ˜¯ç”¨æ¥æè¿°è®¸å¤šéƒ¨åˆ†é‡å¤çš„ä»£ç çš„æœ¯è¯­ã€‚è¿™ä¹Ÿæ˜¯Javaè¯­è¨€æœ€å¸¸æå‡ºæ‰¹è¯„ä¹‹ä¸€,æ˜¯å¤§å¤šæ•°é¡¹ç›®ä¸­éƒ½å­˜åœ¨æ­¤ç±»ä»£ç è€Œä¸”æ•°é‡å¾ˆå¤šã€‚è¿™ä¸ªé—®é¢˜ç»å¸¸æ˜¯å„ç§åº“ä¸­è®¾è®¡å†³ç­–çš„ç»“æœï¼Œä½†æ˜¯ç”±äºè¯­è¨€æœ¬èº«çš„é™åˆ¶è€Œå¯¼è‡´çš„ã€‚Lombok æ—¨åœ¨é€šè¿‡ä¸€ç»„ç®€å•çš„æ³¨é‡Šå–ä»£è¿™äº›é—®é¢˜ã€‚ è™½ç„¶æ³¨é‡Šç”¨äºæŒ‡ç¤ºç”¨æ³•ï¼Œå®ç°ç»‘å®šç”šè‡³ç”Ÿæˆæ¡†æ¶ä½¿ç”¨çš„ä»£ç å¹¶ä¸ç½•è§ï¼Œä½†å®ƒä»¬é€šå¸¸ä¸ç”¨äºç”Ÿæˆåº”ç”¨ç¨‹åºç›´æ¥ä½¿ç”¨çš„ä»£ç ã€‚ éƒ¨åˆ†åŸå› æ˜¯è¿™æ ·åšéœ€è¦åœ¨å¼€å‘æ—¶æ€¥åˆ‡åœ°å¤„ç†æ³¨é‡Šã€‚ Lombokæ­£æ˜¯è¿™æ ·åšçš„ã€‚ é€šè¿‡é›†æˆåˆ°IDEä¸­ï¼ŒProject Lombokèƒ½å¤Ÿæ³¨å…¥å¼€å‘äººå‘˜å¯ç«‹å³ä½¿ç”¨çš„ä»£ç ã€‚ ä¾‹å¦‚ï¼Œç®€å•åœ°å°†@Dataæ³¨é‡Šæ·»åŠ åˆ°æ•°æ®ç±»ï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰ä¼šåœ¨IDEä¸­ç”Ÿæˆè®¸å¤šæ–°æ–¹æ³•ï¼š</p><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/lombok-1.png" alt="lombok-1"> äºŒã€å®‰è£… ======= 1.eclipseå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å®‰è£… â€”â€”â€”â€”â€“ ### 1) ä¸‹è½½lombok.jaråŒ…https://projectlombok.org/download.html</p><h3 id="è¿è¡Œlombok.jar-java--jar-d.jar-d.jarè¿™æ˜¯windowsä¸‹lombok.jaræ‰€åœ¨çš„ä½ç½®">2) è¿è¡ŒLombok.jar: Java -jar D:.jar D:.jarè¿™æ˜¯windowsä¸‹lombok.jaræ‰€åœ¨çš„ä½ç½®</h3><pre><code>æ•°ç§’åå°†å¼¹å‡ºä¸€æ¡†ï¼Œä»¥ç¡®è®¤eclipseçš„å®‰è£…è·¯å¾„</code></pre><h3 id="ç¡®è®¤å®Œeclipseçš„å®‰è£…è·¯å¾„åç‚¹å‡»installupdateæŒ‰é’®å³å¯å®‰è£…å®Œæˆ">3) ç¡®è®¤å®Œeclipseçš„å®‰è£…è·¯å¾„åï¼Œç‚¹å‡»install/updateæŒ‰é’®ï¼Œå³å¯å®‰è£…å®Œæˆ</h3><h3 id="å®‰è£…å®Œæˆä¹‹åè¯·ç¡®è®¤eclipseå®‰è£…è·¯å¾„ä¸‹æ˜¯å¦å¤šäº†ä¸€ä¸ªlombok.jaråŒ…å¹¶ä¸”å…¶">4) å®‰è£…å®Œæˆä¹‹åï¼Œè¯·ç¡®è®¤eclipseå®‰è£…è·¯å¾„ä¸‹æ˜¯å¦å¤šäº†ä¸€ä¸ªlombok.jaråŒ…ï¼Œå¹¶ä¸”å…¶</h3><pre><code>é…ç½®æ–‡ä»¶eclipse.iniä¸­æ˜¯å¦ æ·»åŠ äº†å¦‚ä¸‹å†…å®¹:    -javaagent:lombok.jar    -Xbootclasspath/a:lombok.jarå¦‚æœä¸Šé¢çš„ç­”æ¡ˆå‡ä¸ºtrueï¼Œé‚£ä¹ˆæ­å–œä½ å·²ç»å®‰è£…æˆåŠŸï¼Œå¦åˆ™å°†ç¼ºå°‘çš„éƒ¨åˆ†æ·»åŠ åˆ°ç›¸åº”çš„ä½ç½®å³å¯</code></pre><h3 id="é‡å¯eclipseæˆ–myeclipse">5) é‡å¯eclipseæˆ–myeclipse</h3><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/lombok-2.png" alt="lombok-2"> 2.IntelliJ IDEAå®‰è£… â€”â€”â€” ### 1ï¼‰æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰“å¼€è®¾ç½®Settingså®‰è£… <img src="https://weaf.oss-cn-beijing.aliyuncs.com/lombok-3.png" alt="lombok-3"> ### 2ï¼‰å®‰è£…åé‡å¯</p><h2 id="æœ€åéœ€è¦åœ¨é¡¹ç›®ä¸­å¼•å…¥jaråŒ…æˆ–è€…ä½¿ç”¨mavené…ç½®å¥½åæ ‡">3.æœ€åéœ€è¦åœ¨é¡¹ç›®ä¸­å¼•å…¥jaråŒ…æˆ–è€…ï¼Œä½¿ç”¨mavené…ç½®å¥½åæ ‡ã€‚</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.9.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line">&lt;repositories&gt;</span><br><span class="line">    &lt;repository&gt;</span><br><span class="line">        &lt;id&gt;projectlombok.org&lt;/id&gt;</span><br><span class="line">        &lt;url&gt;http://projectlombok.org/mavenrepo&lt;/url&gt;</span><br><span class="line">    &lt;/repository&gt;</span><br><span class="line">&lt;/repositories&gt;</span><br></pre></td></tr></table></figure><h1 id="ä¸‰lombokçš„æ³¨è§£æœ‰å“ªäº›">ä¸‰ã€Lombokçš„æ³¨è§£æœ‰å“ªäº›</h1><ol type="1"><li><span class="citation" data-cites="Getter">@Getter</span></li><li><span class="citation" data-cites="Setter">@Setter</span></li><li><span class="citation" data-cites="Data">@Data</span></li><li><span class="citation" data-cites="NonNull">@NonNull</span></li><li><span class="citation" data-cites="ToString">@ToString</span></li><li><span class="citation" data-cites="EqualsAndHashCode">@EqualsAndHashCode</span></li><li><span class="citation" data-cites="Cleanup">@Cleanup</span></li><li><span class="citation" data-cites="Synchronized">@Synchronized</span></li><li><span class="citation" data-cites="SneakyThrows">@SneakyThrows</span></li><li><span class="citation" data-cites="AllArgsConstructor">@AllArgsConstructor</span></li><li><span class="citation" data-cites="Builder">@Builder</span></li><li><span class="citation" data-cites="Generated">@Generated</span></li><li><span class="citation" data-cites="NoArgsConstructor">@NoArgsConstructor</span></li><li><span class="citation" data-cites="RequiredArgsConstructor">@RequiredArgsConstructor</span></li><li><span class="citation" data-cites="Singular">@Singular</span></li><li><span class="citation" data-cites="val">@val</span></li><li><span class="citation" data-cites="var">@var</span></li><li><span class="citation" data-cites="Value">@Value</span></li><li><span class="citation" data-cites="FieldNameConstants">@FieldNameConstants</span></li><li><span class="citation" data-cites="Log">@Log</span>, <span class="citation" data-cites="Log4j">@Log4j</span>, <span class="citation" data-cites="Log4j2">@Log4j2</span>, <span class="citation" data-cites="Slf4j">@Slf4j</span>, <span class="citation" data-cites="XSlf4j">@XSlf4j</span>, <span class="citation" data-cites="CommonsLog">@CommonsLog</span>, <span class="citation" data-cites="JBossLog">@JBossLog</span>, <span class="citation" data-cites="Flogger">@Flogger</span></li><li><span class="citation" data-cites="Delegate">@Delegate</span></li><li><span class="citation" data-cites="Wither">@Wither</span></li></ol><h1 id="å››lombokæ³¨è§£çš„ä½¿ç”¨">å››ã€Lombokæ³¨è§£çš„ä½¿ç”¨</h1><h2 id="getter">1 <span class="citation" data-cites="Getter">@Getter</span></h2><p>ç”Ÿæˆç›¸åº”çš„getæ–¹æ³•,å…¶ä¸­booleanç±»å‹ä¼šç”Ÿæˆ isFoo(); å¹¶ä¸”å¯ä»¥é…åˆAccessLevelä½¿ç”¨</p><h2 id="setter">2 <span class="citation" data-cites="Setter">@Setter</span></h2><p>ç”Ÿæˆç›¸åº”çš„setæ–¹æ³•,å…¶ä¸­booleanç±»å‹ä¼šç”Ÿäº§ setFoo();</p><h2 id="data">3 <span class="citation" data-cites="Data">@Data</span></h2><p>ç”Ÿæˆgetã€setã€toStringã€equalsã€hashCodeç­‰æ–¹æ³•ã€‚</p><h2 id="nonnull">4 <span class="citation" data-cites="NonNull">@NonNull</span></h2><p>å¯ä»¥å†æ–¹æ³•å¼•ç”¨ã€å’Œä¼ å‚æ—¶å¦‚æœå€¼ä¸ºnull,æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><h2 id="tostring">5 <span class="citation" data-cites="ToString">@ToString</span></h2><p>ç”ŸæˆtoStringæ–¹æ³•</p><h2 id="equalsandhashcode">6 <span class="citation" data-cites="EqualsAndHashCode">@EqualsAndHashCode</span></h2><p>ç”Ÿæˆequalså’ŒhashCodeæ–¹æ³•</p><h2 id="cleanup">7 <span class="citation" data-cites="Cleanup">@Cleanup</span></h2><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/lombok-4.png" alt="lombok-4"></p><p>å‚è€ƒåœ°å€ï¼š<a href="http://jnb.ociweb.com/jnb/jnbJan2010.html" class="uri" target="_blank" rel="noopener">http://jnb.ociweb.com/jnb/jnbJan2010.html</a></p>]]></content>
    
    <summary type="html">
    
      Lombokçš„ä½¿ç”¨
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>Springä¸­@transactionalçš„ä½¿ç”¨</title>
    <link href="http://weafteam.github.io/posts/435ecce8/"/>
    <id>http://weafteam.github.io/posts/435ecce8/</id>
    <published>2018-05-20T18:04:44.000Z</published>
    <updated>2018-08-07T08:56:41.651Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h1><p>æˆ‘ä»¬åœ¨å·¥ä½œä¸­å¤šå¤šå°‘å°‘ä¼šä½¿ç”¨åˆ°å’Œäº‹åŠ¡ç›¸å…³çš„ï¼Œä½†æ˜¯ç¨‹åºè¿è¡Œæ€»ä¸ä¼šä¸€å®šä¸å‡ºç°ä»»ä½•å¼‚å¸¸ã€‚ä¸€æ—¦æ•´ä¸ªæµç¨‹ä¸­å‡ºç°ä¸€ä¸ªå¼‚å¸¸ï¼Œä¹Ÿè®¸æˆ‘ä»¬å°±éœ€è¦æ•´ä¸ªæ“ä½œä¸ç»§ç»­è¿›è¡Œä¸‹å»ï¼Œå¹¶ä¸”éœ€è¦ä¹‹å‰åšè¿‡çš„æ“ä½œéƒ½ä¸èµ·ä½œç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨äº‹åŠ¡æ¥æ§åˆ¶ã€‚</p><p>åœ¨Springä¸­ï¼Œæˆ‘ä»¬é€šè¿‡@transactionalæ¥å¯ç”¨äº‹åŠ¡ã€‚</p><h1 id="äºŒtransactionalè¯¦è§£">äºŒã€<span class="citation" data-cites="transactionalè¯¦è§£">@transactionalè¯¦è§£</span></h1><h3 id="transactionalæ³¨è§£ä¸­å¸¸ç”¨å‚æ•°è¯´æ˜"><span class="citation" data-cites="Transactionalæ³¨è§£ä¸­å¸¸ç”¨å‚æ•°è¯´æ˜">@Transactionalæ³¨è§£ä¸­å¸¸ç”¨å‚æ•°è¯´æ˜</span></h3><table><colgroup><col style="width: 50%"><col style="width: 50%"></colgroup><thead><tr class="header"><th>å‚æ•°åç§°</th><th>æè¿°</th></tr></thead><tbody><tr class="odd"><td>rollbackFor</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(rollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(rollbackFor={RuntimeException.class, Exception.class})</td></tr><tr class="even"><td>rollbackForClassName</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(rollbackForClassName=â€œRuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(rollbackForClassName={â€œRuntimeExceptionâ€,â€œExceptionâ€})</td></tr><tr class="odd"><td>noRollbackFor</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(noRollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(noRollbackFor={RuntimeException.class, Exception.class})</td></tr><tr class="even"><td>noRollbackForClassName</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(noRollbackForClassName=â€œRuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(noRollbackForClassName={â€œRuntimeExceptionâ€,â€œExceptionâ€})</td></tr><tr class="odd"><td>propagation</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼Œå…·ä½“å–å€¼å¯å‚è€ƒè¡¨6-7ã€‚ä¾‹å¦‚ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(propagation=Propagation.NOT_SUPPORTED,readOnly=true)</td></tr><tr class="even"><td>isolation</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®åº•å±‚æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«ç”¨äºå¤„ç†å¤šäº‹åŠ¡å¹¶å‘çš„æƒ…å†µï¼Œé€šå¸¸ä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«å³å¯ï¼ŒåŸºæœ¬ä¸éœ€è¦è¿›è¡Œè®¾ç½®</td></tr><tr class="odd"><td>timeout</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®äº‹åŠ¡çš„è¶…æ—¶ç§’æ•°ï¼Œé»˜è®¤å€¼ä¸º-1è¡¨ç¤ºæ°¸ä¸è¶…æ—¶</td></tr><tr class="even"><td>readOnly</td><td>è¯¥å±æ€§ç”¨äºè®¾ç½®å½“å‰äº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡ï¼Œè®¾ç½®ä¸ºtrueè¡¨ç¤ºåªè¯»ï¼Œfalseåˆ™è¡¨ç¤ºå¯è¯»å†™ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚ä¾‹å¦‚ï¼š<span class="citation" data-cites="Transactional">@Transactional</span>(readOnly=true)</td></tr></tbody></table><h3 id="äº‹ç‰©ä¼ æ’­è¡Œä¸ºä»‹ç»">äº‹ç‰©ä¼ æ’­è¡Œä¸ºä»‹ç»:</h3><ul><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(propagation=Propagation.REQUIRED)</strong> ï¼šå¦‚æœæœ‰äº‹åŠ¡, é‚£ä¹ˆåŠ å…¥äº‹åŠ¡, æ²¡æœ‰çš„è¯æ–°å»ºä¸€ä¸ª(é»˜è®¤æƒ…å†µä¸‹)</li><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(propagation=Propagation.NOT_SUPPORTED)</strong> ï¼šå®¹å™¨ä¸ä¸ºè¿™ä¸ªæ–¹æ³•å¼€å¯äº‹åŠ¡</li><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(propagation=Propagation.REQUIRES_NEW)</strong> ï¼šä¸ç®¡æ˜¯å¦å­˜åœ¨äº‹åŠ¡,éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡,åŸæ¥çš„æŒ‚èµ·,æ–°çš„æ‰§è¡Œå®Œæ¯•,ç»§ç»­æ‰§è¡Œè€çš„äº‹åŠ¡</li><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(propagation=Propagation.MANDATORY)</strong> ï¼šå¿…é¡»åœ¨ä¸€ä¸ªå·²æœ‰çš„äº‹åŠ¡ä¸­æ‰§è¡Œ,å¦åˆ™æŠ›å‡ºå¼‚å¸¸</li><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(propagation=Propagation.NEVER)</strong> ï¼šå¿…é¡»åœ¨ä¸€ä¸ªæ²¡æœ‰çš„äº‹åŠ¡ä¸­æ‰§è¡Œ,å¦åˆ™æŠ›å‡ºå¼‚å¸¸(ä¸Propagation.MANDATORYç›¸å)</li><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(propagation=Propagation.SUPPORTS)</strong> ï¼šå¦‚æœå…¶ä»–beanè°ƒç”¨è¿™ä¸ªæ–¹æ³•,åœ¨å…¶ä»–beanä¸­å£°æ˜äº‹åŠ¡,é‚£å°±ç”¨äº‹åŠ¡.å¦‚æœå…¶ä»–beanæ²¡æœ‰å£°æ˜äº‹åŠ¡,é‚£å°±ä¸ç”¨äº‹åŠ¡.</li></ul><h3 id="äº‹ç‰©è¶…æ—¶è®¾ç½®">äº‹ç‰©è¶…æ—¶è®¾ç½®:</h3><ul><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(timeout=30)</strong> //é»˜è®¤æ˜¯30ç§’</li></ul><h3 id="äº‹åŠ¡éš”ç¦»çº§åˆ«">äº‹åŠ¡éš”ç¦»çº§åˆ«:</h3><ul><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(isolation = Isolation.READ_UNCOMMITTED)</strong>ï¼šè¯»å–æœªæäº¤æ•°æ®(ä¼šå‡ºç°è„è¯», ä¸å¯é‡å¤è¯») åŸºæœ¬ä¸ä½¿ç”¨</li><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(isolation = Isolation.READ_COMMITTED)</strong>ï¼šè¯»å–å·²æäº¤æ•°æ®(ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»)</li><li><strong><span class="citation" data-cites="Transactional">@Transactional</span>(isolation = Isolation.REPEATABLE_READ)</strong>ï¼šå¯é‡å¤è¯»(ä¼šå‡ºç°å¹»è¯»)</li><li><p><strong><span class="citation" data-cites="Transactional">@Transactional</span>(isolation = Isolation.SERIALIZABLE)</strong>ï¼šä¸²è¡ŒåŒ–</p></li><li>MYSQL: é»˜è®¤ä¸ºREPEATABLE_READçº§åˆ«</li><li><p>SQLSERVER: é»˜è®¤ä¸ºREAD_COMMITTED</p></li><li><strong>è„è¯»</strong> : ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°å¦ä¸€äº‹åŠ¡æœªæäº¤çš„æ›´æ–°æ•°æ®</li><li><strong>ä¸å¯é‡å¤è¯»</strong> : åœ¨åŒä¸€äº‹åŠ¡ä¸­, å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®è¿”å›çš„ç»“æœæœ‰æ‰€ä¸åŒ, æ¢å¥è¯è¯´, åç»­è¯»å–å¯ä»¥è¯»åˆ°å¦ä¸€äº‹åŠ¡å·²æäº¤çš„æ›´æ–°æ•°æ®. ç›¸å, â€œå¯é‡å¤è¯»â€åœ¨åŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡ è¯»å–æ•°æ®æ—¶, èƒ½å¤Ÿä¿è¯æ‰€è¯»æ•°æ®ä¸€æ ·, ä¹Ÿå°±æ˜¯åç»­è¯»å–ä¸èƒ½è¯»åˆ°å¦ä¸€äº‹åŠ¡å·²æäº¤çš„æ›´æ–°æ•°æ®</li><li><p><strong>å¹»è¯»</strong> : ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å·²æäº¤çš„insertæ•°æ®</p></li></ul><h1 id="ä¸‰ç‰¹åˆ«éœ€è¦æ³¨æ„çš„å‡ ç‚¹">ä¸‰ã€ç‰¹åˆ«éœ€è¦æ³¨æ„çš„å‡ ç‚¹</h1><ol type="1"><li>spring äº‹åŠ¡ç®¡ç†å™¨,ç”±springæ¥è´Ÿè´£æ•°æ®åº“çš„æ‰“å¼€,æäº¤,å›æ»š.é»˜è®¤é‡åˆ°è¿è¡ŒæœŸä¾‹å¤–(throw new RuntimeException(â€œæ³¨é‡Šâ€);)ä¼šå›æ»šï¼Œå³é‡åˆ°ä¸å—æ£€æŸ¥ï¼ˆuncheckedï¼‰çš„ä¾‹å¤–æ—¶å›æ»šï¼›è€Œé‡åˆ°éœ€è¦æ•è·çš„ä¾‹å¤–(throw new Exception(â€œæ³¨é‡Šâ€);)ä¸ä¼šå›æ»š,å³é‡åˆ°å—æ£€æŸ¥çš„ä¾‹å¤–ï¼ˆå°±æ˜¯éè¿è¡Œæ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥åˆ°çš„å¼‚å¸¸å«å—æ£€æŸ¥ä¾‹å¤–æˆ–è¯´å—æ£€æŸ¥å¼‚å¸¸ï¼‰æ—¶ï¼Œéœ€æˆ‘ä»¬æŒ‡å®šæ–¹å¼æ¥è®©äº‹åŠ¡å›æ»šè¦æƒ³æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š,è¦åŠ ä¸Š <span class="citation" data-cites="Transactional">@Transactional</span>( rollbackFor={Exception.class,å…¶å®ƒå¼‚å¸¸}) .å¦‚æœè®©uncheckedä¾‹å¤–ä¸å›æ»š</li><li><span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£åº”è¯¥åªè¢«åº”ç”¨åˆ° public å¯è§åº¦çš„æ–¹æ³•ä¸Šã€‚ å¦‚æœä½ åœ¨ protectedã€private æˆ–è€… package-visible çš„æ–¹æ³•ä¸Šä½¿ç”¨ <span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£ï¼Œå®ƒä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œ ä½†æ˜¯è¿™ä¸ªè¢«æ³¨è§£çš„æ–¹æ³•å°†ä¸ä¼šå±•ç¤ºå·²é…ç½®çš„äº‹åŠ¡è®¾ç½®ã€‚</li><li><span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£å¯ä»¥è¢«åº”ç”¨äºæ¥å£å®šä¹‰å’Œæ¥å£æ–¹æ³•ã€ç±»å®šä¹‰å’Œç±»çš„ public æ–¹æ³•ä¸Šã€‚ç„¶è€Œï¼Œè¯·æ³¨æ„ä»…ä»… <span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£çš„å‡ºç°ä¸è¶³äºå¼€å¯äº‹åŠ¡è¡Œä¸ºï¼Œå®ƒä»…ä»… æ˜¯ä¸€ç§å…ƒæ•°æ®ï¼Œèƒ½å¤Ÿè¢«å¯ä»¥è¯†åˆ« <span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£å’Œä¸Šè¿°çš„é…ç½®é€‚å½“çš„å…·æœ‰äº‹åŠ¡è¡Œä¸ºçš„beansæ‰€ä½¿ç”¨ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå…¶å®æ­£æ˜¯ å…ƒç´ çš„å‡ºç° å¼€å¯ äº†äº‹åŠ¡è¡Œä¸ºã€‚</li><li>Springå›¢é˜Ÿçš„å»ºè®®æ˜¯ä½ åœ¨å…·ä½“çš„ç±»ï¼ˆæˆ–ç±»çš„æ–¹æ³•ï¼‰ä¸Šä½¿ç”¨ <span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£ï¼Œè€Œä¸è¦ä½¿ç”¨åœ¨ç±»æ‰€è¦å®ç°çš„ä»»ä½•æ¥å£ä¸Šã€‚ä½ å½“ç„¶å¯ä»¥åœ¨æ¥å£ä¸Šä½¿ç”¨ <span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£ï¼Œä½†æ˜¯è¿™å°†åªèƒ½å½“ä½ è®¾ç½®äº†åŸºäºæ¥å£çš„ä»£ç†æ—¶å®ƒæ‰ç”Ÿæ•ˆã€‚å› ä¸ºæ³¨è§£æ˜¯ä¸èƒ½ç»§æ‰¿çš„ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœä½ æ­£åœ¨ä½¿ç”¨åŸºäºç±»çš„ä»£ç†æ—¶ï¼Œé‚£ä¹ˆäº‹åŠ¡çš„è®¾ç½®å°†ä¸èƒ½è¢«åŸºäºç±»çš„ä»£ç†æ‰€è¯†åˆ«ï¼Œè€Œä¸”å¯¹è±¡ä¹Ÿå°†ä¸ä¼šè¢«äº‹åŠ¡ä»£ç†æ‰€åŒ…è£…ï¼ˆå°†è¢«ç¡®è®¤ä¸ºä¸¥é‡çš„ï¼‰ã€‚å› æ­¤ï¼Œè¯·æ¥å—Springå›¢é˜Ÿçš„å»ºè®®å¹¶ä¸”åœ¨å…·ä½“çš„ç±»ä¸Šä½¿ç”¨ <span class="citation" data-cites="Transactional">@Transactional</span> æ³¨è§£ã€‚</li><li>å¦‚æœå¼‚å¸¸è¢«tryï½›ï½catchï½›ï½äº†ï¼Œäº‹åŠ¡å°±ä¸å›æ»šäº†ï¼Œå¦‚æœæƒ³è®©äº‹åŠ¡å›æ»šå¿…é¡»å†å¾€å¤–æŠ›tryï½›ï½catchï½›throw Exceptionï½ã€‚</li><li>ä½¿ç”¨äº†@Transactionalçš„æ–¹æ³•ï¼Œå¯¹åŒä¸€ä¸ªç±»é‡Œé¢çš„æ–¹æ³•è°ƒç”¨ï¼Œ <span class="citation" data-cites="Transactionalæ— æ•ˆ">@Transactionalæ— æ•ˆ</span>ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªç±»Testï¼Œå®ƒçš„ä¸€ä¸ªæ–¹æ³•Aï¼ŒAå†è°ƒç”¨Testæœ¬ç±»çš„æ–¹æ³•Bï¼ˆä¸ç®¡Bæ˜¯å¦publicè¿˜æ˜¯privateï¼‰ï¼Œä½†Aæ²¡æœ‰å£°æ˜æ³¨è§£äº‹åŠ¡ï¼Œè€ŒBæœ‰ã€‚åˆ™å¤–éƒ¨è°ƒç”¨Aä¹‹åï¼ŒBçš„äº‹åŠ¡æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„ã€‚ï¼ˆç»å¸¸åœ¨è¿™é‡Œå‡ºé”™ï¼‰</li><li>æ”¾åœ¨æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼šè¦†ç›–ç±»ä¸Šè¾¹çš„æ³¨è§£çš„å‚æ•°å±æ€§ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      Springä¸­@transactionalçš„ä½¿ç”¨
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>chapter-10-AIR</title>
    <link href="http://weafteam.github.io/posts/78b2bf24/"/>
    <id>http://weafteam.github.io/posts/78b2bf24/</id>
    <published>2018-05-20T11:52:00.000Z</published>
    <updated>2018-05-29T03:28:39.852Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-svm">TensorFlow SVM</h1><ol type="1"><li>ç®€å•çš„ä»‹ç»ä¸€ä¸‹Support Vector Machineï¼ŒSVMæ˜¯ä¸€ä¸ªäºŒåˆ†ç±»æœºå™¨å­¦ä¹ ç®—æ³•ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†è®©ä¸¤ç±»ä¹‹é—´çš„marginæ›´å¤§ï¼ŒSVMè¿˜å¯ä»¥å®ç°å¤šåˆ†ç±»ä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦æ‰©å±•éçº¿æ€§kernelsè¿›å»ï¼Œæ¥ä¸‹æ¥é€æ¸ä»‹ç»SVM</li><li>å’Œçº¿æ€§å›å½’ä¸€èµ·å·¥ä½œçš„SVM,ä½¿ç”¨å¾—æ•°æ®æ˜¯IRISæ•°æ®é›†ï¼Œå–ä¸¤ä¸ªç‰¹å¾ç»´åº¦ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">importimport  matplotlib.pyplotmatplot  <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line">iris = datasets.load_iris()</span><br><span class="line">x_vals = np.array([[x[<span class="number">0</span>], x[<span class="number">3</span>]] <span class="keyword">for</span> x <span class="keyword">in</span> iris.data])</span><br><span class="line">y_vals = np.array([<span class="number">1</span> <span class="keyword">if</span> y == <span class="number">0</span> <span class="keyword">else</span> <span class="number">-1</span> <span class="keyword">for</span> y <span class="keyword">in</span> iris.target])</span><br><span class="line"></span><br><span class="line">train_indices = np.random.choice(len(x_vals),</span><br><span class="line">                                 round(len(x_vals)*<span class="number">0.8</span>),</span><br><span class="line">                                 replace=<span class="keyword">False</span>)</span><br><span class="line">test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))</span><br><span class="line">x_vals_train = x_vals[train_indices]</span><br><span class="line">x_vals_test = x_vals[test_indices]</span><br><span class="line">y_vals_train = y_vals[train_indices]</span><br><span class="line">y_vals_test = y_vals[test_indices]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">2</span>], dtype=tf.float32)</span><br><span class="line">y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A = tf.Variable(tf.random_normal(shape=[<span class="number">2</span>, <span class="number">1</span>]))</span><br><span class="line">b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model_output = tf.subtract(tf.matmul(x_data, A), b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l2_norm = tf.reduce_sum(tf.square(A))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prediction = tf.sign(model_output)</span><br><span class="line">accuracy = tf.reduce_mean(tf.cast(tf.equal(prediction, y_target), tf.float32))</span><br><span class="line"></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.01</span>)</span><br><span class="line">train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line">loss_vec = []</span><br><span class="line">train_accuracy = []</span><br><span class="line">test_accuracy = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">500</span>):</span><br><span class="line">    rand_index = np.random.choice(len(x_vals_train), size=batch_size)</span><br><span class="line">    rand_x = x_vals_train[rand_index]</span><br><span class="line">    rand_y = np.transpose([y_vals_train[rand_index]])</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line"></span><br><span class="line">    temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    loss_vec.append(temp_loss)</span><br><span class="line"></span><br><span class="line">    train_acc_temp = sess.run(accuracy, feed_dict=&#123;</span><br><span class="line">        x_data: x_vals_train,</span><br><span class="line">        y_target: np.transpose([y_vals_train])&#125;)</span><br><span class="line">    train_accuracy.append(train_acc_temp)</span><br><span class="line"></span><br><span class="line">    test_acc_temp = sess.run(accuracy, feed_dict=&#123;</span><br><span class="line">        x_data: x_vals_test,</span><br><span class="line">        y_target: np.transpose([y_vals_test])&#125;)</span><br><span class="line">    test_accuracy.append(test_acc_temp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #&#123;&#125; A = &#123;&#125;, b = &#123;&#125;'</span>.format(</span><br><span class="line">            str(i+<span class="number">1</span>),</span><br><span class="line">            str(sess.run(A)),</span><br><span class="line">            str(sess.run(b))</span><br><span class="line">        ))</span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(temp_loss))</span><br><span class="line">        </span><br><span class="line">[[a1], [a2]] = sess.run(A)</span><br><span class="line">[[b]] = sess.run(b)</span><br><span class="line">slope = -a2/a1</span><br><span class="line">y_intercept = b/a1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x1_vals = [d[<span class="number">1</span>] <span class="keyword">for</span> d <span class="keyword">in</span> x_vals]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">best_fit = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> x1_vals:</span><br><span class="line">    best_fit.append(slope*i+y_intercept)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setosa_x = [d[<span class="number">1</span>] <span class="keyword">for</span> i, d <span class="keyword">in</span> enumerate(x_vals) <span class="keyword">if</span> y_vals[i] == <span class="number">1</span>]</span><br><span class="line">setosa_y = [d[<span class="number">0</span>] <span class="keyword">for</span> i, d <span class="keyword">in</span> enumerate(x_vals) <span class="keyword">if</span> y_vals[i] == <span class="number">1</span>]</span><br><span class="line">not_setosa_x = [d[<span class="number">1</span>] <span class="keyword">for</span> i, d <span class="keyword">in</span> enumerate(x_vals) <span class="keyword">if</span> y_vals[i] == <span class="number">-1</span>]</span><br><span class="line">not_setosa_y = [d[<span class="number">0</span>] <span class="keyword">for</span> i, d <span class="keyword">in</span> enumerate(x_vals) <span class="keyword">if</span> y_vals[i] == <span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plt.plot(setosa_x, setosa_y, <span class="string">'o'</span>, label=<span class="string">'I. setosa'</span>)</span><br><span class="line">plt.plot(not_setosa_x, not_setosa_y, <span class="string">'x'</span>, label=<span class="string">'Non-setosa'</span>)</span><br><span class="line">plt.plot(x1_vals, best_fit, <span class="string">'r-'</span>, label=<span class="string">'Linear Separator'</span>, linewidth=<span class="number">3</span>)</span><br><span class="line">plt.ylim([<span class="number">0</span>, <span class="number">10</span>])</span><br><span class="line">plt.legend(loc=<span class="string">'lower right'</span>)</span><br><span class="line">plt.title(<span class="string">'Sepal Length vs Pedal Width'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'Pedal Width'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Sepal Length'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">plt.plot(train_accuracy, <span class="string">'k-'</span>, label=<span class="string">'Training Accuracy'</span>)</span><br><span class="line">plt.plot(test_accuracy, <span class="string">'r--'</span>, label=<span class="string">'Test Accuracy'</span>)</span><br><span class="line">plt.title(<span class="string">'Train and Test Set Accuracies'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Accuracy'</span>)</span><br><span class="line">plt.legend(loc=<span class="string">'lower right'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">plt.plot(loss_vec, <span class="string">'k-'</span>)</span><br><span class="line">plt.title(<span class="string">'Loss per Generation'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Loss'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p>åˆæ¢SVM å¤§å®¶ä¸€å®šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œæˆ‘åªä»‹ç»åœ¨tensorflowä¸‹é¢çš„ä¸€äº›å®ç°ï¼Œä¸å«åŸç†ï¼ŒåŸç†å¤§å®¶å¯ä»¥åœ¨ç½‘ä¸Šæ‰¾ä¸€äº›èµ„æ–™äº†è§£ã€‚é‚®ç®±air@weaf.topã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-svm&quot;&gt;TensorFlow SVM&lt;/h1&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;ç®€å•çš„ä»‹ç»ä¸€ä¸‹Support Vector
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>chapter-09-AIR</title>
    <link href="http://weafteam.github.io/posts/befe0ef0/"/>
    <id>http://weafteam.github.io/posts/befe0ef0/</id>
    <published>2018-05-20T11:31:09.000Z</published>
    <updated>2018-05-29T01:27:49.900Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-logistic-regression">TensorFlow Logistic Regression</h1><p>è¿˜æ˜¯å¾—å…ˆå’Œå¤§å®¶å¼€ä¸ªå¤´ï¼Œæˆ‘æœ€è¿‘æœ‰ç‚¹å¿™ï¼Œæ‰€ä»¥æœ‰æ—¶å€™éœ€è¦æŠ½å¼€æ—¶é—´è¡¥ä¸Šæ‹‰ä¸‹çš„åšå®¢ï¼Œè¿™æ˜¯æˆ‘2018å¹´5æœˆ20å·è¡¥5æœˆä¸ƒå·é‚£ä¸ªæœˆçš„åšå®¢ï¼Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹é€»è¾‘å›å½’çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯ç›¸å¯¹äºçº¿æ€§å›å½’ï¼Œå…¶å®é€»è¾‘å›å½’å°±æ˜¯ä¸€ä¸ªåˆ†ç±»é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œä¹Ÿå°±æ˜¯æœ€åå°†å€¼å¾—åˆ†å¸ƒç¡®å®šåœ¨å‡ ç±»å½“ä¸­ï¼Œå°±åƒæˆ‘ä»¬æœ€å¼€å§‹åœ¨åšå®¢ä¸€å¼€å§‹å­¦ä¹ å¾—fashion mnistä¸€æ ·ï¼Œåªä¸è¿‡ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾æ¥ä¸€ä¸ªï¼Œç®€å•å¾—äºŒåˆ†ç±»é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯ï¼š <span class="math display">\[y=sigmoid(A*x+b)\]</span> æœ€åæˆ‘ä»¬å¾—åˆ°å¾—yçš„é¢„æµ‹å€¼éƒ½ä¼šæ˜¯0ï¼Œæˆ–è€…æ˜¯1ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®æ˜¯githubçš„ä¸€ä¸ªæ•°æ®ï¼š</p><ol type="1"><li>æ­£å¼å¼€å§‹ä»£ç çš„ç¼–å†™ï¼Œå…¶å®å¾ˆç®€å•ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šé¢ä¸€å¦‚æ—¢å¾€çš„æ¨¡å—å¯¼å…¥</span></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæˆ‘ä»¬çš„ä¼šè¯</span></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®çš„æ–‡ä»¶å</span></span><br><span class="line">birth_weight_file = <span class="string">'birth_weight.csv'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æ•°æ®</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(birth_weight_file):</span><br><span class="line">    </span><br><span class="line">    birthdata_url = <span class="string">'https://github.com/nfmcclure/tensorflow_cookbook/'</span> + \</span><br><span class="line">    <span class="string">'raw/master/01_Introduction/07_Working_with_Data_Sources/birthweight_data/birthweight.dat'</span></span><br><span class="line">    birth_file = requests.get(birthdata_url)</span><br><span class="line">    birth_data = birth_file.text.split(<span class="string">'\r\n'</span>)</span><br><span class="line">    birth_header = birth_data[<span class="number">0</span>].split(<span class="string">'\t'</span>)</span><br><span class="line">    birth_data = [[float(x) <span class="keyword">for</span> x <span class="keyword">in</span> y.split(<span class="string">'\t'</span>) <span class="keyword">if</span> len(x)&gt;=<span class="number">1</span>] <span class="keyword">for</span> y <span class="keyword">in</span> birth_data[<span class="number">1</span>:] <span class="keyword">if</span> len(y)&gt;=<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> open(birth_weight_file, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        writer = csv.writer(f)</span><br><span class="line">        writer.writerow(birth_header)</span><br><span class="line">        writer.writerows(birth_data)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–æ•°æ®ï¼Œå°±åƒæˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œè¦æ”¾åœ¨placeholderå¾—æ•°æ®æ˜¯è¦åŠ è½½åœ¨æ•°ç»„é‡Œé¢å¾—</span></span><br><span class="line">birth_data = []</span><br><span class="line"><span class="keyword">with</span> open(birth_weight_file, newline=<span class="string">''</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">     csv_reader = csv.reader(csvfile)</span><br><span class="line">     birth_header = next(csv_reader)</span><br><span class="line">     <span class="keyword">for</span> row <span class="keyword">in</span> csv_reader:</span><br><span class="line">         birth_data.append(row)</span><br><span class="line"></span><br><span class="line">birth_data = [[float(x) <span class="keyword">for</span> x <span class="keyword">in</span> row] <span class="keyword">for</span> row <span class="keyword">in</span> birth_data]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æ•°æ®</span></span><br><span class="line">y_vals = np.array([x[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> birth_data])</span><br><span class="line">x_vals = np.array([x[<span class="number">1</span>:<span class="number">8</span>] <span class="keyword">for</span> x <span class="keyword">in</span> birth_data])</span><br><span class="line"></span><br><span class="line">seed = <span class="number">99</span></span><br><span class="line">np.random.seed(seed)</span><br><span class="line">tf.set_random_seed(seed)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç¦»è®­ç»ƒé›†å’Œæµ‹è¯•é›†</span></span><br><span class="line">train_indices = np.random.choice(len(x_vals), round(len(x_vals)*<span class="number">0.8</span>), replace=<span class="keyword">False</span>)</span><br><span class="line">test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))</span><br><span class="line">x_vals_train = x_vals[train_indices]</span><br><span class="line">x_vals_test = x_vals[test_indices]</span><br><span class="line">y_vals_train = y_vals[train_indices]</span><br><span class="line">y_vals_test = y_vals[test_indices]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½’ä¸€åŒ–æ•°æ®å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize_cols</span><span class="params">(m)</span>:</span></span><br><span class="line">    col_max = m.max(axis=<span class="number">0</span>)</span><br><span class="line">    col_min = m.min(axis=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> (m-col_min) / (col_max - col_min)</span><br><span class="line">    </span><br><span class="line">x_vals_train = np.nan_to_num(normalize_cols(x_vals_train))</span><br><span class="line">x_vals_test = np.nan_to_num(normalize_cols(x_vals_test))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ‰¹å¤„ç†å¤§å°</span></span><br><span class="line">batch_size = <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ– placeholders</span></span><br><span class="line">x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">7</span>], dtype=tf.float32)</span><br><span class="line">y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå›å½’å˜é‡</span></span><br><span class="line">A = tf.Variable(tf.random_normal(shape=[<span class="number">7</span>,<span class="number">1</span>]))</span><br><span class="line">b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>,<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ¨¡å‹å›¾çš„æ“ä½œ</span></span><br><span class="line">model_output = tf.add(tf.matmul(x_data, A), b)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰äº¤å‰ç†µæŸå¤±å‡½æ•°</span></span><br><span class="line">loss = tf.reduce_mean(tf.nn.sigmoid_cross_entropy_with_logits(logits=model_output, labels=y_target))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¼˜åŒ–å™¨</span></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.01</span>)</span><br><span class="line">train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å…¨å±€å˜é‡</span></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æµ‹å€¼</span></span><br><span class="line">prediction = tf.round(tf.sigmoid(model_output))</span><br><span class="line">predictions_correct = tf.cast(tf.equal(prediction, y_target), tf.float32)</span><br><span class="line">accuracy = tf.reduce_mean(predictions_correct)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹è®­ç»ƒ</span></span><br><span class="line">loss_vec = []</span><br><span class="line">train_acc = []</span><br><span class="line">test_acc = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1500</span>):</span><br><span class="line">    rand_index = np.random.choice(len(x_vals_train), size=batch_size)</span><br><span class="line">    rand_x = x_vals_train[rand_index]</span><br><span class="line">    rand_y = np.transpose([y_vals_train[rand_index]])</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line"></span><br><span class="line">    temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    loss_vec.append(temp_loss)</span><br><span class="line">    temp_acc_train = sess.run(accuracy, feed_dict=&#123;x_data: x_vals_train, y_target: np.transpose([y_vals_train])&#125;)</span><br><span class="line">    train_acc.append(temp_acc_train)</span><br><span class="line">    temp_acc_test = sess.run(accuracy, feed_dict=&#123;x_data: x_vals_test, y_target: np.transpose([y_vals_test])&#125;)</span><br><span class="line">    test_acc.append(temp_acc_test)</span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">300</span>==<span class="number">0</span>: <span class="comment"># æ¯ä¸‰ç™¾æ¬¡æ‰“ä¸€æ¬¡æŸå¤±å‡½æ•°</span></span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(temp_loss))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ç”»å‡ºlossçš„å€¼</span></span><br><span class="line">plt.plot(loss_vec, <span class="string">'k-'</span>)</span><br><span class="line">plt.title(<span class="string">'Cross Entropy Loss per Generation'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Cross Entropy Loss'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”»å‡ºè®­ç»ƒå’Œæµ‹è¯•çš„å‡†ç¡®ç‡</span></span><br><span class="line">plt.plot(train_acc, <span class="string">'k-'</span>, label=<span class="string">'Train Set Accuracy'</span>)</span><br><span class="line">plt.plot(test_acc, <span class="string">'r--'</span>, label=<span class="string">'Test Set Accuracy'</span>)</span><br><span class="line">plt.title(<span class="string">'Train and Test Accuracy'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Accuracy'</span>)</span><br><span class="line">plt.legend(loc=<span class="string">'lower right'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯è¡¥ä¸Šå‘¨çš„åšå®¢ï¼Œè®©å¤§å®¶è®¤è¯†ä¸€ä¸‹é€»è¾‘å›å½’æ¨¡å‹çš„åŸºæœ¬å»ºç«‹ã€‚æœ‰ä»€ä¹ˆç–‘é—®ï¼Œå‘é‚®ä»¶air@weaf.topã€‚æœŸå¾…ä½ å“¦ï¼ï¼ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-logistic-regression&quot;&gt;TensorFlow Logistic
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>Pillowçš„ç®€å•ä½¿ç”¨</title>
    <link href="http://weafteam.github.io/posts/33d9791f/"/>
    <id>http://weafteam.github.io/posts/33d9791f/</id>
    <published>2018-05-17T02:03:18.000Z</published>
    <updated>2018-05-29T01:27:49.882Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘å¯¼å¸ˆè®©æˆ‘æ ¹æ®å·²æœ‰çš„ç¬”ç”»ä½ç½®ä¿¡æ¯ï¼Œç”Ÿæˆç›¸å¯¹åº”çš„å›¾åƒä¿¡æ¯ï¼Œå…¶ä¸­ç”¨åˆ°çš„å°±æ˜¯Pillowåº“ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±æŒ‰ç…§è¿™ä¸ªä»»åŠ¡è¦æ±‚ï¼Œå¯¹Pillowè¿™ä¸ªåº“è¿›è¡Œä½¿ç”¨è®²è§£ã€‚</p></blockquote><h1 id="æ•°æ®">æ•°æ®</h1><p>å…ˆä»‹ç»ä¸‹æ•°æ®å§ï¼Œå½“æ—¶å¯¼å¸ˆç»™äº†æˆ‘ä¸€ä»½600Mçš„JSONæ–‡ä»¶ï¼Œçœ‹åˆ°ä¹‹åæˆ‘çš„å†…å¿ƒæ¯«æ— æ³¢æ¾œï¼Œç”šè‡³è¿˜æƒ³æ¥ä¸€ä»½é»„ç„–é¸¡ç±³é¥­ã€‚è™½ç„¶æ•°æ®é‡å¾ˆå¤§ï¼Œä½†æ˜¯æ¯æ¡æ•°æ®æ˜¯å¾ˆè§„èŒƒçš„ï¼Œä¾‹å¦‚è¿™æ ·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;_id&quot;:&#123;&quot;$oid&quot;:&quot;58cbeb882398b78ed0c8165b&quot;&#125;,&quot;word&quot;:&quot;640,83;640,83;642,93;645,102;650,112;653,121;654,128;656,136;654,143;649,152;641,164;630,178;616,193;599,208;583,224;571,234;564,241;558,246;557,250;556,254;562,257;567,260;573,263;575,264;578,270;576,278;572,289;566,303;557,320;549,332;542,342;539,348;537,352;538,353;539,354;541,354;543,355;544,356;544,358;544,363;543,372;541,384;538,396;536,405;536,411;536,415;537,417;542,418;546,420;551,420;554,421;555,422;555,427;552,437;546,455;533,479;514,511;493,548;473,580;460,604;452,622;448,632;448,638;451,639;464,637;484,621;504,600;518,581;527,566;530,558;531,552;529,548;526,545;525,542;523,539;526,534;533,526;546,519;555,514;565,514;569,515;570,522;567,537;560,557;551,577;544,592;540,600;540,604;540,605;541,606;544,607;548,609;550,610;552,613;552,618;552,627;551,637;549,647;548,653;547,658;547,661;549,664;550,665;553,668;554,672;556,676;556,686;555,697;553,708;550,717;549,722;549,725;551,728;553,730;557,733;560,736;563,743;565,754;561,777;552,804;540,833;524,862;508,884;496,899;490,906;485,908;484,903;484,890;494,863;506,842;522,829;543,821;568,835;589,855;608,886;622,923;629,946;633,966;633,977;633,979#577,414;577,414;593,416;614,420;648,423;666,423;689,418;704,414;724,404;742,390;755,381&quot;,&quot;wordIndex&quot;:8826,&quot;str&quot;:&quot;á  á ¯á ³á  á ¬á ¤&quot;,&quot;createAtDate&quot;:&#123;&quot;$date&quot;:&quot;2017-03-17T13:58:32.767Z&quot;&#125;,&quot;updateAtDate&quot;:&#123;&quot;$date&quot;:&quot;2017-03-17T13:58:32.767Z&quot;&#125;,&quot;phoneId&quot;:&quot;9e29fc4021b45fbe&quot;,&quot;userId&quot;:&quot;0161132290&quot;,&quot;paid&quot;:false,&quot;__v&quot;:0&#125;</span><br></pre></td></tr></table></figure><p>wordå­—æ®µå°±æ˜¯ç¬”ç”»çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ç°åœ¨æ‰¾ä¸ªç”»ç¬”è·Ÿç€è¿™ä¸ªç¬”ç”»ç”»å°±è¡Œäº†ã€‚</p><h1 id="æ€è·¯">æ€è·¯</h1><p>å› ä¸ºè¿™äº›ç¬”ç”»çš„ä½ç½®å’Œå¤§å°å¹¶ä¸æ˜¯ç‰¹åˆ«è§„èŒƒçš„ï¼ˆå› ä¸ºæ”¶é›†è¿™äº›æ‰‹å†™ä½“çš„æ—¶å€™ï¼Œå°±æ˜¯åˆ©ç”¨æ‰‹æœºçš„æ‰‹å†™è¾“å…¥æ”¶é›†çš„ï¼Œæ‰€ä»¥ä¸æ˜¯å¾ˆè§„èŒƒï¼‰ï¼Œæ‰€ä»¥é¦–å…ˆç”Ÿæˆä¸€ä¸ª3000*3000çš„ç°åº¦å›¾ï¼ˆåº•æ˜¯ç™½è‰²ï¼‰ï¼Œç„¶åç”¨ä¸€ä¸ªå¾ˆç²—çš„ç”»ç¬”ï¼ˆå½“æ—¶ç”¨æ¥ä¸€ä¸ªwidth = 18çš„ç”»ç¬”ï¼‰å°†ä¸Šè¿°çš„ç¬”ç”»ç”»å‡ºæ¥ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬å¯ä»¥å…ˆæ‰¾å‡ºç¬”ç”»çš„æ¨ªå‘æœ€å¤§æœ€å°å€¼å’Œçºµå‘çš„æœ€å¤§æœ€å°å€¼ï¼Œç„¶åæ ¹æ®è¿™å››ä¸ªå€¼ï¼Œåœ¨ç”»å¸ƒä¸Šè£å‰ªå‡ºä¸€ä¸ªçŸ©å½¢æ¡†ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥å°†è£å‰ªå‡ºçš„çŸ©å½¢åŒºåŸŸresizeï¼ŒæŒ‰ç…§è¦æ±‚æ˜¯ç”Ÿæˆå®½åº¦ä¸º32ï¼Œé«˜åº¦ç­‰æ¯”ä¾‹ç¼©æ”¾çš„å›¾åƒï¼Œå½“ç„¶è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åŠ ä¸€ä¸ªå‚æ•°ï¼Œå«åšæŠ—é”¯é½¿ï¼Œç¨åæˆ‘ä¼šè®²åˆ°ã€‚</p><p>å› ä¸ºä¼ ç»Ÿçš„PILåº“ä¸æ”¯æŒPython3ï¼Œæ‰€ä»¥ä½¿ç”¨ä»PILæ´¾ç”Ÿå‡ºæ¥çš„Pillowåº“ã€‚</p><h1 id="imageå’Œimagedrawç±»">Imageå’ŒImageDrawç±»</h1><p>Pillowä¸­æœ€é‡è¦çš„å°±æ˜¯Imageç±»ï¼Œè¯¥ç±»å­˜åœ¨äºåŒåçš„æ¨¡å—ä¸­ã€‚æˆ‘ä»¬æœ¬æ¬¡ç”¨åˆ°çš„å®ä¾‹åŒ–æ–¹å¼æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ªå›¾ç‰‡ã€‚</p><p><strong>ç”Ÿæˆç”»å¸ƒ</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image = Image.new(<span class="string">"L"</span>,(<span class="number">3000</span>,<span class="number">3000</span>),<span class="string">"white"</span>)</span><br></pre></td></tr></table></figure><p>ImageDrawç±»ï¼Œä»åå­—ä¸­ä¸éš¾çœ‹å‡ºä»–çš„ä½œç”¨ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¼€å§‹ç”»å›¾å§ã€‚</p><p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œwordå­—æ®µé‡Œé¢ï¼Œ<span class="math inline">\(;\)</span>åˆ†å‰²çš„æ˜¯ç‚¹ï¼Œ<span class="math inline">\(,\)</span>åˆ†å‰²çš„æ˜¯xå’Œyï¼Œ<span class="math inline">\(#\)</span>åˆ†å‰²çš„æ˜¯ç¬”ç”»ï¼Œæ‰€ä»¥æ ¹æ®è¿™ä¸ªå±‚çº§å…³ç³»ï¼Œä¸‰å±‚åµŒå¥—çš„æ–¹å¼å°±å¯ä»¥å°†è¿™äº›ç¬”ç”»åˆ»ç”»å‡ºæ¥ã€‚</p><p><strong>ç”Ÿæˆç”»ç¬”</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">draw = ImageDraw.Draw(image)</span><br></pre></td></tr></table></figure><p><strong>ç”»å›¾</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lines = [[[int(x) <span class="keyword">for</span> x <span class="keyword">in</span> point.split(<span class="string">','</span>)] <span class="keyword">for</span> point <span class="keyword">in</span> line.split(<span class="string">';'</span>)] <span class="keyword">for</span> line <span class="keyword">in</span> fileJson[<span class="string">'word'</span>].split(<span class="string">'#'</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">            <span class="keyword">if</span>(len(line)&gt;<span class="number">1</span>):</span><br><span class="line">                draw.line((line[<span class="number">0</span>][<span class="number">0</span>], -line[<span class="number">0</span>][<span class="number">1</span>], line[<span class="number">1</span>][<span class="number">0</span>], -line[<span class="number">1</span>][<span class="number">1</span>]),fill=<span class="string">'black'</span>,width=<span class="number">18</span>)</span><br><span class="line">                temp = [line[<span class="number">1</span>][<span class="number">0</span>],line[<span class="number">1</span>][<span class="number">1</span>]]</span><br><span class="line">                <span class="keyword">for</span> point <span class="keyword">in</span> line:</span><br><span class="line">                    draw.line((temp[<span class="number">0</span>],temp[<span class="number">1</span>],point[<span class="number">0</span>],point[<span class="number">1</span>]),fill=<span class="string">'black'</span>,width=<span class="number">18</span>)</span><br><span class="line">                    temp=[point[<span class="number">0</span>],point[<span class="number">1</span>]]</span><br></pre></td></tr></table></figure><p><strong>è£å‰ª</strong></p><p>è®¡ç®—å‡ºæ¨ªå‘çºµå‘ä¸Šçš„æœ€å¤§æœ€å°å€¼ï¼Œè¿›è¡Œè£å‰ªã€‚ï¼ˆä¹‹æ‰€ä»¥åŠ 30ï¼Œæ˜¯å› ä¸ºæœ‰ç™½è¾¹çš„æƒ…å†µä¸‹çœ‹ç€æ¯”è¾ƒèˆ’æœï¼Œä½†æ˜¯minçš„å€¼å¹¶æ²¡æœ‰åŠ ï¼ŒåŸå› æ˜¯å®¹æ˜“äº§ç”Ÿé»‘æ ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">box = (hor_min  , ver_min , hor_max + <span class="number">30</span> , ver_max + <span class="number">30</span>)</span><br><span class="line">b = image.crop(box)</span><br></pre></td></tr></table></figure><p><strong>resizeå¹¶ä¿å­˜</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = b.resize((<span class="number">32</span>,length),Image.ANTIALIAS)</span><br><span class="line">a.save(path)</span><br></pre></td></tr></table></figure><p>æœ¬æ¬¡å®éªŒå¾ˆç®€å•ï¼Œç”¨åˆ°äº†Pillowä¸­ä¸å¤šçš„å‡½æ•°ï¼Œå…¶å®Pillowä¸­è¿˜æœ‰å¾ˆå¤šæœ‰è¶£çš„æ“ä½œï¼Œè¯·å¤§å®¶è‡ªè¡Œç ”ç©¶å®ƒçš„ä¸­æ–‡æ–‡æ¡£ã€‚</p><p><strong>æ•ˆæœ</strong></p><p>æœ€åç»™å¤§å®¶çœ‹ä¸‹æ•ˆæœï¼š</p><p><img src="https://i.loli.net/2018/05/17/5afd163532d24.bmp" alt="593d584661d6b6417c2b19d6.bmp"></p><p><img src="https://i.loli.net/2018/05/17/5afd1695ae569.bmp" alt="58dba09d2398b78ed0c9a7ac.bmp"></p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘å¯¼å¸ˆè®©æˆ‘æ ¹æ®å·²æœ‰çš„ç¬”ç”»ä½ç½®ä¿¡æ¯ï¼Œç”Ÿæˆç›¸å¯¹åº”çš„å›¾åƒä¿¡æ¯ï¼Œå…¶ä¸­ç”¨åˆ°çš„å°±æ˜¯Pillowåº“ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±æŒ‰ç…§è¿™ä¸ªä»»åŠ¡è¦æ±‚ï¼Œå¯¹Pillowè¿™ä¸ªåº“è¿›è¡Œä½¿ç”¨è®²è§£ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1
        
      
    
    </summary>
    
    
      <category term="Pillow Python OCR" scheme="http://weafteam.github.io/tags/Pillow-Python-OCR/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot å…³ä¹javaç¨‹åºå‘˜</title>
    <link href="http://weafteam.github.io/posts/1cf77d1e/"/>
    <id>http://weafteam.github.io/posts/1cf77d1e/</id>
    <published>2018-05-16T18:04:44.000Z</published>
    <updated>2018-08-07T08:56:41.650Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h1><p>Spring Boot2.0ä¸€æ¨å‡ºå°±æ¿€èµ·äº†ä¸€é˜µå­¦ä¹ Spring Bootçš„çƒ­æµªï¼Œå°±ç™¾åº¦å’Œæœç´¢å¼•æ“çš„æ•°æ®æŠ¥å‘Šæ˜¾ç¤ºSpring Bootç›¸å…³æœç´¢æŒ‡æ•°æ€¥å‰§å¢åŠ ã€‚</p><p>é‚£ä¹ˆSpring Bootåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæƒ³å¿…å¤§å®¶éƒ½æœ‰äº†ä¸€äº›äº†è§£ï¼‰ é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤šäººå»å­¦ä¹ ä»–å‘¢ï¼Ÿï¼ˆå€¼å¾—æ€è€ƒçš„é—®é¢˜ï¼‰</p><h3 id="spring-bootçš„è¯ç”Ÿ">Spring Bootçš„è¯ç”Ÿ</h3><p>éšç€ä½¿ç”¨Springçš„äººè¶Šæ¥è¶Šå¤šï¼ŒSpringå°±å¼€å§‹ä»ä¸€ä¸ªç®€å•ã€å•ä¸€çš„å°æ¡†æ¶å˜æˆä¸€ä¸ªå¤§è€Œå…¨çš„å¼€æºè½¯ä»¶ï¼Œéƒ½åæ¥ï¼Œå‡ ä¹ç”¨æ•´ä¸ªSpringå°±å¯ä»¥æ”¯æ’‘èµ·ä¼ä¸šä¸­æ‰€æœ‰çš„æœåŠ¡äº†ã€‚ä½†æ˜¯éšä¹‹ä¹Ÿä½¿å¾—å¸¦æ¥ä¸€äº›é—®é¢˜ã€‚</p><p>ä¹‹å‰çš„Spring æœ‰ç€å„ç§å„æ ·çš„é…ç½®æ–‡ä»¶ã€‚å¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ä¸å¾—ä¸é…ç½®å¾ˆå¤šä¸œè¥¿ã€‚</p><p>åæ¥Springæ…¢æ…¢çš„å‘ç°äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¼€å§‹äº†Spring Booté¡¹ç›®çš„ç ”å‘ã€‚</p><h3 id="spring-bootæ˜¯ä»€ä¹ˆ">Spring Bootæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>Spring Bootæ˜¯ç”±Pivotalå›¢é˜Ÿæä¾›çš„å…¨æ–°æ¡†æ¶ï¼Œå…¶è®¾è®¡ç›®çš„æ˜¯ç”¨æ¥ç®€åŒ–æ–°Springåº”ç”¨çš„åˆå§‹æ­å»ºä»¥åŠå¼€å‘è¿‡ç¨‹ã€‚è¯¥æ¡†æ¶ä½¿ç”¨äº†ç‰¹å®šçš„æ–¹å¼æ¥è¿›è¡Œé…ç½®ï¼Œä»è€Œä½¿å¼€å‘äººå‘˜ä¸å†éœ€è¦å®šä¹‰æ ·æ¿åŒ–çš„é…ç½®ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒSpring Bootè‡´åŠ›äºåœ¨è“¬å‹ƒå‘å±•çš„å¿«é€Ÿåº”ç”¨å¼€å‘é¢†åŸŸ(rapid application development)æˆä¸ºé¢†å¯¼è€…ã€‚</p><h5 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h5><ol type="1"><li>åˆ›å»ºç‹¬ç«‹çš„Springåº”ç”¨ç¨‹åº</li><li>åµŒå…¥çš„Tomcatï¼Œæ— éœ€éƒ¨ç½²WARæ–‡ä»¶</li><li>ç®€åŒ–Mavené…ç½®</li><li>è‡ªåŠ¨é…ç½®Spring</li><li>æä¾›ç”Ÿäº§å°±ç»ªå‹åŠŸèƒ½ï¼Œå¦‚æŒ‡æ ‡ï¼Œå¥åº·æ£€æŸ¥å’Œå¤–éƒ¨é…ç½®</li><li>ç»å¯¹æ²¡æœ‰ä»£ç ç”Ÿæˆå’Œå¯¹XMLæ²¡æœ‰è¦æ±‚é…ç½®</li></ol><h1 id="äºŒspringbootå…³ä¹javaç¨‹åºå‘˜">äºŒã€SpringBootå…³ä¹Javaç¨‹åºå‘˜</h1><p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼Œç°åœ¨ä¼ä¸šä¸­å¾ˆå¤šéƒ½æ˜¯ç”¨Springå¼€æºæ¡†æ¶ï¼Œå¹¶ä¸”ç°åœ¨Spring Boot2.0ä½œä¸ºSpringçš„ä¼˜ç§€äº§ç‰©ï¼Œå·²ç»å¸å¼•äº†å¾ˆå¤šæŠ€æœ¯å’Œä¼ä¸šå»ä½¿ç”¨å®ƒã€‚ è¿™ä½¿å¾—æˆ‘ä»¬Javaç¨‹åºå‘˜ä¸å¾—ä¸å»å­¦ä¹ ä»–çš„ä¸€ä¸ªåŸå› ã€‚ å…¶æ¬¡ï¼ŒSpring Boot è¿˜å…·æœ‰ä¸€ä¸‹ç‰¹ç‚¹ï¼š</p><ol type="1"><li>Spring Boot è®©å¼€å‘å˜å¾—æ›´ç®€å•<ol type="1"><li>ç™»å½•ç½‘å€ http://start.spring.io/ é€‰æ‹©å¯¹åº”çš„ç»„ä»¶ç›´æ¥ä¸‹è½½</li><li>å¯¼å…¥é¡¹ç›®ï¼Œç›´æ¥å¼€å‘</li></ol></li><li>Spring Boot ä½¿æµ‹è¯•å˜å¾—æ›´ç®€å•<ol type="1"><li>å¼•å…¥spring-boot-start-testä¾èµ–åŒ…</li><li>å¯¹æ•°æ®åº“ã€Mockã€ Web ç­‰å„ç§æƒ…å†µè¿›è¡Œæµ‹è¯•ã€‚</li></ol></li><li>Spring Boot è®©é…ç½®å˜å¾—æ›´ç®€å•</li><li>Spring Boot è®©éƒ¨ç½²å˜å¾—æ›´ç®€å•</li><li>Spring Boot è®©ç›‘æ§å˜å¾—æ›´ç®€å•</li></ol><h1 id="ä¸‰é¡¹ç›®ç”Ÿäº§">ä¸‰ã€é¡¹ç›®ç”Ÿäº§</h1><p>Spring Booté¡¹ç›®æ­å»ºéå¸¸ç®€å•</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨springæä¾›çš„ç½‘ç«™ç›´æ¥ç”Ÿäº§è‡ªå·±æƒ³è¦çš„é¡¹ç›®</p><p><a href="https://start.spring.io/" class="uri" target="_blank" rel="noopener">https://start.spring.io/</a></p><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/springboot-1.png" alt="springboot-1"></p><p>è¿™é‡Œç”Ÿäº§çš„demoå¯ä»¥å°†ä½ æ‰€éœ€çš„æ‰€æœ‰ä¸œè¥¿éƒ½é›†æˆè¿›å»ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‚¹å‡» <strong>Switch to the full version</strong> æ¥æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„åˆ—è¡¨</p><p>å››ã€ç›®å½•è§£æ</p><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/springboot-2.png" alt="springboot-2"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºé»˜è®¤ç»™å‡ºçš„demoçš„é¡¹ç›®ç›®å½•å¾ˆç®€å•ã€‚</p><p>éƒ½æ˜¯æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„ä¸‰ä¸ªç›®å½•</p><ol type="1"><li>src/main/java/</li><li>src/main/resources/</li><li>src/test/java/</li></ol><p>è¿™é‡Œresources æˆ‘ä½¿ç”¨çš„æ˜¯yamlæ–‡ä»¶ã€‚è€Œä¸”SpringBootå¯¹å®ƒçš„æ”¯æŒä¹Ÿæ˜¯éå¸¸å¥½çš„ã€‚ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/springboot-3.png" alt="springboot-3">ã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ol type="1"><li><a href="https://spring.io/projects/spring-boot" class="uri" target="_blank" rel="noopener">https://spring.io/projects/spring-boot</a></li><li><a href="http://blog.51cto.com/ityouknow/2128700" class="uri" target="_blank" rel="noopener">http://blog.51cto.com/ityouknow/2128700</a></li></ol>]]></content>
    
    <summary type="html">
    
      Spring Boot å…³ä¹javaç¨‹åºå‘˜
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆäº”ï¼‰</title>
    <link href="http://weafteam.github.io/posts/112d613e/"/>
    <id>http://weafteam.github.io/posts/112d613e/</id>
    <published>2018-05-13T15:09:56.000Z</published>
    <updated>2018-08-07T08:56:41.649Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šæ–‡ã€‚</p><h2 id="ç”¨åç¨‹å’Œæµå®ç°å¼‚æ­¥-i-o">ç”¨åç¨‹å’Œæµå®ç°å¼‚æ­¥ I / O</h2><p>æœ¬èŠ‚å°†é‡æ–°å®ç° echo æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ä¸¤ä¸ªç¤ºä¾‹ç¨‹åºï¼Œåªä¸è¿‡ä¼šä½¿ç”¨åç¨‹å’Œ <code>asyncio</code> æµ API è€Œä¸æ˜¯ <code>Protocol</code> å’Œ <code>Transport</code> ç±»æŠ½è±¡ã€‚è¿™äº›ç¤ºä¾‹åœ¨æ¯”å‰é¢è®¨è®ºçš„<code>Protocol</code> API æ›´ä½çš„æŠ½è±¡çº§åˆ«ä¸Šæ“ä½œï¼Œä½†æ˜¯å¤„ç†çš„äº‹ä»¶æ˜¯ç›¸ä¼¼çš„ã€‚</p><h3 id="echo-æœåŠ¡å™¨">Echo æœåŠ¡å™¨</h3><p>æœåŠ¡å™¨ç¨‹åºé¦–å…ˆå¯¼å…¥æ‰€éœ€çš„ <code>asyncio</code> å’Œ <code>logging</code> æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">SERVER_ADDRESS = (<span class="string">'localhost'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    format=<span class="string">'%(name)s: %(message)s'</span>,</span><br><span class="line">    stream=sys.stderr,</span><br><span class="line">)</span><br><span class="line">log = logging.getLogger(<span class="string">'main'</span>)</span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br></pre></td></tr></table></figure><p>ç„¶åå®šä¹‰ä¸€ä¸ªåç¨‹æ¥å¤„ç†é€šä¿¡ã€‚æ¯æ¬¡å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨åç¨‹çš„æ–°å®ä¾‹ï¼Œä»è€Œåœ¨è¯¥å‡½æ•°ä¸­çš„ä»£ç ä¸€æ¬¡åªèƒ½ä¸ä¸€ä¸ªå®¢æˆ·ç«¯é€šä¿¡ã€‚Python çš„è¯­è¨€è¿è¡Œæ—¶ç®¡ç†æ¯ä¸ªåç¨‹å®ä¾‹çš„çŠ¶æ€ï¼Œå› æ­¤åº”ç”¨ç¨‹åºä»£ç ä¸éœ€è¦ç®¡ç†ä»»ä½•é¢å¤–çš„æ•°æ®ç»“æ„æ¥è·Ÿè¸ªå•ç‹¬çš„å®¢æˆ·ç«¯ã€‚</p><p>åç¨‹æ¥å—çš„å‚æ•°æ˜¯ä¸æ–°è¿æ¥å…³è”çš„Â <code>StreamReader</code> å’Œ <code>StreamWriter</code> å®ä¾‹ã€‚ä¸ <code>Transport</code> ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡ <code>writer</code> çš„ <code>get_extra_info()</code> æ–¹æ³•è®¿é—®å®¢æˆ·ç«¯åœ°å€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">echo</span><span class="params">(reader, writer)</span>:</span></span><br><span class="line">    address = writer.get_extra_info(<span class="string">'peername'</span>)</span><br><span class="line">    log = logging.getLogger(<span class="string">'echo_&#123;&#125;_&#123;&#125;'</span>.format(*address))</span><br><span class="line">    log.debug(<span class="string">'connection accepted'</span>)</span><br></pre></td></tr></table></figure><p>è™½ç„¶åœ¨å»ºç«‹è¿æ¥æ—¶è°ƒç”¨åç¨‹ï¼Œä½†å¯èƒ½è¿˜æ²¡æœ‰ä»»ä½•è¦è¯»å–çš„æ•°æ®ã€‚ä¸ºäº†é¿å…åœ¨è¯»å–æ—¶é˜»å¡ï¼Œåç¨‹ä½¿ç”¨ <code>await read()</code> æ¥å…è®¸äº‹ä»¶å¾ªç¯ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œç›´åˆ°æœ‰æ•°æ®è¦è¯»å–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    data = <span class="keyword">await</span> reader.read(<span class="number">128</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æœå®¢æˆ·ç«¯å‘é€äº†æ•°æ®ï¼Œåˆ™ä» <code>await</code> è¿”å›æ•°æ®ï¼Œå¹¶å¯é€šè¿‡å°†å…¶ä¼ é€’ç»™ <code>writer</code> å‘é€å›å®¢æˆ·ç«¯ã€‚å¯¹ <code>write()</code> çš„å¤šä¸ªè°ƒç”¨å¯ç”¨äºç¼“å†²ä¼ å‡ºçš„æ•°æ®ï¼Œç„¶åä½¿ç”¨ <code>drain()</code> åˆ·æ–°ç»“æœã€‚ç”±äºåˆ·æ–°ç½‘ç»œ I / O å¯èƒ½ä¼šé˜»å¡ï¼Œå› æ­¤å†æ¬¡ä½¿ç”¨ <code>await</code> æ¥æ¢å¤å¯¹äº‹ä»¶å¾ªç¯çš„æ§åˆ¶ï¼Œäº‹ä»¶å¾ªç¯ç›‘è§†å†™å…¥ socketï¼Œå¹¶åœ¨å¯èƒ½å‘é€æ›´å¤šæ•°æ®æ—¶è°ƒç”¨ <code>writer</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> data:</span><br><span class="line">    log.debug(<span class="string">f'received <span class="subst">&#123;data&#125;</span>'</span>)</span><br><span class="line">    writer.write(data)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    log.debug(<span class="string">f'sent <span class="subst">&#123;data&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æœå®¢æˆ·ç«¯æœªå‘é€ä»»ä½•æ•°æ®ï¼Œ<code>read()</code> å°†è¿”å›ä¸€ä¸ªç©ºå­—èŠ‚ä¸²ï¼Œä»¥æŒ‡ç¤ºè¿æ¥å·²å…³é—­ã€‚æœåŠ¡å™¨éœ€è¦å…³é—­ socket ä»¥å†™å…¥å®¢æˆ·ç«¯ï¼Œç„¶å åç¨‹å¯ä»¥è¿”å›ä»¥æŒ‡ç¤ºå®ƒå·²å®Œæˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    log.debug(<span class="string">'closing'</span>)</span><br><span class="line">    writer.close()</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡å™¨æœ‰ä¸¤ä¸ªæ­¥éª¤ã€‚é¦–å…ˆï¼Œåº”ç”¨ç¨‹åºå‘Šè¯‰äº‹ä»¶å¾ªç¯è¦ç›‘å¬çš„ä¸»æœºåå’Œ socketï¼Œä½¿ç”¨åç¨‹åˆ›å»ºæ–°çš„æœåŠ¡å™¨å¯¹è±¡ã€‚Â <code>start_server()</code>Â  æ–¹æ³•æœ¬èº«å°±æ˜¯ä¸€ä¸ªåç¨‹ï¼Œå› æ­¤å¿…é¡»ç”±äº‹ä»¶å¾ªç¯å¤„ç†ç»“æœæ‰èƒ½å®é™…å¯åŠ¨æœåŠ¡å™¨ã€‚å®Œæˆåç¨‹äº§ç”Ÿäº†ç»‘å®šåˆ°äº‹ä»¶å¾ªç¯çš„ <code>asyncio.Server</code> å®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">factory = asyncio.start_server(echo, *SERVER_ADDRESS)</span><br><span class="line">server = event_loop.run_until_complete(factory)</span><br><span class="line">log.debug(<span class="string">'starting up on &#123;&#125; port &#123;&#125;'</span>.format(*SERVER_ADDRESS))</span><br></pre></td></tr></table></figure><p>éœ€è¦è¿è¡Œäº‹ä»¶å¾ªç¯ä»¥å¤„ç†äº‹ä»¶å’Œå®¢æˆ·ç«¯è¯·æ±‚ã€‚å¯¹äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ï¼Œ<code>run_forever()</code>Â æ–¹æ³•æ˜¯æœ€ç®€å•çš„æ–¹æ³•ã€‚å½“äº‹ä»¶å¾ªç¯åœæ­¢æ—¶ï¼Œæ— è®ºæ˜¯é€šè¿‡åº”ç”¨ç¨‹åºä»£ç è¿˜æ˜¯é€šè¿‡å‘ä¿¡å·é€šçŸ¥è¿›ç¨‹ï¼ŒæœåŠ¡å™¨éƒ½å¯ä»¥å…³é—­ä»¥æ­£ç¡®æ¸…ç† socketï¼Œç„¶åå¯ä»¥å…³é—­äº‹ä»¶å¾ªç¯ä»¥åœ¨ç¨‹åºé€€å‡ºä¹‹å‰å®Œæˆå¯¹ä»»ä½•å…¶ä»–äº‹åŠ¡çš„å¤„ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_forever()</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    log.debug(<span class="string">'closing server'</span>)</span><br><span class="line">    server.close()</span><br><span class="line">    event_loop.run_until_complete(server.wait_closed())</span><br><span class="line">    log.debug(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><h3 id="echo-å®¢æˆ·ç«¯">Echo å®¢æˆ·ç«¯</h3><p>ä½¿ç”¨åç¨‹æ„å»ºå®¢æˆ·ç«¯éå¸¸ç±»ä¼¼äºæ„å»ºæœåŠ¡å™¨ã€‚ä»£ç å†æ¬¡å¼€å§‹äºå¯¼å…¥ <code>asyncio</code> å’Œ <code>logging</code> æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">MESSAGES = [</span><br><span class="line">    <span class="string">b'This is the message. '</span>,</span><br><span class="line">    <span class="string">b'It will be sent '</span>,</span><br><span class="line">    <span class="string">b'in parts.'</span>,</span><br><span class="line">]</span><br><span class="line">SERVER_ADDRESS = (<span class="string">'localhost'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    format=<span class="string">'%(name)s: %(message)s'</span>,</span><br><span class="line">    stream=sys.stderr,</span><br><span class="line">)</span><br><span class="line">log = logging.getLogger(<span class="string">'main'</span>)</span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br></pre></td></tr></table></figure><p><code>echo_client</code> åç¨‹æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œå‘Šè¯‰å®ƒæœåŠ¡å™¨åœ¨å“ªé‡Œä»¥åŠè¦å‘é€ä»€ä¹ˆæ¶ˆæ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">echo_client</span><span class="params">(address, messages)</span>:</span></span><br></pre></td></tr></table></figure><p>å½“ä»»åŠ¡å¯åŠ¨æ—¶è°ƒç”¨åç¨‹ï¼Œä½†å®ƒæ²¡æœ‰å¯ç”¨çš„æ´»åŠ¨è¿æ¥ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯è®©å®¢æˆ·ç«¯å»ºç«‹è‡ªå·±çš„è¿æ¥ã€‚å®ƒä½¿ç”¨ <code>await</code> æ¥é¿å…åœ¨ <code>open_connection()</code> åç¨‹è¿è¡Œæ—¶é˜»å¡å…¶ä»–æ´»åŠ¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log = logging.getLogger(<span class="string">'echo_client'</span>)</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">'connecting to &#123;&#125; port &#123;&#125;'</span>.format(*address))</span><br><span class="line">reader, writer = <span class="keyword">await</span> asyncio.open_connection(*address)</span><br></pre></td></tr></table></figure><p><code>open_connection()</code> åç¨‹è¿”å›ä¸æ–° socket å…³è”çš„ <code>StreamReader</code> å’Œ <code>StreamWriter</code> å®ä¾‹ã€‚ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨ <code>writer</code> å‘æœåŠ¡å™¨å‘é€æ•°æ®ã€‚ä¸æœåŠ¡å™¨ä¸€æ ·ï¼Œ<code>writer</code> å°†ç¼“å†²ä¼ å‡ºçš„æ•°æ®ï¼Œç›´åˆ° socket å°±ç»ªæˆ–ä½¿ç”¨ <code>drain()</code> åˆ·æ–°ç»“æœã€‚ç”±äºåˆ·æ–°ç½‘ç»œ I / O å¯èƒ½ä¼šé˜»å¡ï¼Œå› æ­¤å†æ¬¡ä½¿ç”¨ <code>await</code> æ¥æ¢å¤å¯¹äº‹ä»¶å¾ªç¯çš„æ§åˆ¶ï¼Œäº‹ä»¶å¾ªç¯ç›‘è§†å†™å…¥ socketï¼Œå¹¶åœ¨å¯èƒ½å‘é€æ›´å¤šæ•°æ®æ—¶è°ƒç”¨ <code>writer</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> msg <span class="keyword">in</span> messages:</span><br><span class="line">    writer.write(msg)</span><br><span class="line">    log.debug(<span class="string">f'sending <span class="subst">&#123;msg&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">if</span> writer.can_write_eof():</span><br><span class="line">    writer.write_eof()</span><br><span class="line"><span class="keyword">await</span> writer.drain()</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯é€šè¿‡å°è¯•è¯»å–æ•°æ®ç›´åˆ°æ²¡æœ‰è¦è¯»å–çš„å†…å®¹æ¥è·å–æ¥è‡ªæœåŠ¡å™¨çš„å“åº”ã€‚ä¸ºäº†é¿å…é˜»å¡å•ä¸ª <code>read()</code> è°ƒç”¨ï¼Œ<code>await</code> å°†æ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯ã€‚å¦‚æœæœåŠ¡å™¨å·²å‘é€æ•°æ®ï¼Œåˆ™ä¼šè®°å½•æ•°æ®ã€‚å¦‚æœæœåŠ¡å™¨æœªå‘é€ä»»ä½•æ•°æ®ï¼Œ<code>read()</code> å°†è¿”å›ä¸€ä¸ªç©ºå­—èŠ‚ä¸²ï¼ŒæŒ‡ç¤ºè¿æ¥å·²å…³é—­ã€‚å®¢æˆ·ç«¯éœ€è¦å…³é—­ socket ä»¥å‘é€åˆ°æœåŠ¡å™¨ï¼Œç„¶åè¿”å›ä»¥æŒ‡ç¤ºå·²å®Œæˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">log.debug(<span class="string">'waiting for response'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    data = <span class="keyword">await</span> reader.read(<span class="number">128</span>)</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        log.debug(<span class="string">f'received <span class="subst">&#123;data&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        log.debug(<span class="string">'closing'</span>)</span><br><span class="line">        writer.close()</span><br><span class="line">        <span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>è¦å¯åŠ¨å®¢æˆ·ç«¯ï¼Œä½¿ç”¨åç¨‹è°ƒç”¨äº‹ä»¶å¾ªç¯ä»¥åˆ›å»ºå®¢æˆ·ç«¯ã€‚ä½¿ç”¨Â <code>run_until_complete()</code>Â  å¯é¿å…å®¢æˆ·ç«¯ç¨‹åºä¸­å‡ºç°æ— é™å¾ªç¯ã€‚ä¸<code>Protocol</code> ç¤ºä¾‹ä¸åŒï¼Œåç¨‹å®Œæˆæ—¶ä¸éœ€è¦å•ç‹¬çš„ <code>future</code> å‘å‡ºä¿¡å·ï¼Œå› ä¸º <code>echo_client()</code> åŒ…å«æ‰€æœ‰å®¢æˆ·ç«¯é€»è¾‘æœ¬èº«ï¼Œå¹¶ä¸”åœ¨æ”¶åˆ°å“åº”å¹¶å…³é—­æœåŠ¡å™¨è¿æ¥ä¹‹å‰ä¸ä¼šè¿”å›ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(echo_client(SERVER_ADDRESS, MESSAGES))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    log.debug(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><h3 id="è¾“å‡º">è¾“å‡º</h3><p>åœ¨ä¸€ä¸ªçª—å£ä¸­è¿è¡ŒæœåŠ¡å™¨è€Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­è¿è¡Œå®¢æˆ·ç«¯ã€‚</p><p>å®¢æˆ·ç«¯å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">asyncio: Using selector: SelectSelector</span><br><span class="line">echo_client: connecting to localhost port 10000</span><br><span class="line">echo_client: sending b'This is the message. '</span><br><span class="line">echo_client: sending b'It will be sent '</span><br><span class="line">echo_client: sending b'in parts.'</span><br><span class="line">echo_client: waiting for response</span><br><span class="line">echo_client: received b'This is the message. It will be sent in parts.'</span><br><span class="line">echo_client: closing</span><br><span class="line">main: closing event loop</span><br></pre></td></tr></table></figure><p>è™½ç„¶å®¢æˆ·ç«¯æ€»æ˜¯å•ç‹¬å‘é€æ¶ˆæ¯ï¼Œä½†å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ”¶åˆ°ä¸€æ¡å¤§æ¶ˆæ¯ï¼Œå¹¶å°†è¯¥æ¶ˆæ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ ¹æ®ç½‘ç»œçš„ç¹å¿™ç¨‹åº¦ä»¥åŠæ˜¯å¦åœ¨å‡†å¤‡æ‰€æœ‰æ•°æ®ä¹‹å‰åˆ·æ–°ç½‘ç»œç¼“å†²åŒºï¼Œè¿™äº›ç»“æœåœ¨åç»­è¿è¡Œä¸­ä¼šæœ‰æ‰€ä¸åŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">asyncio: Using selector: SelectSelector</span><br><span class="line">main: starting up on localhost port 10000</span><br><span class="line">echo_::1_11075: connection accepted</span><br><span class="line">echo_::1_11075: received b'This is the message. It will be sent in parts.'</span><br><span class="line">echo_::1_11075: sent b'This is the message. It will be sent in parts.'</span><br><span class="line">echo_::1_11075: closing</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo_::1_11200: connection accepted</span><br><span class="line">echo_::1_11200: received b'This is the message. It will be sent '</span><br><span class="line">echo_::1_11200: sent b'This is the message. It will be sent '</span><br><span class="line">echo_::1_11200: received b'in parts.'</span><br><span class="line">echo_::1_11200: sent b'in parts.'</span><br><span class="line">echo_::1_11200: closing</span><br></pre></td></tr></table></figure><h2 id="ä¸å­è¿›ç¨‹åä½œ">ä¸å­è¿›ç¨‹åä½œ</h2><p>ä¸ºäº†åˆ©ç”¨ç°æœ‰ä»£ç è€Œä¸é‡å†™ï¼Œæˆ–è€…è®¿é—® Python ä¸­ä¸å¯ç”¨çš„åº“æˆ–åŠŸèƒ½ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä½¿ç”¨å…¶ä»–ç¨‹åºæˆ–è¿›ç¨‹ã€‚ä¸ç½‘ç»œ I / O ä¸€æ ·ï¼Œ<code>asyncio</code> åŒ…æ‹¬ä¸¤ä¸ªæŠ½è±¡ï¼Œç”¨äºå¯åŠ¨å¦ä¸€ä¸ªç¨‹åºï¼Œç„¶åä¸å®ƒäº¤äº’ã€‚</p><h3 id="ä½¿ç”¨å­è¿›ç¨‹çš„-protocol-æŠ½è±¡">ä½¿ç”¨å­è¿›ç¨‹çš„ Protocol æŠ½è±¡</h3><p>è¿™ä¸ªä¾‹å­ä½¿ç”¨åç¨‹å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œ Unix å‘½ä»¤ <code>df</code>ï¼Œä»¥ä¾¿æŸ¥çœ‹åœ¨æœ¬åœ°ç£ç›˜ä¸Šçš„å¯ç”¨ç©ºé—´ã€‚å®ƒä½¿ç”¨ <code>subprocess_exec()</code> å¯åŠ¨è¿›ç¨‹ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°çŸ¥é“å¦‚ä½•è¯»å– <code>df</code> å‘½ä»¤è¾“å‡ºå¹¶å¯¹å…¶è¿›è¡Œåˆ†æçš„ <code>Protocol</code> ç±»ã€‚<code>Protocol</code> ç±»çš„æ–¹æ³•æ˜¯æ ¹æ®å­è¿›ç¨‹çš„ I / O äº‹ä»¶è‡ªåŠ¨è°ƒç”¨çš„ã€‚å› ä¸º <code>stdin</code> å’Œ <code>stderr</code> å‚æ•°éƒ½è®¾ç½®ä¸º <code>None</code>ï¼Œæ‰€ä»¥è¿™äº›é€šä¿¡é€šé“ä¸ä¼šè¿æ¥åˆ°æ–°è¿›ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_df</span><span class="params">(loop)</span>:</span></span><br><span class="line">    print(<span class="string">'in run_df'</span>)</span><br><span class="line"></span><br><span class="line">    cmd_done = asyncio.Future(loop=loop)</span><br><span class="line">    factory = functools.partial(DFProtocol, cmd_done)</span><br><span class="line">    proc = loop.subprocess_exec(</span><br><span class="line">        factory,</span><br><span class="line">        <span class="string">'df'</span>,</span><br><span class="line">        <span class="string">'-hl'</span>,</span><br><span class="line">        stdin=<span class="keyword">None</span>,</span><br><span class="line">        stderr=<span class="keyword">None</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(<span class="string">'launching process'</span>)</span><br><span class="line">        transport, protocol = <span class="keyword">await</span> proc</span><br><span class="line">        print(<span class="string">'waiting for process to complete'</span>)</span><br><span class="line">        <span class="keyword">await</span> cmd_done</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        transport.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cmd_done.result()</span><br></pre></td></tr></table></figure><p>ç±» <code>DFProtocol</code> ç»§æ‰¿è‡ª <code>SubprocessProtocol</code>ï¼Œè¯¥ <code>Protocol</code> å®šä¹‰äº†ç±»é€šè¿‡ç®¡é“ä¸å¦ä¸€è¿›ç¨‹é€šä¿¡çš„ APIã€‚<code>done</code> å‚æ•°æ˜¯è°ƒç”¨è€…ç”¨æ¥ç›‘è§†è¿›ç¨‹æ˜¯å¦å®Œæˆçš„ <code>future</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DFProtocol</span><span class="params">(asyncio.SubprocessProtocol)</span>:</span></span><br><span class="line"></span><br><span class="line">    FD_NAMES = [<span class="string">'stdin'</span>, <span class="string">'stdout'</span>, <span class="string">'stderr'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, done_future)</span>:</span></span><br><span class="line">        self.done = done_future</span><br><span class="line">        self.buffer = bytearray()</span><br><span class="line">        super().__init__()</span><br></pre></td></tr></table></figure><p>ä¸ socket é€šä¿¡ä¸€æ ·ï¼Œåœ¨è®¾ç½®æ–°è¿›ç¨‹çš„è¾“å…¥é€šé“æ—¶è°ƒç”¨ <code>connection_made()</code>ã€‚<code>transport</code> å‚æ•°æ˜¯ <code>BaseSubprocessTransport</code> å­ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚å¦‚æœè¿›ç¨‹è¢«é…ç½®ä¸ºæ¥æ”¶è¾“å…¥ï¼Œåˆ™å®ƒå¯ä»¥è¯»å–è¿›ç¨‹è¾“å‡ºçš„æ•°æ®å¹¶å°†æ•°æ®å†™å…¥è¿›ç¨‹çš„è¾“å…¥æµï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connection_made</span><span class="params">(self, transport)</span>:</span></span><br><span class="line">    print(<span class="string">f'process started <span class="subst">&#123;transport.get_pid()&#125;</span>'</span>)</span><br><span class="line">    self.transport = transport</span><br></pre></td></tr></table></figure><p>å½“è¿›ç¨‹ç”Ÿæˆè¾“å‡ºæ—¶ï¼Œ<code>pipe_data_received()</code> å°†ä½¿ç”¨å‘é€æ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦å’Œä»ç®¡é“è¯»å–çš„å®é™…æ•°æ®ä½œä¸ºå‚æ•°è°ƒç”¨ã€‚<code>Protocol</code>ç±»å°†è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºé€šé“çš„è¾“å‡ºä¿å­˜åœ¨ç¼“å†²åŒºä¸­ï¼Œä»¥ä¾›ä»¥åå¤„ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pipe_data_received</span><span class="params">(self, fd, data)</span>:</span></span><br><span class="line">    print(<span class="string">f'read <span class="subst">&#123;len(data)&#125;</span> bytes from <span class="subst">&#123;self.FD_NAMES[fd]&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">if</span> fd == <span class="number">1</span>:</span><br><span class="line">        self.buffer.extend(data)</span><br></pre></td></tr></table></figure><p>å½“è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œ<code>process_exited()</code> å°†è¢«è°ƒç”¨ã€‚é€šè¿‡è°ƒç”¨ <code>get_returncode()</code> å¯ä»¥ä» <code>transport</code> å¯¹è±¡è·å¾—è¿›ç¨‹çš„é€€å‡ºä»£ç ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æŠ¥å‘Šé”™è¯¯ï¼Œåˆ™å¯ä»¥åœ¨é€šè¿‡ <code>future</code> å®ä¾‹è¿”å›å¯ç”¨è¾“å‡ºä¹‹å‰å¯¹å…¶è¿›è¡Œè§£ç å’Œåˆ†æã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œåˆ™ç»“æœä¸ºç©ºã€‚è®¾ç½® <code>future</code> çš„ç»“æœä¼šå‘Šè¯‰ <code>run_df()</code> è¿›ç¨‹å·²é€€å‡ºï¼Œå› æ­¤å®ƒä¼šæ¸…ç†å¹¶è¿”å›ç»“æœï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_exited</span><span class="params">(self)</span>:</span></span><br><span class="line">    print(<span class="string">'process exited'</span>)</span><br><span class="line">    return_code = self.transport.get_returncode()</span><br><span class="line">    print(<span class="string">f'return code <span class="subst">&#123;return_code&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> return_code:</span><br><span class="line">        cmd_output = bytes(self.buffer).decode()</span><br><span class="line">        results = self._parse_results(cmd_output)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        results = []</span><br><span class="line">    self.done.set_result((return_code, results))</span><br></pre></td></tr></table></figure><p>å‘½ä»¤çš„è¾“å‡ºè¢«è§£ææˆä¸€ç³»åˆ—å­—å…¸ï¼Œå°†æ¯è¡Œè¾“å‡ºçš„æ ‡é¢˜åç§°æ˜ å°„åˆ°å€¼ï¼Œå¹¶è¿”å›ç»“æœåˆ—è¡¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_parse_results</span><span class="params">(self, output)</span>:</span></span><br><span class="line">    print(<span class="string">'parsing results'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> output:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    lines = output.splitlines()</span><br><span class="line">    headers = lines[<span class="number">0</span>].split()</span><br><span class="line">    devices = lines[<span class="number">1</span>:]</span><br><span class="line">    results = [dict(zip(headers, line.split())) <span class="keyword">for</span> line <span class="keyword">in</span> devices]</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><p><code>run_df()</code> åç¨‹ä½¿ç”¨ <code>run_until_complete()</code> è¿è¡Œï¼Œç„¶åæ£€æŸ¥ç»“æœå¹¶æ‰“å°æ¯ä¸ªè®¾å¤‡ä¸Šçš„å¯ç”¨ç©ºé—´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    return_code, results = event_loop.run_until_complete(run_df(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> return_code:</span><br><span class="line">    print(<span class="string">f'error exit <span class="subst">&#123;return_code&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'\nFree space:'</span>)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;r[<span class="string">"Mounted"</span>]:<span class="number">25</span>&#125;</span>: <span class="subst">&#123;r[<span class="string">"Avail"</span>]&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„è¾“å‡ºæ˜¾ç¤ºäº†æ‰§è¡Œæ­¥éª¤çš„é¡ºåºï¼Œä»¥åŠç³»ç»Ÿä¸­é©±åŠ¨å™¨çš„å¯ç”¨ç©ºé—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">in run_df</span><br><span class="line">launching process</span><br><span class="line">process started 6170</span><br><span class="line">waiting for process to complete</span><br><span class="line">read 375 bytes from stdout</span><br><span class="line">process exited</span><br><span class="line">return code 0</span><br><span class="line">parsing results</span><br><span class="line"></span><br><span class="line">Free space:</span><br><span class="line">/                        : 41G</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="ç”¨åç¨‹å’Œæµè°ƒç”¨å­è¿›ç¨‹">ç”¨åç¨‹å’Œæµè°ƒç”¨å­è¿›ç¨‹</h3><p>è‹¥è¦ä½¿ç”¨åç¨‹ç›´æ¥è¿è¡Œè¿›ç¨‹ï¼Œè€Œä¸æ˜¯é€šè¿‡ <code>Protocol</code> å­ç±»è®¿é—®è¿›ç¨‹ï¼Œè¯·è°ƒç”¨ <code>create_subprocess_exec()</code>ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªè¿æ¥åˆ°ç®¡é“çš„æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯å’Œæ ‡å‡†è¾“å…¥ã€‚äº§ç”Ÿå­è¿›ç¨‹çš„åç¨‹çš„ç»“æœæ˜¯ä¸€ä¸ª <code>Process</code>Â å®ä¾‹ï¼Œå¯ç”¨äºæ“ä½œå­è¿›ç¨‹æˆ–ä¸å…¶é€šä¿¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> asyncio.subprocess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_df</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in run_df'</span>)</span><br><span class="line"></span><br><span class="line">    buffer = bytearray()</span><br><span class="line"></span><br><span class="line">    create = asyncio.create_subprocess_exec(</span><br><span class="line">        <span class="string">'df'</span>,</span><br><span class="line">        <span class="string">'-hl'</span>,</span><br><span class="line">        stdout=asyncio.subprocess.PIPE,</span><br><span class="line">    )</span><br><span class="line">    print(<span class="string">'launching process'</span>)</span><br><span class="line">    proc = <span class="keyword">await</span> create</span><br><span class="line">    print(<span class="string">f'process started <span class="subst">&#123;proc.pid&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>df</code> é™¤äº†å‘½ä»¤è¡Œå‚æ•°ä¹‹å¤–ä¸éœ€è¦ä»»ä½•è¾“å…¥ï¼Œå› æ­¤ä¸‹ä¸€æ­¥æ˜¯è¯»å–æ‰€æœ‰è¾“å‡ºã€‚å¯¹äº <code>Protocol</code>ï¼Œæ— æ³•æ§åˆ¶ä¸€æ¬¡è¯»å–å¤šå°‘æ•°æ®ã€‚è¿™ä¸ªä¾‹å­ä¸­ä½¿ç”¨äº† <code>readline()</code>ï¼Œä½†ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ <code>read()</code> è¯»å–ä¸æ˜¯æŒ‰è¡Œç»„ç»‡çš„æ•°æ®ã€‚å‘½ä»¤çš„è¾“å‡ºè¢«ç¼“å†²ï¼Œå°±åƒ <code>Protocol</code> ç¤ºä¾‹ä¸€æ ·ï¼Œå› æ­¤ç¨åå¯ä»¥å¯¹å…¶è¿›è¡Œåˆ†æï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    line = <span class="keyword">await</span> proc.stdout.readline()</span><br><span class="line">    print(<span class="string">f'read <span class="subst">&#123;line!r&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">        print(<span class="string">'no more output from command'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    buffer.extend(line)</span><br></pre></td></tr></table></figure><p><code>readline()</code> æ–¹æ³•åœ¨ç¨‹åºå·²å®Œæˆä¸å†æœ‰è¾“å‡ºæ—¶è¿”å›ç©ºå­—èŠ‚ä¸²ã€‚ä¸ºç¡®ä¿æ­£ç¡®æ¸…é™¤è¿›ç¨‹ï¼Œä¸‹ä¸€æ­¥æ˜¯ç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">'waiting for process to complete'</span>)</span><br><span class="line"><span class="keyword">await</span> proc.wait()</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥æ£€æŸ¥é€€å‡ºçŠ¶æ€ï¼Œä»¥ç¡®å®šæ˜¯è§£æè¾“å‡ºè¿˜æ˜¯å°†é”™è¯¯è§†ä¸ºæœªç”Ÿæˆè¾“å‡ºã€‚è§£æé€»è¾‘ä¸å‰é¢çš„ç¤ºä¾‹ç›¸åŒï¼Œä½†å¤„äºç‹¬ç«‹å‡½æ•°ä¸­ï¼Œå› ä¸ºæ²¡æœ‰å¯ä»¥åŒ…è£…å®ƒçš„ <code>Protocol</code> ç±»ã€‚è§£ææ•°æ®åï¼Œç»“æœå’Œé€€å‡ºä»£ç å°†è¿”å›ç»™è°ƒç”¨æ–¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">return_code = proc.returncode</span><br><span class="line">print(<span class="string">f'return code <span class="subst">&#123;return_code&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> return_code:</span><br><span class="line">    cmd_output = bytes(buffer).decode()</span><br><span class="line">    results = _parse_results(cmd_output)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    results = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (return_code, results)</span><br></pre></td></tr></table></figure><p>ä¸»ç¨‹åºçœ‹èµ·æ¥ç±»ä¼¼äºåŸºäº <code>Protocol</code> çš„ç¤ºä¾‹ï¼Œå› ä¸ºå®ç°çš„æ”¹å˜è¢«éš”ç¦»åœ¨ <code>run_df()</code> ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    return_code, results = event_loop.run_until_complete(run_df())</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> return_code:</span><br><span class="line">    print(<span class="string">f'error exit <span class="subst">&#123;return_code&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'\nFree space:'</span>)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;r[<span class="string">"Mounted"</span>]:<span class="number">25</span>&#125;</span>: <span class="subst">&#123;r[<span class="string">"Avail"</span>]&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>ç”±äº <code>df</code> çš„è¾“å‡ºå¯ä»¥ä¸€æ¬¡è¯»å–ä¸€è¡Œï¼Œå› æ­¤å®ƒå°†æ˜¾ç¤ºç¨‹åºçš„è¿›åº¦ã€‚å¦åˆ™ï¼Œè¾“å‡ºçœ‹èµ·æ¥ä¸å‰é¢çš„ç¤ºä¾‹ç±»ä¼¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">in run_df</span><br><span class="line">launching process</span><br><span class="line">process started 7354</span><br><span class="line">read b'Filesystem      Size  Used Avail Use% Mounted on\n'</span><br><span class="line">read b'/dev/vda1        50G  6.0G   41G  13% /\n'</span><br><span class="line">...</span><br><span class="line">read b''</span><br><span class="line">no more output from command</span><br><span class="line">waiting for process to complete</span><br><span class="line">return code 0</span><br><span class="line">parsing results</span><br><span class="line"></span><br><span class="line">Free space:</span><br><span class="line">/                        : 41G</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="å‘å­è¿›ç¨‹å‘é€æ•°æ®">å‘å­è¿›ç¨‹å‘é€æ•°æ®</h3><p>å‰é¢çš„ä¸¤ä¸ªç¤ºä¾‹éƒ½ä»…ä½¿ç”¨å•ä¸ªé€šä¿¡ä¿¡é“æ¥ä»å­è¿›ç¨‹è¯»å–æ•°æ®ã€‚é€šå¸¸éœ€è¦å°†æ•°æ®å‘é€åˆ°å‘½ä»¤ä¸­è¿›è¡Œå¤„ç†ã€‚ä¸‹é¢å°†å®šä¹‰ä¸€ä¸ªåç¨‹ï¼Œç”¨äºæ‰§è¡Œ Unix å‘½ä»¤ <code>tr</code> ä»¥è½¬æ¢å…¶è¾“å…¥æµä¸­çš„å­—ç¬¦ã€‚è¿™ä¸ªä¾‹å­ä¸­<code>tr</code> ç”¨äºå°†å°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯ã€‚</p><p><code>to_upper()</code> åç¨‹å°†è¾“å…¥å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ã€‚å®ƒäº§ç”Ÿè¿è¡Œ <code>trÂ [:lower:]Â [:upper:]</code> çš„å­è¿›ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> asyncio.subprocess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">to_upper</span><span class="params">(input)</span>:</span></span><br><span class="line">    print(<span class="string">'in to_upper'</span>)</span><br><span class="line"></span><br><span class="line">    create = asyncio.create_subprocess_exec(</span><br><span class="line">        <span class="string">'tr'</span>,</span><br><span class="line">        <span class="string">'[:lower:]'</span>,</span><br><span class="line">        <span class="string">'[:upper:]'</span>,</span><br><span class="line">        stdout=asyncio.subprocess.PIPE,</span><br><span class="line">        stdin=asyncio.subprocess.PIPE,</span><br><span class="line">    )</span><br><span class="line">    print(<span class="string">'launching process'</span>)</span><br><span class="line">    proc = <span class="keyword">await</span> create</span><br><span class="line">    print(<span class="string">f'pid <span class="subst">&#123;proc.pid&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ <code>to_upper()</code> ä½¿ç”¨ <code>Process</code> çš„ <code>communicate()</code> æ–¹æ³•å°†è¾“å…¥å­—ç¬¦ä¸²å‘é€åˆ°å‘½ä»¤ï¼Œå¹¶å¼‚æ­¥è¯»å–æ‰€æœ‰ç”Ÿæˆçš„è¾“å‡ºã€‚ä¸ <code>subprocess.Popen</code> ç‰ˆæœ¬çš„æ–¹æ³•ç›¸åŒï¼Œ<code>communicate()</code>Â  è¿”å›å®Œæ•´çš„è¾“å‡ºå­—èŠ‚ä¸²ã€‚å¦‚æœä¸€ä¸ªå‘½ä»¤å¯èƒ½äº§ç”Ÿçš„æ•°æ®è¶…å‡ºäº†å¯ä»¥å……è£•çš„æ”¾å…¥å†…å­˜çš„èŒƒå›´ï¼Œæˆ–è€…æ— æ³•ä¸€æ¬¡äº§ç”Ÿè¾“å…¥ï¼Œæˆ–è€…å¿…é¡»å¢é‡å¤„ç†è¾“å‡ºï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨è¿›ç¨‹çš„ <code>stdin</code>ã€<code>stdout</code> å’Œ <code>stderr</code> å¥æŸ„ï¼Œè€Œä¸æ˜¯è°ƒç”¨ <code>communicate()</code> ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">'communicating with process'</span>)</span><br><span class="line">stdout, stderr = <span class="keyword">await</span> proc.communicate(input.encode())</span><br></pre></td></tr></table></figure><p>I / O å®Œæˆåï¼Œç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡ºå¯ç¡®ä¿è¿›ç¨‹å¾—åˆ°æ­£ç¡®æ¸…ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">'waiting for process to complete'</span>)</span><br><span class="line"><span class="keyword">await</span> proc.wait()</span><br></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥æ£€æŸ¥è¿”å›ä»£ç ï¼Œå¹¶å¯¹è¾“å‡ºå­—èŠ‚ä¸²è¿›è¡Œè§£ç ï¼Œä»¥å‡†å¤‡åç¨‹çš„è¿”å›å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">return_code = proc.returncode</span><br><span class="line">print(<span class="string">f'return code <span class="subst">&#123;return_code&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> return_code:</span><br><span class="line">    results = bytes(stdout).decode()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    results = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (return_code, results)</span><br></pre></td></tr></table></figure><p>ç¨‹åºçš„ä¸»è¦éƒ¨åˆ†æ„å»ºè¦è½¬æ¢çš„æ¶ˆæ¯å­—ç¬¦ä¸²ï¼Œç„¶åè®¾ç½®äº‹ä»¶å¾ªç¯ä»¥è¿è¡Œ <code>to_upper()</code> å¹¶æ‰“å°ç»“æœï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MESSAGE = <span class="string">"""</span></span><br><span class="line"><span class="string">This message will be converted</span></span><br><span class="line"><span class="string">to all caps.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    return_code, results = event_loop.run_until_complete(to_upper(MESSAGE))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> return_code:</span><br><span class="line">    print(<span class="string">f'error exit <span class="subst">&#123;return_code&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">f'Original: <span class="subst">&#123;MESSAGE!r&#125;</span>'</span>.format(MESSAGE))</span><br><span class="line">    print(<span class="string">f'Changed : <span class="subst">&#123;results!r&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>è¾“å‡ºæ˜¾ç¤ºæ“ä½œåºåˆ—ï¼Œç„¶åæ˜¾ç¤ºå¦‚ä½•è½¬æ¢ç®€å•æ–‡æœ¬æ¶ˆæ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">in to_upper</span><br><span class="line">launching process</span><br><span class="line">pid 12428</span><br><span class="line">communicating with process</span><br><span class="line">waiting for process to complete</span><br><span class="line">return code 0</span><br><span class="line">Original: '\nThis message will be converted\nto all caps.\n'</span><br><span class="line">Changed : '\nTHIS MESSAGE WILL BE CONVERTED\nTO ALL CAPS.\n'</span><br></pre></td></tr></table></figure><h2 id="æ¥æ”¶-unix-ä¿¡å·">æ¥æ”¶ Unix ä¿¡å·</h2><p>UNIX ç³»ç»Ÿäº‹ä»¶é€šçŸ¥é€šå¸¸ä¼šä¸­æ–­åº”ç”¨ç¨‹åºï¼Œä»è€Œè§¦å‘å…¶å¤„ç†ç¨‹åºã€‚å½“ä¸ <code>asyncio</code> ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œä¿¡å·å¤„ç†ç¨‹åºå›è°ƒä¸äº‹ä»¶å¾ªç¯ç®¡ç†çš„å…¶ä»–åç¨‹å’Œå›è°ƒäº¤é”™æ‰§è¡Œã€‚è¿™å¯¼è‡´ä¸­æ–­å‡½æ•°è¾ƒå°‘ï¼Œå› æ­¤éœ€è¦æä¾›å®‰å…¨é˜²æŠ¤æ¥æ¸…ç†ä¸å®Œæ•´çš„æ“ä½œã€‚</p><p>ä¿¡å·å¤„ç†ç¨‹åºå¿…é¡»æ˜¯å¸¸è§„çš„å¯è°ƒç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯åç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signal_handler</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">f'signal_handler(<span class="subst">&#123;name!r&#125;</span>)'</span>)</span><br></pre></td></tr></table></figure><p>ä¿¡å·å¤„ç†ç¨‹åºæ˜¯ä½¿ç”¨ <code>add_signal_handler()</code> æ³¨å†Œçš„ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¿¡å·ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å›è°ƒã€‚å›è°ƒä¸ä¼ é€’å‚æ•°ï¼Œå› æ­¤å¦‚æœéœ€è¦å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ <code>functools.partical()</code> åŒ…è£…å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line">event_loop.add_signal_handler(</span><br><span class="line">    signal.SIGHUP,</span><br><span class="line">    functools.partial(signal_handler, name=<span class="string">'SIGHUP'</span>),</span><br><span class="line">)</span><br><span class="line">event_loop.add_signal_handler(</span><br><span class="line">    signal.SIGUSR1,</span><br><span class="line">    functools.partial(signal_handler, name=<span class="string">'SIGUSR1'</span>),</span><br><span class="line">)</span><br><span class="line">event_loop.add_signal_handler(</span><br><span class="line">    signal.SIGINT,</span><br><span class="line">    functools.partial(signal_handler, name=<span class="string">'SIGINT'</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>æœ¬ç¤ºä¾‹ç¨‹åºä½¿ç”¨åç¨‹é€šè¿‡ <code>os.kill()</code> å‘è‡ªèº«å‘é€ä¿¡å·ã€‚åœ¨å‘é€æ¯ä¸ªä¿¡å·ä¹‹åï¼Œåç¨‹å°†è®©å‡ºæ§åˆ¶æƒä»¥å…è®¸å¤„ç†ç¨‹åºæ‰§è¡Œã€‚åœ¨ä¸€ä¸ªæ­£å¸¸çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¼šæœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºä»£ç è®©æ­¥ç»™äº‹ä»¶å¾ªç¯çš„åœ°æ–¹ï¼Œè€Œä¸éœ€è¦è¿™æ ·çš„äººå·¥è®©æ­¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_signals</span><span class="params">()</span>:</span></span><br><span class="line">    pid = os.getpid()</span><br><span class="line">    print(<span class="string">f'starting send_signals for <span class="subst">&#123;pid&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">'SIGHUP'</span>, <span class="string">'SIGHUP'</span>, <span class="string">'SIGUSR1'</span>, <span class="string">'SIGINT'</span>]:</span><br><span class="line">        print(<span class="string">f'sending <span class="subst">&#123;name&#125;</span>'</span>)</span><br><span class="line">        os.kill(pid, getattr(signal, name))</span><br><span class="line">        print(<span class="string">'yielding control'</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>ä¸»ç¨‹åºè¿è¡Œ <code>send_signals()</code>ï¼Œç›´åˆ°å®ƒå‘é€å®Œæ‰€æœ‰ä¿¡å·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(send_signals())</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>è¾“å‡ºæ˜¾ç¤ºå½“ <code>send_signals()</code> åœ¨å‘é€ä¿¡å·åè®©å‡ºæ§åˆ¶æ—¶å¦‚ä½•è°ƒç”¨å¤„ç†ç¨‹åºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">starting send_signals for 23185</span><br><span class="line">sending SIGHUP</span><br><span class="line">yielding control</span><br><span class="line">signal_handler('SIGHUP')</span><br><span class="line">sending SIGHUP</span><br><span class="line">yielding control</span><br><span class="line">signal_handler('SIGHUP')</span><br><span class="line">sending SIGUSR1</span><br><span class="line">yielding control</span><br><span class="line">signal_handler('SIGUSR1')</span><br><span class="line">sending SIGINT</span><br><span class="line">yielding control</span><br><span class="line">signal_handler('SIGINT')</span><br></pre></td></tr></table></figure><h2 id="å°†åç¨‹ä¸çº¿ç¨‹å’Œè¿›ç¨‹ç›¸ç»“åˆ">å°†åç¨‹ä¸çº¿ç¨‹å’Œè¿›ç¨‹ç›¸ç»“åˆ</h2><p>è®¸å¤šç°æœ‰åº“å°šæœªå‡†å¤‡å¥½ä¸ <code>asyncio</code> é…åˆä½¿ç”¨ã€‚å®ƒä»¬å¯èƒ½ä¼šé˜»å¡æˆ–ä¾èµ–æ¨¡å—ä¸­ä¸å¯ç”¨çš„å¹¶å‘åŠŸèƒ½ã€‚é€šè¿‡ä½¿ç”¨æ¥è‡ª <code>concurrent.futures</code> çš„ <code>executor</code> åœ¨å•ç‹¬çš„çº¿ç¨‹æˆ–å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œä»£ç ï¼Œä»ç„¶å¯ä»¥åœ¨åŸºäº <code>asyncio</code> çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¿™äº›åº“ã€‚</p><h3 id="çº¿ç¨‹">çº¿ç¨‹</h3><p>äº‹ä»¶å¾ªç¯çš„ <code>run_in_executor()</code> æ–¹æ³•æ¥å—çš„å‚æ•°ä¸º <code>executor</code> å®ä¾‹ï¼Œè¦è°ƒç”¨çš„å¸¸è§„å¯è°ƒç”¨å¯¹è±¡ä»¥åŠè¦ä¼ é€’ç»™å¯è°ƒç”¨å¯¹è±¡çš„ä»»ä½•å‚æ•°ã€‚å®ƒè¿”å›ä¸€ä¸ªå¯ç”¨äºç­‰å¾…å‡½æ•°å®Œæˆå…¶å·¥ä½œå¹¶è¿”å›æŸäº›å†…å®¹çš„ <code>future</code>ã€‚å¦‚æœæ²¡æœ‰ä¼ å…¥ <code>executor</code>ï¼Œåˆ™ä¼šåˆ›å»º <code>ThreadPoolExecutor</code>ã€‚æ­¤ç¤ºä¾‹æ˜¾å¼åˆ›å»ºä¸€ä¸ª <code>executor</code>ï¼Œä»¥é™åˆ¶å¯ç”¨çš„å·¥ä½œçº¿ç¨‹æ•°ã€‚</p><p><code>ThreadPoolExecutor</code>å¯åŠ¨å…¶å·¥ä½œçº¿ç¨‹ï¼Œç„¶ååœ¨çº¿ç¨‹ä¸­è°ƒç”¨æ¯ä¸ªæä¾›çš„å‡½æ•°ä¸€æ¬¡ã€‚æ­¤ç¤ºä¾‹è¯´æ˜å¦‚ä½•å°† <code>run_in_executor()</code> å’Œ <code>wait()</code> ç»„åˆèµ·æ¥ï¼Œä»¥ä¾¿åœ¨é˜»å¡å•ç‹¬çº¿ç¨‹ä¸­è¿è¡Œçš„å‡½æ•°çš„åŒæ—¶ï¼Œå¯¹äº‹ä»¶å¾ªç¯å…·æœ‰åç¨‹è®©æ­¥æ§åˆ¶ï¼Œç„¶ååœ¨è¿™äº›å‡½æ•°å®Œæˆæ—¶å°†å…¶å”¤é†’ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blocks</span><span class="params">(n)</span>:</span></span><br><span class="line">    log = logging.getLogger(<span class="string">f'blocks(<span class="subst">&#123;n&#125;</span>)'</span>)</span><br><span class="line">    log.info(<span class="string">'running'</span>)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    log.info(<span class="string">'done'</span>)</span><br><span class="line">    <span class="keyword">return</span> n**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_blocking_tasks</span><span class="params">(executor)</span>:</span></span><br><span class="line">    log = logging.getLogger(<span class="string">'run_blocking_tasks'</span>)</span><br><span class="line">    log.info(<span class="string">'starting'</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">'creating executor tasks'</span>)</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    blocking_tasks = [loop.run_in_executor(executor, blocks, i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>)]</span><br><span class="line">    log.info(<span class="string">'waiting for executor tasks'</span>)</span><br><span class="line">    completed, pending = <span class="keyword">await</span> asyncio.wait(blocking_tasks)</span><br><span class="line">    results = [t.result() <span class="keyword">for</span> t <span class="keyword">in</span> completed]</span><br><span class="line">    log.info(<span class="string">f'results: <span class="subst">&#123;results!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">'exiting'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        format=<span class="string">'%(threadName)10s %(name)18s: %(message)s'</span>,</span><br><span class="line">        stream=sys.stderr,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    executor = concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">3</span>,)</span><br><span class="line"></span><br><span class="line">    event_loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        event_loop.run_until_complete(run_blocking_tasks(executor))</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        event_loop.close()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºä½¿ç”¨ <code>logging</code> æ¥æ–¹ä¾¿åœ°æŒ‡ç¤ºå“ªäº›çº¿ç¨‹å’Œå‡½æ•°æ­£åœ¨ç”Ÿæˆçš„æ—¥å¿—æ¶ˆæ¯ã€‚å› ä¸ºæ¯æ¬¡è°ƒç”¨ <code>blocks()</code> æ—¶ä½¿ç”¨å•ç‹¬çš„ <code>Logger</code>ï¼Œæ‰€ä»¥è¾“å‡ºæ¸…æ¥šåœ°æ˜¾ç¤ºäº†ç›¸åŒçš„çº¿ç¨‹è¢«é‡ç”¨ï¼Œä»¥è°ƒç”¨å…·æœ‰ä¸åŒå‚æ•°çš„å‡½æ•°çš„å¤šä¸ªå‰¯æœ¬ï¼š</p><p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MainThread run_blocking_tasks: starting</span><br><span class="line">MainThread run_blocking_tasks: creating executor tasks</span><br><span class="line">ThreadPoolExecutor-0_0          blocks(0): running</span><br><span class="line">ThreadPoolExecutor-0_1          blocks(1): running</span><br><span class="line">ThreadPoolExecutor-0_2          blocks(2): running</span><br><span class="line">MainThread run_blocking_tasks: waiting for executor tasks</span><br><span class="line">ThreadPoolExecutor-0_0          blocks(0): done</span><br><span class="line">ThreadPoolExecutor-0_0          blocks(3): running</span><br><span class="line">ThreadPoolExecutor-0_1          blocks(1): done</span><br><span class="line">ThreadPoolExecutor-0_2          blocks(2): done</span><br><span class="line">ThreadPoolExecutor-0_1          blocks(4): running</span><br><span class="line">ThreadPoolExecutor-0_2          blocks(5): running</span><br><span class="line">ThreadPoolExecutor-0_0          blocks(3): done</span><br><span class="line">ThreadPoolExecutor-0_1          blocks(4): done</span><br><span class="line">ThreadPoolExecutor-0_2          blocks(5): done</span><br><span class="line">MainThread run_blocking_tasks: results: [16, 25, 1, 4, 0, 9]</span><br><span class="line">MainThread run_blocking_tasks: exiting</span><br></pre></td></tr></table></figure></p><h3 id="è¿›ç¨‹">è¿›ç¨‹</h3><p><code>ProcessPoolExecutor</code> çš„å·¥ä½œæ–¹å¼å¤§è‡´ç›¸åŒï¼Œå®ƒåˆ›å»ºä¸€ç»„å·¥ä½œè¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ã€‚ä½¿ç”¨å•ç‹¬çš„è¿›ç¨‹éœ€è¦æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œä½†æ˜¯å¯¹äºè®¡ç®—å¯†é›†å‹æ“ä½œï¼Œåœ¨æ¯ä¸ª CPU å†…æ ¸ä¸Šè¿è¡Œå•ç‹¬çš„ä»»åŠ¡æ˜¯æœ‰æ„ä¹‰çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        format=<span class="string">'PID %(process)5s %(name)18s: %(message)s'</span>,</span><br><span class="line">        stream=sys.stderr,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    executor = concurrent.futures.ProcessPoolExecutor(max_workers=<span class="number">3</span>,)</span><br><span class="line"></span><br><span class="line">    event_loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        event_loop.run_until_complete(run_blocking_tasks(executor))</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        event_loop.close()</span><br></pre></td></tr></table></figure><p>ä»çº¿ç¨‹è½¬ç§»åˆ°è¿›ç¨‹æ‰€éœ€çš„å”¯ä¸€æ›´æ”¹æ˜¯åˆ›å»ºä¸åŒç±»å‹çš„ <code>executor</code>ã€‚æœ¬ç¤ºä¾‹è¿˜å°†æ—¥å¿—è®°å½•æ ¼å¼æ›´æ”¹ä¸ºåŒ…å«è¿›ç¨‹ id è€Œä¸æ˜¯çº¿ç¨‹åç§°ï¼Œä»¥è¯æ˜ä»»åŠ¡å®é™…ä¸Šæ­£åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PID 24417 run_blocking_tasks: starting</span><br><span class="line">PID 24417 run_blocking_tasks: creating executor tasks</span><br><span class="line">PID 24417 run_blocking_tasks: waiting for executor tasks</span><br><span class="line">PID 24461          blocks(0): running</span><br><span class="line">PID 24460          blocks(1): running</span><br><span class="line">PID 24459          blocks(2): running</span><br><span class="line">PID 24460          blocks(1): done</span><br><span class="line">PID 24459          blocks(2): done</span><br><span class="line">PID 24460          blocks(3): running</span><br><span class="line">PID 24461          blocks(0): done</span><br><span class="line">PID 24459          blocks(4): running</span><br><span class="line">PID 24461          blocks(5): running</span><br><span class="line">PID 24460          blocks(3): done</span><br><span class="line">PID 24459          blocks(4): done</span><br><span class="line">PID 24461          blocks(5): done</span><br><span class="line">PID 24417 run_blocking_tasks: results: [16, 1, 25, 0, 4, 9]</span><br><span class="line">PID 24417 run_blocking_tasks: exiting</span><br></pre></td></tr></table></figure><h2 id="è°ƒè¯•">è°ƒè¯•</h2><p><code>asyncio</code> å†…ç½®äº†å‡ ä¸ªæœ‰ç”¨çš„è°ƒè¯•åŠŸèƒ½ã€‚</p><p>é¦–å…ˆï¼Œäº‹ä»¶å¾ªç¯ä½¿ç”¨ <code>logging</code> åœ¨è¿è¡Œæ—¶å‘å‡ºçŠ¶æ€æ¶ˆæ¯ã€‚å¦‚æœåœ¨åº”ç”¨ç¨‹åºä¸­å¯ç”¨äº†æ—¥å¿—è®°å½•ï¼Œåˆ™å…¶ä¸­ä¸€äº›æ˜¯å¯ç”¨çš„ã€‚å…¶ä»–çš„å¯ä»¥é€šè¿‡å‘Šè¯‰å¾ªç¯å‘å‡ºæ›´å¤šè°ƒè¯•æ¶ˆæ¯æ¥æ‰“å¼€ã€‚è°ƒç”¨ <code>set_debug()</code>ï¼Œä¼ é€’ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦åº”å¯ç”¨è°ƒè¯•ã€‚</p><p>ç”±äºåŸºäº <code>asyncio</code> æ„å»ºçš„åº”ç”¨ç¨‹åºå¯¹æ— æ³•è®©å‡ºæ§åˆ¶çš„â€œè´ªå©ªâ€åç¨‹éå¸¸æ•æ„Ÿï¼Œå› æ­¤æ”¯æŒæ£€æµ‹äº‹ä»¶å¾ªç¯ä¸­çš„ç¼“æ…¢å›è°ƒã€‚é€šè¿‡å¯ç”¨è°ƒè¯•å°†å…¶æ‰“å¼€ï¼Œå¹¶é€šè¿‡å°†å¾ªç¯çš„ <code>slow_callback_duration</code> å±æ€§è®¾ç½®ä¸ºåº”å‘å‡ºè­¦å‘Šçš„ç§’æ•°æ¥å®šä¹‰ â€œç¼“æ…¢â€ã€‚</p><p>æœ€åï¼Œå¦‚æœä½¿ç”¨ <code>asyncio</code> çš„åº”ç”¨ç¨‹åºåœ¨ä¸æ¸…ç†æŸäº›åç¨‹æˆ–å…¶ä»–èµ„æºçš„æƒ…å†µä¸‹é€€å‡ºï¼Œè¿™å¯èƒ½æ„å‘³ç€å­˜åœ¨é€»è¾‘é”™è¯¯ï¼Œæ— æ³•è¿è¡ŒæŸäº›åº”ç”¨ç¨‹åºä»£ç ã€‚å¯ç”¨ <code>ResourceWarning</code> è­¦å‘Šä¼šåœ¨ç¨‹åºé€€å‡ºæ—¶æŠ¥å‘Šè¿™äº›æƒ…å†µï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(<span class="string">'debugging asyncio'</span>)</span><br><span class="line">parser.add_argument(</span><br><span class="line">    <span class="string">'-v'</span>,</span><br><span class="line">    dest=<span class="string">'verbose'</span>,</span><br><span class="line">    default=<span class="keyword">False</span>,</span><br><span class="line">    action=<span class="string">'store_true'</span>,</span><br><span class="line">)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    format=<span class="string">'%(levelname)7s: %(message)s'</span>,</span><br><span class="line">    stream=sys.stderr,</span><br><span class="line">)</span><br><span class="line">LOG = logging.getLogger(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">()</span>:</span></span><br><span class="line">    LOG.info(<span class="string">'inner starting'</span>)</span><br><span class="line">    <span class="comment"># æ¨¡æ‹Ÿç¼“æ…¢çš„ä»»åŠ¡</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    LOG.info(<span class="string">'inner completed'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">outer</span><span class="params">(loop)</span>:</span></span><br><span class="line">    LOG.info(<span class="string">'outer starting'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.ensure_future(loop.create_task(inner()))</span><br><span class="line">    LOG.info(<span class="string">'outer completed'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">if</span> args.verbose:</span><br><span class="line">    LOG.info(<span class="string">'enabling debugging'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯ç”¨è°ƒè¯•</span></span><br><span class="line">    event_loop.set_debug(<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®šä¹‰ä¸€ä¸ªå¾ˆå°é˜ˆå€¼è¡¨ç¤ºâ€œç¼“æ…¢â€</span></span><br><span class="line">    event_loop.slow_callback_duration = <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŠ¥å‘Šç®¡ç†å¼‚æ­¥èµ„æºçš„æ‰€æœ‰é”™è¯¯</span></span><br><span class="line">    warnings.simplefilter(<span class="string">'always'</span>, ResourceWarning)</span><br><span class="line"></span><br><span class="line">LOG.info(<span class="string">'entering event loop'</span>)</span><br><span class="line">event_loop.run_until_complete(outer(event_loop))</span><br></pre></td></tr></table></figure><p>åœ¨æœªå¯ç”¨è°ƒè¯•çš„æƒ…å†µä¸‹è¿è¡Œæ—¶ï¼Œæ­¤åº”ç”¨ç¨‹åºçš„æ‰€æœ‰å†…å®¹çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DEBUG: Using selector: SelectSelector</span><br><span class="line"> INFO: entering event loop</span><br><span class="line"> INFO: outer starting</span><br><span class="line"> INFO: inner starting</span><br><span class="line"> INFO: inner completed</span><br><span class="line"> INFO: outer completed</span><br></pre></td></tr></table></figure><p>å¼€å¯è°ƒè¯•ä¼šæš´éœ²å‡ºä¸€äº›é—®é¢˜ï¼ŒåŒ…æ‹¬ <code>inner()</code> å®Œæˆæ‰€èŠ±çš„æ—¶é—´æ¯”è®¾å®šçš„ <code>slow_callback_duration</code>Â è¿˜è¦é•¿ï¼Œè€Œä¸”å½“ç¨‹åºç»“æŸæ—¶ï¼Œäº‹ä»¶å¾ªç¯å¹¶æœªæ­£ç¡®å…³é—­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  DEBUG: Using selector: SelectSelector</span><br><span class="line">   INFO: enabling debugging</span><br><span class="line">   INFO: entering event loop</span><br><span class="line">   INFO: outer starting</span><br><span class="line">   INFO: inner starting</span><br><span class="line">   INFO: inner completed</span><br><span class="line">WARNING: Executing &lt;Task finished coro=&lt;inner() done, defined at *.py:25&gt; result=None created at *.py:33&gt; took 0.093 seconds</span><br><span class="line">   INFO: outer completed</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¹¦æ¥ä¸Šæ–‡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç”¨åç¨‹å’Œæµå®ç°å¼‚æ­¥-i-o&quot;&gt;ç”¨åç¨‹å’Œæµå®ç°å¼‚æ­¥ I / O&lt;/h2&gt;
&lt;p&gt;æœ¬èŠ‚å°†é‡æ–°å®ç° echo æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ä¸¤ä¸ªç¤ºä¾‹ç¨‹åºï¼Œåªä¸è¿‡ä¼šä½¿ç”¨åç¨‹å’Œ &lt;code&gt;asyncio&lt;/code&gt; æµ API è€Œä¸æ˜¯
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Kafkaåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ-1</title>
    <link href="http://weafteam.github.io/posts/6e26f2f1/"/>
    <id>http://weafteam.github.io/posts/6e26f2f1/</id>
    <published>2018-05-07T10:13:02.000Z</published>
    <updated>2018-08-12T09:51:01.075Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h1><p>ä¹‹å‰æˆ‘è®²è¿‡å…³äºSpringBootæ•´åˆKafkaçš„demo,ä½†æ˜¯åæ¥ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œè¶Šæ¥ä¸å‘ç°è¿™ä¸ªå·²ç»ä¸èƒ½é€‚åˆæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„ç¯å¢ƒäº†ã€‚</p><p>ä¹‹å‰æ˜¯ç®€å•çš„å‘é€æ¶ˆæ¯è€Œå·²ï¼Œè€Œç°åœ¨æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªé«˜ååé‡çš„webä¸­é—´ä»¶ã€‚</p><p>ç°åœ¨æ¯ç§’å¤§æ¦‚èƒ½å‘é€1000æ¡å·¦å³çš„æ•°æ®ï¼Œä½†æ˜¯æ¥å—è¿™è¾¹å¹¶ä¸èƒ½æ‰¿å—è¿™ä¹ˆé«˜çš„ååé‡ï¼Œå¯¼è‡´kafkaæ¶ˆæ¯å †ç§¯ï¼Œæ¶ˆæ¯å †ç§¯çš„è¶Šæ¥è¶Šå¤šã€‚</p><p>æ°å·§æˆ‘ä»¬çš„äº§å“æ‰€éœ€è¦çš„æ•°æ®å®æ—¶æ€§éå¸¸é«˜ã€‚æ‰€ä»¥è¿™ä¸å¾—ä»¥æˆ‘è¦æ”¹è¿›æˆ‘è¯»çš„é€Ÿåº¦ã€‚</p><h1 id="äºŒå…¥é—¨">äºŒã€å…¥é—¨</h1><p>ç®€å•ä»‹ç»ä¸€ç‚¹ç›¸å…³çš„æ¦‚å¿µ</p><h3 id="æ¶ˆè´¹æ¶ˆæ¯åŸºæœ¬æµç¨‹">2.1 æ¶ˆè´¹æ¶ˆæ¯åŸºæœ¬æµç¨‹</h3><p>Kafka è®¢é˜…è€…åœ¨è®¢é˜…æ¶ˆæ¯æ—¶çš„åŸºæœ¬æµç¨‹æ˜¯ï¼š</p><ol type="1"><li>Poll æ•°æ®</li><li>æ‰§è¡Œæ¶ˆè´¹é€»è¾‘</li><li>å†æ¬¡ poll æ•°æ®</li></ol><h3 id="è´Ÿè½½å‡è¡¡">2.2 è´Ÿè½½å‡è¡¡</h3><p>æ¯ä¸ª Consumer Group å¯ä»¥åŒ…å«å¤šä¸ªæ¶ˆè´¹å®ä¾‹ï¼Œå³å¯ä»¥å¯åŠ¨å¤šä¸ª Kafka Consumerï¼Œå¹¶æŠŠå‚æ•° group.id è®¾ç½®æˆç›¸åŒçš„å€¼ã€‚å±äºåŒä¸€ä¸ª Consumer Group çš„æ¶ˆè´¹å®ä¾‹ä¼šè´Ÿè½½æ¶ˆè´¹è®¢é˜…çš„ Topicã€‚</p><p>ä¸¾ä¾‹ï¼šConsumer Group A è®¢é˜…äº† Topic Aï¼Œå¹¶å¼€å¯ä¸‰ä¸ªæ¶ˆè´¹å®ä¾‹ C1ã€C2ã€C3ï¼Œåˆ™å‘é€åˆ° Topic A çš„æ¯æ¡æ¶ˆæ¯æœ€ç»ˆåªä¼šä¼ ç»™ C1ã€C2ã€C3 çš„æŸä¸€ä¸ªã€‚Kafka é»˜è®¤ä¼šå‡åŒ€åœ°æŠŠæ¶ˆæ¯ä¼ ç»™å„ä¸ªæ¶ˆæ¯å®ä¾‹ï¼Œä»¥åšåˆ°æ¶ˆè´¹è´Ÿè½½å‡è¡¡ã€‚</p><p>Kafka è´Ÿè½½æ¶ˆè´¹çš„å†…éƒ¨åŸç†æ˜¯ï¼ŒæŠŠè®¢é˜…çš„ Topic çš„åˆ†åŒºï¼Œå¹³å‡åˆ†é…ç»™å„ä¸ªæ¶ˆè´¹å®ä¾‹ã€‚å› æ­¤ï¼Œæ¶ˆè´¹å®ä¾‹çš„ä¸ªæ•°ä¸è¦å¤§äºåˆ†åŒºçš„æ•°é‡ï¼Œå¦åˆ™ä¼šæœ‰å®ä¾‹åˆ†é…ä¸åˆ°ä»»ä½•åˆ†åŒºè€Œå¤„äºç©ºè·‘çŠ¶æ€ã€‚è¿™ä¸ªè´Ÿè½½å‡è¡¡å‘ç”Ÿçš„æ—¶é—´ï¼Œé™¤äº†ç¬¬ä¸€æ¬¡å¯åŠ¨ä¸Šçº¿ä¹‹å¤–ï¼Œåç»­æ¶ˆè´¹å®ä¾‹å‘ç”Ÿé‡å¯ã€å¢åŠ ã€å‡å°‘ç­‰å˜æ›´æ—¶ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡è´Ÿè½½å‡è¡¡ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ— Kafka çš„æ¯ä¸ª Topic çš„åˆ†åŒºæ•°é‡é»˜è®¤æ˜¯ 16 ä¸ªï¼Œå·²ç»è¶³å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯çš„éœ€æ±‚ï¼Œä¸”äº‘ä¸ŠæœåŠ¡ä¼šæ ¹æ®å®¹é‡è°ƒæ•´åˆ†åŒºæ•°ã€‚</p><h3 id="å¤šä¸ªè®¢é˜…">2.3 å¤šä¸ªè®¢é˜…</h3><p>ä¸€ä¸ª Consumer Group å¯ä»¥è®¢é˜…å¤šä¸ª Topicã€‚ä¸€ä¸ª Topic ä¹Ÿå¯ä»¥è¢«å¤šä¸ª Consumer Group è®¢é˜…ï¼Œä¸”å„ä¸ª Consumer Group ç‹¬ç«‹æ¶ˆè´¹ Topic ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯ã€‚</p><p>ä¸¾ä¾‹ï¼šConsumer Group A è®¢é˜…äº† Topic Aï¼ŒConsumer Group B ä¹Ÿè®¢é˜…äº† Topic Aï¼Œåˆ™å‘é€åˆ° Topic A çš„æ¯æ¡æ¶ˆæ¯ï¼Œä¸ä»…ä¼šä¼ ä¸€ä»½ç»™ Consumer Group A çš„æ¶ˆè´¹å®ä¾‹ï¼Œä¹Ÿä¼šä¼ ä¸€ä»½ç»™ Consumer Group B çš„æ¶ˆè´¹å®ä¾‹ï¼Œä¸”è¿™ä¸¤ä¸ªè¿‡ç¨‹ç›¸äº’ç‹¬ç«‹ï¼Œç›¸äº’æ²¡æœ‰ä»»ä½•å½±å“ã€‚ ### 2.4 æ¶ˆè´¹ä½ç‚¹ æ¯ä¸ª Topic ä¼šæœ‰å¤šä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºä¼šç»Ÿè®¡å½“å‰æ¶ˆæ¯çš„æ€»æ¡æ•°ï¼Œè¿™ä¸ªç§°ä¸ºæœ€å¤§ä½ç‚¹ MaxOffsetã€‚Kafka Consumer ä¼šæŒ‰é¡ºåºä¾æ¬¡æ¶ˆè´¹åˆ†åŒºå†…çš„æ¯æ¡æ¶ˆæ¯ï¼Œè®°å½•å·²ç»æ¶ˆè´¹äº†çš„æ¶ˆæ¯æ¡æ•°ï¼Œç§°ä¸ºConsumerOffsetã€‚</p><p>å‰©ä½™çš„æœªæ¶ˆè´¹çš„æ¡æ•°ï¼ˆä¹Ÿç§°ä¸ºæ¶ˆæ¯å †ç§¯é‡ï¼‰ = MaxOffset - ConsumerOffset</p><h3 id="æ¶ˆè´¹ä½ç‚¹æäº¤">2.5 æ¶ˆè´¹ä½ç‚¹æäº¤</h3><p>Kafka æ¶ˆè´¹è€…æœ‰ä¸¤ä¸ªç›¸å…³å‚æ•°ï¼š</p><ul><li>enable.auto.commitï¼šé»˜è®¤å€¼ä¸º trueã€‚</li><li>auto.commit.interval.msï¼š é»˜è®¤å€¼ä¸º 1000ï¼Œä¹Ÿå³ 1sã€‚</li></ul><p>è¿™ä¸¤ä¸ªå‚æ•°ç»„åˆçš„ç»“æœå°±æ˜¯ï¼Œæ¯æ¬¡ poll æ•°æ®å‰ä¼šå…ˆæ£€æŸ¥ä¸Šæ¬¡æäº¤ä½ç‚¹çš„æ—¶é—´ï¼Œå¦‚æœè·ç¦»å½“å‰æ—¶é—´å·²ç»è¶…è¿‡å‚æ•°auto.commit.interval.msè§„å®šçš„æ—¶é•¿ï¼Œåˆ™å®¢æˆ·ç«¯ä¼šå¯åŠ¨ä½ç‚¹æäº¤åŠ¨ä½œã€‚</p><p>å› æ­¤ï¼Œå¦‚æœå°†enable.auto.commitè®¾ç½®ä¸º trueï¼Œåˆ™éœ€è¦åœ¨æ¯æ¬¡ poll æ•°æ®æ—¶ï¼Œç¡®ä¿å‰ä¸€æ¬¡ poll å‡ºæ¥çš„æ•°æ®å·²ç»æ¶ˆè´¹å®Œæ¯•ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ä½ç‚¹è·³è·ƒã€‚</p><p>å¦‚æœæƒ³è‡ªå·±æ§åˆ¶ä½ç‚¹æäº¤ï¼Œè¯·æŠŠ enable.auto.commit è®¾ä¸º falseï¼Œå¹¶è°ƒç”¨ commit(offsets)å‡½æ•°è‡ªè¡Œæ§åˆ¶ä½ç‚¹æäº¤ã€‚</p><h3 id="æ¶ˆæ¯é‡å¤å’Œæ¶ˆè´¹å¹‚ç­‰">2.6 æ¶ˆæ¯é‡å¤å’Œæ¶ˆè´¹å¹‚ç­‰</h3><p>Kafka æ¶ˆè´¹çš„è¯­ä¹‰æ˜¯ â€œat least onceâ€ï¼Œ ä¹Ÿå°±æ˜¯è‡³å°‘æŠ•é€’ä¸€æ¬¡ï¼Œä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼Œä½†æ˜¯ä¸ä¼šä¿è¯æ¶ˆæ¯ä¸é‡å¤ã€‚åœ¨å‡ºç°ç½‘ç»œé—®é¢˜ã€å®¢æˆ·ç«¯é‡å¯æ—¶å‡æœ‰å¯èƒ½å‡ºç°å°‘é‡é‡å¤æ¶ˆæ¯ï¼Œæ­¤æ—¶åº”ç”¨æ¶ˆè´¹ç«¯å¦‚æœå¯¹æ¶ˆæ¯é‡å¤æ¯”è¾ƒæ•æ„Ÿï¼ˆæ¯”å¦‚è¯´è®¢å•äº¤æ˜“ç±»ï¼‰ï¼Œåˆ™åº”è¯¥åšåˆ°æ¶ˆæ¯å¹‚ç­‰ã€‚</p><p>ä»¥æ•°æ®åº“ç±»åº”ç”¨ä¸ºä¾‹ï¼Œå¸¸ç”¨åšæ³•æ˜¯ï¼š</p><p>å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼ å…¥ key ä½œä¸ºå”¯ä¸€æµæ°´å·IDï¼› æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œåˆ¤æ–­ key æ˜¯å¦å·²ç»æ¶ˆè´¹è¿‡ï¼Œå¦‚æœå·²ç»æ¶ˆè´¹è¿‡äº†ï¼Œåˆ™å¿½ç•¥ï¼Œå¦‚æœæ²¡æ¶ˆè´¹è¿‡ï¼Œåˆ™æ¶ˆè´¹ä¸€æ¬¡ï¼› å½“ç„¶ï¼Œå¦‚æœåº”ç”¨æœ¬èº«å¯¹å°‘é‡æ¶ˆæ¯é‡å¤ä¸æ•æ„Ÿï¼Œåˆ™ä¸éœ€è¦åšæ­¤ç±»å¹‚ç­‰æ£€æŸ¥ã€‚</p><h3 id="æ¶ˆè´¹å¤±è´¥">2.7 æ¶ˆè´¹å¤±è´¥</h3><p>Kafka æ˜¯æŒ‰åˆ†åŒºä¸€æ¡ä¸€æ¡æ¶ˆæ¯é¡ºåºå‘å‰æ¨è¿›æ¶ˆè´¹çš„ï¼Œå¦‚æœæ¶ˆè´¹ç«¯æ‹¿åˆ°æŸæ¡æ¶ˆæ¯åæ‰§è¡Œæ¶ˆè´¹é€»è¾‘å¤±è´¥ï¼Œæ¯”å¦‚åº”ç”¨æœåŠ¡å™¨å‡ºç°äº†è„æ•°æ®ï¼Œå¯¼è‡´æŸæ¡æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œç­‰å¾…äººå·¥å¹²é¢„ï¼Œé‚£ä¹ˆæœ‰ä»¥ä¸‹ä¸¤ç§å¤„ç†æ–¹å¼ï¼š</p><p>å¤±è´¥åä¸€ç›´å°è¯•å†æ¬¡æ‰§è¡Œæ¶ˆè´¹é€»è¾‘ã€‚è¿™ç§æ–¹å¼æœ‰å¯èƒ½é€ æˆæ¶ˆè´¹çº¿ç¨‹é˜»å¡åœ¨å½“å‰æ¶ˆæ¯ï¼Œæ— æ³•å‘å‰æ¨è¿›ï¼Œé€ æˆæ¶ˆæ¯å †ç§¯ï¼› ç”±äº Kafka è‡ªèº«æ²¡æœ‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„è®¾è®¡ï¼Œå®è·µä¸­é€šå¸¸ä¼šæ‰“å°å¤±è´¥çš„æ¶ˆæ¯ã€æˆ–è€…å­˜å‚¨åˆ°æŸä¸ªæœåŠ¡ï¼ˆæ¯”å¦‚åˆ›å»ºä¸€ä¸ª Topic ä¸“é—¨ç”¨æ¥æ”¾å¤±è´¥çš„æ¶ˆæ¯ï¼‰ï¼Œç„¶åå®šæ—¶ check å¤±è´¥æ¶ˆæ¯çš„æƒ…å†µï¼Œåˆ†æå¤±è´¥åŸå› ï¼Œæ ¹æ®æƒ…å†µå¤„ç†ã€‚ ### 2.8 æ¶ˆè´¹é˜»å¡ä»¥åŠå †ç§¯ æ¶ˆè´¹ç«¯æœ€å¸¸è§çš„é—®é¢˜å°±æ˜¯æ¶ˆè´¹å †ç§¯ï¼Œæœ€å¸¸é€ æˆå †ç§¯çš„åŸå› æ˜¯ï¼š</p><p>æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦ï¼Œæ­¤æ—¶åº”è¯¥æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œè¯¦è§ä¸‹ä¸€èŠ‚ã€Šæé«˜æ¶ˆè´¹é€Ÿåº¦ã€‹ï¼› æ¶ˆè´¹ç«¯äº§ç”Ÿäº†é˜»å¡ã€‚ æ¶ˆè´¹ç«¯æ‹¿åˆ°æ¶ˆæ¯åï¼Œæ‰§è¡Œæ¶ˆè´¹é€»è¾‘ï¼Œé€šå¸¸ä¼šæ‰§è¡Œä¸€äº›è¿œç¨‹è°ƒç”¨ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™åŒæ­¥ç­‰å¾…ç»“æœï¼Œåˆ™æœ‰å¯èƒ½é€ æˆä¸€ç›´ç­‰å¾…ï¼Œæ¶ˆè´¹è¿›ç¨‹æ— æ³•å‘å‰æ¨è¿›ã€‚</p><p>æ¶ˆè´¹ç«¯åº”è¯¥ç«­åŠ›é¿å…å µå¡æ¶ˆè´¹çº¿ç¨‹ï¼Œå¦‚æœå­˜åœ¨ç­‰å¾…è°ƒç”¨ç»“æœçš„æƒ…å†µï¼Œå»ºè®®è®¾ç½®ç­‰å¾…çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åä½œæ¶ˆè´¹å¤±è´¥å¤„ç†ã€‚</p><h3 id="æé«˜æ¶ˆè´¹é€Ÿåº¦">2.9 æé«˜æ¶ˆè´¹é€Ÿåº¦</h3><p>æé«˜æ¶ˆè´¹é€Ÿåº¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŠæ³•ï¼š</p><p>å¢åŠ  Consumer å®ä¾‹ä¸ªæ•° å¢åŠ æ¶ˆè´¹çº¿ç¨‹ ##### å¢åŠ  Consumer å®ä¾‹ å¯ä»¥åœ¨è¿›ç¨‹å†…ç›´æ¥å¢åŠ ï¼ˆéœ€è¦ä¿è¯æ¯ä¸ªå®ä¾‹å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦åˆ™æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼‰ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²å¤šä¸ªæ¶ˆè´¹å®ä¾‹è¿›ç¨‹ï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ä¾‹ä¸ªæ•°è¶…è¿‡åˆ†åŒºæ•°é‡åå°±ä¸å†èƒ½æé«˜é€Ÿåº¦ï¼Œå°†ä¼šæœ‰æ¶ˆè´¹å®ä¾‹ä¸å·¥ä½œã€‚</p><h5 id="å¢åŠ æ¶ˆè´¹çº¿ç¨‹">å¢åŠ æ¶ˆè´¹çº¿ç¨‹</h5><p>å¢åŠ  Consumer å®ä¾‹æœ¬è´¨ä¸Šä¹Ÿæ˜¯å¢åŠ çº¿ç¨‹çš„æ–¹å¼æ¥æå‡é€Ÿåº¦ï¼Œå› æ­¤æ›´åŠ é‡è¦çš„æ€§èƒ½æå‡æ–¹å¼æ˜¯å¢åŠ æ¶ˆè´¹çº¿ç¨‹ï¼Œæœ€åŸºæœ¬çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol type="1"><li>å®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼›</li><li>Poll æ•°æ®ï¼›</li><li>æŠŠæ•°æ®æäº¤åˆ°çº¿ç¨‹æ± è¿›è¡Œå¹¶å‘å¤„ç†ï¼›</li><li>ç­‰å¹¶å‘ç»“æœè¿”å›æˆåŠŸåï¼Œå†æ¬¡ poll æ•°æ®æ‰§è¡Œã€‚</li></ol><h3 id="æ¶ˆæ¯è¿‡æ»¤">2.10 æ¶ˆæ¯è¿‡æ»¤</h3><p>Kafka è‡ªèº«æ²¡æœ‰æ¶ˆæ¯è¿‡æ»¤çš„è¯­ä¹‰ã€‚å®è·µä¸­å¯ä»¥é‡‡å–ä»¥ä¸‹ä¸¤ä¸ªåŠæ³•ï¼š</p><p>å¦‚æœè¿‡æ»¤çš„ç§ç±»ä¸å¤šï¼Œå¯ä»¥é‡‡å–å¤šä¸ª Topic çš„æ–¹å¼è¾¾åˆ°è¿‡æ»¤çš„ç›®çš„ï¼› å¦‚æœè¿‡æ»¤çš„ç§ç±»å¤šï¼Œåˆ™æœ€å¥½åœ¨å®¢æˆ·ç«¯ä¸šåŠ¡å±‚é¢è‡ªè¡Œè¿‡æ»¤ã€‚ å®è·µä¸­è¯·æ ¹æ®ä¸šåŠ¡å…·ä½“æƒ…å†µè¿›è¡Œé€‰æ‹©ï¼Œä¹Ÿå¯ä»¥ç»¼åˆè¿ç”¨ä¸Šé¢ä¸¤ç§åŠæ³•ã€‚</p><h3 id="æ¶ˆæ¯å¹¿æ’­">2.11 æ¶ˆæ¯å¹¿æ’­</h3><p>Kafka è‡ªèº«æ²¡æœ‰æ¶ˆæ¯å¹¿æ’­çš„è¯­ä¹‰ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºä¸åŒçš„ Consumer Group æ¥æ¨¡æ‹Ÿå®ç°ã€‚</p><h3 id="è®¢é˜…å…³ç³»">2.12 è®¢é˜…å…³ç³»</h3><p>åŒä¸€ä¸ª Consumer Group å†…ï¼Œå„ä¸ªæ¶ˆè´¹å®ä¾‹è®¢é˜…çš„ Topic æœ€å¥½ä¿æŒä¸€è‡´ï¼Œé¿å…ç»™æ’æŸ¥é—®é¢˜å¸¦æ¥å¹²æ‰°ã€‚</p><h1 id="ä¸‰å¼€å§‹æŠ›ä»£ç ">ä¸‰ã€å¼€å§‹æŠ›ä»£ç </h1><p>æˆ‘ä»¬çš„é—®é¢˜æ˜¯ç”±äºæ¶ˆè´¹çš„é€Ÿåº¦ä¸å¤Ÿå¼•èµ·çš„ã€‚æ ¹æ®2.9çš„åŠæ³•ã€‚æˆ‘æä¾›äº†ä»¥ä¸‹ä»£ç  æ¶ˆè´¹è€…é…ç½®ï¼š <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.xxxxxx.kafka;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.CommonClientConfigs;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.config.SaslConfigs;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.config.SslConfigs;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.annotation.EnableKafka;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.config.ConcurrentKafkaListenerContainerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.config.KafkaListenerContainerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.core.ConsumerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.core.DefaultKafkaConsumerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.listener.BatchLoggingErrorHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.listener.ConcurrentMessageListenerContainer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 18:15 2018/4/24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableKafka</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiverConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.bootstrap-servers&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String bootstrapServers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;app.group.id&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String groupId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;kafka.client.truststore&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String kafkaClientTruststore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;app.topic.test&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">consumerConfigs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);</span><br><span class="line">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);</span><br><span class="line">        props.put(SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG,kafkaClientTruststore);</span><br><span class="line">        props.put(SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG,<span class="string">"KafkaOnsClient"</span>);</span><br><span class="line">        props.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG,<span class="string">"SASL_SSL"</span>);</span><br><span class="line">        props.put(SaslConfigs.SASL_MECHANISM,<span class="string">"ONS"</span>);</span><br><span class="line">        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">false</span>);</span><br><span class="line">        props.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,<span class="number">1000</span>);</span><br><span class="line">        props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG,<span class="number">50</span>);</span><br><span class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"latest"</span>);</span><br><span class="line">        <span class="keyword">return</span> props;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConsumerFactory&lt;String, String&gt; <span class="title">consumerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; <span class="title">kafkaListenerContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory = <span class="keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();</span><br><span class="line">        factory.setConsumerFactory(consumerFactory());</span><br><span class="line">        factory.setBatchListener(<span class="keyword">true</span>);</span><br><span class="line">        factory.setAutoStartup(<span class="keyword">true</span>);</span><br><span class="line">        factory.setAckDiscarded(<span class="keyword">true</span>);</span><br><span class="line">        factory.setConcurrency(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»¥ä¸‹æ˜¯æ¶ˆè´¹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.xxxxxx.kafka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.xxx.xxxxxx.common.Constants;</span><br><span class="line"><span class="keyword">import</span> com.xxx.xxxxxx.entry.vo.TrendInfoVO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.listener.KafkaDataListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.listener.MessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.support.KafkaHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Header;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Payload;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 17:09 2018/4/24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrendConsumer</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Long timestart = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"kafkaExecutor"</span>)</span><br><span class="line">    <span class="meta">@KafkaListener</span>(id = <span class="string">"list"</span>, topics = <span class="string">"$&#123;app.topic.test&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(@Payload List&lt;String&gt; messages,</span></span></span><br><span class="line"><span class="function"><span class="params">                        @Header(KafkaHeaders.RECEIVED_PARTITION_ID)</span> List&lt;Integer&gt; partitions,</span></span><br><span class="line"><span class="function">                        @<span class="title">Header</span><span class="params">(KafkaHeaders.OFFSET)</span> List&lt;Long&gt; offsets) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String str :messages)</span><br><span class="line">        &#123;</span><br><span class="line">            doRedisTask(str);</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis()-timestart&gt;=<span class="number">10000</span>) &#123;</span><br><span class="line">                log.info(<span class="string">"æ—¶é—´ï¼š&#123;&#125;kafkaæ¶ˆè´¹æ•°é‡ï¼š&#123;&#125;"</span>, Calendar.getInstance().getTime(),count);</span><br><span class="line">                count = <span class="number">0</span>;</span><br><span class="line">                timestart = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"redisExecutor"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRedisTask</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        JSONObject json = JSONObject.parseObject(message);</span><br><span class="line">        String exchange = json.getString(<span class="string">"exchange"</span>);</span><br><span class="line">        String symbol = json.getString(<span class="string">"symbol"</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(Constants.KAFKA_TRADE_PREFIX+exchange+symbol,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº†å¼‚æ­¥çº¿ç¨‹å»æ¶ˆè´¹ã€‚æé«˜æ¶ˆè´¹çš„é€Ÿåº¦ã€‚</p><p>å››ã€ç‰¹åˆ«æ³¨æ„</p><p>æ³¨æ„ä»¥ä¸‹å‡ ç‚¹é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">false</span>);</span><br><span class="line">props.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,<span class="number">1000</span>);</span><br><span class="line">props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG,<span class="number">50</span>);</span><br><span class="line">props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"latest"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">factory.setBatchListener(<span class="keyword">true</span>);</span><br><span class="line">actory.setConcurrency(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>äº”ã€å‚è€ƒåœ°å€</p><ol type="1"><li><a href="https://help.aliyun.com/document_detail/68166.html?spm=a2c4g.11186623.6.566.nnWMLo" target="_blank" rel="noopener">é˜¿é‡Œäº‘kafkaè®¢é˜…è€…æœ€ä½³å®è·µ:https://help.aliyun.com/document_detail/68166.html?spm=a2c4g.11186623.6.566.nnWMLo</a></li><li><a href="https://docs.spring.io/spring-kafka/docs/2.1.5.RELEASE/reference/html/" target="_blank" rel="noopener">Spring KAFKAåœ°å€ï¼šhttps://docs.spring.io/spring-kafka/docs/2.1.5.RELEASE/reference/html/</a></li></ol>]]></content>
    
    <summary type="html">
    
      Kafkaåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ-1
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>chapter-08-AIR</title>
    <link href="http://weafteam.github.io/posts/839e2740/"/>
    <id>http://weafteam.github.io/posts/839e2740/</id>
    <published>2018-05-06T03:30:48.000Z</published>
    <updated>2018-05-29T01:27:49.888Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-linear-regression-2">TensorFlow Linear Regression 2</h1><ol type="1"><li>å›é¡¾ä¸€ä¸‹çº¿æ€§å›å½’çš„losså‡½æ•°ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    ops.reset_default_graph()</span><br><span class="line">    sess = tf.Session()</span><br><span class="line">    batch_size = <span class="number">100</span></span><br><span class="line">    x_vals = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">    y_vals = x_vals + np.random.normal(<span class="number">0</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">    y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create variables for linear regression</span></span><br><span class="line">    A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line">    b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Declare model operations</span></span><br><span class="line">    model_output = tf.add(tf.matmul(x_data, A), b)</span><br><span class="line"></span><br><span class="line">    loss_l1 = tf.reduce_mean(tf.abs(y_target - model_output))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Declare optimizers</span></span><br><span class="line">    my_opt_l1 = tf.train.GradientDescentOptimizer(<span class="number">0.0001</span>)</span><br><span class="line">    train_step_l1 = my_opt_l1.minimize(loss_l1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize variables</span></span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess.run(init)</span><br><span class="line"></span><br><span class="line">    loss_vec_l1 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        rand_index = np.random.choice(len(x_vals), size=batch_size)</span><br><span class="line">        rand_x = np.transpose([x_vals[rand_index]])</span><br><span class="line">        rand_y = np.transpose([y_vals[rand_index]])</span><br><span class="line">        sess.run(train_step_l1, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        temp_loss_l1 = sess.run(loss_l1, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        loss_vec_l1.append(temp_loss_l1)</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">25</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">'Step #'</span> + str(i + <span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)) + <span class="string">' b = '</span> + str(sess.run(b)))</span><br><span class="line"></span><br><span class="line">    ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create graph</span></span><br><span class="line">    sess = tf.Session()</span><br><span class="line"></span><br><span class="line">    x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">    y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create variables for linear regression</span></span><br><span class="line">    A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line">    b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Declare model operations</span></span><br><span class="line">    model_output = tf.add(tf.matmul(x_data, A), b)</span><br><span class="line"></span><br><span class="line">    loss_l2 = tf.reduce_mean(tf.square(y_target - model_output))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Declare optimizers</span></span><br><span class="line">    my_opt_l2 = tf.train.GradientDescentOptimizer(<span class="number">0.0001</span>)</span><br><span class="line">    train_step_l2 = my_opt_l2.minimize(loss_l2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize variables</span></span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess.run(init)</span><br><span class="line"></span><br><span class="line">    loss_vec_l2 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        rand_index = np.random.choice(len(x_vals), size=batch_size)</span><br><span class="line">        rand_x = np.transpose([x_vals[rand_index]])</span><br><span class="line">        rand_y = np.transpose([y_vals[rand_index]])</span><br><span class="line">        sess.run(train_step_l2, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        temp_loss_l2 = sess.run(loss_l2, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        loss_vec_l2.append(temp_loss_l2)</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">25</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">'Step #'</span> + str(i + <span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)) + <span class="string">' b = '</span> + str(sess.run(b)))</span><br><span class="line"></span><br><span class="line">    plt.plot(loss_vec_l1, <span class="string">'k-'</span>, label=<span class="string">'L1 Loss'</span>)</span><br><span class="line">    plt.plot(loss_vec_l2, <span class="string">'r--'</span>, label=<span class="string">'L2 Loss'</span>)</span><br><span class="line">    plt.title(<span class="string">'L1 and L2 Loss per Generation'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'L1 Loss'</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper right'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure><ol start="2" type="1"><li>æˆ´æ˜å›å½’:</li></ol><p>çœ‹å›¾ï¼šæ‰¾ä¸åŒï¼š</p><p><img src="https://s1.ax1x.com/2018/05/06/CUmQtU.png"></p><p>losså‡½æ•°æ˜¯å…³é”®:ä¸‹é¢æ˜¯deming regressionçš„losså‡½æ•° <span class="math display">\[\frac{\mid{A*x+b-y}\mid}{\sqrt{A^2 + 1}}\]</span></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2018/5/6 14:32</span><br><span class="line"># @Author  : milittle</span><br><span class="line"># @Site    : www.weaf.top</span><br><span class="line"># @File    : deming_lr.py</span><br><span class="line"># @Software: PyCharm</span><br><span class="line"></span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import numpy as np</span><br><span class="line">import tensorflow as tf</span><br><span class="line">from tensorflow.python.framework import ops</span><br><span class="line"></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def run():</span><br><span class="line">    x_vals = np.linspace(0, 10, 100)</span><br><span class="line">    y_vals = x_vals + np.random.normal(0, 1, 100)</span><br><span class="line">    batch_size = 125</span><br><span class="line"></span><br><span class="line">    x_data = tf.placeholder(shape=[None, 1], dtype=tf.float32)</span><br><span class="line">    y_target = tf.placeholder(shape=[None, 1], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">    A = tf.Variable(tf.random_normal(shape=[1, 1]))</span><br><span class="line">    b = tf.Variable(tf.random_normal(shape=[1, 1]))</span><br><span class="line"></span><br><span class="line">    model_output = tf.add(tf.matmul(x_data, A), b)</span><br><span class="line"></span><br><span class="line">    # æ³¨æ„è¿™é‡Œçš„losså‡½æ•°çš„æ±‚è§£</span><br><span class="line">    demming_numerator = tf.abs(tf.subtract(tf.add(tf.matmul(x_data, A), b), y_target))</span><br><span class="line">    demming_denominator = tf.sqrt(tf.add(tf.square(A), 1))</span><br><span class="line">    loss = tf.reduce_mean(tf.truediv(demming_numerator, demming_denominator))</span><br><span class="line"></span><br><span class="line">    my_opt = tf.train.GradientDescentOptimizer(0.01)</span><br><span class="line">    train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line">    # Initialize variables</span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess.run(init)</span><br><span class="line"></span><br><span class="line">    loss_vec = []</span><br><span class="line">    for i in range(1500):</span><br><span class="line">        rand_index = np.random.choice(len(x_vals), size=batch_size)</span><br><span class="line">        rand_x = np.transpose([x_vals[rand_index]])</span><br><span class="line">        rand_y = np.transpose([y_vals[rand_index]])</span><br><span class="line">        sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        loss_vec.append(temp_loss)</span><br><span class="line">        if (i + 1) % 100 == 0:</span><br><span class="line">            print(&apos;Step #&apos; + str(i + 1) + &apos; A = &apos; + str(sess.run(A)) + &apos; b = &apos; + str(sess.run(b)))</span><br><span class="line">            print(&apos;Loss = &apos; + str(temp_loss))</span><br><span class="line"></span><br><span class="line">    [W] = sess.run(A)</span><br><span class="line">    [bias] = sess.run(b)</span><br><span class="line"></span><br><span class="line">    # Get best fit line</span><br><span class="line">    best_fit = []</span><br><span class="line">    for i in x_vals:</span><br><span class="line">        best_fit.append(W * i + bias)</span><br><span class="line"></span><br><span class="line">    plt.plot(x_vals, y_vals, &apos;o&apos;, label=&apos;Data Points&apos;)</span><br><span class="line">    plt.plot(x_vals, best_fit, &apos;r-&apos;, label=&apos;Best fit line&apos;, linewidth=3)</span><br><span class="line">    plt.legend(loc=&apos;upper left&apos;)</span><br><span class="line">    plt.title(&apos;Sepal Length vs Pedal Width&apos;)</span><br><span class="line">    plt.xlabel(&apos;Pedal Width&apos;)</span><br><span class="line">    plt.ylabel(&apos;Sepal Length&apos;)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    # Plot loss over time</span><br><span class="line">    plt.plot(loss_vec, &apos;k-&apos;)</span><br><span class="line">    plt.title(&apos;Demming Loss per Generation&apos;)</span><br><span class="line">    plt.xlabel(&apos;Iteration&apos;)</span><br><span class="line">    plt.ylabel(&apos;Demming Loss&apos;)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">def main(_):</span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure><ol start="3" type="1"><li>LASSO and Ridge Regression(å…³é”®çš„åœ°æ–¹è¿˜æ˜¯losså‡½æ•°çš„ä¸åŒï¼Œå…¶ä»–æ­¥éª¤æ˜¯ä¸€è‡´çš„)</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2018/5/6 14:46</span></span><br><span class="line"><span class="comment"># @Author  : milittle</span></span><br><span class="line"><span class="comment"># @Site    : www.weaf.top</span></span><br><span class="line"><span class="comment"># @File    : LASSO_Ridge_lr.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">regression_type = <span class="string">'LASSO'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    sess = tf.Session()</span><br><span class="line">    x_vals = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">    y_vals = x_vals + np.random.normal(<span class="number">0</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    batch_size = <span class="number">125</span></span><br><span class="line"></span><br><span class="line">    x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">    y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">    seed = <span class="number">13</span></span><br><span class="line">    np.random.seed(seed)</span><br><span class="line">    tf.set_random_seed(seed)</span><br><span class="line"></span><br><span class="line">    A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line">    b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    model_output = tf.add(tf.matmul(x_data, A), b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> regression_type == <span class="string">'LASSO'</span>:</span><br><span class="line">        lasso_param = tf.constant(<span class="number">0.9</span>)</span><br><span class="line">        heavyside_step = tf.truediv(<span class="number">1.</span>, tf.add(<span class="number">1.</span>, tf.exp(tf.multiply(<span class="number">-50.</span>, tf.subtract(A, lasso_param)))))</span><br><span class="line">        regularization_param = tf.multiply(heavyside_step, <span class="number">99.</span>)</span><br><span class="line">        loss = tf.add(tf.reduce_mean(tf.square(y_target - model_output)), regularization_param)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> regression_type == <span class="string">'Ridge'</span>:</span><br><span class="line">        ridge_param = tf.constant(<span class="number">1.</span>)</span><br><span class="line">        ridge_loss = tf.reduce_mean(tf.square(A))</span><br><span class="line">        loss = tf.expand_dims(</span><br><span class="line">            tf.add(tf.reduce_mean(tf.square(y_target - model_output)), tf.multiply(ridge_param, ridge_loss)), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'Invalid regression_type parameter value'</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.001</span>)</span><br><span class="line">    train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess.run(init)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Training loop</span></span><br><span class="line">    loss_vec = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1500</span>):</span><br><span class="line">        rand_index = np.random.choice(len(x_vals), size=batch_size)</span><br><span class="line">        rand_x = np.transpose([x_vals[rand_index]])</span><br><span class="line">        rand_y = np.transpose([y_vals[rand_index]])</span><br><span class="line">        sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        loss_vec.append(temp_loss[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">300</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">'Step #'</span> + str(i + <span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)) + <span class="string">' b = '</span> + str(sess.run(b)))</span><br><span class="line">            print(<span class="string">'Loss = '</span> + str(temp_loss))</span><br><span class="line">            print(<span class="string">'\n'</span>)</span><br><span class="line">    [W] = sess.run(A)</span><br><span class="line">    [bias] = sess.run(b)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get best fit line</span></span><br><span class="line">    best_fit = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> x_vals:</span><br><span class="line">        best_fit.append(W * i + bias)</span><br><span class="line">    <span class="comment"># Plot the result</span></span><br><span class="line">    plt.plot(x_vals, y_vals, <span class="string">'o'</span>, label=<span class="string">'Data Points'</span>)</span><br><span class="line">    plt.plot(x_vals, best_fit, <span class="string">'r-'</span>, label=<span class="string">'Best fit line'</span>, linewidth=<span class="number">3</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">    plt.title(<span class="string">'Sepal Length vs Pedal Width'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Pedal Width'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Sepal Length'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Plot loss over time</span></span><br><span class="line">    plt.plot(loss_vec, <span class="string">'k-'</span>)</span><br><span class="line">    plt.title(regression_type + <span class="string">' Loss per Generation'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Loss'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure><ol start="4" type="1"><li>Elastic Net Regression(åˆ©ç”¨å¤šä¸ªlosså‡½æ•°çš„å åŠ è¿›è¡Œè®­ç»ƒ)å¼¹æ€§çš„æ–¹å¼</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2018/5/6 14:57</span></span><br><span class="line"><span class="comment"># @Author  : milittle</span></span><br><span class="line"><span class="comment"># @Site    : www.weaf.top</span></span><br><span class="line"><span class="comment"># @File    : Elastic_Net_Regression.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line">x_vals = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">y_vals = x_vals + np.random.normal(<span class="number">0</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">batch_size = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">seed = <span class="number">13</span></span><br><span class="line">np.random.seed(seed)</span><br><span class="line">tf.set_random_seed(seed)</span><br><span class="line"></span><br><span class="line">x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32, name=<span class="string">'input'</span>)</span><br><span class="line">y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32, name=<span class="string">'output'</span>)</span><br><span class="line"></span><br><span class="line">A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line">b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">model_output = tf.add(tf.matmul(x_data, A), b)</span><br><span class="line"></span><br><span class="line">elastic_param1 = tf.constant(<span class="number">1.</span>)</span><br><span class="line">elastic_param2 = tf.constant(<span class="number">1.</span>)</span><br><span class="line">l1_a_loss = tf.reduce_mean(tf.abs(A))</span><br><span class="line">l2_a_loss = tf.reduce_mean(tf.square(A))</span><br><span class="line">e1_term = tf.multiply(elastic_param1, l1_a_loss)</span><br><span class="line">e2_term = tf.multiply(elastic_param2, l2_a_loss)</span><br><span class="line">loss = tf.expand_dims(tf.add(tf.add(tf.reduce_mean(tf.square(y_target - model_output)), e1_term), e2_term), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.001</span>)</span><br><span class="line">train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Training loop</span></span><br><span class="line">loss_vec = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    rand_index = np.random.choice(len(x_vals), size=batch_size)</span><br><span class="line">    rand_x = np.transpose([x_vals[rand_index]])</span><br><span class="line">    rand_y = np.transpose([y_vals[rand_index]])</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    loss_vec.append(temp_loss[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">250</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i + <span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)) + <span class="string">' b = '</span> + str(sess.run(b)))</span><br><span class="line">    print(<span class="string">'Loss = '</span> + str(temp_loss))</span><br><span class="line"></span><br><span class="line">W = sess.run(A)</span><br><span class="line">bias = sess.run(b)</span><br><span class="line"></span><br><span class="line">plt.plot(loss_vec, <span class="string">'k-'</span>)</span><br><span class="line">plt.title(<span class="string">'Loss per Generation'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Loss'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p>å¥½ï¼Œä»Šå¤©åˆ°æ­¤æŠŠä¸€äº›çº¿æ€§æ¨¡å‹çš„åº”ç”¨é—®é¢˜å¤§ä½“è®²å®Œäº†ï¼Œè¿˜æ˜¯æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥ç§¯æè®¨è®ºï¼Œå¯ä»¥ç»™æˆ‘å‘é‚®ä»¶air@weaf.topï¼Œä¸Šé¢çš„ä»£ç ç”±äºå¾ˆç®€å•ï¼Œæ‰€ä»¥æˆ‘æƒ³å¤§å®¶éƒ½å¯ä»¥çœ‹æ‡‚çš„ã€‚å…¶å®è¿™ä¹ˆå¤šç±»å‹çš„å›å½’é—®é¢˜ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯losså‡½æ•°ä¸ä¸€æ ·ï¼Œåªè¦å°†losså‡½æ•°ç†è§£äº†ï¼Œé‚£ä¹ˆé—®é¢˜å°±è¿åˆƒè€Œè§£ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-linear-regression-2&quot;&gt;TensorFlow Linear Regression 2&lt;/h1&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;å›é¡¾ä¸€ä¸‹çº¿æ€§å›å½’çš„losså‡½æ•°ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;figure
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>chapter-07-AIR</title>
    <link href="http://weafteam.github.io/posts/1ceb091/"/>
    <id>http://weafteam.github.io/posts/1ceb091/</id>
    <published>2018-05-06T03:29:55.000Z</published>
    <updated>2018-05-29T01:27:49.874Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-linear-regression-1">TensorFlow Linear Regression 1</h1><p>äº²çˆ±çš„å°ä¼™ä¼´ä»¬ï¼Œä¸Šå‘¨åˆäº‹æƒ…ç»™è€½æäº†ï¼Œè¿™å‘¨å°†ä¸Šå‘¨çš„å†…å®¹ä¸€èµ·è¡¥å……ä¸€ä¸‹ã€‚æˆ‘ä»¬å‰é¢çš„å†…å®¹å°†TensorFlowçš„åŸºç¡€å†…å®¹éƒ½ä»‹ç»äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€äº›åŸºæœ¬çš„ç®—æ³•ï¼Œå¦‚æœå¤§å®¶æƒ³è·‘ä¸€äº›ç°åœ¨ä¸»æµçš„ä¸€äº›ç½‘ç»œç»“æ„ï¼Œå¤§å®¶å¯ä»¥ç§»æ­¥åˆ°æˆ‘çš„GitHub MLModelè¿™ä¸ªä»“åº“<a href="https://github.com/Milittle/MLModel" target="_blank" rel="noopener">MLModel</a>ï¼Œé‡Œé¢ä¼šå®šæœŸæ›´æ–°ä¸€äº›ä¸»æµçš„ç½‘ç»œæ¡†æ¶ã€‚å–œæ¬¢çš„è¯ï¼Œç»™ä¸ªstarå¯å¥½ã€‚æ¥ä¸‹æ¥å‘¢æˆ‘ä»¬å¼€å§‹æˆ‘ä»¬ä»Šå¤©çš„çº¿æ€§å›å½’æ¨¡å‹çš„å„ç§æ±‚è§£æ–¹æ³•ã€‚</p><ol type="1"><li>åœ¨TensorFlowä¸­ä½¿ç”¨çŸ©é˜µçš„é€†æ¥è§£å†³çº¿æ€§æ¨¡å‹ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œç›¸æ¯”å­¦è¿‡çº¿æ€§ä»£æ•°çš„ä½ ï¼Œéƒ½ä¼šè§£ã€‚</li></ol><p>å¤§å®¶å¯æ›¾è®°å¾—çº¿æ€§ä»£æ•°é‡Œé¢çš„çº¿æ€§æ–¹ç¨‹ç»„ï¼š <span class="math display">\[A * x + b = y\]</span> xå°±æ˜¯æˆ‘ä»¬è¦è§£çš„æœªçŸ¥è§£ï¼Œé‚£xè¯¥æ€ä¹ˆè§£æ¥ç€ï¼Ÿ <span class="math display">\[x = {(A^T  * A)}^{-1} * A^T * y - b\]</span> ä¸Šé¢çš„å…¬å¼ä¸€ä¸‹å°±èƒ½çœ‹å‡ºæ¥æ˜¯æ€ä¹ˆå›äº‹å¯¹ä¸å¯¹ï¼Ÿ</p><p>æ¨å¯¼è¿‡ç¨‹ï¼š <span class="math display">\[ç¬¬ä¸€æ­¥:A^T * A * x = A^T*y-b\\ç¬¬äºŒæ­¥ï¼š{(A^T*A)}^{-1} *{(A^T*A)} * x = {(A^T*A)}^{-1} * A^T*y-b\\ç¬¬ä¸‰æ­¥ï¼šå·¦è¾¹æ˜¯ä¸æ˜¯å°±æ˜¯ä¸€ä¸ªå•ä½çŸ©é˜µäº†ï¼Ÿ\\å¾—åˆ°æœ€åçš„ç»“æœæ˜¯ï¼šx = {(A^T  * A)}^{-1} * A^T * y-b\]</span> æˆ‘ä»¬ä¸‹é¢ä½¿ç”¨çš„Açš„ç‰¹å¾ç»´åº¦æ˜¯ä¸€ç»´ï¼Œ(å†åŠ ä¸Šbè¿™ä¸ªç»´åº¦)è¿™æ˜¯ä¸ºäº†å¯ä»¥å¯è§†åŒ–ç»“æœï¼šåœ¨ç›´æ¥åˆ©ç”¨çŸ©é˜µè¿ç®—è€Œå¾—åˆ°çš„è§£å¯¹äºè¿™äº›æ•°æ®æ¥è¯´ï¼Œæ˜¯æœ€å¥½çš„ç»“æœã€‚ä¹Ÿæ˜¯å”¯ä¸€è§£ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># æ„é€ æ•°æ®</span></span><br><span class="line">    x_vals = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">    y_vals = x_vals + np.random.normal(<span class="number">0</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    x_vals_column = np.transpose(np.matrix(x_vals))</span><br><span class="line">    ones_column = np.transpose(np.matrix(np.repeat(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line"></span><br><span class="line">    A = np.column_stack((x_vals_column, ones_column))</span><br><span class="line"></span><br><span class="line">    y = np.transpose(np.matrix(y_vals))</span><br><span class="line"></span><br><span class="line">    A_tensor = tf.constant(A)</span><br><span class="line">    y_tensor = tf.constant(y)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#åˆ©ç”¨çŸ©é˜µçš„é€†è§£å†³è¿™ä¸ªçº¿æ€§é—®é¢˜ã€‚</span></span><br><span class="line">    t_A_A = tf.matmul(tf.transpose(A_tensor), A_tensor) <span class="comment">#æ±‚çŸ©é˜µè½¬ç½®å’Œæœ¬èº«çš„ä¹˜ç§¯</span></span><br><span class="line">    t_A_A_inverse = tf.matrix_inverse(t_A_A) <span class="comment"># æ±‚çŸ©é˜µçš„é€†</span></span><br><span class="line">    product = tf.matmul(t_A_A_inverse, tf.transpose(A_tensor))</span><br><span class="line">    solution = tf.matmul(product, y_tensor)</span><br><span class="line"></span><br><span class="line">    solution_eval = sess.run(solution)</span><br><span class="line"></span><br><span class="line">    W = solution_eval[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    bias = solution_eval[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'W: '</span> + str(W))</span><br><span class="line">    print(<span class="string">'bias: '</span> + str(bias))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get best fit line</span></span><br><span class="line">    best_fit = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> x_vals:</span><br><span class="line">        best_fit.append(W * i + bias)</span><br><span class="line">    plt.plot(x_vals, y_vals, <span class="string">'o'</span>, label = <span class="string">'data'</span>)</span><br><span class="line">    plt.plot(x_vals, best_fit, <span class="string">'r-'</span>, label = <span class="string">'best fit line'</span>, linewidth = <span class="number">3</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure><p>å…¶å®å¤§å®¶ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä½¿ç”¨çŸ©é˜µçš„é€†å»æ±‚çº¿æ€§æ¨¡å‹æ˜¯åˆå¿«åˆå‡†ï¼Œä½†æ˜¯ä½ ä»¬æƒ³è¿‡æ²¡æœ‰ä¸ºå•¥ç¥ç»ç½‘ç»œé‡Œé¢åœ¨æ±‚è§£çº¿æ€§å›å½’çš„æ—¶å€™è¿˜è¦ç”¨åˆ°åå‘ä¼ æ’­æ¢¯åº¦ä¸‹é™çš„æ–¹å¼å‘¢ï¼Œç»™ä½ ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ç°åœ¨ä¸€ä¸ªæ ·æœ¬æœ‰ä¸Šä¸‡æˆ–è€…åä¸‡ä¸ªç‰¹å¾ç»´åº¦ï¼Œä½ æƒ³æƒ³æˆ‘ä»¬åœ¨æ±‚è§£çŸ©é˜µé€†çš„æ—¶å€™è¦èŠ±è´¹å¤šé•¿æ—¶é—´ï¼Œé‚£æ˜¯ä½ æ„æƒ³ä¸åˆ°çš„ï¼Œæ‰€ä»¥æ‰ä¼šä½¿ç”¨æ–¹å‘ä¼ æ’­ç®—æ³•å»è§£å†³Wçš„æ±‚è§£é—®é¢˜ã€‚è¯¦ç»†éœ€è¦èŠ±è´¹çš„æ—¶é—´ã€‚</p><ol start="2" type="1"><li>ç¬¬äºŒç§æ±‚è§£æ–¹å¼ï¼šCholesky Method</li></ol><p><span class="math display">\[A*x=y\]</span></p><p>æ€è·¯å¦‚ä¸‹ï¼šåœ¨Cholesky methodæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†Aåˆ†è§£ä¸ºLå’ŒLçš„è½¬ç½®çš„ä¹˜ç§¯ï¼Œç„¶åå†è¿›è¡Œxçš„æ±‚è§£ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢?å½“ç„¶æ˜¯ä¸ºäº†é¿å…æ±‚çŸ©é˜µçš„é€†ï¼Œå®ƒå¾ˆè€—è´¹æ—¶é—´ã€‚</p><p>å› ä¸ºAè¦æ±‚åœ¨æ±‚è§£Cholesky Depcompositionçš„æ—¶å€™æ˜¯squareä¹Ÿå°±æ˜¯æ–¹é˜µã€‚ä½†æ˜¯ä¸€èˆ¬çš„Aéƒ½ä¸æ˜¯æ–¹é˜µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ„é€ å‡ºæ¥ä¸€ä¸ªæ–¹é˜µï¼š <span class="math display">\[A^T*A\]</span> å®ƒå°±æ˜¯ä¸€ä¸ªæ–¹é˜µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ±‚Aè½¬ç½®å’ŒAä¹˜ç§¯çš„Cholesky Decompositionã€‚</p><p>é¦–å…ˆæ˜ç¡®åˆ†è§£æ­¥éª¤ï¼š <span class="math display">\[ç¬¬ä¸€æ­¥ï¼šA^T*A=L^T*L\\ç¬¬äºŒæ­¥ï¼šL^T*L*x=A^T*Y\\ç¬¬ä¸‰æ­¥ï¼šL^T*z=A^T*Y\\where z = L*x\]</span> å…¶æ¬¡æ˜ç¡®æ±‚è§£æ­¥éª¤ï¼š <span class="math display">\[ç¬¬ä¸€æ­¥ï¼šè®¡ç®—Açš„Cholesky Decomposition\\where A^T*A=L^T*L\\ç¬¬äºŒæ­¥ï¼šæ±‚è§£zï¼Œåˆ©ç”¨L^T*z=A^T*yè¿™ä¸ªå…¬å¼\\ç¬¬ä¸‰æ­¥ï¼šæ±‚è§£xï¼Œåˆ©ç”¨L*x=zè¿™ä¸ªå…¬å¼\]</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„é€ æ•°æ®</span></span><br><span class="line">    x_vals = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">    y_vals = x_vals + np.random.normal(<span class="number">0</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    x_vals_column = np.transpose(np.matrix(x_vals))</span><br><span class="line">    ones_column = np.transpose(np.matrix(np.repeat(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line">    A = np.column_stack((x_vals_column, ones_column))</span><br><span class="line">    y = np.transpose(np.matrix(y_vals))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    A_tensor = tf.constant(A)</span><br><span class="line">    y_tensor = tf.constant(y)</span><br><span class="line"></span><br><span class="line">    tA_A = tf.matmul(tf.transpose(A_tensor), A_tensor)</span><br><span class="line">    L = tf.cholesky(tA_A)</span><br><span class="line"></span><br><span class="line">    tA_y = tf.matmul(tf.transpose(A_tensor), y)</span><br><span class="line">    sol1 = tf.matrix_solve(L, tA_y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sol2 = tf.matrix_solve(tf.transpose(L), sol1)</span><br><span class="line">    solution_eval = sess.run(sol2)</span><br><span class="line"></span><br><span class="line">    W = solution_eval[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    bias = solution_eval[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'slope: '</span> + str(W))</span><br><span class="line">    print(<span class="string">'y_intercept: '</span> + str(bias))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    best_fit = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> x_vals:</span><br><span class="line">        best_fit.append(W * i + bias)</span><br><span class="line">    plt.plot(x_vals, y_vals, <span class="string">'o'</span>, label=<span class="string">'Data'</span>)</span><br><span class="line">    plt.plot(x_vals, best_fit, <span class="string">'r-'</span>, label=<span class="string">'Best fit line'</span>, linewidth=<span class="number">3</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure><ol start="3" type="1"><li>ä½¿ç”¨åå‘ä¼ æ’­æ¢¯åº¦ä¸‹é™çš„æ–¹å¼æ±‚è§£çº¿æ€§æ¨¡å‹ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># æ„é€ æ•°æ®</span></span><br><span class="line">    batch_size = <span class="number">32</span></span><br><span class="line">    x_vals = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">    y_vals = x_vals + np.random.normal(<span class="number">0</span>, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">    y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">    A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line">    b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    model_output = tf.add(tf.matmul(x_data, A), b)</span><br><span class="line">    loss = tf.reduce_mean(tf.square(y_target - model_output))</span><br><span class="line"></span><br><span class="line">    my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.00001</span>)</span><br><span class="line">    train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line">    sess.run(tf.global_variables_initializer())</span><br><span class="line"></span><br><span class="line">    loss_vec = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000</span>):</span><br><span class="line">        rand_index = np.random.choice(len(x_vals), size = batch_size)</span><br><span class="line">        rand_x = np.transpose([x_vals[rand_index]])</span><br><span class="line">        rand_y = np.transpose([y_vals[rand_index]])</span><br><span class="line">        sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        loss_vec.append(temp_loss)</span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">25</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">'Step #'</span> + str(i + <span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)) + <span class="string">' b = '</span> + str(sess.run(b)))</span><br><span class="line">            print(<span class="string">'Loss = '</span> + str(temp_loss))</span><br><span class="line"></span><br><span class="line">    [W] = sess.run(A)</span><br><span class="line">    [b] = sess.run(b)</span><br><span class="line"></span><br><span class="line">    best_fit = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> x_vals:</span><br><span class="line">        best_fit.append(W * i + b)</span><br><span class="line"></span><br><span class="line">    plt.plot(x_vals, y_vals, <span class="string">'o'</span>, label=<span class="string">'Data Points'</span>)</span><br><span class="line">    plt.plot(x_vals, best_fit, <span class="string">'r-'</span>, label=<span class="string">'Best fit line'</span>, linewidth=<span class="number">3</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">    plt.title(<span class="string">'Sepal Length vs Pedal Width'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Pedal Width'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Sepal Length'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    plt.plot(loss_vec, <span class="string">'b-'</span>)</span><br><span class="line">    plt.title(<span class="string">'L2 Loss per Generation'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'Generation'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'L2 Loss'</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_)</span>:</span></span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure><p>è¿™ä¸‰ç§æ–¹å¼æ±‚è§£çš„çº¿æ€§æ¨¡å‹ï¼Œå¤§å®¶éƒ½ç†Ÿæ‚‰ä¸€ä¸‹ã€‚æœ‰ä»€ä¹ˆä¸ç¡®å®šçš„åœ°æ–¹ï¼Œå¯ä»¥å‘é‚®ä»¶ç»™æˆ‘air@weaf.topã€‚ä¸Šé¢çš„æ–¹å¼å…¶å®åœ¨ç°å®é‡Œé¢éƒ½å¯ä»¥ä½¿ç”¨ï¼Œåªä¸è¿‡å‰ä¸¤ç§æ–¹æ³•ï¼Œåœ¨æ•°æ®ç»´åº¦è¾ƒå¤§çš„æ—¶å€™ï¼Œè®¡ç®—è€—æ—¶ã€‚æ‰€ä»¥æ‰ä¼šä½¿ç”¨æ¢¯åº¦ä¸‹é™çš„å»æ±‚æœ€ä¼˜è§£ã€‚è¿™æ¬¡çš„æ–‡ç« å°±åˆ°è¿™é‡Œã€‚å¦‚æœå“ªé‡Œè¡¨è¿°ä¸æ¸…çš„åœ°æ–¹æˆ–è€…é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤§å®¶æŒ‡å‡ºã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-linear-regression-1&quot;&gt;TensorFlow Linear Regression
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆå››ï¼‰</title>
    <link href="http://weafteam.github.io/posts/7eb3a479/"/>
    <id>http://weafteam.github.io/posts/7eb3a479/</id>
    <published>2018-05-04T14:32:16.000Z</published>
    <updated>2018-08-07T08:56:41.619Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šæ–‡ã€‚</p><h2 id="åŒæ­¥åŸè¯­">åŒæ­¥åŸè¯­</h2><p>è™½ç„¶ä½¿ç”¨ <code>asyncio</code> çš„ç¨‹åºé€šå¸¸éƒ½ä»¥å•çº¿ç¨‹è¿è¡Œï¼Œä½†ä»ç„¶å¯ä»¥ä½œä¸ºå¹¶å‘ç¨‹åºã€‚æ¯ä¸ªåç¨‹æˆ–ä»»åŠ¡å¯ä»¥æ ¹æ®æ¥è‡ª I / O æˆ–å…¶ä»–å¤–éƒ¨äº‹ä»¶çš„å»¶è¿Ÿå’Œä¸­æ–­ä»¥ä¸å¯é¢„æµ‹çš„é¡ºåºæ‰§è¡Œã€‚ä¸ºäº†æ”¯æŒå®‰å…¨å¹¶å‘ï¼Œå’Œ <code>threading</code>å’Œ <code>multiprocessing</code> æ¨¡å—ä¸€æ ·ï¼Œ<code>asyncio</code> åŒ…å«äº†ä¸€äº›ç›¸åŒçš„ä½çº§åŸè¯­çš„å®ç°ã€‚</p><h3 id="é”">é”</h3><p>é”å¯¹å…±äº«èµ„æºçš„è®¿é—®æä¾›äº†ä¿æŠ¤ã€‚åªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½ä½¿ç”¨èµ„æºã€‚ç¬¬äºŒæ¬¡åŠä»¥ä¸Šè·å–é”çš„å°è¯•å°†è¢«é˜»æ­¢ï¼Œå› æ­¤æ¯æ¬¡åªæœ‰ä¸€ä¸ªæŒæœ‰è€…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unlock</span><span class="params">(lock)</span>:</span></span><br><span class="line">    print(<span class="string">'callback releasing lock'</span>)</span><br><span class="line">    lock.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro1</span><span class="params">(lock)</span>:</span></span><br><span class="line">    print(<span class="string">'`coro1` waiting for the lock'</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="keyword">await</span> lock:</span><br><span class="line">        print(<span class="string">'`coro1` acquired lock'</span>)</span><br><span class="line">    print(<span class="string">'`coro1` released lock'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro2</span><span class="params">(lock)</span>:</span></span><br><span class="line">    print(<span class="string">'`coro2` waiting for the lock'</span>)</span><br><span class="line">    <span class="keyword">await</span> lock</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(<span class="string">'`coro2` acquired lock'</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">'`coro2` released lock'</span>)</span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="comment"># åˆ›å»ºå¹¶æŒæœ‰ä¸€ä¸ªé”</span></span><br><span class="line">    lock = asyncio.Lock()</span><br><span class="line">    print(<span class="string">'acquiring the lock before starting coroutines'</span>)</span><br><span class="line">    <span class="keyword">await</span> lock.acquire()</span><br><span class="line">    print(<span class="string">f'lock acquired: <span class="subst">&#123;lock.locked()&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®‰æ’ä¸€ä¸ªå›è°ƒé‡Šæ”¾é”</span></span><br><span class="line">    loop.call_later(<span class="number">0.1</span>, functools.partial(unlock, lock))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿è¡Œå¸Œæœ›æŒæœ‰é”çš„åç¨‹</span></span><br><span class="line">    print(<span class="string">'waiting for coroutines'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait([coro1(lock), coro2(lock)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ <code>await</code> æŒæœ‰ä¸€ä¸ªé”ï¼Œå¹¶ç”¨ <code>release()</code> é‡Šæ”¾ï¼Œå°±åƒ<code>coro2()</code> çš„åšæ³•ä¸€æ ·ï¼›åŒæ—¶ä¹Ÿå¯ä»¥åƒ <code>coro1()</code> ä¸€æ ·ï¼Œç”¨å¸¦æœ‰ <code>await</code> çš„å¼‚æ­¥ä¸Šä¸‹æ–‡å¤„ç†å™¨æ¥æŒæœ‰å¹¶é‡Šæ”¾ä¸€ä¸ªé”ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">acquiring the lock before starting coroutines</span><br><span class="line">lock acquired: True</span><br><span class="line">waiting for coroutines</span><br><span class="line">`coro1` waiting for the lock</span><br><span class="line">`coro2` waiting for the lock</span><br><span class="line">callback releasing lock</span><br><span class="line">`coro1` acquired lock</span><br><span class="line">`coro1` released lock</span><br><span class="line">`coro2` acquired lock</span><br><span class="line">`coro2` released lock</span><br></pre></td></tr></table></figure><h3 id="event">Event</h3><p><code>asyncio.Event</code> ä¸ <code>threading.Event</code> ç±»ä¼¼ï¼Œç”¨äºå…è®¸å¤šä¸ªåç¨‹ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿï¼Œè€Œä¸éœ€è¦ç›‘å¬ä¸€ä¸ªç‰¹å®šå€¼æ¥å®ç°ç±»ä¼¼é€šçŸ¥çš„åŠŸèƒ½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_event</span><span class="params">(event)</span>:</span></span><br><span class="line">    print(<span class="string">'setting event in callback'</span>)</span><br><span class="line">    event.set()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro1</span><span class="params">(event)</span>:</span></span><br><span class="line">    print(<span class="string">'coro1 waiting for event'</span>)</span><br><span class="line">    <span class="keyword">await</span> event.wait()</span><br><span class="line">    print(<span class="string">'coro1 triggered'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro2</span><span class="params">(event)</span>:</span></span><br><span class="line">    print(<span class="string">'coro2 waiting for event'</span>)</span><br><span class="line">    <span class="keyword">await</span> event.wait()</span><br><span class="line">    print(<span class="string">'coro2 triggered'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    event = asyncio.Event()</span><br><span class="line">    print(<span class="string">f'event start state: <span class="subst">&#123;event.is_set()&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    loop.call_later(<span class="number">0.1</span>, functools.partial(set_event, event))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(coro1(event), coro2(event))</span><br><span class="line">    print(<span class="string">f'event end state: <span class="subst">&#123;event.is_set()&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>ä¸é”ä¸€æ ·ï¼Œ<code>coro1()</code> å’Œ <code>coro2()</code> éƒ½ä¼šç­‰å¾… <code>event</code> è¢«è®¾ç½®ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä»¬å¯ä»¥åœ¨ <code>event</code> çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ç«‹å³å¯åŠ¨ï¼Œå¹¶ä¸”å®ƒä»¬ä¸éœ€è¦è·å– <code>event</code> å¯¹è±¡çš„å”¯ä¸€ä½¿ç”¨æƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">event start state: False</span><br><span class="line">coro2 waiting for event</span><br><span class="line">coro1 waiting for event</span><br><span class="line">setting event in callback</span><br><span class="line">coro2 triggered</span><br><span class="line">coro1 triggered</span><br><span class="line">event end state: True</span><br></pre></td></tr></table></figure><h3 id="condition">Condition</h3><p><code>Condition</code>çš„ä½œç”¨ç±»ä¼¼äº <code>Event</code>ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼Œ<code>Condition</code> ä¸ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…ä¸­çš„åç¨‹ï¼Œå”¤é†’çš„æ•°é‡ç”± <code>notify()Â </code> çš„å‚æ•°æ§åˆ¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(condition, n)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> <span class="keyword">await</span> condition:</span><br><span class="line">        print(<span class="string">f'consumer <span class="subst">&#123;n&#125;</span> is waiting'</span>)</span><br><span class="line">        <span class="keyword">await</span> condition.wait()</span><br><span class="line">        print(<span class="string">f'consumer <span class="subst">&#123;n&#125;</span> triggered'</span>)</span><br><span class="line">    print(<span class="string">f'ending consumer <span class="subst">&#123;n&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">manipulate_condition</span><span class="params">(condition)</span>:</span></span><br><span class="line">    print(<span class="string">'starting manipulate_condition'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="keyword">await</span> condition:</span><br><span class="line">            print(<span class="string">f'notifying <span class="subst">&#123;i&#125;</span> consumers'</span>)</span><br><span class="line">            condition.notify(n=i)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="keyword">await</span> condition:</span><br><span class="line">        print(<span class="string">'notifying remaining consumers'</span>)</span><br><span class="line">        condition.notify_all()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'ending manipulate_condition'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    condition = asyncio.Condition()</span><br><span class="line"></span><br><span class="line">    consumers = [consumer(condition, i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line">    loop.create_task(manipulate_condition(condition))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*consumers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­å¯åŠ¨äº†äº”ä¸ª <code>Condition</code> çš„æ¶ˆè´¹è€…ã€‚æ¯ä¸ªéƒ½ä½¿ç”¨ <code>wait()</code> æ–¹æ³•ç­‰å¾…é€šçŸ¥å®ƒä»¬ç»§ç»­çš„æ¶ˆæ¯ã€‚<code>manipulate_condition()</code> é€šçŸ¥ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç„¶åé€šçŸ¥ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œæœ€åé€šçŸ¥æ‰€æœ‰å‰©ä½™çš„æ¶ˆè´¹è€…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">starting manipulate_condition</span><br><span class="line">notifying 1 consumers</span><br><span class="line">consumer 2 is waiting</span><br><span class="line">consumer 3 is waiting</span><br><span class="line">consumer 0 is waiting</span><br><span class="line">consumer 4 is waiting</span><br><span class="line">consumer 1 is waiting</span><br><span class="line">notifying 2 consumers</span><br><span class="line">consumer 2 triggered</span><br><span class="line">ending consumer 2</span><br><span class="line">consumer 3 triggered</span><br><span class="line">ending consumer 3</span><br><span class="line">notifying remaining consumers</span><br><span class="line">ending manipulate_condition</span><br><span class="line">consumer 0 triggered</span><br><span class="line">ending consumer 0</span><br><span class="line">consumer 4 triggered</span><br><span class="line">ending consumer 4</span><br><span class="line">consumer 1 triggered</span><br><span class="line">ending consumer 1</span><br></pre></td></tr></table></figure><h3 id="queue">Queue</h3><p><code>asyncio.Queue</code> ä¸ºåç¨‹æä¾›äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äºä¸å¤šçº¿ç¨‹ä¸­çš„ <code>queue.Queue</code>ï¼Œå¤šè¿›ç¨‹ä¸­çš„ <code>multiprocessing.Queue</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(n, q)</span>:</span></span><br><span class="line">    print(<span class="string">f'consumer <span class="subst">&#123;n&#125;</span>: starting'</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        print(<span class="string">f'consumer <span class="subst">&#123;n&#125;</span>: waiting for item'</span>)</span><br><span class="line">        item = <span class="keyword">await</span> q.get()</span><br><span class="line">        print(<span class="string">f'consumer <span class="subst">&#123;n&#125;</span>: has item <span class="subst">&#123;item&#125;</span>'</span>)</span><br><span class="line">        <span class="comment"># None è¡¨ç¤ºç»ˆæ­¢ä¿¡å·</span></span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            q.task_done()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span> * item)</span><br><span class="line">            q.task_done()</span><br><span class="line">    print(<span class="string">f'consumer <span class="subst">&#123;n&#125;</span>: ending'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">(q, num_workers)</span>:</span></span><br><span class="line">    print(<span class="string">'producer: starting'</span>)</span><br><span class="line">    <span class="comment"># å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€äº›æ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_workers * <span class="number">3</span>):</span><br><span class="line">        <span class="keyword">await</span> q.put(i)</span><br><span class="line">        print(<span class="string">f'producer: added task <span class="subst">&#123;i&#125;</span> to the queue'</span>)</span><br><span class="line">    <span class="comment"># ä¼ å…¥ç»ˆæ­¢ä¿¡å·</span></span><br><span class="line">    print(<span class="string">'producer: adding stop signals to the queue'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_workers):</span><br><span class="line">        <span class="keyword">await</span> q.put(<span class="keyword">None</span>)</span><br><span class="line">    print(<span class="string">'producer: waiting for queue to empty'</span>)</span><br><span class="line">    <span class="keyword">await</span> q.join()</span><br><span class="line">    print(<span class="string">'producer: ending'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop, num_consumers)</span>:</span></span><br><span class="line">    <span class="comment"># åˆ›å»ºæŒ‡å®šå¤§å°çš„é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment"># è¶…è¿‡é˜Ÿåˆ—å¤§å°æ—¶ç”Ÿäº§è€…ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ¶ˆè´¹è€…å–å‡ºæ•°æ®</span></span><br><span class="line">    q = asyncio.Queue(maxsize=num_consumers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è°ƒåº¦æ¶ˆè´¹è€…</span></span><br><span class="line">    consumers = [loop.create_task(consumer(i, q)) <span class="keyword">for</span> i <span class="keyword">in</span> range(num_consumers)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è°ƒåº¦ç”Ÿäº§è€…</span></span><br><span class="line">    prod = loop.create_task(producer(q, num_consumers))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*consumers, prod)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop, <span class="number">2</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>put()</code> æ·»åŠ é¡¹æˆ–ä½¿ç”¨ <code>get()</code> è·å–å¹¶åˆ é™¤é¡¹éƒ½æ˜¯å¼‚æ­¥æ“ä½œï¼Œå› ä¸ºé˜Ÿåˆ—å¤§å°å¯èƒ½æ˜¯å›ºå®šçš„ï¼ˆé˜»å¡æ·»åŠ æ“ä½œï¼‰ï¼Œæˆ–è€…é˜Ÿåˆ—å¯èƒ½æ˜¯ç©ºçš„ï¼ˆé˜»å¡è·å–é¡¹çš„æ“ä½œï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">consumer 0: starting</span><br><span class="line">consumer 0: waiting for item</span><br><span class="line">consumer 1: starting</span><br><span class="line">consumer 1: waiting for item</span><br><span class="line">producer: starting</span><br><span class="line">producer: added task 0 to the queue</span><br><span class="line">producer: added task 1 to the queue</span><br><span class="line">consumer 0: has item 0</span><br><span class="line">consumer 1: has item 1</span><br><span class="line">producer: added task 2 to the queue</span><br><span class="line">producer: added task 3 to the queue</span><br><span class="line">consumer 0: waiting for item</span><br><span class="line">consumer 0: has item 2</span><br><span class="line">producer: added task 4 to the queue</span><br><span class="line">consumer 1: waiting for item</span><br><span class="line">consumer 1: has item 3</span><br><span class="line">producer: added task 5 to the queue</span><br><span class="line">producer: adding stop signals to the queue</span><br><span class="line">consumer 0: waiting for item</span><br><span class="line">consumer 0: has item 4</span><br><span class="line">consumer 1: waiting for item</span><br><span class="line">consumer 1: has item 5</span><br><span class="line">producer: waiting for queue to empty</span><br><span class="line">consumer 0: waiting for item</span><br><span class="line">consumer 0: has item None</span><br><span class="line">consumer 0: ending</span><br><span class="line">consumer 1: waiting for item</span><br><span class="line">consumer 1: has item None</span><br><span class="line">consumer 1: ending</span><br><span class="line">producer: ending</span><br></pre></td></tr></table></figure><h2 id="ç”¨-protocol-æŠ½è±¡ç±»å®ç°å¼‚æ­¥-i-o">ç”¨ Protocol æŠ½è±¡ç±»å®ç°å¼‚æ­¥ I / O</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™äº›ç¤ºä¾‹éƒ½é¿å…äº†å°†å¹¶å‘å’Œ I / O æ“ä½œæ··åˆåœ¨ä¸€èµ·ï¼Œä¸€æ¬¡åªå…³æ³¨ä¸€ä¸ªæ¦‚å¿µã€‚ä½†æ˜¯ï¼Œåœ¨ I / O é˜»å¡æ—¶åˆ‡æ¢ä¸Šä¸‹æ–‡æ˜¯ <code>asyncio</code> çš„ä¸»è¦ä½¿ç”¨æƒ…å½¢ä¹‹ä¸€ã€‚åœ¨å·²ç»ä»‹ç»çš„å¹¶å‘æ¦‚å¿µçš„åŸºç¡€ä¸Šï¼Œæœ¬èŠ‚å°†å®ç°ç®€å•çš„ echo æœåŠ¡å™¨ç¨‹åºå’Œå®¢æˆ·ç«¯ç¨‹åºã€‚å®¢æˆ·ç«¯å¯ä»¥è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå‘é€ä¸€äº›æ•°æ®ï¼Œç„¶åæ¥æ”¶ä¸å“åº”ç›¸åŒçš„æ•°æ®ã€‚æ¯æ¬¡å¯åŠ¨ I / O æ“ä½œæ—¶ï¼Œæ‰§è¡Œä»£ç éƒ½ä¼šæ”¾å¼ƒå¯¹äº‹ä»¶å¾ªç¯çš„æ§åˆ¶ï¼Œä»è€Œå…è®¸å…¶ä»–ä»»åŠ¡è¿è¡Œï¼Œç›´åˆ° I / O æ“ä½œå°±ç»ªã€‚</p><h3 id="echo-æœåŠ¡å™¨">Echo æœåŠ¡å™¨</h3><p>æœåŠ¡å™¨é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„ <code>asyncio</code> å’Œ <code>logging</code> æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">SERVER_ADDRESS = (<span class="string">'localhost'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    format=<span class="string">'%(name)s: %(message)s'</span>,</span><br><span class="line">    stream=sys.stderr,</span><br><span class="line">)</span><br><span class="line">log = logging.getLogger(<span class="string">'main'</span>)</span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br></pre></td></tr></table></figure><p>ç„¶åå®šä¹‰äº†ä¸€ä¸ª <code>asyncio.Protocol</code> çš„å­ç±»ï¼Œç”¨æ¥å¤„ç†ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ã€‚<code>Protocol</code> å¯¹è±¡çš„æ–¹æ³•æ˜¯åŸºäºä¸æœåŠ¡å™¨ socket å…³è”çš„äº‹ä»¶è°ƒç”¨çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span><span class="params">(asyncio.Protocol)</span>:</span></span><br></pre></td></tr></table></figure><p>æ¯ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥éƒ½ä¼šè§¦å‘å¯¹ <code>connection_made()Â </code> çš„è°ƒç”¨ã€‚<code>transport</code> å‚æ•°æ˜¯<code>asyncio.Transport</code> çš„å®ä¾‹ï¼Œå®ƒæä¾›äº†ä½¿ç”¨ socket è¿›è¡Œå¼‚æ­¥ I / O çš„æŠ½è±¡ã€‚ä¸åŒç±»å‹çš„é€šä¿¡æä¾›ä¸åŒçš„ <code>tansport</code> å®ç°ï¼Œæ‰€æœ‰è¿™äº›å®ç°éƒ½å…·æœ‰ç›¸åŒçš„ APIã€‚ä¾‹å¦‚ï¼Œæœ‰å•ç‹¬çš„ <code>transport</code> ç±»ç”¨äºä¸ socket é€šä¿¡ã€ä¸å­è¿›ç¨‹é€šè¿‡ç®¡é“é€šä¿¡ã€‚ä¼ å…¥å®¢æˆ·ç«¯çš„åœ°å€å¯ä»¥é€šè¿‡ <code>transport</code> çš„ <code>get_extra_info()</code> è·å–ï¼Œè¿™æ˜¯ä¸€ç§ç‰¹å®šäºå®ç°çš„æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connection_made</span><span class="params">(self, transport)</span>:</span></span><br><span class="line">    self.transport = transport</span><br><span class="line">    self.address = transport.get_extra_info(<span class="string">'peername'</span>)</span><br><span class="line">    self.log = logging.getLogger(<span class="string">'EchoServer_&#123;&#125;_&#123;&#125;'</span>.format(*self.address))</span><br><span class="line">    self.log.debug(<span class="string">'connection accepted'</span>)</span><br></pre></td></tr></table></figure><p>å»ºç«‹è¿æ¥åï¼Œå½“æ•°æ®ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨æ—¶ï¼Œå°†è°ƒç”¨åè®®çš„ Â <code>data_received()</code> æ–¹æ³•å°†æ•°æ®ä¼ å…¥ä»¥è¿›è¡Œå¤„ç†ã€‚æ•°æ®ä»¥å­—èŠ‚ä¸²çš„å½¢å¼ä¼ é€’ï¼Œç”±åº”ç”¨ç¨‹åºä»¥é€‚å½“çš„æ–¹å¼å¯¹å…¶è¿›è¡Œè§£ç ã€‚åœ¨è¿™é‡Œè®°å½•ç»“æœï¼Œç„¶åé€šè¿‡è°ƒç”¨ <code>transport.write()</code> ç«‹å³å°†å“åº”å‘é€å›å®¢æˆ·ç«¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data_received</span><span class="params">(self, data)</span>:</span></span><br><span class="line">    self.log.debug(<span class="string">'received &#123;!r&#125;'</span>.format(data))</span><br><span class="line">    self.transport.write(data)</span><br><span class="line">    self.log.debug(<span class="string">'sent &#123;!r&#125;'</span>.format(data))</span><br></pre></td></tr></table></figure><p>æŸäº› <code>transport</code> æ”¯æŒç‰¹æ®Šçš„æ–‡ä»¶ç»“æŸæ ‡è¯†ç¬¦ï¼ˆEOFï¼‰ã€‚é‡åˆ° EOF æ—¶ï¼Œå°†è°ƒç”¨ <code>eof_received()</code> æ–¹æ³•ã€‚åœ¨è¿™ä¸ªå®ç°ä¸­ï¼ŒEOF è¢«å‘é€å›å®¢æˆ·ç«¯æ¥è¡¨ç¤ºå®ƒå·²è¢«æ¥æ”¶ã€‚ç”±äºå¹¶éæ‰€æœ‰ <code>transport</code> éƒ½æ”¯æŒæ˜¾å¼ EOFï¼Œå› æ­¤ <code>protocol</code> é¦–å…ˆè¯¢é—® <code>transport</code> å‘é€ EOF æ˜¯å¦å®‰å…¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eof_received</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.log.debug(<span class="string">'received EOF'</span>)</span><br><span class="line">    <span class="keyword">if</span> self.transport.can_write_eof():</span><br><span class="line">        self.transport.write_eof()</span><br></pre></td></tr></table></figure><p>å½“è¿æ¥å…³é—­æ—¶ï¼Œæ— è®ºæ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯é”™è¯¯å…³é—­ï¼Œéƒ½ä¼šè°ƒç”¨ <code>protocol</code> çš„ Â <code>connection_lost()</code>Â  æ–¹æ³•ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå‚æ•°ä¼šåŒ…å«é€‚å½“çš„å¼‚å¸¸å¯¹è±¡ï¼Œå¦åˆ™ä¸º <code>None</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connection_lost</span><span class="params">(self, error)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> error:</span><br><span class="line">        self.log.error(<span class="string">f'ERROR: <span class="subst">&#123;error&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.log.debug(<span class="string">'closing'</span>)</span><br><span class="line">    super().connection_lost(error)</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡å™¨æœ‰ä¸¤ä¸ªæ­¥éª¤ã€‚é¦–å…ˆï¼Œåº”ç”¨ç¨‹åºå‘Šè¯‰äº‹ä»¶å¾ªç¯è¦ä½¿ç”¨çš„ <code>protocol</code> ç±»ä»¥åŠè¦ä¾¦å¬çš„ä¸»æœºåå’Œ socketï¼Œç”¨æ¥åˆ›å»ºæ–°çš„æœåŠ¡å™¨å¯¹è±¡ã€‚<code>create_server()</code> æ–¹æ³•æ˜¯åç¨‹ï¼Œå› æ­¤å¿…é¡»ç”±äº‹ä»¶å¾ªç¯å¤„ç†ç»“æœï¼Œæ‰èƒ½çœŸæ­£çš„å¯åŠ¨æœåŠ¡å™¨ã€‚ç„¶åï¼Œåç¨‹å®Œæˆåäº§ç”Ÿäº†ä¸€ä¸ªç»‘å®šåˆ°äº‹ä»¶å¾ªç¯çš„ <code>asyncio.Server</code> å®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">factory = event_loop.create_server(EchoServer, *SERVER_ADDRESS)</span><br><span class="line">server = event_loop.run_until_complete(factory)</span><br><span class="line">log.debug(<span class="string">'starting up on &#123;&#125; port &#123;&#125;'</span>.format(*SERVER_ADDRESS))</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œéœ€è¦è¿è¡Œäº‹ä»¶å¾ªç¯ä»¥å¤„ç†äº‹ä»¶å’Œå®¢æˆ·ç«¯è¯·æ±‚ã€‚å¯¹äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ï¼Œ<code>run_forever()</code> æ–¹æ³•æ˜¯æœ€ç®€å•çš„æ–¹æ³•ã€‚å½“äº‹ä»¶å¾ªç¯åœæ­¢æ—¶ï¼Œæ— è®ºæ˜¯é€šè¿‡åº”ç”¨ç¨‹åºä»£ç è¿˜æ˜¯é€šè¿‡å‘ä¿¡å·é€šçŸ¥è¿›ç¨‹ï¼ŒæœåŠ¡å™¨éƒ½å¯ä»¥å…³é—­ï¼Œä»¥ä¾¿æ­£ç¡®æ¸…ç† socketï¼Œç„¶åå¯ä»¥å…³é—­äº‹ä»¶å¾ªç¯ï¼Œä»¥ä¾¿åœ¨ç¨‹åºé€€å‡ºä¹‹å‰å®Œæˆå¯¹ä»»ä½•å…¶ä»–äº‹åŠ¡çš„å¤„ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_forever()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    log.debug(<span class="string">'closing server'</span>)</span><br><span class="line">    server.close()</span><br><span class="line">    event_loop.run_until_complete(server.wait_closed())</span><br><span class="line">    log.debug(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><h3 id="echo-å®¢æˆ·ç«¯">Echo å®¢æˆ·ç«¯</h3><p>ä½¿ç”¨ <code>protocol</code> ç±»æ„é€ å®¢æˆ·ç«¯éå¸¸ç±»ä¼¼äºæ„é€ æœåŠ¡å™¨ã€‚é¦–å…ˆå¯¼å…¥æ‰€éœ€çš„ <code>asyncio</code> å’Œ <code>logging</code> æ¨¡å—ï¼Œç„¶ååˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">MESSAGES = [</span><br><span class="line">    <span class="string">b'This is the message. '</span>,</span><br><span class="line">    <span class="string">b'It will be sent '</span>,</span><br><span class="line">    <span class="string">b'in parts.'</span>,</span><br><span class="line">]</span><br><span class="line">SERVER_ADDRESS = (<span class="string">'localhost'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    format=<span class="string">'%(name)s: %(message)s'</span>,</span><br><span class="line">    stream=sys.stderr,</span><br><span class="line">)</span><br><span class="line">log = logging.getLogger(<span class="string">'main'</span>)</span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ <code>protocol</code> ç±»å®šä¹‰äº†ä¸æœåŠ¡å™¨ç›¸åŒçš„æ–¹æ³•ï¼Œä½†å®ç°æ–¹å¼ä¸åŒã€‚ç±»æ„é€ å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯è¦å‘é€çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>future</code> çš„å®ä¾‹ï¼Œç”¨äºé€šè¿‡æ¥æ”¶æ¥è‡ªæœåŠ¡å™¨çš„å“åº”æ¥è¡¨æ˜å®¢æˆ·ç«¯å·²ç»å®Œæˆäº†ä¸€ä¸ªå·¥ä½œå‘¨æœŸï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoClient</span><span class="params">(asyncio.Protocol)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, messages, future)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.messages = messages</span><br><span class="line">        self.log = logging.getLogger(<span class="string">'EchoClient'</span>)</span><br><span class="line">        self.f = future</span><br></pre></td></tr></table></figure><p>å½“å®¢æˆ·ç«¯æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼Œå®ƒå°†ç«‹å³å¼€å§‹é€šä¿¡ã€‚æ¶ˆæ¯åºåˆ—ä¸€æ¬¡å‘é€ä¸€æ¡ï¼Œå°½ç®¡åº•å±‚ç½‘ç»œä»£ç å¯ä»¥å°†å¤šä¸ªæ¶ˆæ¯ç»„åˆæˆä¸€ä¸ªä¼ è¾“ã€‚å½“æ‰€æœ‰æ¶ˆæ¯éƒ½ç”¨å°½æ—¶ï¼Œå°†å‘é€ EOFã€‚</p><p>è™½ç„¶çœ‹èµ·æ¥æ•°æ®éƒ½æ˜¯ç«‹å³å‘é€çš„ï¼Œä½†å®é™…ä¸Š <code>transport</code> å¯¹è±¡ç¼“å†²ä¼ å‡ºçš„æ•°æ®ï¼Œå¹¶åœ¨å½“ socket çš„ç¼“å†²åŒºå‡†å¤‡å¥½æ¥æ”¶æ•°æ®æ—¶è®¾ç½®å›è°ƒæ¥è¿›è¡Œå®é™…çš„ä¼ è¾“ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯é€æ˜å¤„ç†çš„ï¼Œå› æ­¤å¯ä»¥ç¼–å†™åº”ç”¨ç¨‹åºä»£ç ï¼Œå°±å¥½åƒ I / O æ“ä½œæ­£åœ¨ç«‹å³å‘ç”Ÿä¸€æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connection_made</span><span class="params">(self, transport)</span>:</span></span><br><span class="line">    self.transport = transport</span><br><span class="line">    self.address = transport.get_extra_info(<span class="string">'peername'</span>)</span><br><span class="line">    self.log.debug(<span class="string">'connecting to &#123;&#125; port &#123;&#125;'</span>.format(*self.address))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿™é‡Œå¯ä»¥æ˜¯ transport.writelines()</span></span><br><span class="line">    <span class="comment"># ä½†è¿™ä¼šä½¿æ˜¾ç¤ºè¦å‘é€çš„æ¶ˆæ¯çš„æ¯ä¸ªéƒ¨åˆ†å˜å¾—æ›´åŠ å›°éš¾</span></span><br><span class="line">    <span class="keyword">for</span> msg <span class="keyword">in</span> self.messages:</span><br><span class="line">        transport.write(msg)</span><br><span class="line">        self.log.debug(<span class="string">f'sending <span class="subst">&#123;msg!r&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">if</span> transport.can_write_eof():</span><br><span class="line">        transport.write_eof()</span><br></pre></td></tr></table></figure><p>æ”¶åˆ°æ¥è‡ªæœåŠ¡å™¨çš„å“åº”æ—¶ï¼Œå°†è®°å½•è¯¥å“åº”ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data_received</span><span class="params">(self, data)</span>:</span></span><br><span class="line">    self.log.debug(<span class="string">f'received <span class="subst">&#123;data!r&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>å½“ä»æœåŠ¡å™¨ç«¯æ¥æ”¶åˆ° EOF æˆ–è€…è¿æ¥è¢«å…³é—­æ—¶ï¼Œæœ¬åœ° <code>transport</code> å¯¹è±¡è¢«å…³é—­ï¼Œå¹¶é€šè¿‡è®¾ç½®ç»“æœå°† <code>future</code> å¯¹è±¡æ ‡è®°ä¸ºå®Œæˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eof_received</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.log.debug(<span class="string">'received EOF'</span>)</span><br><span class="line">    self.transport.close()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.f.done():</span><br><span class="line">        self.f.set_result(<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connection_lost</span><span class="params">(self, exc)</span>:</span></span><br><span class="line">    self.log.debug(<span class="string">'server closed connection'</span>)</span><br><span class="line">    self.transport.close()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.f.done():</span><br><span class="line">        self.f.set_result(<span class="keyword">True</span>)</span><br><span class="line">    super().connection_lost(exc)</span><br></pre></td></tr></table></figure><p>é€šå¸¸ï¼Œ<code>protocol</code> ç±»è¢«ä¼ é€’åˆ°äº‹ä»¶å¾ªç¯ä»¥åˆ›å»ºè¿æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºäº‹ä»¶å¾ªç¯æ²¡æœ‰å‘ <code>protocol</code> æ„é€ å‡½æ•°ä¼ é€’é¢å¤–å‚æ•°çš„å·¥å…·ï¼Œå› æ­¤éœ€è¦ <code>functools.partial()</code> æ¥åŒ…è£…å®¢æˆ·ç«¯ç±»ï¼Œå¹¶ä¼ é€’è¦å‘é€çš„æ¶ˆæ¯åˆ—è¡¨å’Œ <code>future</code> çš„å®ä¾‹ã€‚ç„¶åï¼Œåœ¨è°ƒç”¨ <code>create_connection()</code> å»ºç«‹å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå°†ä½¿ç”¨è¯¥æ–°çš„å¯è°ƒç”¨å¯¹è±¡ä»£æ›¿ <code>protocol</code> ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">client_completed = asyncio.Future()</span><br><span class="line"></span><br><span class="line">client_factory = functools.partial(</span><br><span class="line">    EchoClient,</span><br><span class="line">    messages=MESSAGES,</span><br><span class="line">    future=client_completed,</span><br><span class="line">)</span><br><span class="line">factory_coroutine = event_loop.create_connection(</span><br><span class="line">    client_factory,</span><br><span class="line">    *SERVER_ADDRESS,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è§¦å‘å®¢æˆ·ç«¯è¿è¡Œï¼Œäº‹ä»¶å¾ªç¯å°†è°ƒç”¨ä¸€æ¬¡åˆ›å»ºå®¢æˆ·ç«¯çš„åç¨‹ï¼Œç„¶åå†è°ƒç”¨ä¸€æ¬¡æŒ‡å®šç»™å®¢æˆ·ç«¯çš„ <code>future</code> å®ä¾‹ï¼Œä»¥ä¾¿åœ¨å®Œæˆåè¿›è¡Œé€šä¿¡ã€‚ä½¿ç”¨è¿™æ ·çš„ä¸¤ä¸ªè°ƒç”¨é¿å…äº†å®¢æˆ·ç«¯ç¨‹åºä¸­çš„æ— é™å¾ªç¯ï¼Œå®¢æˆ·ç«¯ç¨‹åºå¯èƒ½å¸Œæœ›åœ¨å®Œæˆä¸æœåŠ¡å™¨çš„é€šä¿¡åé€€å‡ºã€‚å¦‚æœä»…ä½¿ç”¨ç¬¬ä¸€ä¸ªè°ƒç”¨æ¥ç­‰å¾…åç¨‹åˆ›å»ºå®¢æˆ·ç«¯ï¼Œé‚£å®ƒå¯èƒ½æ— æ³•å¤„ç†æ‰€æœ‰å“åº”æ•°æ®å¹¶æ­£ç¡®æ¸…ç†ä¸æœåŠ¡å™¨çš„è¿æ¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log.debug(<span class="string">'waiting for client to complete'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(factory_coroutine)</span><br><span class="line">    event_loop.run_until_complete(client_completed)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    log.debug(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><h3 id="è¾“å‡º">è¾“å‡º</h3><p>åœ¨ä¸€ä¸ªçª—å£ä¸­è¿è¡ŒæœåŠ¡å™¨è€Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­è¿è¡Œå®¢æˆ·ç«¯ã€‚</p><p>å®¢æˆ·ç«¯å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">asyncio: Using selector: KqueueSelector</span><br><span class="line">main: waiting for client to complete</span><br><span class="line">EchoClient: connecting to ::1 port 10000</span><br><span class="line">EchoClient: sending b'This is the message. '</span><br><span class="line">EchoClient: sending b'It will be sent '</span><br><span class="line">EchoClient: sending b'in parts.'</span><br><span class="line">EchoClient: received b'This is the message. It will be sent in parts.'</span><br><span class="line">EchoClient: received EOF</span><br><span class="line">EchoClient: server closed connection</span><br><span class="line">main: closing event loop</span><br></pre></td></tr></table></figure><p>è™½ç„¶å®¢æˆ·ç«¯æ€»æ˜¯å•ç‹¬å‘é€æ¶ˆæ¯ï¼Œä½†å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ”¶åˆ°ä¸€æ¡å¤§æ¶ˆæ¯ï¼Œå¹¶å°†è¯¥æ¶ˆæ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ ¹æ®ç½‘ç»œçš„ç¹å¿™ç¨‹åº¦ä»¥åŠæ˜¯å¦åœ¨å‡†å¤‡æ‰€æœ‰æ•°æ®ä¹‹å‰åˆ·æ–°ç½‘ç»œç¼“å†²åŒºï¼Œè¿™äº›ç»“æœåœ¨åç»­è¿è¡Œä¸­ä¼šæœ‰æ‰€ä¸åŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">asyncio: Using selector: KqueueSelector</span><br><span class="line">main: starting up on localhost port 10000</span><br><span class="line">EchoServer_::1_55307: connection accepted</span><br><span class="line">EchoServer_::1_55307: received b'This is the message. It will be sent in part</span><br><span class="line">s.'</span><br><span class="line">EchoServer_::1_55307: sent b'This is the message. It will be sent in parts.'</span><br><span class="line">EchoServer_::1_55307: received EOF</span><br><span class="line">EchoServer_::1_55307: closing</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EchoServer_::1_55309: connection accepted</span><br><span class="line">EchoServer_::1_55309: received b'This is the message. '</span><br><span class="line">EchoServer_::1_55309: sent b'This is the message. '</span><br><span class="line">EchoServer_::1_55309: received b'It will be sent in parts.'</span><br><span class="line">EchoServer_::1_55309: sent b'It will be sent in parts.'</span><br><span class="line">EchoServer_::1_55309: received EOF</span><br><span class="line">EchoServer_::1_55309: closing</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¹¦æ¥ä¸Šæ–‡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åŒæ­¥åŸè¯­&quot;&gt;åŒæ­¥åŸè¯­&lt;/h2&gt;
&lt;p&gt;è™½ç„¶ä½¿ç”¨ &lt;code&gt;asyncio&lt;/code&gt; çš„ç¨‹åºé€šå¸¸éƒ½ä»¥å•çº¿ç¨‹è¿è¡Œï¼Œä½†ä»ç„¶å¯ä»¥ä½œä¸ºå¹¶å‘ç¨‹åºã€‚æ¯ä¸ªåç¨‹æˆ–ä»»åŠ¡å¯ä»¥æ ¹æ®æ¥è‡ª I / O
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Javaä¸­Stringã€StringBufferä¸StringBuilderçš„åŒºåˆ«</title>
    <link href="http://weafteam.github.io/posts/2870b42a/"/>
    <id>http://weafteam.github.io/posts/2870b42a/</id>
    <published>2018-05-03T07:39:02.000Z</published>
    <updated>2018-05-29T01:27:49.865Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘å‡†å¤‡å¼€å§‹åˆ·ç‰›å®¢ç½‘ä¸Šçš„é¢˜ç›®ï¼Œä¸ºæ‰¾å·¥ä½œé¢è¯•åšå‡†å¤‡ï¼Œä»Šåæˆ‘ä¼šå°†å…¶ä¸­æ„Ÿè§‰æ¯”è¾ƒä¸é”™çš„çŸ¥è¯†ç‚¹æ€»ç»“å‡ºæ¥å½¢æˆåšå®¢ï¼Œè´´å‡ºæ¥ä¸å¤§å®¶å…±åŒå­¦ä¹ ï¼Œå¦‚æœå…¶ä¸­å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶ä¸åæŒ‡æ•™ï¼Œé‚®ç®±åœ°å€ä¸ºwell@weaf.topã€‚</p></blockquote><p>ä¸‹é¢å¼€å§‹æœ¬æ¬¡çš„å†…å®¹æ•´ç†å§~</p><h1 id="string">String</h1><p>é¦–å…ˆè¯´ä¸€ä¸‹Stringç±»çš„å£°æ˜,é€šè¿‡æŸ¥é˜…æºç å¯çŸ¥å®ƒçš„å£°æ˜æ˜¯public finalï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„å­—ç¬¦ä¸²çš„å€¼ä¸€æ—¦æ”¹å˜ï¼Œæˆ‘ä»¬å°±å¾—å†å‘å†…å­˜é‡æ–°ç”³è¯·ä¸€å—åœ°æ–¹å­˜æ”¾æ”¹å˜ä¹‹åçš„å­—ç¬¦ä¸²ã€‚å¾ˆæ˜¾ç„¶ï¼ŒStringæ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼Œå­—ç¬¦é•¿åº¦ä¸å¯å˜ã€‚å…¶å®è¿™æ˜¯ä¸€ä»¶å¾ˆææ€–çš„äº‹æƒ…ï¼Œå½“ä½ éœ€è¦å¤šæ¬¡æ”¹å˜æ—¶ï¼Œå¤šæ¬¡çš„æ”¹å˜äº§ç”Ÿçš„ä»£ä»·ä¸è¨€è€Œå–»ã€‚</p><h1 id="stringbuffer">StringBuffer</h1><p>StringBufferæ˜¯å­—ç¬¦ä¸²å˜é‡ï¼Œæ”¯æŒå¤šçº¿ç¨‹è¿›è¡Œå­—ç¬¦æ“ä½œï¼Œè€Œä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€‚åˆåœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ã€‚åŸå› æ˜¯åœ¨æºä»£ç ä¸­StringBuilderçš„å¾ˆå¤šæ–¹æ³•éƒ½è¢«å…³é”®å­—synchronizedä¿®é¥°äº†ï¼Œè¿™ä¹Ÿæ˜¯StringBufferå’ŒStringBuilderçš„æœ€å¤§åŒºåˆ«çš„åœ°æ–¹ã€‚</p><h1 id="stringbuilder">StringBuilder</h1><p>StringBuilderä¹Ÿæ˜¯å­—ç¬¦ä¸²å˜é‡ï¼Œä½†æ˜¯åŒºåˆ«äºStringBufferï¼Œå®ƒå¹¶ä¸æ”¯æŒå¹¶å‘æ“ä½œï¼Œéçº¿ç¨‹å®‰å…¨ï¼Œä¸é€‚åˆåœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯å…¶åœ¨å•çº¿ç¨‹ä¸­çš„æ€§èƒ½æ¯”StringBufferé«˜ã€‚</p><h1 id="æµ‹è¯•">æµ‹è¯•</h1><h2 id="ä»£ç ">ä»£ç </h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EchoNum = <span class="number">10000</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TestStr</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String A = <span class="keyword">new</span> String(<span class="string">"AAA"</span>);</span><br><span class="line">        <span class="keyword">long</span> StartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;EchoNum;i++)&#123;</span><br><span class="line">            A+=<span class="string">"A"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> EndTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"String: "</span>+ (EndTime-StartTime)+<span class="string">" millis has been used"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TestStrBuffer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        StringBuffer A = <span class="keyword">new</span> StringBuffer(<span class="string">"AAA"</span>);</span><br><span class="line">        <span class="keyword">long</span> StartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;EchoNum;i++)&#123;</span><br><span class="line">            A = A.append(<span class="string">"A"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> EndTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"StringBuffer: "</span>+ (EndTime-StartTime)+<span class="string">" millis has been used"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TestStrBuilder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        StringBuilder A = <span class="keyword">new</span> StringBuilder(<span class="string">"AAA"</span>);</span><br><span class="line">        <span class="keyword">long</span> StartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;EchoNum;i++)&#123;</span><br><span class="line">            A = A.append(<span class="string">"A"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> EndTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"StringBuilder: "</span>+ (EndTime-StartTime)+<span class="string">" millis has been used"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        TestStr();</span><br><span class="line">        TestStrBuffer();</span><br><span class="line">        TestStrBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç»“æœ">ç»“æœ</h2><p><img src="https://i.loli.net/2018/05/06/5aee5e758b3a0.png" alt="StringsResult.png"></p><p>ç»“æœå°±å¾ˆæ˜æ˜¾äº†ï¼ŒStringçš„æ•ˆç‡æœ€ä½ä¸‹ï¼Œåªè€ƒè™‘å•çº¿ç¨‹çš„è¯ï¼Œæ¨èä½¿ç”¨StringBuilderï¼›ä½†æ˜¯å¦‚æœæ˜¯è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„è¯ï¼Œè‚¯å®šè¦ä½¿ç”¨StringBufferã€‚</p><p>ç¨å¾®æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li>å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨æ•´ä¸ªç¨‹åºä¸­ä¸éœ€è¦ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œ<strong>String</strong>æ˜¯é¦–é€‰ã€‚</li><li>å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº«çš„åŠ¨æ€å­—ç¬¦ä¸²ï¼Œ<strong>StringBuffer</strong>æ˜¯æˆ‘ä»¬çš„é€‰æ‹©ã€‚</li><li>å¦‚æœä»¥ä¸Šä¸¤ç§æƒ…å†µéƒ½ä¸å­˜åœ¨ï¼Œ<strong>StringBuilder</strong>æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</li></ul><h1 id="ç»ƒæ‰‹">ç»ƒæ‰‹</h1><p>ç„¶åæ¥çœ‹ä¸€é“é˜¿é‡Œå·´å·´çš„é¢è¯•é¢˜å§ï¼Œé¢˜ç›®å†…å®¹å¦‚ä¸‹ï¼š</p><p><strong>é¢˜ç›®ï¼š</strong> (å•é€‰é¢˜)Javaä¸­ï¼ŒStringBuilderå’ŒStringBufferçš„åŒºåˆ«ï¼Œä¸‹é¢è¯´æ³•é”™è¯¯çš„æ˜¯ï¼Ÿ</p><p><strong>Aï¼š</strong> StringBufferæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p><strong>Bï¼š</strong> StringBuilderæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚</p><p><strong>Cï¼š</strong> StringBufferå¯¹Stringç±»å‹è¿›è¡Œæ”¹å˜çš„æ—¶å€™ï¼Œå…¶å®éƒ½ç­‰åŒäºç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„Stringå¯¹è±¡ï¼Œç„¶åå°†æŒ‡é’ˆæŒ‡å‘æ–°çš„Stringå¯¹è±¡ã€‚</p><p><strong>Dï¼š</strong> æ•ˆç‡æ¯”è¾ƒ String &lt; StringBuffer &lt; StringBuilderï¼Œä½†æ˜¯åœ¨ String S1 = â€œThis is only aâ€ + &quot; simple&quot; + &quot; testâ€œæ—¶ï¼ŒStringçš„æ•ˆç‡æœ€é«˜ã€‚</p><p><strong>åˆ†æï¼š</strong></p><p>Aï¼ŒBå°±ä¸ç”¨å¤šè¯´äº†ï¼Œè‚¯å®šæ˜¯æ­£ç¡®çš„ã€‚Cé¡¹ä¸€çœ¼å…¶å®å°±èƒ½çœ‹å‡ºæ¥æ˜¯é”™è¯¯çš„ï¼ŒStringBufferå’ŒStringBuilderéƒ½æ˜¯å­—ç¬¦ä¸²å˜é‡ï¼Œå¹¶ä¸éœ€è¦é‡æ–°ç”³è¯·å†…å­˜å­˜æ”¾æ–°çš„å¯¹è±¡ã€‚Dé¡¹ä¸­çš„åä¸€éƒ¨åˆ†<strong>String S1 = â€œThis is only aâ€+ â€œSimpleâ€+â€œTestâ€</strong>ï¼Œå…¶å®è¿™ä¸ªåœ°æ–¹å¹¶æ²¡æœ‰å­—ç¬¦ä¸²æ“ä½œå¤„ç†ï¼Œåªæ˜¯ç®€å•çš„<strong>String S1 = â€œThis is only a simple testâ€</strong>ï¼Œæ‰€ä»¥æ•ˆç‡æœ€é«˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘å‡†å¤‡å¼€å§‹åˆ·ç‰›å®¢ç½‘ä¸Šçš„é¢˜ç›®ï¼Œä¸ºæ‰¾å·¥ä½œé¢è¯•åšå‡†å¤‡ï¼Œä»Šåæˆ‘ä¼šå°†å…¶ä¸­æ„Ÿè§‰æ¯”è¾ƒä¸é”™çš„çŸ¥è¯†ç‚¹æ€»ç»“å‡ºæ¥å½¢æˆåšå®¢ï¼Œè´´å‡ºæ¥ä¸å¤§å®¶å…±åŒå­¦ä¹ ï¼Œå¦‚æœå…¶ä¸­å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶ä¸åæŒ‡æ•™ï¼Œé‚®ç®±åœ°å€ä¸ºwell@weaf.topã€‚&lt;/p&gt;
&lt;/blockquote&gt;

        
      
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="é¢è¯•" scheme="http://weafteam.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>å¾®ä¿¡å…¬ä¼—å·åå°åœ¨SpringBoot2.0ä¸­çš„å®ç°ï¼ˆä¸Šï¼‰</title>
    <link href="http://weafteam.github.io/posts/637facd6/"/>
    <id>http://weafteam.github.io/posts/637facd6/</id>
    <published>2018-05-01T10:13:02.000Z</published>
    <updated>2018-05-29T01:27:49.896Z</updated>
    
    <content type="html"><![CDATA[<p>ç°åœ¨å¾®ä¿¡åœ¨ä¸­å›½ä½œä¸ºæœ€é‡è¦çš„ç¤¾äº¤è½¯ä»¶ï¼Œç›¸ä¿¡å¾ˆå¤šäººéƒ½ä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·ã€‚ è€Œä¸”å¾®ä¿¡å…¬ä¼—å·ä¹Ÿæˆä¸ºä¸€äº›ä¼ä¸šä¼ æ’­èµ„è®¯æœ€å¥½çš„å¹³å°ã€‚ é‚£ä¹ˆä»Šå¤©å°±æ¥è®²ä¸‹å¾®ä¿¡å…¬ä¼—å·åå°å…·ä½“å¦‚ä½•æ¥å®ç°ã€‚ ä¸€ã€ç”³è¯·å…¬ä¼—å· â€”â€”- é¦–å…ˆæˆ‘ä»¬æ ¹æ®è‡ªå·±æ´»ç€ä¼ä¸šçš„æ‰€éœ€çš„ä¸œè¥¿ï¼Œé€‰å®šå¥½ä¸€ä¸‹å‡ ç§ç±»åˆ«çš„è´¦å·ã€‚ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/wechat-1.png" alt="wechat-1"> ä¸åŒçš„è´¦æˆ·æ‹¥æœ‰çš„æƒé™ä¸å°½ç›¸åŒã€‚ è¿™ä¸ªæˆ‘ä»¬å¯ä»¥æ ¹æ®æƒé™æ–‡æ¡£è¿›è¡ŒæŸ¥çœ‹ï¼</p><p><a href="https://mp.weixin.qq.com/advanced/advanced?action=table&amp;token=1776791094&amp;lang=zh_CN" target="_blank" rel="noopener">æ¥å£æƒé™ï¼šhttps://mp.weixin.qq.com/advanced/advanced?action=table&amp;token=1776791094&amp;lang=zh_CN</a> ç„¶åå°±æ˜¯æ ¹æ®è‡ªå·±çš„æ¥å£çš„è¦æ±‚ï¼Œå»å®¡æ‰¹ã€‚ äºŒã€è®¾ç½®åŸºæœ¬é…ç½® â€”â€”â€” <img src="https://weaf.oss-cn-beijing.aliyuncs.com/wechat-2.png" alt="wechat-2"> è¿™é‡Œéœ€è¦æˆ‘ä»¬å…ˆå¼€å¯è‡ªå·±çš„å¼€å‘è€…å¯†ç ã€‚ï¼ˆè¿™ä¸ªæ˜¯æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨çš„ï¼‰</p><p>æœåŠ¡å™¨åœ°å€ï¼ˆURLï¼‰:è¿™é‡Œéœ€è¦è®¾ç½®å…¬ç½‘å¯è®¿é—®çš„æ¥å£</p><p>ä»¤ç‰Œï¼ˆTokenï¼‰ï¼šè¿™å—æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ª32ä¸ºUUIDçš„å­—ç¬¦ä¸²ã€‚</p><p>æ›´å¤šç»†èŠ‚è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319" class="uri" target="_blank" rel="noopener">https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319</a></p><p>ä¸‰ã€ä»£ç çš„å®ç° å…¶ä»–çš„ä¹Ÿå°±ä¸å¤šè¯´äº†ï¼Œç›´æ¥ä¸Šä»£ç ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªä»‹å…¥æŒ‡å—ä¸­ï¼Œå¾®ä¿¡éœ€è¦éªŒè¯çš„æ¥å£ã€‚ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**---------*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"verification"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">weChatVerification</span><span class="params">(String signature, String timestamp, String nonce, String echostr, HttpServletRequest request)</span> <span class="keyword">throws</span> AesException </span>&#123;</span><br><span class="line">    log.info(<span class="string">"å¾®ä¿¡æ ¡éªŒå‚æ•°ï¼šsignature=&#123;&#125;ï¼Œtimestamp=&#123;&#125;ï¼Œnonce=&#123;&#125;ï¼Œechostr=&#123;&#125;"</span>,signature,timestamp,nonce,echostr);</span><br><span class="line">    <span class="keyword">if</span>(signature.equals(getSHA1(token,timestamp,nonce)))</span><br><span class="line">            <span class="keyword">return</span> echostr;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getSHA1</span><span class="params">(String token, String timestamp, String nonce)</span> <span class="keyword">throws</span> AesException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] array = <span class="keyword">new</span> String[] &#123; token, timestamp, nonce &#125;;</span><br><span class="line">            StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="comment">// å­—ç¬¦ä¸²æ’åº</span></span><br><span class="line">            Arrays.sort(array);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                sb.append(array[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            String str = sb.toString();</span><br><span class="line">            <span class="comment">// SHA1ç­¾åç”Ÿæˆ</span></span><br><span class="line">            MessageDigest md = MessageDigest.getInstance(<span class="string">"SHA-1"</span>);</span><br><span class="line">            md.update(str.getBytes());</span><br><span class="line">            <span class="keyword">byte</span>[] digest = md.digest();</span><br><span class="line"></span><br><span class="line">            StringBuffer hexstr = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            String shaHex = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; digest.length; i++) &#123;</span><br><span class="line">                shaHex = Integer.toHexString(digest[i] &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span> (shaHex.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                    hexstr.append(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                hexstr.append(shaHex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> hexstr.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AesException(AesException.ComputeSignatureError);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>ç°åœ¨å°±å·²ç»æ¥å…¥äº†å¾®ä¿¡å…¬ä¼—å¹³å°ã€‚</p>]]></content>
    
    <summary type="html">
    
      å¾®ä¿¡å…¬ä¼—å·åå°åœ¨SpringBoot2.0ä¸­çš„å®ç°ï¼ˆä¸Šï¼‰
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆä¸‰ï¼‰</title>
    <link href="http://weafteam.github.io/posts/c99ebd1c/"/>
    <id>http://weafteam.github.io/posts/c99ebd1c/</id>
    <published>2018-05-01T03:58:22.000Z</published>
    <updated>2018-08-07T08:56:41.618Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šæ–‡ã€‚</p><h2 id="å¹¶è¡Œæ‰§è¡Œä»»åŠ¡">å¹¶è¡Œæ‰§è¡Œä»»åŠ¡</h2><p>ä»»åŠ¡æ˜¯ä¸äº‹ä»¶å¾ªç¯äº¤äº’çš„ä¸»è¦æ–¹å¼ä¹‹ä¸€ã€‚ä»»åŠ¡åŒ…è£…åç¨‹å¹¶è·Ÿè¸ªå®ƒä»¬å®Œæˆçš„æ—¶é—´ã€‚ä»»åŠ¡æ˜¯ <code>future</code> çš„å­ç±»ï¼Œå› æ­¤å…¶å®ƒåç¨‹å¯ä»¥ç­‰å¾…ä»»åŠ¡ï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªç»“æœï¼Œå¯ä»¥åœ¨ä»»åŠ¡å®Œæˆåè·å–ã€‚</p><h3 id="å¯åŠ¨ä»»åŠ¡">å¯åŠ¨ä»»åŠ¡</h3><p>ä½¿ç”¨ <code>create_task()</code> åˆ›å»ºä»»åŠ¡å®ä¾‹ã€‚åªè¦äº‹ä»¶å¾ªç¯æ­£åœ¨è¿è¡Œä¸”åç¨‹ä¸è¿”å›ï¼Œç”Ÿæˆçš„ä»»åŠ¡å°†ä½œä¸ºäº‹ä»¶å¾ªç¯ç®¡ç†çš„å¹¶å‘æ“ä½œçš„ä¸€éƒ¨åˆ†è¿è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">task_func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in task_func'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'the result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    print(<span class="string">'creating task'</span>)</span><br><span class="line">    task = loop.create_task(task_func())</span><br><span class="line">    print(<span class="string">f'waiting for <span class="subst">&#123;task!r&#125;</span>'</span>)</span><br><span class="line">    return_value = <span class="keyword">await</span> task</span><br><span class="line">    print(<span class="string">f'task completed <span class="subst">&#123;task!r&#125;</span>'</span>)</span><br><span class="line">    print(<span class="string">f'return value: <span class="subst">&#123;return_value!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p><code>main()</code> å‡½æ•°åœ¨é€€å‡ºå‰ç­‰å¾…ä»»åŠ¡è¿”å›ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">creating task</span><br><span class="line">waiting for &lt;Task pending coro=&lt;task_func() running at *.py:4&gt;&gt;</span><br><span class="line">in task_func</span><br><span class="line">task completed &lt;Task finished coro=&lt;task_func() done, defined at *.py:4&gt; result='the result'&gt;</span><br><span class="line">return value: 'the result'</span><br></pre></td></tr></table></figure><h3 id="å–æ¶ˆä»»åŠ¡">å–æ¶ˆä»»åŠ¡</h3><p>é€šè¿‡ä¿ç•™ <code>create_task()</code> è¿”å›çš„ä»»åŠ¡å¯¹è±¡ï¼Œå¯ä»¥åœ¨ä»»åŠ¡å®Œæˆä¹‹å‰å–æ¶ˆå…¶æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">task_func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in task_func'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'the result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    print(<span class="string">'creating task'</span>)</span><br><span class="line">    task = loop.create_task(task_func())</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'canceling task'</span>)</span><br><span class="line">    task.cancel()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f'canceled task <span class="subst">&#123;task!r&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> task</span><br><span class="line">    <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">        print(<span class="string">'caught error from canceled task'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">f'task result: <span class="subst">&#123;task.result()!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨äº‹ä»¶å¾ªç¯ä¹‹å‰å–æ¶ˆä»»åŠ¡æ—¶ï¼Œ<code>await task</code> ä¼šæŠ›å‡º <code>CancelledError</code> å¼‚å¸¸ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">creating task</span><br><span class="line">canceling task</span><br><span class="line">canceled task &lt;Task cancelling coro=&lt;task_func() running at *.py:4&gt;&gt;</span><br><span class="line">caught error from canceled task</span><br></pre></td></tr></table></figure><p>å¦‚æœæŸä¸ªä»»åŠ¡åœ¨ç­‰å¾…å¦ä¸€ä¸ªå¹¶å‘æ“ä½œæ—¶è¢«å–æ¶ˆï¼Œåˆ™ä¼šé€šè¿‡åœ¨å…¶ç­‰å¾…çš„ä½ç½®æŠ›å‡º <code>CancelledError</code> å¼‚å¸¸æ¥é€šçŸ¥è¯¥ä»»åŠ¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">task_func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in task_func, sleeping'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">        print(<span class="string">'task_func was canceled'</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'the result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task_canceller</span><span class="params">(t)</span>:</span></span><br><span class="line">    print(<span class="string">'in task_canceller'</span>)</span><br><span class="line">    t.cancel()</span><br><span class="line">    print(<span class="string">'canceled the task'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    print(<span class="string">'creating task'</span>)</span><br><span class="line">    task = loop.create_task(task_func())</span><br><span class="line">    loop.call_soon(task_canceller, task)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> task</span><br><span class="line">    <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">        print(<span class="string">'main() also sees task as canceled'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>æ•è·è¯¥å¼‚å¸¸å¯ä»¥æ¸…ç†å·²å®Œæˆå·¥ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">creating task</span><br><span class="line">in task_func, sleeping</span><br><span class="line">in task_canceller</span><br><span class="line">canceled the task</span><br><span class="line">task_func was canceled</span><br><span class="line">main() also sees task as canceled</span><br></pre></td></tr></table></figure><h3 id="ä»åç¨‹åˆ›å»ºä»»åŠ¡">ä»åç¨‹åˆ›å»ºä»»åŠ¡</h3><p><code>ensure_future()</code> è¿”å›ä¸€ä¸ªä¸åç¨‹çš„æ‰§è¡Œç›¸å…³è”çš„ä»»åŠ¡ã€‚ç„¶åï¼Œå¯ä»¥å°†è¯¥ä»»åŠ¡å®ä¾‹ä¼ é€’ç»™å…¶ä»–ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥åœ¨ä¸çŸ¥é“åŸå§‹çš„åç¨‹æ˜¯å¦‚ä½•æ„é€ æˆ–è°ƒç”¨çš„æƒ…å†µä¸‹ç­‰å¾…å®ƒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'wrapped'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(task)</span>:</span></span><br><span class="line">    print(<span class="string">'inner: starting'</span>)</span><br><span class="line">    print(<span class="string">f'inner: waiting for <span class="subst">&#123;task!r&#125;</span>'</span>)</span><br><span class="line">    result = <span class="keyword">await</span> task</span><br><span class="line">    print(<span class="string">f'inner: task returned <span class="subst">&#123;result!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">starter</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'starter: creating task'</span>)</span><br><span class="line">    task = asyncio.ensure_future(wrapped())</span><br><span class="line">    print(<span class="string">'starter: waiting for inner'</span>)</span><br><span class="line">    <span class="keyword">await</span> inner(task)</span><br><span class="line">    print(<span class="string">'starter: inner returned'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">'entering event loop'</span>)</span><br><span class="line">    result = event_loop.run_until_complete(starter())</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°ä¼ å…¥ <code>ensure_future()</code> çš„åç¨‹ä¸ä¼šé©¬ä¸Šå¯åŠ¨ï¼Œè€Œæ˜¯ç›´åˆ°æŸä¸ªåœ°æ–¹ç”¨ <code>await</code> è°ƒç”¨äº†ç”¨å®ƒåˆ›å»ºçš„ä»»åŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">entering event loop</span><br><span class="line">starter: creating task</span><br><span class="line">starter: waiting for inner</span><br><span class="line">inner: starting</span><br><span class="line">inner: waiting for &lt;Task pending coro=&lt;wrapped() running at *.py:4&gt;&gt;</span><br><span class="line">wrapped</span><br><span class="line">inner: task returned 'result'</span><br><span class="line">starter: inner returned</span><br></pre></td></tr></table></figure><h2 id="ç”¨æ§åˆ¶ç»“æ„ç»„åˆåç¨‹">ç”¨æ§åˆ¶ç»“æ„ç»„åˆåç¨‹</h2><p>ä¸€ç³»åˆ—çº¿æ€§æ‰§è¡Œçš„åç¨‹å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨å…³é”®å­— <code>await</code> ç®¡ç†ã€‚å¯¹äºå¤æ‚çš„æ§åˆ¶ç»“æ„ï¼Œä¾‹å¦‚ä¸€ä¸ªåç¨‹ç­‰å¾…å…¶ä»–å‡ ä¸ªåç¨‹å¹¶è¡Œå®Œæˆï¼Œä¹Ÿå¯ä»¥ç”¨ <code>asyncio</code> ä¸­çš„å·¥å…·å®ç°ã€‚</p><h3 id="ç­‰å¾…å¤šä¸ªåç¨‹">ç­‰å¾…å¤šä¸ªåç¨‹</h3><p>å°†ä¸€ä¸ªæ“ä½œåˆ†æˆè®¸å¤šéƒ¨åˆ†å¹¶åˆ†åˆ«æ‰§è¡Œå®ƒä»¬æ˜¯å¾ˆå¸¸è§çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œä¸‹è½½å¤šä¸ªè¿œç¨‹èµ„æºï¼Œæˆ–æŸ¥è¯¢è¿œç¨‹ APIã€‚åœ¨æ‰§è¡Œé¡ºåºæ— å…³ç´§è¦ï¼Œå¹¶ä¸”å¯èƒ½å­˜åœ¨ä»»æ„æ•°é‡çš„æ“ä½œçš„æƒ…å†µä¸‹ï¼Œ<code>wait()</code> å¯ä»¥ç”¨äºæš‚åœä¸€ä¸ªåç¨‹ï¼Œç›´åˆ°å…¶ä»–åå°æ“ä½œå®Œæˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">phase</span><span class="params">(i)</span>:</span></span><br><span class="line">    print(<span class="string">f'in phase <span class="subst">&#123;i&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span> * i)</span><br><span class="line">    print(<span class="string">f'done with phase <span class="subst">&#123;i&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f'phase <span class="subst">&#123;i&#125;</span> result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(num_phases)</span>:</span></span><br><span class="line">    print(<span class="string">'starting main'</span>)</span><br><span class="line">    phases = [phase(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(num_phases)]</span><br><span class="line">    print(<span class="string">'waiting for phases to complete'</span>)</span><br><span class="line">    completed, pending = <span class="keyword">await</span> asyncio.wait(phases)</span><br><span class="line">    results = [t.result() <span class="keyword">for</span> t <span class="keyword">in</span> completed]</span><br><span class="line">    print(<span class="string">f'results: <span class="subst">&#123;results!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>åœ¨å†…éƒ¨ï¼Œ<code>wait()</code> ä½¿ç”¨ä¸€ä¸ªé›†åˆæ¥ä¿å­˜å®ƒåˆ›å»ºçš„ä»»åŠ¡å®ä¾‹ï¼Œæ‰€ä»¥ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ã€‚<code>wait()</code> çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé›†åˆçš„å…ƒç»„ï¼Œç¬¬ä¸€ä¸ªä¿å­˜äº†çŠ¶æ€ä¸º <code>done</code> çš„ä»»åŠ¡ï¼Œç¬¬äºŒä¸ªä¿å­˜äº†çŠ¶æ€ä¸º <code>pending</code> çš„ä»»åŠ¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">starting main</span><br><span class="line">waiting for phases to complete</span><br><span class="line">in phase 1</span><br><span class="line">in phase 0</span><br><span class="line">in phase 2</span><br><span class="line">done with phase 0</span><br><span class="line">done with phase 1</span><br><span class="line">done with phase 2</span><br><span class="line">results: ['phase 1 result', 'phase 0 result', 'phase 2 result']</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>wait()</code> æ—¶å¦‚æœæŒ‡å®šäº† <code>timeout</code> å‚æ•°ï¼Œæ‰ä¼šå‡ºç°çŠ¶æ€ä¸º <code>pending</code> çš„ä»»åŠ¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">phase</span><span class="params">(i)</span>:</span></span><br><span class="line">    print(<span class="string">f'in phase <span class="subst">&#123;i&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span> * i)</span><br><span class="line">    <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">        print(<span class="string">f'phase <span class="subst">&#123;i&#125;</span> canceled'</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">f'done with phase <span class="subst">&#123;i&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'phase <span class="subst">&#123;i&#125;</span> result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(num_phases)</span>:</span></span><br><span class="line">    print(<span class="string">'starting main'</span>)</span><br><span class="line">    phases = [phase(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(num_phases)]</span><br><span class="line">    print(<span class="string">'waiting 0.1 for phases to complete'</span>)</span><br><span class="line">    completed, pending = <span class="keyword">await</span> asyncio.wait(phases, timeout=<span class="number">0.1</span>)</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;len(completed)&#125;</span> completed and <span class="subst">&#123;len(pending)&#125;</span> pending'</span>)</span><br><span class="line">    <span class="comment"># å–æ¶ˆçŠ¶æ€ä¸º pending çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> pending:</span><br><span class="line">        print(<span class="string">'canceling tasks'</span>)</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> pending:</span><br><span class="line">            t.cancel()</span><br><span class="line">    print(<span class="string">'exiting main'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>è¿™äº›çŠ¶æ€ä¸º <code>pending</code> çš„ä»»åŠ¡åº”è¢«å–æ¶ˆæˆ–è€…ç»§ç»­ç­‰å¾…å®ƒä»¬å®Œæˆã€‚äº‹ä»¶å¾ªç¯ç»§ç»­è¿è¡Œæ—¶è¿™äº›ä»»åŠ¡å°†ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœ<code>wait()</code> å‡½æ•°çš„å®Œæˆè¢«è®¤ä¸ºæ‰€æœ‰æ“ä½œéƒ½å·²ç»ç»ˆæ­¢äº†ï¼Œé‚£è¿™æ ·çš„ç»“æœæ˜¯ä¸æ­£ç¡®çš„ï¼›å¦‚æœåœ¨äº‹ä»¶å¾ªç¯ç»“æŸæ—¶ä»æœªå®Œæˆè¿™äº›ä»»åŠ¡ï¼Œåˆ™ä¼šç”Ÿæˆè­¦å‘Šã€‚æ‰€ä»¥æœ‰å¿…è¦åœ¨ <code>wait()</code> å‡½æ•°ç»“æŸåå–æ¶ˆæ‰€æœ‰çŠ¶æ€ä¸º <code>pending</code> çš„ä»»åŠ¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">starting main</span><br><span class="line">waiting 0.1 for phases to complete</span><br><span class="line">in phase 0</span><br><span class="line">in phase 1</span><br><span class="line">in phase 2</span><br><span class="line">done with phase 0</span><br><span class="line">1 completed and 2 pending</span><br><span class="line">canceling tasks</span><br><span class="line">exiting main</span><br><span class="line">phase 1 canceled</span><br><span class="line">phase 2 canceled</span><br></pre></td></tr></table></figure><h3 id="æ”¶é›†åç¨‹çš„ç»“æœ">æ”¶é›†åç¨‹çš„ç»“æœ</h3><p>å¦‚æœè¦æ‰§è¡Œçš„å¤šä¸ªåç¨‹å·²ç»è¢«å®šä¹‰å¥½ï¼Œå¹¶ä¸”åªå…³å¿ƒå®ƒä»¬çš„ç»“æœï¼Œé‚£ä¹ˆ <code>gather()</code> æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„æ”¶é›†ç»“æœçš„æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">phase1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in phase1'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'done with phase1'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'phase1 result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">phase2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in phase2'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'done with phase2'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'phase2 result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'starting main'</span>)</span><br><span class="line">    print(<span class="string">'waiting for phases to complete'</span>)</span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">        phase1(),</span><br><span class="line">        phase2(),</span><br><span class="line">    )</span><br><span class="line">    print(<span class="string">f'results: <span class="subst">&#123;results!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main())</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p><code>gather()</code> åˆ›å»ºçš„ä»»åŠ¡ä¸ä¼šå…¬å¼€ï¼Œå› æ­¤æ— æ³•å–æ¶ˆã€‚è¿”å›å€¼æ˜¯ä¸€ä¸ªç»“æœåˆ—è¡¨ï¼Œé¡ºåºä¸ä¼ é€’ç»™ <code>gather()</code> çš„å‚æ•°çš„é¡ºåºç›¸åŒï¼Œä¸å®é™…å®Œæˆçš„é¡ºåºæ— å…³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">starting main</span><br><span class="line">waiting for phases to complete</span><br><span class="line">in phase2</span><br><span class="line">in phase1</span><br><span class="line">done with phase2</span><br><span class="line">done with phase1</span><br><span class="line">results: [&apos;phase1 result&apos;, &apos;phase2 result&apos;]</span><br></pre></td></tr></table></figure><h3 id="åœ¨ä»»åŠ¡å®Œæˆååšä¸€äº›äº‹">åœ¨ä»»åŠ¡å®Œæˆååšä¸€äº›äº‹</h3><p><code>as_completed()</code> æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå®ƒç®¡ç†å½“ä½œå‚æ•°ä¼ é€’ç»™å®ƒçš„åç¨‹åˆ—è¡¨çš„æ‰§è¡Œï¼Œæ¯æ¬¡è¿­ä»£éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ‰§è¡Œå®Œçš„åç¨‹ã€‚ä¸ <code>wait()</code> ä¸€æ ·ï¼Œ<code>as_completed()</code> ä¹Ÿä¸ä¿è¯é¡ºåºï¼›ä¸ <code>wait()</code> ä¸åŒçš„æ˜¯å®ƒä¸ä¼šç­‰åˆ°æ‰€æœ‰åå°æ“ä½œå®Œæˆåæ‰å¯ä»¥æ‰§è¡Œå…¶å®ƒæ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">phase</span><span class="params">(i)</span>:</span></span><br><span class="line">    print(<span class="string">f'in phase <span class="subst">&#123;i&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span> - (<span class="number">0.1</span> * i))</span><br><span class="line">    print(<span class="string">f'done with phase <span class="subst">&#123;i&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f'phase <span class="subst">&#123;i&#125;</span> result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(num_phases)</span>:</span></span><br><span class="line">    print(<span class="string">'starting main'</span>)</span><br><span class="line">    phases = [phase(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(num_phases)]</span><br><span class="line">    print(<span class="string">'waiting for phases to complete'</span>)</span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">for</span> next_to_complete <span class="keyword">in</span> asyncio.as_completed(phases):</span><br><span class="line">        print(<span class="string">f'start <span class="subst">&#123;next_to_complete&#125;</span>'</span>)</span><br><span class="line">        answer = <span class="keyword">await</span> next_to_complete</span><br><span class="line">        print(<span class="string">f'received answer <span class="subst">&#123;answer!r&#125;</span>'</span>)</span><br><span class="line">        results.append(answer)</span><br><span class="line">    print(<span class="string">f'results: <span class="subst">&#123;results!r&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­å¯åŠ¨äº†å‡ ä¸ªåç¨‹ï¼Œè¿™äº›åç¨‹ä»¥å®ƒä»¬å¼€å§‹é¡ºåºçš„ç›¸åé¡ºåºç»“æŸã€‚å½“ç”Ÿæˆå™¨è¢«æ¶ˆè€—æ—¶ï¼Œå¾ªç¯ä½¿ç”¨ <code>await</code>ç­‰å¾…åç¨‹çš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">starting main</span><br><span class="line">waiting for phases to complete</span><br><span class="line">in phase 0</span><br><span class="line">in phase 1</span><br><span class="line">in phase 2</span><br><span class="line">done with phase 2</span><br><span class="line">received answer 'phase 2 result'</span><br><span class="line">done with phase 1</span><br><span class="line">received answer 'phase 1 result'</span><br><span class="line">done with phase 0</span><br><span class="line">received answer 'phase 0 result'</span><br><span class="line">results: ['phase 2 result', 'phase 1 result', 'phase 0 result']</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://pymotw.com/3/asyncio/tasks.html" target="_blank" rel="noopener">Executing Tasks Concurrently</a></li><li><a href="https://pymotw.com/3/asyncio/control.html" target="_blank" rel="noopener">Composing Coroutines with Control Structures</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¹¦æ¥ä¸Šæ–‡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å¹¶è¡Œæ‰§è¡Œä»»åŠ¡&quot;&gt;å¹¶è¡Œæ‰§è¡Œä»»åŠ¡&lt;/h2&gt;
&lt;p&gt;ä»»åŠ¡æ˜¯ä¸äº‹ä»¶å¾ªç¯äº¤äº’çš„ä¸»è¦æ–¹å¼ä¹‹ä¸€ã€‚ä»»åŠ¡åŒ…è£…åç¨‹å¹¶è·Ÿè¸ªå®ƒä»¬å®Œæˆçš„æ—¶é—´ã€‚ä»»åŠ¡æ˜¯ &lt;code&gt;future&lt;/code&gt;
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆäºŒï¼‰</title>
    <link href="http://weafteam.github.io/posts/84801e4e/"/>
    <id>http://weafteam.github.io/posts/84801e4e/</id>
    <published>2018-04-24T15:43:20.000Z</published>
    <updated>2018-08-07T08:56:41.617Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šæ–‡ã€‚</p><h2 id="è°ƒåº¦å¸¸è§„å‡½æ•°">è°ƒåº¦å¸¸è§„å‡½æ•°</h2><p>é™¤äº†ç®¡ç†åç¨‹å’Œ I / O å›è°ƒä¹‹å¤–ï¼Œ<code>asyncio</code> äº‹ä»¶å¾ªç¯è¿˜å¯ä»¥æ ¹æ®å¾ªç¯ä¸­çš„è®¡æ—¶å™¨è°ƒåº¦å¸¸è§„å‡½æ•°ã€‚</p><h3 id="ç«‹å³è°ƒåº¦">ç«‹å³è°ƒåº¦</h3><p>å¦‚æœå‡½æ•°æ‰§è¡Œçš„æ—¶æœºæ— å…³ç´§è¦ï¼Œ<code>call_soon()</code> å¯ä»¥ç”¨äºåœ¨äº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€æ¬¡è¿­ä»£ä¸­è°ƒåº¦å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(arg, *, kwarg=<span class="string">'default'</span>)</span>:</span></span><br><span class="line">    print(<span class="string">f'callback invoked with <span class="subst">&#123;arg&#125;</span> and <span class="subst">&#123;kwarg&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    print(<span class="string">'registering callbacks'</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="number">1</span>)</span><br><span class="line">    wrapped = functools.partial(callback, kwarg=<span class="string">'not default'</span>)</span><br><span class="line">    loop.call_soon(wrapped, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">'entering event loop'</span>)</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    print(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p><code>call_soon()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°ï¼Œå‰©ä¸‹çš„ä½ç½®å‚æ•°éƒ½ä¼šè¢«ä¼ é€’ç»™å›è°ƒå‡½æ•°ã€‚å¦‚æœæƒ³ä¼ å…¥å…³é”®å­—å‚æ•°ï¼Œå°±éœ€è¦ç”¨åˆ° <code>functools.partical()</code>ã€‚</p><p>å›è°ƒå‡½æ•°æŒ‰ç…§è°ƒåº¦é¡ºåºè¢«ä¾æ¬¡è°ƒç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">entering event loop</span><br><span class="line">registering callbacks</span><br><span class="line">callback invoked with 1 and default</span><br><span class="line">callback invoked with 2 and not default</span><br><span class="line">closing event loop</span><br></pre></td></tr></table></figure><h3 id="æœ‰å»¶è¿Ÿçš„è°ƒåº¦">æœ‰å»¶è¿Ÿçš„è°ƒåº¦</h3><p>è¦å°†å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ¨è¿Ÿåˆ°å°†æ¥çš„æŸä¸ªæ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨ <code>call_later()</code>ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»¥ç§’ä¸ºå•ä½çš„å»¶è¿Ÿï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(n)</span>:</span></span><br><span class="line">    print(<span class="string">f'callback <span class="subst">&#123;n&#125;</span> invoked'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    print(<span class="string">'registering callbacks'</span>)</span><br><span class="line">    loop.call_later(<span class="number">0.2</span>, callback, <span class="number">1</span>)</span><br><span class="line">    loop.call_later(<span class="number">0.1</span>, callback, <span class="number">2</span>)</span><br><span class="line">    loop.call_soon(callback, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">'entering event loop'</span>)</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    print(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç›¸åŒçš„å›è°ƒå‡½æ•°å‚ä¸äº†ä¸‰æ¬¡è°ƒåº¦ï¼Œåˆ†åˆ«ä½¿ç”¨äº†å‡ ä¸ªä¸åŒçš„å»¶è¿Ÿå’Œä¸åŒçš„å‚æ•°ã€‚æœ€åä½¿ç”¨äº† <code>call_soon()</code>ï¼Œå®ƒä½¿å›è°ƒå‡½æ•°åœ¨æ‰€æœ‰å»¶è¿Ÿè°ƒåº¦ä¹‹å‰è°ƒç”¨ï¼Œè¿™è¡¨æ˜ <code>call_soon()</code> é€šå¸¸æ„å‘³ç€æœ€å°å»¶è¿Ÿï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">entering event loop</span><br><span class="line">registering callbacks</span><br><span class="line">callback 3 invoked</span><br><span class="line">callback 2 invoked</span><br><span class="line">callback 1 invoked</span><br><span class="line">closing event loop</span><br></pre></td></tr></table></figure><h3 id="åœ¨ç‰¹å®šæ—¶é—´è°ƒåº¦">åœ¨ç‰¹å®šæ—¶é—´è°ƒåº¦</h3><p>è¿˜å¯ä»¥åœ¨ç‰¹å®šæ—¶é—´è°ƒåº¦å‡½æ•°ã€‚äº‹ä»¶å¾ªç¯ä½¿ç”¨å•è°ƒæ—¶é’Ÿï¼Œè€Œä¸æ˜¯ Unix æ—¶é’Ÿï¼Œä»¥ç¡®ä¿å½“å‰çš„å€¼æ°¸ä¸å›å½’ã€‚è¦åœ¨ç‰¹å®šçš„æ—¶é—´è°ƒåº¦ï¼Œå¿…é¡»ä½¿ç”¨äº‹ä»¶å¾ªç¯çš„<code>time()</code>æ–¹æ³•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(n, loop)</span>:</span></span><br><span class="line">    print(<span class="string">f'callback <span class="subst">&#123;n&#125;</span> invoked at <span class="subst">&#123;loop.time()&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    now = loop.time()</span><br><span class="line">    print(<span class="string">f'clock time: <span class="subst">&#123;time.time()&#125;</span>'</span>)</span><br><span class="line">    print(<span class="string">f'loop  time: <span class="subst">&#123;now&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'registering callbacks'</span>)</span><br><span class="line">    loop.call_at(now + <span class="number">0.2</span>, callback, <span class="number">1</span>, loop)</span><br><span class="line">    loop.call_at(now + <span class="number">0.1</span>, callback, <span class="number">2</span>, loop)</span><br><span class="line">    loop.call_soon(callback, <span class="number">3</span>, loop)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">'entering event loop'</span>)</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    print(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°äº‹ä»¶å¾ªç¯å†…çš„æ—¶é—´ä¸ <code>time.time()</code> ä¸ä¸€è‡´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">entering event loop</span><br><span class="line">clock time: 1524502404.7036376</span><br><span class="line">loop  time: 4562.515</span><br><span class="line">registering callbacks</span><br><span class="line">callback 3 invoked at 4562.515</span><br><span class="line">callback 2 invoked at 4562.625</span><br><span class="line">callback 1 invoked at 4562.718</span><br><span class="line">closing event loop</span><br></pre></td></tr></table></figure><h2 id="å¼‚æ­¥äº§ç”Ÿç»“æœ">å¼‚æ­¥äº§ç”Ÿç»“æœ</h2><p><code>future</code>æ˜¯å°šæœªå®Œæˆçš„å·¥ä½œçš„ç»“æœã€‚äº‹ä»¶å¾ªç¯å¯ä»¥ç›‘è§†<code>future</code>å¯¹è±¡çš„çŠ¶æ€ç›´åˆ°å®ƒå®Œæˆï¼Œä»è€Œå…è®¸åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ç­‰å¾…å¦ä¸€éƒ¨åˆ†å®ŒæˆæŸäº›å·¥ä½œã€‚</p><h3 id="ç­‰å¾…-future">ç­‰å¾… <code>future</code></h3><p><code>future</code>å°±åƒåç¨‹ï¼Œæ‰€ä»¥ä»»ä½•ç”¨äºå¤„ç†åç¨‹çš„æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç†<code>future</code>ã€‚è¿™ä¸ªä¾‹å­å°†<code>future</code>ä¼ é€’ç»™äº‹ä»¶å¾ªç¯çš„<code>run_until_complete()</code>æ–¹æ³•ã€‚è®°ä½æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡ä¸­æåˆ°çš„ï¼Œé€šå¸¸æˆ‘ä»¬ä¸åº”è¯¥è‡ªè¡Œåˆ›å»º <code>future</code> å¯¹è±¡ï¼Œè¿™é‡Œåªä¸ºæ¼”ç¤ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mark_done</span><span class="params">(future, result)</span>:</span></span><br><span class="line">    print(<span class="string">f'setting future result to <span class="subst">&#123;result!r&#125;</span>'</span>)</span><br><span class="line">    future.set_result(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    all_done = asyncio.Future()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'scheduling mark_done'</span>)</span><br><span class="line">    event_loop.call_soon(mark_done, all_done, <span class="string">'the result'</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'entering event loop'</span>)</span><br><span class="line">    result = event_loop.run_until_complete(all_done)</span><br><span class="line">    print(<span class="string">f'returned result: <span class="subst">&#123;result!r&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    print(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'future result: <span class="subst">&#123;all_done.result()!r&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>set_result()</code> æ—¶ï¼Œ<code>future</code> çš„çŠ¶æ€ä¼šè¢«æ›´æ”¹ä¸ºå·²å®Œæˆï¼Œ<code>future</code>çš„å®ä¾‹å°†ä¿å­˜ç»“æœï¼Œå¹¶è¿”å›ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scheduling mark_done</span><br><span class="line">entering event loop</span><br><span class="line">setting future result to 'the result'</span><br><span class="line">returned result: 'the result'</span><br><span class="line">closing event loop</span><br><span class="line">future result: 'the result'</span><br></pre></td></tr></table></figure><p><code>future</code> ä¹Ÿå¯ä»¥ä¸ <code>await</code> ä¸€èµ·ä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mark_done</span><span class="params">(future, result)</span>:</span></span><br><span class="line">    print(<span class="string">f'setting future result to <span class="subst">&#123;result!r&#125;</span>'</span>)</span><br><span class="line">    future.set_result(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(loop)</span>:</span></span><br><span class="line">    all_done = asyncio.Future()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'scheduling mark_done'</span>)</span><br><span class="line">    loop.call_soon(mark_done, all_done, <span class="string">'the result'</span>)</span><br><span class="line"></span><br><span class="line">    result = <span class="keyword">await</span> all_done</span><br><span class="line">    print(<span class="string">f'returned result: <span class="subst">&#123;result!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p><code>future</code> çš„ç»“æœç”± <code>await</code> è¿”å›ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scheduling mark_done</span><br><span class="line">setting future result to <span class="string">'the result'</span></span><br><span class="line">returned result: <span class="string">'the result'</span></span><br></pre></td></tr></table></figure><h3 id="future-çš„å›è°ƒ"><code>future</code> çš„å›è°ƒ</h3><p>é™¤äº†åƒåç¨‹ä¸€æ ·å·¥ä½œä¹‹å¤–ï¼Œ<code>future</code>è¿˜å¯ä»¥åœ¨å®Œæˆæ—¶è°ƒç”¨å›è°ƒå‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(future, n)</span>:</span></span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;n&#125;</span>: future done: <span class="subst">&#123;future.result()&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">register_callbacks</span><span class="params">(all_done)</span>:</span></span><br><span class="line">    print(<span class="string">'registering callbacks on future'</span>)</span><br><span class="line">    all_done.add_done_callback(functools.partial(callback, n=<span class="number">1</span>))</span><br><span class="line">    all_done.add_done_callback(functools.partial(callback, n=<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(all_done)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> register_callbacks(all_done)</span><br><span class="line">    print(<span class="string">'setting result of future'</span>)</span><br><span class="line">    all_done.set_result(<span class="string">'the result'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    all_done = asyncio.Future()</span><br><span class="line">    event_loop.run_until_complete(main(all_done))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><p>æ·»åŠ å›è°ƒçš„å‡½æ•°åªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œå³å›è°ƒå‡½æ•°ï¼›å›è°ƒå‡½æ•°ä¹Ÿåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³ <code>future</code> å®ä¾‹ã€‚è‹¥è¦ä¼ é€’å…¶ä»–å‚æ•°ç»™å›è°ƒå‡½æ•°ï¼Œè¦ä½¿ç”¨ <code>functools.partical()</code> ã€‚å›è°ƒå‡½æ•°æŒ‰æ³¨å†Œé¡ºåºè¢«è°ƒç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">registering callbacks on future</span><br><span class="line">setting result of future</span><br><span class="line">1: future done: the result</span><br><span class="line">2: future done: the result</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://pymotw.com/3/asyncio/scheduling.html" target="_blank" rel="noopener">Scheduling Calls to Regular Functions</a></li><li><a href="https://pymotw.com/3/asyncio/futures.html" target="_blank" rel="noopener">Producing Results Asynchronously</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¹¦æ¥ä¸Šæ–‡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è°ƒåº¦å¸¸è§„å‡½æ•°&quot;&gt;è°ƒåº¦å¸¸è§„å‡½æ•°&lt;/h2&gt;
&lt;p&gt;é™¤äº†ç®¡ç†åç¨‹å’Œ I / O å›è°ƒä¹‹å¤–ï¼Œ&lt;code&gt;asyncio&lt;/code&gt; äº‹ä»¶å¾ªç¯è¿˜å¯ä»¥æ ¹æ®å¾ªç¯ä¸­çš„è®¡æ—¶å™¨è°ƒåº¦å¸¸è§„å‡½æ•°ã€‚&lt;/p&gt;
&lt;h3
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Kafkaåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ</title>
    <link href="http://weafteam.github.io/posts/23949c22/"/>
    <id>http://weafteam.github.io/posts/23949c22/</id>
    <published>2018-04-23T10:13:02.000Z</published>
    <updated>2018-08-12T09:51:01.068Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€windowså¹³å°kafkaçš„ç¯å¢ƒæ­å»º">ä¸€ã€Windowså¹³å°Kafkaçš„ç¯å¢ƒæ­å»º</h2><p>æ³¨æ„ï¼šç¡®ä¿JAVAç¯å¢ƒå˜é‡çš„æ­£ç¡®</p><h3 id="zookeeperçš„å®‰è£…">1.ZooKeeperçš„å®‰è£…</h3><p>Kafkaçš„è¿è¡Œä¾èµ–äºZookeeperï¼Œæ‰€ä»¥éœ€è¦å…ˆå®‰è£…Zookeeper. Zookeeperä¸‹è½½åœ°å€ï¼š<a href="http://mirror.bit.edu.cn/apache/zookeeper/" target="_blank" rel="noopener">Zookeeper</a> <img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-1.png" alt="kafka-1"> è§£å‹å‡ºæ¥ï¼Œæ”¾åœ¨æŒ‡å®šä½ç½®ã€‚ åœ¨confæ–‡ä»¶å¤¹ä¸‹ä¿®æ”¹zoo_sample.cfgåä¸ºzoo.cfg ç„¶åæ‰“å¼€zoo.cfg æ·»åŠ ä¸€ä¸‹å˜é‡ï¼ˆå¦‚æœæ²¡æœ‰è¯·æ·»åŠ ï¼Œå­˜åœ¨è¯·ä¿®æ”¹ï¼‰ <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dataDir=D:\data\logs\zookeeper </span><br><span class="line">dataLogDir=D:\data\logs\zookeeper</span><br></pre></td></tr></table></figure></p><p>ç„¶åè¿›å…¥binç›®å½•åŒå‡»zkServer.cmdè¿è¡Œã€‚å¦‚ä¸‹å›¾ï¼š <img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-2.png" alt="kafka-2"></p><h3 id="kafkaçš„å®‰è£…">2.Kafkaçš„å®‰è£…</h3><p>Kafkaä¸‹è½½åœ°å€ï¼š<a href="http://kafka.apache.org/downloads.html" target="_blank" rel="noopener">Kafka</a> <img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-3.png" alt="kafka-3"> è§£å‹æ–‡ä»¶åˆ°æŒ‡å®šåœ°æ–¹ æ‰“å¼€configä¸‹çš„server.properties ä¿®æ”¹ä»¥ä¸‹å˜é‡ <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.dirs=D:\data\logs\kafka</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°binç›®å½•ä¸‹çš„æ˜¯linuxçš„å¯åŠ¨è„šæœ¬ï¼Œç„¶åæœ‰ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹è£…ç€windowsçš„è„šæœ¬ã€‚ æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹æ‰“å¼€å‘½ä»¤è¡Œï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨Kafkaã€‚ æˆ‘ä»¬åœ¨è¿è¡Œå‰éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹</p><ol type="1"><li>ç¡®è®¤JAVAç¯å¢ƒå˜é‡æ²¡æœ‰é—®é¢˜</li><li>è·¯å¾„ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œä¸ç„¶å¯èƒ½ä¼šå‡ºç°æ— æ³•åŠ è½½ä¸»ç±»çš„é”™è¯¯ã€‚</li><li>å‡ºç°æ— æ³•åŠ è½½ä¸»ç±»é”™è¯¯ï¼Œå¯ä¿®æ”¹bin-run-class.batä¸­ set COMMAND=%JAVA% %KAFKA_HEAP_OPTS% %KAFKA_JVM_PERFORMANCE_OPTS% %KAFKA_JMX_OPTS% %KAFKA_LOG4J_OPTS% -cp %CLASSPATH% %KAFKA_OPTS% %* ä¸­â€œ%CLASSPATH%â€åŠ ä¸ŠåŒå¼•å·</li></ol><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-4.png" alt="kafka-3"> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\windows\kafka-server-start.bat .\config\server.properties</span><br></pre></td></tr></table></figure></p><h2 id="äºŒspringboot2.0ç›¸å…³é…ç½®">äºŒã€SpringBoot2.0ç›¸å…³é…ç½®</h2><p>pomæ–‡ä»¶åŠ å…¥ä»¥ä¸‹ä¾èµ–</p><h5 id="pom.xml">pom.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- kafka --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡ŒSpringBootçš„é…ç½®æ–‡ä»¶ä½¿ç”¨çš„æ˜¯YAMLã€‚ åœ¨ç›¸åº”ç¯å¢ƒä¸­é…ç½®Kafka ##### application-local.yml <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 7777</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">    datasource:</span><br><span class="line">        name: test</span><br><span class="line">        driverClassName: com.mysql.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql://.....</span><br><span class="line">        username: ...</span><br><span class="line">        password: ....</span><br><span class="line">    redis:</span><br><span class="line">      database: 0</span><br><span class="line">      host: localhost</span><br><span class="line">      port: 6379</span><br><span class="line">      jedis:</span><br><span class="line">        pool:</span><br><span class="line">          min-idle: 0</span><br><span class="line">          max-idle: 8</span><br><span class="line">          max-active: 8</span><br><span class="line">          max-wait: -1ms</span><br><span class="line">      password: 123456</span><br><span class="line">    kafka:</span><br><span class="line">        consumer:</span><br><span class="line">          group-id: foo</span><br><span class="line">          auto-offset-reset: earliest</span><br><span class="line">          key-deserializer: org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">          value-deserializer: org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">        producer:</span><br><span class="line">          key-serializer: org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">          value-serializer: org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">        bootstrap-servers: localhost:9092</span><br><span class="line">app:</span><br><span class="line">      topic:</span><br><span class="line">        foo: foo.t</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥ä»…å…³æ³¨spring.kafkaå’Œapp.topicèŠ‚ç‚¹ æ›´å¤šspring.kafkaé…ç½®ä¿¡æ¯è¯·æŸ¥çœ‹<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html" target="_blank" rel="noopener">å®˜ç½‘æ–‡æ¡£</a></p><h2 id="ä¸‰ä»£ç ">ä¸‰ã€ä»£ç </h2><p>ä¸»è¦ä»£ç ç»“æ„ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-5.png" alt="kafka-5"> æ¶ˆè´¹è€…ä»£ç  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.kafka.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Payload;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 17:56 2018/4/23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener</span>(topics = <span class="string">"$&#123;app.topic.foo&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(@Payload String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"received message='&#123;&#125;'"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç”Ÿäº§è€…ä»£ç  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.kafka.producer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.core.KafkaTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 17:57 2018/4/23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;app.topic.foo&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"sending message='&#123;&#125;' to topic='&#123;&#125;'"</span>, message, topic);</span><br><span class="line">        kafkaTemplate.send(topic, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æµ‹è¯•ä»£ç  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxx.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxx.controller.entry.ResMsg;</span><br><span class="line"><span class="keyword">import</span> com.xxx.Sender;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 11:21 2018/4/21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"test"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Sender sender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"send"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResMsg <span class="title">send</span><span class="params">(String content)</span></span>&#123;</span><br><span class="line">        sender.send(<span class="string">"Spring Kafka and Spring Boot Send Message:"</span>+content);</span><br><span class="line">        <span class="keyword">return</span> ResMsg.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="å››ç®€å•çš„æµ‹è¯•">å››ã€ç®€å•çš„æµ‹è¯•</h2><p>è¿è¡Œé¡¹ç›® <img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-6.png" alt="kafka-6"> æµ‹è¯•å‘é€ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-7.png" alt="kafka-6"> æŸ¥çœ‹æ¥æ”¶ç»“æœï¼š <img src="https://weaf.oss-cn-beijing.aliyuncs.com/kafka-8.png" alt="kafka-6"></p><h2 id="äº”springboot-demo">äº”ã€SpringBoot-Demo</h2><p>æœ¬äººæœ€è¿‘ä½¿ç”¨é˜¿é‡Œäº‘çš„Kafkaå‘ç°æ²¡æœ‰SpringBootçš„Demoä¾¿å†™äº†ä¸€ä¸ªã€‚</p><p>ä»£ç åœ°å€ï¼š<a href="https://github.com/songyaxu/kafka-springboot-demo" class="uri" target="_blank" rel="noopener">https://github.com/songyaxu/kafka-springboot-demo</a></p><p>æœ¬æ–‡å‚è€ƒåœ°å€<a href="https://docs.spring.io/spring-kafka/docs/2.1.5.RELEASE/reference/html/" class="uri" target="_blank" rel="noopener">https://docs.spring.io/spring-kafka/docs/2.1.5.RELEASE/reference/html/</a></p>]]></content>
    
    <summary type="html">
    
      Kafkaåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>chapter-06-AIR</title>
    <link href="http://weafteam.github.io/posts/3cae9921/"/>
    <id>http://weafteam.github.io/posts/3cae9921/</id>
    <published>2018-04-22T06:31:24.000Z</published>
    <updated>2018-05-29T01:27:49.852Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-åŸºç¡€3">TensorFlow åŸºç¡€ï¼ˆ3ï¼‰</h1><p>hello,å¤§å®¶å¥½ï¼Œå‡ å¤©æˆ‘ä»¬ç»§ç»­å­¦ä¹ åŸºç¡€çŸ¥è¯†ï¼Œä¸ºæˆ‘ä»¬ä»¥åå»ºç«‹æ¨¡å‹æ‰“ä¸‹åŸºç¡€ã€‚ä¸»è¦æ˜¯æœ€è¿‘æœ‰ç‚¹å¿™ï¼Œæ‰€ä»¥æ¯ä¸€å‘¨çš„å†…å®¹ä¼šå°‘ä¸€äº›ï¼Œè¯·å¤§å®¶è°…è§£ï¼Œéšåæ…¢æ…¢åŠ å¿«è¿›åº¦ã€‚</p><blockquote><p>è¿™ä¸€æ¬¡æˆ‘ä»¬è®²ä¸€ä¸‹batchçš„æ¦‚å¿µï¼Œä»¥åŠä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®²è¿‡batchè¿™ä¸ªæ¦‚å¿µçš„ã€‚å¤§å®¶åº”è¯¥ä¸ä¼šé™Œç”Ÿ</p></blockquote><ol type="1"><li>Working with Batch and Stochastic Training</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># éšæœºæ¢¯åº¦è®­ç»ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ•°æ®</span></span><br><span class="line"></span><br><span class="line">x_vals = np.random.normal(<span class="number">1.</span>, <span class="number">0.1</span>, <span class="number">100</span>)</span><br><span class="line">y_vals = np.repeat(<span class="number">10.</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">x_data = tf.placeholder(shape = [<span class="number">1</span>], dtype = tf.float32)</span><br><span class="line">y_target = tf.placeholder(shape = [<span class="number">1</span>], dtype = tf.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Aå°±ç›¸å½“äºæƒé‡å’¯</span></span><br><span class="line">A = tf.Variable(tf.random_normal(shape = [<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">my_output = tf.multiply(x_data, A)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„æˆ‘ä»¬ä¸Šä¸€æ¬¡çš„losså‡½æ•°å“¦</span></span><br><span class="line"></span><br><span class="line">loss = tf.square(my_output - y_target)</span><br><span class="line"></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.02</span>) <span class="comment"># 0.02å°±æ˜¯å­¦ä¹ ç‡</span></span><br><span class="line"></span><br><span class="line">train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹è®­ç»ƒæ¨¡å‹</span></span><br><span class="line">loss_stochastic = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    rand_index = np.random.choice(<span class="number">100</span>) <span class="comment"># éšæœºé€‰å–ä¸€ä¸ªæ ·æœ¬è¿›è¡Œè®­ç»ƒ</span></span><br><span class="line">    rand_x = [x_vals[rand_index]]</span><br><span class="line">    rand_y = [y_vals[rand_index]]</span><br><span class="line">    sess.run(train_step, feed_dict = &#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">5</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i + <span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)))</span><br><span class="line">        temp_loss = sess.run(loss, feed_dict = &#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(temp_loss))</span><br><span class="line">        loss_stochastic.append(temp_loss)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="comment"># batch train      </span></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">25</span></span><br><span class="line">x_vals = np.random.normal(<span class="number">1</span>, <span class="number">0.1</span>, <span class="number">100</span>)</span><br><span class="line">y_vals = np.repeat(<span class="number">10.</span>, <span class="number">100</span>)</span><br><span class="line">x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32) <span class="comment"># çœ‹å‡ºæ¥å˜åŒ–äº†å§ï¼Ÿ</span></span><br><span class="line">y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32) <span class="comment"># è¿™é‡Œä¹Ÿæ˜¯</span></span><br><span class="line"></span><br><span class="line">A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>,<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">my_output = tf.matmul(x_data, A)</span><br><span class="line"><span class="comment"># æ˜¯ä¸æ˜¯l2loss</span></span><br><span class="line">loss = tf.reduce_mean(tf.square(my_output - y_target))</span><br><span class="line"><span class="comment"># è¿™é‡Œå·²ç»å¼ºè°ƒè¿‡å¾ˆå¤šéäº†</span></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯ä¼˜åŒ–å™¨</span></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.02</span>)</span><br><span class="line">train_step = my_opt.minimize(loss)</span><br><span class="line"></span><br><span class="line">loss_batch = []</span><br><span class="line"><span class="comment"># Run Loop</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    rand_index = np.random.choice(<span class="number">100</span>, size=batch_size) <span class="comment"># çœ‹å‡ºæ¥åŒºåˆ«äº†ä¹ˆï¼Ÿ</span></span><br><span class="line">    rand_x = np.transpose([x_vals[rand_index]])</span><br><span class="line">    rand_y = np.transpose([y_vals[rand_index]])</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">5</span>==<span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i+<span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)))</span><br><span class="line">        temp_loss = sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(temp_loss))</span><br><span class="line">        loss_batch.append(temp_loss)</span><br><span class="line"></span><br><span class="line">plt.plot(range(<span class="number">0</span>, <span class="number">100</span>, <span class="number">5</span>), loss_stochastic, <span class="string">'b-'</span>, label=<span class="string">'Stochastic Loss'</span>)</span><br><span class="line">plt.plot(range(<span class="number">0</span>, <span class="number">100</span>, <span class="number">5</span>), loss_batch, <span class="string">'r--'</span>, label=<span class="string">'Batch Loss, size=20'</span>)</span><br><span class="line">plt.legend(loc=<span class="string">'upper right'</span>, prop=&#123;<span class="string">'size'</span>: <span class="number">11</span>&#125;)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p>è®©ä½ æ„Ÿå—ä¸€äº›ï¼Œbatchè®­ç»ƒçš„lossæ”¶æ•›ï¼š</p><p><img src="https://s1.ax1x.com/2018/04/22/CMTbv9.png" alt="-"></p><p>ä½ å°±è¯´ä¸Šé¢çš„ä½ ç†è§£æ²¡ç†è§£ï¼Œæ²¡ç†è§£è¦å¥½å¥½ç†è§£ç†è§£äº†~ï¼ï¼ï¼</p><ol start="2" type="1"><li>è¿™ä¸ªå°±æ˜¯ç»“åˆäº†ï¼ŒæŠŠæ‰€æœ‰ä¸Šé¢ä»‹ç»çš„åŸºç¡€ç»“åˆåœ¨ä¸€èµ·ï¼Œä½ è¯´è¯´æ˜¯ä¸æ˜¯å¾ˆæ£’</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è”åˆæ‰€æœ‰çš„åŸºç¡€æ“ä½œï¼Œå¼„ä¸€ä¸ªåˆ†ç±»çš„ä¾‹å­ï¼ŒæœŸä¸æœŸå¾…</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">iris = datasets.load_iris() <span class="comment"># å°†é¸¢å°¾èŠ±æ•°æ®é›†ä¸‹ä¸‹æ¥ æ€»å…±æ˜¯å››ä¸ªå±æ€§çš„æ•°æ®é›†ï¼Œæ ¹æ®å››ä¸ªç§ç±»ï¼Œé¢„æµ‹ç§ç±»ï¼Œæ€»å…±ä¸‰ç±»</span></span><br><span class="line">binary_target = np.array([<span class="number">1.</span> <span class="keyword">if</span> x==<span class="number">0</span> <span class="keyword">else</span> <span class="number">0.</span> <span class="keyword">for</span> x <span class="keyword">in</span> iris.target]) <span class="comment"># å°†labelä½œä¸ºäºŒåˆ†ç±»é—®é¢˜</span></span><br><span class="line">iris_2d = np.array([[x[<span class="number">2</span>], x[<span class="number">3</span>]] <span class="keyword">for</span> x <span class="keyword">in</span> iris.data]) <span class="comment"># å°†åä¸¤ä¸ªå±æ€§å–å‡ºæ¥ç”¨ä½œç§ç±»é¢„æµ‹</span></span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line">x1_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">x2_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line">b = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">my_mult = tf.matmul(x2_data, A)</span><br><span class="line">my_add = tf.add(my_mult, b)</span><br><span class="line">my_output = tf.subtract(x1_data, my_add) <span class="comment"># ä½ èƒ½ä¸èƒ½è‡ªå·±ä½¿ç”¨å…¬å¼å†™å‡ºæˆ‘ä»¬é¢„æµ‹ç§ç±»çš„å…¬å¼å‘¢ï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">xentropy = tf.nn.sigmoid_cross_entropy_with_logits(logits = my_output, labels = y_target)</span><br><span class="line"></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.05</span>)</span><br><span class="line">train_step = my_opt.minimize(xentropy)</span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    rand_index = np.random.choice(len(iris_2d), size=batch_size)</span><br><span class="line">    <span class="comment">#rand_x = np.transpose([iris_2d[rand_index]])</span></span><br><span class="line">    rand_x = iris_2d[rand_index]</span><br><span class="line">    rand_x1 = np.array([[x[<span class="number">0</span>]] <span class="keyword">for</span> x <span class="keyword">in</span> rand_x])</span><br><span class="line">    rand_x2 = np.array([[x[<span class="number">1</span>]] <span class="keyword">for</span> x <span class="keyword">in</span> rand_x])</span><br><span class="line">    <span class="comment">#rand_y = np.transpose([binary_target[rand_index]])</span></span><br><span class="line">    rand_y = np.array([[y] <span class="keyword">for</span> y <span class="keyword">in</span> binary_target[rand_index]])</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x1_data: rand_x1, x2_data: rand_x2, y_target: rand_y&#125;)</span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">200</span>==<span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i+<span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)) + <span class="string">', b = '</span> + str(sess.run(b)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pull out slope/intercept</span></span><br><span class="line">[[slope]] = sess.run(A)</span><br><span class="line">[[intercept]] = sess.run(b)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create fitted line</span></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">3</span>, num=<span class="number">50</span>)</span><br><span class="line">ablineValues = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> x:</span><br><span class="line">  ablineValues.append(slope*i+intercept)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plot the fitted line over the data</span></span><br><span class="line">setosa_x = [a[<span class="number">1</span>] <span class="keyword">for</span> i,a <span class="keyword">in</span> enumerate(iris_2d) <span class="keyword">if</span> binary_target[i]==<span class="number">1</span>]</span><br><span class="line">setosa_y = [a[<span class="number">0</span>] <span class="keyword">for</span> i,a <span class="keyword">in</span> enumerate(iris_2d) <span class="keyword">if</span> binary_target[i]==<span class="number">1</span>]</span><br><span class="line">non_setosa_x = [a[<span class="number">1</span>] <span class="keyword">for</span> i,a <span class="keyword">in</span> enumerate(iris_2d) <span class="keyword">if</span> binary_target[i]==<span class="number">0</span>]</span><br><span class="line">non_setosa_y = [a[<span class="number">0</span>] <span class="keyword">for</span> i,a <span class="keyword">in</span> enumerate(iris_2d) <span class="keyword">if</span> binary_target[i]==<span class="number">0</span>]</span><br><span class="line">plt.plot(setosa_x, setosa_y, <span class="string">'rx'</span>, ms=<span class="number">10</span>, mew=<span class="number">2</span>, label=<span class="string">'setosa'</span>)</span><br><span class="line">plt.plot(non_setosa_x, non_setosa_y, <span class="string">'ro'</span>, label=<span class="string">'Non-setosa'</span>)</span><br><span class="line">plt.plot(x, ablineValues, <span class="string">'b-'</span>)</span><br><span class="line">plt.xlim([<span class="number">0.0</span>, <span class="number">2.7</span>])</span><br><span class="line">plt.ylim([<span class="number">0.0</span>, <span class="number">7.1</span>])</span><br><span class="line">plt.suptitle(<span class="string">'Linear Separator For I.setosa'</span>, fontsize=<span class="number">20</span>)</span><br><span class="line">plt.xlabel(<span class="string">'Petal Length'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Petal Width'</span>)</span><br><span class="line">plt.legend(loc=<span class="string">'lower right'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2018/04/22/CM7GV0.png"></p><p>ä¸Šé¢æ˜¯åˆ†ç±»çš„ç»“æœå›¾</p><ol start="3" type="1"><li>éªŒè¯æ¨¡å‹ï¼š</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šå®ç°ä¸€ä¸ªç®€å•çš„å›å½’æ¨¡å‹å’Œåˆ†ç±»æ¨¡å‹ï¼Œåˆ†åˆ«åšå‡ºä»–ä»¬çš„æµ‹è¯•æ ·ä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å›å½’æ¨¡å‹</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line">batch_size = <span class="number">25</span></span><br><span class="line"></span><br><span class="line">x_vals = np.random.normal(<span class="number">1</span>, <span class="number">0.1</span>, <span class="number">100</span>)</span><br><span class="line">y_vals = np.repeat(<span class="number">10.</span>, <span class="number">100</span>)</span><br><span class="line">x_data = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">y_target = tf.placeholder(shape=[<span class="keyword">None</span>, <span class="number">1</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ•°æ®åˆ†ä¸ºè®­ç»ƒé›†80%å’Œæµ‹è¯•é›†20%</span></span><br><span class="line">train_indices = np.random.choice(len(x_vals), round(len(x_vals) * <span class="number">0.8</span>), replace = <span class="keyword">False</span>)</span><br><span class="line">test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))</span><br><span class="line">x_vals_train = x_vals[train_indices]</span><br><span class="line">x_vals_test = x_vals[test_indices]</span><br><span class="line">y_vals_train = y_vals[train_indices]</span><br><span class="line">y_vals_test = y_vals[test_indices]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢è¿™äº›æˆ‘ä»¬æ˜¯ä¸æ˜¯å†™äº†å¥½å¤šéäº†ï¼ï¼ï¼</span></span><br><span class="line">A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>,<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">my_output = tf.matmul(x_data, A)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿˜è®°å¾—æˆ‘ä¹ˆï¼Ÿä½ ä¹Ÿè§è¿‡æˆ‘å¥½å¤šæ¬¡äº†ï¼Œä¸ºä»€ä¹ˆåŠ reduce_mean? ä½ ä¹ŸçŸ¥é“batchå¯ä¸æ˜¯ä¸€ä¸ªæ•°æ®æ ·æœ¬å‘€~</span></span><br><span class="line">loss = tf.reduce_mean(tf.square(my_output - y_target))</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¼˜åŒ–å™¨</span></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.02</span>)</span><br><span class="line">train_step = my_opt.minimize(loss)</span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®—äº†ï¼Œæˆ‘éƒ½ä¸æƒ³å†™äº†ï¼Œä½ è¯´è¯´æˆ‘ä»¬å†™äº†å¤šå°‘éäº†ï¼Œè¯¥ä¼šäº†</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    rand_index = np.random.choice(len(x_vals_train), size=batch_size)</span><br><span class="line">    rand_x = np.transpose([x_vals_train[rand_index]])</span><br><span class="line">    rand_y = np.transpose([y_vals_train[rand_index]])</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">25</span>==<span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i+<span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)))</span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯å‘€ï¼Œä¸€èˆ¬è®­ç»ƒå‡ºæ¥çš„æ¨¡å‹ï¼Œæˆ‘ä»¬è¦åœ¨æµ‹è¯•é›†ä¸Šé¢è·‘çš„å¾ˆå¥½ï¼Œåœ¨æµ‹è¯•é›†ä¸Šé¢çš„å‡†ç¡®ç‡å¥½äº†ï¼Œæ²¡ç”¨ï¼Œå› ä¸ºæœ‰è¿‡æ‹Ÿåˆçš„å«Œç–‘ï¼Œå°±æ˜¯å¤ªè®¤çœŸäº†ã€‚æ³›åŒ–èƒ½åŠ›å¤ªå·®ã€‚</span></span><br><span class="line"><span class="comment"># éªŒè¯å›å½’æ¨¡å‹ï¼Œé‚£å°±è¦ä½¿ç”¨losså»è¡¡é‡è¿™ä¸ªæ¨¡å‹çš„å¥½åäº†</span></span><br><span class="line">mse_test = sess.run(loss, feed_dict=&#123;x_data: np.transpose([x_vals_test]), y_target: np.transpose([y_vals_test])&#125;)</span><br><span class="line">mse_train = sess.run(loss, feed_dict=&#123;x_data: np.transpose([x_vals_train]), y_target: np.transpose([y_vals_train])&#125;)</span><br><span class="line">print(<span class="string">'MSE on test:'</span> + str(np.round(mse_test, <span class="number">2</span>)))</span><br><span class="line">print(<span class="string">'MSE on train:'</span> + str(np.round(mse_train, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç±»å·¥ä½œï¼Œå°ä¼™ä¼´æ˜¯ä¸æ˜¯ä¸€ç›´è§‰å¾—åˆ†ç±»å·¥ä½œæ€ä¹ˆèƒ½åšï¼Œé‚£æ˜¯å› ä¸ºä½¿ç”¨æ¦‚ç‡åšçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯”å¦‚æ¦‚ç‡å¤§äºæŸä¸€ä¸ªé˜ˆå€¼0.5 æˆ‘ä»¬å°±åˆ†ä¸ºæŸä¸€ç±»ï¼Œå¦‚æœå°äºæˆ‘ä»¬å°±åˆ†ä¸ºå¦ä¸€ç§ï¼Œè¿™æ˜¯äºŒåˆ†ç±»ï¼Œé‚£ä¹ˆå¤šåˆ†ç±»æ€ä¹ˆåŠï¼Œé‚£ä¹ˆå°±è¦å¼•å…¥one-hotç¼–ç ï¼Œè¿™ä¸ªæˆ‘ä»¬åæ¥æ…¢æ…¢æ·±å…¥ã€‚å…ˆæ¥çœ‹ä¾‹å­</span></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line">batch_size = <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€æ¯›ä¸€æ ·</span></span><br><span class="line">x_vals = np.concatenate((np.random.normal(<span class="number">-1</span>, <span class="number">1</span>, <span class="number">50</span>), np.random.normal(<span class="number">2</span>, <span class="number">1</span>, <span class="number">50</span>)))</span><br><span class="line">y_vals = np.concatenate((np.repeat(<span class="number">0.</span>, <span class="number">50</span>), np.repeat(<span class="number">1.</span>, <span class="number">50</span>)))</span><br><span class="line">x_data = tf.placeholder(shape=[<span class="number">1</span>, <span class="keyword">None</span>], dtype=tf.float32)</span><br><span class="line">y_target = tf.placeholder(shape=[<span class="number">1</span>, <span class="keyword">None</span>], dtype=tf.float32)</span><br><span class="line"></span><br><span class="line">train_indices = np.random.choice(len(x_vals), round(len(x_vals)*<span class="number">0.8</span>), replace=<span class="keyword">False</span>)</span><br><span class="line">test_indices = np.array(list(set(range(len(x_vals))) - set(train_indices)))</span><br><span class="line">x_vals_train = x_vals[train_indices]</span><br><span class="line">x_vals_test = x_vals[test_indices]</span><br><span class="line">y_vals_train = y_vals[train_indices]</span><br><span class="line">y_vals_test = y_vals[test_indices]</span><br><span class="line"></span><br><span class="line">A = tf.Variable(tf.random_normal(mean=<span class="number">10</span>, shape=[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">my_output = tf.add(x_data, A) <span class="comment"># æˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ªåŠ æ³•æ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®è¿˜æ˜¯losså‡½æ•°</span></span><br><span class="line">xentropy = tf.reduce_mean(tf.nn.sigmoid_cross_entropy_with_logits(logits = my_output, labels = y_target))</span><br><span class="line"></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.05</span>)</span><br><span class="line">train_step = my_opt.minimize(xentropy)</span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run loop</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1800</span>):</span><br><span class="line">    rand_index = np.random.choice(len(x_vals_train), size=batch_size)</span><br><span class="line">    rand_x = [x_vals_train[rand_index]]</span><br><span class="line">    rand_y = [y_vals_train[rand_index]]</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">200</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i+<span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)))</span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(sess.run(xentropy, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)))</span><br><span class="line"><span class="comment"># åœ¨æµ‹è¯•é›†ä¸Šé¢åšæµ‹è¯•</span></span><br><span class="line">y_prediction = tf.squeeze(tf.round(tf.nn.sigmoid(tf.add(x_data, A))))</span><br><span class="line">correct_prediction = tf.equal(y_prediction, y_target)</span><br><span class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line">acc_value_test = sess.run(accuracy, feed_dict=&#123;x_data: [x_vals_test], y_target: [y_vals_test]&#125;)</span><br><span class="line">acc_value_train = sess.run(accuracy, feed_dict=&#123;x_data: [x_vals_train], y_target: [y_vals_train]&#125;)</span><br><span class="line">print(<span class="string">'Accuracy on train set: '</span> + str(acc_value_train))</span><br><span class="line">print(<span class="string">'Accuracy on test set: '</span> + str(acc_value_test))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”»å‡ºåˆ†ç±»ç»“æœ</span></span><br><span class="line">A_result = -sess.run(A)</span><br><span class="line">bins = np.linspace(<span class="number">-5</span>, <span class="number">5</span>, <span class="number">50</span>)</span><br><span class="line">plt.hist(x_vals[<span class="number">0</span>:<span class="number">50</span>], bins, alpha=<span class="number">0.5</span>, label=<span class="string">'N(-1,1)'</span>, color=<span class="string">'white'</span>)</span><br><span class="line">plt.hist(x_vals[<span class="number">50</span>:<span class="number">100</span>], bins[<span class="number">0</span>:<span class="number">50</span>], alpha=<span class="number">0.5</span>, label=<span class="string">'N(2,1)'</span>, color=<span class="string">'red'</span>)</span><br><span class="line">plt.plot((A_result, A_result), (<span class="number">0</span>, <span class="number">8</span>), <span class="string">'k--'</span>, linewidth=<span class="number">3</span>, label=<span class="string">'A = '</span>+ str(np.round(A_result, <span class="number">2</span>)))</span><br><span class="line">plt.legend(loc=<span class="string">'upper right'</span>)</span><br><span class="line">plt.title(<span class="string">'Binary Classifier, Accuracy='</span> + str(np.round(acc_value_test, <span class="number">2</span>)))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼šè¿™æ¬¡ä¸‹æ¥æˆ‘ä»¬å°±æŠŠTensorFlowçš„æ‰€æœ‰åŸºç¡€å†…å®¹è®²å®Œäº†ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥ç»™æˆ‘å‘é‚®ä»¶ï¼šair@weaf.top</p><p>å¸Œæœ›å¤§å®¶æŠŠè¿™äº›åŸºç¡€çŸ¥è¯†å¥½å¥½ç¨³å›ºä¸€ä¸‹ï¼ŒåŠ¡å¿…ç‰¢è®°äºå¿ƒï¼Œéšåæˆ‘ä»¬å°±ä¼šå¾ˆé¡ºåˆ©ã€‚</p><p>ä¸‹ä¸€æ¬¡æˆ‘ä»¬å°±ä¼šå¼€å§‹ä¸€äº›åŸºæœ¬ç®—æ³•~ï¼ŒåŸºç¡€å­¦å®Œä¸å¾—å¥½å¥½ç»ƒä¹ ä¸€ä¸‹ä¹ˆï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-åŸºç¡€3&quot;&gt;TensorFlow
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>å”¯å¯†æ–‡è§£å¯†ï¼ˆé’ˆå¯¹VigenereåŠ å¯†ï¼‰</title>
    <link href="http://weafteam.github.io/posts/899ccb0/"/>
    <id>http://weafteam.github.io/posts/899ccb0/</id>
    <published>2018-04-21T01:38:12.000Z</published>
    <updated>2018-05-29T01:27:49.860Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸Šæ¬¡è¯´åˆ°äº†VigenereåŠ å¯†ä»¥åŠè§£å¯†çš„ç®—æ³•ï¼Œä½†æ˜¯å¦‚ä½•ç ´è¯‘è¿™æ ·çš„å¯†ç ï¼Œä¹Ÿæ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œè¿™ç¯‡åšå®¢å°±æ˜¯å®ç°ä¸€ä¸ªè¿™æ ·çš„ç ´è¯‘ï¼Œä¸»è¦é’ˆå¯¹çš„æ˜¯é€šè¿‡VigenereåŠ å¯†çš„å¯†æ–‡ï¼Œé‚£ä¹ˆå°±å¼€å§‹å§~</p></blockquote><h1 id="ä»»åŠ¡è¦æ±‚">ä»»åŠ¡è¦æ±‚ï¼š</h1><ul><li><pre><code> a.ç¼–ç¨‹å®ç°VigenereåŠ å¯†/è§£å¯†ç³»ç»Ÿï¼Œå¹¶åˆ†æå’Œè¯„ä¼°è¯¥ç®—æ³•çš„å®‰å…¨æ€§ã€‚</code></pre></li><li><pre><code> b.ç¼–ç¨‹å®ç°å”¯å¯†æ–‡ç ´è¯‘ç³»ç»Ÿï¼Œèƒ½å¤Ÿç ´è¯‘å¯†é’¥ä¸º2åˆ°4ä¸ªå­—ç¬¦çš„Vigenereå¯†æ–‡ï¼Œå¹¶åˆ†æå¦‚ä½•åŠ å¿«ç ´è¯‘é€Ÿåº¦ã€‚</code></pre></li><li>æ—¶é—´è¦æ±‚ï¼š å¸ƒç½®ä»»åŠ¡åï¼Œåœ¨3å‘¨ä¹‹å†…å®Œæˆã€‚</li><li>æäº¤ç»“æœï¼šå·²è®¾è®¡å¹¶æµ‹è¯•å¥½çš„ç¨‹åºï¼ŒåŒ…æ‹¬æºç ã€å¯æ‰§è¡Œç¨‹åºã€æµ‹è¯•æ•°æ®é›†ã€å®éªŒæŠ¥å‘Šã€‚</li></ul><h1 id="åŸç†ä»‹ç»">åŸç†ä»‹ç»ï¼š</h1><p>æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„è¯´æ³•ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹CaesaråŠ å¯†çš„ç¼ºç‚¹ã€‚å¯¹äºä¸€ä¸ªç¨å¾®æœ‰ç‚¹ç‚¹å¯†ç å­¦åŠŸåº•çš„äººæ¥è¯´ï¼ŒCaesarå¯†ç çš„å®‰å…¨å¼ºåº¦å‡ ä¹ä¸ºé›¶ï¼Œæ­£å¦‚æˆ‘ä»¬æ˜¯ä¸Šç¯‡åšå®¢æ‰€è®²çš„CaesaråŠ å¯†ï¼ŒåŠ å¯†çš„å¯†é’¥å……å…¶é‡ä¹Ÿå°±24ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡ç§»åŠ¨å¤šå°‘ä¸ªå­—ç¬¦ï¼Œæœ€å¤šè¿›è¡Œ24æ¬¡çŒœè§£å°±å¯ä»¥ç ´è¯‘å‡ºæ¥ã€‚</p><p>å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ç§è§£å¯†æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒç¬¨çš„ä¸€ç§æ–¹æ³•ï¼Œè€Œä¸”è¿™ç§æ–¹æ³•å¹¶ä¸é€‚ç”¨äºæˆ‘ä»¬çš„Vigenereå¯†ç ç ´è§£ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡åŠæ³•åˆ—ä¸¾å‡ºæ‰€æœ‰çš„æƒ…å†µã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»‹ç»ç ´è§£Caesarå¯†ç çš„å¦ä¸€ç±»æ–¹æ³•ï¼Œç§°ä¸ºï¼ˆå­—æ¯ï¼‰é¢‘åº¦åˆ†ææ³•ã€‚</p><p>å‡è®¾å¤§å®¶éƒ½çŸ¥é“ï¼Œè‹±è¯­ä¸­çš„å­—æ¯å‡ºç°æ¦‚ç‡æ˜¯æœ‰å·®åˆ«çš„ï¼Œå…¶å®å¯¹äºä¸€ç§ç‰¹å®šçš„è‡ªç„¶è¯­è¨€ï¼Œå¦‚æœæ–‡æœ¬è¶³å¤Ÿé•¿ï¼Œé‚£ä¹ˆå„ä¸ªå­—æ¯å‡ºç°çš„æ¦‚ç‡å°±æ˜¯ç›¸å¯¹ç¨³å®šçš„ï¼Œå…·ä½“çš„æ¦‚ç‡ç»Ÿè®¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2018/04/21/5adaa41cbbb56.png" alt="percent.png"></p><p>è¿™æ ·æˆ‘ä»¬æ ¹æ®ä»¥ä¸Šçš„é¢‘åº¦è¡¨ï¼Œä»¥åŠæ ¹æ®æˆ‘ä»¬çš„Caesarå¯†æ–‡ä¸­çš„ç»Ÿè®¡å‡ºæ¥çš„å„ä¸ªè¯çš„æ‹¼è¯»ï¼Œå¯¹åº”ä¸€ä¸‹å°±å¯ä»¥æ‰¾åˆ°å¯†æ–‡å¯¹åº”çš„æ˜æ–‡ï¼Œå†ç„¶åå¯¹åº”å¯†æ–‡ä¸æ˜æ–‡å°±å¯ä»¥æ‰¾åˆ°ç›¸åº”çš„åŠ å¯†çš„å¯†é’¥ã€‚å¾ˆç®€å•å§ï¼Œå…¶å®èƒ½æƒ³åˆ°è¿™ä¸ªæƒ³æ³•å¹¶ä¸ç®€å•çš„ã€‚</p><p>ç”±ä¸Šä¸€ç¯‡çš„åšå®¢ä»‹ç»ï¼Œä½ åº”è¯¥çŸ¥é“äº†Vigenereå¯†ç åˆ†è§£ä¹‹åå…¶å®å°±æ˜¯å¤šä¸ªCaesarå¯†ç ã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚æœçŸ¥é“å¯†é’¥çš„é•¿åº¦ï¼Œæ¯éš”è¿™ä¸ªé•¿åº¦å°†åŸæ¥çš„Vigenereå¯†æ–‡åˆ†è§£ä¸ºå¤šä¸ªCaesarå¯†æ–‡ï¼Œå†åšä¸Šè¿°çš„å·¥ä½œï¼Œæ˜¯ä¸æ˜¯å°±å®Œæˆäº†æˆ‘ä»¬çš„ç ´è¯‘å·¥ä½œï¼Ÿæ€è·¯å°±æ˜¯è¿™æ ·ï¼Œä½†æ˜¯æ€ä¹ˆç¡®å®šæˆ‘ä»¬çš„å¯†é’¥é•¿åº¦ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å°±è®²è®²æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å§ã€‚</p><h1 id="ç¡®å®šå¯†é’¥é•¿åº¦">ç¡®å®šå¯†é’¥é•¿åº¦</h1><p>è¿™ä¸ªåœ¨ç½‘ä¸Šæœé›†åˆ°çš„èµ„æ–™å…¶å®æ˜¯æœ‰ä¸¤ç§æ–¹æ³•çš„ã€‚åˆ†åˆ«ç§°ä¸ºKasiskiæµ‹è¯•æ³•å’ŒFriedmanæµ‹è¯•æ³•ï¼Œä½†æ˜¯æœ¬æ–‡ç»™åˆ°çš„ä»£ç æ˜¯åŸºäºç¬¬äºŒä¸ªæ–¹æ³•çš„ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆè®²è®²è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ€è·¯å§ã€‚</p><h2 id="kasiskiæµ‹è¯•æ³•">Kasiskiæµ‹è¯•æ³•</h2><p>Kasiskiæµ‹è¯•æ³•æ˜¯ç”±Friedrich Kasiskiäº1863å¹´ç»™å‡ºäº†å…¶æè¿°ï¼Œç„¶è€Œæ—©åœ¨çº¦1854å¹´è¿™ä¸€æ–¹æ³•å°±ç”±Charles Babbageé¦–å…ˆå‘ç°ã€‚</p><p>å®ƒçš„æ€æƒ³æ˜¯åŸºäºè¿™æ ·çš„ä¸€ä¸ªäº‹å®ï¼šä¸¤ä¸ªç›¸åŒçš„æ˜æ–‡æ®µåŠ å¯†æˆç›¸åŒçš„å¯†æ–‡æ®µï¼Œå®ƒä»¬ä¹‹é—´çš„è·ç¦»ä¸ºLengthï¼Œé‚£ä¹ˆå¯†é’¥çš„é•¿åº¦å°±æ˜¯è·ç¦»Lengthçš„çº¦æ•°ã€‚</p><p>è€Œå½“å¯†æ–‡çš„é•¿åº¦å¾ˆé•¿æ—¶ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¤šæ‰¾å‡ ç»„è¿™æ ·æ‹¥æœ‰é‡å¤å¯†æ–‡æ®µï¼Œæ‰¾å‡ºä»–ä»¬é—´è·çš„ç›¸åŒçº¦æ•°å°±æ˜¯å¯†é’¥çš„é•¿åº¦ã€‚</p><p>å…³äºè¿™ä¸ªæ–¹æ³•çš„ä»£ç ï¼Œæœ¬æ–‡å¹¶æœªæ¶‰åŠï¼Œå¤§å®¶æœ‰å…´è¶£å¯è‡ªè¡ŒæŸ¥é˜…èµ„æ–™å®ç°ã€‚</p><p>å¦ï¼šæœºæ™ºçš„ä½ ä¹Ÿè®¸å‘ç°äº†ï¼Œæˆ‘ä»¬è¿™ç§æ–¹æ³•å…¶å®å¹¶æ²¡æœ‰æ¶‰åŠåˆ°æˆ‘ä»¬åˆšæ‰è¯´çš„ç»Ÿè®¡é¢‘åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹ä¸æ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœ¬æ–‡çš„é‡ç‚¹äº†ã€‚</p><h2 id="friedmanæµ‹è¯•æ³•">Friedmanæµ‹è¯•æ³•</h2><p>é¦–å…ˆæˆ‘ä»¬è®²ä¸€ä¸ªæ¦‚å¿µï¼šé‡åˆæŒ‡æ•°ï¼ˆICï¼Œindex of coincidenceï¼‰ã€‚ç™¾åº¦ä¸€ä¸‹è¿™ä¸ªæ¦‚å¿µçš„è¯ï¼Œæœåˆ°çš„ç»“æœå¯èƒ½ä¸æ˜¯ä»¤äººå¾ˆæ»¡æ„ï¼Œæˆ‘ä¹Ÿæ˜¯æ‰¾äº†å¾ˆå¤šèµ„æ–™ï¼Œæ„Ÿè§‰å¦‚ä¸‹çš„æ¦‚å¿µè¯´çš„å¾ˆæ¸…æ¥šï¼Œåˆ†äº«ç»™å¤§å®¶ã€‚</p><p>é‡åˆæŒ‡æ•°è¡¨ç¤ºï¼šä¸¤ä¸ªéšæœºé€‰å‡ºçš„å­—æ¯æ˜¯ç›¸åŒçš„æ¦‚ç‡ï¼Œå¯¹äºæˆ‘ä»¬çš„è‹±æ–‡å­—æ¯æ¥è¯´ï¼Œå³ä»¥ä¸Šæ¦‚ç‡å³ä¸ºéšæœºé€‰å‡ºä¸¤ä¸ªAçš„æ¦‚ç‡+éšæœºé€‰å‡ºä¸¤ä¸ªBçš„æ¦‚ç‡+â€¦.+éšæœºé€‰å‡ºä¸¤ä¸ªZçš„æ¦‚ç‡ã€‚</p><p>å‰äººä¹Ÿä¸ºæˆ‘ä»¬ç»Ÿè®¡å‡ºäº†è¿™ä¸ªæ•°å­—ï¼Œä¸º0.65ã€‚</p><blockquote><p>å³ P(A)^2 + P(B)^2 + P(C)^2 + â€¦ + P(Z)^2 = 0.65.</p></blockquote><p>è€Œåˆ©ç”¨è¿™ä¸€æ¦‚å¿µæ¨æµ‹å¯†é’¥é•¿åº¦çš„åŸç†ä¸ºï¼šå¯¹äºä¸€ä¸ªCaesarå¯†ç çš„åºåˆ—ï¼Œç”±äºæ‰€æœ‰å­—æ¯çš„ä½ç§»ç¨‹åº¦æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯†æ–‡çš„é‡åˆæŒ‡æ•°ç­‰äºåŸæ–‡çš„é‡åˆæŒ‡æ•°ã€‚</p><p>å°†è¿™ä¸€æ¦‚å¿µè¿ç§»åˆ°æˆ‘ä»¬çš„Vigenereå¯†æ–‡ä¸Šï¼Œæˆ‘ä»¬åªè¦è®¡ç®—ä¸åŒå¯†é’¥é•¿åº¦ä¸‹çš„é‡åˆæŒ‡æ•°ï¼Œåªè¦é‡åˆæŒ‡æ•°æ¥è¿‘æœŸæœ›çš„0.65æ—¶ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ¨æµ‹å½“å‰çš„é•¿åº¦å°±æ˜¯æˆ‘ä»¬çš„å¯†é’¥é•¿åº¦ã€‚</p><p><strong>ä¸¾ä¸ªä¾‹å­ï¼š</strong></p><p>å¯†æ–‡ä¸ºï¼šAAABBCCDDDDEEEFG</p><p>é¦–å…ˆæˆ‘ä»¬æµ‹è¯•å¯†é’¥é•¿åº¦=1ï¼Œé¦–å…ˆç»Ÿè®¡ä¸Šè¿°å¯†æ–‡ä¸­æ¯ä¸ªå­—æ¯å‡ºç°çš„æ¬¡æ•°ï¼ˆA-Zï¼‰ï¼š</p><p>Aï¼š3 Bï¼š2 Cï¼š2 Dï¼š4 Eï¼š3 F:1 G:1 H:0 â€¦ Zï¼š0</p><p>ç„¶åæˆ‘ä»¬æ ¹æ®ä¸Šè¿°å…¬å¼è®¡ç®—é‡åˆæŒ‡æ•°Pï¼Œå¦‚æœ P ï¼= 0.65ï¼Œæˆ‘ä»¬å°±å°è¯•å¯†é’¥é•¿åº¦2ã€‚</p><p>å‡è®¾ä¸º2çš„è¯ï¼Œå°†ä¸Šè¿°çš„å¯†æ–‡åˆ†æˆä¸¤ç»„ï¼š</p><p>ç»„1ï¼šA A B C D D E F</p><p>ç»„2ï¼šA B C D D E E G</p><p>å†åˆ†åˆ«è®¡ç®—é‡åˆæŒ‡æ•°ï¼Œå¦‚æœè¿™ä¸¤ä¸ªçš„é‡åˆæŒ‡æ•°éƒ½æ¥è¿‘äº0.65ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åŸºæœ¬ç¡®å®šå¯†é’¥çš„é•¿åº¦ä¸º2äº†ã€‚å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆç»§ç»­å¾€ä¸‹åˆ†ã€‚</p><p>ç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬å¾—åˆ°çš„å¯†æ–‡é•¿åº¦è¶Šé•¿ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•åˆ†æå¾—åˆ°çš„æ•ˆæœä¼šæ›´å¥½ï¼Œå®é™…ä¸Šåœ¨æˆ‘æµ‹è¯•çš„ç»“æœä¸­ï¼Œä¹Ÿç¡®å®ç¬¦åˆåˆšæ‰çš„è¯´æ³•ã€‚</p><h1 id="å®ç°">å®ç°</h1><p><strong>Friedmanæµ‹è¯•æ³•ç¡®å®šå¯†é’¥é•¿åº¦</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// Friedmanæµ‹è¯•æ³•ç¡®å®šå¯†é’¥é•¿åº¦</span><br><span class="line">   public int Friedman(String ciphertext) &#123;</span><br><span class="line">       int keyLength = 1; // çŒœæµ‹å¯†é’¥é•¿åº¦</span><br><span class="line">       double[] IC; // é‡åˆæŒ‡æ•°</span><br><span class="line">       double average; // å¹³å‡é‡åˆæŒ‡æ•°</span><br><span class="line">       ArrayList&lt;String&gt; cipherGroup; // å¯†æ–‡åˆ†ç»„</span><br><span class="line"></span><br><span class="line">       while (true) &#123;</span><br><span class="line">           IC = new double[keyLength];</span><br><span class="line">           cipherGroup = new ArrayList&lt;String&gt;();</span><br><span class="line">           average = 0;</span><br><span class="line"></span><br><span class="line">           // 1 å…ˆæ ¹æ®å¯†é’¥é•¿åº¦åˆ†ç»„</span><br><span class="line">           for (int i = 0; i &lt; keyLength; ++i) &#123;</span><br><span class="line">               StringBuffer temporaryGroup = new StringBuffer();</span><br><span class="line">               for (int j = 0; i + j * keyLength &lt; ciphertext.length(); ++j) &#123;</span><br><span class="line">                   temporaryGroup.append(ciphertext.charAt(i + j * keyLength));</span><br><span class="line">               &#125;</span><br><span class="line">               cipherGroup.add(temporaryGroup.toString());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // 2 å†è®¡ç®—æ¯ä¸€ç»„çš„é‡åˆæŒ‡æ•°</span><br><span class="line">           for (int i = 0; i &lt; keyLength; ++i) &#123;</span><br><span class="line">               String subCipher = new String(cipherGroup.get(i)); // å­ä¸²</span><br><span class="line">               HashMap&lt;Character, Integer&gt; occurrenceNumber = new HashMap&lt;Character, Integer&gt;(); // å­—æ¯åŠå…¶å‡ºç°çš„æ¬¡æ•°</span><br><span class="line"></span><br><span class="line">               // 2.1 åˆå§‹åŒ–å­—æ¯åŠå…¶æ¬¡æ•°é”®å€¼å¯¹</span><br><span class="line">               for (int h = 0; h &lt; 26; ++h) &#123;</span><br><span class="line">                   occurrenceNumber.put((char) (h + 65), 0);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               // 2.2 ç»Ÿè®¡æ¯ä¸ªå­—æ¯å‡ºç°çš„æ¬¡æ•°</span><br><span class="line">               for (int j = 0; j &lt; subCipher.length(); ++j) &#123;</span><br><span class="line">                   occurrenceNumber.put(subCipher.charAt(j), occurrenceNumber.get(subCipher.charAt(j)) + 1);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               // 2.3 è®¡ç®—é‡åˆæŒ‡æ•°</span><br><span class="line">               double denominator = Math.pow((double) subCipher.length(), 2);</span><br><span class="line">               for (int k = 0; k &lt; 26; ++k) &#123;</span><br><span class="line">                   double o = (double) occurrenceNumber.get((char) (k + 65));</span><br><span class="line">                   IC[i] += o * (o - 1);</span><br><span class="line">               &#125;</span><br><span class="line">               IC[i] /= denominator;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // 3 åˆ¤æ–­é€€å‡ºæ¡ä»¶,é‡åˆæŒ‡æ•°çš„å¹³å‡å€¼æ˜¯å¦å¤§äº0.065</span><br><span class="line">           for (int i = 0; i &lt; keyLength; ++i) &#123;</span><br><span class="line">               average += IC[i];</span><br><span class="line">           &#125;</span><br><span class="line">           average /= (double) keyLength;</span><br><span class="line">           if (average &gt;= 0.06) &#123;</span><br><span class="line">               break;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               keyLength++;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; // while--end</span><br><span class="line">       </span><br><span class="line">       return keyLength;</span><br><span class="line">   &#125;// Friedman--end</span><br></pre></td></tr></table></figure><p><strong>ç ´è¯‘å¯†æ–‡</strong></p><p>è¿™é‡Œç»™å‡ºæ¥çš„æ˜¯æ‰“å°å‡ºæ¥äº†å…·ä½“çš„å¯†é’¥å’Œæ˜æ–‡ï¼Œå®é™…ä¸Šå¯ä»¥ç›´æ¥å†™ä¸€ä¸ªç±»ï¼Œç±»ä¸­è®¾è®¡ä¸¤ä¸ªå±æ€§å€¼ï¼Œä¸€ä¸ªå¯†é’¥å±æ€§ï¼Œä¸€ä¸ªæ˜æ–‡å±æ€§ï¼Œç›´æ¥èµ‹å€¼ä¸‹å°±å¯ä»¥äº†ã€‚ç›¸ä¿¡æœºæ™ºçš„ä½ å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">public void decryptCipher(int keyLength, String ciphertext) &#123;</span><br><span class="line">        int[] key = new int[keyLength];</span><br><span class="line">        ArrayList&lt;String&gt; cipherGroup = new ArrayList&lt;String&gt;();</span><br><span class="line">        double[] probability = new double[] &#123; 0.082, 0.015, 0.028, 0.043, 0.127, 0.022, 0.02, 0.061, 0.07, 0.002, 0.008,</span><br><span class="line">                0.04, 0.024, 0.067, 0.075, 0.019, 0.001, 0.06, 0.063, 0.091, 0.028, 0.01, 0.023, 0.001, 0.02, 0.001 &#125;;</span><br><span class="line"></span><br><span class="line">        // 1 å…ˆæ ¹æ®å¯†é’¥é•¿åº¦åˆ†ç»„</span><br><span class="line">        for (int i = 0; i &lt; keyLength; ++i) &#123;</span><br><span class="line">            StringBuffer temporaryGroup = new StringBuffer();</span><br><span class="line">            for (int j = 0; i + j * keyLength &lt; ciphertext.length(); ++j) &#123;</span><br><span class="line">                temporaryGroup.append(ciphertext.charAt(i + j * keyLength));</span><br><span class="line">            &#125;</span><br><span class="line">            cipherGroup.add(temporaryGroup.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 2 ç¡®å®šå¯†é’¥</span><br><span class="line">        for (int i = 0; i &lt; keyLength; ++i) &#123;</span><br><span class="line">            double MG; // é‡åˆæŒ‡æ•°</span><br><span class="line">            int flag; // ç§»åŠ¨ä½ç½®</span><br><span class="line">            int g = 0; // å¯†æ–‡ç§»åŠ¨gä¸ªä½ç½®</span><br><span class="line">            HashMap&lt;Character, Integer&gt; occurrenceNumber; // å­—æ¯å‡ºç°æ¬¡æ•°</span><br><span class="line">            String subCipher; // å­ä¸²</span><br><span class="line"></span><br><span class="line">            while (true) &#123;</span><br><span class="line">                MG = 0;</span><br><span class="line">                flag = 65 + g;</span><br><span class="line">                subCipher = new String(cipherGroup.get(i));</span><br><span class="line">                occurrenceNumber = new HashMap&lt;Character, Integer&gt;();</span><br><span class="line"></span><br><span class="line">                // 1.1 åˆå§‹åŒ–å­—æ¯åŠå…¶æ¬¡æ•°</span><br><span class="line">                for (int h = 0; h &lt; 26; ++h) &#123;</span><br><span class="line">                    occurrenceNumber.put((char) (h + 65), 0);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 1.2 ç»Ÿè®¡å­—æ¯å‡ºç°æ¬¡æ•°</span><br><span class="line">                for (int j = 0; j &lt; subCipher.length(); ++j) &#123;</span><br><span class="line">                    occurrenceNumber.put(subCipher.charAt(j), occurrenceNumber.get(subCipher.charAt(j)) + 1);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 1.3 è®¡ç®—é‡åˆæŒ‡æ•°</span><br><span class="line">                for (int k = 0; k &lt; 26; ++k, ++flag) &#123;</span><br><span class="line">                    double p = probability[k];</span><br><span class="line">                    flag = (flag == 91) ? 65 : flag;</span><br><span class="line">                    double f = (double) occurrenceNumber.get((char) flag) / subCipher.length();</span><br><span class="line">                    MG += p * f;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 1.4 åˆ¤æ–­é€€å‡ºæ¡ä»¶</span><br><span class="line">                if (MG &gt;= 0.055) &#123;</span><br><span class="line">                    key[i] = g;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    ++g;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; // while--end</span><br><span class="line">        &#125; // for--end</span><br><span class="line"></span><br><span class="line">        // 3 æ‰“å°å¯†é’¥</span><br><span class="line">        StringBuffer keyString = new StringBuffer();</span><br><span class="line">        for (int i = 0; i &lt; keyLength; ++i) &#123;</span><br><span class="line">            keyString.append((char) (key[i] + 65));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;\nå¯†é’¥ä¸º: &quot; + keyString.toString());</span><br><span class="line"></span><br><span class="line">        // 4 è§£å¯†</span><br><span class="line">        StringBuffer plainBuffer = new StringBuffer();</span><br><span class="line">        for (int i = 0; i &lt; ciphertext.length(); ++i) &#123;</span><br><span class="line">            int keyFlag = i % keyLength;</span><br><span class="line">            int change = (int) ciphertext.charAt(i) - 65 - key[keyFlag];</span><br><span class="line">            char plainLetter = (char) ((change &lt; 0 ? (change + 26) : change) + 65);</span><br><span class="line">            plainBuffer.append(plainLetter);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;\næ˜æ–‡ä¸ºï¼š\n&quot; + plainBuffer.toString().toLowerCase());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><p><a href="https://blog.csdn.net/limisky/article/details/16885959" target="_blank" rel="noopener">ç»´å‰å°¼äºšå¯†ç åŠå…¶ç ´è§£</a></p><p><a href="https://blog.csdn.net/white_idiot/article/details/61201864" target="_blank" rel="noopener">ã€å¯†ç å­¦ã€‘ç»´å‰å°¼äºšå¯†ç åŠ è§£å¯†åŸç†åŠå…¶ç ´è§£ç®—æ³•Javaå®ç°</a></p><p>ä»¥ä¸Šæ˜¯æœ¬æ¬¡åšå®¢çš„å…¨éƒ¨å†…å®¹ï¼Œæ„Ÿè°¢é©»è¶³~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;ä¸Šæ¬¡è¯´åˆ°äº†VigenereåŠ å¯†ä»¥åŠè§£å¯†çš„ç®—æ³•ï¼Œä½†æ˜¯å¦‚ä½•ç ´è¯‘è¿™æ ·çš„å¯†ç ï¼Œä¹Ÿæ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œè¿™ç¯‡åšå®¢å°±æ˜¯å®ç°ä¸€ä¸ªè¿™æ ·çš„ç ´è¯‘ï¼Œä¸»è¦é’ˆå¯¹çš„æ˜¯é€šè¿‡VigenereåŠ å¯†çš„å¯†æ–‡ï¼Œé‚£ä¹ˆå°±å¼€å§‹å§~&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1
        
      
    
    </summary>
    
      <category term="å¯†ç å­¦" scheme="http://weafteam.github.io/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/"/>
    
    
      <category term="å¯†ç å­¦" scheme="http://weafteam.github.io/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/"/>
    
  </entry>
  
  <entry>
    <title>Redisåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ</title>
    <link href="http://weafteam.github.io/posts/2b2e3e2f/"/>
    <id>http://weafteam.github.io/posts/2b2e3e2f/</id>
    <published>2018-04-18T09:57:12.000Z</published>
    <updated>2018-05-29T01:27:49.847Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©å¼€å§‹ç»™å¤§å®¶åˆ†äº«Javaç›¸å…³çš„æŠ€æœ¯å¼€å‘çŸ¥è¯†ï¼Œåœ¨ä»¥åçš„å¼€å‘å’Œå­¦ä¹ ä¸­ï¼Œè¿˜å¸Œæœ›å¤§å®¶å¤šå¤šæŒ‡æ•™ï¼Œå¯¹äºæˆ‘å‘è¡¨çš„ç›¸å…³å†…å®¹ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œè¯·å¤§å®¶æŒ‡å‡ºæ¥ï¼Œä¸€èµ·å­¦ä¹ ã€‚ æ›´è¦è®°ä½è¿™å¥è¯ï¼šStay Hungry, Stay Foolish.</p><h2 id="ä¸€redisçš„å®‰è£…">ä¸€ã€Redisçš„å®‰è£…</h2><p>ä¸ºäº†æ–¹ä¾¿æ•™ç¨‹è¿™é‡Œå…ˆç®€å•ä»‹ç»Redisçš„å®‰è£…ã€‚</p><h3 id="windowså¹³å°çš„å®‰è£…">1. windowså¹³å°çš„å®‰è£…</h3><p>ç°åœ¨å®˜ç½‘å·²ç»ä¸æä¾›windowså¹³å°çš„ä¸‹è½½ï¼Œæ‰€ä»¥åªèƒ½å»githubä¸Šä¸‹è½½å®‰è£… <a href="https://github.com/MSOpenTech/redis/tags" target="_blank" rel="noopener">githubä¸‹è½½ç½‘å€</a> è¿›å…¥ä¹‹åé€‰æ‹©å¥½ç‰ˆæœ¬ç‚¹å‡»msiä¸‹è½½ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-1.png" alt="Redis"> ç„¶ååŒå‡»å®‰è£…ã€‚ é»˜è®¤æ˜¯ç›´æ¥è¿è¡Œçš„ã€‚ å¯ä»¥é€šè¿‡æ§åˆ¶å°è®¿é—®å¦‚ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-2.png" alt="Redis"> å…·ä½“è¯­æ³•å¯ä»¥åœ¨ç›¸å…³ç½‘ä¸ŠæŸ¥é˜…ã€‚ ### 2. Linuxå¹³å°çš„å®‰è£… ç›´æ¥åˆ°å®˜ç½‘ä¸‹è½½ <a href="http://redis.io/download" target="_blank" rel="noopener">Redis.io</a> è§£å‹å¹¶å®‰è£… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-4.0.9.tar.gz</span><br><span class="line">tar xzf redis-4.0.9.tar.gz</span><br><span class="line">cd redis-4.0.9</span><br><span class="line">make</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>æœåŠ¡ç«¯è¿è¡Œè„šæœ¬ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/redis-server</span><br></pre></td></tr></table></figure></p><p>å®¢æˆ·ç«¯è¿è¡Œè„šæœ¬ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/redis-cli</span><br></pre></td></tr></table></figure></p><h3 id="springboot2.0ç›¸å…³é…ç½®">3. SpringBoot2.0ç›¸å…³é…ç½®</h3><p>pomæ–‡ä»¶åŠ å…¥ä»¥ä¸‹ä¾èµ– <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><p>æˆ‘è¿™é‡ŒSpringBootçš„é…ç½®æ–‡ä»¶ä½¿ç”¨çš„æ˜¯YAMLã€‚ åœ¨ç›¸åº”ç¯å¢ƒä¸­é…ç½®Redis ##### application-local.yml <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    datasource:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">        driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">jdbc:mysql://127.0.0.1:3306/local?useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    redis:</span></span><br><span class="line"><span class="attr">          database:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">          port:</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">          jedis:</span></span><br><span class="line"><span class="attr">            pool:</span></span><br><span class="line"><span class="attr">              min-idle:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">              max-idle:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">              max-active:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">              max-wait:</span> <span class="bullet">-1</span><span class="string">ms</span></span><br></pre></td></tr></table></figure></p><h3 id="ä»£ç çº§åˆ«é…ç½®">4.ä»£ç çº§åˆ«é…ç½®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xxx.controller.entry.entity.AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.convert.KeyspaceConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.repository.configuration.EnableRedisRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 18:35 2018/4/17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="comment">//å¢åŠ Respositoryæ”¯æŒï¼Œå¹¶ä½¿å…¶æ”¯æŒ@TimeToLive</span></span><br><span class="line"><span class="meta">@EnableRedisRepositories</span>(keyspaceConfiguration = RedisCacheConfig.MyKeyspaceConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">cacheManager</span><span class="params">(RedisConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RedisCacheManager.builder(connectionFactory).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public RedisConnectionFactory connectionFactory() &#123;</span></span><br><span class="line"><span class="comment">//        return new JedisConnectionFactory();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;?, ?&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123;</span><br><span class="line">        RedisTemplate&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt; template = <span class="keyword">new</span> RedisTemplate&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory)&#123;</span></span><br><span class="line"><span class="comment">//        RedisTemplate&lt;Object, Object&gt; redisTemplate = new RedisTemplate&lt;Object, Object&gt;();</span></span><br><span class="line"><span class="comment">//        redisTemplate.setConnectionFactory(redisConnectionFactory);</span></span><br><span class="line"><span class="comment">//        redisTemplate.setKeySerializer(new StringRedisSerializer());//keyåºåˆ—åŒ–</span></span><br><span class="line"><span class="comment">//        redisTemplate.setValueSerializer(new Jackson2JsonRedisSerializer(Object.class));  //valueåºåˆ—åŒ–</span></span><br><span class="line"><span class="comment">//        redisTemplate.afterPropertiesSet();</span></span><br><span class="line"><span class="comment">//        return redisTemplate;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyKeyspaceConfiguration</span> <span class="keyword">extends</span> <span class="title">KeyspaceConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Iterable&lt;KeyspaceSettings&gt; <span class="title">initialConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> KeyspaceSettings(AccessToken.class, <span class="string">"accessToken"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼“å­˜å¯¹è±¡AccessToken <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisHash;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.TimeToLive;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 14:26 2018/4/18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RedisHash</span>(<span class="string">"accessToken"</span>)</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessToken</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    String id;</span><br><span class="line">    String accessToken;</span><br><span class="line">    <span class="meta">@TimeToLive</span></span><br><span class="line">    Long expire;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åˆ›å»ºRespository <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xxx.controller.entry.entity.AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.CrudRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 14:34 2018/4/18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="comment">// ç»§æ‰¿è‡ªCURDï¼Œé‡Œè¾¹æœ‰æœ€åŸºæœ¬çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessTokenRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">AccessToken</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥å®Œæˆè‡ªå·±çš„ä¸šåŠ¡æœåŠ¡ç±» <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xxx.controller.entry.entity.AccessToken;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 14:50 2018/4/18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessTokenService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">AccessToken <span class="title">save</span><span class="params">(AccessToken accessToken)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(AccessToken accessToken)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AccessToken <span class="title">get</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸šåŠ¡æœåŠ¡ç±»çš„å®ç° <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xxx.controller.entry.entity.AccessToken;</span><br><span class="line"><span class="keyword">import</span> com.xxx.dao.repository.AccessTokenRepository;</span><br><span class="line"><span class="keyword">import</span> com.xxx.service.AccessTokenService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 14:52 2018/4/18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span>(<span class="string">"accessTokenService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessTokenServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccessTokenService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccessTokenRepository repo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AccessToken <span class="title">save</span><span class="params">(AccessToken accessToken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  repo.save(accessToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(AccessToken accessToken)</span> </span>&#123;</span><br><span class="line">        repo.delete(accessToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AccessToken <span class="title">get</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        Optional&lt;AccessToken&gt; accessToken = repo.findById(id);</span><br><span class="line">        <span class="keyword">return</span> accessToken.orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»¥ä¸Šå®Œæˆäº†æ•´ä¸ªæ•´åˆè¿‡ç¨‹ã€‚ ### 5. ç®€å•çš„æµ‹è¯• <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xxx.controller.entry.entity.AccessToken;</span><br><span class="line"><span class="keyword">import</span> com.xxx.service.AccessTokenService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> ï¼šyaxuSong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 15:16 2018/4/18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modified</span> by:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccessTokenService accessTokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        AccessToken accessToken = <span class="keyword">new</span> AccessToken();</span><br><span class="line">        accessToken.setAccessToken(<span class="string">"dadaadadsdadewqeqfskksdbfdbkfsdkdajdhwke2elhsbcslc/DNDAWDAWWAFEWFSD23E2342"</span>);</span><br><span class="line">        accessToken.setExpire(<span class="number">60L</span>);</span><br><span class="line"><span class="comment">//å•ä½ ç§’</span></span><br><span class="line">        AccessToken at = accessTokenService.save(accessToken);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"æˆåŠŸ"</span>+<span class="string">"é”®å€¼ä¸ºï¼š"</span>+at.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">        AccessToken accessToken = accessTokenService.get(id);</span><br><span class="line">        <span class="keyword">return</span> accessToken==<span class="keyword">null</span>?<span class="string">"å·²è¿‡æœŸ"</span>:accessToken.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æµ‹è¯•ç»“æœï¼š</p><p><img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-3.png" alt="Redis"></p><p>æˆ‘è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªè¿‡æœŸæ—¶é—´ä¸º60sçš„tokenã€‚ æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹å¯ä»¥çœ‹åˆ°æ—¶é—´çš„å˜åŒ–</p><p>ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼š <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-4.png" alt="Redis"> ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼š <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-5.png" alt="Redis"> ç¬¬ä¸‰æ¬¡æŸ¥è¯¢ï¼š <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-6.png" alt="Redis"></p><p>æˆ‘ä»¬æŸ¥çœ‹ä¸‹æœ¬åœ°Rdisæ‰€æœ‰é”®å€¼æƒ…å†µï¼š <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-7.png" alt="Redis"> è¿‡ä¸€æ®µæ—¶é—´åæŸ¥è¯¢ï¼š <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-9.png" alt="Redis"> æˆ‘ä»¬å‘ç°ä¹‹å‰è¿˜å­˜åœ¨é”®å€¼idä¸ºc07cde6a-aec7-40f3-ad39-41862209bc9fçš„ï¼Œä½†æ˜¯å†…å®¹æ²¡æœ‰äº†ã€‚ åæ¥æŸ¥è¯¢çš„å°±è¢«åˆ é™¤äº†ï¼ˆè¿‡æœŸåä¸ä¼šç›´æ¥åˆ é™¤ï¼Œä¼šç¨æœ‰å»¶è¿Ÿï¼Œåªæœ‰idå­˜åœ¨ï¼Œå…¶ä»–éƒ½å·²è¢«åˆ é™¤ï¼‰</p><p>æˆ‘ä»¬çœ‹åˆ°é”®å€¼ä¸ºï¼šd2b97d54-1c8b-4803-8f60-6aaf3384fc32çš„æ˜¯æˆ‘ä¹‹å‰å­˜çš„TTL=7200sçš„ã€‚ <img src="https://weaf.oss-cn-beijing.aliyuncs.com/redis-8.png" alt="Redis"></p><p>è‡³æ­¤æ‰€æœ‰ç›¸å…³çš„å†…å®¹å°±ä»‹ç»å®Œäº†ã€‚</p><p>æœ¬æ–‡å‚è€ƒåœ°å€ï¼š<a href="https://docs.spring.io/spring-data/redis/docs/2.0.5.RELEASE/reference/html/" target="_blank" rel="noopener">Spring-data-redis</a></p>]]></content>
    
    <summary type="html">
    
      Redisåœ¨SpringBoot 2.0ä¸­çš„æ•´åˆ
    
    </summary>
    
      <category term="JAVA" scheme="http://weafteam.github.io/categories/JAVA/"/>
    
    
      <category term="JAVA" scheme="http://weafteam.github.io/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>Linuxä¸‹MySQLå®‰è£…</title>
    <link href="http://weafteam.github.io/posts/2cd32dfc/"/>
    <id>http://weafteam.github.io/posts/2cd32dfc/</id>
    <published>2018-04-17T04:07:12.000Z</published>
    <updated>2018-05-29T01:27:49.843Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç»3ç§æ–¹æ³•å®‰è£…MySQL</p><h1 id="ç¬¬ä¸€ç§">ç¬¬ä¸€ç§</h1><h2 id="ä¸€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†mysql">ä¸€ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†MySQL</h2><p>ä½¿ç”¨å‘½ä»¤ï¼š <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep -i mysql</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä½¿ç”¨centosï¼Œå¯èƒ½ä¼šå‡ºç°å†²çªï¼Œè§£å†³å†²çªéœ€è¦å¸è½½mariadb é¦–å…ˆæŸ¥çœ‹æ˜¯å¦å®‰è£…äº†Mariadb <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep mariadb</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>ç„¶åå¸è½½ <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e mariadb-libs-5.5.56-2.el7.x86_64</span><br></pre></td></tr></table></figure></p><p>å¼ºåˆ¶å¸è½½(å¯é€‰): <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps mariadb-libs-5.5.56-2.el7.x86_64</span><br></pre></td></tr></table></figure></p><p><img src="http://us-forever.com/img/linuxMySQL-1.png" alt="mysql-1"> äºŒã€å¦‚æœå®‰è£…äº†éœ€åˆ é™¤å·²å®‰è£…ç‰ˆæœ¬ â€”â€” åˆ é™¤å‘½ä»¤ï¼š <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps åŒ…å</span><br><span class="line">( rpm -ev mysql-4.1.12-3.RHEL4.1 )</span><br></pre></td></tr></table></figure></p><p>åˆ é™¤è€ç‰ˆæœ¬mysqlçš„å¼€å‘å¤´æ–‡ä»¶å’Œåº“ å‘½ä»¤ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -fr /usr/lib/mysql</span><br><span class="line">rm -fr /usr/include/mysql</span><br></pre></td></tr></table></figure></p><p>æ³¨æ„ï¼šå¸è½½å/var/lib/mysqlä¸­çš„æ•°æ®åŠ/etc/my.cnfä¸ä¼šåˆ é™¤ï¼Œå¦‚æœç¡®å®šæ²¡ç”¨åå°±æ‰‹å·¥åˆ é™¤ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /etc/my.cnf</span><br><span class="line">rm -fr /var/lib/mysql</span><br></pre></td></tr></table></figure></p><h2 id="ä¸‰å®‰è£…mysqlå‡†å¤‡ç¯å¢ƒ">ä¸‰ã€å®‰è£…mysqlå‡†å¤‡ç¯å¢ƒ</h2><p>æˆ‘è‡ªmysqlå®˜ç½‘ä¸‹è½½é€šç”¨çš„Linuxç‰ˆæœ¬å®‰è£…åŒ… mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz å°†ä¸‹è½½å¥½çš„åŒ…æ”¾åœ¨ /usr/local ç›®å½•ä¸‹ï¼Œæˆ–è€…æ‰§è¡Œå‘½ä»¤ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">wget https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p><p><img src="http://us-forever.com/img/linuxMySQL-2.png" alt="mysql-2"></p><p>è§£å‹ä¸‹è½½çš„æ–‡ä»¶ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p><p>å°†è§£å‹ä¹‹åçš„æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°/usr/local/mysql <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ./mysql-5.7.20-linux-glibc2.12-x86_64/* ./mysql</span><br></pre></td></tr></table></figure></p><p>ä¸ºmysqlåˆ›å»ºç³»ç»Ÿç”¨æˆ·(å¯é€‰ï¼Œæ–°ç‰ˆæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºç›¸åº”ç”¨æˆ·) <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql mysql</span><br></pre></td></tr></table></figure></p><p>//-rå‚æ•°è¡¨ç¤ºmysqlç”¨æˆ·æ˜¯ç³»ç»Ÿç”¨æˆ·ï¼Œä¸å¯ç”¨äºç™»å½•ç³»ç»Ÿ å¹¶å˜æ›´mysqlå®‰è£…ç›®å½•çš„æ‰€å±ç”¨æˆ·å’Œç”¨æˆ·ç»„ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql mysql</span><br><span class="line">// -R è¿­ä»£å¤„ç†</span><br></pre></td></tr></table></figure></p><p><img src="http://us-forever.com/img/linuxMySQL-3.png" alt="mysql-3"> å››ã€ å®‰è£…å’Œåˆå§‹åŒ– â€”â€”</p><p>åˆå§‹åŒ–æ•°æ®åº“ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --lc_messages_dir=/usr/local/mysql/share --lc_messages=en_US</span><br></pre></td></tr></table></figure></p><p>è®°å½•åˆšåˆšè¾“å‡ºçš„å¯†ç ï¼š jk9tEao&lt;94MC <img src="http://us-forever.com/img/linuxMySQL-4.png" alt="mysql-4"></p><p>é…ç½®/etc/my.cnf</p><p><a href="http://us-forever.com/file/my.cnf" target="_blank" rel="noopener">my.cnf</a></p><h2 id="äº”-å¯åŠ¨ç™»å½•å’Œè®¾ç½®å¯†ç ">äº”ã€ å¯åŠ¨ç™»å½•å’Œè®¾ç½®å¯†ç </h2><p>åˆ‡æ¢åˆ°mysqlå®‰è£…ç›®å½•çš„binä¸‹å¯åŠ¨ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mysqld_safe --user=mysql</span><br></pre></td></tr></table></figure></p><p>å¯åŠ¨åå¯èƒ½æ— æ³•ä½¿ç”¨å½“å‰çª—å£</p><p>ç™»å½•è¿›å»è®¾ç½®æ–°çš„å¯†ç ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mysql -u root -p</span><br></pre></td></tr></table></figure></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">password</span>=<span class="keyword">password</span>(<span class="string">"root"</span>);</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure><p><img src="http://us-forever.com/img/linuxMySQL-5.png" alt="mysql-5"></p><p>å…­ã€ æ·»åŠ åˆ°æœåŠ¡</p><p>åˆ‡æ¢åˆ° support-filesç›®å½•ä¸‹ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp mysql.server /etc/init.d/mysql</span><br></pre></td></tr></table></figure></p><p>ç„¶ååœæ­¢å½“å‰è¿›ç¨‹ï¼Œä½¿ç”¨æœåŠ¡å¯åŠ¨mysql <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql start</span><br></pre></td></tr></table></figure></p><p>å¹¶æ·»åŠ mysqlç¯å¢ƒå˜é‡ åœ¨ /etc/profile çš„æ–‡ä»¶æœ«å°¾è¿½åŠ ï¼š export PATH=$PATH:/usr/local/mysql/bin ä¿å­˜åæ‰§è¡Œ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p><p>æœ€åä½¿ç”¨æ–°å¯†ç ç™»å½•åˆ°mysql <img src="http://us-forever.com/img/linuxMySQL-6.png" alt="mysql-6"></p><h1 id="ç¬¬äºŒç§">ç¬¬äºŒç§</h1><h2 id="ä¸€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†mysql-1">ä¸€ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†MySQL</h2><p>ä½¿ç”¨å‘½ä»¤ï¼š <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep -i mysql</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä½¿ç”¨centosï¼Œå¯èƒ½ä¼šå‡ºç°å†²çªï¼Œè§£å†³å†²çªéœ€è¦å¸è½½mariadb é¦–å…ˆæŸ¥çœ‹æ˜¯å¦å®‰è£…äº†Mariadb <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep mariadb</span><br></pre></td></tr></table></figure></p><!--more--><p>ç„¶åå¸è½½ <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e mariadb-libs-5.5.56-2.el7.x86_64</span><br></pre></td></tr></table></figure></p><p>å¼ºåˆ¶å¸è½½(å¯é€‰): <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps mariadb-libs-5.5.56-2.el7.x86_64</span><br></pre></td></tr></table></figure></p><p><img src="http://us-forever.com/img/linuxMySQL-1.png" alt="mysql-1"> äºŒã€å¦‚æœå®‰è£…äº†éœ€åˆ é™¤å·²å®‰è£…ç‰ˆæœ¬ â€”â€” åˆ é™¤å‘½ä»¤ï¼š <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps åŒ…å</span><br><span class="line">( rpm -ev mysql-4.1.12-3.RHEL4.1 )</span><br></pre></td></tr></table></figure></p><p>åˆ é™¤è€ç‰ˆæœ¬mysqlçš„å¼€å‘å¤´æ–‡ä»¶å’Œåº“ å‘½ä»¤ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -fr /usr/lib/mysql</span><br><span class="line">rm -fr /usr/include/mysql</span><br></pre></td></tr></table></figure></p><p>æ³¨æ„ï¼šå¸è½½å/var/lib/mysqlä¸­çš„æ•°æ®åŠ/etc/my.cnfä¸ä¼šåˆ é™¤ï¼Œå¦‚æœç¡®å®šæ²¡ç”¨åå°±æ‰‹å·¥åˆ é™¤ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /etc/my.cnf</span><br><span class="line">rm -fr /var/lib/mysql</span><br></pre></td></tr></table></figure></p><p>ä¸‰ã€å‡†å¤‡å®‰è£…çš„ç¯å¢ƒ wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-1.el7.x86_64.rpm-bundle.tar æˆ–è€…ç”¨è‡ªå·±å‡†å¤‡å¥½çš„åŒ… mysql-5.7.20-1.el7.x86_64.rpm-bundle.tar è§£å‹åŒ… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf mysql-5.7.20-1.el7.x86_64.rpm-bundle.tar</span><br></pre></td></tr></table></figure></p><p>ç„¶åæŒ‰ç…§ä»¥ä¸‹é¡ºåºå®‰è£… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh mysql-community-common-5.7.20-1.el7.x86_64.rpm </span><br><span class="line">rpm -ivh mysql-community-libs-5.7.20-1.el7.x86_64.rpm </span><br><span class="line">rpm -ivh mysql-community-client-5.7.20-1.el7.x86_64.rpm </span><br><span class="line">rpm -ivh mysql-community-server-5.7.20-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>å››ã€å¯åŠ¨å¹¶ä¿®æ”¹å¯†ç  å®‰è£…å®Œæˆåå°±å¯ä»¥å¯åŠ¨æœåŠ¡äº† <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld start</span><br></pre></td></tr></table></figure></p><p>å¯åŠ¨åæŸ¥çœ‹é…ç½®æ–‡ä»¶ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure></p><p><img src="http://us-forever.com/img/linuxMySQL-1-2.png" alt="linuxMySQL-1-2.png"> æ‰¾æ‰“logæ–‡ä»¶ è¿›å…¥æŸ¥æ‰¾é»˜è®¤rootå¯†ç  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/log/mysqld.log</span><br></pre></td></tr></table></figure></p><p><img src="http://us-forever.com/img/linuxMySQL-1-3.png"></p><p>ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ç™»å½•å¹¶ä¿®æ”¹å¯†ç  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹å¯†ç  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET PASSWORD FOR &apos;root&apos;@&apos;localhost&apos; = PASSWORD(&apos;newpass&apos;);</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></p><p><img src="http://us-forever.com/img/linuxMySQL-1-4.png"></p><h1 id="ç¬¬ä¸‰ç§">ç¬¬ä¸‰ç§</h1><h2 id="ä¸€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†mysqlæ•°æ®åº“">ä¸€ã€æŸ¥çœ‹æ˜¯å¦å®‰è£…äº†MySQLæ•°æ®åº“</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep mysql</span><br></pre></td></tr></table></figure><p><img src="http://us-forever.com/img/mysql1.png"> å¸è½½ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps mysql-libs-5.1.71-1.el6.x86_64</span><br></pre></td></tr></table></figure></p><p>äºŒã€å®‰è£… å®‰è£…ä¸€ä¸‹åŒ… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh MySQL-devel-5.6.23-1.linux_glibc2.5.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-client-5.6.23-1.linux_glibc2.5.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-server-5.6.23-1.linux_glibc2.5.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-embedded-5.6.23-1.linux_glibc2.5.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-shared-5.6.23-1.linux_glibc2.5.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-shared-compat-5.6.23-1.linux_glibc2.5.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>ä¸‰ã€å¯åŠ¨ç™»å½•è®¾ç½®å¯†ç  ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¼€å¯æœåŠ¡</p><pre><code>service mysql start</code></pre><p>è·å–åˆå§‹å¯†ç ï¼š <img src="http://us-forever.com/img/mysql2.png"> ä½¿ç”¨rootç™»å½•</p><pre><code>mysql -uroot -p</code></pre><p>ç„¶åè¯•ç”¨ä¸€ä¸‹å‘½ä»¤è®¾ç½®å¯†ç </p><pre><code>SET PASSWORD = PASSWORD(&#39;123456&#39;);</code></pre>]]></content>
    
    <summary type="html">
    
      Linuxä¸‹MySQLå®‰è£…
    
    </summary>
    
      <category term="Linux" scheme="http://weafteam.github.io/categories/Linux/"/>
    
    
      <category term="Linuxè¿ç»´" scheme="http://weafteam.github.io/tags/Linux%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>chapter-05-AIR</title>
    <link href="http://weafteam.github.io/posts/7b0ee3f1/"/>
    <id>http://weafteam.github.io/posts/7b0ee3f1/</id>
    <published>2018-04-15T14:14:23.000Z</published>
    <updated>2018-05-29T01:27:49.835Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-åŸºç¡€2">TensorFlow åŸºç¡€ï¼ˆ2ï¼‰</h1><p>ä»Šå¤©æœ‰å’Œå¤§å®¶è§é¢äº†ï¼Œä»Šå¤©çš„æ–‡ç« å¯èƒ½å†…å®¹æœ‰ç‚¹å°‘ï¼Œè¿™å‘¨æœ‰å¾ˆå¤šäº‹æƒ…ï¼Œæ‰€ä»¥å°‘å†™ç‚¹ã€‚ä¸‹ä¸€å‘¨æˆ‘å°½é‡å¤šå†™ç‚¹ã€‚å¼¥è¡¥å¤§å®¶ã€‚é‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©é—²è¯å°‘è¯´ï¼Œç›´æ¥å¼€å§‹ä»Šå¤©çš„TensorFlowçš„åŸºç¡€ä»‹ç»ã€‚æ¥ç€ä¸Šä¸€èŠ‚ç»§ç»­è®²èµ·ã€‚</p><ol type="1"><li>Loss Functions</li></ol><blockquote><p>ä»Šå¤©è¿™ä¸ªå¼€å¤´å°±æ˜¯æœ€å¸¸ç”¨çš„æŸå¤±å‡½æ•°çš„å®ç°ï¼Œä½¿ç”¨ã€‚ä¸»è¦æ¶‰åŠåˆ°ä¸¤ç§æŸå¤±å‡½æ•°çš„è®¾è®¡ï¼Œæ•°å€¼é¢„æµ‹çš„å›å½’æŸå¤±å‡½æ•°ï¼Œè¿˜æœ‰åˆ†ç±»çš„æŸå¤±å‡½æ•°è®¾è®¡ã€‚é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å¼€å§‹æˆ‘ä»¬çš„å®ç°ï¼Œæœ‰ä»€ä¹ˆéš¾ç‚¹æˆ‘ä¼šæ³¨é‡Šã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é¦–å…ˆæˆ‘ä»¬åƒå¾€å¸¸ä¸€åœºå¯¼å…¥æˆ‘ä»¬éœ€è¦çš„æ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line">x_vals = tf.linspace(<span class="number">-1.</span>, <span class="number">1.</span>, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">target = tf.constant(<span class="number">0.</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># l2 loss å’Œl2èŒƒæ•°å·®ä¸€ä¸ªå¹³æ–¹æ ¹</span></span><br><span class="line">l2_y_vals = tf.square(target - x_vals)</span><br><span class="line">l2_y_out = sess.run(l2_y_vals)</span><br><span class="line"></span><br><span class="line"><span class="comment"># l1 loss å°±æ˜¯l1èŒƒæ•°</span></span><br><span class="line">l1_y_vals = tf.abs(target - x_vals)</span><br><span class="line">l1_y_out = sess.run(l1_y_vals)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pseudo-Huber loss ä¸ºäº†è®©lossæ›´åŠ çš„å…‰æ»‘ä¸€äº›</span></span><br><span class="line"><span class="comment"># å…·ä½“çœ‹å…¬å¼ä¸€</span></span><br><span class="line">delta = tf.constant(<span class="number">0.25</span>)</span><br><span class="line">phuber1_y_vals = tf.multiply(tf.square(delta), tf.sqrt(<span class="number">1.</span> + tf.square((target - x_vals) / delta)) - <span class="number">1.</span>)</span><br><span class="line">phuber1_y_out = sess.run(phuber1_y_vals)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delta2 = tf.constant(<span class="number">5.</span>)</span><br><span class="line">phuber2_y_vals = tf.multiply(tf.square(delta2), tf.sqrt(<span class="number">1.</span> + tf.square((target - x_vals)/delta2)) - <span class="number">1.</span>)</span><br><span class="line">phuber2_y_out = sess.run(phuber2_y_vals)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”»å‡ºè¿™äº›å›å½’æŸå¤±å‡½æ•°</span></span><br><span class="line">x_array = sess.run(x_vals)</span><br><span class="line">plt.plot(x_array, l2_y_out, <span class="string">'b-'</span>, label=<span class="string">'L2 Loss'</span>)</span><br><span class="line">plt.plot(x_array, l1_y_out, <span class="string">'r--'</span>, label=<span class="string">'L1 Loss'</span>)</span><br><span class="line">plt.plot(x_array, phuber1_y_out, <span class="string">'k-.'</span>, label=<span class="string">'P-Huber Loss (0.25)'</span>)</span><br><span class="line">plt.plot(x_array, phuber2_y_out, <span class="string">'g:'</span>, label=<span class="string">'P-Huber Loss (5.0)'</span>)</span><br><span class="line">plt.ylim(<span class="number">-0.2</span>, <span class="number">0.4</span>)</span><br><span class="line">plt.legend(loc=<span class="string">'lower right'</span>, prop=&#123;<span class="string">'size'</span>: <span class="number">11</span>&#125;)</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># ä½ èƒ½ä»åé¢çš„ä¸¤ä¸ªæŸå¤±å‡½æ•°ä¸­å¾—åˆ°ä»€ä¹ˆè§„å¾‹å‘¢ï¼Ÿ</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Various predicted X values</span></span><br><span class="line">x_vals = tf.linspace(<span class="number">-3.</span>, <span class="number">5.</span>, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Target of 1.0</span></span><br><span class="line">target = tf.constant(<span class="number">1.</span>)</span><br><span class="line">targets = tf.fill([<span class="number">500</span>,], <span class="number">1.</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç±»æŸå¤±å‡½æ•°</span></span><br><span class="line"><span class="comment"># Hinge Loss åˆé¡µæŸå¤±å‡½æ•°</span></span><br><span class="line"><span class="comment"># å…·ä½“è¯·è§å…¬å¼äºŒ</span></span><br><span class="line">hinge_y_vals = tf.maximum(<span class="number">0.</span>, <span class="number">1.</span> - tf.multiply(target, x_vals))</span><br><span class="line">hinge_y_out = sess.run(hinge_y_vals)</span><br><span class="line"></span><br><span class="line"><span class="comment"># äº¤å‰ç†µæŸå¤±</span></span><br><span class="line">xentropy_y_vals = - tf.multiply(target, tf.log(x_vals)) - tf.multiply((<span class="number">1.</span> - target), tf.log(<span class="number">1.</span> - x_vals))</span><br><span class="line">xentropy_y_out = sess.run(xentropy_y_vals)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sigmoid äº¤å‰ç†µ</span></span><br><span class="line">x_val_input = tf.expand_dims(x_vals, <span class="number">1</span>)</span><br><span class="line">target_input = tf.expand_dims(targets, <span class="number">1</span>)</span><br><span class="line">xentropy_sigmoid_y_vals = tf.nn.softmax_cross_entropy_with_logits(logits = x_val_input, labels = target_input)</span><br><span class="line">xentropy_sigmoid_y_out = sess.run(xentropy_sigmoid_y_vals)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒé‡softmax äº¤å‰ç†µæŸå¤±å‡½æ•°</span></span><br><span class="line">weight = tf.constant(<span class="number">0.5</span>)</span><br><span class="line">xentropy_weighted_y_vals = tf.nn.weighted_cross_entropy_with_logits(x_vals, targets, weight)</span><br><span class="line">xentropy_weighted_y_out = sess.run(xentropy_weighted_y_vals)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”»å‡ºè¿™äº›æŸå¤±å‡½æ•°</span></span><br><span class="line">x_array = sess.run(x_vals)</span><br><span class="line">plt.plot(x_array, hinge_y_out, <span class="string">'b-'</span>, label=<span class="string">'Hinge Loss'</span>)</span><br><span class="line">plt.plot(x_array, xentropy_y_out, <span class="string">'r--'</span>, label=<span class="string">'Cross Entropy Loss'</span>)</span><br><span class="line">plt.plot(x_array, xentropy_sigmoid_y_out, <span class="string">'k-.'</span>, label=<span class="string">'Cross Entropy Sigmoid Loss'</span>)</span><br><span class="line">plt.plot(x_array, xentropy_weighted_y_out, <span class="string">'g:'</span>, label=<span class="string">'Weighted Cross Entropy Loss (x0.5)'</span>)</span><br><span class="line">plt.ylim(<span class="number">-1.5</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment">#plt.xlim(-1, 3)</span></span><br><span class="line">plt.legend(loc=<span class="string">'lower right'</span>, prop=&#123;<span class="string">'size'</span>: <span class="number">11</span>&#125;)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…·ä½“æŸå¤±å‡½æ•°æ˜¯å¹²å˜›ç”¨çš„ï¼Œé‚£å°±æ˜¯ä¸ºäº†å…·ä½“çš„æ•°æ®é¢„æµ‹ç»™æä¾›ä¸€ä¸ªæœ€ä¼˜åŒ–çš„ç›®æ ‡ï¼Œä¸ºäº†è®©æ¯ä¸€ç±»ä»»åŠ¡æœ‰ä¸€ä¸ªæœ€å°åŒ–ç›®æ ‡è€Œæ„é€ å‡ºæ¥çš„losså‡½æ•°ï¼Œåœ¨æœºå™¨å­¦ä¹ é‡Œé¢æœ€é‡è¦çš„å…¶å®æœ‰ä¸€é¡¹å°±æ˜¯æŸå¤±å‡½æ•°çš„è®¾è®¡ï¼Œè®¾è®¡ä¸€ä¸ªå¥½çš„æŸå¤±å‡½æ•°ï¼Œä¼šè®©æˆ‘ä»¬çš„ç½‘ç»œæ›´åŠ çš„ç¨³å®šï¼Œæ›´åŠ å®¹æ˜“æ”¶æ•›å’Œæ”¶æ•›åˆ°ä¸€ä¸ªç›¸å¯¹æœ€ä¼˜å€¼</span></span><br><span class="line"><span class="comment"># æ²¡æœ‰æŒæ¡è¿™äº›åŸºæœ¬æ¦‚å¿µçš„ï¼Œå¸Œæœ›è‡ªå·±å…ˆæ‰¾ä¸€äº›è¿™æ–¹é¢çš„çŸ¥è¯†æ¥çœ‹ä¸€çœ‹ï¼Œç„¶åå†ç†è§£çš„å†™ä»£ç ï¼Œè¿™æ ·ä¼šäº‹åŠåŠŸå€ã€‚</span></span><br></pre></td></tr></table></figure><blockquote><p>å…¬å¼ä¸€ï¼š</p></blockquote><p><span class="math display">\[L_{\delta}(i) = {\delta}^2 (\sqrt{1 + (a/{\delta})^2} - 1)\]</span></p><blockquote><p>å…¬å¼äºŒï¼š</p></blockquote><p><span class="math display">\[max(0, 1 - (pre - y))\]</span></p><blockquote><p>å…¬å¼ä¸‰ï¼š</p></blockquote><p><span class="math display">\[L = -actual * (log(pre)) - (1- actual)(log(1-pre))\]</span></p><blockquote><p>å…¬å¼å››ï¼š</p></blockquote><p><span class="math display">\[L = -actual * (log(sigmoid(pre))) - (1- actual)(log(1- sigmoid(pre)))\]</span></p><blockquote><p>å…¬å¼äº”ï¼š</p></blockquote><p><span class="math display">\[L = -actual * (log(pre)) * weights - (1-actual)(log(1-pre))\]</span></p><ol start="2" type="1"><li>Back Propagation</li></ol><blockquote><p>è¿™ä¸ªåœ°æ–¹ä¸è¦ç´§å¼ ï¼Œæˆ‘è¿™é‡Œç»™ä½ æ¨èä¸€ä¸ªç½‘ç«™ï¼Œä¸Šé¢æœ‰å¾ˆå¥½ç†è§£è¿™ä¸ªç®—æ³•çš„è§£é‡Šã€‚</p></blockquote><p><a href="https://www.zybuluo.com/hanbingtao/note/476663" target="_blank" rel="noopener">æœºå™¨å­¦ä¹ åŸºç¡€ä»¥åŠåå‘ä¼ æ’­ç®—æ³•ä»‹ç»</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹é¢æ˜¯ä¸€ä¸ªå›å½’çš„ä¾‹å­</span></span><br><span class="line"><span class="comment"># è€æ ·å­ï¼Œæˆ‘ä»¬åˆ›å»ºtensorflowçš„ä¼šè¯ï¼Œä½¿ç”¨é»˜è®¤çš„è®¡ç®—å›¾</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"><span class="comment"># ä¸€ä¸ªå›å½’çš„ä¾‹å­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®</span></span><br><span class="line">x_vals = np.random.normal(<span class="number">1</span>, <span class="number">0.1</span>, <span class="number">100</span>) <span class="comment"># xæ•°æ®</span></span><br><span class="line">y_vals = np.repeat(<span class="number">10.</span>, <span class="number">100</span>) <span class="comment"># y æ•°æ®</span></span><br><span class="line">x_data = tf.placeholder(shape=[<span class="number">1</span>], dtype=tf.float32) <span class="comment"># å ä½ç¬¦</span></span><br><span class="line">y_target = tf.placeholder(shape=[<span class="number">1</span>], dtype=tf.float32) <span class="comment"># labelï¼ˆçœŸå€¼ï¼‰</span></span><br><span class="line"></span><br><span class="line">A = tf.Variable(tf.random_normal(shape=[<span class="number">1</span>]))</span><br><span class="line">my_output = tf.multiply(x_data, A)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨l2 loss</span></span><br><span class="line">loss = tf.square(my_output - y_target)</span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºäº†ä¸€ä¸ªåå‘ä¼ æ’­ä¼˜åŒ–å™¨</span></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.02</span>)</span><br><span class="line">train_step = my_opt.minimize(loss) <span class="comment"># æœ€å°åŒ–loss</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹æˆ‘ä»¬çš„è¿­ä»£è®­ç»ƒ</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    rand_index = np.random.choice(<span class="number">100</span>)</span><br><span class="line">    rand_x = [x_vals[rand_index]]</span><br><span class="line">    rand_y = [y_vals[rand_index]]</span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">25</span>==<span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i+<span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)))</span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(sess.run(loss, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ†ç±»çš„ä¾‹å­</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç±»çš„ä¾‹å­</span></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®</span></span><br><span class="line">x_vals = np.concatenate((np.random.normal(<span class="number">-1</span>, <span class="number">1</span>, <span class="number">50</span>), np.random.normal(<span class="number">3</span>, <span class="number">1</span>, <span class="number">50</span>)))</span><br><span class="line">y_vals = np.concatenate((np.repeat(<span class="number">0.</span>, <span class="number">50</span>), np.repeat(<span class="number">1.</span>, <span class="number">50</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå ä½ç¬¦</span></span><br><span class="line">x_data = tf.placeholder(shape=[<span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">y_target = tf.placeholder(shape=[<span class="number">1</span>], dtype=tf.float32)</span><br><span class="line">A = tf.Variable(tf.random_normal(mean=<span class="number">10</span>, shape=[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">my_output = tf.add(x_data, A)</span><br><span class="line"></span><br><span class="line">my_output_expanded = tf.expand_dims(my_output, <span class="number">0</span>)</span><br><span class="line">y_target_expanded = tf.expand_dims(y_target, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¯ä¸æ˜¯ä½¿ç”¨çš„æ˜¯å¯¹åº”çš„åˆ†ç±»æŸå¤±å‡½æ•°å‘€ sigmoid cross entropy</span></span><br><span class="line">xentropy = tf.nn.sigmoid_cross_entropy_with_logits(logits = my_output_expanded, labels = y_target_expanded)</span><br><span class="line"></span><br><span class="line">my_opt = tf.train.GradientDescentOptimizer(<span class="number">0.05</span>)</span><br><span class="line">train_step = my_opt.minimize(xentropy)</span><br><span class="line"></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line">sess.run(init)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1400</span>):</span><br><span class="line">    rand_index = np.random.choice(<span class="number">100</span>)</span><br><span class="line">    rand_x = [x_vals[rand_index]]</span><br><span class="line">    rand_y = [y_vals[rand_index]]</span><br><span class="line">    </span><br><span class="line">    sess.run(train_step, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)</span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>)%<span class="number">200</span>==<span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Step #'</span> + str(i+<span class="number">1</span>) + <span class="string">' A = '</span> + str(sess.run(A)))</span><br><span class="line">        print(<span class="string">'Loss = '</span> + str(sess.run(xentropy, feed_dict=&#123;x_data: rand_x, y_target: rand_y&#125;)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯• </span></span><br><span class="line">predictions = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(x_vals)):</span><br><span class="line">    x_val = [x_vals[i]]</span><br><span class="line">    prediction = sess.run(tf.round(tf.sigmoid(my_output)), feed_dict=&#123;x_data: x_val&#125;)</span><br><span class="line">    predictions.append(prediction[<span class="number">0</span>])</span><br><span class="line">    </span><br><span class="line">accuracy = sum(x==y <span class="keyword">for</span> x,y <span class="keyword">in</span> zip(predictions, y_vals))/<span class="number">100.</span></span><br><span class="line">print(<span class="string">'Ending Accuracy = '</span> + str(np.round(accuracy, <span class="number">2</span>)))</span><br></pre></td></tr></table></figure><p>o^o,ä»Šå¤©æˆ‘ä»¬å°±è®²åˆ°è¿™é‡Œï¼Œä¸‹èŠ‚æˆ‘ä»¬å†è§ï¼Œæ€»çš„æ¥è¯´ï¼Œå°±æ˜¯åœ¨å›å½’å’Œåˆ†ç±»é—®é¢˜ä¸­ï¼Œè®¾è®¡ç›¸å¯¹åº”çš„losså‡½æ•°ï¼Œç„¶åä½¿ç”¨åå‘ä¼ æ’­ä¼˜åŒ–å™¨èµ·ä¼˜åŒ–lossï¼Œä½¿å¾—lossé€æ¸å‡å°</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-åŸºç¡€2&quot;&gt;TensorFlow
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>asyncio ä¸å®Œå…¨æŒ‡åŒ—ï¼ˆä¸€ï¼‰</title>
    <link href="http://weafteam.github.io/posts/b496f296/"/>
    <id>http://weafteam.github.io/posts/b496f296/</id>
    <published>2018-04-14T19:37:56.000Z</published>
    <updated>2018-08-07T08:56:41.616Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒPython çš„å¹¶å‘ç¼–ç¨‹ä¸»è¦ç”±çº¿ç¨‹ã€è¿›ç¨‹å’Œåç¨‹ä¸‰ä¸ªç»„ä»¶ç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python æ¨¡å— <code>threading</code>ã€<code>multiprocessing</code> å’Œ <code>yield</code> å¥æ³•å»æ“çºµå®ƒä»¬ã€‚åæ¥ï¼Œåˆæœ‰äº†æ›´é«˜å±‚çš„å°è£…ï¼š<code>concurrent.futures</code> å’Œ <code>asyncio</code> æ¨¡å—ã€‚<code>concurrent.futures</code>æ˜¯å¯¹ <code>threading</code> å’Œ <code>multiprocessing</code> çš„å°è£…ï¼Œä¸æ˜¯è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼›<code>asyncio</code> æ˜¯ Python ä¸­çš„é‡å¤§å˜åŒ–ï¼Œä¹Ÿä»£è¡¨äº†æœªæ¥çš„å‘å±•è¶‹åŠ¿ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æ‰“ç®—è®²è®² <code>asyncio</code>ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-asyncio">ä»€ä¹ˆæ˜¯ asyncio</h2><p><code>asyncio</code> ä¸€å¼€å§‹æ˜¯ Python çš„ä½œè€… Guido van Rossum åœ¨ Python ä»“åº“ä¹‹å¤–å¼€å‘çš„ï¼Œä»£å·ä¸ºâ€œ<a href="https://code.google.com/p/tulip/" target="_blank" rel="noopener">Tulip</a>â€ï¼Œåœ¨ Python 3.4 æ—¶åŠ å…¥æ ‡å‡†åº“ã€‚<code>asyncio</code>æ¨¡å—ä½¿ç”¨äº‹ä»¶å¾ªç¯é©±åŠ¨çš„åç¨‹å®ç°å¹¶å‘ï¼Œæä¾›äº†åŸºäºåç¨‹æ¥æ„å»ºå¹¶å‘ç¨‹åºçš„å·¥å…·ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œ<code>threading</code> æ¨¡å—é€šè¿‡åº”ç”¨çº§çº¿ç¨‹å®ç°å¹¶å‘ï¼›<code>multiprocessing</code> æ¨¡å—ä½¿ç”¨ç³»ç»Ÿçº§è¿›ç¨‹å®ç°å¹¶å‘ï¼›è€Œ <code>asyncio</code>ä½¿ç”¨å•çº¿ç¨‹ã€å•è¿›ç¨‹ï¼Œå…¶ä¸­åº”ç”¨ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†åœ¨äº‹ä»¶å¾ªç¯çš„é©±åŠ¨ä¸‹è¿›è¡Œåä½œï¼Œåœ¨æœ€ä½³æ—¶é—´æ˜¾å¼åˆ‡æ¢ä»»åŠ¡ã€‚<code>asyncio</code> ä¸ä½†æ”¯æŒé€šå¸¸æƒ…å†µä¸‹å‡ºç°é˜»å¡å‹ IO æ—¶çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿˜æ”¯æŒè°ƒåº¦ï¼Œæ¥è®©ä»£ç åœ¨æŒ‡å®šçš„å°†æ¥æ—¶é—´è¿è¡Œï¼Œå¹¶ä¸”è¿˜å¯ä»¥è®©ä¸€ä¸ªåç¨‹ç­‰å¾…å¦ä¸€ä¸ªåç¨‹å®Œæˆã€‚</p><h2 id="asyncio-ä¸­çš„å‡ ä¸ªæ¦‚å¿µ">asyncio ä¸­çš„å‡ ä¸ªæ¦‚å¿µ</h2><p>äº‹ä»¶å¾ªç¯ï¼š<code>asyncio</code> æä¾›çš„æ¡†æ¶ä»¥äº‹ä»¶å¾ªç¯ä¸ºä¸­å¿ƒï¼Œå®ƒæ˜¯è´Ÿè´£æœ‰æ•ˆå¤„ç† I / O äº‹ä»¶ã€ç³»ç»Ÿäº‹ä»¶å’Œåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡åˆ‡æ¢çš„ç¬¬ä¸€ç±»å¯¹è±¡ã€‚Python æä¾›äº†å‡ ä¸ªå¾ªç¯å®ç°ï¼Œé€šå¸¸ä¼šè‡ªåŠ¨é€‰æ‹©åˆç†çš„é»˜è®¤å€¼ï¼Œä½†ä¹Ÿå¯ä»¥é€‰æ‹©ç‰¹å®šçš„äº‹ä»¶å¾ªç¯å®ç°ã€‚åŒæ ·ä¹Ÿæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„å®ç°ï¼Œä¾‹å¦‚ <a href="https://github.com/MagicStack/uvloop" target="_blank" rel="noopener">uvloop</a>ã€‚åº”ç”¨ç¨‹åºå°†è¦æ‰§è¡Œçš„ä»£ç æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œä»£è¡¨å…è®¸äº‹ä»¶å¾ªç¯åœ¨å¿…è¦æ—¶å¯¹ä»£ç è¿›è¡Œè°ƒç”¨ã€‚å½“è°ƒç”¨ç»“æŸï¼Œæˆ–æ— æ³•ç»§ç»­æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè®©å‡ºæ§åˆ¶æƒï¼Œäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯ã€‚</p><p>åç¨‹ï¼ˆcoroutine ï¼‰ï¼šå°†æ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯çš„æœºåˆ¶æ¥è‡ªäº Python çš„åç¨‹ï¼Œè¿™æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œå®ƒå°†æ§åˆ¶æƒäº¤è¿˜ç»™è°ƒç”¨æ–¹è€Œä¸ä¼šä¸¢å¤±æœ¬èº«çŠ¶æ€ã€‚åç¨‹ç±»ä¼¼äºç”Ÿæˆå™¨å‡½æ•°ï¼Œäº‹å®ä¸Šå¯ä»¥åœ¨ Python 3.5 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ç”¨ç”Ÿæˆå™¨å®ç°åç¨‹ã€‚<code>asyncio</code> è¿˜ä¸º <code>Protocols</code> å’Œ <code>Transports</code> æä¾›äº†åŸºäºç±»çš„æŠ½è±¡å±‚ï¼Œä½¿ç”¨å›è°ƒçš„ä»£ç é£æ ¼ã€‚åœ¨åŸºäºç±»çš„æ¨¡å‹å’Œåç¨‹æ¨¡å‹ä¸­ï¼Œé€šè¿‡é‡æ–°è¿›å…¥äº‹ä»¶å¾ªç¯æ¥æ˜¾å¼æ›´æ”¹ä¸Šä¸‹æ–‡å°†å–ä»£ Python çº¿ç¨‹å®ç°ä¸­çš„éšå¼ä¸Šä¸‹æ–‡æ›´æ”¹ã€‚</p><p><code>future</code>ï¼š<code>future</code>æ˜¯ä¸€ç§å¯¹è±¡ï¼Œè¡¨ç¤ºå¾…å®Œæˆçš„æ“ä½œçš„ç»“æœã€‚äº‹ä»¶å¾ªç¯å¯ä»¥ç›‘è§† <code>future</code> å¯¹è±¡ç›´åˆ°å®ƒå®Œæˆï¼Œä»è€Œå…è®¸åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ç­‰å¾…å¦ä¸€éƒ¨åˆ†å®ŒæˆæŸäº›å·¥ä½œã€‚é™¤äº† <code>future</code>ï¼Œ<code>asyncio</code> è¿˜åŒ…æ‹¬å…¶ä»–å¹¶å‘åŸè¯­ï¼Œä¾‹å¦‚é”å’Œä¿¡å·é‡ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è‡ªè¡Œåˆ›å»º <code>future</code>ï¼Œåªèƒ½é€šè¿‡å¹¶å‘æ¡†æ¶ï¼ˆä¾‹å¦‚ <code>asyncio</code>ï¼‰æ¥å®ä¾‹åŒ–ã€‚åŸå› æ˜¯ <code>future</code>ä»£è¡¨ç»ˆå°†å‘ç”Ÿçš„äº‹æƒ…ï¼Œè€ŒæŸä»¶äº‹çš„å‘ç”Ÿï¼Œæ˜¯é€šè¿‡å®‰æ’å¥½è¿™ä»¶äº‹çš„æ‰§è¡Œæ—¶é—´æ¥ç¡®å®šçš„ã€‚åªæœ‰å½“æˆ‘ä»¬æŠŠæŸä»¶äº‹äº¤ç»™äº‹ä»¶å¾ªç¯å¤„ç†æ—¶ï¼Œäº‹ä»¶å¾ªç¯æ‰ä¼šç»™è¿™ä»¶äº‹æ’æœŸï¼Œä»è€Œåˆ›å»ºä¸€ä¸ª <code>future</code>å¯¹è±¡ã€‚</p><p>ä»»åŠ¡ï¼ˆTaskï¼‰ï¼šä»»åŠ¡æ˜¯ <code>future</code>çš„å­ç±»ï¼Œå®ƒåŒ…è£…å¹¶ç®¡ç†åç¨‹çš„æ‰§è¡Œã€‚ä»»åŠ¡å¯ä»¥é€šè¿‡äº‹ä»¶å¾ªç¯è¿›è¡Œè°ƒåº¦ï¼Œä»¥ä¾¿åœ¨å®ƒä»¬éœ€è¦çš„èµ„æºå¯ç”¨æ—¶è¿è¡Œï¼Œå¹¶ç”Ÿæˆå¯ç”±å…¶ä»–åç¨‹ä½¿ç”¨çš„ç»“æœã€‚</p><h2 id="ä½¿ç”¨åç¨‹å¤„ç†å¤šä»»åŠ¡åä½œ">ä½¿ç”¨åç¨‹å¤„ç†å¤šä»»åŠ¡åä½œ</h2><p>åç¨‹æ˜¯ä¸ºå¹¶å‘è®¾è®¡çš„è¯­è¨€æ¦‚å¿µã€‚åç¨‹å‡½æ•°åœ¨è°ƒç”¨æ—¶åˆ›å»ºåç¨‹å¯¹è±¡ï¼Œç„¶åè°ƒç”¨æ–¹å¯ä»¥ä½¿ç”¨åç¨‹çš„ <code>send ()</code> æ–¹æ³•è¿è¡Œå‡½æ•°ã€‚åç¨‹å¯ä»¥åœ¨å¦ä¸€ä¸ªåç¨‹ä¸­ä½¿ç”¨ <code>await</code>å…³é”®å­—æš‚åœæ‰§è¡Œã€‚å½“å®ƒè¢«æš‚åœæ—¶ï¼Œåç¨‹çš„çŠ¶æ€è¢«ä¿æŒï¼Œå…è®¸å®ƒåœ¨ä¸‹æ¬¡è¢«å”¤é†’æ—¶æ¢å¤åˆ°å®ƒåœæ­¢çš„ä½ç½®ã€‚</p><h3 id="å¯åŠ¨åç¨‹">å¯åŠ¨åç¨‹</h3><p>å¯åŠ¨ä¸€ä¸ªåç¨‹æœ€ç®€å•çš„æ–¹å¼æ˜¯å°†ä¸€ä¸ªåç¨‹ä¼ é€’ç»™äº‹ä»¶å¾ªç¯çš„ <code>run_until_complete()</code> æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coroutine</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in coroutine'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">'starting coroutine'</span>)</span><br><span class="line">    print(<span class="string">'entering event loop'</span>)</span><br><span class="line">    event_loop.run_until_complete(coroutine())</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    print(<span class="string">'closing event loop'</span>)</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">starting coroutine</span><br><span class="line">entering event loop</span><br><span class="line">in coroutine</span><br><span class="line">closing event loop</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ <code>asyncio.get_event_loop()</code> è·å–äº†ä¸€ä¸ªé»˜è®¤äº‹ä»¶å¾ªç¯çš„å¼•ç”¨ã€‚<code>run_until_complete()</code> æ–¹æ³•æ¥å—ä¸€ä¸ªåç¨‹å¯¹è±¡ï¼Œå¹¶ç”¨å®ƒå¯åŠ¨äº‹ä»¶å¾ªç¯ï¼Œç„¶ååœ¨åç¨‹é€šè¿‡ <code>return</code> ç»“æŸæ—¶åœæ­¢äº‹ä»¶å¾ªç¯ã€‚</p><h3 id="åç¨‹çš„è¿”å›å€¼">åç¨‹çš„è¿”å›å€¼</h3><p>åç¨‹çš„è¿”å›å€¼è¿”å›ç»™å¯åŠ¨å¹¶ç­‰å¾…å®ƒçš„ç¨‹åºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coroutine</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in coroutine'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'result'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    return_value = event_loop.run_until_complete(coroutine())</span><br><span class="line">    print(<span class="string">f'it returned: <span class="subst">&#123;return_value!r&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">in coroutine</span><br><span class="line">it returned: 'result'</span><br></pre></td></tr></table></figure><h3 id="é“¾å¼è°ƒç”¨åç¨‹">é“¾å¼è°ƒç”¨åç¨‹</h3><p>ä¸€ä¸ªåç¨‹å¯ä»¥å¯åŠ¨å¦ä¸€ä¸ªåç¨‹å¹¶ç­‰å¾…å®ƒè¿”å›ç»“æœã€‚ä¸‹é¢çš„ç¤ºä¾‹åŒ…å«ä¸¤ä¸ªé˜¶æ®µï¼Œå®ƒä»¬å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†å¯ä»¥ä¸å¦å¤–çš„æ“ä½œåŒæ—¶è¿è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">phase1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in phase1'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'result1'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">phase2</span><span class="params">(arg)</span>:</span></span><br><span class="line">    print(<span class="string">'in phase2'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f'result2 derived from <span class="subst">&#123;arg&#125;</span>'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in main'</span>)</span><br><span class="line">    print(<span class="string">'waiting for result1'</span>)</span><br><span class="line">    result1 = <span class="keyword">await</span> phase1()</span><br><span class="line">    print(<span class="string">'waiting for result2'</span>)</span><br><span class="line">    result2 = <span class="keyword">await</span> phase2(result1)</span><br><span class="line">    <span class="keyword">return</span> (result1, result2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    return_value = event_loop.run_until_complete(main())</span><br><span class="line">    print(<span class="string">f'return value: <span class="subst">&#123;return_value!r&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">in main</span><br><span class="line">waiting for result1</span><br><span class="line">in phase1</span><br><span class="line">waiting for result2</span><br><span class="line">in phase2</span><br><span class="line">return value: ('result1', 'result2 derived from result1')</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä½¿ç”¨äº† <code>await</code> å…³é”®å­—ï¼Œå¹¶æ²¡æœ‰å°†æ–°çš„åç¨‹æ·»åŠ åˆ°äº‹ä»¶å¾ªç¯ä¸­ã€‚å› ä¸ºæ§åˆ¶æµå·²ç»åœ¨ç”±äº‹ä»¶å¾ªç¯ç®¡ç†çš„åç¨‹å†…éƒ¨ï¼Œæ‰€ä»¥ä¸éœ€è¦é€šçŸ¥äº‹ä»¶å¾ªç¯ç®¡ç†æ–°çš„åç¨‹ã€‚</p><h3 id="ä½¿ç”¨ç”Ÿæˆå™¨è¯­æ³•">ä½¿ç”¨ç”Ÿæˆå™¨è¯­æ³•</h3><p><code>async</code> å’Œ <code>await</code> å…³é”®å­—å‡ºç°äº Python 3.5ï¼Œå¯¹äº Python 3.5 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ <code>asyncio.coroutine</code> è£…é¥°å™¨å’Œ <code>yield from</code> æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">phase1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in phase1'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'result1'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">phase2</span><span class="params">(arg)</span>:</span></span><br><span class="line">    print(<span class="string">'in phase2'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f'result2 derived from <span class="subst">&#123;arg&#125;</span>'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'in main'</span>)</span><br><span class="line">    print(<span class="string">'waiting for result1'</span>)</span><br><span class="line">    result1 = <span class="keyword">yield</span> <span class="keyword">from</span> phase1()</span><br><span class="line">    print(<span class="string">'waiting for result2'</span>)</span><br><span class="line">    result2 = <span class="keyword">yield</span> <span class="keyword">from</span> phase2(result1)</span><br><span class="line">    <span class="keyword">return</span> (result1, result2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    return_value = event_loop.run_until_complete(main())</span><br><span class="line">    print(<span class="string">f'return value: <span class="subst">&#123;return_value!r&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://pymotw.com/3/asyncio/concepts.html" target="_blank" rel="noopener">Asynchronous Concurrency Concepts</a></li><li><a href="https://pymotw.com/3/asyncio/coroutines.html" target="_blank" rel="noopener">Cooperative Multitasking with Coroutines</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼ŒPython çš„å¹¶å‘ç¼–ç¨‹ä¸»è¦ç”±çº¿ç¨‹ã€è¿›ç¨‹å’Œåç¨‹ä¸‰ä¸ªç»„ä»¶ç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python æ¨¡å— &lt;code&gt;threading&lt;/code&gt;ã€&lt;code&gt;multiprocessing&lt;/code&gt; å’Œ
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Vigenereå¯†ç åŠ å¯†è§£å¯†</title>
    <link href="http://weafteam.github.io/posts/8b092926/"/>
    <id>http://weafteam.github.io/posts/8b092926/</id>
    <published>2018-04-14T14:11:24.000Z</published>
    <updated>2018-05-29T01:27:49.829Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©æ¢ä¸ªå£å‘³ï¼Œå†™ç‚¹åŸæ¥ä»æ²¡æ¥è§¦è¿‡çš„ä¸œè¥¿â€“å¯†ç å­¦ã€‚å‰ä¸€é˜µä¿¡æ¯å®‰å…¨è¯¾ä¸Šç•™äº†ä¸€ä¸ªä½œä¸šï¼Œå®ç°VigenereåŠ å¯†è§£å¯†ï¼Œå€Ÿç€æœºä¼šå†™ç¯‡åšå®¢ã€‚è¿™æ¬¡åšå®¢ç”±äºæ¯”è¾ƒä»“ä¿ƒï¼Œè¿™æ¬¡åªå†™åŠ å¯†è§£å¯†ç³»ç»Ÿçš„å®ç°ï¼Œä¸æ¶‰åŠå”¯å¯†æ–‡ç ´è§£ã€‚</p></blockquote><hr><h1 id="ä»»åŠ¡è¦æ±‚">ä»»åŠ¡è¦æ±‚ï¼š</h1><ul><li><pre><code> a.ç¼–ç¨‹å®ç°VigenereåŠ å¯†/è§£å¯†ç³»ç»Ÿï¼Œå¹¶åˆ†æå’Œè¯„ä¼°è¯¥ç®—æ³•çš„å®‰å…¨æ€§ã€‚</code></pre></li><li><pre><code> b.ç¼–ç¨‹å®ç°å”¯å¯†æ–‡ç ´è¯‘ç³»ç»Ÿï¼Œèƒ½å¤Ÿç ´è¯‘å¯†é’¥ä¸º2åˆ°4ä¸ªå­—ç¬¦çš„Vigenereå¯†æ–‡ï¼Œå¹¶åˆ†æå¦‚ä½•åŠ å¿«ç ´è¯‘é€Ÿåº¦ã€‚</code></pre></li><li>æ—¶é—´è¦æ±‚ï¼š å¸ƒç½®ä»»åŠ¡åï¼Œåœ¨3å‘¨ä¹‹å†…å®Œæˆã€‚</li><li>æäº¤ç»“æœï¼šå·²è®¾è®¡å¹¶æµ‹è¯•å¥½çš„ç¨‹åºï¼ŒåŒ…æ‹¬æºç ã€å¯æ‰§è¡Œç¨‹åºã€æµ‹è¯•æ•°æ®é›†ã€å®éªŒæŠ¥å‘Šã€‚</li></ul><h1 id="åŸç†ä»‹ç»">åŸç†ä»‹ç»ï¼š</h1><p>å…ˆæ™®åŠä¸‹Caesarå¯†ç ï¼Œä½œä¸ºå•å¯†ç ç®€å•æ›¿æ¢å¯†ç å±Šçš„æ‰›æŠŠå­ï¼Œä»–æœ‰ç€ä¸å¯åŠ¨æ‘‡çš„åœ°ä½ï¼Œå®ƒçš„åŸç†å¾ˆç®€å•ï¼Œå¯¹äºéœ€è¦åŠ å¯†çš„æ¯ä¸ªå­—ç¬¦éƒ½è¿›è¡Œç›¸åŒå¤§å°çš„å¹³ç§»ã€‚å…ˆç»™å‡ºCaesarå¯†ç åŠ å¯†çš„å­—ç¬¦å¯¹åº”è¡¨ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://i.loli.net/2018/04/15/5ad32ed02524c.png" alt="Caesar.png"></p><p>ä¸¾ä¸ªä¾‹å­å§ï¼šæ˜æ–‡ä¸ºChinaï¼Œå®ƒå¯¹åº”çš„æ•°å­—åº”ä¸º2 7 8 13 0.æ¯”å¦‚æˆ‘ä»¬å¹³ç§»è·ç¦»ä¸º3ï¼Œé‚£ä¹ˆåŠ å¯†ä¹‹åçš„å¯†æ–‡åº”è¯¥ä¸ºFKLQDï¼Œç®€å•åˆ°ç‚¸ã€‚</p><p>æˆ‘ä»¬å…ˆä¸è°ˆä¸Šè¿°åŠ å¯†æ–¹æ³•çš„ç¼ºç‚¹ï¼Œè¿™äº›æˆ‘ä»¬æ”¾åˆ°å”¯å¯†æ–‡è§£å¯†ä¸­èŠã€‚æœ‰äº†ä»¥ä¸Šçš„åŸºç¡€ä¹‹åæˆ‘ä»¬å†èŠVigenereåŠ å¯†ä»¥åŠè§£å¯†ï¼Œå®ƒæ˜¯ä½¿ç”¨ä¸€ç³»åˆ—å‡¯æ’’å¯†ç ç»„æˆå¯†ç å­—æ¯è¡¨çš„åŠ å¯†ç®—æ³•ï¼Œå±äºå¤šè¡¨å¯†ç çš„ä¸€ç§ç®€å•å½¢å¼ã€‚åŒæ ·å…ˆç»™å‡ºå®ƒçš„å¯†ç åŠ å¯†å­—ç¬¦å¯¹åº”è¡¨ï¼ˆè‡ªå·±ç”»å¤ªéº»çƒ¦äº†ï¼Œæˆ‘å°±åœ¨ç™¾ç§‘ä¸Šæ‰’äº†ä¸€ä¸ªå›¾ï¼Œæºœã€‚ã€‚ï¼‰ï¼š</p><p><img src="https://i.loli.net/2018/04/15/5ad33112af0e9.png" alt="222.png"></p><p>ä¸Šå›¾ä¸­çš„ç»´å‰å°¼äºšè¡¨çš„ç¬¬ä¸€åˆ—ä»£è¡¨ç€å¯†é’¥å­—æ¯ï¼ˆè¿™æ˜¯æœ‰åˆ«äºCaesarå¯†ç çš„åœ°æ–¹ï¼‰ï¼Œç¬¬ä¸€è¡Œä»£è¡¨ç€æ˜æ–‡å­—æ¯ï¼Œè¡Œåˆ—åˆ†åˆ«ä½¿ç”¨å½“å‰éœ€è¦åŠ å¯†å­—ç¬¦å’Œå½“å‰çš„å¯†é’¥å­—ç¬¦ç¡®å®šå½“å‰æ˜æ–‡å­—ç¬¦å¯¹åº”ç€çš„å¯†æ–‡å­—ç¬¦ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç»™å‡ºçš„å¯†é’¥æ˜¯çŸ­äºæˆ‘ä»¬çš„æ˜æ–‡é•¿åº¦çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åšVigenereåŠ å¯†çš„æ—¶å€™ç¬¬ä¸€æ­¥åšçš„å°±æ˜¯å¯¹ç…§æ˜æ–‡é•¿åº¦ï¼Œè¡¥é½å¯†é’¥å­—ä¸²ã€‚</p><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œä¸¾ä¸ªä¾‹å­è¯´ä¸‹å§ï¼š</p><ul><li><p>ä¾‹å¦‚æˆ‘ä»¬çš„æ˜æ–‡å­—ä¸²ä¸ºï¼šdata security</p></li><li><p>å¯†é’¥ï¼šbest</p></li></ul><p>æŒ‰ç…§ä¸Šè¿°çš„è§„åˆ™ï¼Œç¬¬bè¡Œï¼Œç¬¬dåˆ—ï¼Œå¯¹åº”çš„å­—ç¬¦ä¸ºEï¼Œâ€¦.. åŠ å¯†ä¹‹åçš„å¯†æ–‡åº”ä¸ºï¼šEELTTIUNSMLRï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ã€‚</p><h1 id="å®ç°">å®ç°</h1><h3 id="ç¬¬ä¸€æ­¥ä½¿å¾—å¯†é’¥å­—ç¬¦ä¸²é•¿åº¦ä¸æ˜æ–‡é•¿åº¦ç›¸åŒ">ç¬¬ä¸€æ­¥ï¼šä½¿å¾—å¯†é’¥å­—ç¬¦ä¸²é•¿åº¦ä¸æ˜æ–‡é•¿åº¦ç›¸åŒ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">dealKey</span><span class="params">(String str,String Key)</span></span>&#123;   </span><br><span class="line">        Key=Key.toUpperCase();<span class="comment">// å°†å¯†é’¥è½¬æ¢æˆå¤§å†™</span></span><br><span class="line">        Key=Key.replaceAll(<span class="string">"[^A-Z]"</span>, <span class="string">""</span>);<span class="comment">//å»é™¤æ‰€æœ‰éå­—æ¯çš„å­—ç¬¦  </span></span><br><span class="line"></span><br><span class="line">StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder(Key);</span><br><span class="line">        String newKey=<span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(sstringBuilder.length()!=str.length())&#123; </span><br><span class="line">            <span class="comment">//å¦‚æœå¯†é’¥é•¿åº¦ä¸strä¸åŒï¼Œåˆ™éœ€è¦ç”Ÿæˆå¯†é’¥å­—ç¬¦ä¸²</span></span><br><span class="line">            <span class="keyword">if</span>(stringBuilder.length()&lt;str.length())&#123;</span><br><span class="line">                <span class="comment">//å¦‚æœå¯†é’¥é•¿åº¦æ¯”strçŸ­ï¼Œåˆ™ä»¥ä¸æ–­é‡å¤å¯†é’¥çš„æ–¹å¼ç”Ÿæˆå¯†é’¥å­—ç¬¦ä¸²</span></span><br><span class="line">                <span class="keyword">while</span>(stringBuilder.length()&lt;str.length())&#123;</span><br><span class="line">                    stringBuilder.append(Key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ­¤æ—¶ï¼Œå¯†é’¥å­—ç¬¦ä¸²çš„é•¿åº¦å¤§äºæˆ–ç­‰äºstré•¿åº¦</span></span><br><span class="line">            <span class="comment">//å°†å¯†é’¥å­—ç¬¦ä¸²æˆªå–ä¸ºä¸strç­‰é•¿çš„å­—ç¬¦ä¸²</span></span><br><span class="line">            newKey=stringBuilder.substring(<span class="number">0</span>, str.length());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newKey;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬äºŒæ­¥åŠ å¯†">ç¬¬äºŒæ­¥ï¼šåŠ å¯†</h3><p>å…¶å®æˆ‘ä»¬ä¸ç”¨å°†ä¸Šè¿°çš„Vigenereå¯†ç è¡¨åˆ—å‡ºæ¥ï¼Œä¸€æ˜¯åˆ—å‡ºæ¥è´¹æ—¶è´¹åŠ›è´¹ç©ºé—´ï¼ŒäºŒæ˜¯ä¸€ä¸ªç®€å•çš„å–ä½™æ“ä½œå°±èƒ½è§£å†³è¿™ä¸ªäº‹æƒ…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String PwTable = <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">Encryption</span><span class="params">(String P,String K)</span></span>&#123;</span><br><span class="line">        P = P.toUpperCase();<span class="comment">// å°†æ˜æ–‡è½¬æ¢æˆå¤§å†™</span></span><br><span class="line">        P = P.replaceAll(<span class="string">"[^A-Z]"</span>, <span class="string">""</span>);<span class="comment">//å»é™¤æ‰€æœ‰éå­—æ¯çš„å­—ç¬¦   </span></span><br><span class="line">        K = dealKey(P,K);</span><br><span class="line">        <span class="keyword">int</span> len = K.length();</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; len;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> row=PwTable.indexOf(K.charAt(i));<span class="comment">//è¡Œå·</span></span><br><span class="line">            <span class="keyword">int</span> col=PwTable.indexOf(P.charAt(i));<span class="comment">//åˆ—å·</span></span><br><span class="line">            <span class="keyword">int</span> index = (row+col)%<span class="number">26</span>;</span><br><span class="line">            stringBuilder.append(PwTable.charAt(index));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();       </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸‰æ­¥è§£å¯†">ç¬¬ä¸‰æ­¥ï¼šè§£å¯†</h3><p>è¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ï¼Œæˆ‘ä»¬å–å¯†é’¥æ‰€åœ¨è¡Œä¸ºè§£å¯†çš„è¡Œå·ï¼Œå¯†æ–‡æ‰€åœ¨åˆ—ä½œä¸ºæˆ‘ä»¬çš„åˆ—å·ï¼Œæˆ‘ä»¬éœ€è¦åˆ†ä¸¤ç§æƒ…å†µè€ƒè™‘ï¼š</p><p>é¦–å…ˆè¯´ä¸€ä¸‹ç¬¬ä¸€ç§æƒ…å†µï¼Œå°†ä¸Šè¿°çš„å¯†ç è¡¨ä»ä¸»å¯¹è§’çº¿åˆ†å¼€ï¼Œä¸€æ˜¯å¯†æ–‡åœ¨æˆ‘ä»¬çš„å¯†ç è¡¨çš„å³ä¸Šéƒ¨ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåŠ å¯†è¿‡ç¨‹çš„é€†è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ­¤æ—¶çš„å¯†æ–‡å­—ç¬¦åœ¨å¯†ç è¡¨ä¸­çš„ä½ç½®è‚¯å®šæ˜¯ä¸æ¯”å…¶å¯¹åº”çš„æ˜æ–‡é åçš„ï¼ˆç†è§£è¿™å¥è¯ï¼Œè¿™ç§æƒ…å†µå…¶å®ä¹Ÿå°±æ˜ç™½äº†ï¼Œå†ç®€å•ç‚¹è®²å°±æ˜¯PwTable.indexof(å¯†æ–‡)&gt;PwTable.indexof(å¯¹åº”çš„æ˜æ–‡)ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬åªè¦è®©åˆ—å·å‡å»è¡Œå·ï¼Œç„¶åå°†ç»“æœåšindexofæ“ä½œå°±èƒ½å¾—åˆ°ç›¸åº”çš„æ˜æ–‡ã€‚</p><p>å¦‚æœä½ ç†è§£äº†ç¬¬ä¸€ç§æƒ…å†µï¼Œç¬¬äºŒç§æƒ…å†µä¹Ÿå°±å¥½ç†è§£äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„å¯†æ–‡å­—ç¬¦åœ¨æˆ‘ä»¬çš„å¯†ç è¡¨ä¸­çš„ä½ç½®è‚¯å®šæ˜¯ä¸æ¯”å…¶å¯¹åº”çš„æ˜æ–‡çš„ä½ç½®é å‰çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†åˆ—å·åŠ ä¸€åœˆå­—ç¬¦è¡¨å†å»å‡è¡Œå·ã€‚</p><p>ç†è§£ä¹‹åä¸‹é¢çš„è¿™äº›ä»£ç åº”è¯¥å°±ä¸éš¾ç†è§£äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">Decryption</span><span class="params">(String C,String K)</span></span>&#123;</span><br><span class="line">        C=C.toUpperCase();<span class="comment">// å°†å¯†æ–‡è½¬æ¢æˆå¤§å†™</span></span><br><span class="line">        C=C.replaceAll(<span class="string">"[^A-Z]"</span>, <span class="string">""</span>);<span class="comment">//å»é™¤æ‰€æœ‰éå­—æ¯çš„å­—ç¬¦   </span></span><br><span class="line">        K=dealKey(C,K);</span><br><span class="line">        <span class="keyword">int</span> len = K.length();</span><br><span class="line">        StringBuilder stringBuilder=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> row = PwTable.indexOf(K.charAt(i));<span class="comment">//è¡Œå·</span></span><br><span class="line">            <span class="keyword">int</span> col = PwTable.indexOf(C.charAt(i));<span class="comment">//åˆ—å·</span></span><br><span class="line">            <span class="keyword">int</span> index;</span><br><span class="line">            <span class="keyword">if</span>(row&gt;col)&#123;</span><br><span class="line">                index=col+<span class="number">26</span>-row;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                index=col-row;</span><br><span class="line">            &#125;</span><br><span class="line">            stringBuilder.append(PwTable.charAt(index));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();     </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯æœ¬ç¯‡åšå®¢çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ„Ÿè°¢é©»è¶³~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;ä»Šå¤©æ¢ä¸ªå£å‘³ï¼Œå†™ç‚¹åŸæ¥ä»æ²¡æ¥è§¦è¿‡çš„ä¸œè¥¿â€“å¯†ç å­¦ã€‚å‰ä¸€é˜µä¿¡æ¯å®‰å…¨è¯¾ä¸Šç•™äº†ä¸€ä¸ªä½œä¸šï¼Œå®ç°VigenereåŠ å¯†è§£å¯†ï¼Œå€Ÿç€æœºä¼šå†™ç¯‡åšå®¢ã€‚è¿™æ¬¡åšå®¢ç”±äºæ¯”è¾ƒä»“ä¿ƒï¼Œè¿™æ¬¡åªå†™åŠ å¯†è§£å¯†ç³»ç»Ÿçš„å®ç°ï¼Œä¸æ¶‰åŠå”¯å¯†æ–‡ç ´è§£ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
        
      
    
    </summary>
    
      <category term="å¯†ç å­¦" scheme="http://weafteam.github.io/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/"/>
    
    
      <category term="å¯†ç å­¦" scheme="http://weafteam.github.io/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç†è§£ä¸˜å¥‡è®¡æ•°</title>
    <link href="http://weafteam.github.io/posts/cd89a3b2/"/>
    <id>http://weafteam.github.io/posts/cd89a3b2/</id>
    <published>2018-04-07T19:39:29.000Z</published>
    <updated>2018-08-07T08:56:41.615Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¸æƒ³å†™ Python äº†ï¼Œè¿™æ¬¡æ¢ä¸ªä¸»é¢˜ï¼šä¸˜å¥‡è®¡æ•°ï¼Œåˆå lambda æ¼”ç®—çš„è‡ªç„¶æ•°è¡¨ç¤ºæ³•ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-lambda-æ¼”ç®—">ä»€ä¹ˆæ˜¯ lambda æ¼”ç®—</h2><p>lambda æ¼”ç®—ï¼ˆä¹Ÿç§°ä¸º Î» æ¼”ç®—ï¼‰æ˜¯æ•°å­¦é€»è¾‘ä¸­çš„ä¸€ç§å½¢å¼ç³»ç»Ÿï¼Œå®ƒåŸºäºå‡½æ•°æŠ½è±¡å’Œåº”ç”¨ï¼Œä½¿ç”¨å˜é‡ç»‘å®šå’Œæ›¿æ¢æ¥è¡¨ç¤ºè®¡ç®—ã€‚</p><p>æ²¡é”™ï¼Œä¸Šé¢è¿™å¥è¯æ¥è‡ªç»´åŸºç™¾ç§‘ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€å¥æ­£ç¡®çš„åºŸè¯ï¼Œçœ‹å®Œäº†ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ˜¯ lambda æ¼”ç®—ã€‚ä¸è¿‡è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹ä¸åœ¨ lambda æ¼”ç®—ä¸Šï¼Œå¸Œæœ›ä½ å·²ç»äº†è§£äº†ä¸€äº›å…³äº lambda æ¼”ç®—çš„çŸ¥è¯†ã€‚å¦‚æœæœ‰æœºä¼šä¸‹ä¸€ç¯‡å†å±•å¼€è¯´ï¼ˆå¯èƒ½</p><h2 id="ä»€ä¹ˆæ˜¯è‡ªç„¶æ•°">ä»€ä¹ˆæ˜¯è‡ªç„¶æ•°</h2><p>åœ¨è®¡ç®—æœºç§‘å­¦å’Œé›†åˆè®ºä¸­ï¼Œæˆ‘ä»¬æŠŠéè´Ÿæ•´æ•° <span class="math inline">\((0, 1, 2, 3, 4...)\)</span> ç§°ä¸ºè‡ªç„¶æ•°ã€‚çš®äºšè¯ºç»™å‡ºäº†è‡ªç„¶æ•°çš„ä¸¥æ ¼å®šä¹‰ï¼š</p><ol type="1"><li><span class="math inline">\(0\)</span> æ˜¯è‡ªç„¶æ•°ï¼›</li><li>å¦‚æœ <span class="math inline">\(n\)</span> æ˜¯è‡ªç„¶æ•°ï¼Œé‚£ä¹ˆ <span class="math inline">\(n+1\)</span> ä¹Ÿæ˜¯è‡ªç„¶æ•°ï¼ˆ<span class="math inline">\(n+1\)</span> ä»£è¡¨ <span class="math inline">\(n\)</span> çš„åç»§ï¼‰ï¼›</li><li><span class="math inline">\(0\)</span> ä¸æ˜¯ä»»ä½•ä¸€ä¸ªæ•°çš„åç»§ï¼›</li><li>å¦‚æœ <span class="math inline">\(m\)</span> ä¸ <span class="math inline">\(n\)</span> éƒ½æ˜¯è‡ªç„¶æ•°ä¸” <span class="math inline">\(m\neq n\)</span>ï¼Œé‚£ä¹ˆ <span class="math inline">\(n+1 \neq m+1\)</span>ï¼›</li><li>è®¾ <span class="math inline">\(P(n)\)</span> ä¸ºå…³äºè‡ªç„¶æ•° <span class="math inline">\(n\)</span> çš„ä¸€ä¸ªæ€§è´¨ï¼Œå¦‚æœ <span class="math inline">\(P(0)\)</span> æ­£ç¡®ï¼Œ ä¸”å‡è®¾ <span class="math inline">\(P(n)\)</span> æ­£ç¡®ï¼Œåˆ™ <span class="math inline">\(P(n+1)\)</span> äº¦æ­£ç¡®ã€‚é‚£ä¹ˆ <span class="math inline">\(P(n)\)</span> å¯¹ä¸€åˆ‡è‡ªç„¶æ•° <span class="math inline">\(n\)</span> éƒ½æ­£ç¡®ã€‚</li></ol><p>å­˜åœ¨ä¸€ä¸ªé›†åˆ <span class="math inline">\(N\)</span>ï¼Œç§°å…¶å…ƒç´ ä¸ºè‡ªç„¶æ•°ï¼Œå½“ä¸”ä»…å½“è¿™äº›å…ƒç´ æ»¡è¶³å…¬ç† 1 - 5ï¼ˆä¹Ÿå°±æ˜¯çš®äºšè¯ºå…¬ç†ï¼‰ã€‚</p><p>åœ¨è‡ªç„¶æ•°é›†åˆä¸Šå¯ä»¥å®šä¹‰ä¸€ç»„è¿ç®—ï¼šåŠ æ³•ã€ä¹˜æ³•ç­‰ç­‰ï¼Œè¿™é‡Œç”¨åŠ æ³•ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(m, n)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> m</span><br><span class="line">    <span class="keyword">return</span> add(m, n - <span class="number">1</span>) + <span class="number">1</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºåŠ æ³•æ˜¯ç”±ä¸¤æ¡è§„åˆ™é€’å½’å®šä¹‰çš„ï¼š</p><ol type="1"><li>$ m + 0 = m$</li><li><span class="math inline">\(m + (n + 1) = (m + n) + 1\)</span></li></ol><h2 id="lambda-æ¼”ç®—çš„è‡ªç„¶æ•°è¡¨ç¤ºæ³•">lambda æ¼”ç®—çš„è‡ªç„¶æ•°è¡¨ç¤ºæ³•</h2><p>è‡ªç„¶æ•°å½“ç„¶ä¸æ­¢å¯ä»¥ç”¨çš®äºšè¯ºå…¬ç†å®šä¹‰ï¼Œä¸˜å¥‡é¦–å…ˆæŠŠè‡ªç„¶æ•°å’Œè‡ªç„¶æ•°ä¸Šçš„è¿ç®—å®šä¹‰åœ¨äº† lambda æ¼”ç®—ä¸Šï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºä¸˜å¥‡è®¡æ•°ã€‚</p><p>ä¸‹é¢å°±è¦å¼€å§‹ä¸˜å¥‡è®¡æ•°çš„å®šä¹‰äº†ï¼Œç”±äº lambda æ¼”ç®—çš„æ ·å­ä¸å¤ªå‹å¥½ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨ Python è¡¨ç¤ºã€‚</p><p>é¦–å…ˆå®šä¹‰ 0ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zero = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: x</span><br></pre></td></tr></table></figure><p>å…ˆä¸ç®¡å®ƒä¸ºä»€ä¹ˆæ˜¯ 0ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªè¯­å¥ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªæ¥å—ä¸€ä¸ªå‚æ•° <code>f</code> çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° <code>x</code>ï¼Œç„¶åè¿”å›å®ƒã€‚ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†æ˜¯å®ƒä¸ºä»€ä¹ˆæ˜¯ 0ï¼Ÿ</p><p>æŠŠå®ƒæ”¾åœ¨ä¸€è¾¹ï¼Œçœ‹çœ‹ 1 çš„å®šä¹‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">one = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f(x)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¯­å¥æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®šä¹‰äº†ä¸€ä¸ªæ¥å—ä¸€ä¸ªå‚æ•° <code>f</code> çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° <code>x</code>ï¼Œç„¶åè¿”å› <code>f(x)</code> çš„è°ƒç”¨ç»“æœã€‚å¥½åƒæœ‰äº›è§„å¾‹äº†ï¼Œå†çœ‹çœ‹ 2ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">two = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f(f(x))</span><br></pre></td></tr></table></figure><p>å®šä¹‰äº†ä¸€ä¸ªæ¥å—ä¸€ä¸ªå‚æ•° <code>f</code> çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° <code>x</code>ï¼Œç„¶åè¿”å› <code>f(f(x))</code> çš„è°ƒç”¨ç»“æœã€‚</p><p>ç°åœ¨å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œæ¯ä¸ªè‡ªç„¶æ•°çš„åç»§éƒ½å¤šè°ƒç”¨äº†ä¸€æ¬¡ <code>f</code>ï¼Œè‡ªç„¶æ•°è¢«è¡¨ç¤ºä¸º <code>f</code> çš„è°ƒç”¨æ¬¡æ•°ã€‚</p><p>äºæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„å†™å‡ºåç»§å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">succ = <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f(n(f)(x))</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•° <code>n</code>ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢è¢«å®šä¹‰çš„ 0ï¼Œ1ï¼Œ2 ç­‰ç­‰ï¼‰ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨ <code>n</code> çš„åŸºç¡€ä¸Šå¤šæ‰§è¡Œäº†ä¸€æ¬¡ <code>f</code>ï¼Œè¾¾åˆ°äº†æ±‚ <code>n</code> çš„åç»§çš„ç›®çš„ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬å¿˜è®° 1 çš„å®šä¹‰ï¼Œç”¨ 0 å’Œåç»§é‡æ–°å®šä¹‰ä¸€æ¬¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">zero = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: x</span><br><span class="line">succ = <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f(n(f)(x))</span><br><span class="line"></span><br><span class="line">one = succ(zero)</span><br><span class="line">    = (<span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f(n(f)(x)))(<span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: x)</span><br><span class="line">    = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f(((<span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: x)(f))(x))</span><br><span class="line">    = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f((<span class="keyword">lambda</span> x: x)(x))</span><br><span class="line">    = <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: f(x)</span><br></pre></td></tr></table></figure><p>å’Œæˆ‘ä»¬é¢„æƒ³çš„å®Œå…¨ä¸€è‡´ã€‚</p><h3 id="åŠ æ³•">åŠ æ³•</h3><p>æ¥ä¸‹æ¥è¯•ç€å®šä¹‰ä¸€ä¸‹åŠ æ³•ï¼ŒåŠ æ³•æ˜¯ä¸¤ä¸ªæ•°ç›¸åŠ è¿”å›ä¸€ä¸ªæ•°ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ æ³•æ˜¯å®šä¹‰åœ¨è‡ªç„¶æ•°ä¸Šçš„å¹ºåŠç¾¤ï¼‰ï¼Œæ‰€ä»¥ç­¾åé•¿è¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: ...</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä½“å‘¢ï¼Ÿæˆ‘ä»¬æ¨å¹¿ä¸€ä¸‹åç»§å‡½æ•°ï¼šåç»§å‡½æ•°åœ¨<code>n</code>çš„åŸºç¡€ä¸Šå¤šè°ƒç”¨äº†ä¸€æ¬¡ <code>f</code>ï¼Œç›¸å½“äº <code>+1</code>ï¼›é‚£åŠ æ³•ç›¸å½“äº <code>+m</code>ï¼Œä¹Ÿå°±æ˜¯å¤šè°ƒç”¨ <code>m</code> æ¬¡ <code>f</code>ï¼Œäºæ˜¯å¯ä»¥å¾—å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: m(f)(n(f)(x))</span><br></pre></td></tr></table></figure><h3 id="ä¹˜æ³•">ä¹˜æ³•</h3><p>ä¹˜æ³•çš„ç­¾åä¹Ÿæ˜¯ä¸€æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mul = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: ...</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éƒ½çŸ¥é“ä¹˜æ³•æ˜¯ä»åŠ æ³•æ¨å¹¿è€Œæ¥çš„ï¼š<code>m * n</code> ç›¸å½“äºåŠ  <code>m</code> æ¬¡ <code>n</code>ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨åŠ æ³•çš„å®šä¹‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mul = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: m(add(n))(zero)(f)(x)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å†™æ³•æ­£ç¡®ï¼Œä¸è¿‡å¤ªä¸‘äº†ï¼Œå¯ä»¥åŒ–ç®€ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mul = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: m(n(f))(x)</span><br></pre></td></tr></table></figure><h3 id="æ±‚å¹‚">æ±‚å¹‚</h3><p>æ±‚å¹‚çš„ç­¾åä¹Ÿä¸€æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pow = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: ...</span><br></pre></td></tr></table></figure><p>æ±‚å¹‚æ˜¯ç”±ä¹˜æ³•æ¨å¹¿è€Œæ¥çš„ï¼šm<sup>n</sup> ç›¸å½“äºä¹˜ <code>n</code> æ¬¡ <code>m</code>ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ä¹˜æ³•çš„å®šä¹‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pow = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: n(mul(m))(one)(f)(x)</span><br></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥åŒ–ç®€ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pow = <span class="keyword">lambda</span> m: <span class="keyword">lambda</span> n: <span class="keyword">lambda</span> f: <span class="keyword">lambda</span> x: n(m)(f)(x)</span><br></pre></td></tr></table></figure><h2 id="ç»“è¯­">ç»“è¯­</h2><p>æœºæ™ºçš„åŒå­¦ä¸€å®šå‘ç°æˆ‘ä»¬å¹¶æ²¡æœ‰å®ç°å‡æ³•ï¼Œè¿™æ˜¯å› ä¸ºå‡æ³•çš„å®ç°å¤ªå¤æ‚äº†ã€‚è‡³äºä¸ºä»€ä¹ˆå‡æ³•çš„å®ç°å¾ˆå¤æ‚ï¼Œä»¥åŠå¦‚ä½•å®ç°å‡æ³•ï¼Œè¿™é‡Œæœ‰ä¸€ç¯‡<a href="http://gettingsharper.de/2012/08/30/lambda-calculus-subtraction-is-hard/" target="_blank" rel="noopener">å‚è€ƒèµ„æ–™</a> ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œäº†è§£ä¸€ä¸‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ä¸æƒ³å†™ Python äº†ï¼Œè¿™æ¬¡æ¢ä¸ªä¸»é¢˜ï¼šä¸˜å¥‡è®¡æ•°ï¼Œåˆå lambda æ¼”ç®—çš„è‡ªç„¶æ•°è¡¨ç¤ºæ³•ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯-lambda-æ¼”ç®—&quot;&gt;ä»€ä¹ˆæ˜¯ lambda æ¼”ç®—&lt;/h2&gt;
&lt;p&gt;lambda æ¼”ç®—ï¼ˆä¹Ÿç§°ä¸º Î»
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>chapter-04-AIR</title>
    <link href="http://weafteam.github.io/posts/466eca41/"/>
    <id>http://weafteam.github.io/posts/466eca41/</id>
    <published>2018-04-05T02:13:07.000Z</published>
    <updated>2018-05-29T01:27:49.820Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-åŸºç¡€1">TensorFLow åŸºç¡€ï¼ˆ1ï¼‰</h1><p>hi,åˆå’Œå¤§å®¶è§é¢äº†ï¼Œä¸Šä¸€æ¬¡æˆ‘ä»¬è®²äº†å»ºç«‹æ¨¡å‹æ­¥éª¤å’Œä¸€äº›åŸºç¡€çš„æ¦‚å¿µï¼ˆTensorã€Placeholderï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™æ¬¡å°±ç»§ç»­æˆ‘ä»¬çš„çŸ©é˜µæ“ä½œï¼Œå› ä¸ºåœ¨TensorFlowå¤„ç†ä¸€äº›æ•°å­¦é—®é¢˜çš„æ—¶å€™ï¼Œå¾€å¾€éƒ½æ˜¯é€šè¿‡çŸ©é˜µæ¥å­˜å‚¨æ•°æ®ï¼Œé€šè¿‡ç‰¹å®šçš„çŸ©é˜µè¿ç®—ï¼Œæˆ‘ä»¬å®ç°æ•°æ®çš„å¤„ç†ï¼Œä»è€Œå¾—åˆ°ä¸€äº›æ•°æ®çš„ç‰¹æ€§ã€‚è¿˜æœ‰ä¸€äº›å…¶ä»–çš„Tensorflowçš„æ¦‚å¿µï¼Œæˆ‘å¸Œæœ›å¤§å®¶èƒ½åšæŒä¸‹å»ï¼Œåªè¦å°†è¿™äº›åŸºç¡€çš„æ¦‚å¿µå­¦ä¼šï¼Œé‚£ä¹ˆä»¥åè¿ç”¨TensorFlowå°±ä¼šå¾—å¿ƒåº”æ‰‹ã€‚</p><ol type="1"><li>å’ŒTensorFlowä¸€èµ·å·¥ä½œçš„Matrices</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># çŸ©é˜µå’ŒçŸ©é˜µæ“ä½œ</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line">identity_matrix = tf.diag([<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1</span>])</span><br><span class="line">print(sess.run(identity_matrix)) <span class="comment">#æ³¨æ„è¿™ä¸ªåœ°æ–¹ï¼Œå¦‚æœæ˜¯TensorFlowçš„Tensorï¼Œ</span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆä½¿ç”¨sessçš„runæ–¹æ³•æ‰èƒ½å°†ç»“æœæ˜¾ç¤º</span></span><br><span class="line"><span class="comment"># æˆ–è€…ä¸‹é¢è¿™ç§æ–¹å¼</span></span><br><span class="line">print(identity_matrix.eval(session = sess))</span><br><span class="line">A = tf.truncated_normal([<span class="number">2</span>, <span class="number">3</span>]) <span class="comment"># 2 * 3 å¤§å° å‡å€¼0 æ–¹å·®ä¸º1.</span></span><br><span class="line">print(sess.run(A))</span><br><span class="line">B = tf.fill([<span class="number">2</span>, <span class="number">3</span>], <span class="number">5.</span>) <span class="comment"># 2 * 3 ä½¿ç”¨5.å¡«å……</span></span><br><span class="line">print(sess.run(B))</span><br><span class="line">C = tf.random_uniform([<span class="number">3</span>, <span class="number">2</span>]) <span class="comment"># 3 * 2 éšæœºåˆå§‹åŒ–</span></span><br><span class="line">print(sess.run(C))</span><br><span class="line">D = tf.convert_to_tensor(np.array([[<span class="number">1.</span>, <span class="number">2.</span>, <span class="number">3.</span>], [<span class="number">-3.</span>, <span class="number">-7.</span>, <span class="number">-1.</span>], [<span class="number">0.</span>, <span class="number">5.</span>, <span class="number">-2.</span>]]))</span><br><span class="line">print(sess.run(D))</span><br><span class="line"></span><br><span class="line">print(sess.run(A+B)) <span class="comment"># åŠ æ³•å’Œ tf.add() ä¸€æ ·</span></span><br><span class="line">print(sess.run(B-B)) <span class="comment"># å‡æ³•å’Œ tf.subtract() ä¸€æ ·</span></span><br><span class="line">print(sess.run(tf.matmul(B, identity_matrix))) <span class="comment"># çŸ©é˜µä¹˜æ³•</span></span><br><span class="line">print(sess.run(tf.transpose(C))) <span class="comment"># çŸ©é˜µè½¬ç½®</span></span><br><span class="line">print(sess.run(tf.matrix_determinant(D)))  <span class="comment"># è®¡ç®—è¡Œåˆ—å¼</span></span><br><span class="line">print(sess.run(tf.matrix_inverse(D))) <span class="comment"># çŸ©é˜µçš„é€†</span></span><br><span class="line">print(sess.run(tf.cholesky(identity_matrix))) <span class="comment"># choleskåˆ†è§£ï¼ˆå¹³æ–¹æ ¹åˆ†è§£ï¼‰</span></span><br><span class="line"></span><br><span class="line">eigenvalues, eigenvectors = sess.run(tf.self_adjoint_eig(D)) <span class="comment"># æ±‚ç‰¹å¾å‘é‡å’Œç‰¹å¾å€¼</span></span><br><span class="line">print(eigenvalues)</span><br><span class="line">print(eigenvectors)</span><br></pre></td></tr></table></figure><ol start="2" type="1"><li>Math Operationï¼ˆæ•°å­¦æ“ä½œï¼‰</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"><span class="comment"># math operation</span></span><br><span class="line">print(sess.run(tf.div(<span class="number">3</span>, <span class="number">4</span>)))</span><br><span class="line">print(sess.run(tf.truediv(<span class="number">3</span>, <span class="number">4</span>)))</span><br><span class="line">print(sess.run(tf.floordiv(<span class="number">3.</span>, <span class="number">4.</span>)))</span><br><span class="line">print(sess.run(tf.mod(<span class="number">22.</span>, <span class="number">5.</span>)))</span><br><span class="line">print(sess.run(tf.cross([<span class="number">1.</span>, <span class="number">0.</span>, <span class="number">0.</span>], [<span class="number">0.</span>, <span class="number">1.</span>, <span class="number">0.</span>])))</span><br><span class="line"><span class="comment"># Trig operation</span></span><br><span class="line">print(sess.run(tf.sin(<span class="number">3.1416</span>)))</span><br><span class="line">print(sess.run(tf.cos(<span class="number">3.1416</span>)))</span><br><span class="line">print(sess.run(tf.div(tf.sin(<span class="number">3.1416</span> / <span class="number">4.</span>), tf.cos(<span class="number">3.1416</span> / <span class="number">4.</span>))))</span><br><span class="line"><span class="comment"># custom operation</span></span><br><span class="line"><span class="comment"># f(x) = 3 * x^2 - X + 10</span></span><br><span class="line"></span><br><span class="line">test_nums = range(<span class="number">15</span>) <span class="comment"># ç”Ÿæˆä¸€ä¸ªlist</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">custom_polynomial</span><span class="params">(x_val)</span>:</span></span><br><span class="line"><span class="keyword">return</span> (tf.subtract(<span class="number">3</span> * tf.square(x_val), x_val) + <span class="number">10</span>)</span><br><span class="line">print(sess.run(custom_polynomial(<span class="number">11</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># list expend</span></span><br><span class="line">expected_output = [<span class="number">3</span> * x * x - x + <span class="number">10</span> <span class="keyword">for</span> x <span class="keyword">in</span> test_nums]</span><br><span class="line">print(expected_output)</span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> test_nums:</span><br><span class="line">    print(sess.run(custom_polynomial(num)))</span><br></pre></td></tr></table></figure><ol start="3" type="1"><li>Activation Functionï¼ˆæ¿€æ´»å‡½æ•°ï¼‰</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¿€æ´»å‡½æ•°ä¸»è¦æ˜¯ä¸ºäº†è®©ç¥ç»ç½‘ç»œæ¨¡å‹å…·æœ‰éçº¿æ€§çš„ç‰¹æ€§</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line">x_vals = np.linspace(start = <span class="number">-10</span>, stop = <span class="number">10</span>, num = <span class="number">100</span>)</span><br><span class="line"><span class="comment"># Relu Activation-&gt; max(0, x)</span></span><br><span class="line">print(sess.run(tf.nn.relu([<span class="number">-3.</span>, <span class="number">3.</span>, <span class="number">10.</span>])))</span><br><span class="line">y_relu = sess.run(tf.nn.relu(x_vals))</span><br><span class="line"><span class="comment"># Relu6 Activation-&gt; min(max(x, 0), 6)</span></span><br><span class="line">print(sess.run(tf.nn.relu6([<span class="number">-3.</span>, <span class="number">3.</span>, <span class="number">10.</span>])))</span><br><span class="line">y_relu6 = sess.run(tf.nn.relu6(x_vals))</span><br><span class="line"><span class="comment"># Sigmoidactivation-&gt; è§å…¬å¼1</span></span><br><span class="line">print(sess.run(tf.nn.sigmoid([<span class="number">-1.</span>, <span class="number">0.</span>, <span class="number">1.</span>])))</span><br><span class="line">y_sigmoid = sess.run(tf.nn.sigmoid(x_vals))</span><br><span class="line"><span class="comment"># Hyper Tangent activation-&gt;è§å…¬å¼2</span></span><br><span class="line">print(sess.run(tf.nn.tanh([<span class="number">-1.</span>, <span class="number">0.</span>, <span class="number">1.</span>])))</span><br><span class="line">y_tanh = sess.run(tf.nn.tanh(x_vals))</span><br><span class="line"><span class="comment"># softsign activation-&gt;è§å…¬å¼3</span></span><br><span class="line">print(sess.run(tf.nn.softsign([<span class="number">-1.</span>, <span class="number">0.</span>, <span class="number">1.</span>])))</span><br><span class="line">y_softsign = sess.run(tf.nn.softsign(x_vals))</span><br><span class="line"><span class="comment"># softplus activation-&gt;è§å…¬å¼4</span></span><br><span class="line">print(sess.run(tf.nn.softplus([<span class="number">-1.</span>, <span class="number">0.</span>, <span class="number">1.</span>])))</span><br><span class="line">y_softplus = sess.run(tf.nn.softplus(x_vals))</span><br><span class="line"><span class="comment"># Exponential linear activation-&gt;è§å…¬å¼5</span></span><br><span class="line">print(sess.run(tf.nn.elu([<span class="number">-1.</span>, <span class="number">0.</span>, <span class="number">1.</span>])))</span><br><span class="line">y_elu = sess.run(tf.nn.elu(x_vals))</span><br><span class="line"></span><br><span class="line">plt.plot(x_vals, y_softplus, <span class="string">'r--'</span>, label=<span class="string">'Softplus'</span>, linewidth=<span class="number">2</span>)</span><br><span class="line">plt.plot(x_vals, y_relu, <span class="string">'b:'</span>, label=<span class="string">'ReLU'</span>, linewidth=<span class="number">2</span>)</span><br><span class="line">plt.plot(x_vals, y_relu6, <span class="string">'g-.'</span>, label=<span class="string">'ReLU6'</span>, linewidth=<span class="number">2</span>)</span><br><span class="line">plt.plot(x_vals, y_elu, <span class="string">'k-'</span>, label=<span class="string">'ExpLU'</span>, linewidth=<span class="number">0.5</span>)</span><br><span class="line">plt.ylim([<span class="number">-1.5</span>,<span class="number">7</span>])</span><br><span class="line">plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">plt.plot(x_vals, y_sigmoid, <span class="string">'r--'</span>, label=<span class="string">'Sigmoid'</span>, linewidth=<span class="number">2</span>)</span><br><span class="line">plt.plot(x_vals, y_tanh, <span class="string">'b:'</span>, label=<span class="string">'Tanh'</span>, linewidth=<span class="number">2</span>)</span><br><span class="line">plt.plot(x_vals, y_softsign, <span class="string">'g-.'</span>, label=<span class="string">'Softsign'</span>, linewidth=<span class="number">2</span>)</span><br><span class="line">plt.ylim([<span class="number">-2</span>,<span class="number">2</span>])</span><br><span class="line">plt.legend(loc=<span class="string">'upper left'</span>)</span><br><span class="line">plt.show()</span><br><span class="line">ä¸‹å›¾ç»™å‡ºæ¿€æ´»å‡½æ•°çš„æ›²çº¿å›¾</span><br></pre></td></tr></table></figure><blockquote><p>å…¬å¼1ï¼š</p></blockquote><p><span class="math display">\[\sigma(x)=\frac{1}{1+e^{-x}}\]</span></p><blockquote><p>å…¬å¼2ï¼š</p></blockquote><p><span class="math display">\[f(x)=\frac{e^x-e^{-x}}{e^x + e^{-x}}\]</span></p><blockquote><p>å…¬å¼3ï¼š</p></blockquote><p><span class="math display">\[f(x) = \frac{1}{1 + |x|}\]</span></p><blockquote><p>å…¬å¼4</p></blockquote><p><span class="math display">\[f(x) = \log(1 + e^x)\]</span></p><blockquote><p>å…¬å¼5ï¼š</p></blockquote><p><span class="math display">\[elu(x) = \begin{cases} x &amp; x &gt; 0 \\\alpha(exp(x) - 1) &amp; x \leq 0\end{cases}\]</span></p><p><img src="https://s1.ax1x.com/2018/04/05/CC9wN9.png" alt="-"></p><p><img src="https://s1.ax1x.com/2018/04/05/CC90hR.png" alt="-"></p><ol start="4" type="1"><li>Operations on a Computational Graph</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºçš„æ•°æ®æ˜¯è¦å–‚ç»™ä¸‹é¢çš„placeholderçš„</span></span><br><span class="line">x_vals = np.array([<span class="number">1.</span>, <span class="number">3.</span>, <span class="number">5.</span>, <span class="number">7.</span>, <span class="number">9.</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºplaceholder</span></span><br><span class="line">x_data = tf.placeholder(tf.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªä¹˜æ•°</span></span><br><span class="line">m = tf.constant(<span class="number">3.</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹˜æ³•</span></span><br><span class="line">prod = tf.multiply(x_data, m)</span><br><span class="line"><span class="keyword">for</span> x_val <span class="keyword">in</span> x_vals:</span><br><span class="line">    print(sess.run(prod, feed_dict = &#123;x_data: x_val&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸‹é¢å°†æ•°æ®è®¡ç®—å›¾è¾“å‡ºåˆ°æ–‡ä»¶é‡Œé¢ï¼Œä¾›æˆ‘ä»¬åæ¥å¯åŠ¨tensorboardä½¿ç”¨</span></span><br><span class="line">merged = tf.summary.merge_all(key = <span class="string">'summary'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'tensorboard_logs/'</span>):</span><br><span class="line">    os.makedirs(<span class="string">'tensorboard_logs/'</span>)</span><br><span class="line"></span><br><span class="line">my_writer = tf.summary.FileWriter(<span class="string">'./tensorboard_logs/'</span>, sess.graph)</span><br></pre></td></tr></table></figure><ol start="5" type="1"><li>Layering Nested Operations</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®ä¸ºäº†feed</span></span><br><span class="line">my_array = np.array([[<span class="number">1.</span>, <span class="number">3.</span>, <span class="number">5.</span>, <span class="number">7.</span>, <span class="number">9.</span>],</span><br><span class="line">                    [<span class="number">-2.</span>, <span class="number">0.</span>, <span class="number">2.</span>, <span class="number">4.</span>, <span class="number">6.</span>],</span><br><span class="line">                    [<span class="number">-6.</span>, <span class="number">-3.</span>, <span class="number">0.</span>, <span class="number">3.</span>, <span class="number">6.</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶</span></span><br><span class="line">x_vals = np.array([my_array, my_array + <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜placeholder</span></span><br><span class="line">x_data = tf.placeholder(tf.float32, shape = [<span class="number">3</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜å¸¸æ•°æ¥æ“ä½œ</span></span><br><span class="line">m1 = tf.constant([[<span class="number">1.</span>], [<span class="number">0.</span>], [<span class="number">-1.</span>], [<span class="number">2.</span>], [<span class="number">4</span>]])</span><br><span class="line">m2 = tf.constant([[<span class="number">2.</span>]])</span><br><span class="line">a1 = tf.constant([[<span class="number">10.</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜æ“ä½œ</span></span><br><span class="line">prod1 = tf.matmul(x_data, m1)</span><br><span class="line">prod2 = tf.matmul(prod1, m2)</span><br><span class="line">add1 = tf.matmul(prod2, a1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°éªŒè¯ç»“æœ</span></span><br><span class="line"><span class="keyword">for</span> x_val <span class="keyword">in</span> x_vals:</span><br><span class="line">    print(sess.run(add1, feed_dict = &#123;x_data: x_val&#125;))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#ä¸‹é¢å°†æ•°æ®è®¡ç®—å›¾è¾“å‡ºåˆ°æ–‡ä»¶é‡Œé¢ï¼Œä¾›æˆ‘ä»¬åæ¥å¯åŠ¨tensorboardä½¿ç”¨</span></span><br><span class="line">merged = tf.summary.merge_all(key = <span class="string">'summaries'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'tensorboard_logs/'</span>):</span><br><span class="line">    os.makedirs(<span class="string">'tensorflow_logs/'</span>)</span><br><span class="line">my_writer = tf.summary.FileWriter(<span class="string">'tensorboard_logs/'</span>, sess.graph)</span><br><span class="line"><span class="comment">#ä¸‹å›¾å°±æ˜¯åœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œtensorflowå»ºç«‹çš„å›¾è¿ç®—æ¨¡å‹</span></span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2018/04/05/CCkFQ1.png" alt="-"></p><ol start="6" type="1"><li>Working With Multiple Layers</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line"></span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line">x_shape = [<span class="number">1</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>]</span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ª4 * 4 å¤§å°çš„éšæœºçŸ©é˜µ</span></span><br><span class="line">x_val = np.randim.uniform(size = x_shape)</span><br><span class="line"></span><br><span class="line">x_data = tf.placeholder(tf.float32, shape = x_shape)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç©ºé—´ç§»åŠ¨çª—å£ï¼Œä¹Ÿå°±æ˜¯å·ç§¯æ“ä½œçš„å·ç§¯æ ¸</span></span><br><span class="line"><span class="comment"># å¤§å°æ˜¯2 * 2ï¼Œ æ­¥é•¿æ˜¯ 2</span></span><br><span class="line"><span class="comment"># filterçš„å€¼æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼0.25</span></span><br><span class="line">my_filter = tf.constant(<span class="number">0.25</span>, shape = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>])</span><br><span class="line">my_strides = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">mov_avg_layer = tf.nn.conv2d(x_data, my_filter, my_strides, padding = <span class="string">'SAME'</span>, name = <span class="string">'Moving_Avg_Window'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒå±‚</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">custom_layer</span><span class="params">(input_matrix)</span>:</span></span><br><span class="line">    input_matrix_sqeezed = tf.squeeze(input_matrix)</span><br><span class="line">    A = tf.constant([<span class="number">1.</span>, <span class="number">2.</span>], [<span class="number">-1.</span>, <span class="number">3.</span>])</span><br><span class="line">    b = tf.constant(<span class="number">1.</span>, shape = [<span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">    output = tf.add(tf.matmul(A, input_matrix_sqeezed), b)</span><br><span class="line">    <span class="keyword">return</span> tf.nn.relu(output)</span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">'custom_layer'</span>) <span class="keyword">as</span> scope:</span><br><span class="line">    custom_layer1 = custom_layer(mov_avg_layer)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œç»“æœ</span></span><br><span class="line">print(sess.run(mov_avg_layer, feed_dict = &#123;x_data: x_val&#125;))</span><br><span class="line"></span><br><span class="line">print(sess.run(custom_layer1, feed_dict = &#123;x_data: x_val&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸‹é¢å°†æ•°æ®è®¡ç®—å›¾è¾“å‡ºåˆ°æ–‡ä»¶é‡Œé¢ï¼Œä¾›æˆ‘ä»¬åæ¥å¯åŠ¨tensorboardä½¿ç”¨</span></span><br><span class="line">merged = tf.summary.merge_all(key = <span class="string">'summaries'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'tensorboard_logs/'</span>):</span><br><span class="line">    os.makedirs(<span class="string">'tensorboard_logs/'</span>)</span><br><span class="line">my_writer = tf.summary.FileWriter(<span class="string">'tensorboard_logs'</span>, sess.graph)</span><br><span class="line"><span class="comment"># ä¸‹å›¾æ˜¯è®¡ç®—å›¾</span></span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2018/04/05/CCksmV.png" alt="-"></p><p>æ€»ç»“ï¼šè¿™ä¸€æ¬¡ï¼Œä¸€å¼€å§‹ä¸»è¦è®²äº†çŸ©é˜µçš„ä¸€äº›æ“ä½œï¼Œåç»­åˆè¿›è¡Œäº†æ•°å­¦æ“ä½œï¼Œæ¿€æ´»å‡½æ•°ï¼Œè¿ç®—å›¾ã€å±‚å†…å…ƒç´ åµŒå¥—è¿ç®—è¿˜æœ‰æœ€å¥½çš„å¤šå±‚è¿ç®—ï¼Œå¹¶ç»™å‡ºäº†tensorboardçš„è®¡ç®—å›¾ç»“æ„ã€‚å¤§å®¶ä¸ä»…ä»…è¦çœ‹ä¸€çœ‹ï¼Œä¹Ÿè¦åŠ¨æ‰‹åšä¸€åšå“¦ã€‚</p><p>ä¸€å¦‚æ—¢å¾€çš„æœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥ç›´æ¥è”ç³»milittleï¼Œair@weaf.topé‚®ç®±</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-åŸºç¡€1&quot;&gt;TensorFLow
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>Nginxå’ŒGitçš„ç¦»çº¿å®‰è£…</title>
    <link href="http://weafteam.github.io/posts/a86291b8/"/>
    <id>http://weafteam.github.io/posts/a86291b8/</id>
    <published>2018-04-01T04:07:12.000Z</published>
    <updated>2018-05-29T01:27:49.810Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€å‡†å¤‡å·¥ä½œ">ä¸€ã€å‡†å¤‡å·¥ä½œ</h1><p>ä¸€èˆ¬æƒ…å†µä¸‹ä¸ºäº†ç¡®ä¿å®‰è£…æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨æœ‰ç½‘ç»œç¯å¢ƒçš„ä¸‹å®‰è£…çš„æ–¹æ³•ï¼Œå»æ£€æµ‹å½“å‰æœºå™¨å…·ä½“éœ€è¦å®‰è£…ä»€ä¹ˆå†¬å¤©é“¾æ¥åº“ï¼Œç„¶åæŒ‰ç…§æç¤ºç¼ºå¤±çš„åº“å»ä¸‹è½½ç›¸åº”çš„åº“ã€‚ æˆ‘ä»¬æŒ‰ç…§æ­£å¸¸çš„æµç¨‹ï¼Œå»è§£å‹nginx <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.13.8.tar.gz</span><br></pre></td></tr></table></figure></p><p>è¿›å…¥è§£å‹åçš„ç›®å½•æ‰§è¡Œ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.13.8</span><br><span class="line">./configure</span><br></pre></td></tr></table></figure></p><p>å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š <img src="http://us-forever.com/img/nginxerror.png"></p><p>æˆ‘ä»¬æŒ‰ç…§æœ‰ç½‘ç»œç¯å¢ƒçš„æ–¹æ³•å»æ£€æµ‹ç¼ºå¤±çš„åº“åŠå…¶ç‰ˆæœ¬ã€‚ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ autoconf automake make</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>æ˜¾ç¤ºå¦‚ä¸‹ï¼š <img src="http://us-forever.com/img/liberror.png"></p><p>æˆ‘ä»¬ä¸‹è½½å·ç›¸åº”çš„åº“ ä¸‹è¾¹æä¾›å‡ ä¸ªä¸‹è½½çš„ç½‘å€ï¼š</p><ul><li><a href="http://mirrors.163.com/centos/6/os/x86_64/Packages/" class="uri" target="_blank" rel="noopener">http://mirrors.163.com/centos/6/os/x86_64/Packages/</a></li><li><a href="http://rpmfind.net/" class="uri" target="_blank" rel="noopener">http://rpmfind.net/</a></li><li><a href="https://pkgs.org" class="uri" target="_blank" rel="noopener">https://pkgs.org</a></li></ul><p>ä¸‹è¾¹æ˜¯ä¸‹è½½å¥½çš„åº“ <img src="http://us-forever.com/img/gcclib.png"> å®‰è£…ç›¸åº”çš„åº“ï¼ˆ<strong>é›†ä½“å®‰è£…æƒ…å†µå…·ä½“åˆ†æ</strong>ï¼‰ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh mpfr-2.4.1-6.el6.x86_64.rpm</span><br><span class="line">rpm -ivh cpp-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -Uvh tzdata-2016j-1.el6.noarch.rpm</span><br><span class="line">rpm -Uvh glibc-common-2.12-1.209.el6.x86_64.rpm glibc-2.12-1.209.el6.x86_64.rpm glibc-headers-2.12-1.209.el6.x86_64.rpm glibc-devel-2.12-1.209.el6.x86_64.rpm kernel-headers-2.6.32-696.el6.x86_64.rpm</span><br><span class="line">rpm -ivh libgomp-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -Uvh libstdc++-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh libstdc++-devel-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh ppl-0.10.2-11.el6.x86_64.rpm</span><br><span class="line">rpm -ivh cloog-ppl-0.15.7-1.2.el6.x86_64.rpm</span><br><span class="line">rpm -Uvh libgcc-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh gcc-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh gcc-c++-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh automake-1.11.1-4.el6.noarch.rpm autoconf-2.63-5.1.el6.noarch.rpm</span><br></pre></td></tr></table></figure></p><p>ç„¶åæ‰§è¡Œ./configure å‘ç°é”™è¯¯ï¼š <img src="http://us-forever.com/img/nginxerror1.png"> ç„¶åå®‰è£…ä¸€ä¸‹åº“ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh pcre-7.8-7.el6.x86_64.rpm</span><br><span class="line">rpm -ivh pcre-devel-7.8-7.el6.x86_64.rpm</span><br><span class="line">rpm -Uvh zlib-1.2.3-29.el6.x86_64.rpm</span><br><span class="line">rpm -ivh zlib-devel-1.2.3-29.el6.x86_64.rpm</span><br><span class="line">rpm -i --force --nodeps krb5-devel-1.10.3-65.el6.x86_64.rpm</span><br><span class="line">rpm -Uvh openssl-1.0.1e-57.el6.x86_64.rpm</span><br><span class="line">rpm -ivh openssl-devel-1.0.1e-57.el6.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>ç„¶åæ‰§è¡Œ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p><p>å®‰è£…å®Œæˆ äºŒã€æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯ ===== æ ¹æ®å®‰è£…å®Œæˆçš„ä¿¡æ¯æŸ¥çœ‹nginx. ä¸‰ã€ç®€ä»‹ â€”â€“ ä¸åŒæ“ä½œç³»ç»Ÿçš„Linuxçš„å®‰è£…å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚ æœ¬æ•™ç¨‹ä½¿ç”¨çš„æ˜¯CentOSæˆ–è€…RHELã€‚ å››ã€å‡†å¤‡ç¯å¢ƒ â€”- å¦‚æœæœ‰ç½‘ç»œçš„æƒ…å†µä¸‹è‚¯å®šç›¸å½“å®¹æ˜“ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel gcc perl-ExtUtils-MakeMaker</span><br><span class="line"></span><br><span class="line">yum install git</span><br></pre></td></tr></table></figure></p><p>è‹¥æœyumæºå®‰è£…çš„ç‰ˆæœ¬è¾ƒä½ï¼Œä¸æ‰§è¡Œ<strong>yum install git</strong>å‘½ä»¤ï¼Œå¹¶æŒ‰ç…§å››ã€äº”æ­¥éª¤æ“ä½œã€‚ å¦‚æœæ˜¯ç¦»çº¿éœ€è¦å®Œæˆåç»­æ“ä½œï¼š é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ°å®˜ç½‘ä¸‹è½½ç›¸åº”çš„å®‰è£…åŒ… <a href="https://www.kernel.org/pub/software/scm/git/" class="uri" target="_blank" rel="noopener">https://www.kernel.org/pub/software/scm/git/</a> é€‰æ‹©<strong>tar.gz</strong> ä¸‰ã€ä¸‹è½½å’Œå®‰è£…ä¾èµ– â€”â€” ç„¶åæœ€éº»çƒ¦çš„åœ°æ–¹å°±æ˜¯ä¾èµ–åŠ¨æ€é“¾æ¥åº“çš„ä¸‹è½½ã€‚ éœ€è¦ä¸‹è½½çš„åº“å¯ä»¥åˆ°è¿™ä¸¤ä¸ªç½‘ç«™ä¸Šå»æ‰¾ï¼š <a href="http://www.rpmfind.net/linux/RPM/index.html" target="_blank" rel="noopener">fr2.rpmfind.net</a> <a href="https://pkgs.org/" target="_blank" rel="noopener">Linux Packages Search-pkgs.org</a> æˆ‘è¿™é‡Œæä¾›äº†ä¸€äº› <!--more--> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cpio-2.11-24.el7.x86_64.rpm</span><br><span class="line">curl-7.29.0-42.el7.x86_64.rpm</span><br><span class="line">expat-2.1.0-10.el7_3.x86_64.rpm</span><br><span class="line">expat-devel-2.1.0-10.el7_3.x86_64.rpm</span><br><span class="line">gdbm-devel-1.10-8.el7.x86_64.rpm</span><br><span class="line">gettext-0.19.8.1-2.el7.x86_64.rpm</span><br><span class="line">gettext-devel-0.19.8.1-2.el7.x86_64.rpm</span><br><span class="line">krb5-devel-1.15.1-8.el7.x86_64.rpm</span><br><span class="line">libcurl-7.29.0-42.el7.x86_64.rpm</span><br><span class="line">libcurl-devel-7.29.0-42.el7.x86_64.rpm</span><br><span class="line">libdb-devel-5.3.21-20.el7.x86_64.rpm</span><br><span class="line">openssl-1.0.2k-8.el7.x86_64.rpm</span><br><span class="line">openssl-devel-1.0.2k-8.el7.x86_64.rpm</span><br><span class="line">perl-5.16.3-292.el7.x86_64.rpm</span><br><span class="line">perl-devel-5.16.3-292.el7.x86_64.rpm</span><br><span class="line">perl-ExtUtils-CBuilder-0.28.2.6-292.el7.noarch.rpm</span><br><span class="line">perl-ExtUtils-Install-1.58-292.el7.noarch.rpm</span><br><span class="line">perl-ExtUtils-MakeMaker-6.68-3.el7.noarch.rpm</span><br><span class="line">perl-ExtUtils-Manifest-1.61-244.el7.noarch.rpm</span><br><span class="line">perl-ExtUtils-ParseXS-3.18-3.el7.noarch.rpm</span><br><span class="line">systemtap-sdt-devel-3.1-3.el7.x86_64.rpm</span><br><span class="line">zlib-1.2.7-17.el7.x86_64.rpm</span><br><span class="line">zlib-devel-1.2.7-17.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>è¿™æ˜¯gitéœ€è¦çš„ä¸€äº›åº“ï¼Œéœ€è¦å®‰è£…çš„ä¸æ˜¯å¾ˆå¤šï¼Œä½†æ˜¯å®‰è£…çš„åº“ä¹Ÿéœ€è¦ä¾èµ–ã€‚ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh perl-5.16.3-292.el7.x86_64.rpm</span><br><span class="line">rpm -ivh perl-devel-5.16.3-292.el7.x86_64.rpm</span><br><span class="line">rpm -ivh zlib-devel-1.2.7-17.el7.x86_64.rpm</span><br><span class="line">rpm -ivh libcurl-devel-7.29.0-42.el7.x86_64.rpm</span><br><span class="line">rpm -ivh curl-7.29.0-42.el7.x86_64.rpm</span><br><span class="line">rpm -ivh zlib-devel-1.2.7-17.el7.x86_64.rpm</span><br><span class="line">rpm -ivh openssl-devel-1.0.2k-8.el7.x86_64.rpm</span><br><span class="line">rpm -ivh perl-ExtUtils-MakeMaker-6.68-3.el7.noarch.rpm</span><br><span class="line">rpm -ivh gettext-devel-0.19.8.1-2.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>ä»¥ä¸Šåº“éœ€è¦å®‰è£…ï¼Œå¹¶éœ€è¦å®‰è£…å¯¹åº”ä¾èµ–ã€‚ æœ‰æ—¶å€™æœ‰äº›åŒ…å¯èƒ½äº’ç›¸ä¾èµ–ï¼Œå®‰è£…æ—¶å¯ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh perl-ExtUtils-MakeMaker-6.68-3.el7.noarch.rpm perl-ExtUtils-Install-1.58-292.el7.noarch.rpm zlib-devel-1.2.7-17.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>ç¼–è¯‘å®‰è£…å¯èƒ½éœ€è¦çš„åŒ… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh cloog-ppl-0.15.7-1.2.el6.x86_64.rpm</span><br><span class="line">rpm -ivh cpp-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh gcc-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh gcc-c++-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh libgcc-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh libgomp-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh libstdc++-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh libstdc++-devel-4.4.7-18.el6.x86_64.rpm</span><br><span class="line">rpm -ivh mpfr-2.4.1-6.el6.x86_64.rpm</span><br><span class="line">rpm -ivh ppl-0.10.2-11.el6.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>æœ‰æ—¶ä¼šå‘ç”Ÿå†²çªå¯ä»¥ä½¿ç”¨æªæ”¯å¸è½½ï¼Œæˆ–è€…ä¸è€ƒè™‘ä¾èµ–å®‰è£…ã€‚ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpm -e  --nodeps mariadb-libs-5.5.56-2.el7.x86_64</span><br><span class="line">//å¼ºåˆ¶å¸è½½</span><br><span class="line"></span><br><span class="line">rpm -i --force --nodeps krb5-devel-1.15.1-8.el7.x86_64.rpm</span><br><span class="line">//å¼ºåˆ¶å®‰è£… --forceå¯é€‰</span><br></pre></td></tr></table></figure></p><h2 id="äº”è§£å‹å’Œå®‰è£…">äº”ã€è§£å‹å’Œå®‰è£…</h2><p>è§£å‹å®‰è£…åŒ… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf git-2.15.1.tar.gz</span><br></pre></td></tr></table></figure></p><p>è¿›å…¥è§£å‹åçš„æ–‡ä»¶å¤¹ <img src="http://us-forever.com/img/git-1.png"> æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br></pre></td></tr></table></figure></p><p>æ£€æŸ¥æ²¡æœ‰ä»»ä½•å‡ºé”™ <img src="http://us-forever.com/img/git-2.png"> ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure></p><p>æ£€æŸ¥æ²¡æœ‰é—®é¢˜æ‰§è¡Œå®‰è£… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install</span><br></pre></td></tr></table></figure></p><p>æ£€æŸ¥æ²¡æœ‰ä»»ä½•å‡ºé”™ <img src="http://us-forever.com/img/git-4.png"> å…­ã€æŸ¥çœ‹å®‰è£…ç»“æœ â€”-</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git --version</span><br></pre></td></tr></table></figure><p><img src="http://us-forever.com/img/git-5.png"></p>]]></content>
    
    <summary type="html">
    
      Nginxå’ŒGitçš„ç¦»çº¿å®‰è£…
    
    </summary>
    
      <category term="Linux" scheme="http://weafteam.github.io/categories/Linux/"/>
    
    
      <category term="Linuxè¿ç»´" scheme="http://weafteam.github.io/tags/Linux%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>TensorFlow å»ºç«‹ç½‘ç»œæ¨¡å‹</title>
    <link href="http://weafteam.github.io/posts/5b7df854/"/>
    <id>http://weafteam.github.io/posts/5b7df854/</id>
    <published>2018-03-31T10:23:35.000Z</published>
    <updated>2018-05-29T01:27:49.806Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-å»ºç«‹ç½‘ç»œæ¨¡å‹">TensorFlow å»ºç«‹ç½‘ç»œæ¨¡å‹</h1><p>ä¸Šæ¬¡ä¸€æˆ‘ä»¬åœ¨fashion-mnistä¸Šé¢ä½“éªŒäº†ä¸€æŠŠï¼Œä½†æ˜¯é‡Œé¢æœ‰ä¸€äº›å»ºç«‹æ¨¡å‹å’Œä¸€äº›TensorFlowçš„åŸºç¡€æ¦‚å¿µéƒ½æ²¡æœ‰ç»™å¤§å®¶è®²ï¼Œæ‰€ä»¥è¿™èŠ‚å†³å®šå°†è¿™æ–¹é¢çš„çŸ¥è¯†ä»‹ç»ä¸€äº›ï¼Œä¸ŠèŠ‚æ˜¯ä¸ºäº†å¼•èµ·å¤§å®¶çš„æ³¨æ„ï¼ŒTensorFlowå…·æœ‰å¾ˆå¼ºå¤§çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªèƒ½åç»­æ…¢æ…¢çš„å­¦ä¹ ã€‚</p><ol type="1"><li>å…¶å®åœ¨ä¸Šä¸€æ¬¡çš„å®ä¾‹ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹ç¡®å®æ˜¯å¾ˆå›°æƒ‘çš„ï¼Œå¦‚æœæ²¡æœ‰æ¥è§¦è¿‡æœºå™¨å­¦ä¹ çš„å°ä¼™ä¼´å¯èƒ½ç†è§£èµ·æ¥ä¼šæœ‰ä¸€äº›é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘å¼€å¤´å°±ç¨å¾®è®²ä¸€ä¸‹ï¼Œæœºå™¨å­¦ä¹ æœ‰ä¸€äº›ä»€ä¹ˆï¼Ÿå°±æˆ‘ç°åœ¨äº†è§£çš„ä¸€äº›å†…å®¹ç»™å¤§å®¶ä»‹ç»ï¼Œæœ‰å¯èƒ½æœ‰ä¸€äº›ä¸åˆ°ä½çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤šå¤šåŒ…æ¶µï¼š</li></ol><blockquote><ul><li>å…¶å®æœºå™¨å­¦ä¹ ï¼Œæ€»çš„å®—æ—¨å°±æ˜¯åˆ©ç”¨æ•°æ®çš„ç‰¹å¾æ¥åšè¯†åˆ«å’Œåˆ†ç±»ç­‰ä»»åŠ¡</li><li>ç¬¬ä¸€å¤§ç±»æ˜¯åˆ†ç±»å·¥ä½œï¼Œå‡è®¾æœ‰ä¸€ç™¾ç±»ï¼Œç»å…¸çš„åšæ³•ï¼Œå°±æ˜¯ä½¿ç”¨ç¥ç»ç½‘ç»œæå–ä¸€äº›æ•°æ®çš„ç‰¹å¾ï¼Œç„¶ååˆ©ç”¨softmaxè¾“å‡ºå±‚è¿›è¡Œä¸åŒç§ç±»æ¦‚ç‡çš„é¢„æµ‹ï¼š</li></ul></blockquote><p><span class="math display">\[softmax(i) = \frac{X_i}{\sum_{i=0,99}X_i}\]</span></p><blockquote><ul><li>ä¸Šé¢æ˜¯softmaxå±‚è®¡ç®—çš„å…¬å¼ï¼Œä»ä¸€ç™¾ç±»é‡Œé¢æ‰¾å‡ºæ¯ä¸€ç±»çš„æ¦‚ç‡å€¼ï¼Œç„¶åæŒ‰ç…§æ¦‚ç‡å€¼æ¥é¢„æµ‹è¾“å…¥æ•°æ®æ˜¯å“ªä¸€ç§ç±»å‹ï¼Œå°±åƒä¸Šä¸€æ¬¡æ–‡ç« é‡Œé¢çš„fashion-mnistçš„æ•°æ®ä¸€æ ·ï¼Œä¼šé¢„æµ‹å‡ºè¾“å‡ºçš„ç±»åˆ«ã€‚softmax(i)ä»£è¡¨çš„å°±æ˜¯è¿™ä¸ªç§ç±»çš„æ¦‚ç‡å€¼ï¼Œå–æœ€å¤§å€¼ä½œä¸ºé¢„æµ‹ç±»åˆ«ã€‚</li><li>ä½ å¯ä»¥æŠŠä¸€ä¸ªçŸ©é˜µçœ‹æˆä¸€ä¸ªæ•°æ®é›†åˆï¼Œä¸€è¡Œæ˜¯ä¸€ä¸ªæ•°æ®ä¿¡æ¯ï¼Œå°±å’Œæˆ‘ä»¬çš„å…³ç³»å‹æ•°æ®ä¸€æ ·ï¼Œä¸€è¡Œä»£è¡¨ä¸€ä¸ªè¡¨çš„ä¸€æ¡ä¿¡æ¯ï¼Œé‚£ä¹ˆæ¯åˆ—å°±æ˜¯æ¯ä¸€è¡Œæ•°æ®çš„ä¸€ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåœ¨æœºå™¨å­¦ä¹ é‡Œé¢å°±æ˜¯æ•°æ®çš„ç‰¹å¾äº†ï¼Œå› ä¸ºåœ¨ç½‘ç»œæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªç‰¹å¾éƒ½æœ‰å¯¹åº”çš„æƒé‡ï¼Œé‚£ä¹ˆï¼Œå¯¹äºæ¯ä¸ªç‰¹å¾æ¥è¯´ï¼Œå¯¹äºæœ€åçš„åˆ†ç±»ï¼Œè¯†åˆ«ç­‰å·¥ä½œèµ·çš„é‡è¦ç¨‹åº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™ä¹Ÿå’Œæˆ‘ä»¬çš„æ•°æ®åº“ä¿¡æ¯å·®ä¸å¤šï¼Œæœ‰ä¸€äº›ä¿¡æ¯ä¹Ÿæ˜¯æ— å…³ç´§è¦çš„ã€‚æœ‰äº›ä¿¡æ¯å¯ä»¥ä¸»è¦å†³å®šè¿™ä¸€è¡Œæ•°æ®ã€‚</li><li>ç¬¬äºŒå¤§ç±»å°±æ˜¯å›å½’ï¼Œå›å½’å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè¿ç»­çš„åˆ†ç±»ï¼Œå¯¹äºäºŒç»´æ•°æ®æ¥è¯´ï¼Œå…¶å®å°±æ˜¯æ ¹æ®ä½ ç»™å‡ºçš„æ•°æ®æ¥æ‹Ÿåˆä¸€æ¡çº¿ã€‚å¯¹äºä¸‰ç»´æ¥è®²å°±æ˜¯æ‹Ÿåˆä¸€ä¸ªå¹³é¢ã€‚å†é«˜ç»´å°±æ˜¯è¶…å¹³é¢ã€‚</li></ul></blockquote><ol start="2" type="1"><li>æœ€è¿‘ï¼Œä¹Ÿå°±æ˜¯2018å¹´3æœˆ31åœ¨åŠ åˆ©ç¦å°¼äºšå·å±±æ™¯åŸçš„è®¡ç®—æœºå†å²åšç‰©é¦†ä¸¾åŠäº†ç¬¬äºŒå±ŠTensorFlowå¼€å‘è€…å³°ä¼šï¼Œä¼šä¸Šæœ‰è¶…è¿‡500åä½¿ç”¨TensorFlowçš„ç”¨æˆ·ï¼Œè¿˜æœ‰ä¸€äº›è§‚ä¼—ï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥å…³æ³¨youtubeçš„TensorFlowå®˜æ–¹é¢‘é“ã€‚å¯ä»¥æŸ¥çœ‹å¼€ä¼šçš„è§†é¢‘ã€‚</li></ol><ul><li>TensorFlowåº”ç”¨å¹¿æ³›ï¼Œå…¶ä¸­æœ‰ä½¿ç”¨TensorFlowæ¥åšå¼€æ™®å‹’ä»»åŠ¡åˆ†æçš„</li><li>ä¹Ÿæœ‰ä½¿ç”¨TensorFlowé¢„æµ‹å¿ƒè„å‘ä½œå’Œä¸­é£æ¦‚ç‡</li><li>è¿˜æœ‰ä¸€äº›åº”ç”¨åœ¨ç°å®å½“ä¸­çš„é¡¹ç›®ã€‚</li><li>è¿™è®©æˆ‘ä»¬è®¤è¯†åˆ°TensorFlowå¯¹äºå®é™…é¢†åŸŸä¸­åº”ç”¨çš„è¶Šæ¥è¶Šå¹¿æ³›ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å­¦ä¹ æ˜¯ä¸æ˜¯æœ‰ç‚¹äºã€‚è¿™ä¹ˆå¥½çš„å¼€æºé¡¹ç›®ã€‚</li></ul><ol start="3" type="1"><li>ä¸Šä¸€æ¬¡æˆ‘ä»¬æ—¢ç„¶åšè¿‡äº†ä¸€æ¬¡æœè£…ç±»åˆ«è¯†åˆ«ï¼Œé‚£ä¹ˆè¿™æ¬¡æˆ‘ä¸»è¦ä»TensorFlowå»ºç«‹æ¨¡å‹çš„æ­¥éª¤è®²èµ·ï¼šè®©å¤§å®¶å†æ·±å…¥ç†è§£ä¸€ä¸‹TensorFlowã€‚</li></ol><ul><li>ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œé‚£å°±æ˜¯å¯¼å…¥æ•°æ®ã€‚</li><li>ç¬¬äºŒæ­¥ä¸€èˆ¬å°±æ˜¯å¯¹æ•°æ®è¿›è¡Œçš„é¢„å¤„ç†ï¼Œä¸€èˆ¬åŒ…æ‹¬å½’ä¸€åŒ–æ•°æ®ï¼Œè½¬æ¢æ•°æ®ç­‰æ“ä½œã€‚</li><li>ç¬¬ä¸‰æ­¥è®¾ç½®ç®—æ³•çš„è¶…å‚æ•°ï¼Œä¸€èˆ¬ä¹Ÿå°±æ˜¯å­¦ä¹ ç‡ï¼Œbatch_size(æ‰¹å¤„ç†ä¸ªæ•°)ï¼Œepoch(è½®æ¬¡)ã€‚è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡å¦‚ä½ æœ‰10000æ¡è®­ç»ƒæ•°æ®ã€‚é‚£ä¹ˆï¼Œbatch_sizeè®¾ç½®ä¸º100ï¼Œé‚£ä¹ˆä½ çš„ä¸€ä¸ªepochå°±è¿­ä»£100æ¬¡æ‰èƒ½å°†æ‰€æœ‰æ•°æ®è®­ç»ƒä¸€éï¼Œæ¯æ¬¡è¾“å…¥æ•°æ®æ˜¯100æ¡ï¼Œå› ä¸ºä¸€ä¸ªepochçš„æ„æ€å°±æ˜¯è®­ç»ƒå®Œä¸€æ¬¡è®­ç»ƒæ•°æ®ï¼Œæ‰€ä»¥ä¸€ä¸ªepochæ˜¯è¿­ä»£100æ¬¡å°±å¯ä»¥ç»“æŸä¸€è½®äº†ã€‚learning_rateä¸€èˆ¬è®¾ç½®ä¸º0.1-0.0001ä¹‹é—´ï¼Œä½†æ˜¯ä¹Ÿä¸æ’é™¤ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œä¸»è¦æ˜¯learning_rateè®¾ç½®çš„è¿‡å°ï¼Œåå‘ä¼ æ’­æ›´æ–°å‚æ•°çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œè®¾ç½®çš„è¿‡å¤§ï¼Œä¼šå‡ºç°æ— æ³•æ”¶æ•›çš„æƒ…å†µã€‚</li><li>ç¬¬å››æ­¥è®¾ç½®å˜é‡å’Œplaceholdersï¼Œå˜é‡æ˜¯è®°å½•æƒé‡å’Œåç½®é¡¹ä¿¡æ¯çš„ï¼Œä¸€èˆ¬åœ¨æœ€å°åŒ–losså‡½æ•°çš„æ—¶å€™ï¼Œåå‘ä¼ æ’­ç®—æ³•ä¼šæ›´æ–°æƒé‡å’Œåç½®é¡¹ï¼ŒTensorFlowå¯¼å…¥æ•°æ®æ˜¯é€šè¿‡placeholdersæ¥å®ç°çš„ï¼Œå¤§å®¶è¿˜è®°å¾—æˆ‘ä»¬ä¸Šæ¬¡çš„fashion-mnistè¯†åˆ«ï¼Œæˆ‘çš„æ•°æ®å°±æ˜¯é€šè¿‡å…ˆå®šä¹‰placeholdersï¼Œæœ€ååœ¨Sessionè¿è¡Œçš„æ—¶å€™ï¼Œåœ¨feed_dictè¿™ä¸ªå­—å…¸å‚æ•°é‡Œé¢å°†è®­ç»ƒæ•°æ®å–‚è¿›å»çš„ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a_var = tf.constant(<span class="number">42</span>)</span><br><span class="line">x_input = tf.placeholder(tf.float32, [n_x, <span class="keyword">None</span>], name=<span class="string">"X"</span>)</span><br><span class="line">x_output = tf.placeholder(tf.float32, [n_y, <span class="keyword">None</span>], name=<span class="string">"y"</span>)</span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®çš„ä¸€äº›æ–¹å¼</span></span><br></pre></td></tr></table></figure><ul><li>ç¬¬äº”æ­¥å®šä¹‰å›¾æ¨¡å‹ï¼Œæˆ‘ä»¬æœ‰äº†æ•°æ®ï¼Œåˆå§‹åŒ–äº†å˜é‡å’Œplaceholdersï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å®šä¹‰ä¸€ä¸ªå›¾æ¨¡å‹ï¼Œæ¥ç”ŸæˆTensorFlowçš„å›¾æ¨¡å‹ï¼ˆè®¡ç®—å›¾ï¼‰æˆ‘ä»¬å¿…é¡»å‘Šè¯‰TensorFlowå¯¹æˆ‘ä»¬çš„æ•°æ®è¿›è¡Œå“ªäº›æ“ä½œï¼Œæ¥è®©æˆ‘ä»¬çš„æ¨¡å‹å…·æœ‰é¢„æµ‹èƒ½åŠ›ï¼ˆæ›´åŠ æ·±å…¥çš„è¿ç®—æˆ‘ä»¬åœ¨åç»­çš„åšå®¢é‡Œé¢ä¼šé™†ç»­è®²åˆ°ï¼‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h_pre_output = tf.add(tf.matmul(W, x_input) + B)</span><br></pre></td></tr></table></figure><ul><li>ç¬¬å…­æ­¥å£°æ˜losså‡½æ•°ï¼Œåœ¨ä¸Šé¢è®¡ç®—å›¾ä¸­æˆ‘ä»¬å®šä¹‰äº†ä¸€äº›å¯¹æˆ‘ä»¬æ•°æ®çš„æ“ä½œã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦éªŒè¯æˆ‘ä»¬é¢„æµ‹çš„è¾“å‡ºï¼Œå’Œæˆ‘ä»¬çœŸå®ä¹‹é—´çš„å·®è·ï¼Œä¸€èˆ¬å¯¹äºå›å½’ä»»åŠ¡æ¥è®²çš„è¯ï¼Œå°±æ˜¯å¹³æ–¹è¯¯å·®ï¼šè¿™æ ·å°±æ±‚å¾—äº†å¹³æ–¹è¯¯å·®ã€‚ä½†æ˜¯å¯¹äºåˆ†ç±»ä»»åŠ¡ï¼Œé‚£å°±æ˜¯äº¤å‰ç†µè¯¯å·®ã€‚å°±åƒä¸Šä¸€èŠ‚æˆ‘ä»¬ç”¨åˆ°çš„lossç”Ÿæˆå‡½æ•°å°±æ˜¯softmaxè¿™ç§æ–¹å¼ã€‚ï¼Œäº¤å‰ç†µçš„å…¬å¼åç»­ç”¨åˆ°å†ç»™å¤§å®¶ä»‹ç»ã€‚</li></ul><p><span class="math display">\[loss(i)=\frac{1}{N}\sum{_i}(y\_pre_i-y\_true_i)^2\]</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TensorFlowæ±‚æ³•ï¼š</span><br><span class="line">loss = tf.reduce_mean(tf.square(y_pre - y_true))</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸ƒæ­¥å£°æ˜äº†losså‡½æ•°ä»¥åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨BPç®—æ³•ä¹Ÿå°±æ˜¯åå‘ä¼ æ’­ç®—æ³•æ¥æ›´æ–°æƒé‡å’Œåç½®é¡¹ã€‚åœ¨TenorFlowæ¡†æ¶é‡Œé¢æœ‰å¥½å¤šè¿™æ ·çš„ä¼˜åŒ–å™¨ï¼Œéƒ½åœ¨ tf.trainè¿™ä¸ªæ¨¡å—é‡Œé¢ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">optimizer = tf.train.AdamOptimizer(learning_rate = <span class="number">0.001</span>).minimize(loss)</span><br><span class="line">è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¸Šæ¬¡ä½¿ç”¨çš„ä¼˜åŒ–å™¨ï¼Œæ¥ä¼˜åŒ–æˆ‘ä»¬çš„loss</span><br></pre></td></tr></table></figure><ul><li>æœ€åä¸€æ­¥é‚£å°±æ˜¯åˆå§‹åŒ–ä¼šè¯Session()ï¼Œå¼€å§‹è®­ç»ƒæ¨¡å‹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> session:</span><br><span class="line">session.run(init)</span><br><span class="line">.....</span><br></pre></td></tr></table></figure><ol start="4" type="1"><li>ç”±ä¸Šé¢çš„æ­¥éª¤ï¼Œå¤§å®¶å†ç»“åˆä¸Šä¸€æ¬¡çš„ç½‘ç»œä»£ç ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£äº†TensorFlowåœ¨å»ºç«‹ä¸€ä¸ªç½‘ç»œæ¨¡å‹çš„æ—¶å€™çš„å…·ä½“æ­¥éª¤ã€‚</li><li>å…¶å®åœ¨TensorFlowä¸­è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯Tensorï¼Œä¸Šæ¬¡è¯´è¿‡äº†å®ƒçš„æ¦‚å¿µï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘è®²ä¸€ä¸‹TensorFlowé‡Œé¢çš„Tensorã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªä¼šè¯ï¼Œè®°å¾—ï¼ŒTensorFlowé‡Œé¢éƒ½æ˜¯é€šè¿‡sessionæ¥æ‰§è¡Œçš„</span></span><br><span class="line">sess = tf.Session()</span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª1 * 20çš„å‘é‡</span></span><br><span class="line">tensor_zeros = tf.zeros([<span class="number">1</span>, <span class="number">20</span>])</span><br><span class="line">sess.run(tensor_zeros) <span class="comment"># ä½ å¯ä»¥è¿è¡Œä¸€ä¸‹çœ‹çœ‹</span></span><br><span class="line">my_var = tf.Variable(tf.zeros([<span class="number">1</span>, <span class="number">20</span>])) <span class="comment"># ä½¿ç”¨tensoæ¥åˆå§‹åŒ–å˜é‡</span></span><br><span class="line">sess.run(my_var.initializer) <span class="comment"># åˆä¸€ç§è¿è¡Œå˜é‡åˆå§‹åŒ–å™¨çš„æ–¹å¼</span></span><br><span class="line">sess.run(my_var) <span class="comment">#æ‰“å°å‡ºæ¥çœ‹çœ‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tf.ones() ç”Ÿæˆå…¨æ˜¯1</span></span><br><span class="line"><span class="comment"># tf.zeros() ç”Ÿæˆå…¨æ˜¯0</span></span><br><span class="line"><span class="comment"># tf.constant() ç”Ÿæˆä¸€ä¸ªå¸¸é‡Tensor</span></span><br><span class="line"><span class="comment"># å¦‚æœæˆ‘ä»¬æƒ³è¦é€šè¿‡ä¸€ä¸ªå·²çŸ¥çš„Tensoræ¥åˆ›å»ºå¦ä¸€ä¸ªï¼Œåˆ™å¯ä»¥ä½¿ç”¨ones_like()å’Œzeros_like()è¿™ä¸¤ä¸ªå‡½æ•°</span></span><br><span class="line">zero_similar = tf.Variable(tf.zeros_like(tensor_zeros))</span><br><span class="line"></span><br><span class="line">sess.run(zero_similar.initializer)</span><br><span class="line">print(sess.run(zero_similar))</span><br><span class="line"><span class="comment"># æ³¨æ„ä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ä¸ºäº†ç¡®å®šç”ŸæˆTensorçš„å¤§å°ï¼Œè€Œäº§ç”Ÿçš„å€¼æ˜¯é€šè¿‡å‡½æ•°å†³å®šçš„</span></span><br><span class="line">tf.fill([row, col], <span class="number">-1</span>)  <span class="comment"># ç”¨å…·ä½“çš„æ•°å­—å¡«å……</span></span><br><span class="line">tf.linspace(start=<span class="number">0.0</span>, stop=<span class="number">1.0</span>, num=<span class="number">3</span>) <span class="comment"># çº¿æ€§åˆ†å¸ƒ åŒ…æ‹¬end</span></span><br><span class="line">tf.range(start=<span class="number">6</span>, limit=<span class="number">15</span>, delta=<span class="number">3</span>)    <span class="comment"># ä¹Ÿæ˜¯çº¿æ€§å‡åŒ€ ä¸åŒ…æ‹¬end</span></span><br><span class="line">tf.random_normal([row_dim, col_dim], mean=<span class="number">0.0</span>, stddev=<span class="number">1.0</span>) <span class="comment"># éšæœº å‡å€¼0 æ–¹å·®1.0</span></span><br><span class="line">tf.random_uniform([row_dim, col_dim], minval=<span class="number">0</span>, maxval=<span class="number">4</span>) <span class="comment"># æˆ–è€…æœ€å°æœ€å¤§å€¼éšæœºåˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.python.framework <span class="keyword">import</span> ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line">my_var = tf.Variable(tf.zeros([<span class="number">1</span>,<span class="number">20</span>]))</span><br><span class="line"></span><br><span class="line">merged = tf.summary.merge_all()</span><br><span class="line"></span><br><span class="line">writer = tf.summary.FileWriter(<span class="string">"./tmp/variable_logs"</span>, graph=sess.graph)</span><br><span class="line"></span><br><span class="line">initialize_op = tf.global_variables_initializer()</span><br><span class="line"></span><br><span class="line">sess.run(initialize_op)</span><br><span class="line"><span class="comment"># ä¸Šé¢çš„å°±æ˜¯ä¸€ä¸ªTensoræ”¾åœ¨ä¸€ä¸ªå˜é‡é‡Œé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€æ¡è¯­å¥ merged = tf.summary.merge_all() è¿˜æœ‰writer = tf.summary.FileWriter("/tmp/variable_logs", graph=sess.graph)ï¼Œè¿™ä¸¤å¥è¿™æ˜¯ä¸ºäº†å°†å˜é‡åœ¨TensorBoardé‡Œé¢æ˜¾ç¤ºå‡ºæ¥ï¼Œè®©æˆ‘ä»¬æ›´åŠ äº†è§£TensorFLowçš„ä¸€äº›æ“ä½œã€‚</span></span><br><span class="line"><span class="comment"># ä¸Šé¢çš„æ“ä½œè¿‡ç¨‹ä¼šåœ¨å½“å‰æ–‡ä»¶å¤¹é‡Œé¢åˆ›å»ºä¸€ä¸ª/tmp/variable_logsæ–‡ä»¶å¤¹ç„¶åä¼šå°†å˜é‡ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢</span></span><br></pre></td></tr></table></figure><ol start="6" type="1"><li>é‚£æ€ä¹ˆä½¿ç”¨tensorboard</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#è¿›å»æˆ‘ä»¬çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åæ‰§è¡Œ</span><br><span class="line">tensorboard --logdir=tmpçš„ç»å¯¹è·¯å¾„</span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2018/04/01/9zF2P1.png" alt="-"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä¸Šé¢æ‰§è¡Œçš„å‘½ä»¤ã€‚ç„¶ååœ¨æµè§ˆå™¨é‡Œé¢è¾“å…¥127.0.0.1:6006ç„¶åä½ å°±å¯ä»¥çœ‹åˆ°åˆšæ‰é‚£ä¸ªå˜é‡çš„æ“ä½œè¿‡ç¨‹ï¼Œè¿™å°±æ˜¯tensorboardçš„é­…åŠ›</p><p><img src="https://s1.ax1x.com/2018/04/01/9zF7ad.png" alt="-"></p><p>ä¸Šé¢å°±æ˜¯ä¸€ä¸ªå˜é‡åœ¨è¿›è¡Œåˆå§‹åŒ–æ—¶å€™å¯è§†åŒ–æ˜¾ç¤º</p><ol start="7" type="1"><li>Placeholdersä½¿ç”¨(ä¸€æ ·å¯ä»¥ä½¿ç”¨tensorboardæ¥æŸ¥çœ‹)</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">import tensorflow as tf</span><br><span class="line">from tensorflow.python.framework import ops</span><br><span class="line">ops.reset_default_graph()</span><br><span class="line">sess = tf.Session()</span><br><span class="line"># å®šä¹‰ä¸€ä¸ªplaceholder</span><br><span class="line">x = tf.placeholder(tf.float32, shape = (4, 4))</span><br><span class="line"></span><br><span class="line"># éšæœºç”Ÿæˆ4 * 4çš„çŸ©é˜µ</span><br><span class="line">reand_array = np.random.rand(4, 4)</span><br><span class="line">y = tf.identity(x) # è¿”å›ä¸è¾“å…¥å¯¹è±¡ç›¸åŒçš„å†…å®¹å’Œå¤§å°</span><br><span class="line">print(sess.run(y, feed_dict=&#123;x: rand_array&#125;))</span><br><span class="line"></span><br><span class="line">merged = tf.summary.merge_all()</span><br><span class="line">writer = tf.summary.FileWriter(&quot;./tmp/variable_logs&quot;, sess.graph)</span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2018/04/01/9zAshR.png" alt="-"></p><h5 id="æ€»ç»“">æ€»ç»“</h5><p>è¿™æ¬¡æˆ‘ä»¬å°±TensorFlowçš„ä¸€äº›åŸºç¡€æ¦‚å¿µçš„ä»‹ç»ï¼Œä¹Ÿæ˜¯ä¸ºäº†è®©å¤§å®¶åœ¨ä»¥åçš„TensorFlowä½¿ç”¨è¿‡ç¨‹ä¸­å°‘ä¸€äº›ç–‘é—®ï¼Œåé¢çš„ç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šæ…¢æ…¢æ·±å…¥ã€‚å°ä¼™ä¼´ä»¬ä¸è¦ç€æ€¥ï¼Œæˆ‘çš„é‚®ç®±æ˜¯air@weaf.topï¼Œä¾æ—§æ˜¯é‚£ä¸ªå¯ä»¥äº¤æµå­¦ä¹ çš„milittleã€‚è°¢è°¢å¤§å®¶çš„é©»è¶³ã€‚</p><p><a href="https://weaf.top/posts/8e8e4531/" target="_blank" rel="noopener">ç¬¬ä¸€ç¯‡ TensorFlowå®‰è£…</a></p><p><a href="https://weaf.top/posts/b0821049/" target="_blank" rel="noopener">ç¬¬äºŒç¯‡ TensorFlowåˆä½“éªŒï¼ˆfasion-mnistè¯†åˆ«ï¼‰</a></p><p><a href="https://weaf.top/posts/233074e6/" target="_blank" rel="noopener">ä¿®æ”¹pipå…¨å±€é•œåƒæ–¹æ³•</a></p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-å»ºç«‹ç½‘ç»œæ¨¡å‹&quot;&gt;TensorFlow
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆä¸‰ï¼‰æ„å»ºè¯è¢‹ç©ºé—´VSMï¼ˆVector Space Modelï¼‰</title>
    <link href="http://weafteam.github.io/posts/a751f7e5/"/>
    <id>http://weafteam.github.io/posts/a751f7e5/</id>
    <published>2018-03-30T06:00:08.000Z</published>
    <updated>2018-05-29T01:27:49.814Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å’±ä»¬ä»Šå¤©å…ˆèŠä¸ªæ¦‚å¿µå§ï¼Œè‘—åçš„èšç±»å‡è®¾ï¼Œè¿™ä¹Ÿæ˜¯æ–‡æœ¬èšç±»çš„ä¾æ®ï¼Œå†…å®¹å¦‚ä¸‹ï¼šè¯¥å‡è®¾è®¤ä¸ºï¼ŒåŒç±»çš„æ–‡æ¡£ç›¸ä¼¼åº¦è¾ƒå¤§ï¼Œè€Œä¸åŒç±»çš„æ–‡æ¡£ç›¸ä¼¼åº¦è¾ƒå°ã€‚</p></blockquote><hr><h1 id="æ¦‚å¿µ">æ¦‚å¿µï¼š</h1><p>å¯¹äºä¸Šè¿°æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯åšæ–‡æœ¬èšç±»çš„åŸºç¡€ï¼Œå¦‚æœä¸ç›¸å…³çš„æ–‡æ¡£åè€Œç›¸ä¼¼åº¦é«˜ï¼Œæˆ‘ä»¬ä¾¿æ— æ³•åšæ–‡æœ¬èšç±»ã€‚</p><p>æ¥ä¸‹æ¥å†è¯´VSM(Vector Space Model),å¯¹äºVSMçš„å®šä¹‰ï¼Œæˆ‘åœ¨ç½‘ä¸Šæœç½—äº†äº›èµ„æ–™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>Vector space model (or term vector model) is an algebraic model for representing text documents (and any objects, in general) as vectors of identifiers, such as, for example, index terms. It is used in information filtering, information retrieval, indexing and relevancy rankings. Its first use was in the SMART Information Retrieval System.</p><p>A document is represented as a vector. Each dimension corresponds to a separate term. If a term occurs in the document, its value in the vector is non-zero. Several different ways of computing these values, also known as (term) weights, have been developed. One of the best known schemes is tf-idf weighting.</p><p>The definition of term depends on the application. Typically terms are single words, keywords, or longer phrases. If the words are chosen to be the terms, the dimensionality of the vector is the number of words in the vocabulary (the number of distinct words occurring in the corpus).</p><p><strong>æ‹™åŠ£çš„ç¿»è¯‘ï¼š</strong></p><p>å‘é‡ç©ºé—´æ¨¡å‹æ˜¯ç”¨æ¥è¡¨ç¤ºæ–‡æœ¬æ–‡æ¡£ï¼ˆé€šå¸¸ä¹ŸåŒ…å«ä¸€äº›å¯¹è±¡ï¼‰çš„ç‰¹å¾å‘é‡çš„ä»£æ•°æ¨¡å‹ï¼Œä¾‹å¦‚ç´¢å¼•è¯é¡¹ã€‚å®ƒè¢«åº”ç”¨äºä¿¡æ¯è¿‡æ»¤ã€ä¿¡æ¯æ£€ç´¢ã€ç´¢å¼•å’Œç›¸å…³åº¦è®¡ç®—ã€‚è¿™ä¸ªæ¨¡å‹æœ€æ—©è¢«åº”ç”¨äºSMARTä¿¡æ¯æ£€ç´¢ç³»ç»Ÿã€‚</p><p>ä¸€ä¸ªæ–‡æœ¬æ–‡æ¡£è¡¨ç¤ºä¸€ä¸ªå‘é‡ã€‚æ¯ä¸€ä¸ªç»´åº¦ç›¸å½“äºä¸€ä¸ªå•ç‹¬çš„è¯é¡¹ï¼ˆtermï¼‰ã€‚å¦‚æœä¸€ä¸ªè¯é¡¹ï¼ˆtermï¼‰å‡ºç°åœ¨ä¸€ä¸ªæ–‡æ¡£ä¸­ï¼Œé‚£ä¹ˆå®ƒåœ¨è¡¨ç¤ºè¯¥æ–‡æ¡£çš„å‘é‡ä¸­å¯¹åº”é¡¹ä¸ä¸º0.æœ‰ä¸€äº›è®¡ç®—è¿™äº›è¯é¡¹ï¼ˆtermï¼‰æƒé‡çš„æ–¹æ³•è¢«é€æ¸æå‡ºæ¥ï¼Œå…¶ä¸­æœ€è‘—åçš„æ–¹æ³•å°±æ˜¯tf-idfæƒé‡è®¡ç®—æ–¹æ³•ã€‚</p><p>å¯¹äºè¯é¡¹ï¼ˆtermï¼‰çš„å®šä¹‰ä¾èµ–äºåº”ç”¨ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œè¯é¡¹ï¼ˆtermï¼‰å¯ä»¥æ˜¯å•è¯ã€å…³é”®å­—ã€æˆ–è€…é•¿çŸ­è¯­ã€‚å¦‚æœå•è¯ä½œä¸ºè¯é¡¹ï¼ˆtermï¼‰ï¼Œé‚£ä¹ˆå‘é‡ä¸­çš„ç»´åº¦å°±æ˜¯è¯æ±‡è¡¨ä¸­çš„å•è¯çš„ä¸ªæ•°ï¼ˆå‡ºç°åœ¨æ–‡æ¡£å…¨é›†ä¸­æ‰€æœ‰ä¸åŒçš„å•è¯çš„æ•°é‡ï¼‰ã€‚</p><p><strong>å°è”æï¼š</strong></p><p>ä¸¾ä¸ªè”æå§ ï¼Œæ–¹ä¾¿ç†è§£ä¸Šè¿°çš„æ¦‚å¿µã€‚é¦–å…ˆå‡è®¾æœ‰è¿™æ ·ä¸¤ä¸ªæ–‡æœ¬</p><p>1.<code>æˆ‘æ¥åˆ°åŒ—äº¬æ¸…åå¤§å­¦</code></p><p>2.<code>ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦</code></p><p>åˆ†è¯ç»“æœä¸ºï¼š<code>æˆ‘/æ¥åˆ°/åŒ—äº¬/æ¸…åå¤§å­¦</code>å’Œ<code>ä»–/æ¥åˆ°/äº†/ç½‘æ˜“/æ­ç ”/å¤§å¦</code>ç»Ÿè®¡æ‰€æœ‰æ–‡æ¡£çš„è¯é›†åˆï¼š<code>æˆ‘/æ¥åˆ°/åŒ—äº¬/æ¸…åå¤§å­¦/ä»–/äº†/ç½‘æ˜“/æ­ç ”/å¤§å¦</code>ï¼ŒæŒ‰ç…§1983åœç”¨è¯å»é™¤åœç”¨è¯åç»“æœä¸ºï¼š<code>æ¥åˆ°/åŒ—äº¬/æ¸…åå¤§å­¦/ç½‘æ˜“/æ­ç ”/å¤§å¦</code></p><p>æˆ‘ä»¬å¯¹è¿™ä¸¤ä¸ªæ–‡æœ¬æ„å»ºå‘é‡ï¼Œç»“æœå¦‚ä¸‹</p><table><thead><tr class="header"><th></th><th>æ¥åˆ°</th><th>åŒ—äº¬</th><th>æ¸…åå¤§å­¦</th><th>ç½‘æ˜“</th><th>æ­ç ”</th><th>å¤§å¦</th></tr></thead><tbody><tr class="odd"><td>æ–‡æœ¬1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr class="even"><td>æ–‡æœ¬2</td><td>1</td><td>0</td><td>0</td><td>1</td><td>1</td><td>1</td></tr></tbody></table><p>ç›¸ä¿¡ä½ å·²ç»å¯¹VSMçš„è®¤è¯†æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„è½®å»“ï¼Œä½†æ˜¯ç»†å¿ƒçš„ä½ ä¹Ÿå¯èƒ½å‘ç°äº†ï¼Œæˆ‘ä»¬åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­è®¡ç®—termå€¼çš„æ–¹æ³•ä»…ä»…åªæ˜¯è®¡æ•°ï¼Œè¿™æ ·çš„termå€¼æ˜¯å¦æœ‰æ„ä¹‰å‘¢ï¼Ÿæˆ‘ä»¬æ˜¯å¦èƒ½ç”¨è¿™æ ·çš„æ–¹æ³•ç›´æ¥è¿›è¡Œæ¥ä¸‹æ¥çš„è®¡ç®—å‘¢ï¼Ÿå¯¹äºå‰ä¸€ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ä¸ç®¡åœ¨æ­¤åŸºç¡€ä¸Šåšä»€ä¹ˆæ ·çš„æ”¹è¿›ï¼Œæˆ‘ä»¬æœ€åŸºç¡€çš„å°±æ˜¯ç»Ÿè®¡å•è¯å‡ºç°çš„æ¬¡æ•°ï¼Œé‚£å°±è®©æˆ‘ä»¬å…ˆæŠŠä¸Šè¿°çš„ä»£ç å®ç°ä¸€ä¸‹å§(ä¸è¯¥æ–‡ä»¶åŒç›®å½•ä¸‹æœ‰ä¸ªåä¸ºtxt1çš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰1.txtå’Œ2.txtä¸¤ä¸ªæ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«æ˜¯ä¸Šè¿°æ‰€è¯´çš„ä¸¤ä¸ªæ–‡æ¡£ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ¬¡RmStopWord.pyçš„åŸºç¡€ä¸Šå†åšä¿®æ”¹)ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">d = path.dirname(__file__) <span class="comment"># è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„</span></span><br><span class="line">stopwords_path = <span class="string">'stopwords1893.txt'</span>  <span class="comment"># åœç”¨è¯è¡¨è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#text = open(path.join(d, text_path),'rb').read()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_from_file</span><span class="params">(file_name)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(file_name,<span class="string">"r"</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        words = fp.read()</span><br><span class="line">    <span class="keyword">return</span> words</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RmStopWords</span><span class="params">(text)</span>:</span></span><br><span class="line">    mywordlist = []</span><br><span class="line">    seg_list = jieba.cut(text, cut_all=<span class="keyword">False</span>)</span><br><span class="line">    liststr=<span class="string">"/ "</span>.join(seg_list) <span class="comment"># æ·»åŠ åˆ‡åˆ†ç¬¦</span></span><br><span class="line">    f_stop = open(stopwords_path)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f_stop_text = f_stop.read()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        f_stop.close( )</span><br><span class="line">    f_stop_seg_list=f_stop_text.split(<span class="string">'\n'</span>) <span class="comment"># åœç”¨è¯æ˜¯æ¯è¡Œä¸€ä¸ªï¼Œæ‰€ä»¥ç”¨/nåˆ†ç¦»</span></span><br><span class="line">    <span class="keyword">for</span> myword <span class="keyword">in</span> liststr.split(<span class="string">'/'</span>):</span><br><span class="line">        <span class="comment">#å¯¹äºæ¯ä¸ªåˆ‡åˆ†çš„è¯éƒ½å»åœç”¨è¯è¡¨ä¸­å¯¹æ¯”</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span>(myword.strip() <span class="keyword">in</span> f_stop_seg_list) <span class="keyword">and</span> len(myword.strip())&gt;<span class="number">1</span>:</span><br><span class="line">            mywordlist.append(myword)</span><br><span class="line">    <span class="keyword">return</span> mywordlist</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_vector</span><span class="params">(file_path)</span>:</span></span><br><span class="line">    names = [ os.path.join(file_path,f) <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(file_path) ]</span><br><span class="line">    txts = [ open(name).read() <span class="keyword">for</span> name <span class="keyword">in</span> names]</span><br><span class="line">    docs = []</span><br><span class="line">    word_set = set()</span><br><span class="line">    <span class="keyword">for</span> txt <span class="keyword">in</span> txts:</span><br><span class="line">        doc = RmStopWords(txt)</span><br><span class="line">        docs.append(doc)</span><br><span class="line">        word_set |= set(doc)</span><br><span class="line">        </span><br><span class="line">    word_set = list(word_set)</span><br><span class="line">    docs_vsm = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œåªæ˜¯æƒ³æ˜¾ç¤ºæœ‰å¤šå°‘term</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> word_set[:<span class="number">30</span>]:</span><br><span class="line">        print(word)</span><br><span class="line">    <span class="keyword">for</span> doc <span class="keyword">in</span> docs:</span><br><span class="line">        temp_vector = []</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> word_set:</span><br><span class="line">            temp_vector.append(doc.count(word) * <span class="number">1.0</span>)</span><br><span class="line">        docs_vsm.append(temp_vector)</span><br><span class="line">    docs_matrix = np.array(docs_vsm)</span><br><span class="line">    <span class="keyword">return</span> docs_matrix</span><br><span class="line">    </span><br><span class="line"><span class="comment"># txt2 = RmStopWords(read_from_file(text1_path))</span></span><br><span class="line"><span class="comment"># print(txt2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ–‡ä»¶è·¯å¾„ä¸ºtxt1/1.txtå’Œ2.txtï¼Œåªä¸è¿‡æˆ‘è®©ç¨‹åºå¾ªç¯æ‰«ætxt1ä¸‹æ‰€æœ‰çš„æ–‡æœ¬æ–‡ä»¶</span></span><br><span class="line">txt3 = get_all_vector(<span class="string">'txt1'</span>)</span><br><span class="line">print(txt3)</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œç»“æœï¼š</strong></p><p><a href="https://imgchr.com/i/9x712t" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2018/03/31/9x712t.png" alt="vsmResult.png"></a></p><p><strong>åˆ†æï¼š</strong></p><p>ä¸Šè¿°ç»“æœä¸è¨€è€Œå–»ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç€è®¨è®ºï¼Œæ˜¾è€Œæ˜“è§ï¼Œæˆ‘æ—¢ç„¶æå‡ºäº†ç¬¬äºŒä¸ªç–‘é—®å°±ä¸€å®šæœ‰å®ƒè¢«æå‡ºçš„é“ç†ï¼Œä»…ä»…åªè®¡ç®—termå€¼çš„æ–¹æ³•æ˜¾ç„¶å­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä»¬å†éšä¾¿ä¸¾ä¸ªä¾‹å­ï¼Œæ–‡æœ¬1ä¸­<code>åŒ—äº¬</code>åªå‡ºç°äº†1æ¬¡ï¼Œä½†æ˜¯æ–‡æœ¬1ä¸­åªæœ‰3ä¸ªå•è¯ï¼Œæ–‡æœ¬2ä¸­<code>åŒ—äº¬</code>å‡ºç°äº†10æ¬¡ä½†æ˜¯æ–‡æœ¬2ä¸­æœ‰1000ä¸ªå•è¯ï¼Œé‚£æˆ‘ä»¬ç”¨ä¸Šè¿°çš„æ–¹æ³•æ˜¾ç„¶ä¸åˆé€‚ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿è¦è®²ä¸€ä¸ªæœ€è‘—åçš„æ–¹æ³•tf-idfè®¡ç®—æƒå€¼çš„æ–¹æ³•ã€‚</p><h1 id="tf-idfterm-frequencyinverse-document-frequency">TF-IDF(term frequencyâ€“inverse document frequency)</h1><p>ç»´åŸºç™¾ç§‘å’Œç™¾åº¦ç™¾ç§‘ä¸Šçš„è®²çš„å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œæˆªå–æ¦‚å¿µæ–¹ä¾¿å¤§å®¶é˜…è¯»ï¼Œæ›´è¯¦ç»†çš„å†…å®¹è¯·å‚è€ƒå‰é¢æ‰€è¯´çš„ä¸¤ä¸ªç™¾ç§‘ã€‚</p><p><strong>TF-IDFæ˜¯ä¸€ç§ç»Ÿè®¡æ–¹æ³•ï¼Œç”¨ä»¥è¯„ä¼°ä¸€ä¸ªè¯(term)å¯¹äºä¸€ä¸ªæ–‡ä»¶é›†æˆ–è€…ä¸€ä¸ªè¯­æ–™åº“ä¸­çš„ä¸€ä»½æ–‡ä»¶çš„é‡è¦ç¨‹åº¦ã€‚ä¸€ä¸ªè¯(term)çš„é‡è¦æ€§éšç€å®ƒåœ¨æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°æˆæ­£æ¯”å¢åŠ ï¼Œä½†åŒæ—¶ä¼šéšç€å®ƒåœ¨è¯­æ–™åº“ä¸­å‡ºç°çš„é¢‘ç‡æˆåæ¯”ä¸‹é™ã€‚</strong></p><p><strong>åŸç†ï¼š</strong></p><p>TF-IDFçš„ä¸»è¦æ€æƒ³æ˜¯ï¼šå¦‚æœæŸä¸ªè¯æˆ–çŸ­è¯­(term)åœ¨ä¸€ç¯‡æ–‡ç« ä¸­å‡ºç°çš„é¢‘ç‡TFé«˜ï¼Œå¹¶ä¸”åœ¨å…¶ä»–æ–‡ç« ä¸­å¾ˆå°‘å‡ºç°ï¼Œåˆ™è®¤ä¸ºæ­¤è¯æˆ–è€…çŸ­è¯­(term)å…·æœ‰å¾ˆå¥½çš„ç±»åˆ«åŒºåˆ†èƒ½åŠ›ï¼Œé€‚åˆç”¨æ¥åˆ†ç±»ã€‚å¦‚æœåŒ…å«è¯æ¡termçš„æ–‡æ¡£è¶Šå°‘ï¼Œä¹Ÿå°±æ˜¯nè¶Šå°ï¼Œåˆ™IDFè¶Šå¤§ï¼Œåˆ™è¯´æ˜è¯æ¡termä¹Ÿå…·æœ‰å¾ˆå¥½çš„ç±»åˆ«åŒºåˆ†èƒ½åŠ›ã€‚</p><p><strong>æ€è€ƒï¼š</strong></p><p>ç°åœ¨æƒ³ä¸€ä¸‹æˆ‘ä»¬åˆšæ‰æå‡ºçš„é—®é¢˜ï¼Œé’ˆå¯¹æˆ‘ä»¬ä¸Šè¿°çš„é—®é¢˜ï¼šåŒä¸€è¯è¯­åœ¨é•¿æ–‡ä»¶é‡Œå¯èƒ½ä¼šæ¯”çŸ­æ–‡ä»¶æœ‰æ›´é«˜çš„è¯æ•°ï¼Œè€Œä¸ç®¡è¯¥è¯é‡è¦ä¸å¦ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯¹è¯æ•°åšå½’ä¸€åŒ–å°±å¯ä»¥äº†ï¼Œè€ŒTFå°±å¸®æˆ‘ä»¬åšäº†è¿™æ ·çš„äº‹ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å…ˆç»™å‡ºTFçš„è¿ç®—å…¬å¼å§ã€‚</p><p><span class="math inline">\(tf_i,_j = \frac{n_i,_j}{\sum_k n_k,_j}\)</span></p><p>TFå…¬å¼è§£è¯»ï¼šä¸Šå¼ä¸­åˆ†å­æ˜¯è¯¥è¯åœ¨æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œè€Œåˆ†æ¯åˆ™æ˜¯è¯¥è¯åœ¨æ–‡ä»¶ä¸­å‡ºç°çš„è¯æ•°ä¹‹å’Œã€‚</p><p><strong>æˆ‘ä»¬å†è®²ä¸ªå°é—®é¢˜ï¼š</strong></p><p>å¦‚æœæŸä¸€ç±»æ–‡æ¡£Cä¸­åŒ…å«è¯æ¡tçš„æ–‡æ¡£æ•°ä¸ºmï¼Œè€Œå…¶ä»–ç±»åŒ…å«tçš„æ–‡æ¡£æ€»æ•°ä¸ºkï¼Œæ˜¾ç„¶æ‰€æœ‰åŒ…å«tçš„æ–‡æ¡£æ•°n=m+kï¼Œè€Œå½“må˜å¤§çš„æ—¶å€™ï¼Œnä¹Ÿå˜å¤§ï¼Œè¿™æ˜¯åæŒ‰ç…§IDFçš„è®¡ç®—æ–¹æ³•è®¡ç®—å¾—åˆ°çš„IDFå€¼ä¼šå˜å°ï¼Œä¹Ÿå°±ç›¸å¯¹åº”çš„è¯´æ˜è¯¥è¯æ¡tç±»åˆ«åŒºåˆ†èƒ½åŠ›ä¸å¼ºã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œå¦‚æœä¸€ä¸ªè¯æ¡åœ¨ä¸€ä¸ªç±»çš„æ–‡ä»¶ä¸­é¢‘ç¹å‡ºç°ï¼Œåˆ™è¯´æ˜è¯¥è¯æ¡èƒ½å¤Ÿå¾ˆå¥½çš„ä»£è¡¨è¿™ä¸ªç±»çš„æ–‡æœ¬çš„ç‰¹å¾ï¼Œè¿™æ ·çš„è¯æ¡åº”è¯¥ç»™å®ƒä»¬èµ‹äºˆè¾ƒé«˜çš„æƒé‡ï¼Œå¹¶é€‰æ¥ä½œä¸ºè¯¥ç±»æ–‡æœ¬çš„ç‰¹å¾è¯ä»¥åŒºåˆ«ä¸å…¶å®ƒç±»æ–‡æ¡£ã€‚<strong>å…¶å®è¿™å°±æ˜¯IDFçš„ä¸è¶³</strong>ã€‚</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯TF-IDFç”¨æ¥åšä¿¡æ¯æ£€ç´¢å’Œæ•°æ®æŒ–æ˜ï¼Œä¸ºäº†è·å–æ›´ç²¾å‡†çš„æ•ˆæœï¼Œæˆ‘ä»¬å®æ„¿å¿½ç•¥è¿™æ ·ä¸è¶³æ¥æ¢å–æ›´åŠ ç†æƒ³çš„æ•ˆæœï¼ˆä¹Ÿå°±æ˜¯TF-IDFè®¡ç®—å‡ºæ›´å¤§çš„æƒå€¼ï¼‰ã€‚ï¼ˆè¿™é‡Œæˆ‘çš„ç†è§£æ˜¯è¿™æ ·çš„ï¼Œå¦‚æœæœ‰äººæœ‰æ›´å¥½çš„è§£é‡Šï¼Œæ¬¢è¿ä¸æˆ‘è¿›è¡Œè®¨è®ºï¼Œé‚®ç®±ï¼šwell@weaf.topï¼‰</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±è¯¥ç»™å‡ºIDFçš„è®¡ç®—å…¬å¼äº†ï¼š</p><p><span class="math inline">\(idf(t,D) = log(\frac{N}{\lvert {d \in D, t \in d}\rvert})\)</span></p><p>IDFå…¬å¼è§£è¯»ï¼š</p><p>|D|ï¼šè¯­æ–™åº“ä¸­æ–‡ä»¶çš„æ€»æ•°</p><p>åˆ†å­ä¸ºåŒ…å«è¯¥è¯æ¡tçš„æ–‡ä»¶æ•°ç›®ï¼Œå¦‚æœè¯¥è¯æ¡ä¸åœ¨è¯­æ–™åº“ä¸­ï¼Œå°±ä¼šå¯¼è‡´åˆ†æ¯ä¸ºé›¶ï¼Œå› æ­¤ä¸€èˆ¬ä½¿ç”¨1ã€‚</p><p>é‚£å°±æ¥ç€æˆ‘ä»¬ä¸Šè¿°ä»£ç ï¼Œè¿ç”¨TF-IDFï¼ŒæŠŠå¯¹åº”çš„çŸ©é˜µçš„å•çº¯è®¡æ•°è½¬æ¢æˆæƒå€¼è®¡ç®—å§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Â·Â·Â·</span><br><span class="line"></span><br><span class="line">def get_all_vector(file_path):</span><br><span class="line">    names = [ os.path.join(file_path,f) for f in os.listdir(file_path) ]</span><br><span class="line">    posts = [ open(name).read() for name in names]</span><br><span class="line">    docs = []</span><br><span class="line">    word_set = set()</span><br><span class="line">    for post in posts:</span><br><span class="line">        doc = RmStopWords(post)</span><br><span class="line">        docs.append(doc)</span><br><span class="line">        word_set |= set(doc)</span><br><span class="line"></span><br><span class="line">    word_set = list(word_set)</span><br><span class="line">    docs_vsm = []</span><br><span class="line">    for word in word_set[:30]:</span><br><span class="line">        print(word)</span><br><span class="line">    for doc in docs:</span><br><span class="line">        temp_vector = []</span><br><span class="line">        for word in word_set:</span><br><span class="line">            temp_vector.append(doc.count(word) * 1.0)</span><br><span class="line">        docs_vsm.append(temp_vector)</span><br><span class="line">    docs_matrix = np.array(docs_vsm)</span><br><span class="line">    #return docs_matrix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    column_sum = [ float(len(np.nonzero(docs_matrix[:,i])[0])) for i in range(docs_matrix.shape[1]) ]</span><br><span class="line">    column_sum = np.array(column_sum)</span><br><span class="line">    column_sum = docs_matrix.shape[0] / column_sum</span><br><span class="line">    </span><br><span class="line">idf =  np.log(column_sum)</span><br><span class="line">    idf =  np.diag(idf)</span><br><span class="line">    </span><br><span class="line">i = 0    </span><br><span class="line">    for doc_v in docs_matrix:    </span><br><span class="line">        if doc_v.sum() == 0:</span><br><span class="line">            docs_matrix[i] = docs_matrix[i]/1</span><br><span class="line">        else:</span><br><span class="line">            docs_matrix[i] = docs_matrix[i] / (doc_v.sum())</span><br><span class="line">        i+=1</span><br><span class="line">    </span><br><span class="line">tfidf = np.dot(docs_matrix,idf)</span><br><span class="line">    return names,tfidf</span><br><span class="line"></span><br><span class="line">txt3 = get_all_vector(&apos;txt1&apos;)</span><br><span class="line">print(txt3)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœï¼š</strong></p><p><img src="https://i.loli.net/2018/04/14/5ad1988749e40.png" alt="tfidfResult.png"></p><p>æœ¬æ¬¡çš„å­¦ä¹ ä¼šç”¨åˆ°å¾ˆå¤šnumpyçš„çŸ¥è¯†ï¼Œè¯·å¤§å®¶è‡ªè¡ŒæŸ¥é˜…ã€‚å¦‚æœ‰å…´è¶£ï¼Œè¯·æ€è€ƒä¸ºä»€ä¹ˆåœ¨æ–°çš„æƒå€¼çŸ©é˜µä¸­â€œæ¥åˆ°â€ä¸€è¯çš„æƒé‡å˜æˆäº†0ã€‚æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;å’±ä»¬ä»Šå¤©å…ˆèŠä¸ªæ¦‚å¿µå§ï¼Œè‘—åçš„èšç±»å‡è®¾ï¼Œè¿™ä¹Ÿæ˜¯æ–‡æœ¬èšç±»çš„ä¾æ®ï¼Œå†…å®¹å¦‚ä¸‹ï¼šè¯¥å‡è®¾è®¤ä¸ºï¼ŒåŒç±»çš„æ–‡æ¡£ç›¸ä¼¼åº¦è¾ƒå¤§ï¼Œè€Œä¸åŒç±»çš„æ–‡æ¡£ç›¸ä¼¼åº¦è¾ƒå°ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h1
        
      
    
    </summary>
    
      <category term="æ–‡æœ¬èšç±»" scheme="http://weafteam.github.io/categories/%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB/"/>
    
    
      <category term="æ–‡æœ¬èšç±»" scheme="http://weafteam.github.io/tags/%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>ä¿®æ”¹pipå…¨å±€é•œåƒ</title>
    <link href="http://weafteam.github.io/posts/233074e6/"/>
    <id>http://weafteam.github.io/posts/233074e6/</id>
    <published>2018-03-27T12:29:36.000Z</published>
    <updated>2018-05-29T01:27:49.802Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¿®æ”¹pipå…¨å±€é•œåƒ">ä¿®æ”¹pipå…¨å±€é•œåƒ</h3><p>ç¬¬ä¸€æ¬¡æˆ‘ä»¬åœ¨windowsä¸Šé¢å®‰è£…äº†Anacondaï¼Œåœ¨ä½¿ç”¨pipå®‰è£…Tensorflowä¸­é€Ÿåº¦è¿‡æ…¢ï¼Œæ‰€ä»¥æˆ‘ä¸ºå¤§å®¶ä»‹ç»ä¸€ä¸­ä¿®æ”¹å…¨å±€pipæºçš„æ–¹æ³•ï¼ˆè¿™æ ·åœ¨ä½¿ç”¨pipä¸‹è½½ä¾èµ–åº“çš„æ—¶å€™å°±ä¼šå¿«ä¸€äº›ï¼‰ï¼š</p><ol type="1"><li>æ‰“å¼€ç”¨æˆ·ä¸»ç›®å½•ï¼šæˆ‘çš„æ˜¯<code>C:\Users\milittle</code>ã€‚</li><li>åœ¨é‡Œé¢æ–°å»ºpipæ–‡ä»¶å¤¹ï¼Œåœ¨pipæ–‡ä»¶å¤¹ä¸­å»ºç«‹pip.iniæ–‡ä»¶ã€‚</li><li>åœ¨pip.iniæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä½¿ç”¨çš„è±†ç“£æºï¼š</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout = 6000</span><br><span class="line">index-url = https://pypi.douban.com/simple</span><br></pre></td></tr></table></figure><ol start="4" type="1"><li>æœ€åçš„ç›®å½•ç»“æ„å°±æ˜¯ï¼š<code>C:\Users\milittle\pip\pip.ini</code></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h3
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ç†è§£æè¿°ç¬¦</title>
    <link href="http://weafteam.github.io/posts/5dd0238f/"/>
    <id>http://weafteam.github.io/posts/5dd0238f/</id>
    <published>2018-03-25T15:52:32.000Z</published>
    <updated>2018-08-07T08:56:41.613Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¸Šç¯‡æ–‡ç« ä¸­æŒ–äº† property å’Œæè¿°ç¬¦çš„å‘ï¼Œè¿™ç¯‡å°±æŠŠå®ƒå¡«ä¸Šå¥½äº†_(:Ğ·)âˆ )_</p><p>property æ˜¯ç”¨æè¿°ç¬¦å®ç°çš„ï¼Œæ‰€ä»¥å…ˆè¯´è¯´ propertyã€‚</p><h2 id="property">property</h2><p>property æœ¬èº«æ˜¯ä¸€ä¸ªå®ç°äº†æè¿°ç¬¦åè®®çš„ç±»ï¼Œåœ¨ä¸æ”¹å˜ç±»æ¥å£çš„æƒ…å†µä¸‹ï¼Œæä¾›äº†ä¸€ç»„å¯¹å®ä¾‹å±æ€§çš„è¯»å–ã€å†™å…¥å’Œåˆ é™¤æ“ä½œã€‚ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªé“¶è¡Œè´¦æˆ·çš„æŠ½è±¡ï¼Œå¾ˆå®¹æ˜“å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, balance)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.balance = balance</span><br></pre></td></tr></table></figure><p>é“¶è¡Œè´¦æˆ·æœ€å¸¸è§çš„æ“ä½œå°±æ˜¯å­˜æ¬¾å’Œå–æ¬¾äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: account = Account(<span class="string">'zhang'</span>, <span class="number">100</span>)  <span class="comment"># åˆ›å»ºä¸€ä¸ªæœ‰ 100 å—å­˜æ¬¾çš„è´¦æˆ·</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: account.balance</span><br><span class="line">Out[<span class="number">2</span>]: <span class="number">100</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: account.balance -= <span class="number">90</span>  <span class="comment"># å– 90 å—</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: account.balance  <span class="comment"># è¿˜å‰© 10 å—</span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">10</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: account.balance += <span class="number">30</span>  <span class="comment"># å­˜ 30 å—</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: account.balance  <span class="comment"># ç°åœ¨æœ‰ 40 å—</span></span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">40</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: account.balance -= <span class="number">50</span>  <span class="comment"># å†å– 50 å—</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: account.balance  <span class="comment"># å­˜æ¬¾å˜æˆäº†è´Ÿæ•°ï¼</span></span><br><span class="line">Out[<span class="number">8</span>]: <span class="number">-10</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™ç§æ“ä½œæ˜¯ä¸è¯¥è¢«å…è®¸çš„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ <code>balance</code> çš„å†™å…¥åšé™åˆ¶ã€‚Jawa ä¹‹ç±»çš„è¯­è¨€ä¼šåˆ›å»ºä¸€ç»„ getterã€setter æ–¹æ³•æ¥ç®¡ç†å±æ€§ï¼Œä½†æ˜¯è¿™å¹¶ä¸ Pythonï¼Œä¹Ÿå¯¹ç°æœ‰çš„ä»£ç ä¸å‹å¥½ã€‚æ­£ç¡®çš„æ–¹å¼æ˜¯ä½¿ç”¨ propertyã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, balance)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.balance = balance</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._balance</span><br><span class="line"></span><br><span class="line"><span class="meta">    @balance.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">balance</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'balance must greater than 0.'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._balance = value</span><br></pre></td></tr></table></figure><p>ç°åœ¨ <code>balance</code> è¢«ç¦æ­¢è®¾ä¸ºå°äº 0 çš„æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: account = Account(<span class="string">'zhang'</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: account.balance</span><br><span class="line">Out[<span class="number">2</span>]: <span class="number">100</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: account.balance += <span class="number">40</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: account.balance -= <span class="number">200</span></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">...</span><br><span class="line">ValueError: balance must greater than <span class="number">0.</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: account.balance</span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">140</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: account = Account(<span class="string">'zhang'</span>, <span class="number">-1</span>)  <span class="comment"># åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿä¸è¡Œï¼</span></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">...</span><br><span class="line">ValueError: balance must greater than <span class="number">0.</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨ <code>balance</code> çš„æ–¹å¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å¯¹å€¼çš„é™åˆ¶å·²ç»ç”Ÿæ•ˆäº†ã€‚</p><p>property è¿˜æœ‰ä¸€ä¸ª <code>deleter</code> è£…é¥°å™¨ï¼Œå¤„ç†åº”ç”¨äºå±æ€§çš„ <code>del</code>ï¼›å½“ç„¶ï¼Œ<code>del</code> æœ¬èº«ç”¨çš„ä¹Ÿä¸å¤šï¼Œå¤§å¤šæ•°æ—¶å€™æŠŠé”€æ¯æ“ä½œäº¤ç»™ Python å°±å¯ä»¥äº†ã€‚ä¸è¿‡å¦‚æœæ¶‰åŠåˆ°å¤æ‚å¯¹è±¡çš„å¼•ç”¨ï¼Œè¦åšåˆ° RAIIï¼ˆè¯¯ï¼Œè¿˜æ˜¯è¦æ‰‹åŠ¨å®ç°çš„ã€‚</p><h3 id="property-æ˜¯ç±»">property æ˜¯ç±»</h3><p>property æœ¬èº«æ˜¯ç”¨ C å®ç°çš„ï¼Œ<a href="https://docs.python.org/3/howto/descriptor.html#properties" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰ä¸€ä¸ªçº¯ Python çš„å®ç°ã€‚æ­£å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªç±»ï¼Œæ„é€ æ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">property</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, fget=None, fset=None, fdel=None, doc=None)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>ç†Ÿæ‚‰ä¸€ç‚¹è£…é¥°å™¨ç”¨æ³•çš„è¯å°±å¯ä»¥çœ‹å‡ºä¸Šé¢çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šå°±æ˜¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_balance</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    balance = property(fget=get_balance)</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œä¸‹ä¸€ç¯‡å°±è®²è£…é¥°å™¨å¥½äº†ï¼ˆè¯¯</p><h3 id="property-çš„å®ä¾‹æ˜¯ç±»å±æ€§">property çš„å®ä¾‹æ˜¯ç±»å±æ€§</h3><p>ä¸Šé¢çš„ä»£ç æ®µåŒæ—¶å±•ç¤ºäº†è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šproperty çš„å®ä¾‹æ˜¯ç±»å±æ€§ã€‚è¿™å°±æ¶‰åŠåˆ°äº†å±æ€§æŸ¥æ‰¾é¡ºåºçš„é—®é¢˜ï¼Œç®€å•è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">    data = <span class="string">'data!'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'bar!'</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: f = Foo()</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: f.data</span><br><span class="line">Out[<span class="number">2</span>]: <span class="string">'data!'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: f.data = <span class="string">'f.data!'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: f.data</span><br><span class="line">Out[<span class="number">4</span>]: <span class="string">'f.data!'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: Foo.data</span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">'data!'</span></span><br></pre></td></tr></table></figure><p>å®ä¾‹å±æ€§è¦†ç›–äº†ç±»å±æ€§ï¼Œç¬¦åˆç›´è§‰ã€‚é‚£ä¹ˆå¯¹ property çš„å®ä¾‹æ¥è¯´å‘¢ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">6</span>]: f.bar</span><br><span class="line">Out[<span class="number">6</span>]: <span class="string">'bar!'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: f.bar = <span class="string">'bar'</span></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">AttributeError                            Traceback (most recent call last)</span><br><span class="line">...</span><br><span class="line">AttributeError: can<span class="string">'t set attribute</span></span><br></pre></td></tr></table></figure><p>å°è¯•ç»™ <code>bar</code> èµ‹å€¼ï¼Œå¤±è´¥äº†ï¼Œä¹Ÿç¬¦åˆ property çš„å·¥ä½œæ–¹å¼ï¼šæ‰§è¡Œèµ‹å€¼æ—¶ï¼Œå¦‚æœæ²¡æœ‰ setter æ–¹æ³•å°±æŠ›å‡ºå¼‚å¸¸ã€‚é‚£ä¹ˆç›´æ¥ä¿®æ”¹ <code>f.__dict__</code> å‘¢ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">8</span>]: f.__dict__[<span class="string">'bar'</span>] = <span class="string">'bar'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: f.bar</span><br><span class="line">Out[<span class="number">9</span>]: <span class="string">'bar!'</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿä¸è¡Œï¼Œproperty çš„å®ä¾‹å®Œå…¨è¦†ç›–äº†å®ä¾‹å±æ€§ã€‚ä½†æ˜¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±»å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">10</span>]: Foo.bar</span><br><span class="line">Out[<span class="number">10</span>]: &lt;property at <span class="number">0x29c44800408</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">11</span>]: Foo.bar = <span class="string">'bar'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: f.bar</span><br><span class="line">Out[<span class="number">12</span>]: <span class="string">'bar'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">13</span>]: f.bar = <span class="string">'ba'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">14</span>]: f.bar</span><br><span class="line">Out[<span class="number">14</span>]: <span class="string">'ba'</span></span><br></pre></td></tr></table></figure><p>å¯¹ç±»å±æ€§çš„è¦†ç›–ä½¿ <code>bar</code> ä¸å†æ˜¯ä¸€ä¸ª property çš„å®ä¾‹ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸ä¼šè¦†ç›–åç»­çš„èµ‹å€¼äº†ã€‚</p><p>å½“ç„¶æˆ‘ä»¬ä»ç„¶å¯ä»¥ç”¨ä¸€ä¸ª property çš„å®ä¾‹å†æ¬¡è¦†ç›– <code>Foo.bar</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">15</span>]: Foo.bar = property(fget=<span class="keyword">lambda</span> self: <span class="string">'bar!'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">16</span>]: f.bar</span><br><span class="line">Out[<span class="number">16</span>]: <span class="string">'bar!'</span></span><br></pre></td></tr></table></figure><p>æ¢å¤åŸæ ·ã€‚ property çš„å®ä¾‹è¿™ç§å…ˆä»ç±»ä¸­å¼€å§‹å±æ€§æŸ¥æ‰¾çš„æ–¹å¼ï¼Œæ˜¯ä¸€ç±»æè¿°ç¬¦çš„å·¥ä½œæ¨¡å¼ã€‚æ¥ä¸‹æ¥å°±è¯´è¯´æè¿°ç¬¦ã€‚</p><h2 id="æè¿°ç¬¦">æè¿°ç¬¦</h2><p>æè¿°ç¬¦æ˜¯æŒ‡å®ç°äº†æè¿°ç¬¦åè®®çš„ç±»ï¼Œè¿™ä¸ªåè®®åŒ…å«å››ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ <code>__get__</code>ï¼Œ<code>__set__</code>ï¼Œ<code>__delete__</code> å’Œ Python 3.6 æ–°å¢çš„ <code>__set_name__</code>ã€‚é€šå¸¸ï¼Œåªè¦å®ç°äº† <code>__get__</code> æˆ– <code>__set__</code>ï¼Œå°±å¯ä»¥è¢«ç§°ä¹‹ä¸ºæè¿°ç¬¦ã€‚åœ¨æŸä¸ªè§’åº¦ä¸Šè¯´ï¼Œæè¿°ç¬¦çš„ä½œç”¨ç›¸å½“äºæŠ½è±¡çš„ propertyï¼Œå¯ä»¥ä¸ºä¸€ç»„å±æ€§æä¾›ç›¸åŒçš„è¯»å–ã€å†™å…¥å’Œåˆ é™¤é€»è¾‘ã€‚æ¥ä¸‹æ¥ï¼Œè¿˜æ˜¯ä»æ•°æ®éªŒè¯çš„ä¾‹å­å¼€å§‹ã€‚</p><p>ä¸‹é¢æ˜¯å•†åº—ä¸­ä¸€é¡¹å•†å“çš„æŠ½è±¡ï¼ŒåŒ…å«å•†å“åã€æ•°é‡å’Œå•ä»·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>:</span></span><br><span class="line">    amount = Storage(<span class="string">'amount'</span>)</span><br><span class="line">    price = Storage(<span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, amount, price)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.amount = amount</span><br><span class="line">        self.price = price</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>amount</code> å’Œ <code>price</code> éƒ½å¿…é¡»å¤§äº 0ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ç»Ÿä¸€çš„æè¿°ç¬¦å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Storage</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">0</span>:</span><br><span class="line">            instance.__dict__[self.name] = value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f'<span class="subst">&#123;self.name&#125;</span> must greater than 0.'</span>)</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è¯»å–æ–¹æ³•æœ‰ç‰¹åˆ«çš„éœ€æ±‚ï¼Œæ‰€ä»¥ä¸ç”¨å®ç° <code>__get__</code> æ–¹æ³•ã€‚</p><p>è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: item = Item(<span class="string">'orange'</span>, <span class="number">100</span>, <span class="number">0</span>)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">...</span><br><span class="line">ValueError: price must greater than <span class="number">0.</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: item = Item(<span class="string">'orange'</span>, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">...</span><br><span class="line">ValueError: amount must greater than <span class="number">0.</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>amount</code> æˆ– <code>price</code> ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸å¤§äº 0ï¼Œéƒ½ä¼šè¢«ç¦æ­¢ã€‚</p><p>è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ <code>__set__</code> çš„ç­¾åä¸­çš„ <code>instance</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p><code>instance</code> æ˜¯ <code>Item</code> çš„å®ä¾‹ã€‚å› ä¸ºæè¿°ç¬¦åº”è¯¥ç®¡ç†å®ä¾‹çš„å±æ€§ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–çš„å‚æ•°æä¾›ç›¸åº”çš„å®ä¾‹ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½è¿™æ ·å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">    self.__dict__[self.name] = value</span><br></pre></td></tr></table></figure><p>è¿™å®é™…ä¸Šæ˜¯ä¸ºæè¿°ç¬¦å®ä¾‹è®¾ç½®äº†å€¼ï¼Œè€Œæè¿°ç¬¦å®ä¾‹æ˜¯<code>Item</code> ç±»çš„ç±»å±æ€§ï¼Œæ‰€æœ‰çš„ <code>Item</code> å®ä¾‹éƒ½å…±äº«ç›¸åŒçš„æè¿°ç¬¦å®ä¾‹ã€‚ä¿®æ”¹äº†æŸä¸ªæè¿°ç¬¦å®ä¾‹ï¼Œç›¸å½“äºä¿®æ”¹äº†æ‰€æœ‰çš„ <code>Item</code> å®ä¾‹ã€‚</p><p>ä¸Šé¢çš„ä¾‹å­æœ‰ä¸ªç¼ºç‚¹ï¼Œåˆå§‹åŒ–æè¿°ç¬¦å®ä¾‹çš„æ—¶å€™éœ€è¦é‡å¤å±æ€§çš„åå­—ã€‚æˆ‘ä»¬å¸Œæœ›å¯ä»¥ç®€å•çš„å†™æˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>:</span></span><br><span class="line">    amount = Storage()</span><br><span class="line">    price = Storage()</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>è€Œä¸éœ€è¦åœ¨æè¿°ç¬¦çš„æ„é€ æ–¹æ³•ä¸­é‡å¤å±æ€§åã€‚è¿™å°±æ˜¯ Python 3.6 æ–°å¢çš„ <code>__set_name__</code> æ–¹æ³•çš„ä½œç”¨ã€‚åªè¦å®ç° <code>__set_name__</code> æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Storage</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set_name__</span><span class="params">(self, owner, name)</span>:</span></span><br><span class="line">        self.name = name</span><br></pre></td></tr></table></figure><p>åŒæ ·è§£é‡Šä¸€ä¸‹å‡½æ•°ç­¾åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__set_name__</span><span class="params">(self, owner, name)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p><code>owner</code> æ˜¯ <code>Item</code> ç±»æœ¬èº«ï¼Œ<code>name</code> æ˜¯å¼•ç”¨æè¿°ç¬¦å®ä¾‹çš„å˜é‡çš„åå­—ã€‚</p><p>å¦‚æœä½¿ç”¨çš„ Python ç‰ˆæœ¬åœ¨ 3.6 ä»¥ä¸‹å‘¢ï¼Ÿæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šç¬¬ä¸€ä¸ªæ˜¯ç”¨å…ƒç±»æ¥ç®¡<code>Item</code>ç±»çš„åˆ›å»ºè¿‡ç¨‹ï¼Œè¿™ä¸ªä¸åœ¨è¿™ç¯‡æ–‡ç« çš„å†…å®¹ä¹‹å†…ï¼ˆå¯èƒ½åˆæŒ–äº†ä¸€ä¸ªå‘ï¼›ç¬¬äºŒä¸ªå°±æ˜¯ä¸ºæ¯ä¸ªæè¿°ç¬¦å®ä¾‹ç”Ÿæˆä¸å±æ€§åæ— å…³ä½†æ˜¯å”¯ä¸€å­—ç¬¦ä¸²ï¼Œç”¨æ¥ä»£æ›¿å±æ€§åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Storage</span>:</span></span><br><span class="line"></span><br><span class="line">    _counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        cls = self.__class__</span><br><span class="line">        self.name = <span class="string">f'_<span class="subst">&#123;cls.__name__&#125;</span>#<span class="subst">&#123;cls._counter&#125;</span>'</span></span><br><span class="line">        cls._counter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(instance, self.name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">0</span>:</span><br><span class="line">            setattr(instance, self.name, value)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'must greater than 0.'</span>)</span><br></pre></td></tr></table></figure><p>ç”±äº <code>Item</code> ä¸­çš„å±æ€§åå’Œæˆ‘ä»¬å®é™…ä¿å­˜çš„å±æ€§åä¸åŒï¼Œæ‰€ä»¥éœ€è¦å®ç° <code>__get__</code> æ–¹æ³•ã€‚ä¸ <code>__set_name__</code> ç­¾åä¸­çš„ <code>owner</code> å«ä¹‰ç›¸åŒï¼Œ<code>__get__</code> æ–¹æ³•ç­¾åä¸­çš„ <code>owner</code> ä¹Ÿæ˜¯ <code>Item</code> ç±»æœ¬èº«ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>_Storage#N</code> è¿™æ ·çš„åç§°åœ¨ <code>Item</code> å®ä¾‹ä¸­ä¿å­˜å±æ€§ã€‚å½“ç„¶ï¼Œè¿™æ ·çš„åç§°ä¼šè®©äººæœ‰ç‚¹å›°æƒ‘ï¼Œç‰¹åˆ«æ˜¯ä»¥ç±»å±æ€§è®¿é—®çš„æ—¶å€™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: Item.amount</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">AttributeError                            Traceback (most recent call last)</span><br><span class="line">...</span><br><span class="line">AttributeError: <span class="string">'NoneType'</span> object has no attribute <span class="string">'_Storage#0'</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…åœ¨å¦‚æ­¤æ˜æ˜¾çš„åœ°æ–¹æš´éœ²æˆ‘ä»¬çš„å®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å¼‚å¸¸çš„é”™è¯¯æ¶ˆæ¯ï¼Œæˆ–è€…ï¼Œå†…çœæè¿°ç¬¦å®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> getattr(instance, self.name)</span><br></pre></td></tr></table></figure><h3 id="ä¸¤ç±»æè¿°ç¬¦">ä¸¤ç±»æè¿°ç¬¦</h3><p>ä¸Šè¿°ä¾‹å­ä¸­å¯¹æ•°æ®å±æ€§çš„æ§åˆ¶å’Œç®¡ç†æ˜¯æè¿°ç¬¦çš„å…¸å‹ç”¨é€”ä¹‹ä¸€ã€‚è¿™ç§å®ç°äº† <code>__set__</code> æ–¹æ³•ï¼Œæ¥ç®¡äº†è®¾ç½®å±æ€§è¡Œä¸ºçš„æè¿°ç¬¦ï¼Œè¢«ç§°ä¸ºè¦†ç›–å‹æè¿°ç¬¦ï¼Œæ²¡æœ‰å®šä¹‰ <code>__set__</code> æ–¹æ³•çš„æè¿°ç¬¦ï¼Œè¢«ç§°ä¸ºéè¦†ç›–å‹æè¿°ç¬¦ã€‚ç”±äº Python ä¸­å¯¹å®ä¾‹å±æ€§å’Œç±»å±æ€§çš„å¤„ç†æ–¹å¼ä¸åŒï¼Œè¿™ä¸¤ç±»æè¿°ç¬¦ä¹Ÿæœ‰ä¸åŒçš„è¡Œä¸ºã€‚</p><h4 id="è¦†ç›–å‹æè¿°ç¬¦">è¦†ç›–å‹æè¿°ç¬¦</h4><p>å®ç°äº† <code>__set__</code> æ–¹æ³•çš„æè¿°ç¬¦å°±æ˜¯è¦†ç›–å‹æè¿°ç¬¦ã€‚è¿™ç±»æè¿°ç¬¦è™½ç„¶æ˜¯ç±»å±æ€§ï¼Œä½†æ˜¯ä¼šè¦†ç›–å®ä¾‹å±æ€§çš„èµ‹å€¼æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Override</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">'get!'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        print(<span class="string">'set!'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span>:</span></span><br><span class="line"></span><br><span class="line">    override = Override()</span><br></pre></td></tr></table></figure><p>ä¸‹é¢åšä¸€äº›å®éªŒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: m = Manager()</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: m.override</span><br><span class="line">get!</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: m.override = <span class="number">1</span></span><br><span class="line">set!</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: Manager.override</span><br><span class="line">get!</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: m.__dict__[<span class="string">'override'</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: m.__dict__</span><br><span class="line">Out[<span class="number">6</span>]: &#123;<span class="string">'override'</span>: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: m.override</span><br><span class="line">get!</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œæ— è®ºä»¥å®ä¾‹å±æ€§è¿˜æ˜¯ç±»å±æ€§è®¿é—® <code>override</code>ï¼Œéƒ½ä¼šè§¦å‘ <code>__get__</code> æ–¹æ³•ï¼›ä¸ºå®ä¾‹å±æ€§ <code>override</code> èµ‹å€¼ä¼šè§¦å‘ <code>__set__</code> æ–¹æ³•ï¼›å³ä½¿è·³è¿‡æè¿°ç¬¦ç›´æ¥ä¸º <code>m.__dict__</code> èµ‹å€¼ï¼Œè¯»å– <code>override</code> çš„æ“ä½œä»ç„¶ä¼šè¢«æè¿°ç¬¦è¦†ç›–ã€‚</p><h5 id="æ²¡æœ‰-__get__-æ–¹æ³•çš„è¦†ç›–å‹æè¿°ç¬¦">æ²¡æœ‰ <code>__get__</code> æ–¹æ³•çš„è¦†ç›–å‹æè¿°ç¬¦</h5><p>å¦‚æœåªå®ç°äº† <code>__set__</code> ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OverrideNoGet</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        print(<span class="string">'set!'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span>:</span></span><br><span class="line"></span><br><span class="line">    override_no_get = OverrideNoGet()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: m = Manager()</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: m.override_no_get</span><br><span class="line">Out[<span class="number">2</span>]: &lt;__main__.OverrideNoGet at <span class="number">0x29c44a97668</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: Manager.override_no_get</span><br><span class="line">Out[<span class="number">3</span>]: &lt;__main__.OverrideNoGet at <span class="number">0x29c44a97668</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: m.override_no_get = <span class="number">1</span></span><br><span class="line">set!</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: m.override_no_get</span><br><span class="line">Out[<span class="number">5</span>]: &lt;__main__.OverrideNoGet at <span class="number">0x29c44a97668</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: m.__dict__[<span class="string">'override_no_get'</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: m.override_no_get</span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: m.override_no_get = <span class="number">2</span></span><br><span class="line">set!</span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: m.override_no_get</span><br><span class="line">Out[<span class="number">9</span>]: <span class="number">1</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ²¡å®ç° <code>__get__</code> æ–¹æ³•ï¼Œæ— è®ºä»¥å®ä¾‹å±æ€§è¿˜æ˜¯ç±»å±æ€§è®¿é—® <code>override_no_get</code>ï¼Œéƒ½ä¼šè¿”å›æè¿°ç¬¦å®ä¾‹ï¼›è€Œèµ‹å€¼æ“ä½œå¯ä»¥è§¦å‘ <code>__set__</code> æ–¹æ³•ï¼›ç”±äºæˆ‘ä»¬çš„ <code>__set__</code> æ–¹æ³•å¹¶æ²¡æœ‰çœŸæ­£ä¿®æ”¹å®ä¾‹å±æ€§ï¼Œæ‰€ä»¥å†æ¬¡è®¿é—® <code>override_no_get</code> ä»ç„¶ä¼šå¾—åˆ°æè¿°ç¬¦å®ä¾‹ï¼›é€šè¿‡ <code>m.__dict__</code> ä¿®æ”¹å®ä¾‹å±æ€§åï¼Œå®ä¾‹å±æ€§å°±ä¼šè¦†ç›–æè¿°ç¬¦ï¼›ä¸è¿‡åªæœ‰è®¿é—®å®ä¾‹å±æ€§æ—¶æ‰æ˜¯å¦‚æ­¤ï¼Œèµ‹å€¼ä»ç„¶ç”± <code>__set__</code> å¤„ç†ã€‚</p><h4 id="éè¦†ç›–å‹æè¿°ç¬¦">éè¦†ç›–å‹æè¿°ç¬¦</h4><p>æ²¡æœ‰å®ç° <code>__set__</code> æ–¹æ³•çš„æè¿°ç¬¦å°±æ˜¯éè¦†ç›–å‹æè¿°ç¬¦ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NonOverride</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, owner)</span>:</span></span><br><span class="line">        print(<span class="string">'get!'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span>:</span></span><br><span class="line"></span><br><span class="line">    non_override = NonOverride()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: m = Manager()</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: m.non_override</span><br><span class="line">get!</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: Manager.non_override</span><br><span class="line">get!</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: m.non_override = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: m.non_override</span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: Manager.non_override</span><br><span class="line">get!</span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: <span class="keyword">del</span> m.non_override</span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: m.non_override</span><br><span class="line">get!</span><br></pre></td></tr></table></figure><p>æ— è®ºè®¿é—®å®ä¾‹å±æ€§è¿˜æ˜¯ç±»å±æ€§ï¼Œéƒ½ä¼šè§¦å‘ <code>__get__</code> æ–¹æ³•ï¼›ç”±äºæ²¡æœ‰ <code>__set__</code> æ–¹æ³•ï¼Œå¯¹å±æ€§çš„èµ‹å€¼ä¸ä¼šè¢«å¹²æ¶‰ï¼›å¯¹å±æ€§å¤åˆ¶ä¹‹åï¼Œå®ä¾‹å±æ€§å°±ä¼šè¦†ç›–åŒåçš„æè¿°ç¬¦ï¼Œä½†æ˜¯è®¿é—®ç±»å±æ€§ä»ç„¶å¯ä»¥è§¦å‘ <code>__get__</code> æ–¹æ³•ï¼›å¦‚æœæŠŠ <code>non_override</code> ä»å®ä¾‹ä¸­åˆ é™¤ï¼Œè®¿é—® <code>non_override</code> çš„æ“ä½œåˆä¼šäº¤ç»™ <code>__get__</code>ã€‚</p><p>å½“ç„¶ï¼Œæè¿°ç¬¦éƒ½æ˜¯å®šä¹‰åœ¨ç±»ä¸Šçš„ï¼Œå¦‚æœå¯¹åŒåçš„ç±»å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œå°±ä¼šå®Œå…¨æ›¿æ¢æ‰æè¿°ç¬¦ã€‚è¿™é‡Œè¡¨ç°å‡ºè¯»ã€å†™å±æ€§æ—¶çš„ä¸å¯¹ç­‰ï¼šå¯¹ç±»å±æ€§çš„è¯»æ“ä½œå¯ä»¥è¢« <code>__get__</code> å¤„ç†ï¼Œä½†æ˜¯å†™æ“ä½œä¸ä¼šã€‚å½“ç„¶ï¼Œäº†è§£ä¸€äº› Python çš„è¯å°±ä¼šçŸ¥é“è¿˜å­˜åœ¨ç€å¦ä¸€ç§ä¸å¯¹ç­‰ï¼šè¯»å–å®ä¾‹å±æ€§æ—¶ï¼Œä¼šè¿”å›å®ä¾‹å±æ€§ï¼Œå¦‚æœå®ä¾‹å±æ€§ä¸å­˜åœ¨ï¼Œä¼šè¿”å›ç±»å±æ€§ï¼›ä½†æ˜¯ä¸ºå®ä¾‹å±æ€§èµ‹å€¼æ—¶ï¼Œå¦‚æœå®ä¾‹å±æ€§ä¸å­˜åœ¨ï¼Œä¼šåœ¨å®ä¾‹ä¸­åˆ›å»ºå±æ€§ï¼Œä¸ä¼šå½±å“åˆ°ç±»å±æ€§ã€‚</p><h2 id="ç»“è¯­">ç»“è¯­</h2><p>æè¿°ç¬¦å……æ–¥åœ¨ Python åº•å±‚ï¼ˆä¸¾ä¸ªä¾‹å­ï¼šPython ä¸­çš„æ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿï¼‰ä¸å„ç§æ¡†æ¶ä¸­ï¼Œç†è§£æè¿°ç¬¦æ˜¯ä½“ä¼š Python ä¸–ç•Œå·¥ä½œåŸç†å’Œè®¾è®¡ç¾å­¦çš„é‡è¦æ–¹å¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ä¸Šç¯‡æ–‡ç« ä¸­æŒ–äº† property å’Œæè¿°ç¬¦çš„å‘ï¼Œè¿™ç¯‡å°±æŠŠå®ƒå¡«ä¸Šå¥½äº†_(:Ğ·)âˆ )_&lt;/p&gt;
&lt;p&gt;property æ˜¯ç”¨æè¿°ç¬¦å®ç°çš„ï¼Œæ‰€ä»¥å…ˆè¯´è¯´ propertyã€‚&lt;/p&gt;
&lt;h2
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>TensorFlow åˆä½“éªŒ ï¼ˆFashion-mnistï¼‰</title>
    <link href="http://weafteam.github.io/posts/b0821049/"/>
    <id>http://weafteam.github.io/posts/b0821049/</id>
    <published>2018-03-25T13:18:37.000Z</published>
    <updated>2018-05-29T01:27:49.784Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tensorflow-åˆä½“éªŒfashion-mnist">TensorFlow åˆä½“éªŒï¼ˆFashion-mnistï¼‰</h1><ol type="1"><li>æ¥ç€ä¸Šä¸€è®²çš„å†…å®¹ï¼Œæƒ³å¿…å¤§å®¶å·²ç»é€šè¿‡æˆ‘çš„æ•™ç¨‹å®‰è£…å¥½äº†TensorFlowäº†å§ï¼Œé‚£æˆ‘ä»¬è¿™èŠ‚è¯¾é€šè¿‡å®‰è£…ç®€å•çš„è·¨å¹³å°çš„é›†æˆå¼€å‘ç¯å¢ƒSpyderï¼Œåœ¨è¿™ä¸ªé›†æˆå¼€å‘ç¯å¢ƒä¸Šé¢å®ç°ä¸€äº›pythonç¨‹åºã€‚å…·ä½“å®‰è£…è¿‡ç¨‹è§å¦‚ä¸‹é˜è¿°ï¼š</li></ol><ul><li>é¦–å…ˆåœ¨åº”ç”¨ç¨‹åºé‡Œé¢æ‰¾åˆ°Anacondaåº”ç”¨ç¨‹åºï¼Œæ‰“å¼€é‡Œé¢çš„Anaconda Navigatorï¼Œç„¶åæ‰“å¼€ä»¥åï¼Œé€‰ä¸­æˆ‘ä»¬ä¸Šæ¬¡å»ºç«‹å¥½çš„ç¯å¢ƒtensorflowã€‚</li></ul><p><img src="https://s1.ax1x.com/2018/03/25/9qTXNV.png" alt="-"></p><ul><li>é€‰ä¸­tensorflowè¿™ä¸ªç¯å¢ƒå˜é‡ä»¥åï¼Œçœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ªé›†æˆå¼€å‘ç¯å¢ƒå«spyderï¼Œè¿™ä¸ªå·¥å…·å°±æ˜¯ä»Šå¤©æˆ‘ä»¬è¦å®‰è£…çš„ï¼Œæˆ‘çš„å·²ç»å®‰è£…å¥½äº†ï¼Œæ‰€ä»¥æ˜¯Launchï¼Œä½ ä»¬çš„æ²¡æœ‰å®‰è£…å¥½ï¼Œæ‰€ä»¥æ˜¯installçŠ¶æ€ï¼Œç‚¹è§£å®‰è£…å°±å¥½ã€‚ï¼ˆè¿™ä¸ªåœ°æ–¹ä¹Ÿå¯èƒ½éœ€è¦ç¿»å¢™ï¼‰ã€‚</li><li>è¿™ä¸ªå®‰è£…å¥½ä»¥åï¼Œä½ å°±ä¼šåœ¨åº”ç”¨æ–‡ä»¶å¤¹é‡Œé¢å‡ºç°ä¸€ä¸ªSpyder(tensorflow)è¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œä»¥åä½ å°±ä»åº”ç”¨æ–‡ä»¶å¤¹å¯åŠ¨å°±å¥½ã€‚</li><li>é‚£ä¹ˆå¯åŠ¨ä»¥åï¼šæˆ‘ä¹Ÿæ˜¯å¯åŠ¨äº†ï¼Œå‡ºç°äº†ä»¥ä¸‹çš„æƒ…å†µï¼šä¸æ…Œï¼Œæ…¢æ…¢æ¥ã€‚</li></ul><p><img src="https://s1.ax1x.com/2018/03/25/9q7njH.png" alt="-"></p><ul><li>çœ‹åˆ°ä¸Šé¢çš„é”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯æç¤ºæ˜¯å› ä¸ºæ²¡æœ‰å®‰è£…jediè¿™ä¸ªä¾èµ–åº“ï¼Œè€Œä¸”è¦æ±‚ç‰ˆæœ¬è¦å¤§äº0.9.0ã€‚é‚£æˆ‘ä»¬æ¥ä¸‹æ¥è§£å†³ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</li></ul><blockquote><p>å°æ’æ›²ï¼Œä¸€ä¸‹å°±å¯ä»¥è§£å†³ï¼Œå…·ä½“æ“ä½œæ­¥éª¤:</p><ol type="1"><li>è¿˜æ˜¯æ‰“å¼€ä¸Šæ¬¡é‚£ä¸ªAnacondaPromptçš„å‘½ä»¤è¡Œ</li><li>è¿›å»ä»¥åï¼Œæ‰§è¡Œ<code>activate tensorflow</code> ç›¸å½“äºä½ è¦åœ¨è¿™ä¸ªç¯å¢ƒä¸‹é¢ç»™è¿™ä¸ªspyderå®‰è£…è¿™ä¸ªä¾èµ–</li><li>è¿›å»ä»¥åï¼Œæ‰§è¡Œ<code>pip install jedi==0.9.0</code> å°±å¯ä»¥äº†ï¼Œç„¶åé‡å¯spyderï¼ˆå¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªç¯å¢ƒé‡Œé¢è¾“å…¥<code>spyder</code>å‘½ä»¤å°±å¯ä»¥å®ç°spyderçš„å¯åŠ¨ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨åº”ç”¨æ–‡ä»¶å¤¹é‡Œé¢å¯åŠ¨ï¼Œæ€§è´¨æ˜¯ä¸€æ ·çš„ï¼‰</li><li>ä¸å‡ºä»€ä¹ˆæ„å¤–çš„è¯ï¼Œspyderä½¿ç”¨å°±æ²¡æœ‰é—®é¢˜äº†ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥å‘é‚®ä»¶ç»™æˆ‘ï¼ï¼ï¼</li></ol></blockquote><ul><li>è§£å†³äº†ä¸Šé¢çš„å°æ’æ›²ä»¥åï¼Œæˆ‘ä»¬åœ¨spyderä¸­è¾“å…¥ä»¥ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">sess = tf.Session()</span><br><span class="line">init = tf.global_variables_initializer() </span><br><span class="line"><span class="comment"># æ­¤å¤„çš„initæ˜¯å…¨å±€å˜é‡åˆå§‹åŒ–å™¨ï¼Œ</span></span><br><span class="line"><span class="comment"># TensorFlowçš„sessionå¿…é¡»æ‰§è¡Œè¿™ä¸ªåˆå§‹åŒ–å™¨æ‰èƒ½æ‰§è¡Œå‰é¢å»ºç«‹å¥½çš„å›¾ï¼Œ</span></span><br><span class="line"><span class="comment"># æ‰€ä»¥ï¼Œè¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œåç»­ä¹Ÿä¼šå¼ºè°ƒ</span></span><br><span class="line"><span class="comment">#ï¼ˆä¹Ÿå°±æ˜¯åç»­å†ç½‘ç»œä¸­å»ºç«‹å˜é‡å°±æ˜¯é€šè¿‡é‚£ä¸ªåˆå§‹åŒ–å™¨æ¥è¿›è¡Œåˆå§‹åŒ–å·¥ä½œçš„ï¼‰</span></span><br><span class="line"><span class="comment"># å…¶å®åœ¨æ²¡æœ‰å˜é‡çš„æ—¶å€™ï¼Œè¿™ä¸ªåˆå§‹åŒ–å™¨æ˜¯ä¸éœ€è¦çš„</span></span><br><span class="line"><span class="comment"># ä½†æ˜¯ä¸ºäº†è®©å¤§å®¶å½¢æˆä¹ æƒ¯ï¼Œè¿˜æ˜¯å†™ä¸Š</span></span><br><span class="line">sess.run(init)</span><br><span class="line">hello = tf.constant(<span class="string">'hello world'</span>)</span><br><span class="line">print(sess.run(hello))</span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2018/03/25/9q7r5V.png" alt="-"></p><ul><li>ä¸Šå›¾ä¸­å·¦é¢æ˜¯ä»£ç ä¹¦å†™åŒºåŸŸï¼Œå³é¢ä¸ŠåŠéƒ¨åˆ†æ˜¯å˜é‡æŸ¥çœ‹åŒºåŸŸï¼Œè¿˜æœ‰æ–‡ä»¶å¤¹åŒºåŸŸå¯ä»¥åˆ‡æ¢ï¼Œå³é¢ä¸‹åŠéƒ¨åˆ†æ˜¯æ‰§è¡ŒconsoleåŒºåŸŸï¼Œæˆ‘è¾“å…¥ä¸Šé¢çš„ä»£ç ï¼Œæ‰§è¡Œä»¥åconsoleåŒºåŸŸæ‰“å‡ºhello worldå­—ç¬¦ä¸²ã€‚</li></ul><ol start="2" type="1"><li>ä»ä¸Šé¢çš„ä¸€äº›ç®€å•çš„æµ‹è¯•ä»¥åï¼Œæˆ‘ä»¬è¿›å…¥ä»Šå¤©çš„ä¸»é¢˜ï¼Œfashion-ministçš„è¯†åˆ«ï¼Œfashion-ministæ˜¯ä¸€ä¸ªæœè£…è¯†åˆ«çš„ä¸€ä¸ªæ•°æ®é›†ï¼Œåœ¨è¿™ä¸ªæ•°æ®é›†ä¹‹å‰æœ‰ä¸€ä¸ªmnistæ‰‹å†™ä½“è¯†åˆ«æ•°æ®é›†ï¼Œè¿™ä¸ªæ‰‹å†™æ•°æ®é›†å¯¹åº”æˆ‘ä»¬æ‰‹å†™çš„åä¸ªæ•°å­—ï¼Œç„¶åé€šè¿‡è®¾è®¡ç½‘ç»œæ¥è¯†åˆ«æ‰‹å†™ä½“ã€‚ä½†æ˜¯ä»Šå¤©æˆ‘ä»¬ä¸åšæ‰‹å†™ä½“è¯†åˆ«ï¼Œç›´æ¥æ¥åšfashion-ministè¯†åˆ«ã€‚</li></ol><ul><li>é—²è¯å°‘è¯´ï¼Œä¸Šä»£ç ï¼Œè¾¹å†™è¾¹è¯´ã€‚</li></ul><p>é¦–å…ˆç›®æ ‡æ˜¯å®ç°è¡£æœç§ç±»çš„è¯†åˆ«ã€‚</p><p>æ•°æ®å¯ä»¥åœ¨ <a href="https://github.com/zalandoresearch/fashion-mnist" target="_blank" rel="noopener">Zalando_Fashion_MNIST_repository</a>è¿™ä¸ªGithubä»“åº“è·å–ã€‚</p><p>æ•°æ®åˆ†ä¸º60000è®­ç»ƒæ•°æ®å’Œ10000æµ‹è¯•æ•°æ®ï¼Œå›¾ç‰‡éƒ½æ˜¯ç°åº¦å›¾ç‰‡ï¼Œå¤§å°ä¸º28 X 28ï¼Œæ€»å…±ä¹Ÿæ˜¯ç”±10ç±»ç»„æˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Created on Sun Mar 25 15:16:23 2018</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@author: milittle</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥ä¸€äº›å¿…è¦çš„åº“</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np <span class="comment"># æ•°å­¦è®¡ç®—åº“</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt <span class="comment"># ç”»å›¾çš„ä¸€ä¸ªåº“</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf <span class="comment"># TensorFlowçš„åº“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line">fashion_mnist = input_data.read_data_sets(<span class="string">'input/data'</span>, one_hot = <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªæœè£…å¯¹åº”è¡¨</span></span><br><span class="line">label_dict = &#123;</span><br><span class="line">    <span class="number">0</span>: <span class="string">'T-shirt/top'</span>,</span><br><span class="line">    <span class="number">1</span>: <span class="string">'Trouser'</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">'Pullover'</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">'Dress'</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">'Coat'</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">'Sandal'</span>,</span><br><span class="line">    <span class="number">6</span>: <span class="string">'Shirt'</span>,</span><br><span class="line">    <span class="number">7</span>: <span class="string">'Sneaker'</span>,</span><br><span class="line">    <span class="number">8</span>: <span class="string">'Bag'</span>,</span><br><span class="line">    <span class="number">9</span>: <span class="string">'Ankle boot'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–éšæœºçš„æ•°æ®å’Œå®ƒçš„label</span></span><br><span class="line">sample_1 = fashion_mnist.train.images[<span class="number">47</span>].reshape(<span class="number">28</span>,<span class="number">28</span>)</span><br><span class="line">sample_label_1 = np.where(fashion_mnist.train.labels[<span class="number">47</span>] == <span class="number">1</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">sample_2 = fashion_mnist.train.images[<span class="number">23</span>].reshape(<span class="number">28</span>,<span class="number">28</span>)</span><br><span class="line">sample_label_2 = np.where(fashion_mnist.train.labels[<span class="number">23</span>] == <span class="number">1</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨matplotç”»å‡ºè¿™ä¸ªimageå’Œlabel</span></span><br><span class="line">print(<span class="string">"y = &#123;label_index&#125; (&#123;label&#125;)"</span>.format(label_index=sample_label_1, label=label_dict[sample_label_1]))</span><br><span class="line">plt.imshow(sample_1, cmap=<span class="string">'Greys'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"y = &#123;label_index&#125; (&#123;label&#125;)"</span>.format(label_index=sample_label_2, label=label_dict[sample_label_2]))</span><br><span class="line">plt.imshow(sample_2, cmap=<span class="string">'Greys'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥ä¸‹æ¥å°±æ˜¯è®¾è®¡ç½‘ç»œå‚æ•°</span></span><br><span class="line">n_hidden_1 = <span class="number">128</span> <span class="comment"># ç¬¬ä¸€ä¸ªéšè—å±‚çš„å•å…ƒä¸ªæ•°</span></span><br><span class="line">n_hidden_2 = <span class="number">128</span> <span class="comment"># ç¬¬äºŒä¸ªéšè—å±‚çš„å•å…ƒä¸ªæ•°</span></span><br><span class="line">n_input = <span class="number">784</span> <span class="comment"># fashion mnistè¾“å…¥å›¾ç‰‡çš„ç»´åº¦ï¼ˆå•å…ƒä¸ªæ•°ï¼‰ (å›¾ç‰‡å¤§å°: 28*28)</span></span><br><span class="line">n_classes = <span class="number">10</span> <span class="comment"># fashion mnistçš„ç§ç±»æ•°ç›® (0-9 æ•°å­—)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º placeholders</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_placeholders</span><span class="params">(n_x, n_y)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    ä¸ºsessåˆ›å»ºä¸€ä¸ªå ä½å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">    n_x -- å‘é‡, å›¾ç‰‡å¤§å° (28*28 = 784)</span></span><br><span class="line"><span class="string">    n_y -- å‘é‡, ç§ç±»æ•°ç›® (ä» 0 åˆ° 9, æ‰€ä»¥æ˜¯ -&gt; 10ç§)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›å‚æ•°:</span></span><br><span class="line"><span class="string">    X -- ä¸ºè¾“å…¥å›¾ç‰‡å¤§å°çš„placeholder shapeæ˜¯[784, None] </span></span><br><span class="line"><span class="string">    Y -- ä¸ºè¾“å‡ºç§ç±»å¤§å°çš„placeholder shapeæ˜¯[10, None] Noneåœ¨è¿™é‡Œè¡¨ç¤ºä»¥åè¾“å…¥çš„æ•°æ®å¯ä»¥ä»»æ„å¤šå°‘</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    X = tf.placeholder(tf.float32, [n_x, <span class="keyword">None</span>], name=<span class="string">"X"</span>)</span><br><span class="line">    Y = tf.placeholder(tf.float32, [n_y, <span class="keyword">None</span>], name=<span class="string">"Y"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> X, Y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ä¸Šé¢çš„create_placeholders()</span></span><br><span class="line">X, Y = create_placeholders(n_input, n_classes)</span><br><span class="line">print(<span class="string">"Shape of X: &#123;shape&#125;"</span>.format(shape=X.shape))</span><br><span class="line">print(<span class="string">"Shape of Y: &#123;shape&#125;"</span>.format(shape=Y.shape))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰åˆå§‹åŒ–å‚æ•°å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_parameters</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    å‚æ•°åˆå§‹åŒ–ï¼Œä¸‹é¢æ˜¯æ¯ä¸ªå‚æ•°çš„shapeï¼Œæ€»å…±æœ‰ä¸‰å±‚</span></span><br><span class="line"><span class="string">                        W1 : [n_hidden_1, n_input]</span></span><br><span class="line"><span class="string">                        b1 : [n_hidden_1, 1]</span></span><br><span class="line"><span class="string">                        W2 : [n_hidden_2, n_hidden_1]</span></span><br><span class="line"><span class="string">                        b2 : [n_hidden_2, 1]</span></span><br><span class="line"><span class="string">                        W3 : [n_classes, n_hidden_2]</span></span><br><span class="line"><span class="string">                        b3 : [n_classes, 1]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›:</span></span><br><span class="line"><span class="string">    åŒ…å«æ‰€æœ‰æƒé‡å’Œåç½®é¡¹çš„dic</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¾ç½®éšæœºæ•°ç§å­</span></span><br><span class="line">    tf.set_random_seed(<span class="number">42</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä¸ºæ¯ä¸€å±‚çš„æƒé‡å’Œåç½®é¡¹è¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">    W1 = tf.get_variable(<span class="string">"W1"</span>, [n_hidden_1, n_input], initializer = tf.contrib.layers.xavier_initializer(seed = <span class="number">42</span>))</span><br><span class="line">    b1 = tf.get_variable(<span class="string">"b1"</span>, [n_hidden_1, <span class="number">1</span>], initializer = tf.zeros_initializer())</span><br><span class="line">    </span><br><span class="line">    W2 = tf.get_variable(<span class="string">"W2"</span>, [n_hidden_2, n_hidden_1], initializer = tf.contrib.layers.xavier_initializer(seed = <span class="number">42</span>))</span><br><span class="line">    b2 = tf.get_variable(<span class="string">"b2"</span>, [n_hidden_2, <span class="number">1</span>], initializer = tf.zeros_initializer())</span><br><span class="line">    </span><br><span class="line">    W3 = tf.get_variable(<span class="string">"W3"</span>, [n_classes, n_hidden_2], initializer=tf.contrib.layers.xavier_initializer(seed = <span class="number">42</span>))</span><br><span class="line">    b3 = tf.get_variable(<span class="string">"b3"</span>, [n_classes, <span class="number">1</span>], initializer = tf.zeros_initializer())</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°†å‚æ•°å­˜å‚¨åœ¨ä¸€ä¸ªdictå¯¹è±¡é‡Œé¢è¿”å›å»</span></span><br><span class="line">    parameters = &#123;</span><br><span class="line">        <span class="string">"W1"</span>: W1,</span><br><span class="line">        <span class="string">"b1"</span>: b1,</span><br><span class="line">        <span class="string">"W2"</span>: W2,</span><br><span class="line">        <span class="string">"b2"</span>: b2,</span><br><span class="line">        <span class="string">"W3"</span>: W3,</span><br><span class="line">        <span class="string">"b3"</span>: b3</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> parameters</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">tf.reset_default_graph()</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    parameters = initialize_parameters()</span><br><span class="line">    print(<span class="string">"W1 = &#123;w1&#125;"</span>.format(w1=parameters[<span class="string">"W1"</span>]))</span><br><span class="line">    print(<span class="string">"b1 = &#123;b1&#125;"</span>.format(b1=parameters[<span class="string">"b1"</span>]))</span><br><span class="line">    print(<span class="string">"W2 = &#123;w2&#125;"</span>.format(w2=parameters[<span class="string">"W2"</span>]))</span><br><span class="line">    print(<span class="string">"b2 = &#123;b2&#125;"</span>.format(b2=parameters[<span class="string">"b2"</span>]))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># å‰å‘ä¼ æ’­ç®—æ³•ï¼ˆå°±æ˜¯ç¥ç»ç½‘ç»œçš„å‰å‘æ­¥éª¤ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forward_propagation</span><span class="params">(X, parameters)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    å®ç°å‰å‘ä¼ æ’­çš„æ¨¡å‹ LINEAR -&gt; RELU -&gt; LINEAR -&gt; RELU -&gt; LINEAR -&gt; SOFTMAX</span></span><br><span class="line"><span class="string">    ä¸Šé¢çš„æ˜¾ç¤ºå°±æ˜¯ä¸‰ä¸ªçº¿æ€§å±‚ï¼Œæ¯ä¸€å±‚ç»“æŸä»¥åï¼Œå®ç°reluçš„ä½œç”¨ï¼Œå®ç°éçº¿æ€§åŠŸèƒ½ï¼Œæœ€åä¸‰å±‚ä»¥åç”¨softmaxå®ç°åˆ†ç±»</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">    X -- è¾“å…¥è®­ç»ƒæ•°æ®çš„ä¸ªæ•°[784, n] è¿™é‡Œçš„nä»£è¡¨å¯ä»¥ä¸€æ¬¡è®­ç»ƒå¤šä¸ªæ•°æ®</span></span><br><span class="line"><span class="string">    parameters -- åŒ…æ‹¬ä¸Šé¢æ‰€æœ‰çš„å®šä¹‰å‚æ•°ä¸‰ä¸ªç½‘ç»œä¸­çš„æƒé‡Wå’Œåç½®é¡¹B</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¿”å›:</span></span><br><span class="line"><span class="string">    Z3 -- æœ€åçš„ä¸€ä¸ªçº¿æ€§å•å…ƒè¾“å‡º</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»å‚æ•°dicté‡Œé¢å–åˆ°æ‰€æœ‰çš„å‚æ•°</span></span><br><span class="line">    W1 = parameters[<span class="string">'W1'</span>]</span><br><span class="line">    b1 = parameters[<span class="string">'b1'</span>]</span><br><span class="line">    W2 = parameters[<span class="string">'W2'</span>]</span><br><span class="line">    b2 = parameters[<span class="string">'b2'</span>]</span><br><span class="line">    W3 = parameters[<span class="string">'W3'</span>]</span><br><span class="line">    b3 = parameters[<span class="string">'b3'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å‰å‘ä¼ æ’­è¿‡ç¨‹</span></span><br><span class="line">    Z1 = tf.add(tf.matmul(W1,X), b1)     <span class="comment"># Z1 = np.dot(W1, X) + b1</span></span><br><span class="line">    A1 = tf.nn.relu(Z1)                  <span class="comment"># A1 = relu(Z1)</span></span><br><span class="line">    Z2 = tf.add(tf.matmul(W2,A1), b2)    <span class="comment"># Z2 = np.dot(W2, a1) + b2</span></span><br><span class="line">    A2 = tf.nn.relu(Z2)                  <span class="comment"># A2 = relu(Z2)</span></span><br><span class="line">    Z3 = tf.add(tf.matmul(W3,A2), b3)    <span class="comment"># Z3 = np.dot(W3,Z2) + b3</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Z3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•å‰å‘ä¼ æ’­å–Šå‡º</span></span><br><span class="line">tf.reset_default_graph()</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    X, Y = create_placeholders(n_input, n_classes)</span><br><span class="line">    parameters = initialize_parameters()</span><br><span class="line">    Z3 = forward_propagation(X, parameters)</span><br><span class="line">    print(<span class="string">"Z3 = &#123;final_Z&#125;"</span>.format(final_Z=Z3))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è®¡ç®—æŸå¤±å‡½æ•°</span></span><br><span class="line"><span class="comment"># æ˜¯è®¡ç®—lossçš„æ—¶å€™äº†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_cost</span><span class="params">(Z3, Y)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    è®¡ç®—cost</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">    Z3 -- å‰å‘ä¼ æ’­çš„æœ€ç»ˆè¾“å‡ºï¼ˆ[10, n]ï¼‰nä¹Ÿæ˜¯ä½ è¾“å…¥çš„è®­ç»ƒæ•°æ®ä¸ªæ•°</span></span><br><span class="line"><span class="string">    Y -- </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›:</span></span><br><span class="line"><span class="string">    cost - æŸå¤±å‡½æ•° å¼ é‡ï¼ˆTensorï¼‰</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å¾—é¢„æµ‹å’Œå‡†ç¡®çš„label</span></span><br><span class="line">    logits = tf.transpose(Z3)</span><br><span class="line">    labels = tf.transpose(Y)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¡ç®—æŸå¤±</span></span><br><span class="line">    cost = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits = logits, labels = labels))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cost</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•è®¡ç®—æŸå¤±å‡½æ•°</span></span><br><span class="line">tf.reset_default_graph()</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    X, Y = create_placeholders(n_input, n_classes)</span><br><span class="line">    parameters = initialize_parameters()</span><br><span class="line">    Z3 = forward_propagation(X, parameters)</span><br><span class="line">    cost = compute_cost(Z3, Y)</span><br><span class="line">    print(<span class="string">"cost = &#123;cost&#125;"</span>.format(cost=cost))</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸ªå°±æ˜¯å…³é”®äº†ï¼Œå› ä¸ºæ¯ä¸€å±‚çš„å‚æ•°éƒ½æ˜¯é€šè¿‡åå‘ä¼ æ’­æ¥å®ç°æƒé‡å’Œåç½®é¡¹å‚æ•°æ›´æ–°çš„</span></span><br><span class="line"><span class="comment"># æ€»ä½“çš„åŸç†å°±æ˜¯ç»è¿‡å‰å‘ä¼ æ’­ï¼Œè®¡ç®—åˆ°æœ€åçš„å±‚ï¼Œåˆ©ç”¨softmaxåŠ äº¤å‰ç†µï¼Œç®—å‡ºç½‘ç»œçš„æŸå¤±å‡½æ•°</span></span><br><span class="line"><span class="comment"># ç„¶åå¯¹æŸå¤±å‡½æ•°è¿›è¡Œæ±‚åå¯¼ï¼Œåˆ©ç”¨åå‘ä¼ æ’­ç®—æ³•å®ç°æ¯ä¸€å±‚çš„æƒé‡å’Œåç½®é¡¹çš„æ›´æ–°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">model</span><span class="params">(train, test, learning_rate=<span class="number">0.0001</span>, num_epochs=<span class="number">16</span>, minibatch_size=<span class="number">32</span>, print_cost=True, graph_filename=<span class="string">'costs'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    å®ç°äº†ä¸€ä¸ªä¸‰å±‚çš„ç½‘ç»œç»“æ„: LINEAR-&gt;RELU-&gt;LINEAR-&gt;RELU-&gt;LINEAR-&gt;SOFTMAX.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">    train -- è®­ç»ƒé›†</span></span><br><span class="line"><span class="string">    test -- æµ‹è¯•é›†</span></span><br><span class="line"><span class="string">    learning_rate -- ä¼˜åŒ–æƒé‡æ—¶å€™æ‰€ç”¨åˆ°çš„å­¦ä¹ ç‡</span></span><br><span class="line"><span class="string">    num_epochs -- è®­ç»ƒç½‘ç»œçš„è½®æ¬¡</span></span><br><span class="line"><span class="string">    minibatch_size -- æ¯ä¸€æ¬¡é€è¿›ç½‘ç»œè®­ç»ƒçš„æ•°æ®ä¸ªæ•°ï¼ˆä¹Ÿå°±æ˜¯å…¶ä»–å‡½æ•°é‡Œé¢é‚£ä¸ªnå‚æ•°ï¼‰</span></span><br><span class="line"><span class="string">    print_cost -- æ¯ä¸€è½®ç»“æŸä»¥åçš„æŸå¤±å‡½æ•°</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›:</span></span><br><span class="line"><span class="string">    parameters -- è¢«ç”¨æ¥å­¦ä¹ çš„å‚æ•°</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¡®ä¿å‚æ•°ä¸è¢«è¦†ç›–é‡å†™</span></span><br><span class="line">    tf.reset_default_graph()</span><br><span class="line">    tf.set_random_seed(<span class="number">42</span>)</span><br><span class="line">    seed = <span class="number">42</span></span><br><span class="line">    <span class="comment"># è·å–è¾“å…¥å’Œè¾“å‡ºå¤§å°</span></span><br><span class="line">    (n_x, m) = train.images.T.shape</span><br><span class="line">    n_y = train.labels.T.shape[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    costs = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ›å»ºè¾“å…¥è¾“å‡ºæ•°æ®çš„å ä½ç¬¦</span></span><br><span class="line">    X, Y = create_placeholders(n_x, n_y)</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">    parameters = initialize_parameters()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">    Z3 = forward_propagation(X, parameters)</span><br><span class="line">    <span class="comment"># è®¡ç®—æŸå¤±å‡½æ•°</span></span><br><span class="line">    cost = compute_cost(Z3, Y)</span><br><span class="line">    <span class="comment"># ä½¿ç”¨AdamOptimizerä¼˜åŒ–å™¨å®ç°åå‘ä¼ æ’­ç®—æ³•ï¼ˆæœ€å°åŒ–costï¼‰</span></span><br><span class="line">    <span class="comment"># å…¶å®æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹çš„åå‘æ›´æ–°å‚æ•°çš„è¿‡ç¨‹éƒ½æ˜¯tensorflowç»™åšäº†</span></span><br><span class="line">    optimizer = tf.train.AdamOptimizer(learning_rate).minimize(cost)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å˜é‡åˆå§‹åŒ–å™¨</span></span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¼€å§‹tensorflowçš„sess æ¥è®¡ç®—tensorflowæ„å»ºå¥½çš„å›¾</span></span><br><span class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿™ä¸ªå°±æ˜¯ä¹‹å‰è¯´è¿‡çš„è¦è¿›è¡Œåˆå§‹åŒ–çš„</span></span><br><span class="line">        sess.run(init)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®­ç»ƒè½®æ¬¡</span></span><br><span class="line">        <span class="keyword">for</span> epoch <span class="keyword">in</span> range(num_epochs):</span><br><span class="line">            </span><br><span class="line">            epoch_cost = <span class="number">0.</span></span><br><span class="line">            num_minibatches = int(m / minibatch_size)</span><br><span class="line">            seed = seed + <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(num_minibatches):</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># è·å–ä¸‹ä¸€ä¸ªbatchçš„è®­ç»ƒæ•°æ®å’Œlabelæ•°æ®</span></span><br><span class="line">                minibatch_X, minibatch_Y = train.next_batch(minibatch_size)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ‰§è¡Œä¼˜åŒ–å™¨</span></span><br><span class="line">                _, minibatch_cost = sess.run([optimizer, cost], feed_dict=&#123;X: minibatch_X.T, Y: minibatch_Y.T&#125;)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ›´æ–°æ¯ä¸€è½®çš„æŸå¤±</span></span><br><span class="line">                epoch_cost += minibatch_cost / num_minibatches</span><br><span class="line">                </span><br><span class="line">            <span class="comment"># æ‰“å°æ¯ä¸€è½®çš„æŸå¤±</span></span><br><span class="line">            <span class="keyword">if</span> print_cost == <span class="keyword">True</span>:</span><br><span class="line">                print(<span class="string">"Cost after epoch &#123;epoch_num&#125;: &#123;cost&#125;"</span>.format(epoch_num=epoch, cost=epoch_cost))</span><br><span class="line">                costs.append(epoch_cost)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä½¿ç”¨matplotç”»å‡ºæŸå¤±çš„å˜åŒ–æ›²çº¿å›¾</span></span><br><span class="line">        plt.figure(figsize=(<span class="number">16</span>,<span class="number">5</span>))</span><br><span class="line">        plt.plot(np.squeeze(costs), color=<span class="string">'#2A688B'</span>)</span><br><span class="line">        plt.xlim(<span class="number">0</span>, num_epochs<span class="number">-1</span>)</span><br><span class="line">        plt.ylabel(<span class="string">"cost"</span>)</span><br><span class="line">        plt.xlabel(<span class="string">"iterations"</span>)</span><br><span class="line">        plt.title(<span class="string">"learning rate = &#123;rate&#125;"</span>.format(rate=learning_rate))</span><br><span class="line">        plt.savefig(graph_filename, dpi = <span class="number">300</span>)</span><br><span class="line">        plt.show()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¿å­˜å‚æ•°</span></span><br><span class="line">        parameters = sess.run(parameters)</span><br><span class="line">        print(<span class="string">"Parameters have been trained!"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—é¢„æµ‹å‡†ç‡</span></span><br><span class="line">        correct_prediction = tf.equal(tf.argmax(Z3), tf.argmax(Y))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æµ‹è¯•å‡†ç‡</span></span><br><span class="line">        accuracy = tf.reduce_mean(tf.cast(correct_prediction, <span class="string">"float"</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"Train Accuracy:"</span>, accuracy.eval(&#123;X: train.images.T, Y: train.labels.T&#125;))</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"Test Accuracy:"</span>, accuracy.eval(&#123;X: test.images.T, Y: test.labels.T&#125;))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> parameters</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦å¼€å§‹è®­ç»ƒæˆ‘ä»¬çš„fashion mnistç½‘ç»œäº†</span></span><br><span class="line">train = fashion_mnist.train <span class="comment"># è®­ç»ƒçš„æ•°æ®</span></span><br><span class="line">test = fashion_mnist.test <span class="comment"># æµ‹è¯•çš„æ•°æ®</span></span><br><span class="line"></span><br><span class="line">parameters = model(train, test, learning_rate = <span class="number">0.001</span>, num_epochs = <span class="number">16</span>, graph_filename = <span class="string">'fashion_mnist_costs'</span>)</span><br></pre></td></tr></table></figure><ul><li>ä¸Šé¢çš„ä»£ç æ˜¯å†™å¥½äº†ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªpythonçš„ä¾èµ–åº“ï¼ˆmatplotlibï¼‰éœ€è¦å®‰è£…ä»¥ä¸‹ï¼ŒåŒæ ·çš„åŠæ³•ï¼Œå°±æ˜¯è¿›å»tensorflowè¿™ä¸ªç¯å¢ƒé‡Œé¢ï¼Œç„¶åæ‰§è¡Œ<code>pip install matplotlib</code>å°±å¯ä»¥äº†ã€‚</li><li>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä»tensorflowä¸‹è½½æ•°æ®çš„æ—¶å€™ä¼šå¾ˆæ…¢ã€‚ï¼ˆæˆ‘ä»¬é€‰æ‹©ç›´æ¥ä»ä¸Šé¢ç»™å‡ºä¸‹è½½æ•°æ®é›†çš„githubç½‘å€ï¼Œç›´æ¥ä¸‹è½½ä»¥åï¼Œå°†æ•°æ®æ‹·è´åœ¨ä»£ç æ‰€åœ¨æ–‡ä»¶å¤¹çš„input/data/æ–‡ä»¶å¤¹é‡Œé¢ï¼Œæ€»å…±ç”±å››ä¸ªæ–‡ä»¶ç»„æˆï¼‰åˆ†åˆ«æ˜¯è®­ç»ƒæ•°æ®å›¾ç‰‡ã€è®­ç»ƒæ•°æ®labelå’Œæµ‹è¯•æ•°æ®å›¾ç‰‡ã€æµ‹è¯•æ•°æ®labelã€‚è¿™æ ·å°±å¯ä»¥çœå»ä¸‹è½½æ•°æ®æ—¶å€™æ¼«é•¿çš„ç­‰å¾…ã€‚</li></ul><ol start="3" type="1"><li>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨TensorFlowå®ç°çš„fashion-mnistçš„è¯†åˆ«ï¼Œæ€»ä½“æ ¹æ®å®éªŒç»“æœæ¥è¯´ï¼Œä»æµ‹è¯•é›†çš„æ•°æ®æ¥çœ‹ï¼Œæˆ‘è¾¾åˆ°çš„å‡†ç¡®ç‡ç»“æœæ˜¯88.5%ï¼Œè¿˜ç®—å¯ä»¥ã€‚åç»­æˆ‘ä»¬å¯èƒ½ä½¿ç”¨å…¶ä»–ä¸€äº›ç°æœ‰çš„ç½‘ç»œç»“æ„æ¥å®ç°fashion-mnistçš„è¯†åˆ«ï¼Œçœ‹çœ‹å‡†ç¡®ç‡ä¼šä¸ä¼šæé«˜ã€‚</li><li>å¦‚ä¸‹æ˜¯æˆ‘å¯¹ä¸Šé¢TensorFLowå‡ºç°çš„æ–¹æ³•ä»‹ç»ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">tf.placeholders(</span><br><span class="line">dtype,</span><br><span class="line">shape=<span class="keyword">None</span>,</span><br><span class="line">name=<span class="keyword">None</span></span><br><span class="line">)</span><br><span class="line">ä»å‚æ•°ä¸Šé¢çœ‹åˆ°ï¼Œæ€»å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</span><br><span class="line">dtypeï¼šåœ¨tensorä¸­è¢«å–‚æ•°æ®çš„å…ƒç´ ç±»å‹</span><br><span class="line">shape: tensorçš„shape</span><br><span class="line">nameï¼šå‘½å</span><br><span class="line">è¯´æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªtensorï¼Œåœ¨TensorFlowé‡Œé¢ï¼Œtensoræ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œå¤§å®¶åŠ¡å¿…æŒæ¡ï¼Œä¹Ÿå«å¼ é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ä¸€ä¸ªæ•°:å°±æ˜¯<span class="number">0</span>-é˜¶å¼ é‡ï¼Œä¹Ÿå«æ ‡é‡ã€‚ä¸€ä¸ªå‘é‡ï¼Œå°±æ˜¯<span class="number">1</span>-é˜¶å¼ é‡ã€‚ä¸€ä¸ªçŸ©é˜µï¼Œå°±æ˜¯<span class="number">2</span>-é˜¶å¼ é‡ï¼Œåé¢çš„å°±æ˜¯ä¸€ç›´å¾€é«˜ç»´äº†èµ°ï¼Œå¯¹åº”çš„å°±æ˜¯å¤šå°‘é˜¶å¼ é‡ã€‚</span><br><span class="line">è¿™ä¸ªæ–¹æ³•ï¼Œå¾ˆé‡è¦çš„åŸå› ä¹Ÿåœ¨äºå®ƒæ˜¯å®šä¹‰åœ¨Sessionæ‰§è¡Œrunçš„æ—¶å€™ï¼Œåœ¨åé¢å¡«å……æ•°æ®çš„å ä½ç¬¦ï¼Œä¹Ÿå°±æ˜¯feed_dictè¿™ä¸ªå˜é‡é‡Œé¢çš„æ•°æ®ï¼Œæ‰€ä»¥å¤§å®¶ï¼ŒåŠ¡å¿…è®°ä½è¿™ä¸€å…³é”®çš„æ¦‚å¿µã€‚åç»­ç”¨èµ·æ¥å°±ä¼šå¾ˆé¡ºæ‰‹ã€‚</span><br><span class="line">tf.get_variable()</span><br><span class="line">è¿™ä¸ªæ–¹æ³•åç»­åœ¨å±•å¼€æ¥è¯´ï¼Œä½ å…ˆç†è§£å°±æ˜¯ä½¿ç”¨å®ƒå¯ä»¥å®šä¹‰å˜é‡ï¼ˆä¿å­˜æƒé‡å’Œåç½®é¡¹çš„ï¼‰ï¼Œè¿˜å¯ä»¥åŠ ä¸€äº›ä¼˜åŒ–å™¨ï¼Œæ¯”å¦‚è¯´æ­£åˆ™ä¼˜åŒ–å™¨ç­‰ç­‰</span><br><span class="line">tf.matmul(</span><br><span class="line">a,</span><br><span class="line">b,</span><br><span class="line">)</span><br><span class="line">å±•ç¤ºç»™ä½ ä»¬åˆ—å‡ºè¿™ä¸¤ä¸ªå‚æ•°ï¼š</span><br><span class="line">aï¼šå°±æ˜¯å¾…æ“ä½œçš„çŸ©é˜µ<span class="number">1</span></span><br><span class="line">b: å°±æ˜¯å¾…æ“ä½œçš„çŸ©é˜µ<span class="number">2</span></span><br><span class="line">å‡½æ•°åŠŸèƒ½å°±æ˜¯å®ç°çŸ©é˜µçš„ç›¸ä¹˜è¿ç®—ï¼ˆå½“ç„¶è¦ç¬¦åˆåŸºæœ¬çš„çŸ©é˜µè¿ç®—æ ¼å¼ï¼‰</span><br><span class="line">tf.transpose(</span><br><span class="line">a,</span><br><span class="line">)</span><br><span class="line">å…ˆåˆ—å‡ºæ¥ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯çŸ©é˜µçš„è½¬ç½®</span><br><span class="line">Session().run(</span><br><span class="line">fetches,</span><br><span class="line">feed_list=<span class="keyword">None</span>,</span><br><span class="line">)</span><br><span class="line">è¿™ä¸ªæ–¹æ³•å°±æ˜¯è¿è¡Œå›¾ã€‚å¾ˆå…³é”®ï¼Œå…ˆæŒæ¡ä¸¤ä¸ªå‚æ•°:</span><br><span class="line">fetches: ä½ è¦ä»å›¾é‡Œé¢å–å‡ºçš„æ•°æ®ï¼ˆï¼‰</span><br><span class="line">feed_list: ä½ è¦ç»™å›¾å–‚çš„æ•°æ®ï¼ˆè¾“å…¥å’Œlabelæ•°æ®å°±æ˜¯ç”¨è¿™æ ·çš„æ–¹å¼æ¥åšçš„ï¼‰</span><br><span class="line">    æ¯”å¦‚æˆ‘ä»¬è®­ç»ƒçš„ç½‘ç»œä¸­è¾“å…¥çš„å›¾ç‰‡ä¿¡æ¯å’Œå¯¹åº”çš„labelä¿¡æ¯</span><br><span class="line">tf.reduce_mean(</span><br><span class="line">input_tensor,</span><br><span class="line">axis=<span class="keyword">None</span>,</span><br><span class="line">keepdims=<span class="keyword">None</span>,</span><br><span class="line">name=<span class="keyword">None</span>,</span><br><span class="line">redcution_indices=<span class="keyword">None</span>,</span><br><span class="line">keep_dims=<span class="keyword">None</span></span><br><span class="line">)</span><br><span class="line">è®¡ç®—è¾“å…¥tensorçš„æ€»å’Œï¼š</span><br><span class="line">input_tensor: è¦å åŠ çš„tensor</span><br><span class="line">axis: é€‰æ‹©é‚£ä¸ªç»´åº¦å åŠ </span><br><span class="line">keepdims: å åŠ å…ƒç´ ä»¥åï¼Œä¿ç•™åŸæ¥çš„ç»´åº¦ä¿¡æ¯</span><br><span class="line">nameï¼šå°±æ˜¯åå­—</span><br><span class="line">redcution_indicesï¼šè¢«axiså–ä»£</span><br><span class="line">keep_dimsï¼šè¢«keepdimså–ä»£</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»Šå¤©çš„ä»»åŠ¡é‡å¯èƒ½æœ‰ä¸€äº›å¤§ï¼Œå¤§å®¶åšæŒã€‚æ€»çš„æ¥è¯´å°±æ˜¯ä½¿ç”¨ç¥ç»ç½‘ç»œå¯¹å®é™…çš„ä¸€ä¸ªfashion-mnistæ•°æ®é›†è¿›è¡Œæœè£…ç§ç±»çš„è¯†åˆ«ï¼Œå¤§å®¶ä¸»è¦çœ‹çœ‹æˆ‘çš„ä»£ç ã€‚æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„æˆ‘åœ¨ä»£ç é‡Œé¢éƒ½åšå‡ºäº†æ³¨é‡Šã€‚</p><p>é‚®ç®±â€”â€”air@weaf.topæ¬¢è¿æ¥æ¢è®¨</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;tensorflow-åˆä½“éªŒfashion-mnist&quot;&gt;TensorFlow åˆä½“éªŒï¼ˆFashion-mnistï¼‰&lt;/h1&gt;
&lt;ol
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>rsyncçš„ä½¿ç”¨ä¸é…ç½®</title>
    <link href="http://weafteam.github.io/posts/cfc65600/"/>
    <id>http://weafteam.github.io/posts/cfc65600/</id>
    <published>2018-03-25T13:08:56.000Z</published>
    <updated>2018-05-29T01:27:49.793Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ä»€ä¹ˆæ˜¯rsync">ä¸€ã€ä»€ä¹ˆæ˜¯rsync</h2><p><strong>rsync</strong>ï¼Œremote synchronizeé¡¾åæ€æ„å°±çŸ¥é“å®ƒæ˜¯ä¸€æ¬¾å®ç°è¿œç¨‹åŒæ­¥åŠŸèƒ½çš„è½¯ä»¶ï¼Œå®ƒåœ¨åŒæ­¥æ–‡ä»¶çš„åŒæ—¶ï¼Œå¯ä»¥ä¿æŒåŸæ¥æ–‡ä»¶çš„æƒé™ã€æ—¶é—´ã€è½¯ç¡¬é“¾æ¥ç­‰é™„åŠ ä¿¡æ¯ã€‚ rsyncæ˜¯ç”¨ â€œrsync ç®—æ³•â€æä¾›äº†ä¸€ä¸ªå®¢æˆ·æœºå’Œè¿œç¨‹æ–‡ä»¶æœåŠ¡å™¨çš„æ–‡ä»¶åŒæ­¥çš„å¿«é€Ÿæ–¹æ³•ï¼Œè€Œä¸”å¯ä»¥é€šè¿‡sshæ–¹å¼æ¥ä¼ è¾“æ–‡ä»¶ï¼Œè¿™æ ·å…¶ä¿å¯†æ€§ä¹Ÿéå¸¸å¥½ï¼Œå¦å¤–å®ƒè¿˜æ˜¯å…è´¹çš„è½¯ä»¶ã€‚</p><h2 id="äºŒrsyncçš„å®‰è£…">äºŒã€rsyncçš„å®‰è£…</h2><p>rysncçš„å®˜æ–¹ç½‘ç«™ï¼šhttp://rsync.samba.org å¯ä»¥ä»ä¸Šé¢å¾—åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚ç›®å‰æœ€æ–°ç‰ˆæ˜¯3.1.2ã€‚å½“ç„¶ï¼Œå› ä¸ºrsyncæ˜¯ä¸€æ¬¾å¦‚æ­¤æœ‰ç”¨çš„è½¯ä»¶ï¼Œæ‰€ä»¥å¾ˆå¤šLinuxçš„å‘è¡Œç‰ˆæœ¬éƒ½å°†å®ƒæ”¶å½•åœ¨å†…äº†ã€‚</p><a id="more"></a><p>ã€€ã€€è½¯ä»¶åŒ…å®‰è£…</p><table><thead><tr class="header"><th>å‘½ä»¤</th><th>å¹³å°</th></tr></thead><tbody><tr class="odd"><td># sudo apt-get install rsync</td><td>æ³¨ï¼šåœ¨debianã€ubuntu ç­‰åœ¨çº¿å®‰è£…æ–¹æ³•ï¼›</td></tr><tr class="even"><td># yum install rsync</td><td>æ³¨ï¼šFedoraã€Redhat ç­‰åœ¨çº¿å®‰è£…æ–¹æ³•ï¼›</td></tr><tr class="odd"><td># rpm -ivh rsync</td><td>æ³¨ï¼šFedoraã€Redhat ç­‰rpmåŒ…å®‰è£…æ–¹æ³•ï¼›</td></tr></tbody></table><p>ã€€ã€€å…¶å®ƒLinuxå‘è¡Œç‰ˆï¼Œè¯·ç”¨ç›¸åº”çš„è½¯ä»¶åŒ…ç®¡ç†æ–¹æ³•æ¥å®‰è£…ã€‚</p><p>ã€€ã€€æºç åŒ…å®‰è£… <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€tar xvf  rsync-xxx.tar.gz</span><br><span class="line">ã€€ã€€cd rsync-xxx</span><br><span class="line">ã€€ã€€./configure --prefix=/usr  ;make ;make install   æ³¨ï¼šåœ¨ç”¨æºç </span><br></pre></td></tr></table></figure></p><p>åŒ…ç¼–è¯‘å®‰è£…ä¹‹å‰ï¼Œæ‚¨å¾—å®‰è£…gccç­‰ç¼–è¯‘å¼€å…·æ‰è¡Œï¼› ä¸‰ã€rsyncçš„é…ç½® â€”â€”â€”â€“ rsyncçš„ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªé…ç½®æ–‡ä»¶<strong>rsyncd.conf</strong>(ä¸»é…ç½®æ–‡ä»¶)ã€<strong>rsyncd.secrets</strong>(å¯†ç æ–‡ä»¶)ã€<strong>rsyncd.motd</strong>(rysncæœåŠ¡å™¨ä¿¡æ¯) æ¯”å¦‚æˆ‘ä»¬è¦å¤‡ä»½æœåŠ¡å™¨ä¸Šçš„/homeå’Œ/optï¼Œåœ¨/homeä¸­æˆ‘æƒ³æŠŠeasylifeå’Œsambaç›®å½•æ’é™¤åœ¨å¤–ï¼› <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€# Distributed under the terms of the GNU General Public License v2</span><br><span class="line">ã€€ã€€# Minimal configuration file for rsync daemon</span><br><span class="line">ã€€ã€€# See rsync(1) and rsyncd.conf(5) man pages for help</span><br><span class="line"></span><br><span class="line">ã€€ã€€# This line is required by the /etc/init.d/rsyncd script</span><br><span class="line">ã€€ã€€pid file = /var/run/rsyncd.pid   </span><br><span class="line">ã€€ã€€port = 873</span><br><span class="line">ã€€ã€€address = 192.168.1.171  </span><br><span class="line">ã€€ã€€#uid = nobody </span><br><span class="line">ã€€ã€€#gid = nobody    </span><br><span class="line">ã€€ã€€uid = root   </span><br><span class="line">ã€€ã€€gid = root  </span><br><span class="line"></span><br><span class="line">ã€€ã€€use chroot = yes  </span><br><span class="line">ã€€ã€€read only = yes </span><br><span class="line"></span><br><span class="line">ã€€ã€€#limit access to private LANs</span><br><span class="line">ã€€ã€€hosts allow=192.168.1.0/255.255.255.0 10.0.1.0/255.255.255.0  </span><br><span class="line">ã€€ã€€hosts deny=*</span><br><span class="line"></span><br><span class="line">ã€€ã€€max connections = 5 </span><br><span class="line">ã€€ã€€motd file = /etc/rsyncd.motd</span><br><span class="line"></span><br><span class="line">ã€€ã€€#This will give you a separate log file</span><br><span class="line">ã€€ã€€#log file = /var/log/rsync.log</span><br><span class="line"></span><br><span class="line">ã€€ã€€#This will log every file transferred - up to 85,000+ per user, per sync</span><br><span class="line">ã€€ã€€#transfer logging = yes</span><br><span class="line"></span><br><span class="line">ã€€ã€€log format = %t %a %m %f %b</span><br><span class="line">ã€€ã€€syslog facility = local3</span><br><span class="line">ã€€ã€€timeout = 300</span><br><span class="line"></span><br><span class="line">ã€€ã€€[rhel4home]   </span><br><span class="line">ã€€ã€€path = /home    </span><br><span class="line">ã€€ã€€list=yes </span><br><span class="line">ã€€ã€€ignore errors </span><br><span class="line">ã€€ã€€auth users = root</span><br><span class="line">ã€€ã€€secrets file = /etc/rsyncd.secrets  </span><br><span class="line">ã€€ã€€comment = This is RHEL 4 data  </span><br><span class="line">ã€€ã€€exclude = easylife/  samba/     </span><br><span class="line"></span><br><span class="line">ã€€ã€€[rhel4opt]</span><br><span class="line">ã€€ã€€path = /opt </span><br><span class="line">ã€€ã€€list=no</span><br><span class="line">ã€€ã€€ignore errors</span><br><span class="line">ã€€ã€€comment = This is RHEL 4 opt </span><br><span class="line">ã€€ã€€auth users = easylife</span><br><span class="line">ã€€ã€€secrets file = /etc/rsyncd/rsyncd.secrets</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€æ³¨ï¼šå…³äºauth usersæ˜¯å¿…é¡»åœ¨æœåŠ¡å™¨ä¸Šå­˜åœ¨çš„çœŸå®çš„ç³»ç»Ÿç”¨æˆ·ï¼Œå¦‚æœä½ æƒ³ç”¨å¤šä¸ªç”¨æˆ·ä»¥,å·éš”å¼€ï¼Œæ¯”å¦‚auth users = easylife,root ã€€ã€€è®¾å®šå¯†ç æ–‡ä»¶</p><p>ã€€ã€€å¯†ç æ–‡ä»¶æ ¼å¼å¾ˆç®€å•ï¼Œrsyncd.secretsçš„å†…å®¹æ ¼å¼ä¸ºï¼š</p><p>ã€€ã€€ç”¨æˆ·å:å¯†ç </p><p>ã€€ã€€æˆ‘ä»¬åœ¨ä¾‹å­ä¸­rsyncd.secretsçš„å†…å®¹å¦‚ä¸‹ç±»ä¼¼çš„ï¼›åœ¨æ–‡æ¡£ä¸­è¯´ï¼Œæœ‰äº›ç³»ç»Ÿä¸æ”¯æŒé•¿å¯†ç ï¼Œè‡ªå·±å°è¯•ç€è®¾ç½®ä¸€ä¸‹å§ã€‚ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€easylife:keer</span><br><span class="line">ã€€ã€€root:mike</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€chown root.root rsyncd.secrets ã€€#ä¿®æ”¹å±ä¸»</span><br><span class="line">ã€€ã€€chmod 600 rsyncd.secrets     #ä¿®æ”¹æƒé™</span><br></pre></td></tr></table></figure><p>ã€€ã€€æ³¨ï¼š1ã€å°†rsyncd.secretsè¿™ä¸ªå¯†ç æ–‡ä»¶çš„æ–‡ä»¶å±æ€§è®¾ä¸ºrootæ‹¥æœ‰, ä¸”æƒé™è¦è®¾ä¸º600, å¦åˆ™æ— æ³•å¤‡ä»½æˆåŠŸ! å‡ºäºå®‰å…¨ç›®çš„ï¼Œæ–‡ä»¶çš„å±æ€§å¿…éœ€æ˜¯åªæœ‰å±ä¸»å¯è¯»ã€‚ ã€€ã€€ã€€ã€€2ã€è¿™é‡Œçš„å¯†ç å€¼å¾—æ³¨æ„ï¼Œä¸ºäº†å®‰å…¨ä½ ä¸èƒ½æŠŠç³»ç»Ÿç”¨æˆ·çš„å¯†ç å†™åœ¨è¿™é‡Œã€‚æ¯”å¦‚ä½ çš„ç³»ç»Ÿç”¨æˆ·easylifeå¯†ç æ˜¯000000ï¼Œä¸ºäº†å®‰å…¨ä½ å¯ä»¥è®©rsyncä¸­çš„easylifeä¸ºkeerã€‚è¿™å’Œsambaçš„ç”¨æˆ·è®¤è¯çš„å¯†ç åŸç†æ˜¯å·®ä¸å¤šçš„ã€‚</p><p>ã€€ã€€è®¾å®šrsyncd.motd æ–‡ä»¶;</p><p>ã€€ ã€€å®ƒæ˜¯å®šä¹‰rysncæœåŠ¡å™¨ä¿¡æ¯çš„ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ç™»å½•ä¿¡æ¯ã€‚æ¯”å¦‚è®©ç”¨æˆ·çŸ¥é“è¿™ä¸ªæœåŠ¡å™¨æ˜¯è°æä¾›çš„ç­‰ï¼›ç±»ä¼¼ftpæœåŠ¡å™¨ç™»å½•æ—¶ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„ linuxsir.org ftp â€¦â€¦ã€‚ å½“ç„¶è¿™åœ¨å…¨å±€å®šä¹‰å˜é‡æ—¶ï¼Œå¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½ å¯ä»¥ç”¨#å·æ³¨æ‰ï¼Œæˆ–åˆ é™¤ï¼›æˆ‘åœ¨è¿™é‡Œå†™äº†ä¸€ä¸ª rsyncd.motdçš„å†…å®¹ä¸ºï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">ã€€ã€€Welcome to use the mike.org.cn rsync services!</span><br><span class="line">2002------2009</span><br><span class="line">ã€€ã€€++++++++++++++++++++++++++++++++++++++++++++++</span><br></pre></td></tr></table></figure></p><h2 id="å››å¯åŠ¨rsyncæœåŠ¡å™¨">å››ã€å¯åŠ¨rsyncæœåŠ¡å™¨</h2><p>ç›¸å½“ç®€å•ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•</p><p>ã€€ã€€Aã€â€“daemonå‚æ•°æ–¹å¼ï¼Œæ˜¯è®©rsyncä»¥æœåŠ¡å™¨æ¨¡å¼è¿è¡Œ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#/usr/bin/rsync --daemon  --config=/etc/rsyncd/rsyncd.conf ã€€#--configç”¨äºæŒ‡å®šrsyncd.confçš„ä½ç½®,å¦‚æœåœ¨/etcä¸‹å¯ä»¥ä¸å†™</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€Bã€xinetdæ–¹å¼ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€ä¿®æ”¹servicesåŠ å…¥å¦‚ä¸‹å†…å®¹</span><br><span class="line">ã€€ã€€# nano -w /etc/services</span><br><span class="line"></span><br><span class="line">ã€€ã€€rsyncã€€ã€€873/tcpã€€ã€€# rsync </span><br><span class="line">ã€€ã€€rsyncã€€ã€€873/udpã€€ã€€# rsync</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€è¿™ä¸€æ­¥ä¸€èˆ¬å¯ä»¥ä¸åšï¼Œé€šå¸¸éƒ½æœ‰è¿™ä¸¤è¡Œ(æˆ‘çš„RHEL4å’ŒGENTOOé»˜è®¤éƒ½æœ‰)ã€‚ä¿®æ”¹çš„ç›®çš„æ˜¯è®©ç³»ç»ŸçŸ¥é“873ç«¯å£å¯¹åº”çš„æœåŠ¡åä¸ºrsyncã€‚å¦‚æ²¡æœ‰çš„è¯å°±è‡ªè¡ŒåŠ å…¥ã€‚</p><p>ã€€ã€€è®¾å®š /etc/xinetd.d/rsync, ç®€å•ä¾‹å­å¦‚ä¸‹: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€# default: off</span><br><span class="line">ã€€ã€€# description: The rsync server is a good addition to am ftp server, as it \</span><br><span class="line">ã€€ã€€#       allows crc checksumming etc.</span><br><span class="line">ã€€ã€€service rsync</span><br><span class="line">ã€€ã€€&#123;</span><br><span class="line">disable = no</span><br><span class="line">socket_type     = stream</span><br><span class="line">wait            = no</span><br><span class="line">user            = root</span><br><span class="line">server          = /usr/bin/rsync</span><br><span class="line">server_args     = --daemon</span><br><span class="line">log_on_failure  += USERID</span><br><span class="line">ã€€ã€€&#125;</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€ä¸Šè¿°, ä¸»è¦æ˜¯è¦æ‰“å¼€rsyncé€™å€‹daemon, ä¸€æ—¦æœ‰rsync clientè¦è¿æ¥æ™‚, xinetdä¼šæŠŠå®ƒè½¬ä»‹çµ¦ rsyncd(port 873)ã€‚ç„¶åservice xinetd restart, ä½¿ä¸Šè¿°è®¾å®šç”Ÿæ•ˆ.</p><p>ã€€ã€€rsyncæœåŠ¡å™¨å’Œé˜²ç«å¢™</p><p>ã€€ã€€Linux é˜²ç«å¢™æ˜¯ç”¨iptablesï¼Œæ‰€ä»¥æˆ‘ä»¬è‡³å°‘åœ¨æœåŠ¡å™¨ç«¯è¦è®©ä½ æ‰€å®šä¹‰çš„rsync æœåŠ¡å™¨ç«¯å£é€šè¿‡ï¼Œå®¢æˆ·ç«¯ä¸Šä¹Ÿåº”è¯¥è®©é€šè¿‡ã€‚ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#iptables -A INPUT -p tcp -m state --state NEW  -m tcp --dport 873 -j ACCEPT</span><br><span class="line">ã€€ã€€#iptables -L  æŸ¥çœ‹ä¸€ä¸‹é˜²ç«å¢™æ˜¯ä¸æ˜¯æ‰“å¼€äº† 873ç«¯å£</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€å¦‚æœä½ ä¸å¤ªæ‡‚é˜²ç«å¢™çš„é…ç½®ï¼Œå¯ä»¥å…ˆservice iptables stop å°†é˜²ç«å¢™å…³æ‰ã€‚å½“ç„¶åœ¨ç”Ÿäº§ç¯å¢ƒè¿™æ˜¯å¾ˆå±é™©çš„ï¼Œåšå®éªŒæ‰å¯ä»¥è¿™ä¹ˆåšå“Ÿï¼</p><h2 id="äº”é€šè¿‡rsyncå®¢æˆ·ç«¯æ¥åŒæ­¥æ•°æ®">äº”ã€é€šè¿‡rsyncå®¢æˆ·ç«¯æ¥åŒæ­¥æ•°æ®</h2><h3 id="b1åˆ—å‡ºrsync-æœåŠ¡å™¨ä¸Šçš„æ‰€æä¾›çš„åŒæ­¥å†…å®¹">B1ã€åˆ—å‡ºrsync æœåŠ¡å™¨ä¸Šçš„æ‰€æä¾›çš„åŒæ­¥å†…å®¹ï¼›</h3><p>ã€€ã€€é¦–å…ˆï¼šæˆ‘ä»¬çœ‹çœ‹rsyncæœåŠ¡å™¨ä¸Šæä¾›äº†å“ªäº›å¯ç”¨çš„æ•°æ®æº</p><p>ã€€ã€€# rsync â€“list-only root@192.168.145.5:: ã€€ã€€++++++++++++++++++++++++++++++++++++++++++++++ ã€€ã€€Welcome to use the mike.org.cn rsync services! ã€€ã€€ 2002â€”â€”2009 ã€€ã€€++++++++++++++++++++++++++++++++++++++++++++++</p><p>ã€€ã€€rhel4home This is RHEL 4 data</p><p>ã€€ ã€€æ³¨ï¼šå‰é¢æ˜¯rsyncæ‰€æä¾›çš„æ•°æ®æºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨rsyncd.confä¸­æ‰€å†™çš„[rhel4home]æ¨¡å—ã€‚è€Œâ€œThis is RHEL 4 dataâ€æ˜¯ç”±[rhel4home]æ¨¡å—ä¸­çš„ comment = This is RHEL 4 data æä¾›çš„ï¼›ä¸ºä»€ä¹ˆæ²¡æœ‰æŠŠrhel4optæ•°æ®æºåˆ—å‡ºæ¥å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨[rhel4opt]ä¸­å·²ç»æŠŠlist=noäº†ã€‚</p><p>ã€€ã€€$ rsync â€“list-only root@192.168.145.5::rhel4home</p><p>ã€€ã€€++++++++++++++++++++++++++++++++++++++++++++++ ã€€ã€€Welcome to use the mike.org.cn rsync services! ã€€ã€€ 2002â€”â€”2009 ã€€ã€€++++++++++++++++++++++++++++++++++++++++++++++</p><p>ã€€ã€€Password: ã€€ã€€drwxr-xr-x 4096 2009/03/15 21:33:13 . ã€€ã€€-rw-râ€“râ€“ 1018 2009/03/02 02:33:41 ks.cfg ã€€ã€€-rwxr-xr-x 21288 2009/03/15 21:33:13 wgetpaste ã€€ã€€drwxrwxr-x 4096 2008/10/28 21:04:05 cvsroot ã€€ã€€drwxâ€”â€” 4096 2008/11/30 16:30:58 easylife ã€€ã€€drwsr-sr-x 4096 2008/09/20 22:18:05 giddir ã€€ã€€drwxâ€”â€” 4096 2008/09/29 14:18:46 quser1 ã€€ã€€drwxâ€”â€” 4096 2008/09/27 14:38:12 quser2 ã€€ã€€drwxâ€”â€” 4096 2008/11/14 06:10:19 test ã€€ã€€drwxâ€”â€” 4096 2008/09/22 16:50:37 vbird1 ã€€ã€€drwxâ€”â€” 4096 2008/09/19 15:28:45 vbird2</p><p>ã€€ã€€åé¢çš„root@ipä¸­ï¼Œrootæ˜¯æŒ‡å®šå¯†ç æ–‡ä»¶ä¸­çš„ç”¨æˆ·åï¼Œä¹‹åçš„::rhel4homeè¿™æ˜¯rhel4homeæ¨¡å—å ### B2ã€rsyncå®¢æˆ·ç«¯åŒæ­¥æ•°æ®ï¼›</p><p>ã€€ã€€#rsync -avzP root@192.168.145.5::rhel4home rhel4home ã€€ã€€Password: è¿™é‡Œè¦è¾“å…¥rootçš„å¯†ç ï¼Œæ˜¯æœåŠ¡å™¨ç«¯rsyncd.secretsæä¾›çš„ã€‚åœ¨å‰é¢çš„ä¾‹å­ä¸­æˆ‘ä»¬ç”¨çš„æ˜¯mikeï¼Œè¾“å…¥çš„å¯†ç å¹¶ä¸å›æ˜¾ï¼Œè¾“å¥½å°±å›è½¦ã€‚</p><p>ã€€ ã€€æ³¨ï¼š è¿™ä¸ªå‘½ä»¤çš„æ„æ€å°±æ˜¯è¯´ï¼Œç”¨rootç”¨æˆ·ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šï¼ŒæŠŠrhel4homeæ•°æ®ï¼ŒåŒæ­¥åˆ°æœ¬åœ°å½“å‰ç›®å½•rhel4homeä¸Šã€‚å½“ç„¶æœ¬åœ°çš„ç›®å½•æ˜¯å¯ä»¥ä½ è‡ªå·± å®šä¹‰çš„ã€‚å¦‚æœå½“ä½ åœ¨å®¢æˆ·ç«¯ä¸Šå½“å‰æ“ä½œçš„ç›®å½•ä¸‹æ²¡æœ‰rhel4homeè¿™ä¸ªç›®å½•æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸€ä¸ªï¼›å½“å­˜åœ¨rhel4homeè¿™ä¸ªç›®å½•ä¸­ï¼Œä½ è¦æ³¨æ„ å®ƒçš„å†™æƒé™ã€‚ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#rsync -avzP  --delete linuxsir@linuxsir.org::rhel4home   rhel4home</span><br></pre></td></tr></table></figure></p><p>ã€€ ã€€è¿™å›æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªâ€“delete é€‰é¡¹ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ä¸Šçš„æ•°æ®è¦ä¸æœåŠ¡å™¨ç«¯å®Œå…¨ä¸€è‡´ï¼Œå¦‚æœ linuxsirhomeç›®å½•ä¸­æœ‰æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œåˆ™åˆ é™¤ã€‚æœ€ç»ˆç›®çš„æ˜¯è®©linuxsirhomeç›®å½•ä¸Šçš„æ•°æ®å®Œå…¨ä¸æœåŠ¡å™¨ä¸Šä¿æŒä¸€è‡´ï¼›ç”¨çš„æ—¶å€™è¦ å°å¿ƒç‚¹ï¼Œæœ€å¥½ä¸è¦æŠŠå·²ç»æœ‰é‡è¦æ•°æ‰€æ®çš„ç›®å½•ï¼Œå½“åšæœ¬åœ°æ›´æ–°ç›®å½•ï¼Œå¦åˆ™ä¼šæŠŠä½ çš„æ•°æ®å…¨éƒ¨åˆ é™¤ï¼›</p><p>ã€€ã€€è¨­å®š rsync client</p><p>ã€€ã€€è®¾å®šå¯†ç æ–‡ä»¶ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#rsync -avzP  --delete  --password-file=rsyncd.secrets   root@192.168.145.5::rhel4home rhel4home</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€è¿™æ¬¡æˆ‘ä»¬åŠ äº†ä¸€ä¸ªé€‰é¡¹ â€“password-file=rsyncd.secretsï¼Œè¿™æ˜¯å½“æˆ‘ä»¬ä»¥rootç”¨æˆ·ç™»å½•rsyncæœåŠ¡å™¨åŒæ­¥æ•°æ®æ—¶ï¼Œå¯†ç å°†è¯»å–rsyncd.secretsè¿™ä¸ªæ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å†…å®¹åªæ˜¯rootç”¨æˆ·çš„å¯†ç ã€‚æˆ‘ä»¬è¦å¦‚ä¸‹åšï¼›</p><p>ã€€ã€€# touch rsyncd.secrets ã€€ã€€# chmod 600 rsyncd.secrets ã€€ã€€# echo â€œmikeâ€&gt; rsyncd.secrets</p><p>ã€€ã€€# rsync -avzP â€“delete â€“password-file=rsyncd.secrets root@192.168.145.5::rhel4home rhel4home</p><p>ã€€ã€€æ³¨ï¼šè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä»½å¯†ç æ–‡ä»¶æƒé™å±æ€§è¦è®¾å¾—åªæœ‰å±ä¸»å¯è¯»ã€‚</p><p>ã€€ã€€ã€€ã€€è¿™æ ·å°±ä¸éœ€è¦å¯†ç äº†ï¼›å…¶å®è¿™æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œå› ä¸ºæœåŠ¡å™¨é€šè¿‡crond è®¡åˆ’ä»»åŠ¡è¿˜æ˜¯æœ‰å¿…è¦çš„ï¼› ### B3ã€è®©rsyncå®¢æˆ·ç«¯è‡ªåŠ¨ä¸æœåŠ¡å™¨åŒæ­¥æ•°æ®</p><p>ã€€ ã€€æœåŠ¡å™¨æ˜¯é‡é‡çº§åº”ç”¨ï¼Œæ‰€ä»¥æ•°æ®çš„ç½‘ç»œå¤‡ä»½è¿˜æ˜¯æä¸ºé‡è¦çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§å‹æœåŠ¡å™¨ä¸Šé…ç½®å¥½rsync æœåŠ¡å™¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸€å°è£…æœ‰rysncæœºå™¨å½“åšæ˜¯å¤‡ä»½æœåŠ¡å™¨ã€‚è®©è¿™å°å¤‡ä»½æœåŠ¡å™¨ï¼Œæ¯å¤©åœ¨æ—©ä¸Š4ç‚¹å¼€å§‹åŒæ­¥æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼›å¹¶ä¸”æ¯ä¸ªå¤‡ä»½éƒ½æ˜¯å®Œæ•´å¤‡ä»½ã€‚æœ‰æ—¶ ç¡¬ç›˜åæ‰ï¼Œæˆ–è€…æœåŠ¡å™¨æ•°æ®è¢«åˆ é™¤ï¼Œå®Œæ•´å¤‡ä»½è¿˜æ˜¯ç›¸å½“é‡è¦çš„ã€‚è¿™ç§å¤‡ä»½ç›¸å½“äºæ¯å¤©ä¸ºæœåŠ¡å™¨çš„æ•°æ®åšä¸€ä¸ªé•œåƒï¼Œå½“ç”Ÿäº§å‹æœåŠ¡å™¨å‘ç”Ÿäº‹æ•…æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾æ¢å¤æ•° æ®ï¼Œèƒ½æŠŠæ•°æ®æŸå¤±é™åˆ°æœ€ä½ï¼›æ˜¯ä¸æ˜¯è¿™ä¹ˆå›äº‹ï¼Ÿï¼Ÿ</p><p>ã€€ã€€step1ï¼šåˆ›å»ºåŒæ­¥è„šæœ¬å’Œå¯†ç æ–‡ä»¶ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#mkdir   /etc/cron.daily.rsync</span><br><span class="line">ã€€ã€€#cd  /etc/cron.daily.rsync </span><br><span class="line">ã€€ã€€#touch rhel4home.sh  rhel4opt.sh </span><br><span class="line">ã€€ã€€#chmod 755 /etc/cron.daily.rsync/*.sh  </span><br><span class="line">ã€€ã€€#mkdir /etc/rsyncd/</span><br><span class="line">ã€€ã€€#touch /etc/rsyncd/rsyncrhel4root.secrets</span><br><span class="line">ã€€ã€€#touch /etc/rsyncd/rsyncrhel4easylife.secrets</span><br><span class="line">ã€€ã€€#chmod 600  /etc/rsyncd/rsync.*</span><br></pre></td></tr></table></figure></p><p>ã€€ ã€€æ³¨ï¼š æˆ‘ä»¬åœ¨ /etc/cron.daily/ä¸­åˆ›å»ºäº†ä¸¤ä¸ªæ–‡ä»¶rhel4home.shå’Œrhel4opt.sh ï¼Œå¹¶ä¸”æ˜¯æƒé™æ˜¯755çš„ã€‚åˆ›å»ºäº†ä¸¤ä¸ªå¯†ç æ–‡ä»¶rootç”¨æˆ·ç”¨çš„æ˜¯rsyncrhel4root.secrets ï¼Œeasylifeç”¨æˆ·ç”¨çš„æ˜¯ rsyncrhel4easylife.secretsï¼Œæƒé™æ˜¯600ï¼›</p><p>ã€€ã€€æˆ‘ä»¬ç¼–è¾‘rhel4home.shï¼Œå†…å®¹æ˜¯å¦‚ä¸‹çš„ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#!/bin/sh</span><br><span class="line">ã€€ã€€#backup 192.168.145.5:/home </span><br><span class="line">ã€€ã€€/usr/bin/rsync   -avzP  --password-file=/etc/rsyncd/rsyncrhel4root.secrets    root@192.168.145.5::rhel4home   /home/rhel4homebak/$(date +&apos;%m-%d-%y&apos;)</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€æˆ‘ä»¬ç¼–è¾‘ rhel4opt.sh ï¼Œå†…å®¹æ˜¯ï¼š <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#!/bin/sh</span><br><span class="line">ã€€ã€€#backup 192.168.145.5:/opt </span><br><span class="line">ã€€ã€€/usr/bin/rsync   -avzP  --password-file=/etc/rsyncd/rsyncrhel4easylife.secrets    easylife@192.168.145.5::rhel4opt   /home/rhel4hoptbak/$(date +&apos;%m-%d-%y&apos;)</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€æ³¨ï¼šä½ å¯ä»¥æŠŠrhel4home.shå’Œrhel4opt.shçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚éƒ½å†™åˆ°rhel4bak.shä¸­ï¼›</p><p>ã€€ã€€æ¥ç€æˆ‘ä»¬ä¿®æ”¹ /etc/rsyncd/rsyncrhel4root.secretså’Œrsyncrhel4easylife.secretsçš„å†…å®¹ï¼› <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€# echo &quot;mike&quot; &gt; /etc/rsyncd/rsyncrhel4root.secrets</span><br><span class="line">ã€€ã€€# echo &quot;keer&quot;&gt; /etc/rsyncd/rsyncrhel4easylife.secrets</span><br></pre></td></tr></table></figure></p><p>ã€€ ã€€ç„¶åæˆ‘ä»¬å†/homeç›®å½•ä¸‹åˆ›å»ºrhel4homebak å’Œrhel4optbakä¸¤ä¸ªç›®å½•ï¼Œæ„æ€æ˜¯æœåŠ¡å™¨ç«¯çš„rhel4homeæ•°æ®åŒæ­¥åˆ°å¤‡ä»½æœåŠ¡å™¨ä¸Šçš„/home/rhel4homebak ä¸‹ï¼Œrhel4optæ•°æ®åŒæ­¥åˆ° /home/rhel4optbak/ç›®å½•ä¸‹ã€‚å¹¶æŒ‰å¹´æœˆæ—¥å½’æ¡£åˆ›å»ºç›®å½•ï¼›æ¯å¤©å¤‡ä»½éƒ½å­˜æ¡£ï¼› <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#mkdir /home/rhel4homebak</span><br><span class="line">ã€€ã€€#mkdir /home/rhel4optbak</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€step2ï¼šä¿®æ”¹crondæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ åŠ å…¥åˆ°è®¡åˆ’ä»»åŠ¡ <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€#crontab  -e</span><br></pre></td></tr></table></figure></p><p>ã€€ã€€åŠ å…¥ä¸‹é¢çš„å†…å®¹ï¼š</p><p>ã€€ã€€# Run daily cron jobs at 4:10 every day backup rhel4 data:<br>ã€€ã€€10 4 * * * /usr/bin/run-parts /etc/cron.daily.rsync 1&gt; /dev/null</p><p>ã€€ã€€æ³¨ï¼šç¬¬ä¸€è¡Œæ˜¯æ³¨é‡Šï¼Œæ˜¯è¯´æ˜å†…å®¹ï¼Œè¿™æ ·èƒ½è‡ªå·±è®°ä½ã€‚ ã€€ã€€ã€€ã€€ç¬¬äºŒè¡Œè¡¨ç¤ºåœ¨æ¯å¤©æ—©ä¸Š4ç‚¹10åˆ†çš„æ—¶å€™ï¼Œè¿è¡Œ /etc/cron.daily.rsync ä¸‹çš„å¯æ‰§è¡Œè„šæœ¬ä»»åŠ¡ï¼› ã€€ã€€ã€€ã€€ ã€€ã€€é…ç½®å¥½åï¼Œè¦é‡å¯crond æœåŠ¡å™¨ï¼› <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ã€€ã€€# killall crond    æ³¨ï¼šæ€æ­»crond æœåŠ¡å™¨çš„è¿›ç¨‹ï¼›</span><br><span class="line">ã€€ã€€# ps aux |grep crond  æ³¨ï¼šæŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦è¢«æ€æ­»ï¼›</span><br><span class="line">ã€€ã€€# /usr/sbin/crond    æ³¨ï¼šå¯åŠ¨ crond æœåŠ¡å™¨ï¼›</span><br><span class="line">ã€€ã€€# ps aux  |grep crond  æ³¨ï¼šæŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦å¯åŠ¨äº†ï¼Ÿ</span><br><span class="line">ã€€ã€€root      3815  0.0  0.0   1860   664 ?        S    14:44   0:00 /usr/sbin/crond</span><br><span class="line">ã€€ã€€root      3819  0.0  0.0   2188   808 pts/1    S+   14:45   0:00 grep crond</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      rsyncçš„ä½¿ç”¨ä¸é…ç½®
    
    </summary>
    
      <category term="Linux" scheme="http://weafteam.github.io/categories/Linux/"/>
    
    
      <category term="Linuxè¿ç»´" scheme="http://weafteam.github.io/tags/Linux%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆäºŒï¼‰jiebaä¸­æ–‡åˆ†è¯å·¥å…·è¿›é˜¶</title>
    <link href="http://weafteam.github.io/posts/931939a5/"/>
    <id>http://weafteam.github.io/posts/931939a5/</id>
    <published>2018-03-19T11:57:19.000Z</published>
    <updated>2018-05-29T01:27:49.796Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>jiebaä¸­æ–‡åˆ†è¯å·¥å…·ä½¿ç”¨è¿›é˜¶ç¯‡ï¼ŒåºŸè¯ä¸å¤šè¯´å—ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬æ¬¡çš„å­¦ä¹ å§~</p></blockquote><hr><h1 id="å¦‚ä½•è®©åˆ†è¯çš„æ›´åŠ å‡†ç¡®">å¦‚ä½•è®©åˆ†è¯çš„æ›´åŠ å‡†ç¡®</h1><p>æˆ‘ä»¬ä¹‹å‰ä¸¾å¾—ä¾‹å­æœ‰äº›æ–‡æœ¬å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬åæ¥ç¡®å®æ¢äº†å®˜æ–¹çš„æµ‹è¯•æ–‡æœ¬ã€Šå›´åŸã€‹ï¼Œä½†æ˜¯å‡æ²¡é¿å…ä¸€ä¸ªé—®é¢˜ï¼Œè¿™äº›æµ‹è¯•ä¾‹éƒ½ååˆ†åœ°ä¸­è§„ä¸­çŸ©ã€‚åœ¨å®é™…ä¸­éœ€è¦æˆ‘ä»¬åšåˆ†è¯çš„æ–‡æœ¬å¯èƒ½æ˜¯å¤šç§å¤šæ ·çš„ï¼Œè¿™æ—¶å€™çš„åˆ‡è¯æœ‰å¯èƒ½ä¼šä¸å¤ªç‰¹åˆ«ç†æƒ³ï¼Œå¯¼è‡´åˆ†è¯çš„ä¸å‡†ç¡®ã€‚</p><p>é‚£æˆ‘ä»¬ä¸å¦¨ä¸‹ä¸€ä¸ªåˆ«çš„ç”µå­ä¹¦ï¼ˆè¿™é‡Œæˆ‘ä¸‹è½½çš„æ˜¯ã€Šæ–—ç ´è‹ç©¹ã€‹ï¼Œä¸ºäº†æµ‹è¯•æˆ‘åªç”¨äº†ç¬¬ä¸€ç« çš„æ–‡æœ¬ï¼‰ï¼Œç„¶åå†è¿›è¡Œåˆ‡è¯ï¼Œçœ‹ä¸‹æ˜¯å¦å­˜åœ¨è¿™æ ·çš„é—®é¢˜ã€‚è¿™é‡Œæˆ‘ä»¬ç¨å¾®æ”¹æ”¹ä¸Šæ¬¡çš„å»åœç”¨è¯çš„ä»£ç ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">d = path.dirname(__file__) <span class="comment"># è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„</span></span><br><span class="line"></span><br><span class="line">text_path = <span class="string">'txt/chapter2.txt'</span> <span class="comment">#ã€Šæ–—ç ´è‹ç©¹ã€‹ç¬¬ä¸€ç« çš„æ–‡æœ¬è·¯å¾„</span></span><br><span class="line">text = open(path.join(d, text_path),<span class="string">'rb'</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CutWords</span><span class="params">(text)</span>:</span></span><br><span class="line">    mywordlist = []</span><br><span class="line">    seg_list = jieba.cut(text, cut_all=<span class="keyword">False</span>)</span><br><span class="line">    liststr=<span class="string">"/ "</span>.join(seg_list) <span class="comment"># æ·»åŠ åˆ‡åˆ†ç¬¦</span></span><br><span class="line">    <span class="keyword">for</span> myword <span class="keyword">in</span> liststr.split(<span class="string">'/'</span>):</span><br><span class="line">        <span class="keyword">if</span> len(myword.strip())&gt;<span class="number">1</span>:</span><br><span class="line">            mywordlist.append(myword)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(mywordlist) <span class="comment">#è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line">txt5 = CutWords(text)</span><br><span class="line">text_write = <span class="string">'txt/5.txt'</span></span><br><span class="line"><span class="keyword">with</span> open(text_write,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(txt5)</span><br><span class="line">    print(<span class="string">"Success"</span>)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœå¦‚ä¸‹ï¼š</strong></p><p><img src="https://i.loli.net/2018/03/20/5ab12557a30b9.png" alt="result_cutwords.png"></p><p>ç»ˆäºè¢«æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªåˆ‡è¯é”™è¯¯ï¼ŒåŸæ–‡æ˜¯è¿™æ ·çš„ï¼š</p><p>è§åªšè„‘ä¸­å¿½ç„¶æµ®ç°å‡ºä¸‰å¹´å‰é‚£æ„æ°”é£å‘çš„å°‘å¹´</p><p>æŒ‰ç…§æˆ‘ä»¬æ­£å¸¸çš„æ–­å¥ï¼Œåº”ä¸ºï¼š</p><p>è§åªš/è„‘ä¸­/å¿½ç„¶/æµ®ç°â€¦.ï¼Œè€Œjiebaå´è®¤ä¸ºâ€œè§åªšè„‘â€æ˜¯ä¸€ä¸ªå•è¯ï¼Œä»è€Œå¯¼è‡´æ­¤å¤„åˆ†è¯ä¸ç†æƒ³ã€‚</p><p>jiebaè€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œè€Œä¸”æœ‰å¾ˆå¤šçš„åº”å¯¹æ–¹æ¡ˆï¼Œä¸‹é¢æˆ‘ä»¬å…ˆè¯´æœ€ç®€å•çš„ã€‚</p><h1 id="è°ƒæ•´è¯å…¸">è°ƒæ•´è¯å…¸</h1><h2 id="æ–¹æ³•1åŠ¨æ€ä¿®æ”¹è¯å…¸">æ–¹æ³•1ï¼šåŠ¨æ€ä¿®æ”¹è¯å…¸</h2><p>ä½¿ç”¨add_word(word,freq=None,tag=None)å’Œdel_word(word)å¯åœ¨ç¨‹åºä¸­åŠ¨æ€çš„ä¿®æ”¹è¯å…¸ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">d = path.dirname(__file__) <span class="comment"># è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤å¤„å¢åŠ ä»£ç </span></span><br><span class="line">jieba.add_word(<span class="string">'è„‘ä¸­'</span>)</span><br><span class="line"></span><br><span class="line">  Â·Â·Â·Â·</span><br></pre></td></tr></table></figure><p><strong>ç»“æœå¦‚ä¸‹ï¼š</strong></p><p><img src="https://i.loli.net/2018/03/22/5ab3a2f27d481.png" alt="add_word_test.png"></p><p>æœç„¶ï¼Œè¿™æ ·çš„æ–¹æ³•å¾ˆç›´æ¥çš„æŠŠæˆ‘ä»¬åŸæ¥åˆ‡é”™çš„è¯å˜æˆäº†æ­£ç¡®çš„è¯ã€‚ä¸add_word()ç›¸å¯¹åº”çš„æ˜¯delete_word()æ–¹æ³•ï¼Œæ ¹æ®å­—é¢æ„æ€æˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“ç†è§£delete_word()æ–¹æ³•çš„ä½œç”¨ï¼Œè¿™é‡Œæˆ‘å°±ä¸åšè¿‡å¤šçš„æ¼”ç¤ºäº†ï¼Œå¤§å®¶åœ¨å®é™…åœºæ™¯ä¸­ç›´æ¥è¿ç”¨å°±å¥½äº†ã€‚</p><h2 id="æ–¹æ³•2è°ƒèŠ‚è¯é¢‘">æ–¹æ³•2ï¼šè°ƒèŠ‚è¯é¢‘</h2><p>ä½¿ç”¨suggest_freq(segment, tune=True)è°ƒèŠ‚å•ä¸ªè¯è¯­çš„è¯é¢‘ï¼Œä½¿å¾—å®ƒæ›´å®¹æ˜“è¢«åˆ†å‡ºæ¥ï¼Œæˆ–è€…ä¸è¢«åˆ†å‡ºæ¥ã€‚</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>è‡ªåŠ¨è®¡ç®—çš„è¯é¢‘åœ¨ä½¿ç”¨ HMM æ–°è¯å‘ç°åŠŸèƒ½æ—¶å¯èƒ½æ— æ•ˆã€‚</strong></p><p>æ‰€ä»¥æ­¤æ—¶æˆ‘ä»¬åœ¨åšåˆ‡è¯çš„æ—¶å€™éœ€è¦æŠŠæ˜¯HMMç½®ä¸ºFalseã€‚æˆ‘ä»¬çœ‹ä¸‹å®˜æ–¹ç»™çš„Demoï¼ˆå¦‚æœå…³é—­HMMï¼Œå¾ˆå¤šæ–°å‘ç°çš„è¯éƒ½æ¶ˆå¤±äº†ï¼Œæ‰€ä»¥â€˜è§åªšè„‘â€™ä¹Ÿæ¶ˆå¤±äº†ï¼Œæ— æ³•åšæµ‹è¯•ï¼Œæˆ‘ä»¬çš„ä¾‹å­ä¹Ÿæ˜¯ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œæ‰€ä»¥ä¹Ÿæ²¡å¿…è¦éå¾—é’ˆå¯¹è¿™ä¸€ä¸ªè¯åšè¯é¢‘è°ƒèŠ‚ï¼‰ï¼Œå…·ä½“çš„åšæ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"></span><br><span class="line">print(<span class="string">'/'</span>.join(jieba.cut(<span class="string">'å¦‚æœæ”¾åˆ°postä¸­å°†å‡ºé”™ã€‚'</span>, HMM=<span class="keyword">False</span>)))</span><br><span class="line"></span><br><span class="line">jieba.suggest_freq((<span class="string">'ä¸­'</span>, <span class="string">'å°†'</span>), <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'/'</span>.join(jieba.cut(<span class="string">'å¦‚æœæ”¾åˆ°postä¸­å°†å‡ºé”™ã€‚'</span>, HMM=<span class="keyword">False</span>)))</span><br><span class="line"></span><br><span class="line">print(<span class="string">'/'</span>.join(jieba.cut(<span class="string">'ã€Œå°ä¸­ã€æ­£ç¡®åº”è¯¥ä¸ä¼šè¢«åˆ‡å¼€'</span>, HMM=<span class="keyword">False</span>)))</span><br><span class="line"></span><br><span class="line">jieba.suggest_freq(<span class="string">'å°ä¸­'</span>, <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'/'</span>.join(jieba.cut(<span class="string">'ã€Œå°ä¸­ã€æ­£ç¡®åº”è¯¥ä¸ä¼šè¢«åˆ‡å¼€'</span>, HMM=<span class="keyword">False</span>)))</span><br></pre></td></tr></table></figure><p><strong>ç»“æœï¼š</strong></p><p><img src="https://i.loli.net/2018/03/22/5ab3b191d1bfd.png" alt="suggest_freq.png"></p><p>å¯¹æ¯”ä¸‹ç»“æœï¼Œä¸éš¾å‘ç°suggest_freq()çš„ä½¿ç”¨æ–¹æ³•ï¼Œé€šè¿‡è¿™æ ·çš„å¼ºè°ƒé«˜é¢‘è¯å’Œä½é¢‘è¯çš„æ–¹æ³•å¯ä»¥åšåˆ°åˆ†è¯æ›´å‡†ç¡®ã€‚</p><h1 id="æ·»åŠ è‡ªå®šä¹‰è¯å…¸">æ·»åŠ è‡ªå®šä¹‰è¯å…¸</h1><p>æ¯”èµ·é»˜è®¤çš„è¯å…¸ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„è¯å…¸æ›´é€‚åˆæˆ‘ä»¬è‡ªå·±çš„æ–‡æœ¬ï¼Œè¿™ä¸€ç‚¹æ˜¯æ¯‹åº¸ç½®ç–‘çš„ã€‚</p><p>è¯å…¸æ ¼å¼å’Œ dict.txt ä¸€æ ·ï¼Œä¸€ä¸ªè¯å ä¸€è¡Œï¼›æ¯ä¸€è¡Œåˆ†ä¸‰éƒ¨åˆ†ï¼šè¯è¯­ã€è¯é¢‘ï¼ˆå¯çœç•¥ï¼‰ã€è¯æ€§ï¼ˆå¯çœç•¥ï¼‰ï¼Œç”¨ç©ºæ ¼éš”å¼€ï¼Œé¡ºåºä¸å¯é¢ å€’ã€‚file_name è‹¥ä¸ºè·¯å¾„æˆ–äºŒè¿›åˆ¶æ–¹å¼æ‰“å¼€çš„æ–‡ä»¶ï¼Œåˆ™æ–‡ä»¶å¿…é¡»ä¸º UTF-8 ç¼–ç ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬çš„è¯å…¸ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">äº‘è®¡ç®— 5</span><br><span class="line">æå°ç¦ 2 nr</span><br><span class="line">åˆ›æ–°åŠ 3 i</span><br><span class="line">easy_install 3 eng</span><br><span class="line">å¥½ç”¨ 300</span><br><span class="line">éŸ©ç‰èµé‰´ 3 nz</span><br><span class="line">å…«ä¸€åŒé¹¿ 3 nz</span><br><span class="line">å°ä¸­</span><br><span class="line">å‡±ç‰¹ç³ nz</span><br><span class="line">Edu Trustè®¤è¯ 2000</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¹Ÿç”¨å®˜æ–¹çš„Demoï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">"../"</span>)</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line">jieba.load_userdict(<span class="string">"userdict.txt"</span>)</span><br><span class="line"><span class="comment"># jiebaåœ¨0.28ç‰ˆæœ¬ä¹‹åé‡‡ç”¨å»¶è¿ŸåŠ è½½æ–¹å¼</span></span><br><span class="line"><span class="comment"># â€œimport jiebaâ€ä¸ä¼šç«‹å³è§¦å‘è¯å…¸çš„åŠ è½½ï¼Œè€Œæ˜¯åœ¨æœ‰å¿…è¦çš„æ—¶å€™æ‰ä¼šåŠ è½½è¯å…¸</span></span><br><span class="line"><span class="comment"># å¦‚æœæƒ³æ‰‹åŠ¨åŠ è½½ï¼Œå¯æ‰§è¡Œä»£ç ï¼š jieba.initialize() è¿›è¡Œæ‰‹åŠ¨åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line"><span class="comment"># ä¹Ÿæ­£æ˜¯æœ‰äº†å»¶è¿ŸåŠ è½½æœºåˆ¶ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ”¹å˜ä¸»è¯å…¸çš„è·¯å¾„ï¼š</span></span><br><span class="line"><span class="comment"># jieba.set_dictionary('data/dict.txt.big')</span></span><br><span class="line"><span class="comment"># å®˜æ–¹è¿˜æä¾›äº†å ç”¨å†…å­˜è¾ƒå°çš„è¯å…¸å’Œé€‚ç”¨äºç¹ä½“å­—çš„è¯å…¸ï¼Œå‡åœ¨å®˜æ–¹çš„GitHubä¸Šï¼Œæœ‰éœ€è¦çš„å¯ä»¥è‡ªè¡Œä¸‹è½½ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jieba.posseg <span class="keyword">as</span> pseg</span><br><span class="line"><span class="comment"># psegåˆ‡åˆ†å¯ä»¥æ˜¾ç¤ºè¯æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸‹ä¸‰ä¸ªæ“ä½œæ˜¯ä¿®æ”¹è¯å…¸çš„å·©å›º</span></span><br><span class="line">jieba.add_word(<span class="string">'çŸ³å¢¨çƒ¯'</span>)</span><br><span class="line">jieba.add_word(<span class="string">'å‡±ç‰¹ç³'</span>)</span><br><span class="line">jieba.del_word(<span class="string">'è‡ªå®šä¹‰è¯'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test_sent = (</span><br><span class="line"><span class="string">"æå°ç¦æ˜¯åˆ›æ–°åŠä¸»ä»»ä¹Ÿæ˜¯äº‘è®¡ç®—æ–¹é¢çš„ä¸“å®¶; ä»€ä¹ˆæ˜¯å…«ä¸€åŒé¹¿\n"</span></span><br><span class="line"><span class="string">"ä¾‹å¦‚æˆ‘è¾“å…¥ä¸€ä¸ªå¸¦â€œéŸ©ç‰èµé‰´â€çš„æ ‡é¢˜ï¼Œåœ¨è‡ªå®šä¹‰è¯åº“ä¸­ä¹Ÿå¢åŠ äº†æ­¤è¯ä¸ºNç±»\n"</span></span><br><span class="line"><span class="string">"ã€Œå°ä¸­ã€æ­£ç¢ºæ‡‰è©²ä¸æœƒè¢«åˆ‡é–‹ã€‚macä¸Šå¯åˆ†å‡ºã€ŒçŸ³å¢¨çƒ¯ã€ï¼›æ­¤æ™‚åˆå¯ä»¥åˆ†å‡ºä¾†å‡±ç‰¹ç³äº†ã€‚"</span></span><br><span class="line">)</span><br><span class="line">words = jieba.cut(test_sent)</span><br><span class="line">print(<span class="string">'/'</span>.join(words))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"="</span>*<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">result = pseg.cut(test_sent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> result:</span><br><span class="line">    print(w.word, <span class="string">"/"</span>, w.flag, <span class="string">", "</span>, end=<span class="string">' '</span>)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœå¦‚ä¸‹ï¼š</strong></p><p><img src="https://i.loli.net/2018/03/23/5ab46d77c08dc.png" alt="userdict.png"></p><p>åƒâ€˜äº‘è®¡ç®—â€™ã€â€˜åˆ›æ–°åŠâ€™ç­‰è¯åœ¨æ²¡åŠ è½½è¯å…¸çš„æ—¶å€™æ˜¯ä¸èƒ½è¢«è¯†åˆ«å‡ºæ¥çš„ã€‚åƒâ€˜çŸ³å¢¨çƒ¯â€™ç­‰åœ¨æ²¡æœ‰add_word()çš„æ—¶å€™ä¹Ÿæ˜¯ä¸èƒ½è¯†åˆ«å‡ºæ¥çš„ã€‚å¯è§æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚</p><h1 id="å¹¶è¡Œåˆ†è¯">å¹¶è¡Œåˆ†è¯</h1><p>åŸç†ï¼šå°†ç›®æ ‡æ–‡æœ¬æŒ‰è¡Œåˆ†éš”åï¼ŒæŠŠå„è¡Œæ–‡æœ¬åˆ†é…åˆ°å¤šä¸ª Python è¿›ç¨‹å¹¶è¡Œåˆ†è¯ï¼Œç„¶åå½’å¹¶ç»“æœï¼Œä»è€Œè·å¾—åˆ†è¯é€Ÿåº¦çš„å¯è§‚æå‡</p><p>ä½†æ˜¯ä»¤äººé—æ†¾çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡å—å¹¶ä¸æ”¯æŒWindowså¹³å°ï¼ŒåŸå› æ˜¯å› ä¸ºjiebaçš„è¯¥æ¨¡å—æ˜¯åŸºäºpythonè‡ªå¸¦çš„ multiprocessing æ¨¡å—ï¼Œè€Œè¿™ä¸ªæ¨¡å—å¹¶ä¸æ”¯æŒWindowsã€‚è¿™é‡Œæˆ‘å°±è´´ä¸€ä¸‹ç”¨æ³•ï¼Œä½¿ç”¨Linuxç³»ç»Ÿçš„åŒå­¦å¯ä»¥è‡ªè¡Œä½“éªŒä¸‹è¿™ä¸ªå¯è§‚çš„é€Ÿåº¦æå‡ã€‚</p><p><strong>ç”¨æ³•ï¼š</strong></p><ul><li>jieba.enable_parallel(4) # å¼€å¯å¹¶è¡Œåˆ†è¯æ¨¡å¼ï¼Œå‚æ•°ä¸ºå¹¶è¡Œè¿›ç¨‹æ•°</li><li>jieba.disable_parallel() # å…³é—­å¹¶è¡Œåˆ†è¯æ¨¡å¼</li></ul><h1 id="æœ€å">æœ€å</h1><p>ä»¥ä¸Šæ‰€è®²çš„å†…å®¹åœ¨æ—¥å¸¸çš„ä½¿ç”¨ä¸­åº”è¯¥æ˜¯å¤Ÿç”¨äº†ï¼Œå½“ç„¶åƒåŸºäºTextRankç®—æ³•çš„å…³é”®è¯æŠ½å–ç­‰å†…å®¹ï¼Œæˆ‘è¿™é‡Œå¹¶æ²¡æ¶‰åŠï¼Œå¹¶ä¸æ˜¯å› ä¸ºä¸é‡è¦ï¼Œè€Œæ˜¯æˆ‘å¯¹è¿™ä¸ªç®—æ³•è¿˜ä¸æ˜¯å¾ˆäº†è§£ï¼Œç¡¬ç€å¤´çš®å†™è‚¯å®šä¹Ÿæ˜¯ç…§æœ¬å®£ç§‘ï¼Œæ•ˆæœè‚¯å®šå¾ˆå·®ï¼Œæ‰€ä»¥å…ˆæŒ–ä¸ªå‘å§ï¼Œä»¥åå†å¡«ã€‚</p><p>æ„Ÿè°¢é˜…è¯»~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;jiebaä¸­æ–‡åˆ†è¯å·¥å…·ä½¿ç”¨è¿›é˜¶ç¯‡ï¼ŒåºŸè¯ä¸å¤šè¯´å—ï¼Œæˆ‘ä»¬å¼€å§‹æœ¬æ¬¡çš„å­¦ä¹ å§~&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h1
        
      
    
    </summary>
    
      <category term="æ–‡æœ¬èšç±»" scheme="http://weafteam.github.io/categories/%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB/"/>
    
    
      <category term="æ–‡æœ¬èšç±»" scheme="http://weafteam.github.io/tags/%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>æ™®é€šçš„ SQLAlchemy ORM ä½¿ç”¨å§¿åŠ¿</title>
    <link href="http://weafteam.github.io/posts/39277c31/"/>
    <id>http://weafteam.github.io/posts/39277c31/</id>
    <published>2018-03-18T13:38:54.000Z</published>
    <updated>2018-08-07T08:56:41.610Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>SQLAlchemy æ˜¯ Python ä¸–ç•Œä¸­æœ€å¸¸ç”¨çš„ SQL å·¥å…·ä¹‹ä¸€ï¼ŒåŒ…å« SQL æ¸²æŸ“å¼•æ“å’Œ ORM ä¸¤å¤§éƒ¨åˆ†ï¼Œå¹³æ—¶ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯ ORMã€‚åœ¨æˆ‘çœ‹æ¥å¹³æ—¶å¾ˆå¤šä½¿ç”¨ ORM çš„å§¿åŠ¿æ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ–è€…è¯´æ˜¯ä¸ä¼˜é›…çš„ã€‚æ‰€ä»¥è¿™ç¯‡æ–‡ç« æ‰“ç®—è®²è®²ï¼ˆæ¬è¿ï¼‰å…¶ä¸­ä¸€äº›æ™®é€šçš„å§¿åŠ¿å’ŒæŠ€å·§ï¼ˆAPI æ–‡æ¡£ï¼‰ã€‚</p><h2 id="property-å’Œæ··åˆå±æ€§">property å’Œæ··åˆå±æ€§</h2><h3 id="property">property</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æˆ·è¡¨æ˜ å°„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'user'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    password = Column(String(<span class="number">128</span>))</span><br></pre></td></tr></table></figure><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåŠ å¯†ç”¨æˆ·çš„å¯†ç ï¼Œåœ¨æ•°æ®åº“ä¸­ä¿å­˜å¯†æ–‡ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾—è¿™ä¹ˆå†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">user = User(name=<span class="string">'zhang'</span>, password=encrypt(<span class="string">'123456'</span>))</span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯†ç </span></span><br><span class="line">user.password = encrypt(<span class="string">'654321'</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸æ–­çš„é‡å¤ä¹¦å†™ <code>encrypt</code> å‡½æ•°æ¥ä¿è¯åŠ å¯†äº†ç”¨æˆ·å¯†ç ã€‚</p><p>æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•èƒ½çœå»è¿™ä¸€æ­¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <code>property</code>ã€‚</p><p>ç°åœ¨æŠŠç”¨æˆ·è¡¨æ˜ å°„æ”¹æˆè¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'user'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    _password = Column(String(<span class="number">128</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">password</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'write only!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @password.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">password</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self._password = encrypt(value)</span><br></pre></td></tr></table></figure><p>ç°åœ¨åªéœ€è¦ç®€å•çš„å†™æˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">user = User(name=<span class="string">'zhang'</span>, password=<span class="string">'123456'</span>)</span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯†ç </span></span><br><span class="line">user.password = <span class="string">'654321'</span></span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥äº†ã€‚</p><p>å…³äº Python ä¸­ <code>property</code>å’Œæè¿°ç¬¦çš„ä½¿ç”¨å€¼å¾—å†å¦å†™ä¸€ç¯‡æ–‡ç« æè¿°ï¼Œåœ¨è¿™é‡Œå°±ä¸è¯¦ç»†è¯´æ˜äº†ã€‚</p><h3 id="æ··åˆå±æ€§hybrid_property">æ··åˆå±æ€§ï¼ˆhybrid_propertyï¼‰</h3><p>ä¸Šé¢çš„ä¾‹å­çœ‹ä¸Šå»è®©ä»£ç æ¸…çˆ½äº†ä¸å°‘ï¼Œä½†æ˜¯æœ‰æ—¶å€™è¿™ç§ç”¨æ³•æ˜¯æ— æ³•æ»¡è¶³éœ€è¦çš„ï¼Œè­¬å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'student'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    birthday = Column(DateTime)</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªå­¦ç”Ÿè¡¨æ˜ å°„ï¼Œå¢åŠ äº† <code>birthday</code> å­—æ®µã€‚é€šå¸¸æˆ‘ä»¬ä¼šä¿å­˜ç”¨æˆ·çš„ç”Ÿæ—¥ï¼Œå†é€šè¿‡ç”Ÿæ—¥è·å–ç”¨æˆ·å¹´é¾„ã€‚æœ‰äº†ä¸Šé¢çš„ä¾‹å­ï¼Œå¾ˆå®¹æ˜“å†™å‡ºè·å–å¹´é¾„çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Base)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> datetime.now().year - self.birthday.year</span><br></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥ç®€å•çš„ä½¿ç”¨ <code>student.age</code> è·å–å…·ä½“çš„ç”Ÿæ—¥ã€‚</p><p>è¿™æ ·åšæ˜¯æœ‰ç¼ºé™·çš„ï¼šå¦‚æœéœ€è¦è·å–æ‰€æœ‰ 18 å²çš„å­¦ç”Ÿå‘¢ï¼Ÿæˆ‘ä»¬å¸Œæœ›å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(Student).filter_by(age=<span class="number">18</span>).all()</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å´æ²¡æœ‰ä»»ä½•ç»“æœè¿”å›ã€‚å¦‚æœæ”¹æˆè¿™æ ·å‘¢ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">now = datetime.now()</span><br><span class="line">start = datetime(now.year - <span class="number">18</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">end = end = datetime(now.year + <span class="number">1</span> - <span class="number">18</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">session.query(Student).filter(Student.birthday &gt;= start, Student.birthday &lt; end).all()</span><br></pre></td></tr></table></figure><p>è¿™æ ·å€’æ˜¯å¯ä»¥è·å–æ­£ç¡®çš„ç»“æœäº†ï¼Œä½†æ˜¯ä¹Ÿå¤ªä¸‘äº†ç‚¹å§ï¼Ÿéš¾é“æ²¡åŠæ³•å†™å‡ºåƒç¬¬ä¸€æ¡ä¸€æ ·çš„æ—¢æ¸…æ™°åˆç®€æ´çš„æŸ¥è¯¢ä¹ˆï¼Ÿ</p><p>ç­”æ¡ˆè‡ªç„¶æ˜¯æœ‰çš„ï¼ŒSQLAlchemy æä¾›äº†æ··åˆå±æ€§ï¼ˆ<code>hybrid_property</code>ï¼‰æ¥å¤„ç†ç±»ä¼¼çš„æƒ…å†µï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥æ”¹å†™è·å–å¹´é¾„çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.hybrid <span class="keyword">import</span> hybrid_property</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Base)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @hybrid_property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> datetime.now().year - self.birthday.year</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.expression</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> datetime.now().year - func.year(self.birthday)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°†åŸæœ¬çš„ <code>property</code> æ›¿æ¢ä¸º SQLAlchemy ä¸­çš„ <code>hybrid_property</code>ï¼ŒåŒæ—¶æä¾›äº†ä¸€ä¸ª <code>expression</code> è£…é¥°å™¨ï¼Œåœ¨è¢«è£…é¥°çš„æ–¹æ³•ä¸­æŠŠ Python ä»£ç ç¿»è¯‘æˆ SQLï¼ˆä»£ç ç¤ºä¾‹çš„ç›®æ ‡æ•°æ®åº“ä¸º MySQLï¼Œè·å–æ—¥æœŸä¸­çš„å¹´ä»½çš„å‡½æ•°ä¸º<code>YEAR()</code>ï¼Œä½¿ç”¨å…¶ä»–æ•°æ®åº“è¯·æŸ¥é˜…å¯¹åº”æ•°æ®åº“çš„ç›¸å…³æ–‡æ¡£ï¼‰ã€‚æœ‰äº†è¿™ä¸ªæ–¹æ³•ï¼ŒSQLAlchemy å°±çŸ¥é“å¦‚ä½•åœ¨ SQL è¯­å¥ä¸­å¤„ç† <code>age</code> å±æ€§äº†ã€‚</p><p>æ¥ä¸‹æ¥ç¨å¾®æä¸€ä¸‹ <code>hybrid_method</code>ã€‚</p><p>å’Œ <code>hybrid_property</code> ç±»ä¼¼ï¼Œåªä¸è¿‡å¯ä»¥ç»™ <code>hybrid_method</code> ä¼ å‚æ•°ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸å¤ªåˆé€‚ï¼Œåªä¸ºäº†å±•ç¤º<code>hybrid_method</code> çš„åŠŸèƒ½ã€‚</p><p>å¦‚ä½•æ‰¾åˆ°æ‰€æœ‰ 90 ååŒå­¦ï¼Ÿå½“ç„¶æˆ‘ä»¬å¯ä»¥å¤ç”¨ä¸Šé¢çš„ <code>age</code> å±æ€§ï¼Œå…ˆè®¡ç®—ä¸€ä¸‹ 90 åçš„åŒå­¦ç°åœ¨å¤šå°‘å²ï¼Œç„¶åç›´æ¥å†™åœ¨æŸ¥è¯¢é‡Œå°±å¥½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(Student).filter(Student.age &gt;= now.year - <span class="number">1990</span>, Student.age &lt; now.year - <span class="number">2000</span>).all()</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦åˆ¤æ–­æŸä¸ªå­¦ç”Ÿæ˜¯å¦æ˜¯ 90 åå‘¢ï¼Ÿåˆéœ€è¦å†å†™ä¸€éï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> now.year - <span class="number">2000</span> &gt; student.age &gt;= now.year - <span class="number">1990</span>:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>å‡ºç°äº†å¾ˆå¤šä¸ç›´è§‚çš„ä»£ç ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ <code>hybrid_method</code> ç®€åŒ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Base)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">    @hybrid_method</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">born_after</span><span class="params">(self, years)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> years + <span class="number">10</span> &gt; self.birthday.year &gt;= years</span><br><span class="line"></span><br><span class="line"><span class="meta">    @born_after.expression</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">born_after</span><span class="params">(self, years)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> and_(func.year(self.birthday) &lt; years + <span class="number">10</span>, func.year(self.birthday) &gt;= years)</span><br></pre></td></tr></table></figure><p>äºæ˜¯ç°åœ¨å¯ä»¥è¿™æ ·åšï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">session.query(Student).filter(Student.born_after(<span class="number">1990</span>)).all()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> student.born_after(<span class="number">1990</span>):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šå»å¥½äº†ä¸€äº›ï¼ˆè¯¯</p><p>è¿™ä¸€éƒ¨åˆ†å°±åˆ°æ­¤ä¸ºæ­¢ï¼Œå½“ç„¶ hybrid åœ¨ SQLAlchemy ä¸­çš„ç”¨æ³•ä¸æ­¢ä¸Šè¿°è¿™äº›ï¼Œæ›´è¯¦ç»†å’Œå¤æ‚çš„å†…å®¹å‚è§å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="å…³è”ä»£ç†association_proxy">å…³è”ä»£ç†ï¼ˆassociation_proxyï¼‰</h2><h3 id="ç®€åŒ–æ ‡é‡é›†åˆ">ç®€åŒ–æ ‡é‡é›†åˆ</h3><p>å…³è”ä»£ç†ç”¨åœ¨æœ‰å…³è”çš„è¡¨ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ›å»ºå¦‚ä¸‹æ˜ å°„å…³ç³»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">association = Table(<span class="string">'association'</span>, Base.metadata,</span><br><span class="line">                    Column(<span class="string">'blog_id'</span>, Integer, ForeignKey(<span class="string">'blog.id'</span>), primary_key=<span class="keyword">True</span>),</span><br><span class="line">                    Column(<span class="string">'tag_id'</span>, Integer, ForeignKey(<span class="string">'tag.id'</span>), primary_key=<span class="keyword">True</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'blog'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    tags = relationship(</span><br><span class="line">        <span class="string">'Tag'</span>, secondary=association, backref=backref(<span class="string">'blogs'</span>, lazy=<span class="string">'dynamic'</span>), lazy=<span class="string">'dynamic'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'tag'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç»å¸¸è¢«æ‹¿å‡ºæ¥ä½œä¸ºæ¼”ç¤ºçš„ Many-To-Many æ¨¡å‹ã€‚</p><p>å…ˆå¡«å……ä¸€äº›æ•°æ®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: blog = Blog(name=<span class="string">'first'</span>)</span><br><span class="line">In [<span class="number">2</span>]: blog.tags.append(Tag(name=<span class="string">'t1'</span>))</span><br><span class="line">In [<span class="number">3</span>]: blog.tags.append(Tag(name=<span class="string">'t2'</span>))</span><br><span class="line">In [<span class="number">4</span>]: session.add(blog)</span><br><span class="line">In [<span class="number">5</span>]: session.commit()</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±å¯ä»¥è·å–è¿™äº›å¯¹è±¡çš„æ‰€æœ‰ä¿¡æ¯äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">4</span>]: blog.tags.all()</span><br><span class="line">Out[<span class="number">4</span>]: [&lt;Tag at <span class="number">0x1fdbab6f198</span>&gt;, &lt;Tag at <span class="number">0x1fdbab6f208</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: blog.tags.all()[<span class="number">0</span>].name</span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">'t1'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: [t.name <span class="keyword">for</span> t <span class="keyword">in</span> blog.tags]</span><br><span class="line">Out[<span class="number">6</span>]: [<span class="string">'t1'</span>, <span class="string">'t2'</span>]</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ“ä½œæœ‰ç‚¹å¤æ‚ã€‚å¯¹æˆ‘ä»¬è€Œè¨€ï¼Œ<code>Tag</code> å¯¹è±¡åªæœ‰ <code>name</code> å­—æ®µæ˜¯æœ‰ç”¨çš„ï¼Œä¸ºäº†è·å– <code>name</code> å­—æ®µï¼Œæˆ‘ä»¬è¦å†™å¾ˆå¤šé¢å¤–çš„ä»£ç æŠŠ <code>name</code> å­—æ®µä» <code>Tag</code> å¯¹è±¡ä¸­å‰¥ç¦»å‡ºæ¥ã€‚<code>association_proxy</code> å°±å¯ä»¥ç”¨æ¥ç®€åŒ–è¿™ä¸ªæ“ä½œã€‚</p><p>ç°åœ¨ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ <code>Blog</code> æ˜ å°„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.associationproxy <span class="keyword">import</span> association_proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span><span class="params">(Base)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    tag_objects = relationship(</span><br><span class="line">        <span class="string">'Tag'</span>, secondary=association, backref=backref(<span class="string">'blogs'</span>, lazy=<span class="string">'dynamic'</span>), lazy=<span class="string">'dynamic'</span>)</span><br><span class="line">    tags = association_proxy(<span class="string">'tag_objects'</span>, <span class="string">'name'</span>)</span><br></pre></td></tr></table></figure><p>å¢åŠ äº†ä¸€è¡Œ <code>association_proxy</code> å¯¹è±¡çš„å£°æ˜ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">7</span>]: blog.tags</span><br><span class="line">Out[<span class="number">7</span>]: [<span class="string">'t1'</span>, <span class="string">'t2'</span>]</span><br></pre></td></tr></table></figure><p>ç°åœ¨æŸ¥è¯¢æ“ä½œå˜å¾—å¾ˆç®€å•äº†ï¼Œä½†æ˜¯æ–°å¢æ ‡ç­¾çš„æ“ä½œè¿˜æ˜¯å¾ˆéº»çƒ¦ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blog.tag_objects.append(Tag(name=<span class="string">'t3'</span>))</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª <code>Tag</code> å¯¹è±¡ï¼Œèƒ½ä¸èƒ½ç›´æ¥å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blog.tags.append(<span class="string">'t4'</span>)</span><br></pre></td></tr></table></figure><p>å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œåªè¦å†ä¿®æ”¹ä¸€ä¸‹ <code>association_proxy</code> çš„å£°æ˜ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span><span class="params">(Base)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    tags = association_proxy(<span class="string">'tag_objects'</span>, <span class="string">'name'</span>, creator=<span class="keyword">lambda</span> name: Tag(name=name))</span><br></pre></td></tr></table></figure><p>å‚æ•° <code>creator</code> æ¥å—ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå®ƒå‘Šè¯‰ <code>association_proxy</code> å¦‚ä½•å¤„ç†â€œæ–°å¢â€æ“ä½œã€‚</p><p><strong>æ³¨æ„</strong>ï¼š<code>creator</code> çš„é»˜è®¤å‚æ•°æ˜¯è¢«ä»£ç†å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œå¦‚æœæä¾›äº†ä¸€ä¸ªå•å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆå¯ä»¥çœç•¥ <code>creator</code> å‚æ•°ã€‚</p><h3 id="ç®€åŒ–å…³è”å¯¹è±¡">ç®€åŒ–å…³è”å¯¹è±¡</h3><p>ä¸Šé¢çš„ä¾‹å­é‡ŒæŠŠ <code>association</code> è¡¨ä½œä¸ºä¸€ä¸ªæ™®é€šçš„ <code>Table</code> å¯¹è±¡ï¼Œæ˜¯å› ä¸º <code>association</code> ä¸­ä¸éœ€è¦ä¿å­˜é¢å¤–ä¿¡æ¯ï¼Œåªéœ€è¦ä½œä¸º <code>Blog</code> å’Œ <code>Tag</code> çš„ä¸­è½¬ã€‚ç°åœ¨æœ‰äº†æ–°çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ¯ç¯‡åšå®¢çš„æ ‡ç­¾æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åŠ ä¸Šçš„ï¼Œè¿™å°±éœ€è¦åœ¨ <code>association</code> è¡¨ä¸­å¢åŠ ä¸€ä¸ªé¢å¤–çš„å­—æ®µç”¨æ¥è¡¨ç¤ºåˆ›å»ºæ—¶é—´ï¼ŒåŒæ—¶ä¸ºäº†è·å–è¿™ä¸ªæ—¶é—´ï¼Œè¿˜è¦æŠŠ <code>association</code> æ”¹é€ æˆä¸€ä¸ªçœŸæ­£çš„æ˜ å°„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Association</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'association'</span></span><br><span class="line"></span><br><span class="line">    blog_id = Column(Integer, ForeignKey(<span class="string">'blog.id'</span>), primary_key=<span class="keyword">True</span>)</span><br><span class="line">    tag_id = Column(Integer, ForeignKey(<span class="string">'tag.id'</span>), primary_key=<span class="keyword">True</span>)</span><br><span class="line">    created_at = Column(DateTime, default=datetime.now)</span><br><span class="line"></span><br><span class="line">    blog = relationship(<span class="string">'Blog'</span>, backref=backref(<span class="string">'blog_tags'</span>, lazy=<span class="string">'dynamic'</span>), lazy=<span class="string">'joined'</span>)</span><br><span class="line">    tag = relationship(<span class="string">'Tag'</span>, backref=backref(<span class="string">'tag_blogs'</span>, lazy=<span class="string">'dynamic'</span>), lazy=<span class="string">'joined'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'tag'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'blog'</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®é™…ä¸Šæ˜¯æŠŠ Many-To-Many æ‹†æˆäº†ä¸¤ä¸ª One-To-Manyã€‚</p><p>ç„¶åæ„é€ ä¸€äº›æ•°æ®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In  [<span class="number">1</span>]: blog = Blog(name=<span class="string">'first'</span>)</span><br><span class="line">    ...: tags = [Tag(name=<span class="string">'t1'</span>), Tag(name=<span class="string">'t2'</span>)]</span><br><span class="line">    ...: <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">    ...:     session.add(Association(blog=blog, tag=tag))</span><br><span class="line">    ...: session.add(blog)</span><br><span class="line">    ...: session.add_all(tags)</span><br><span class="line">    ...: session.commit()</span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±å¯ä»¥è·å– <code>Tag</code> å’Œè¢«æ·»åŠ çš„æ—¶é—´äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: blog.blog_tags[<span class="number">0</span>].tag.name</span><br><span class="line">Out[<span class="number">2</span>]: <span class="string">'t1'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: blog.blog_tags[<span class="number">0</span>].created_at</span><br><span class="line">Out[<span class="number">3</span>]: datetime.datetime(<span class="number">2018</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">16</span>, <span class="number">4</span>, <span class="number">17</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œç»™ <code>Blog</code> å¢åŠ æ ‡ç­¾è¦ç»è¿‡ <code>Association</code> è¿™ä¸ªä¸­é—´å¯¹è±¡ã€‚è™½ç„¶è¡¨ç»“æ„çš„ç¡®å¦‚æ­¤ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¸Œæœ› <code>Association</code> è¡¨æ˜¯é€æ˜çš„ï¼Œä»…å½“éœ€è¦è·å–å…¶ä¸­çš„åˆ›å»ºæ—¶é—´æ—¶æ‰æ˜ç¡®è·å– <code>Association</code> å¯¹è±¡ã€‚åªéœ€è¦åœ¨ <code>Blog</code> ä¸­å£°æ˜ä¸€ä¸ªå…³è”ä»£ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Blog</span><span class="params">(Base)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    tags = association_proxy(<span class="string">'blog_tags'</span>, <span class="string">'tag'</span>, creator=<span class="keyword">lambda</span> tag: Association(tag=tag))</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥è¿™æ ·å†™äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">4</span>]: blog.tags[<span class="number">0</span>].name</span><br><span class="line">Out[<span class="number">4</span>]: <span class="string">'t1'</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ æ–°çš„ <code>Tag</code> ä¹Ÿæ–¹ä¾¿äº†å¾ˆå¤šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In  [<span class="number">3</span>]: <span class="keyword">for</span> tag <span class="keyword">in</span> [Tag(name=<span class="string">'t3'</span>), Tag(name=<span class="string">'t4'</span>)]:</span><br><span class="line">    ...:     blog.tags.append(tag)</span><br></pre></td></tr></table></figure><h3 id="æ··åˆå…³è”ä»£ç†">æ··åˆå…³è”ä»£ç†</h3><p>ç°åœ¨å›åˆ°äº†ç¬¬ä¸€ä¸ªé—®é¢˜çš„å‡ºå‘ç‚¹ï¼Œèƒ½ä¸èƒ½åœ¨ä¸Šä¸€ä¸ªä¾‹å­çš„åŸºç¡€ä¸Šç®€åŒ– <code>tags</code> çš„è°ƒç”¨å‘¢ï¼ŸåŒæ ·æ²¡é—®é¢˜ï¼Œåªè¦åœ¨ <code>Association</code> ä¸­åŠ ä¸€ä¸ªå…³è”ä»£ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Association</span><span class="params">(Base)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    tag_objects = relationship(<span class="string">'Tag'</span>, backref=backref(<span class="string">'tag_blogs'</span>, lazy=<span class="string">'dynamic'</span>), lazy=<span class="string">'joined'</span>)</span><br><span class="line">    tags = association_proxy(<span class="string">'tag_objects'</span>, <span class="string">'name'</span>, creator=<span class="keyword">lambda</span> name: Tag(name=name))</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨èµ·æ¥å°±å’Œç¬¬ä¸€ä¸ªä¾‹å­ä¸€æ ·äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: blog.tags</span><br><span class="line">Out[<span class="number">1</span>]: [<span class="string">'t1'</span>, <span class="string">'t2'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: blog.tags.append(<span class="string">'t3'</span>)</span><br><span class="line">In [<span class="number">3</span>]: blog.tags</span><br><span class="line">Out[<span class="number">3</span>]: [<span class="string">'t1'</span>, <span class="string">'t2'</span>, <span class="string">'t3'</span>]</span><br></pre></td></tr></table></figure><h2 id="ç»“è¯­">ç»“è¯­</h2><p>ä¸Šè¿°å†…å®¹å¹¶æ²¡æœ‰å¾ˆå¤æ‚çš„æ“ä½œï¼Œéƒ½æ˜¯ä¸€äº›æ˜“äºå®ç°å¹¶ä¸”å¯ä»¥æ”¹å–„æ—¥å¸¸ä½¿ç”¨ä½“éªŒçš„æ–¹æ³•ã€‚SQLAlchemy è¿˜æœ‰å¾ˆå¤šéªšæ“ä½œå¯ä»¥è®²ï¼Œä½†æ˜¯å—é™äºæœ¬äººçš„å§¿åŠ¿æ°´å¹³ï¼Œå¾ˆå¤šå¹¶æ²¡æœ‰å®é™…ä½¿ç”¨è¿‡ï¼Œä¹Ÿè°ˆä¸ä¸Šæœ‰ä»€ä¹ˆè§è§£ã€‚é‚£å°±è¿™æ ·å§~</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;SQLAlchemy æ˜¯ Python ä¸–ç•Œä¸­æœ€å¸¸ç”¨çš„ SQL å·¥å…·ä¹‹ä¸€ï¼ŒåŒ…å« SQL æ¸²æŸ“å¼•æ“å’Œ ORM ä¸¤å¤§éƒ¨åˆ†ï¼Œå¹³æ—¶ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯ ORMã€‚åœ¨æˆ‘çœ‹æ¥å¹³æ—¶å¾ˆå¤šä½¿ç”¨ ORM
        
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>æ–‡æœ¬èšç±»ç³»åˆ—æ•™ç¨‹ï¼šï¼ˆä¸€ï¼‰jiebaä¸­æ–‡åˆ†è¯å·¥å…·å…¥é—¨</title>
    <link href="http://weafteam.github.io/posts/575e441b/"/>
    <id>http://weafteam.github.io/posts/575e441b/</id>
    <published>2018-03-17T09:20:22.000Z</published>
    <updated>2018-05-29T01:27:49.779Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘åœ¨å­¦ä¹ æ–‡æœ¬åˆ†ç±»ï¼ˆèšç±»ï¼‰çš„ç›¸å…³çŸ¥è¯†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å‡†å¤‡å…ˆå†™ä¸€ä¸ªå…³äºè¿™ä¸ªæ–¹é¢çš„ç³»åˆ—åšå®¢ã€‚</p></blockquote><hr><h1 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢ï¼š</h1><p>å…ˆä»‹ç»ä¸‹ç”±æˆ‘ä»¬å››ä¸ªäººç»„æˆçš„ç»„ç»‡ï¼šFOUR ELEMENTSã€‚å››å…ƒç´ åˆ†åˆ«å¯¹åº”WELLã€EARTHã€AIRã€FLAMEï¼Œæ ¹æ®é¦–å­—æ¯ç¼©å†™ï¼Œæˆ‘ä»¬çš„åšå®¢ä¸»é¡µå¾—åWEAFã€‚</p><p>æ¥ä¸‹æ¥ä»‹ç»ä¸‹æˆ‘è‡ªå·±ï¼Œæˆ‘å«Lenoï¼Œå¯¹åº”äºå››å…ƒç´ é‡Œé¢çš„Wellï¼Œç›®å‰ç ”ç©¶ç”Ÿåœ¨è¯»ï¼Œæ–¹å‘ä¸ºæ™ºèƒ½ä¿¡æ¯å¤„ç†ã€‚æˆ‘çš„åšå®¢ä¸»è¦ä¼šä»¥æ—¥å¸¸é‡åˆ°çš„é—®é¢˜ä»¥åŠå­¦ä¹ çš„çŸ¥è¯†ä¸ºä¸»ã€‚</p><hr><h1 id="ç®€å•çš„ä»‹ç»">ç®€å•çš„ä»‹ç»ï¼š</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯å¯¹ä¸­æ–‡æ–‡æœ¬çš„èšç±»ï¼Œå¦‚æœåšèšç±»çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ–‡æœ¬çš„å†…å®¹åšåˆ†æï¼Œè€Œåˆ†æçš„æœ€å°å•ä½è‚¯å®šæ˜¯è¯ã€‚</p><p>å…¶æ¬¡ï¼Œä¸­æ–‡å’Œè‹±æ–‡çš„è¯æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ä¸­æ–‡çš„è¯ä¸è¯ä¹‹é—´å¹¶ä¸æ˜¯ç”¨ç©ºæ ¼åˆ†éš”å¼€çš„ï¼Œè€Œä¸”ç”±äºä¸­å›½æ–‡åŒ–çš„åšå¤§ç²¾æ·±ï¼Œåˆ‡è¯çš„æ—¶å€™æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„è¯è¯­ç»„åˆæƒ…å†µå°±æ›´å¤šäº†ã€‚æ˜¾ç„¶è®©æˆ‘ä»¬è‡ªå·±å»é€ ä¸€ä¸ªè¿™æ ·çš„è½®å­æœ‰ç‚¹ä¸ç°å®ï¼Œå…¶å®åƒè¿™æ ·çš„å·¥å…·ï¼Œå‰è¾ˆä»¬å·²ç»ä¸ºæˆ‘ä»¬åšå¥½äº†ï¼Œè€Œä¸”è¶…å¥½ç”¨ã€‚</p><p>æœ¬æ–‡ä»‹ç»çš„å°±æ˜¯jiebaä¸­æ–‡åˆ†è¯ï¼Œæ­£å¦‚å®ƒçš„å£å·é‚£æ ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://i.loli.net/2018/03/17/5aace9320fbc3.png" alt="jieba.png"></p><p>å½“ç„¶ï¼Œè¿™é‡Œæœ‰ä¸¤æœ¬ç§˜ç±<a href="https://github.com/fxsjy/jieba" target="_blank" rel="noopener">GitHub</a> &amp;&amp; <a href="http://www.oschina.net/p/jieba" target="_blank" rel="noopener">OSChina</a>ï¼Œæ—¢ç„¶ä½ æˆ‘æœ‰ç¼˜ï¼Œä¾¿å…è´¹èµ äºˆä½ ã€‚</p><hr><h1 id="å®‰è£…">å®‰è£…</h1><p>è¿™å¹´å¤´ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸€å¥pip install è§£å†³ä¸äº†çš„ã€‚ä¸ç®¡2æˆ–è€…3ï¼Œç›´æ¥pipå³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jieba</span><br></pre></td></tr></table></figure><hr><h1 id="ç»“åˆå®˜æ–¹demoç†è§£jiebaçš„ä¸‰ç§åˆ‡è¯æ¨¡å¼">ç»“åˆå®˜æ–¹Demoç†è§£jiebaçš„ä¸‰ç§åˆ‡è¯æ¨¡å¼</h1><p><strong>ä¸‰ç§æ¨¡å¼ï¼š</strong></p><ul><li>ç²¾ç¡®æ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ï¼šå®ƒä¼šè¯•å›¾å°†å¥å­æœ€ç²¾ç¡®çš„åˆ‡å¼€ï¼Œé€‚åˆæ–‡æœ¬åˆ†æã€‚</li><li>å…¨æ¨¡å¼ï¼šä¸è€ƒè™‘æ­§ä¹‰ï¼Œè¿™ä¸ªæ¨¡å¼ä¼šå°†æ‰€æœ‰çš„å¯ä»¥æˆè¯çš„è¯è¯­éƒ½æ‰«æå‡ºæ¥ï¼Œå› è€Œé€Ÿåº¦ä¼šéå¸¸å¿«ã€‚</li><li>æœç´¢å¼•æ“æ¨¡å¼ï¼šè¯¥æ¨¡å¼æ˜¯åœ¨ç²¾ç¡®æ¨¡å¼çš„åŸºç¡€ä¸Šï¼Œå¯¹é•¿è¯å†è¿›è¡Œåˆ‡åˆ†ï¼Œæé«˜å¬å›ç‡ï¼Œé€‚ç”¨äºæœç´¢å¼•æ“åˆ†è¯ã€‚</li></ul><p><strong>å®˜æ–¹Demoï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import jieba</span><br><span class="line"></span><br><span class="line">seg_list = jieba.cut(&quot;æˆ‘æ¥åˆ°åŒ—äº¬æ¸…åå¤§å­¦&quot;, cut_all=True)</span><br><span class="line">print(&quot;å…¨æ¨¡å¼: &quot; + &quot;/ &quot;.join(seg_list))  # å…¨æ¨¡å¼</span><br><span class="line"></span><br><span class="line">seg_list = jieba.cut(&quot;æˆ‘æ¥åˆ°åŒ—äº¬æ¸…åå¤§å­¦&quot;, cut_all=False)</span><br><span class="line">print(&quot;ç²¾ç¡®æ¨¡å¼: &quot; + &quot;/ &quot;.join(seg_list))  # ç²¾ç¡®æ¨¡å¼</span><br><span class="line"></span><br><span class="line">seg_list = jieba.cut(&quot;ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦&quot;)  # é»˜è®¤æ˜¯ç²¾ç¡®æ¨¡å¼</span><br><span class="line">print(&quot;é»˜è®¤æ¨¡å¼ï¼š&quot; + &quot;/ &quot;.join(seg_list))</span><br><span class="line"></span><br><span class="line">seg_list = jieba.cut_for_search(&quot;å°æ˜ç¡•å£«æ¯•ä¸šäºä¸­å›½ç§‘å­¦é™¢è®¡ç®—æ‰€ï¼Œååœ¨æ—¥æœ¬äº¬éƒ½å¤§å­¦æ·±é€ &quot;)  # æœç´¢å¼•æ“æ¨¡å¼</span><br><span class="line">print(&quot;æœç´¢å¼•æ“æ¨¡å¼ï¼š&quot; + &quot;/ &quot;.join(seg_list))</span><br></pre></td></tr></table></figure><p><strong>ç»“æœï¼š</strong></p><p><img src="https://i.loli.net/2018/03/17/5aacfab51d67e.png" alt="Demo1.png"></p><p><strong>æ¨¡å¼åˆ†æï¼š</strong></p><p>è¿™é‡Œæˆ‘ä»¬å…ˆåˆ†æè¿™ä¸‰ç§æ¨¡å¼ï¼Œå¯¹äºcutæ–¹æ³•çš„è®²è§£åœ¨åè¾¹ä¼šç»™å‡ºï¼Œsoä¸è¦é—®æˆ‘ä¸ºå•¥ä¸ç»™å‡ºcutæ–¹æ³•ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°HMMã€‚</p><p>é€šè¿‡å¯¹æ¯”å‰ä¸¤æ¡è¾“å‡ºå¯ä»¥çœ‹å‡ºå…¨æ¨¡å¼æƒ…å†µä¸‹ï¼Œå®ƒä¼šæ‰¾å‡ºæ‰€æœ‰å¯ä»¥ç»„æˆè¯çš„åˆ’åˆ†ï¼Œè€Œç²¾ç¡®æ¨¡å¼ä¸å…¶å¯¹æ¯”ç»™å‡ºçš„ç­”æ¡ˆå°±ä¼šå¾ˆæ¸…çˆ½ã€‚æ‰€ä»¥ç»“åˆä¸Šæ–‡æ‰€è¯´ï¼Œä¸éš¾ç†è§£è¿™ä¸¤ä¸ªæ¨¡å¼çš„åŒºåˆ«ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ç¬¬å››æ¡è¾“å‡ºï¼Œå®ƒæ˜¯åœ¨ç²¾ç¡®æ¨¡å¼çš„åŸºç¡€ä¸Šå¯¹é•¿è¯å†åšçš„åˆ’åˆ†ã€‚æ‰€ä»¥â€˜æ—¥æœ¬äº¬éƒ½å¤§å­¦â€™ï¼Œå®ƒä¼šå†æ¬¡åˆ‡åˆ†ä¸ºâ€˜æ—¥æœ¬â€™ï¼Œâ€˜äº¬éƒ½â€™ï¼Œâ€˜å¤§å­¦â€™ä¸‰ä¸ªè¯ï¼ŒåŒç†é€‚ç”¨äºâ€˜ä¸­å›½ç§‘å­¦é™¢â€™ã€‚æ‰€ä»¥è¿™ä¸ªæ¨¡å¼ä¹Ÿä¸éš¾ç†è§£å§ã€‚</p><p><strong>è¡¥å……åˆ†æï¼š</strong></p><p>æœ€åçœ‹ç¬¬ä¸‰æ¡è¾“å‡ºå†…å®¹ï¼Œä¹Ÿè®¸ä½ ä¼šé—®ï¼Œæ—¢ç„¶çŸ¥é“é»˜è®¤æ¨¡å¼æ˜¯ç²¾ç¡®æ¨¡å¼äº†ï¼Œä¸ºå•¥è¿˜è¦ç»™å‡ºè¯•ä¾‹ï¼Œå†µä¸”è¿˜æ˜¯ä¸€ä¸ªä¸å…·æœ‰å¯¹æ¯”æ€§è´¨çš„å¯¹æ¯”ã€‚è¿™é‡Œå…¶å®æƒ³è¯´æ˜çš„æ˜¯ï¼š</p><p>â€˜æ­ç ”â€™å¹¶æ²¡æœ‰åœ¨è¯å…¸ä¸­ï¼Œä½†æ˜¯jiebaçš„Viterbiç®—æ³•ä¹Ÿå°†å…¶è¯†åˆ«äº†å‡ºæ¥ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘HMMè¿™ä¸ªå‚æ•°äº†ï¼Œå…³äºHMMï¼ˆHidden Markov Modelï¼ŒHMMï¼šéšé©¬å°”å¯å¤«æ¨¡å‹ï¼‰ï¼Œå¦‚æœæ·±ç©¶ï¼Œé‚£å°±éœ€è¦å¦å¤–ä¸€ç¯‡åšæ–‡äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦èƒ½ç†è§£å®˜æ–¹ç»™å‡ºçš„è¿™å¥è¯å³å¯ï¼š<strong>å¯¹äºæœªç™»å½•è¯ï¼Œé‡‡ç”¨äº†åŸºäºæ±‰å­—æˆè¯èƒ½åŠ›çš„ HMM æ¨¡å‹ï¼Œä½¿ç”¨äº† Viterbi ç®—æ³•ã€‚</strong></p><p>å¯èƒ½è¯´çš„æ¯”è¾ƒå¹²æ¶©ï¼Œæˆ‘ä»¬å®é™…æµ‹ä¸€ä¸‹å§ã€‚</p><p><strong>è¡¥å……æµ‹è¯•ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import jieba</span><br><span class="line"></span><br><span class="line">seg_list = jieba.cut(&quot;ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦&quot;,HMM=False)</span><br><span class="line">print(&quot;HMMä¸ºFalseï¼š&quot; + &quot;/ &quot;.join(seg_list))</span><br><span class="line"></span><br><span class="line">seg_list = jieba.cut(&quot;ä»–æ¥åˆ°äº†ç½‘æ˜“æ­ç ”å¤§å¦&quot;,HMM=True)</span><br><span class="line">print(&quot;HMMä¸ºTrueï¼š&quot; + &quot;/ &quot;.join(seg_list))</span><br></pre></td></tr></table></figure><p><strong>è¡¥å……æµ‹è¯•ç»“æœï¼š</strong></p><p><img src="https://i.loli.net/2018/03/17/5aad1051896b9.png" alt="Demo1plus.png"></p><p>æ‰€ä»¥<strong>ä¸€èˆ¬æƒ…å†µä¸‹</strong>ï¼Œä½¿ç”¨cutæ–¹æ³•ï¼Œä¸ç”¨è€ƒè™‘HMMè¿™ä¸ªå‚æ•°å°±å¯ä»¥ï¼Œè®©å®ƒé»˜è®¤ä¸ºTrueå³å¯ï¼Œè®©Viterbiç®—æ³•ä¸ºæˆ‘ä»¬è¯†åˆ«æ–°è¯ã€‚HMMä¹Ÿèƒ½æœ‰æ•ˆçš„è§£å†³ä¸­æ–‡ä¸­çš„æ­§ä¹‰é—®é¢˜ã€‚</p><p><strong>å¯ç”¨HMMå¹¶ä¸é€‚ç”¨æ‰€æœ‰æƒ…å†µï¼Œæ ¹æ®éœ€è¦å¼€å¯ï¼ï¼ï¼</strong></p><p>å…³äºåˆ‡è¯çš„æ–¹æ³•ä»¥åŠåˆ‡è¯çš„æ³¨æ„äº‹é¡¹ï¼Œè¯·å¤§å®¶å‚è€ƒä¸Šæ–‡ç»™å‡ºçš„ä¸¤ä¸ªé“¾æ¥ï¼Œè¿™é‡Œæˆ‘ä¸å†èµ˜è¿°ã€‚</p><hr><h1 id="åŸºäºtf-idfçš„å…³é”®è¯æå–">åŸºäºTF-IDFçš„å…³é”®è¯æå–</h1><p><strong>ç›¸å…³çŸ¥è¯†ï¼š</strong></p><p>å¯¹äºä¸€ä¸ªæ–‡æ¡£ï¼Œæˆ‘ä»¬è‚¯å®šä¸ä¼šå¯¹æ‰€æœ‰çš„è¯è¿›è¡Œèšç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹æ–‡æ¡£è¿›è¡Œå…³é”®è¯æå–ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å¯¹TF-IDFåšä¸€ä¸‹ç®€å•çš„è¯´æ˜ã€‚å¦‚æœå•è®²è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œæ‹¿å‡ºæ¥åˆæ˜¯ä¸€ç¯‡åšæ–‡ã€‚ä¸è¿‡åç»­æˆ‘ä¹Ÿä¼šå†™ä¸€ç¯‡å…³äºå®ƒçš„åšæ–‡ã€‚æš‚æ—¶è¯·å¤§å®¶è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™å­¦ä¹ ã€‚</p><p>TF-IDFæ˜¯ä¸€ç§ç»Ÿè®¡æ–¹æ³•ï¼Œç”¨äºè¯„ä¼°ä¸€ä¸ªè¯å¯¹äºä¸€ä¸ªæ–‡ä»¶é›†æˆ–è€…è¯­æ–™åº“ä¸­çš„ä¸€ä»½æ–‡ä»¶çš„é‡è¦ç¨‹åº¦ã€‚</p><p>TF(term frequency)ï¼šæŒ‡çš„æ˜¯æŸä¸€ä¸ªç»™å®šçš„è¯è¯­åœ¨è¯¥æ–‡ä»¶ä¸­å‡ºç°çš„é¢‘ç‡ã€‚å…¬å¼å¦‚ä¸‹ï¼š</p><p><span class="math inline">\(tf_i,_j = \frac{n_i,_j}{\sum_k n_k,_j}\)</span></p><p>IDF(Inverse document frequency)ï¼šæ˜¯ä¸€ä¸ªè¯è¯­æ™®éé‡è¦æ€§çš„åº¦é‡ã€‚æŸä¸€ç‰¹å®šè¯è¯­çš„IDFï¼Œå¯ä»¥ç”±æ€»æ–‡ä»¶æ•°ç›®é™¤ä»¥åŒ…å«è¯¥è¯è¯­ä¹‹æ–‡ä»¶çš„æ•°ç›®ï¼Œå†å°†å¾—åˆ°çš„å•†å–å¯¹æ•°å¾—åˆ°ï¼š</p><p><span class="math inline">\(idf(t,D) = log(\frac{N}{\lvert {d \in D, t \in d}\rvert})\)</span></p><p><strong>å…³é”®è¯æå–ï¼š</strong></p><p>å®˜æ–¹ç»™äº†ä¸€ä¸ªä»£ç ç¤ºä¾‹æ–‡ä»¶ï¼Œæºä»£ç åœ¨è¿™é‡Œï¼š<a href="https://github.com/fxsjy/jieba/blob/master/test/extract_tags.py" target="_blank" rel="noopener">å…³é”®è¯æå–æºç </a> ä½†æ˜¯ä¸ºäº†ç»“æœæ˜¾ç¤ºå¾—æ›´æ¸…æ™°ä¸€ç‚¹ï¼Œæˆ‘åšäº†äº›è®¸çš„æ”¹åŠ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">sys.path.append(&apos;../&apos;)</span><br><span class="line"></span><br><span class="line">import jieba</span><br><span class="line">import jieba.analyse</span><br><span class="line">from optparse import OptionParser</span><br><span class="line"></span><br><span class="line">USAGE = &quot;usage:    python extract_tags.py [file name] -k [top k]&quot;</span><br><span class="line"></span><br><span class="line">parser = OptionParser(USAGE)</span><br><span class="line">parser.add_option(&quot;-k&quot;, dest=&quot;topK&quot;)</span><br><span class="line">opt, args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(args) &lt; 1:</span><br><span class="line">    print(USAGE)</span><br><span class="line">    sys.exit(1)</span><br><span class="line"></span><br><span class="line">file_name = args[0]</span><br><span class="line"></span><br><span class="line">if opt.topK is None:</span><br><span class="line">    topK = 20</span><br><span class="line">else:</span><br><span class="line">    topK = int(opt.topK)</span><br><span class="line"></span><br><span class="line">content = open(file_name, &apos;rb&apos;).read()</span><br><span class="line"></span><br><span class="line">tags = jieba.analyse.extract_tags(content, topK=topK,withWeight=True)</span><br><span class="line"></span><br><span class="line">for i in tags :</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure><p>å…ˆè¯´ä¸‹ç”¨æ³•ï¼Œå®˜æ–¹åœ¨æ–‡ä»¶çš„ç¬¬8è¡Œç»™å‡ºäº†ç”¨æ³•ï¼Œå³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python extract_tags.py [file name] -k [top k]</span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸ªExtract_tags.pyæ–‡ä»¶å’Œæ–‡æœ¬æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œç„¶åç»™åˆ©ç”¨å¦‚ä¸Šå‘½ä»¤ä¾¿å¯å¾—åˆ°æ–‡æœ¬çš„å…³é”®è¯ã€‚é»˜è®¤å–å¾—æ˜¯top10ï¼Œæˆ‘æ”¹äº†ä¸‹å–äº†top20ï¼Œæˆ‘ä»¬è¿™é‡Œåšä¸‹æµ‹è¯•ï¼ˆä½¿ç”¨jiebaçš„å®˜æ–¹æµ‹è¯•æ–‡æ¡£ï¼šã€Šå›´åŸã€‹ï¼‰ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://i.loli.net/2018/03/18/5aade4db4fb52.png" alt="extract.png"></p><p><strong>åˆ†æï¼š</strong></p><p>å®˜æ–¹ç»™çš„ä»£ç çœ‹ç€æŒºé•¿ï¼Œå®é™…ä¸Šè¶…ç®€å•ï¼Œå…¶ä¸­é‡è¦çš„æ— éä¸¤å¥è¯ï¼Œä¸€å¥æ˜¯è¯»æ–‡ä»¶ï¼Œå¦ä¸€å¥åˆ™æ˜¯è°ƒç”¨extract_tags()æ–¹æ³•ï¼Œæˆ‘åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šè®¾ç½®äº†withWight=Trueï¼Œå› è€Œè¿”å›äº†ä¸€ä¸ªæƒé‡å€¼ã€‚å¤§å®¶å¦‚æœå«Œéº»çƒ¦å¯ä»¥å¯¹ä¸Šè¿°å…³é”®ä»£ç è¿›è¡ŒæŠ½å–ï¼Œå†™ä¸€ä¸ªè‡ªå·±çš„æµ‹è¯•ã€‚</p><hr><p>æ­£å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œâ€˜è‡ªå·±â€™ã€â€˜çŸ¥é“â€™ã€â€˜å…ˆç”Ÿâ€™ç­‰ç­‰ç­‰ç­‰ï¼Œåƒè¿™äº›è¯è¯­éƒ½æ˜¯äº›æ²¡æœ‰å®é™…æ„ä¹‰çš„å•è¯ï¼Œæ‰€ä»¥åœ¨èšç±»çš„æ—¶å€™è¿™äº›å•è¯ä¸åº”è¯¥åšä¸ºèšç±»ï¼ˆæˆ–è€…åˆ†ç±»ï¼‰çš„æ ‡å‡†ï¼Œå®ƒä»¬å±äºstop_wordsï¼Œä¸­æ–‡çš„æ„æ€å°±æ˜¯åœç”¨è¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="å»é™¤åœç”¨è¯">å»é™¤åœç”¨è¯</h1><p>å»é™¤åœç”¨è¯ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å“ªäº›å±äºåœç”¨è¯ï¼Œæˆ‘åœ¨CSDNä¸Šæ‰¾åˆ°äº†ä¸€ä¸ª1893è§„æ¨¡çš„åœç”¨è¯è¡¨ï¼Œé“¾æ¥å¦‚ä¸‹ï¼š<a href="http://blog.csdn.net/shijiebei2009/article/details/39696571" target="_blank" rel="noopener">æœ€å…¨ä¸­æ–‡åœç”¨è¯è¡¨æ•´ç†ï¼ˆ1893ä¸ªï¼‰</a>ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥çš„å·¥ä½œæ€è·¯æ˜¯è¿™æ ·çš„ï¼Œå¯¹ã€Šå›´åŸã€‹ï¼ˆæ–‡ä»¶1.txtï¼‰è¿›è¡Œåˆ‡è¯ï¼Œæ–¹æ³•å°±æ˜¯ä¹‹å‰çš„cut()ï¼Œè¯»å–StopWordsæ–‡ä»¶ï¼Œå¯¹æ¯”æ¯ä¸ªåˆ‡åˆ†å‡ºæ¥çš„å•è¯æ˜¯å¦æ˜¯åœç”¨è¯ï¼Œå¦‚æœä¸æ˜¯åˆ™åŠ å…¥åˆ°ä¸€ä¸ªlistä¸­ï¼Œç„¶åå†å°†è¿™ä¸ªlistçš„å†…å®¹å­˜åˆ°å¦ä¸€ä¸ªæ–‡ä»¶2.txtä¸­ï¼Œå¯¹æ–‡ä»¶2.txtä½¿ç”¨ä¹‹å‰è¯´åˆ°çš„å®˜æ–¹ç»™çš„å…³é”®è¯æå–æ–‡ä»¶åšå…³é”®è¯æå–å³å¯ã€‚</p><p>å»é™¤åœç”¨è¯ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import jieba</span><br><span class="line">from os import path</span><br><span class="line"></span><br><span class="line">d = path.dirname(__file__) # è·å–å½“å‰æ–‡ä»¶çš„dirè·¯å¾„</span><br><span class="line">stopwords_path = &apos;stopwords1893.txt&apos;  # åœç”¨è¯è¡¨è·¯å¾„</span><br><span class="line"></span><br><span class="line">text_path = &apos;txt/1.txt&apos; #ã€Šå›´åŸã€‹çš„æ–‡æœ¬è·¯å¾„</span><br><span class="line">text = open(path.join(d, text_path),&apos;rb&apos;).read()</span><br><span class="line"></span><br><span class="line">def RmStopWords(text):</span><br><span class="line">    mywordlist = []</span><br><span class="line">    seg_list = jieba.cut(text, cut_all=False)</span><br><span class="line">    liststr=&quot;/ &quot;.join(seg_list) # æ·»åŠ åˆ‡åˆ†ç¬¦</span><br><span class="line">    f_stop = open(stopwords_path)</span><br><span class="line">    try:</span><br><span class="line">        f_stop_text = f_stop.read()</span><br><span class="line">    finally:</span><br><span class="line">        f_stop.close( )</span><br><span class="line">    f_stop_seg_list=f_stop_text.split(&apos;\n&apos;) # åœç”¨è¯æ˜¯æ¯è¡Œä¸€ä¸ªï¼Œæ‰€ä»¥ç”¨/nåˆ†ç¦»</span><br><span class="line">    for myword in liststr.split(&apos;/&apos;):</span><br><span class="line">        #å¯¹äºæ¯ä¸ªåˆ‡åˆ†çš„è¯éƒ½å»åœç”¨è¯è¡¨ä¸­å¯¹æ¯”</span><br><span class="line">        if not(myword.strip() in f_stop_seg_list) and len(myword.strip())&gt;1:</span><br><span class="line">            mywordlist.append(myword)</span><br><span class="line">    return &apos;&apos;.join(mywordlist) #è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">txt2 = RmStopWords(text)</span><br><span class="line">text_write = &apos;txt/2.txt&apos;</span><br><span class="line">with open(text_write,&apos;w&apos;) as f:</span><br><span class="line">    f.write(txt2)</span><br><span class="line">    print(&quot;Success&quot;)</span><br></pre></td></tr></table></figure><p><strong>ç»“æœï¼š</strong></p><p><img src="https://i.loli.net/2018/03/18/5aadf03b5ddc2.png" alt="RmStopWords.png"></p><p><strong>åˆ†æï¼š</strong></p><p>ç”±ä¸Šå›¾å¯è§ï¼Œæˆ‘ä»¬çš„å»åœç”¨è¯çš„æ•ˆæœè¿˜ä¸é”™ã€‚</p><h1 id="æœ€å">æœ€åï¼š</h1><p>è¿™ç¯‡åšå®¢å…ˆå†™åˆ°è¿™é‡Œï¼Œä¸‹ä¸€ç¯‡åšå®¢æˆ‘ä¼šè®²åˆ°jiebaä¸­æ–‡åˆ†è¯çš„è¿›é˜¶ç¯‡ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœ‰é—®é¢˜å¯ä»¥é€šè¿‡é‚®ä»¶ä¸æˆ‘äº¤æµï¼Œé‚®ç®±ï¼šcliugeek@us-forever.com</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘åœ¨å­¦ä¹ æ–‡æœ¬åˆ†ç±»ï¼ˆèšç±»ï¼‰çš„ç›¸å…³çŸ¥è¯†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å‡†å¤‡å…ˆå†™ä¸€ä¸ªå…³äºè¿™ä¸ªæ–¹é¢çš„ç³»åˆ—åšå®¢ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h1 id=&quot;å†™åœ¨å‰é¢&quot;&gt;å†™åœ¨å‰é¢ï¼š&lt;/h1&gt;
&lt;p&gt;å…ˆä»‹ç»ä¸‹ç”±æˆ‘ä»¬å››ä¸ªäººç»„æˆçš„ç»„ç»‡ï¼šFOUR
        
      
    
    </summary>
    
      <category term="æ–‡æœ¬èšç±»" scheme="http://weafteam.github.io/categories/%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB/"/>
    
    
      <category term="æ–‡æœ¬èšç±»" scheme="http://weafteam.github.io/tags/%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>MySQLä¸»ä»æ•°æ®åº“çš„è®¾ç½®ä¸Xtrabackupå¤‡ä»½InnoDB(MySQL)</title>
    <link href="http://weafteam.github.io/posts/2f5dded6/"/>
    <id>http://weafteam.github.io/posts/2f5dded6/</id>
    <published>2018-03-17T08:08:56.000Z</published>
    <updated>2018-05-29T01:27:49.771Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€å‡†å¤‡ç¯å¢ƒ">ä¸€ã€å‡†å¤‡ç¯å¢ƒ</h2><ol type="1"><li>ä¸¤å°æœåŠ¡å™¨ï¼šæœåŠ¡å™¨Aã€æœåŠ¡å™¨B</li><li>æœåŠ¡å™¨Aï¼šRed Hat Enterprise Linux Server release 6.5 (Santiago)</li><li>æœåŠ¡å™¨Bï¼šRed Hat Enterprise Linux Server release 6.5 (Santiago)</li><li>æœåŠ¡å™¨A IPï¼š172.16.125.50</li><li>æœåŠ¡å™¨B IPï¼š172.16.125.52</li><li>MySQLç‰ˆæœ¬ï¼š5.6.23</li></ol><h2 id="äºŒå®‰è£…mysql">äºŒã€å®‰è£…MySQL</h2><p>å…·ä½“å®‰è£…è¯·è§</p><ol type="1"><li><a href="http://us-forever.com/2018/01/15/LinuxMySQLçš„å®‰è£…/" target="_blank" rel="noopener">LinuxMySQLçš„å®‰è£…(1)</a></li><li><a href="http://us-forever.com/2018/02/02/LinuxMySQLçš„å®‰è£…-2/" target="_blank" rel="noopener">LinuxMySQLçš„å®‰è£…(2)</a></li><li><a href="http://us-forever.com/2018/02/08/LinuxMySQLçš„å®‰è£…-3/" target="_blank" rel="noopener">LinuxMySQLçš„å®‰è£…(3)</a></li></ol><a id="more"></a><h2 id="ä¸‰ä¸»ä»åº“é…ç½®">ä¸‰ã€ä¸»ä»åº“é…ç½®</h2><h3 id="ä¸»åº“åœ¨etcmy.cnfé‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹">1ã€ä¸»åº“åœ¨/etc/my.cnfé‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#logæ—¥å¿—</span></span><br><span class="line"><span class="attr">log_bin</span>=mysql_bin</span><br><span class="line"><span class="comment">#server ID</span></span><br><span class="line"><span class="attr">server_id</span>=<span class="number">2</span></span><br><span class="line"><span class="comment">#å¿½ç•¥åŒæ­¥çš„åº“</span></span><br><span class="line"><span class="attr">binlog-ignore-db</span>=information_schema</span><br><span class="line"><span class="attr">binlog-ignore-db</span>=cluster</span><br><span class="line"><span class="attr">binlog-ignore-db</span>=mysql</span><br><span class="line"><span class="comment">#éœ€è¦åŒæ­¥çš„åº“</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=test</span><br></pre></td></tr></table></figure><h3 id="ä»åº“åœ¨etcmy.cnfé‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹">2ã€ä»åº“åœ¨/etc/my.cnfé‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">log_bin=mysql_bin</span><br><span class="line">server_id=3</span><br><span class="line">binlog-ignore-db=information_schema</span><br><span class="line">binlog-ignore-db=cluster</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">replicate-do-db=ufind_db</span><br><span class="line">replicate-ignore-db=mysql</span><br><span class="line">log-slave-updates</span><br><span class="line">slave-skip-errors=all</span><br><span class="line">slave-net-timeout=60</span><br></pre></td></tr></table></figure><h2 id="å››ä¸»ä»åº“è®¾ç½®">å››ã€ä¸»ä»åº“è®¾ç½®</h2><h3 id="è¿›å…¥ä¸»åº“æˆ‘ä»¬åœ¨ä¸»åº“ä¸­åˆ›å»ºä¸€ä¸ªçš„è´¦æˆ·ä»åº“é€šè¿‡ä½¿ç”¨è¿™ä¸ªè´¦å·æ¥åŒæ­¥æ•°æ®">1ã€è¿›å…¥ä¸»åº“ï¼Œæˆ‘ä»¬åœ¨ä¸»åº“ä¸­åˆ›å»ºä¸€ä¸ªçš„è´¦æˆ·ï¼Œä»åº“é€šè¿‡ä½¿ç”¨è¿™ä¸ªè´¦å·æ¥åŒæ­¥æ•°æ®ã€‚</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'repl'</span>@<span class="string">'172.16.125.52'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br></pre></td></tr></table></figure><h3 id="èµ‹äºˆç›¸åº”çš„æƒé™">2ã€èµ‹äºˆç›¸åº”çš„æƒé™</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">FILE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'repl'</span>@<span class="string">'172.16.125.52'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'repl'</span>@<span class="string">'172.16.125.52'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æ•°æ®åº“ä¸»åº“æ‰§è¡Œä»¥ä¸‹å‘½ä»¤">3ã€é‡å¯æ•°æ®åº“ï¼ˆä¸»åº“ï¼‰æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW MASTER STATUS;</span><br></pre></td></tr></table></figure><p><img src="http://us-forever.com/img/mysqlsync.png"> è¦è®°ä½ä»¥ä¸Šçš„ä¿¡æ¯ï¼Œåœ¨è®¾ç½®ä»åº“çš„æ—¶å€™éœ€è¦å¡«å†™å¹¶è®¾ç½®ã€‚</p><h3 id="åœ¨ä»åº“é‡Œè¾¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤">4ã€åœ¨ä»åº“é‡Œè¾¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">change master to master_host=&apos;172.16.125.50&apos;,master_user=&apos;repl&apos;,master_password=&apos;123456&apos;,master_log_file=&apos;mysql_bin.000023&apos;, master_log_pos=120;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure><h3 id="ç„¶åæ‰§è¡Œä¸€ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€">5ã€ç„¶åæ‰§è¡Œä¸€ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status \G;</span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹ï¼š <img src="http://us-forever.com/img/mysqlsync1.png"> <img src="http://us-forever.com/img/mysqlsync2.png"></p><h3 id="æµ‹è¯•ä¸æç¤º">6ã€æµ‹è¯•ä¸æç¤º</h3><p>åæœŸçš„æµ‹è¯•ä¸­æˆ‘ä»¬åªé’ˆå¯¹<strong>test</strong>åº“è¿›è¡Œäº†åŒæ­¥ã€‚ æ‰€ä»¥åªèƒ½é’ˆå¯¹<strong>test</strong>è¿›è¡Œçš„æ“ä½œæ‰æœ‰æ•ˆã€‚</p><p>å¦‚æœåæœŸå¯¹ä¸€äº›åˆ—åº“è¿›è¡Œæ“ä½œï¼Œéœ€è¦ æ·»åŠ ç›¸åº”çš„é…ç½® <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>ä¸»åº“é…ç½®æ–‡ä»¶</span><br><span class="line">binlog-do-db=test</span><br><span class="line"><span class="meta">#</span>ä»åº“é…ç½®æ–‡ä»¶</span><br><span class="line">replicate-do-db=test</span><br></pre></td></tr></table></figure></p><p>å¹¶æŸ¥è¯¢å‡ºæœ€æ–°çš„masterçš„çŠ¶æ€ï¼Œåœæ­¢ä»åº“ã€‚å¹¶æ”¹å˜ä»åº“çš„é…ç½®é‡å¯åŒæ­¥ã€‚ äº”ã€Xtrabackupçš„ç®€å•ä»‹ç» â€”â€”â€”â€”â€”â€”- Percona XtraBackup æ˜¯ä¸–ç•Œä¸Šå”¯ä¸€çš„å¼€æºå…è´¹çš„MySQLçƒ­å¤‡ä»½è½¯ä»¶ï¼Œå¯ä»¥æ‰§è¡Œéé˜»å¡æ“ä½œ InnoDBå’ŒXtraDBæ•°æ®åº“çš„å¤‡ä»½ã€‚ Percona XtraBackupå¯æä¾›ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>å¤‡ä»½å¿«é€Ÿå®‰å…¨å¯é </li><li>å¤‡ä»½æœŸé—´ä¸é—´æ–­çš„äº‹åŠ¡å¤„ç†</li><li>èŠ‚çœç£ç›˜ç©ºé—´å’Œç½‘ç»œå¸¦å®½</li><li>è‡ªåŠ¨å¤‡ä»½éªŒè¯</li><li>æ›´å¿«çš„æ¢å¤æ—¶é—´ä¿è¯æ­£å¸¸å·¥ä½œ</li></ul><p>Percona XtraBackup ä¸ºæ‰€æœ‰ç‰ˆæœ¬çš„PerconaæœåŠ¡å™¨ï¼ŒMySQLå’ŒMariaDBæä¾›MySQLçƒ­å¤‡ä»½ã€‚ å®ƒå¯æ‰§è¡Œ æµåª’ä½“ï¼Œå‹ç¼©å’Œå¢é‡MySQLå¤‡ä»½ã€‚</p><h2 id="å…­xtrabackupçš„å®‰è£…">å…­ã€Xtrabackupçš„å®‰è£…</h2><p>å¦‚æœåœ¨äº’è”ç½‘ä¸‹ å¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£… <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>è·å–ç›¸åº”rpmåŒ… å®‰è£…éƒ¨åˆ†ä¾èµ–(ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯èƒ½å·²å®‰è£…çš„åº“ä¸å°½ç›¸åŒ) <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh mysql-community-libs-compat-5.7.20-1.el7.x86_64.rpm</span><br><span class="line"><span class="meta">#</span>æ ¹æ®mysqlç‰ˆæœ¬è€Œå®š</span><br><span class="line">yum list|grep perl</span><br><span class="line">yum -y install perl-DBI.x86_64 perl-DBD-MySQL.x86_64</span><br></pre></td></tr></table></figure></p><p>ç„¶åå®‰è£…Xtrabackup <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>å‚è€ƒï¼š <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install cmake gcc gcc-c++ libaio libaio-devel automake autoconf bison libtool ncurses-devel libgcrypt-devel libev-devel libcurl-devel vim-common</span><br></pre></td></tr></table></figure></p><h2 id="ä¸ƒxtrabackupå¤‡ä»½mysql">ä¸ƒã€Xtrabackupå¤‡ä»½MySQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --defaults-file=/etc/my.cnf --user=root --password=root --host=localhost --backup --target-dir=/data/backups/</span><br><span class="line">å¯æŒ‡å®šæ•°æ®åº“--databases=test</span><br></pre></td></tr></table></figure><h2 id="å…«xtrabackupçš„å¤‡ä»½æ¢å¤">å…«ã€Xtrabackupçš„å¤‡ä»½æ¢å¤</h2><p>å¤‡ä»½ä¹‹å‰å¿…é¡»å…ˆå…³é—­MySQL server ç„¶ååˆ é™¤dataç›®å½•ï¼ˆ/var/lib/mysqlä¸€èˆ¬æƒ…å†µæ˜¯è¿™ä¸ªï¼‰ <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup  --copy-back --target-dir=/data/backups/</span><br></pre></td></tr></table></figure></p><p>æ‰§è¡Œå®Œæ¢å¤ä¹‹åéœ€è¦è®¾ç½®æ–‡ä»¶æƒé™ <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql /var/lib/mysql</span><br></pre></td></tr></table></figure></p><p>ç„¶åå¯åŠ¨mysql <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld.service</span><br><span class="line"><span class="meta">#</span>æˆ–è€…ä½¿ç”¨æœåŠ¡</span><br><span class="line">service mysqld start</span><br></pre></td></tr></table></figure></p><h2 id="ä¹ä½¿ç”¨è„šæœ¬è‡ªåŠ¨å¤‡ä»½7å¤©ä¹‹å†…çš„æ•°æ®">ä¹ã€ä½¿ç”¨è„šæœ¬è‡ªåŠ¨å¤‡ä»½7å¤©ä¹‹å†…çš„æ•°æ®</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line"># Database info</span><br><span class="line">DB_USER="root"</span><br><span class="line">DB_PASS="root"</span><br><span class="line">DB_HOST="localhost"</span><br><span class="line"></span><br><span class="line"># Others vars</span><br><span class="line">BCK_DIR="/opt/app/mysqlbackup"    #the backup file directory</span><br><span class="line">CONF_DIR="/etc/my.cnf"</span><br><span class="line">DATE=`date +%F`</span><br><span class="line">RMDATE=`date -d '-7 day' +%F`</span><br><span class="line"></span><br><span class="line"># TODO</span><br><span class="line"></span><br><span class="line">mkdir -p $BCK_DIR/$DATE/</span><br><span class="line">#Create dir for save backup data</span><br><span class="line">xtrabackup --defaults-file=$CONF_DIR --user=$DB_USER --password=$DB_PASS --host=$DB_HOST --backup --target-dir=$BCK_DIR/$DATE/</span><br><span class="line">#Backup mysql data</span><br><span class="line">rm -rf $BCK_DIR/$RMDATE</span><br><span class="line">#Delete the backup 7 days ago</span><br><span class="line">#çƒ­å¤‡ä»½æ•°æ®åº“</span><br></pre></td></tr></table></figure><p>åŠ å…¥crontab <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 2 * * * /bin/sh /home/scripts/mysqlbackup.sh</span><br></pre></td></tr></table></figure></p><p><a href="https://learn.percona.com/hubfs/Manuals/Percona_Xtra_Backup/Percona_XtraBackup_2.4/Percona-XtraBackup-2.4.9.pdf" target="_blank" rel="noopener">æ›´å¤šè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£</a></p>]]></content>
    
    <summary type="html">
    
      MySQLä¸»ä»æ•°æ®åº“çš„è®¾ç½®ä¸Xtrabackupå¤‡ä»½InnoDB(MySQL)
    
    </summary>
    
      <category term="Linux" scheme="http://weafteam.github.io/categories/Linux/"/>
    
    
      <category term="Linuxè¿ç»´" scheme="http://weafteam.github.io/tags/Linux%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>chapter-01-AIR</title>
    <link href="http://weafteam.github.io/posts/8e8e4531/"/>
    <id>http://weafteam.github.io/posts/8e8e4531/</id>
    <published>2018-03-14T10:49:23.000Z</published>
    <updated>2018-05-29T01:27:49.767Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬ä¸€ç¯‡æ–‡ç« -tensorflow-install">ç¬¬ä¸€ç¯‡æ–‡ç« -TensorFlow Install</h1><ol type="1"><li>é¦–å…ˆä»‹ç»ä¸€äº›æˆ‘ä»¬è¿™ä¸ªç»„ç»‡ï¼Œè¿™æ˜¯æœ‰å››ä¸ªäººæ„æˆå¾—ä¸€ä¸ªç»„ç»‡ï¼Œç»„ç»‡å¯ä»¥å«FOUR ELEMENTSã€‚ï¼ˆä¹Ÿå¯ä»¥å«WEAFï¼‰åˆ†åˆ«å¯¹åº”WELLã€EARTHã€AIRã€FLAMEã€‚ï¼ˆWEAFï¼‰ã€‚</li><li>å…¶æ¬¡æˆ‘æƒ³åšä¸€ä¸‹è‡ªæˆ‘ä»‹ç»ï¼Œæˆ‘çš„è‹±æ–‡å­¦åå«milittleã€‚æˆ‘å¼€è®¾çš„è¿™ä¸ªå‘¨åˆŠåå­—å«AIR-å‘¨åˆŠã€‚å¸Œæœ›æŠŠè‡ªå·±å­¦ä¹ çš„ä¸€äº›å†…å®¹åˆ†äº«ç»™å¤§å®¶ï¼Œä¹Ÿæ¿€åŠ±è‡ªå·±ã€‚å­¦æ›´å¤šçš„çŸ¥è¯†ã€‚ä»¥åå¤§å®¶æœ‰ä»€ä¹ˆè¦äº¤æµçš„ï¼Œä¹Ÿå¯ä»¥ä¸€èµ·äº¤æµã€‚ï¼ˆé‚®ç®±åœ°å€ä¼šåœ¨æ–‡ç« æœ«å°¾ç»™å‡ºï¼‰</li></ol><p>æ¥ä¸‹æ¥æˆ‘è®²ä¸€ä¸‹æˆ‘åç»­æ¯å‘¨åœ¨<code>AIR-å‘¨åˆŠ</code>é‡Œé¢ä¼šè®²åˆ°çš„å†…å®¹ï¼š</p><ul><li>ä¸»è¦æ¶‰åŠTensorFlowæ¡†æ¶ä½¿ç”¨å¤šä¸€äº›</li><li>åç»­ä¹Ÿä¼šåˆ†äº«ä¸€äº›æœºå™¨å­¦ä¹ æ–¹é¢çš„ç®—æ³•</li><li>ä¹Ÿä¼šæœ‰ä¸€äº›åœ¨äººå·¥æ™ºèƒ½æ–¹é¢çš„æ‚è°ˆ</li></ul><p>ä¸Šé¢è¯´äº†ä¸€äº›ï¼Œæˆ‘æƒ³æŠŠè¿™å—åšå¥½ï¼Œæ–‡ç« å†…å®¹æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œåç»­çš„æ–‡ç« é‡Œé¢ä¼šæœ‰æ‰€æåŠã€‚</p><p>ä»Šå¤©å°±ä»‹ç»ä¸€äº›TensorFlowçš„ç®€è¿°å’Œå®‰è£…ï¼š</p><ol type="1"><li>TensorFlowæ˜¯Googleå…¬å¸åœ¨2015å¹´12æœˆä»½å¼€æºçš„ä¸€ä¸ªæœºå™¨å­¦ä¹ åº“ï¼Œä»£ç é“¾æ¥<a href="https://github.com/tensorflow/tensorflow" target="_blank" rel="noopener">TensorFLow</a>ã€‚</li><li>ç¬¬äºŒç‚¹ä¸ºä»€ä¹ˆç°åœ¨TensorFlowè¿™ä¹ˆç«ï¼Œåœ¨äººå·¥æ™ºèƒ½ç•Œå·²ç»ç®—å¾—ä¸Šæ˜¯ç§°éœ¸çš„åœ°ä½ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢çš„å›¾ä¸­å¯ä»¥çœ‹å‡ºTensorFlowçš„æ•°æ®å æ®äº†ä¸€å¤§åŠå¸‚åœºã€‚</li></ol><p><img src="https://s1.ax1x.com/2018/03/14/94kzp6.jpg" alt="-"></p><ol start="3" type="1"><li>åŸå› æ˜¯ä»€ä¹ˆå‘¢<ul><li>æœ€ä¸»è¦çš„åŸå› å°±æ˜¯æœ¬èº«å…·æœ‰å›¾è¿ç®—çš„è¿™ä¸ªæ¦‚å¿µã€‚ä½¿ç”¨ç®€å•ï¼Œè€Œä¸”å¯ä»¥è®©ç¨‹åºå‘˜å¿«æ·çš„å®ç°ä¸€äº›ç®—æ³•ã€‚ä»è€Œå¯ä»¥ç”¨TensorFlowè§£å†³ä¸€äº›ç°å®ä¸­çš„é—®é¢˜ã€‚å›¾è¿ç®—çš„æ¦‚å¿µæˆ‘ä»¬åç»­ä¼šæ…¢æ…¢æ·±å…¥ã€‚å¤§å®¶ä¸è¦ç€æ€¥ã€‚</li><li>è¿˜æœ‰ä¸€ä¸ªåŸå› ï¼Œæˆ‘æƒ³ä¸ç”¨è¯´å¤§å®¶ä¹Ÿéƒ½çŸ¥é“ï¼Œæ—¢ç„¶è¯´äº†æ˜¯Googleçš„å¼€æºæ¡†æ¶ï¼Œé‚£ä¹ˆæŠ€æœ¯å°±ä¸€å®šå¾ˆç‰›é€¼ã€‚å¼•å¾—å¹¿å¤§ç¨‹åºå‘˜çš„å–œçˆ±ä¹Ÿæ˜¯å¿…ç„¶å‘ç”Ÿçš„äº‹æƒ…ã€‚</li><li>è€Œä¸”ç”¨è¿™ä¸ªæ¡†æ¶å¯ä»¥å¿«é€Ÿçš„è§£å†³ä¸€äº›æœºå™¨å­¦ä¹ çš„ç®—æ³•é—®é¢˜ã€‚æ˜¯çš„ç¼–ç¨‹æ•ˆç‡ä¹Ÿä¸æ–­æé«˜ã€‚</li></ul></li><li>TensorFlowæ”¯æŒMacã€Windowsã€Linuxã€‚ä»¥åæˆ‘ä»¬çš„å®éªŒæœ‰å¯èƒ½é€šè¿‡Windowsè¿›è¡Œï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨Linuxè¿›è¡Œï¼Œè€Œä¸”ä»¥åçš„ä»£ç éƒ½æ˜¯åŸºäºpython3.Xï¼Œæ‰€ä»¥å¸Œæœ›å¤§å®¶å¯ä»¥å®ç°åŸºæœ¬çš„python3çš„è¯­æ³•çŸ¥è¯†å’Œç¼–ç¨‹çŸ¥è¯†ã€‚è¿˜æœ‰å°±æ˜¯TensorFlowæ”¯æŒCPUç‰ˆæœ¬å’ŒGPUç‰ˆæœ¬ï¼Œå®‰è£…çš„æ—¶å€™éƒ½æœ‰å¾ˆå¤šçš„æ³¨æ„äº‹é¡¹ï¼ŒåŸºäºGPUç‰ˆæœ¬çš„å¯èƒ½ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚ä½†æ˜¯åç»­æˆ‘ä¼šç»™å¤§å®¶å‡ºä¸€ä¸ªæ•™ç¨‹ï¼Œåˆ†åˆ«åœ¨Windowsä¸‹é¢å’ŒLinuxä¸‹é¢é…ç½®è‡ªå·±çš„ç‹¬ç«‹ç¯å¢ƒã€‚è®©ä½ çš„æœºå™¨å­¦ä¹ ç®—æ³•è·‘åœ¨ä½ è‡ªå·±çš„æœºå™¨ä¸Šé¢ã€‚å®Œæˆä¸€äº›çœ‹èµ·æ¥ç‚«é…·çš„ç¨‹åºã€‚</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»‹ç»ä¸€ä¸‹TensorFlowçš„Windows CPUå®‰è£…æ–¹æ³•ï¼š</p><ol type="1"><li>é¦–å…ˆæ‰“å¼€ç”µè„‘ï¼Œè¿™ä¸ªæ˜¯ä¸€å®šçš„~</li><li>å»TensorFlowçš„<a href="https://www.tensorflow.org/install/" target="_blank" rel="noopener">å®˜ç½‘</a>ä¸‹è½½Windowsçš„ç‰ˆæœ¬ã€‚ç‚¹å‡»ä¸‹é¢çº¢è‰²ç®­å¤´çš„åœ°æ–¹â€”éšæ„ï¼Œéƒ½å¯ä»¥è·³è½¬åˆ°ä¸€ä¸ªå…³äºwindowså®‰è£…çš„ç•Œé¢ã€‚ï¼ˆå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œé€ƒï¼‰</li></ol><p><img src="https://s1.ax1x.com/2018/03/14/94AS1K.png" alt="-"></p><ol start="3" type="1"><li>ç‚¹å¼€ç•Œé¢ä»¥åçš„æ³¨æ„äº‹é¡¹ï¼š<ul><li>windows7åŠå…¶ä»¥åçš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬</li><li>å†³å®šå®‰è£…å“ªä¸ªTensorFlowçš„ç‰ˆæœ¬ï¼ŒGPUè¿˜æ˜¯CPUï¼ˆGPUä¼šæœ‰æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„åº“ä¾èµ–ï¼ŒCUDAï¼‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çš„æ•™ç¨‹æ˜¯CPUç‰ˆæœ¬å®‰è£…ã€‚</li><li>å†³å®šæ€ä¹ˆå®‰è£…TensorFlowï¼šå¯é€‰æ–¹å¼æœ‰native pip å’Œ Anacondaç­‰ï¼ˆæˆ‘ä»¬ä½¿ç”¨Anacondaï¼‰</li><li>æœ€åä¸€æ­¥éªŒè¯ä½ çš„å®‰è£…æ•ˆæœ</li></ul></li></ol><p>æ¥ä¸‹æ¥ä¸€æ­¥ä¸€æ­¥æ¥ï¼š</p><p>ç¬¬ä¸€æ­¥ã€æˆ‘ä»¬å†³å®šç”¨Anacondaæ¥å®‰è£…TensorFlowï¼Œä½ è¦çŸ¥é“Anacondaæ˜¯ä»€ä¹ˆå‘¢ï¼Œå®ƒå°±æ˜¯å¯ä»¥å¾ˆå¥½çš„ç®¡ç†pythonçš„ä¸€äº›ä¾èµ–åº“ã€‚è®©ä½ åœ¨ä¸åŒpythonç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢è‡ªå¦‚ã€‚æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥å®‰è£…æˆ‘ä»¬çš„TensorFlowã€‚Anacondaä¹Ÿå¯ä»¥é›†æˆSpyderè¿™äº›ç¼–ç¨‹å·¥å…·ï¼Œä½¿å¾—ä½ ç¼–å†™ä»£ç ä¼šæ–¹ä¾¿ä¸€äº›ã€‚</p><p>ç¬¬äºŒæ­¥ã€é¦–å…ˆä½ å»<a href="https://www.anaconda.com/download/" target="_blank" rel="noopener">Anacondaå®˜ç½‘</a>ä¸‹è½½windowsç‰ˆæœ¬çš„Anacondaï¼Œå…·ä½“å®‰è£…å°±å’Œæ™®é€šçš„å®‰è£…è½¯ä»¶ç±»ä¼¼ã€‚è¿™ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒpythonç‰ˆæœ¬éœ€è¦ä¸åŒçš„Anacondaï¼Œåˆ«ä¸‹é”™äº†ã€‚</p><p>ç¬¬ä¸‰æ­¥ã€å®‰è£…å¥½ä»¥åï¼Œæˆ‘ä»¬æ‰“å¼€Anacondaçš„æ§åˆ¶å°ï¼Œå°±æ˜¯å¼€å§‹é‡Œé¢æ‰¾åˆ°Anacondaçš„åº”ç”¨ï¼Œç„¶åé‡Œé¢æœ‰ä¸€ä¸ªAnaconda Promptã€‚æ‰“å¼€ä»¥åï¼Œæˆ‘ä»¬å°±å¼€å§‹äº†æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„TensorFlowç‹¬ç«‹çš„ç¯å¢ƒã€‚</p><blockquote><p><code>conda create -n tensorflow pip python=3.5</code></p><p>ä¸Šé¢è¿™å‘½ä»¤çš„æ„æ€å°±æ˜¯è¯´åœ¨Anacondaç®¡ç†çš„ç¯å¢ƒé‡Œé¢ç»™æˆ‘ç‹¬ç«‹çš„åˆ›å»ºä¸€ä¸ªpythonç¯å¢ƒæ¥ï¼Œè¿™ä¸ªé‡Œé¢pythonçš„ç‰ˆæœ¬æ˜¯3.5ã€‚æ³¨æ„ä¸€ä¸‹ï¼Œè¿™ä¸ªåœ°æ–¹è¿˜æ²¡æœ‰å®‰è£…tensorflowå‘¢ï¼Œä¸Šé¢çš„tensorflowåªä¸è¿‡æ˜¯åˆ›å»ºçš„ä¸€ä¸ªç¯å¢ƒåå­—è€Œå·²ã€‚</p></blockquote><p><img src="https://s1.ax1x.com/2018/03/14/94kjt1.png" alt="-"></p><blockquote><p><code>activate tensorflow</code></p><p>ä¸Šé¢çš„å‘½ä»¤æ˜¯æ¿€æ´»è¿™ä¸ªtensorflowçš„ç¯å¢ƒï¼Œä½ å¯ä»¥é€šè¿‡è¿™ä¸ªç¯å¢ƒï¼Œæ·»åŠ ä¸€äº›ä½ è‡ªå·±çš„pythonåº“ï¼Œå®šåˆ¶è‡ªå·±çš„pythonç¯å¢ƒï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä½¿ç”¨Anacondaçš„åŸå› ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯åªæœ‰Anacondaæ”¯æŒè¿™æ ·çš„æ–¹å¼ã€‚ä¸è¦å’Œæˆ‘æŠ¬æ ã€‚</p></blockquote><p><img src="https://s1.ax1x.com/2018/03/14/94kXkR.png" alt="-"></p><p>ç¬¬å››æ­¥ï¼Œä¹Ÿå°±æ˜¯æ­£å„¿å…«ç»çš„å®‰è£…TensorFlowçš„é˜¶æ®µï¼Œ<strong>è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œä¸Šé¢ä¸ºä»€ä¹ˆæˆ‘æ‰§è¡Œçš„æ˜¯tensorflow1ï¼Œå› ä¸ºæˆ‘çš„ç”µè„‘ä¸Šé¢å·²ç»æœ‰tensorflowè¿™ä¸ªç¯å¢ƒäº†</strong></p><blockquote><p><code>pip install --ignore-installed --upgrade tensorflow</code></p><p>è¿™ä¸ªå‘½ä»¤å°±æ˜¯ä½¿ç”¨pipæ­£å¸¸çš„å®‰è£…tensorflowï¼Œè¿™é‡Œçš„pipç®¡ç†èµ·æ¥å’Œæ™®é€šçš„pipç®¡ç†æ˜¯ä¸€ä¸ªé“ç†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p></blockquote><p><img src="https://s1.ax1x.com/2018/03/14/94kL79.png" alt="-"></p><p>ç¬¬äº”æ­¥ï¼Œæµ‹è¯•TensorFlowæ˜¯å¦å®‰è£…ä¸Š</p><blockquote><p><code>python</code></p><p>ä¸Šé¢çš„å‘½ä»¤æ˜¯è¿›å…¥pythonè§£é‡Šå™¨ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„importè¯­å¥</p><p><code>import tensorflow as tf</code></p><p>å¦‚æœä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œå®Œï¼Œå¦‚ä¸‹å›¾ä¸­ä¸€æ ·ï¼Œå°±ç®—å®‰è£…æˆåŠŸäº†ï¼Œä¸‹é¢çš„é‚£äº›è¯­å¥æ˜¯å†™äº†ä¸€ä¸ªhello worldï¼ï¼ï¼</p></blockquote><p><img src="https://s1.ax1x.com/2018/03/22/9Hf66P.png" alt="-"></p><p>ä»Šå¤©æ˜¯ä¸ºäº†æˆ‘ä»¬ä»¥ååœ¨TensorFlowä¸Šå¼€å‘æ‰€åšçš„å‡†å¤‡ã€‚å¸Œæœ›å¤§å®¶å®‰è£…é¡ºåˆ©ã€‚æˆ‘çš„ä¸ªäººé‚®ç®±æ˜¯air@weaf.topã€‚æœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥å•ç‹¬å‘é‚®ä»¶é—®æˆ‘ã€‚æ„Ÿè°¢ä½ ä»¬çš„é©»è¶³ã€‚æœ‰ä»€ä¹ˆä¸å¥½çš„åœ°æ–¹ï¼Œå¯ä»¥ç»™å‡ºæ„è§ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h1 id=&quot;ç¬¬ä¸€ç¯‡æ–‡ç« -tensorflow-install&quot;&gt;ç¬¬ä¸€ç¯‡æ–‡ç« -TensorFlow Install&lt;/h1&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;é¦–å…ˆä»‹ç»ä¸€äº›æˆ‘ä»¬è¿™ä¸ªç»„ç»‡ï¼Œè¿™æ˜¯æœ‰å››ä¸ªäººæ„æˆå¾—ä¸€ä¸ªç»„ç»‡ï¼Œç»„ç»‡å¯ä»¥å«FOUR
        
      
    
    </summary>
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/categories/TensorFlow/"/>
    
    
      <category term="TensorFlow" scheme="http://weafteam.github.io/tags/TensorFlow/"/>
    
  </entry>
  
</feed>
